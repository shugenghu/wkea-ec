import 'jest';

import * as core from '@msdyn365-commerce/core';
import { Cart } from '@msdyn365-commerce/retail-proxy';
import * as CartsDataActions from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';
import mockRequestContext from '../../__mocks__/request-context.json';
import clearCartLineDeliveryModeInternal from '../clear-cart-line-delivery-mode';

describe('clearCartLineDeliveryMode tests', () => {
    const actionContext = core.buildMockActionContext({ requestContext: <core.IRequestContext>(<unknown>mockRequestContext) });

    const sampleCart: Cart = {
        Id: 'cart1',
        CartLines: [
            {
                LineId: 'cl1',
                ProductId: 1,
                DeliveryMode: '10',
                FulfillmentStoreId: 'HOUSTON',
                ShippingAddress: {
                    State: 'Texas'
                }
            }
        ]
    };

    // Setup mocks
    beforeAll(() => {
        core.initializeMockApp();
        jest.mock('@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g');
    });

    beforeEach(() => {
        jest.resetAllMocks();

        // @ts-ignore: Jest Mocking Confuses TS Complier
        CartsDataActions.updateCartLinesAsync = jest.fn().mockImplementation((ctx, id, cartLineIds) => {
            return Promise.resolve({
                Id: 'cart2'
            });
        });
    });

    it('returns FAILED if cart is undefined', async () => {
        const result = await clearCartLineDeliveryModeInternal(undefined, 'cl1', actionContext);

        expect(result.status).toBe('FAILED');

        expect(CartsDataActions.updateCartLinesAsync).not.toBeCalled();
    });

    it('returns FAILED cart doesn\'t contain line', async () => {
        const result = await clearCartLineDeliveryModeInternal(sampleCart, 'cl0', actionContext);

        expect(result.status).toBe('FAILED');

        expect(CartsDataActions.updateCartLinesAsync).not.toBeCalled();
    });

    it('matches line with avail quantity', async () => {
        const result = await clearCartLineDeliveryModeInternal(sampleCart, 'cl1', actionContext);

        expect(CartsDataActions.updateCartLinesAsync).toHaveBeenCalledWith(
            expect.anything(),
            'cart1',
            expect.arrayContaining([
                expect.objectContaining(
                    {
                        LineId: 'cl1',
                        ProductId: 1,
                        DeliveryMode: '',
                        FulfillmentStoreId: '',
                        ShippingAddress: {}
                    }
                )
            ]),
            null
        );

        expect(result.status).toBe('SUCCESS');
        expect(result.cart).not.toBeUndefined();
        expect(result.cart!.Id).toEqual('cart2');
    });

    it('returns failure if updateCartLinesAsync throws', async () => {
        // @ts-ignore: Jest Mocking Confuses TS Complier
        CartsDataActions.updateCartLinesAsync = jest.fn().mockImplementation(cb => {
            return Promise.reject(new Error('Fail'));
        });

        const result = await clearCartLineDeliveryModeInternal(sampleCart, 'cl1', actionContext);

        expect(CartsDataActions.updateCartLinesAsync).toBeCalled();

        expect(result.status).toBe('FAILED');
        expect(result.cart).toBeUndefined();
    });
});