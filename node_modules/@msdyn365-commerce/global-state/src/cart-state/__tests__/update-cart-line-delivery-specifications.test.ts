import 'jest';

import * as core from '@msdyn365-commerce/core';
import { Cart } from '@msdyn365-commerce/retail-proxy';
import * as CartsDataActions from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';
import mockRequestContext from '../../__mocks__/request-context.json';
import updateCartLineDeliverySpecificationsInternal from '../update-cart-line-delivery-specifications';

describe('updateCartLineQuantity tests', () => {
    const actionContext = core.buildMockActionContext({ requestContext: <core.IRequestContext>(<unknown>mockRequestContext) });

    const sampleCart: Cart = {
        Id: 'cart1',
        CartLines: [
            {
                LineId: 'cl1',
                ProductId: 1,
                DeliveryMode: '10',
                FulfillmentStoreId: 'HOUSTON',
                ShippingAddress: {
                    State: 'Texas'
                }
            }
        ]
    };

    // Setup mocks
    beforeAll(() => {
        core.initializeMockApp();
        jest.mock('@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g');
    });

    beforeEach(() => {
        jest.resetAllMocks();

        // @ts-ignore: Jest Mocking Confuses TS Complier
        CartsDataActions.updateLineDeliverySpecificationsAsync = jest.fn().mockImplementation((ctx, id, cartLineIds) => {
            return Promise.resolve({
                Id: 'cart2'
            });
        });
    });

    it('returns FAILED if cart is undefined', async () => {
        const result = await updateCartLineDeliverySpecificationsInternal(undefined, [], actionContext);

        expect(result.status).toBe('FAILED');

        expect(CartsDataActions.updateLineDeliverySpecificationsAsync).not.toBeCalled();
    });

    it('calls updateLineDeliverySpecificationsAsync', async () => {
        const result = await updateCartLineDeliverySpecificationsInternal(sampleCart, [{LineId: 'cl1', DeliverySpecification: { PickUpStoreId: 'SEATTLE' }}], actionContext);

        expect(CartsDataActions.updateLineDeliverySpecificationsAsync).toHaveBeenCalledWith(
            expect.anything(),
            'cart1',
            expect.arrayContaining([
                expect.objectContaining(
                    {
                        LineId: 'cl1',
                        DeliverySpecification: expect.objectContaining({
                            PickUpStoreId: 'SEATTLE'
                        })
                    }
                )
            ])
        );

        expect(result.status).toBe('SUCCESS');
        expect(result.cart).not.toBeUndefined();
        expect(result.cart!.Id).toEqual('cart2');
    });

    it('returns failure if updateLineDeliverySpecificationsAsync throws', async () => {
        // @ts-ignore: Jest Mocking Confuses TS Complier
        CartsDataActions.updateLineDeliverySpecificationsAsync = jest.fn().mockImplementation(cb => {
            return Promise.reject(new Error('Fail'));
        });

        const result = await updateCartLineDeliverySpecificationsInternal(sampleCart, [{LineId: 'cl1', DeliverySpecification: { PickUpStoreId: 'SEATTLE' }}], actionContext);

        expect(CartsDataActions.updateLineDeliverySpecificationsAsync).toBeCalled();

        expect(result.status).toBe('FAILED');
        expect(result.cart).toBeUndefined();
    });
});