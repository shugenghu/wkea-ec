import { addDiscountCodeAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';
export default async function addPromoCode(cart, promoCode, actionContext) {
    if (!cart) {
        return { cart: undefined, status: 'FAILED' };
    }
    if (hasPromoCode(cart, promoCode)) {
        return { cart: undefined, status: 'FAILED', substatus: 'ALREADYADDED' };
    }
    return addDiscountCodeAsync({ callerContext: actionContext }, cart.Id, promoCode)
        .then(newCart => {
        // Retail server will still return success if a promo code is not valid,
        // but it won't actually add that promo code. So need to check if promo
        // code is actually in the new cart
        if (hasPromoCode(newCart, promoCode)) {
            return { cart: newCart, status: 'SUCCESS' };
        }
        else {
            return { cart: undefined, status: 'FAILED' };
        }
    }).catch(error => {
        actionContext.telemetry.warning(error);
        return { cart: undefined, status: 'FAILED' };
    });
}
function hasPromoCode(cart, code) {
    const codes = cart.Coupons ? cart.Coupons.map((coupon) => { return coupon.Code.toLowerCase(); }) : [];
    return codes.indexOf(code.toLowerCase()) > -1;
}
//# sourceMappingURL=add-promo-code.js.map