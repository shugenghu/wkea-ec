{"version":3,"file":"parse-request.js","sourceRoot":"","sources":["../../../src/_server/parse-request.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n// tslint:disable: prefer-object-spread - needed to preserve proto properties\nimport msdyn365Commerce, {\n    IAppSettings,\n    ICommerceApiSettings,\n    IConnectorParams,\n    IDictionary,\n    IPageConfig,\n    IPageResponse,\n    IRenderingContext,\n    IRequestContext,\n    tryParseInt\n} from '@msdyn365-commerce/core-internal';\nimport { asSystemMetadata, EXCEPTION_PAGECONFIG, IInternalTelemetry, LogLevel } from '@msdyn365-commerce/telemetry-internal';\nimport { Request } from 'express';\nimport { mergeWith as _mergeWith, pick as _pick } from 'lodash';\nimport { CookieContext } from '../utils/cookie-utils';\nimport { getFlattenedListOfModules } from '../utils/get-modules-flat-list';\nimport { getAbsoluteUri, isTruthy, parseItemQSP, parseToQSPObject } from '../utils/helpers';\nimport { populateApiSettingsFromQSP } from '../utils/query-utils';\nimport { SessionStorageContext } from '../utils/session-storage-utils';\n\n/**\n * Returns default values for platform-provided page config values that all pages will have\n *\n * Default values are provided to avoid to avoid having to type check everything later\n */\nexport const getDefaultPageConfig = (): IPageConfig => ({\n    className: undefined,\n    pageTheme: undefined\n});\n\nexport const getDefaultAppSettings = (): IAppSettings => {\n    return {\n        config: {},\n        routes: {}\n    };\n};\n\nconst getFromReq = (namespaceKey: string, disallow: Set<string>) => {\n    return (req: Request) => {\n        return Object.keys(req[namespaceKey]).reduce((memo, key) => {\n            if (key && !disallow.has(key.toLowerCase())) {\n                memo[key] = req[namespaceKey][key];\n            }\n            return memo;\n            // tslint:disable-next-line:align\n        }, {});\n    };\n};\n\nconst apiSettingsMergeCustomizer = (requestApiSetting: unknown, renderingApiSetting: unknown) => {\n    if (typeof requestApiSetting === 'object') {\n        return _mergeWith(requestApiSetting, renderingApiSetting, apiSettingsMergeCustomizer);\n    }\n    return requestApiSetting ? requestApiSetting : renderingApiSetting;\n};\n\nconst getLocale = (requestContext: IRequestContext, renderingContext: IRenderingContext) => {\n    let locale = renderingContext.query ? renderingContext.query.locale : undefined;\n\n    if (process.env.NODE_ENV === 'development' && requestContext.query) {\n        locale = requestContext.query.locale || locale;\n    }\n\n    return locale;\n};\n\nexport const getHeaders = getFromReq(\n    'headers',\n    new Set<string>([\n        'authorization',\n        'x-client-ip',\n        'x-client-port',\n        'sec-fetch-site',\n        'sec-fetch-mode',\n        'sec-fetch-user',\n        'sec-fetch-dest',\n        'x-forwarded-for',\n        'x-azure-clientip',\n        'x-azure-ref',\n        'x-forwarded-host',\n        'x-forwarded-proto',\n        'x-azure-requestchain',\n        'x-azure-socketip',\n        'x-azure-fdid',\n        'x-waws-unencoded-url',\n        'client-ip',\n        'x-arr-log-id',\n        'disguised-host',\n        'x-site-deployment-id',\n        'was-default-hostname',\n        'x-original-url',\n        'x-arr-ssl',\n        'x-appservice-proto',\n        'x-forwarded-tlsversion',\n        'appex-activity-id',\n        'x-ms-client-principal-name',\n        'x-ms-client-principal-id',\n        'x-ms-client-principal-idp',\n        'x-ms-client-principal',\n        'ms-cv'\n    ])\n);\n\n// tslint:disable-next-line:cyclomatic-complexity\nexport const parseRequest = (req: Request): IRequestContext => {\n    const apiSettingsFromEnv: ICommerceApiSettings = {\n        baseUrl: process.env.MSDyn365Commerce_BASEURL || '',\n        channelId: tryParseInt(process.env.MSDyn365Commerce_CHANNELID) || 0,\n        catalogId: tryParseInt(process.env.MSDyn365Commerce_CATALOGID) || 0,\n        oun: process.env.MSDyn365Commerce_OUN || '',\n        baseImageUrl: process.env.MSDyn365Commerce_BASEIMAGEURL || '',\n        ratingsReviewsEndpoint: process.env.MSDyn365Commerce_RATINGSREVIEWSENDPOINT || '',\n        retailServerProxyVersion: process.env.MSDyn365Commerce_RSVERSION || '',\n        rnr: {\n            proxyUrl: process.env.MSDyn365Commerce_RATINGSREVIEWS_PROXYURL || '',\n            url: process.env.MSDyn365Commerce_RATINGSREVIEWS_URL || '',\n            id: process.env.MSDyn365Commerce_RATINGSREVIEWS_ID || ''\n        }\n    };\n\n    const concatJs = parseToQSPObject(req.query.concatJs);\n    const serverProperties = Object.create({\n        headers: getHeaders(req)\n    });\n\n    return Object.assign(serverProperties, {\n        url: {\n            requestUrl: new URL(getAbsoluteUri(req)),\n            staticCdnUrl: `${req.protocol}://${req.get('host')}/`\n        },\n        urlTokens: {},\n        locale: '',\n        market: '',\n        textDirection: '',\n        sitePath: req.query && req.query.sitePath,\n        device: {\n            Type: 'pc'\n        },\n        user: {\n            token: '',\n            isAuthenticated: false\n        },\n        app: {},\n        query: req.query || undefined,\n        apiSettings: apiSettingsFromEnv,\n        operationId: '',\n        params: {\n            mock: req.query && req.query.mock ? req.query.mock.toString() : '',\n            isDebug: req.query && isTruthy(req.query.debug),\n            isEditor: req.query && isTruthy(req.query.editorial),\n            isPreview: req.query && isTruthy(req.query.preview),\n            concatJs: concatJs.hasValue\n                ? concatJs\n                : {\n                      hasValue: true,\n                      isTruthy: false,\n                      value: false\n                  },\n            theme: req.query && req.query.theme\n        },\n        features: {\n            // initialize default empty set of features\n        },\n        pageData: {},\n        _debug: {\n            commerceSDKVersion: process.env.MSDyn365Commerce_SDK_VERSION || '',\n            commerceSSKVersion: process.env.MSDyn365Commerce_SSK_VERSION || '',\n            retailProxyVersion: process.env.MSDyn365Commerce_RSVERSION || ''\n        },\n        themeOverride: {\n            url: req.query.themeOverride || '',\n            disableDefault: req.query.disableDefaultSiteTheme || false\n        },\n        telemetrySettings: {\n            eventHubEndPoint: '',\n            eventHubAuthToken: '',\n            optOutWebActivityTracking: false,\n            operationId: '',\n            instrumentationKey: '',\n            environmentId: 'Development'\n        }\n    });\n};\n\nexport const mergeSwtichFromPlatformSettingsWithFeatureSwitch = (requestContext: IRequestContext) => {\n    // add local flag in platform settings to feature switch if feature switch does not have those.\n    // feature switch will take priority of controlling  the behavior.\n    const platformSettings = msdyn365Commerce.platformSettings;\n    const enableUrlLocalization =\n        requestContext.features.enableUrlLocalization || (platformSettings && platformSettings.enableUrlLocalization) || false;\n    const enableUrlEncoding =\n        requestContext.features.enableUrlEncoding || (platformSettings && platformSettings.enableUrlEncoding) || false;\n    requestContext.features.enableUrlEncoding = enableUrlEncoding;\n    requestContext.features.enableUrlLocalization = enableUrlLocalization;\n    return requestContext;\n};\n\n// tslint:disable-next-line:cyclomatic-complexity max-func-body-length\nexport const mapRequestContextWithRenderingContext = (\n    req: Request,\n    requestContext: IRequestContext,\n    renderingContext: IRenderingContext,\n    appContext: IAppSettings = getDefaultAppSettings(),\n    pageConfig: IPageConfig = getDefaultPageConfig()\n) => {\n    const disableCookieCompliance = (appContext && appContext.platform && appContext.platform.disableCookieCompliance) || false;\n    const cartCookieExpiration = (appContext && appContext.config && appContext.config.cartSessionExpiration) || 0;\n    const cookieContext = new CookieContext({\n        req,\n        isConsentRequired: !disableCookieCompliance,\n        cartExpirationInDays: cartCookieExpiration,\n        sameSiteRequired: renderingContext.sameSiteRequired\n    });\n\n    const serverProperties = Object.create({\n        headers: requestContext.headers,\n        cookies: cookieContext,\n        sessionStorage: new SessionStorageContext(cookieContext)\n    });\n\n    if (!renderingContext) {\n        return Object.assign(serverProperties, requestContext);\n    }\n\n    let itemQuery: IDictionary<string> = {};\n    const mergedRequestContext = Object.assign(serverProperties, requestContext, renderingContext);\n\n    // Extra merge here required because spread operator only does shallow merge\n    mergedRequestContext.apiSettings =\n        process.env.NODE_ENV === 'development'\n            ? _mergeWith(requestContext.apiSettings, renderingContext.apiSettings, apiSettingsMergeCustomizer)\n            : { ...requestContext.apiSettings, ...renderingContext.apiSettings };\n\n    mergedRequestContext.stylePresets = requestContext.siteStylePreset || renderingContext.siteStylePreset;\n\n    if (renderingContext.staticContext && renderingContext.staticContext.staticCdnUrl) {\n        mergedRequestContext.url.staticCdnUrl = renderingContext.staticContext.staticCdnUrl;\n    }\n\n    if (renderingContext.requestUrl) {\n        // TODO - remove http check after fixing all mocks\n        mergedRequestContext.url.requestUrl = new URL(\n            renderingContext.requestUrl.startsWith('http') ? renderingContext.requestUrl : `https://${renderingContext.requestUrl}`\n        );\n    }\n\n    if (mergedRequestContext.query) {\n        itemQuery = parseItemQSP(mergedRequestContext.query.item);\n        const concatJs = parseToQSPObject(itemQuery.concatJs);\n        mergedRequestContext.params = {\n            // default merge so that any switch related QSPs will be merged here and we don't have to explicitly set\n            ...requestContext.params,\n            mock: mergedRequestContext.query.mock || mergedRequestContext.params.mock,\n            isDebug: isTruthy(mergedRequestContext.query.debug) || mergedRequestContext.params.isDebug,\n            isEditor:\n                isTruthy(mergedRequestContext.query.editorial) || isTruthy(itemQuery.editorial) || mergedRequestContext.params.isEditor,\n            isPreview: isTruthy(mergedRequestContext.query.preview) || mergedRequestContext.params.isPreview,\n            concatJs: concatJs.hasValue ? concatJs : mergedRequestContext.params.concatJs,\n            theme: itemQuery.theme || mergedRequestContext.query.theme || pageConfig.pageTheme || mergedRequestContext.params.theme\n        };\n    }\n\n    if (mergedRequestContext.clientContext) {\n        mergedRequestContext.device = {\n            Type: mergedRequestContext.clientContext.deviceType || mergedRequestContext.device.Type\n        };\n    }\n\n    if (mergedRequestContext.userContext) {\n        mergedRequestContext.user = {\n            ...mergedRequestContext.user,\n            ...mergedRequestContext.userContext\n        };\n    }\n\n    mergedRequestContext.app = appContext;\n\n    // tslint:disable-next-line:no-any\n    const apiSettings = _pick({ ...itemQuery, ...mergedRequestContext.query }, [\n        'oun',\n        'baseUrl',\n        'baseImageUrl',\n        'rsVersion',\n        'rnrUrl',\n        'channelId',\n        'catalogId',\n        'rnrId'\n    ]);\n\n    populateApiSettingsFromQSP(apiSettings, mergedRequestContext);\n\n    mergedRequestContext.apiSettings.channelId = +mergedRequestContext.apiSettings.channelId;\n\n    // Override the locale with locale query string if given\n    mergedRequestContext.locale = getLocale(requestContext, renderingContext) || mergedRequestContext.locale;\n\n    if (renderingContext.themeOverride) {\n        mergedRequestContext.themeOverride = { ...requestContext.themeOverride, ...renderingContext.themeOverride };\n    }\n\n    // add node specific telemetry settings\n    if (process.env.APPINSIGHTS_INSTRUMENTATIONKEY) {\n        mergedRequestContext.telemetrySettings.instrumentationKey = process.env.APPINSIGHTS_INSTRUMENTATIONKEY;\n    }\n\n    if (process.env.NODE_ENV !== 'development') {\n        if (!mergedRequestContext.telemetrySettings.environmentId) {\n            mergedRequestContext.telemetrySettings.environmentId = (process.env.Fabric_ApplicationName || '-').slice(\n                (process.env.Fabric_ApplicationName || '-').indexOf('-') + 1\n            );\n        }\n        if (!mergedRequestContext.telemetrySettings.commerceCoreEnvId && process.env.CommerceCore_EnvironmentId) {\n            mergedRequestContext.telemetrySettings.commerceCoreEnvId = process.env.CommerceCore_EnvironmentId;\n        }\n    }\n\n    // Add information about selected connectors\n    mergedRequestContext.connectors = addConnectorInformation();\n    mergedRequestContext.telemetryData = mergedRequestContext.telemetryData || {};\n\n    // Create a mapping of module id to the experiment it is assocaited with\n    const moduleIdToExperimentId: IDictionary<string> = {};\n    if (mergedRequestContext.experiments?.activeExperiments?.length > 0) {\n        const activeExperiments = mergedRequestContext.experiments.activeExperiments;\n        for (let i = 0; i < activeExperiments.length; i++) {\n            const currentExperiment = activeExperiments[i];\n            if (currentExperiment.moduleId) {\n                moduleIdToExperimentId[currentExperiment.moduleId] = currentExperiment.experimentId;\n            }\n        }\n        mergedRequestContext.experiments.moduleIdToExperimentIdMap = moduleIdToExperimentId;\n    }\n\n    return mergedRequestContext;\n};\n\nconst addConnectorInformation = (): IConnectorParams => {\n    const connectors: IConnectorParams = {};\n    if (msdyn365Commerce.experimentationConnector) {\n        connectors.expConnector = msdyn365Commerce.experimentationConnector.name;\n    }\n    return connectors;\n};\n\nexport const getBodyConfig = (pageResponse: IPageResponse) => {\n    return pageResponse &&\n        pageResponse.pageRoot &&\n        pageResponse.pageRoot.modules &&\n        pageResponse.pageRoot.modules.body &&\n        pageResponse.pageRoot.modules.body[0]\n        ? pageResponse.pageRoot.modules.body[0].config\n        : {};\n};\n\nexport const getPageConfig = (pageResponse: IPageResponse, telemetry: IInternalTelemetry): IPageConfig => {\n    try {\n        if (!pageResponse || !pageResponse.pageRoot) {\n            return getDefaultPageConfig();\n        }\n        if (!pageResponse.slots || !pageResponse.slots.length) {\n            pageResponse.slots = getFlattenedListOfModules(pageResponse);\n        }\n        // TODO: Figure out the body slot once we have head slots\n        const bodySlot =\n            pageResponse.pageRoot.modules && pageResponse.pageRoot.modules.body\n                ? pageResponse.pageRoot.modules.body[0]\n                : pageResponse.slots[0];\n\n        const bodyConfig = bodySlot ? bodySlot.config : {};\n        return Object.assign(getDefaultPageConfig(), bodyConfig);\n    } catch (e) {\n        telemetry.log(LogLevel.Error, EXCEPTION_PAGECONFIG, { exception: e });\n        throw new Error(e);\n    }\n};\n"]}