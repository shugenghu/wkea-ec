/*!
 * Copyright (c) Microsoft Corporation.
 * All rights reserved. See LICENSE in the project root for license information.
 */
import msdyn365Commerce, { HtmlHeadInclude, isNonceEnabled, removeInstanceCache, sanitizeForXss } from '@msdyn365-commerce/core-internal';
import { EVENT_JSON_STRINGIFY_START, EVENT_JSON_STRINGIFY_STOP, InternalTelemetry } from '@msdyn365-commerce/telemetry-internal';
import { escape } from 'lodash';
import { getPlatformExternalStaticsAsStrings } from '../_server/platformExternalStatics';
import { LAYOUT_MOUNT_POINT } from '../consts';
import { getDebugInfo, getExcludedDomains, includeGlimpseNodeTab, includePageLogs, injectStylePresets, moduleListFastJson, pageRootFastJson, renderTags, requestContextFastJson, themeModulesFastJson } from '../utils/base-page-utils';
import { CommentTag, isTruthy, LinkTag } from '../utils/helpers';
const AUTHORING_EDIT_STYLES = `:root{--msv-edit-enabled: 1px solid #0078d7;}.ms-editable-field.enabled:focus{outline: var(--msv-edit-enabled);}.ms-editable-field.enabled:hover{outline: var(--msv-edit-enabled);transition-delay: 0.1s;text-decoration: underline;text-decoration-color: #0078d7;}`;
const AUTHORING_ADD_MODULE_STYLES = `.add-container {margin-bottom: 8px;margin: 0px 15px 8px 15px;}.add-container-inner {background: white;background-size: 20px 20px;background-image: linear-gradient(to right, #f6f6f6 1px, transparent 1px),linear-gradient(to bottom, #f6f6f6 1px, transparent 1px),radial-gradient(#f6f6f6 2px, transparent 0);background-position: 0px 0px,0px 0px,-10px -10px;height: 64px;display: flex;align-items: center;justify-content: center;}.add-sibling {display: flex;height: 40px;margin: 0px 15px;}.add-sibling .add-ruler {border-bottom: 1px solid #6FA2CB;height: 38%;width: 50%;}.add-sibling .add-sibling-inner {padding-top: 4px;height: fit-content;}.add-module-button {cursor: pointer;background: #DDECF9;border-radius: 2px;border: 1px solid #6FA2CB;}.add-module-icon {display: flex;align-items: center;justify-content: center;width: 100%;height: 100%;}.add-container-inner .add-module-button {height: 32px;width: 32px;margin: auto;}.add-container-inner span {margin: auto;color: grey;font-size: 14px;}.add-sibling .add-module-button {height: 20px;width: 20px;}.add-module-button svg {fill: #6FA2CB;}.add-container-inner .add-module-button svg {height: 16px;width: 16px;}.add-sibling .add-module-button svg {height: 10px;width: 10px;}.add-module-button:hover {background: #0078D4;}.add-module-button:hover svg {fill: #7FBAE9;}.add-module-button:active {background: #0F548D;}.add-module-button:active svg {fill: #7399B6;}.add-button-group {display: none;position: absolute;background: white;z-index: 9999;border: 1px solid rgba(0, 0, 0, 0.15);border-radius: 2px;}.add-button-group button {display: block;background: white;text-align:left;border: none;width: 100%;padding: 4px 8px;margin: 2px 0px;height:36px;min-width: 137px;}.add-button-group button:hover {background: lightgray;}.add-container-inner .placeholder-drop {display: none;}.add-container-inner.ondrop .placeholder-drop {display: block;}.add-container-inner.ondrop .default-buttons {display: none;}.add-container-inner.ondrop{border: 1px dashed #6FA2CB;}.add-container-inner.ondrop.drop-error{border: 1px dashed #B3B0AD;}.drop-fragment .ondrop-module {display: none;}.drop-fragment .ondrop-error {display: none;}.drop-module .ondrop-fragment {display: none;}.drop-module .ondrop-error {display: none;}.drop-error .ondrop-module {display: none;}.drop-error .ondrop-fragment {display: none;}.placeholder-drop-icon {display: flex;}.placeholder-drop-icon-bg svg {width: 20px;height: 20px;fill: white;}.placeholder-drop-icon-error-bg svg {width: 32px;height: 32px;fill: #B3B0AD;}.placeholder-drop-icon-bg {margin: auto;width: 32px;background: #0178D4;align-items: center;justify-content: center;display: flex;height: 32px;border-radius: 16px;}.placeholder-drop-icon-error-bg{margin: auto;width: 32px;background: white;align-items: center;justify-content: center;display: flex;height: 32px;border-radius: 16px;}`;
const AUTHORING_DRAG_AND_DROP_STYLES = ` .ms-no-pointer-events {pointer-events: none;} .ms-drag-image {z-index: 9999;position: absolute;pointer-events: none;} .ms-drag-text-box {opacity: 0.88;display: flex;flex-direction: row;padding: 0 4px;position: absolute;min-width: 80px;height: 20px;left: 34px;top: 5px;border-radius: 0 2px 2px 0;box-sizing: unset;background: #fff;filter: drop-shadow(0px 1.3px 0.9px #d0d0d0);} .ms-drag-icon-box.droppable {background: #0078d4;} .ms-drag-icon-box.not-droppable {background: #a80000;} .ms-drag-text-content {opacity: 1;position: static;width: 100%;height: 20px;left: 4px;top: 2px;font-family: Segoe UI;font-size: 12px;line-height: 16px;display: flex;align-items: center;text-align: center;flex: none;order: 0;align-self: center;margin: 10px 0;color: #323130;white-space: nowrap;} .ms-drag-placeholder-top {border-top: 3px solid #2183ba;padding-top: 3px;} .ms-drag-placeholder-bottom {border-bottom: 3px solid #2183ba;padding-bottom: 3px;} .ms-drag-icon-box {margin: auto;width: 30px;align-items: center;justify-content: center;display: flex;height: 30px;border-radius: 2px;opacity: 0.88;} .ms-drag-icon-box svg {fill: #fff;width: 20px;height: 20px;} `;
const AUTHORING_DRAG_IMAGE_ICON_STYLES = ' .ms-drag-icon{position:absolute;width:20px;height:20px;left:calc(50% - 20px/2);top:calc(50% - 20px/2);fill:#fff }.ms-module-icon{d:path("M1536 128l512 896-512 896H512L0 1024l512-896h1024zm-74 1664l439-768-439-768H586l-439 768 439 768h876z") }.ms-container-icon{d:path("M0 1664v-256h128v256H0zM256 0v128H0V0h256zM0 2048v-256h128v256H0zM1792 0v128h-256V0h256zM0 1280v-256h128v256H0zm640-896h768l384 640-384 640H640l-384-640 384-640zm696 1152l307-512-307-512H712l-307 512 307 512h624zM640 0v128H384V0h256zM0 896V640h128v256H0zM1024 0v128H768V0h256zm384 0v128h-256V0h256zm512 1792v-256h128v256h-128zm0-768V768h128v256h-128zm0 384v-256h128v256h-128zm0-768V384h128v256h-128zm0-640h128v256h-128V0zM0 512V256h128v256H0zm640 1536v-128h256v128H640zm-384 0v-128h256v128H256zm1152 0v-128h256v128h-256zm-384 0v-128h256v128h-256zm768 0v-128h256v128h-256z") }.ms-not-droppable-icon{d:path("M939 171q129 0 249 33t224 95 190 146 147 190 94 225 34 249q0 129-33 249t-95 224-146 191-190 147-225 94-249 34q-130 0-250-33t-224-95-190-147-147-190-94-224-34-250q0-129 33-249t95-224 147-190 190-147 224-94 250-34zm0 1740q111 0 213-28t192-81 162-126 125-162 81-191 29-214q0-110-28-212t-81-192-126-162-163-126-191-81-213-29q-111 0-213 28t-192 81-162 126-125 162-81 191-29 214q0 111 28 213t81 192 125 162 163 126 191 80 214 29zm-470-887h939v171H469v-171z") }.ms-add-module-icon{d:path("M1963 939v85h-939v939h-85v-939H0v-85h939V0h85v939h939z") }.ms-add-module-error-icon{d:path("M960 0q132 0 255 34t229 97 194 150 150 194 97 230 35 255q0 133-34 255t-97 229-150 194-194 150-230 97-255 35q-133 0-255-34t-229-97-194-150-150-194-97-230T0 960q0-132 34-255t97-229 150-194 194-150 230-97T960 0zm576 1024V896H384v128h1152z") }.ms-drop-module-slot-icon{d:path("M768 1664h128v128H768v-128zm256 0h128v128h-128v-128zm-512 0h128v128H512v-128zm1152-896h-128V640h128v128zm256-384v1664H256v-640H0V0h731l384 384h805zm-1152 0h165L768 219v165zm256 896V512H640V128H128v1152h896zm768-768h-640v896H640v128H512v-128H384v512h1408V512zm-384 1280h-128v-128h128v128zm256 0h-128v-128h128v128zm0-768h-128V896h128v128zm-256-256h-128V640h128v128zm256 512h-128v-128h128v128zm0 256h-128v-128h128v128z") } .ms-fragment-icon {d: path("M768 896H256L0 448 256 0h512l256 448-256 448zM330 128L147 448l183 320h364l183-320-183-320H330zm-74 896h512l256 448-256 448H256L0 1472l256-448zm438 768l183-320-183-320H330l-183 320 183 320h364zm970-1280l256 448-256 448h-512L896 960l256-448h512zm-74 768l183-320-183-320h-364l-183 320 183 320h364z");} ';
const getAuthoringEditStyles = (context) => {
    return context.features.authoring_inline_edit && context.params && !!context.params.isEditor
        ? AUTHORING_EDIT_STYLES.concat(AUTHORING_DRAG_AND_DROP_STYLES)
            .concat(AUTHORING_DRAG_IMAGE_ICON_STYLES)
            .concat(AUTHORING_ADD_MODULE_STYLES)
        : '';
};
const getAuthoringEditScripts = (context) => {
    // event listener to auto hide add module menu when user clicks anywhere on the editor
    return context.features.authoring_inline_edit && context.params && !!context.params.isEditor
        ? 'document.addEventListener("click", function(event){var clickAddBtn=(e)=>{var i=0; while(e && i<4){if(e.classList.contains("add-module-button")){return true;} e=e.parentElement; i++;} return false;}; var e=document.getElementsByClassName("add-button-group");for(var n of e)n.style.display="none"});'
        : '';
};
const getSanitizedBodyClass = (bodyClass) => {
    return bodyClass ? `class="${escape(bodyClass)}"` : '';
};
/**
 * Renders base page *
 */
// tslint:disable-next-line:max-func-body-length
const basePageTemplate = (props, telemetry) => {
    const baseUrlPrefix = props.baseUrl ? props.baseUrl : '/';
    const baseUrl = `${baseUrlPrefix}${process.env.SUBMISSIONID || 'statics'}/`;
    /*
        All page requested by AAD will have querystring, "?preloadscripts=true".
        Platform use this property to set data-preload="true" on script and css which is requried on page load.
        AAD while parsing HTML look for these attribute and if set true, they either inject content inline or preload the data
        so won't get into race condition on Javascript execution and no css flicking on page load.
    */
    const shouldPreload = isTruthy(props.context.query && props.context.query.preloadscripts);
    const preLoadAttribute = shouldPreload ? 'data-preload="true"' : '';
    const chunks = props.chunks;
    const { concatJs } = props.context.params;
    const defaultScriptBundle = `<script src="${baseUrl}static/js/bundle.js" ${preLoadAttribute} charSet="utf-8" />`;
    const platformExternalStatics = getPlatformExternalStaticsAsStrings(baseUrl, shouldPreload);
    const individualJsFiles = 
    // debug && not force ignored
    (props.isDebug && !concatJs.hasValue) ||
        // don't concat if explicitly asked not to
        (concatJs.hasValue && !concatJs.isTruthy);
    const jsScriptChunks = (individualJsFiles ? chunks.jsScriptChunks : props.jsHashedUrls) || [];
    const tags = HtmlHeadInclude.rewind();
    const ikey = process.env.APPINSIGHTS_INSTRUMENTATIONKEY || '';
    const daUrl = props.context.telemetrySettings.url;
    let environmentId = 'Development';
    const IS_DEV = process.env.NODE_ENV === 'development';
    let commerceCoreEnvironmentId = 'Development';
    if (!IS_DEV) {
        environmentId = (process.env.Fabric_ApplicationName || '-').slice((process.env.Fabric_ApplicationName || '-').indexOf('-') + 1);
        commerceCoreEnvironmentId = process.env.CommerceCore_EnvironmentId || 'CommerceCore_EnvironmentId_Missing';
    }
    const sdkVersion = process.env.MSDyn365Commerce_SDK_VERSION;
    const expVariantInfo = props.context.experiments?.activeExperiments
        ? JSON.stringify(props.context.experiments.activeExperiments).replace(/"/g, '\\"')
        : '[]';
    const correlationIdJsonStringify = InternalTelemetry.generateGuid();
    telemetry && telemetry.startTimer(correlationIdJsonStringify);
    telemetry && telemetry.trackEvent(EVENT_JSON_STRINGIFY_START);
    // Use Regular JSON Stringify for intial data objects that can't be well described with a JSON schema
    const requestCache = JSON.stringify(props.initialData.requestCache, removeInstanceCache);
    const pageRoot = pageRootFastJson(props.initialData.pageRoot);
    // Use Fast JSON stringify to stringify intial data objects based off a JSON schema
    // @ts-ignore _moduleList is a private property on PageContext but we need it here to stringify
    const moduleList = moduleListFastJson(props.initialData._moduleList);
    const requestContext = requestContextFastJson(props.initialData.requestContext);
    // @ts-ignore _themeModulesList is a private property on PageContext but we need it here to stringify
    const themeModulesList = themeModulesFastJson(props.initialData._themeModulesList);
    telemetry &&
        telemetry.trackEvent(EVENT_JSON_STRINGIFY_STOP, {}, { time: telemetry.stopTimer(correlationIdJsonStringify) });
    const sskVersion = process.env.MSDyn365Commerce_SSK_VERSION || 'XX';
    const retailProxyVersion = process.env.MSDyn365Commerce_RSVERSION || 'XX';
    // If editor mode is enabled, send down the theme settings for the current theme
    let themeSettings = '';
    if (props.isEditor) {
        const currentTheme = props.initialData.requestContext && props.initialData.requestContext.params && props.initialData.requestContext.params.theme;
        if (!currentTheme || msdyn365Commerce.themeSettings[currentTheme] === undefined) {
            themeSettings = JSON.stringify(msdyn365Commerce.themeSettings.default);
        }
        else {
            themeSettings = JSON.stringify(msdyn365Commerce.themeSettings[currentTheme]);
        }
    }
    const nonceToken = isNonceEnabled(props.initialData.requestContext);
    // If an experimentation connector is registered, grab the configuration neede to initialize the connector
    // client-side
    const expConfig = props.experimentClientInitConfig || '';
    // tslint:disable:max-line-length
    return `<!DOCTYPE html>
        <html lang="${props.context.locale}" dir="${props.context.textDirection}">
        <head data-info="${escape(getDebugInfo(props, false))}">
            <meta charset="utf-8" />
            ${renderTags(tags.scriptTags.headStart, nonceToken)}
            <meta httpEquiv="X-UA-Compatible" content="ie=edge" />
            <meta name='viewport' content='width=device-width, initial-scale=1.0' />
            ${props.prefetchLinks || ''}
            ${props.isDebug ? platformExternalStatics.debugScriptHtmlString : platformExternalStatics.productionScriptHtmlString}
            <style>.skip-to-main{height:1px;left:-999px;position:absolute;width:1px;z-index:300002}.skip-to-main:focus,.skip-to-main:active{display:block;height:auto;left:0;padding:12px;position:relative;right:0;text-align:center;width:auto;}
            ${getAuthoringEditStyles(props.context)}
            </style>
            ${!props.context.themeOverride.disableDefault && props.themeCss.map(LinkTag(baseUrl, preLoadAttribute))}
            ${props.css
        .map((cssPath) => cssPath &&
        `<link rel="stylesheet" href="${baseUrl}static/${cssPath}" ${preLoadAttribute} crossOrigin="anonymous" />`)
        .join('')}
            ${props.context.themeOverride.url &&
        `<link rel="stylesheet" href="${props.context.themeOverride.url}" ${preLoadAttribute} crossOrigin="anonymous" />`}
            <script ${nonceToken ? `nonce='${nonceToken}'` : ''} type="text/javascript">
                window.___publicPath___= ${JSON.stringify(baseUrl)};
                window.___initialData___ = {};
                window.___initialData___.pageRoot = ${sanitizeForXss(pageRoot)};
                window.___initialData___.requestCache = ${sanitizeForXss(requestCache)};
                window.___initialData___.requestContext = ${sanitizeForXss(requestContext)};
                window.___initialData___._moduleList = ${sanitizeForXss(moduleList)};
                window.___initialData___._themeModulesList = ${themeModulesList};
                ${themeSettings ? `window.___initialData___.themeSettings = ${themeSettings}` : ``}
                ${expConfig ? `window.___initialData___.experimentationConfig = ${expConfig}` : ``}
            </script>
            ${props.isDebug ? CommentTag('debug info') + CommentTag(getDebugInfo(props, true)) : ''}
            ${props.isDebug ? includePageLogs(props) : ''}
            ${props.headContent}
            <script ${nonceToken ? `nonce='${nonceToken}'` : ''} type="text/javascript">
                ${getAuthoringEditScripts(props.context)}
                var appInsights = window.appInsights || function (a) { function b(a) { c[a] = function () { var b = arguments; c.queue.push(function () { c[a].apply(c, b) }) } } var c = { config: a }, d = document, e = window; setTimeout(function () { var b = d.createElement("script"); b.src = a.url || "https://az416426.vo.msecnd.net/scripts/a/ai.0.js", d.getElementsByTagName("script")[0].parentNode.appendChild(b) }); try { c.cookie = d.cookie } catch (a) { } c.queue = []; for (var f = ["Event", "Exception", "Metric", "PageView", "Trace", "Dependency"]; f.length;)b("track" + f.pop()); if (b("setAuthenticatedUserContext"), b("clearAuthenticatedUserContext"), b("startTrackEvent"), b("stopTrackEvent"), b("startTrackPage"), b("stopTrackPage"), b("flush"), !a.disableExceptionTracking) { f = "onerror", b("_" + f); var g = e[f]; e[f] = function (a, b, d, e, h) { var i = g && g(a, b, d, e, h); return !0 !== i && c["_" + f](a, b, d, e, h), i } } return c }({ instrumentationKey: '${ikey}' });
                appInsights.config.enableCorsCorrelation=!0,appInsights.config.correlationHeaderExcludedDomains=${getExcludedDomains(props.context.app)},appInsights.queue.push(function(){appInsights.context.addTelemetryInitializer(function(e){var o=e.data,n=o&&o.baseData;if(n.properties=n.properties||{},e&&o){var t=o.baseType;if("PageviewPerformanceData"===t){const e=window&&window.performance.getEntriesByType("navigation"),o=window.performance.getEntriesByType("paint");if(e&&e.length>0){const o=e[0],t=o.duration,r=o.domContentLoadedEventStart,i=o.domContentLoadedEventEnd,a=o.domInteractive,p=o.domComplete;t&&(n.properties.duration=t),r&&i&&(n.properties.domContentLoadedEvent=i-r),a&&(n.properties.domInteractive=a),p&&(n.properties.domComplete=p)}o&&o.length>0&&o.forEach(e=>{n.properties[e.name]=e.startTime})}if("PageviewData"!==t&&"PageviewPerformanceData"!==t||(n.url="URL CENSORED",n.properties.ExperimentVariants="${expVariantInfo}"),"RemoteDependencyData"===t&&!n.properties.requestId)return!1;e.tags&&("ExceptionData"!==t&&"PageviewPerformanceData"!==t&&"PageviewData"!==t&&"RemoteDependencyData"!==t||(e.tags["ai.operation.name"]="CENSORED"))}var r=n.properties;r["Server operation id"]="${props.context.operationId}",r["Environment id"]="${environmentId}",r["Commerce core environment id"]="${commerceCoreEnvironmentId}",r["SDK version"]="${sdkVersion}",r["RetailProxy version"]="${retailProxyVersion}",r["Node Process ID"]="${process.pid}",r["SSK version"]="${sskVersion}",r["DA SDK version"]=window&&window.oneDSWeb&&window.oneDSWeb.config&&window.oneDSWeb.config._daSdkVer})}),appInsights.trackPageView();
            </script>
            ${(props.context.features.enableDataAnalytics &&
        !IS_DEV &&
        `<script ${nonceToken ? `nonce='${nonceToken}'` : ''} type="text/javascript">var sdkInstance="onedsSDK";window[sdkInstance]="oneDSWeb";var aiName=window[sdkInstance],aisdk=window[aiName]||function(n,e){var a={config:n,extensions:[]},t=document,i=window,o="script";function r(n){a[n]=function(){var e=arguments;a.queue.push(function(){window[aiName][n](e)})}}setTimeout(function(){var e=t.createElement(o);e.src=n.url||"${daUrl}",t.getElementsByTagName(o)[0].parentNode.appendChild(e)}),a.queue=[];for(var s=["track","trackPageView","trackPageAction","trackContentUpdate","trackPageUnload","trackException","trackPageViewPerformance","trackEvent"];s.length;)r(s.pop());if(!n.webAnalyticsConfiguration||!n.webAnalyticsConfiguration.autoCapture||n.webAnalyticsConfiguration.autoCapture.jsError){r("_"+(s="onerror"));var u=i[s];i[s]=function(e,n,a,t,i){var o=u&&u(e,n,a,t,i);return!0!==o&&window[aiName]&&window[aiName]["_"+s]({message:e,url:n,lineNumber:a,columnNumber:t,error:i}),o}}return a}(
                    {instrumentationKey:"${ikey}",webAnalyticsConfiguration:{}});window[aiName]=aisdk;
                </script>`) ||
        ''}
            <script ${nonceToken ? `nonce='${nonceToken}'` : ''}' type="text/javascript">!function(e,i){var n=!1,a=!1,t=0,r=0,m=0,o=1e3,s=200,v=3e4;function c(){"visible"!==i.visibilityState&&(a=!0,i.removeEventListener("visibilitychange",c,!1))}e._pageTimings||(e._pageTimings={}),e.performance&&performance.mark&&performance.now&&e.requestAnimationFrame&&e.parent===e&&i.visibilityState&&i.addEventListener&&("visible"===i.visibilityState?i.addEventListener("visibilitychange",c,!1):a=!0,requestAnimationFrame(function g(){performance.mark("frame"),n||(r=t,(t=performance.now())-r<=s?t-m>=o&&(e._pageTimings.TimeToPageInteractive=Math.round(m),n=!0):m=t),performance.now()<v?requestAnimationFrame(g):(i.removeEventListener("visibilitychange",c,!1),e._pageTimings.wasPageHidden=a)}))}(window,document);</script>
            ${renderTags(tags.nonScriptTags)}
            ${renderTags(tags.scriptTags.headEnd, nonceToken)}
            ${injectStylePresets(props.context.siteStylePreset)}
        </head>
        <body ${getSanitizedBodyClass(props.bodyClassName)}>
            ${props.bodyBeginContent}
            ${renderTags(tags.scriptTags.bodyStart, nonceToken)}
            <div id="${LAYOUT_MOUNT_POINT}">${props.bodyContent}</div>
            <script ${nonceToken ? `nonce='${nonceToken}'` : ''}' type="text/javascript">
                window.___appData___= ${sanitizeForXss(JSON.stringify(props.appData))};
            </script>
            ${props.chunks && props.chunks.isChunkingEnabled
        ? jsScriptChunks
            .concat((individualJsFiles && chunks.entryChunkScripts))
            .filter(Boolean)
            .map((scriptSource) => `<script src="${scriptSource}" ${preLoadAttribute} type="text/javascript" charset="utf-8" ${!!props.context.features.async_chunks ? 'async' : ''} crossOrigin="anonymous"></script>`)
            .join('')
        : defaultScriptBundle}
            ${renderTags(tags.scriptTags.bodyEnd, nonceToken)}
            ${includeGlimpseNodeTab(props)}
            ${props.bodyEndContent}
        </body>
        </html>
    `;
};
export { basePageTemplate };
export default basePageTemplate;
//# sourceMappingURL=base-page.js.map