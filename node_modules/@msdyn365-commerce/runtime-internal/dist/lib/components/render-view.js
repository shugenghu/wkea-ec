import { msdyn365Commerce } from '@msdyn365-commerce/core-internal';
import { asSystemMetadata, EXCEPTION_NOMODULEBINDER, LogLevel } from '@msdyn365-commerce/telemetry-internal';
import React from 'react';
import { getModuleBinder, getModuleName } from '../utils/helpers';
const getViewBinder = (viewLookupKey) => {
    const view = msdyn365Commerce.viewBinder(viewLookupKey);
    if (view) {
        return { key: viewLookupKey, view };
    }
    return undefined;
};
/**
 * View will be read in following hierarchy
 *  1) __local__|__local__|themes|theme1|views|product-tile  OR  @msdyn-365-commerce-modules|theme1|modules|theme1|views|product-tile
 *  2) __local__|__local__|modules|product-tile|product-tile  OR  @msdyn-365-commerce-modules|product-tile|modules|product-tile|product-tile
 */
const viewLookupFunc = (moduleBinder, themeBinder) => themeBinder &&
    (getViewBinder(`__local__|__local__|themes|${themeBinder.name}|views|${moduleBinder.name}`) ||
        getViewBinder(`${themeBinder.moduleNamespace}|${themeBinder.packageName}|modules|${themeBinder.name}|views|${moduleBinder.name}`));
/**
 * View will be read from the module
 *  __local__|__local__|modules|product-tile|product-tile  OR  @msdyn-365-commerce-modules|product-tile|modules|product-tile|product-tile
 */
const defaultViewLookupFunc = moduleBinder => {
    const parentModuleBinder = getModuleBinder(getModuleName(moduleBinder.parentDefinitionPath));
    return (getViewBinder(`${moduleBinder.moduleNamespace}|${moduleBinder.packageName}|modules|${moduleBinder.name}|${moduleBinder.name}`) ||
        (parentModuleBinder &&
            getViewBinder(`${parentModuleBinder.moduleNamespace}|${parentModuleBinder.packageName}|modules|${parentModuleBinder.name}|${parentModuleBinder.name}`)));
};
const getView = (moduleBinder, themeBinder, context) => {
    if (!moduleBinder) {
        return { view: null };
    }
    // tslint:disable-next-line:no-any
    const cache = msdyn365Commerce.getAppCache(context.actionContext.requestContext);
    const viewCacheKey = {
        key: `${moduleBinder.name}|${themeBinder ? themeBinder.name : 'no-theme'}`,
        typeName: '__ViewCacheKey__'
    };
    const viewLookupKey = cache.getValue(viewCacheKey);
    if (viewLookupKey) {
        // @ts-ignore
        !msdyn365Commerce.isBrowser && context.actionContext.requestCache.put(viewCacheKey, { item: viewLookupKey });
        return getViewBinder(viewLookupKey) || { view: null };
    }
    let viewLookup = viewLookupFunc(moduleBinder, themeBinder);
    // If no component found in the theme, search in parent theme (in case of inherited theme)
    if (!viewLookup && themeBinder) {
        const parentThemeName = getModuleName(themeBinder.parentDefinitionPath);
        const parentThemeBinder = getModuleBinder(parentThemeName);
        viewLookup = viewLookupFunc(moduleBinder, parentThemeBinder);
    }
    // If no view file found, fall back to module's default view
    if (!viewLookup) {
        viewLookup = defaultViewLookupFunc(moduleBinder);
    }
    if (viewLookup) {
        cache.put(viewCacheKey, { item: viewLookup.key });
        // @ts-ignore
        context.actionContext.requestCache.put(viewCacheKey, { item: viewLookup.key });
        return viewLookup;
    }
    return { view: null };
};
export const renderView = (props) => {
    props.telemetry.log(LogLevel.Debug, `rendering view-'${props.typeName}' with id-'${props.id}'`);
    const moduleBinder = getModuleBinder(props.typeName);
    if (!moduleBinder) {
        props.context.telemetry.log(LogLevel.Error, EXCEPTION_NOMODULEBINDER, { values: [asSystemMetadata(props.typeName)] });
        return null;
    }
    const themeBinder = getModuleBinder(props.context.actionContext.requestContext.params.theme);
    const { view } = getView(moduleBinder, themeBinder, props.context);
    if (!view) {
        return props.context.actionContext.requestContext.params.isDebug ? (React.createElement("section", null,
            React.createElement("h2", null, "View not found - location searched at"),
            React.createElement("p", null, `views/${moduleBinder.name}.view.tsx`),
            React.createElement("p", null, themeBinder
                ? `views/${themeBinder.name}/${moduleBinder.name}.view.tsx`
                : `No theme [${props.context.actionContext.requestContext.params.theme}] found at local/src`),
            React.createElement("p", null, themeBinder
                ? `${themeBinder.moduleNamespace !== '__local__'
                    ? `${themeBinder.moduleNamespace}/${themeBinder.packageName}/`
                    : ''}modules/${themeBinder.name}/views/${moduleBinder.name}.view.tsx`
                : `No theme [${props.context.actionContext.requestContext.params.theme}] found at node_modules`),
            React.createElement("p", null, `${moduleBinder.moduleNamespace !== '__local__' ? `${moduleBinder.moduleNamespace}/${moduleBinder.packageName}/` : ''}modules/${moduleBinder.name}/${moduleBinder.name}.view.tsx`))) : null;
    }
    const Component = view.component;
    return React.createElement(Component, Object.assign({}, props));
};
//# sourceMappingURL=render-view.js.map