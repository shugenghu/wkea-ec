{"version":3,"file":"render-component.js","sourceRoot":"","sources":["../../../src/app-initialization/render-component.tsx"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\nimport { ICache, ICacheKey } from '@msdyn365-commerce/cache-internal';\nimport { ComponentType, IComponent, IComponentProps, ICoreContext, IModule, msdyn365Commerce } from '@msdyn365-commerce/core-internal';\nimport { asSystemMetadata, EXCEPTION_NOMODULEBINDER, LogLevel } from '@msdyn365-commerce/telemetry-internal';\nimport * as path from 'path';\nimport React from 'react';\nimport { IMSDyn365CommerceExtension } from '../app-initialization/models';\nimport { getModuleName } from '../utils/helpers';\n\nexport interface IModuleWithView extends IModule {\n    View: React.FunctionComponent;\n}\n\nconst getModuleBinder = (typeName: string) => ((msdyn365Commerce as unknown) as IMSDyn365CommerceExtension).moduleBinder(typeName);\n\nconst getBinder = (lookupKey: string) => {\n    const view = ((msdyn365Commerce as unknown) as IMSDyn365CommerceExtension).componentBinder(lookupKey);\n    if (view) {\n        return { key: lookupKey, view };\n    }\n    return undefined;\n};\n\n/* component will be read in following hierarchy\n        1) __local__/__local__|views/theme1/BuyBox/Components/PriceComponent\n        2) __local__/__local__|views/theme1/Components/PriceComponent\n        3) @msdyn-365-commerce-modules/theme1/views/BuyBox/Components/PriceComponent\n        4) @msdyn-365-commerce-modules/theme1/views/Components/PriceComponent\n    */\nconst lookupFunc = (moduleBinder, themeBinder, name) => {\n    name = name.toLowerCase();\n    return (\n        (themeBinder &&\n            (getBinder(`__local__|__local__|themes|${themeBinder.name}|views|${moduleBinder.name}|components|${name}`) ||\n                getBinder(`__local__|__local__|themes|${themeBinder.name}|views|components|${name}`) ||\n                getBinder(\n                    `${themeBinder.moduleNamespace}|${themeBinder.packageName}|modules|${themeBinder.name}|views|components|${moduleBinder.name}|${name}`\n                ) ||\n                getBinder(\n                    `${themeBinder.moduleNamespace}|${themeBinder.packageName}|modules|${themeBinder.name}|views|components|${name}`\n                ))) ||\n        getBinder(`${moduleBinder.moduleNamespace}|${moduleBinder.packageName}|views|${moduleBinder.name}|components|${name}`)\n    );\n};\n\n/**\n * Component will be read from the module\n *  @msdyn-365-commerce-modules/BuyBox/views/BuyBox/Components/PriceComponent\n */\nconst defaultComponentLookupFunc = (moduleBinder, name) => {\n    const parentModuleBinder = getModuleBinder(getModuleName(moduleBinder.parentDefinitionPath));\n\n    return (\n        getBinder(`${moduleBinder.moduleNamespace}|${moduleBinder.packageName}|views|${moduleBinder.name}|components|${name}`) ||\n        (parentModuleBinder &&\n            getBinder(\n                `${parentModuleBinder.moduleNamespace}|${parentModuleBinder.packageName}|views|${parentModuleBinder.name}|components|${name}`\n            ))\n    );\n};\n\nconst getComponent = (name, moduleBinder, themeBinder, context: ICoreContext) => {\n    if (!moduleBinder) {\n        return { view: null };\n    }\n\n    // tslint:disable-next-line:no-any\n    const cache: ICache = (msdyn365Commerce as any).getAppCache(context.actionContext.requestContext);\n    const cacheKey: ICacheKey = {\n        key: `${name}|${moduleBinder.name}|${themeBinder ? themeBinder.name : 'no-theme'}`,\n        typeName: '__ComponentCacheKey__'\n    };\n    const lookupKey = cache.getValue<string>(cacheKey);\n\n    if (lookupKey) {\n        context.telemetry.log(LogLevel.Debug, `lookup key for component [${cacheKey.key}] found at - [${lookupKey}]`);\n        // @ts-ignore\n        !msdyn365Commerce.isBrowser && context.actionContext.requestCache.put(cacheKey, { item: lookupKey });\n        return getBinder(lookupKey) || { view: null };\n    }\n\n    let component = lookupFunc(moduleBinder, themeBinder, name);\n\n    // If no component found in the theme, search in parent theme (in case of inherited theme)\n    if (!component && themeBinder) {\n        const parentThemeName = getModuleName(themeBinder.parentDefinitionPath);\n        const parentThemeBinder = getModuleBinder(parentThemeName);\n        component = lookupFunc(moduleBinder, parentThemeBinder, name);\n    }\n\n    // If no component file found, fall back to module's default component\n    if (!component) {\n        component = defaultComponentLookupFunc(moduleBinder, name);\n    }\n\n    if (component) {\n        context.telemetry.log(LogLevel.Debug, `lookup key for component [${cacheKey.key}] found at - [${component.key}]`);\n        cache.put(cacheKey, { item: component.key });\n        // @ts-ignore\n        context.actionContext.requestCache.put(cacheKey, { item: component.key });\n        return component;\n    }\n\n    return { view: null };\n};\n\nexport const createComponent = <T extends IComponent<IComponentProps>>(name: ComponentType, componentObj: T) => (\n    props: IComponentProps\n) => {\n    props.context.telemetry.log(LogLevel.Debug, `rendering component-'${name}' within module-'${props.id}-${props.typeName}'`);\n    const moduleBinder = getModuleBinder(props.typeName);\n    if (!moduleBinder) {\n        props.context.telemetry.log(LogLevel.Error, EXCEPTION_NOMODULEBINDER, { values: [asSystemMetadata(props.typeName)] });\n        return null;\n    }\n\n    const themeBinder = getModuleBinder(props.context.actionContext.requestContext.params.theme);\n    const { view } = getComponent(name, moduleBinder, themeBinder, props.context);\n    const mergedComponent = view ? { ...((componentObj as unknown) as object), ...view } : componentObj;\n    const Component = mergedComponent.component;\n    return <Component {...props} />;\n};\n"]}