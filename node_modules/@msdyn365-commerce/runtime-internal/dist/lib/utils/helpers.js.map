{"version":3,"file":"helpers.js","sourceRoot":"","sources":["../../../src/utils/helpers.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { ICacheItem, ICacheKey } from '@msdyn365-commerce/cache-internal';\nimport {\n    IDictionary,\n    IParsedQSP,\n    IRenderingHelper,\n    IRequestContext,\n    msdyn365Commerce,\n    MSDyn365Commerce,\n    SDK_FRAGMENT_NAME,\n    SDK_FRAGMENT_NAME_REGEX\n} from '@msdyn365-commerce/core-internal';\nimport { EXCEPTION_EXPECTED501, IInternalTelemetry, StaticTelemetry } from '@msdyn365-commerce/telemetry-internal';\nimport { NextFunction, Request, Response } from 'express';\nimport * as fs from 'fs';\nimport { getCurrency } from 'locale-currency';\nimport { escape } from 'lodash';\nimport * as path from 'path';\nimport { ReactElement } from 'react';\nimport { renderToString } from 'react-dom/server';\nimport * as semver from 'semver';\nimport { Stream } from 'stream';\nimport { THEME_MODULE } from '../_server/Definition/moduleDefinition';\nimport { HttpException } from '../_server/error';\nimport { IMSDyn365CommerceExtension } from '../app-initialization/models';\n\nexport const MODULE_ERROR_TYPE_NAME_FOR_CACHE: string = '__ME';\nexport const EMPTY_MODULE_RESULT_VALUE = 'empty-module-result';\nexport const UNREGISTERED_MODULE_VALUE = 'unregistered-module';\n\n// Used to deprecate older modules starting SSK V2\nexport const SSK2_VERSION = '2.0.0';\n\n/**\n * Creates and returns an ICacheKey object for storing\n * results of module render errors inside the RequestCache\n *\n * @param id The id of the module that encountered an error\n */\nexport const createCacheKeyForModuleError = (id: string): ICacheKey => {\n    return { typeName: MODULE_ERROR_TYPE_NAME_FOR_CACHE, key: id };\n};\n\n/**\n * Creates and returns an ICacheItem object that inidcates\n * a module render result was null or empty\n */\nexport const createCacheValueForEmptyModule = (): ICacheItem<string> => {\n    return { item: EMPTY_MODULE_RESULT_VALUE };\n};\n\n/**\n * Creates and returns an ICacheItem object that inidcates\n * a module was unregistered and thus not rendered\n */\nexport const createCacheValueForUnregisteredModule = (): ICacheItem<string> => {\n    return { item: UNREGISTERED_MODULE_VALUE };\n};\n\n/**\n * Utility function to async check if file exists\n * @param filePath file path to check\n */\nexport const fileExists = async (filePath: string, telemetry: IInternalTelemetry) => {\n    return new Promise((resolve: (pathToFileThatExists?: string) => void, reject: () => void) => {\n        if (!filePath) {\n            resolve(undefined);\n        }\n\n        fs.access(filePath, fs.constants.R_OK, (err: NodeJS.ErrnoException | null) => {\n            if (err) {\n                resolve(undefined);\n            }\n            resolve(filePath);\n        });\n    });\n};\n\n/**\n * Utility function to access the site builder rendering helper\n */\nexport const getRenderingHelper = (): IRenderingHelper | undefined => {\n    // @ts-ignore\n    return window._msdyn365.authoringHelper && window._msdyn365.authoringHelper.renderingHelper;\n};\n\n/**\n * Converts a readable stream (that has yet to emit 'data') to a string\n *\n * @param stream Stream-like object\n */\nexport const streamToString = (stream: Stream): Promise<string> => {\n    return new Promise((resolve: (streamAsString: string) => void) => {\n        const stringParts: string[] = [];\n        stream.on('data', (buffer: Buffer) => {\n            stringParts.push(buffer.toString());\n        });\n        stream.on('end', () => {\n            resolve(stringParts.join(''));\n        });\n    });\n};\n\n/**\n * Checks is value is truthy\n * @param value value to check\n */\nexport const isTruthy = (value: number | boolean | string | undefined | null) => {\n    if (value === undefined || value === null) {\n        return false;\n    }\n    switch (String(value).toLocaleLowerCase()) {\n        case '1':\n        case 'true':\n        case 'yes':\n            return true;\n        case '0':\n        case 'false':\n        case 'no':\n        case 'undefined':\n        case '':\n            return false;\n        default:\n            return !!value;\n    }\n};\n\n/**\n * Checks optional QSP value and returns as a structured type\n *\n * @param qspValue QSP value to check\n */\nexport const parseToQSPObject = <TValue>(qspValue: TValue): IParsedQSP<TValue> => {\n    return {\n        hasValue: qspValue !== undefined,\n        isTruthy: isTruthy(String(qspValue)),\n        value: qspValue\n    };\n};\n\n/**\n * Server has whitelisting of QSPs, so QSPs going through Server have be put beind a whitelisted QSP such as item.\n *\n * Example:\n *  In localhost, we'll have `?debug=true` but when running through Server, this is equivalent to ?item=debug:true\n *\n * This method also supports parsing out a comma separated item list, makes assumption that everything is properly URIEncoded\n *  e.g. ?item=debug:true,foo:bar,bar:123\n *\n * @param itemQueryString the `item` query string value\n */\nexport const parseItemQSP = (itemQueryString: string | undefined | null): IDictionary<string> => {\n    const result: IDictionary<string> = {};\n    if (itemQueryString === undefined || itemQueryString === null) {\n        return result;\n    }\n    const decodedUriParts = decodeURIComponent(itemQueryString).split(',');\n    decodedUriParts.forEach((qsp: string) => {\n        const qspParts = qsp.split(':');\n        if (qspParts && qspParts.length === 2) {\n            const [key, value] = qspParts;\n            if (key.length && value.length) {\n                result[key] = value;\n            }\n        }\n    });\n    return result;\n};\n\nexport const LinkTag = (baseUrl: string, preloadAttribute: string) => (src: string) =>\n    `<link rel=\"stylesheet\" href=\"${baseUrl}${src}\" ${preloadAttribute} crossOrigin=\"anonymous\" />`;\n\nexport const CommentTag = (comment: string | object) => {\n    if (typeof comment === 'object') {\n        return Object.keys(comment)\n            .map(key => `<!-- key: ${escape(key)}, value: ${escape(JSON.stringify(comment[key]))} -->`)\n            .join('');\n    }\n    return `<!-- ${escape(comment)} -->`;\n};\n\n// tslint:disable:no-any\n/**\n * Wraps express routes and makes sure to catch & rethrow any errors.\n * Actual handling will be done by the handlerServerError method that logs error and sends response\n * @param fn Function for wrapped route\n */\nexport const safeRoute = fn => (...args: any[]) =>\n    fn(...args).catch((error: Error) => {\n        args[2] && args[2](error);\n    });\n// tslint:enable:no-any\n\n/**\n * Sample helper\n * @param res Response\n */\nexport const throwHelper = (req: Request, res: Response, next: NextFunction, message: string) => {\n    throw new HttpException(501, StaticTelemetry.stringFormat(EXCEPTION_EXPECTED501, [message]));\n};\n\nexport const getAbsoluteUri = (req): string => {\n    return `${req.protocol}://${req.get('host')}${req.originalUrl}`;\n};\n\n/**\n * Wrapped render to string method that replaces the SDK Fragment element with nothing\n * used as a drop-in for renderToString on elements where we blindly set innerHTML.\n *\n * @param element the element to render\n */\n// tslint:disable-next-line:no-any\nexport const patchedRenderToString = (element: ReactElement, disableServerSideErrorChecking: boolean) => {\n    const renderResult = renderToString(element);\n    if (disableServerSideErrorChecking || !renderResult.startsWith(`<${SDK_FRAGMENT_NAME}`)) {\n        return renderResult;\n    }\n    return renderResult.replace(SDK_FRAGMENT_NAME_REGEX, '');\n};\n\nexport const CurrencyCodeIdentifier = 'cc';\nexport const getCurrencyCodeFromContext = (requestContext: IRequestContext) => {\n    return (\n        (requestContext && requestContext.query && requestContext.query[CurrencyCodeIdentifier]) ||\n        (requestContext.cookies && requestContext.cookies.get<string>(CurrencyCodeIdentifier).value) ||\n        (requestContext.channel && requestContext.channel.Currency) ||\n        getCurrency(requestContext.locale)\n    );\n};\n\n/**\n * Extracts the name of the module from the path to its definition file\n * @param definitionPath path to the definition file\n */\nexport const getModuleName = (definitionPath: string) => {\n    if (!definitionPath || definitionPath === '') {\n        return '';\n    }\n\n    return path.basename(definitionPath, THEME_MODULE.DEFINITION_FILE);\n};\n\n/**\n * Returns the binder object for the given module\n * @param typeName name of the module\n */\nexport const getModuleBinder = (typeName: string) => (<IMSDyn365CommerceExtension>(<unknown>msdyn365Commerce)).moduleBinder(typeName);\n\n/**\n * Returns name of the parent module for given module name\n * @param moduleName name of the module\n */\nexport const getParentModuleName = (moduleName: string) => {\n    const moduleBinder = getModuleBinder(moduleName);\n\n    if (!moduleBinder) {\n        return '';\n    }\n\n    return getModuleName(moduleBinder.parentDefinitionPath);\n};\n\nexport const isSSK2App = () => {\n    const sskVersion =\n        !process.env.MSDyn365Commerce_SSK_VERSION || process.env.MSDyn365Commerce_SSK_VERSION === '--'\n            ? '0.0'\n            : process.env.MSDyn365Commerce_SSK_VERSION;\n\n    return semver.gt(semver.coerce(sskVersion) || '', SSK2_VERSION);\n};\n"]}