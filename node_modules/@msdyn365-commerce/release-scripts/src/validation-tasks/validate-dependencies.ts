/*******************************************************************************
 * Copyright (c) Microsoft Corporation.
 * All rights reserved. See LICENSE in the project root for license information.
 *******************************************************************************/

import { runSchemaValidationWithNestedError, safeReadJsonSync } from '@msdyn365-commerce/utilities-internal';
import chalk from 'chalk';
import { Validator } from 'jsonschema';
import { resolve } from 'path';
const packageJsonSchemaPath = resolve(__dirname, '../schemas/valid-package-json.schema.json');

export const validateDependencies = (partnerPackageJson: string) => {
    const packageJsonSchema = safeReadJsonSync(packageJsonSchemaPath)!;
    const partnerJson: JSON | undefined = safeReadJsonSync(resolve(partnerPackageJson));
    const validator = new Validator();

    if (!partnerJson) {
        console.error(chalk.red(`[ERROR]: Invalid package artifact ${partnerPackageJson}`));
        return false;
    }
    try {
        const validationResult = runSchemaValidationWithNestedError(validator, partnerJson, packageJsonSchema);

        if (validationResult.errors.length) {
            console.error(chalk.red(`[ERROR]: Package.json does not match package.json schema`));
            validationResult.errors.forEach(error => {
                console.error(chalk.red(`[SCHEMA ERROR]: ${error}`));
            });
            return false;
        }
    } catch (e) {
        console.error(chalk.red(`[ERROR]: Unknown validation error ${e}`));
        return false;
    }

    return true;
};
