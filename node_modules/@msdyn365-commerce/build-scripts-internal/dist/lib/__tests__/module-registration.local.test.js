"use strict";
/*!
 * Copyright (c) Microsoft Corporation.
 * All rights reserved. See LICENSE in the project root for license information.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var utilities_internal_1 = require("@msdyn365-commerce/utilities-internal");
var fs = tslib_1.__importStar(require("fs-extra"));
require("jest");
var path_1 = tslib_1.__importDefault(require("path"));
jest.mock('../module-registration/module-registration-model');
jest.unmock('../module-registration/module-registration');
var mockedUtilities = require.requireActual('@msdyn365-commerce/utilities-internal');
mockedUtilities.getSupportedNamespaces = function () { return ['@msdyn365-commerce-modules', '@msdyn365-commerce-partners']; };
jest.mock('../module-registration/module-registration-model', mockedUtilities);
describe('Module Registration Tests (Local Modules)', function () {
    /**
     * THIS TEST CASE MUST NOT BE IGNORED/SKIPPED UNDER ANY CIRCUMSTANCES
     *
     * Valdiates installed modules to be included in build registration output. Test compares the build registration
     * output against a snapshot file in __mocks__/snapshot/module-registration.js. In case if you need to change
     * build-registration code, please update snapshot as well, Under no circumstances this test case can be ignored.
     */
    beforeAll(function () { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
        var model, helper;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    model = require.requireMock('../module-registration/module-registration-model');
                    helper = require.requireActual('../module-registration/module-registration');
                    helper.msdyn365ModuleGlobPattern = jest.fn(function () { return model.DEFINITION.fromLocalModule; });
                    helper.msdyn365ModuleDataDefinitionGlobPattern = jest.fn(function () { return model.localModuleDataDefinitionPathPattern; });
                    return [4 /*yield*/, helper.generateModuleRegistration(true)];
                case 1:
                    _a.sent();
                    return [4 /*yield*/, helper.generateViewRegistration()];
                case 2:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    }); });
    // tslint:disable-next-line:no-any
    it('validate local modules registration', function (done) { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
        var modulesRegistrationFile, _a, registrationOutput, viewRegistrationFile, _b, viewRegistrationOutput;
        return tslib_1.__generator(this, function (_c) {
            switch (_c.label) {
                case 0:
                    modulesRegistrationFile = path_1.default.resolve(process.cwd(), 'lib/module-registration.local.js');
                    _a = expect;
                    return [4 /*yield*/, utilities_internal_1.safeFileExists(modulesRegistrationFile)];
                case 1:
                    _a.apply(void 0, [_c.sent()]).not.toBe(undefined);
                    registrationOutput = fs.readFileSync(path_1.default.resolve(modulesRegistrationFile));
                    expect(registrationOutput && registrationOutput.toString()).toMatchSnapshot();
                    viewRegistrationFile = path_1.default.resolve(process.cwd(), 'lib/view-registration.js');
                    _b = expect;
                    return [4 /*yield*/, utilities_internal_1.safeFileExists(viewRegistrationFile)];
                case 2:
                    _b.apply(void 0, [_c.sent()]).not.toBe(undefined);
                    viewRegistrationOutput = fs.readFileSync(path_1.default.resolve(viewRegistrationFile));
                    expect(viewRegistrationOutput && viewRegistrationOutput.toString()).toMatchSnapshot();
                    done();
                    return [2 /*return*/];
            }
        });
    }); });
    // tslint:disable-next-line:no-any
    it('validate module registration when there are no definition and data definition files', function (done) { return tslib_1.__awaiter(void 0, void 0, void 0, function () {
        var helper, result;
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    helper = require.requireActual('../module-registration/module-registration');
                    helper.msdyn365ModuleGlobPattern = jest.fn(function () { return ''; });
                    helper.msdyn365ModuleDataDefinitionGlobPattern = jest.fn(function () { return ''; });
                    return [4 /*yield*/, helper.generateModuleRegistration(true)];
                case 1:
                    result = _a.sent();
                    expect(result).toEqual([true]);
                    done();
                    return [2 /*return*/];
            }
        });
    }); });
});
//# sourceMappingURL=module-registration.local.test.js.map