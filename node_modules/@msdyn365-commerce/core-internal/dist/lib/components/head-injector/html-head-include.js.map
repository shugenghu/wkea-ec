{"version":3,"file":"html-head-include.js","sourceRoot":"","sources":["../../../../src/components/head-injector/html-head-include.tsx"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { isEqual } from 'lodash';\nimport React, { Component } from 'react';\nimport withSideEffect from 'react-side-effect';\nimport { IDictionary, IGeneric } from '../../interfaces';\nimport { updateHead } from './html-head-utils';\nimport {\n    ALLOWED_DUPLICATES,\n    BODY_END_LOAD_POINT,\n    BODY_START_LOAD_POINT,\n    COMPONENT_TYPES,\n    DATA_LOAD_POINT,\n    FAVICON_REL,\n    HEAD_ELEMENT_IDENTIFIER_ATTR,\n    HEAD_END_LOAD_POINT,\n    HEAD_START_LOAD_POINT,\n    HtmlHeadElement,\n    IHtmlHead,\n    IHtmlHeadProps,\n    META_CONTENT_APPEND_ATTR,\n    METATYPES,\n    NON_SCRIPT_TAGS,\n    TAG_NAMES\n} from './IHtmlHeadModel';\n\nimport msdyn365Commerce from '../../msdyn365-commerce';\n\n/**\n * reduces props of various HtmlHeadInclude instances and deduces a final state value\n *\n * @function reduceComponents\n * @access public\n * @param {IHtmlHeadProps[]} props - props list of all the HtmlHeadInclude instances\n * @return {HtmlHead} - final list of merged tags\n */\nfunction reduceComponents(props: IHtmlHeadProps[]): IHtmlHead {\n    const reducedComponents = props\n        .map((component: IHtmlHeadProps) => {\n            return component.children;\n        })\n        .reduce((a: React.ReactChild[], b: React.ReactChild[]) => {\n            if (b instanceof React.createElement || Array.isArray(b)) {\n                return a.concat(React.Children.toArray(b));\n            }\n\n            return a.concat(b);\n        }, [])\n        .reverse()\n        .filter(Boolean)\n        .filter(unique())\n        .reverse();\n\n    const mergedComponents: HtmlHeadElement[] = [];\n    reducedComponents.forEach((child: React.ReactChild, index: number): void => {\n        const childElement = child as HtmlHeadElement;\n\n        // Append content for conflicting meta tags with same 'name' property\n        if (childElement.type === TAG_NAMES.META) {\n            for (let i = 0; i < mergedComponents.length; ++i) {\n                if (\n                    mergedComponents[i].props.name === childElement.props.name &&\n                    (mergedComponents[i].props[META_CONTENT_APPEND_ATTR] || childElement.props[META_CONTENT_APPEND_ATTR])\n                ) {\n                    mergedComponents[i] = React.cloneElement(mergedComponents[i], {\n                        content: `${mergedComponents[i].props.content}, ${childElement.props.content}`\n                    });\n\n                    return;\n                }\n            }\n        }\n\n        const className =\n            (childElement.props && childElement.props.className ? `${childElement.props.className} ` : '') + HEAD_ELEMENT_IDENTIFIER_ATTR;\n        const key = childElement.key || index;\n\n        mergedComponents.push(React.cloneElement(childElement, { key, className }));\n    });\n    // Initialize dictionary to map all merged components into their respective slots\n    const componentMap: IDictionary<HtmlHeadElement[]> = {};\n    // tslint:disable-next-line: prefer-for-of\n    for (let i = 0; i < COMPONENT_TYPES.length; i++) {\n        componentMap[COMPONENT_TYPES[i]] = [];\n    }\n    let hasFavIcon: boolean = false;\n    // Loop through the merged components and map the component to its appropriate slot\n    mergedComponents.forEach((comp: HtmlHeadElement) => {\n        if (comp.type === 'script') {\n            switch (comp.props[DATA_LOAD_POINT]) {\n                case HEAD_START_LOAD_POINT:\n                    componentMap[HEAD_START_LOAD_POINT].push(comp);\n                    break;\n                case HEAD_END_LOAD_POINT:\n                    componentMap[HEAD_END_LOAD_POINT].push(comp);\n                    break;\n                case BODY_START_LOAD_POINT:\n                    componentMap[BODY_START_LOAD_POINT].push(comp);\n                    break;\n                default:\n                    componentMap[BODY_END_LOAD_POINT].push(comp);\n            }\n        } else if (comp.type !== 'script') {\n            if (FAVICON_REL.indexOf(comp.props.rel) !== -1) {\n                hasFavIcon = true;\n            }\n            componentMap[NON_SCRIPT_TAGS].push(comp);\n        }\n    });\n\n    return {\n        tags: mergedComponents,\n        nonScriptTags: componentMap[NON_SCRIPT_TAGS],\n        scriptTags: {\n            headStart: componentMap[HEAD_START_LOAD_POINT],\n            headEnd: componentMap[HEAD_END_LOAD_POINT],\n            bodyStart: componentMap[BODY_START_LOAD_POINT],\n            bodyEnd: componentMap[BODY_END_LOAD_POINT]\n        },\n        hasFavIcon: hasFavIcon\n    };\n}\n\n/*\n returns a function for filtering head child elements\n which shouldn't be duplicated, like <title/>,\n except we explicit allow it in ALLOWED_DUPLICATES array\n*/\nexport function unique(): (h: React.ReactChild) => boolean {\n    const keys = new Set();\n    const tags = new Set();\n    const metaTypes = new Set();\n    const metaCategories: IGeneric<unknown> = {};\n\n    return (tagComponent: React.ReactChild) => {\n        const tagElement = tagComponent as HtmlHeadElement;\n\n        if (tagElement instanceof React.createElement && tagElement.key) {\n            if (keys.has(tagElement.key)) {\n                return false;\n            }\n\n            keys.add(tagElement.key);\n        }\n\n        switch (tagElement.type) {\n            case TAG_NAMES.TITLE:\n            case TAG_NAMES.BASE:\n                if (tags.has(tagElement.type)) {\n                    return false;\n                }\n\n                tags.add(tagElement.type);\n                break;\n            case TAG_NAMES.META:\n                // tslint:disable-next-line: prefer-for-of\n                for (let i = 0; i < METATYPES.length; i++) {\n                    const metaType = METATYPES[i];\n                    if (tagElement.props[metaType]) {\n                        if (metaType === 'charSet') {\n                            if (metaTypes.has(metaType)) {\n                                return false;\n                            }\n\n                            metaTypes.add(metaType);\n                        } else {\n                            const category = tagElement.props[metaType];\n                            const categories = metaCategories[metaType] || new Set();\n                            if (categories.has(category) && !ALLOWED_DUPLICATES.has(category)) {\n                                return false;\n                            }\n\n                            categories.add(category);\n                            metaCategories[metaType] = categories;\n                        }\n                    }\n                }\n\n                break;\n            case TAG_NAMES.LINK:\n                tags.add(tagElement.type);\n                break;\n            default:\n        }\n\n        return true;\n    };\n}\n\n/**\n * maps state on server\n * @function mapOnServer\n * @param {HtmlHead} head - final list of merged tags\n * @return {HtmlHead} - final list of merged tags\n */\nfunction mapOnServer(head: IHtmlHead): IHtmlHead {\n    return head;\n}\n\n/**\n * state change handler\n * @function onStateChange\n * @param {HtmlHead} head - final list of merged tags\n */\nfunction onStateChange(head: IHtmlHead): void {\n    updateHead(head);\n}\n\n/**\n * <HtmlHeadInclude>\n *     <title></title>\n *     <meta name='description' content='Home page'>\n *     <meta property='og:type, content='article>\n *     <script src='http://include.com/pathtojs.js  type='text/javascript' />\n * </HtmlHeadInclude>\n *\n * HigherOrder Component to wrap HtmlHeadInclude instance and pass it to another higher order component withSideEffect\n * that tracks changes on various instances of HtmlHeadInclude and arrives at a final merged list of props that can be\n * used to update head tags\n */\n// tslint:disable-next-line:no-any\nconst withHtmlHeadInclude = (WrappedComponent: any) =>\n    class WrapperComponent extends Component {\n        static set canUseDOM(canUseDOM: boolean) {\n            WrappedComponent.canUseDOM = canUseDOM;\n        }\n\n        public static peek = () => {\n            return WrappedComponent.peek();\n        };\n\n        public static rewind = () => {\n            let mappedState = WrappedComponent.rewind();\n            if (!mappedState) {\n                // provide fallback if mappedState is undefined\n                mappedState = mapOnServer({\n                    tags: [],\n                    nonScriptTags: [],\n                    scriptTags: {\n                        headStart: [],\n                        headEnd: [],\n                        bodyStart: [],\n                        bodyEnd: []\n                    },\n                    hasFavIcon: false\n                });\n            }\n\n            return mappedState;\n        };\n\n        public shouldComponentUpdate(nextProps: IGeneric<unknown>): boolean {\n            return !isEqual(this.props, nextProps);\n        }\n\n        public render(): JSX.Element | null {\n            if (msdyn365Commerce.isBrowser) {\n                return <React.Fragment />;\n            }\n\n            return <WrappedComponent {...this.props} />;\n        }\n    };\n\nconst htmlHeadIncludeWithSideEffect = withSideEffect(reduceComponents, onStateChange, mapOnServer);\nexport const HtmlHeadInclude = withHtmlHeadInclude(htmlHeadIncludeWithSideEffect(() => null));\n"]}