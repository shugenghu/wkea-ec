{"version":3,"file":"image.js","sourceRoot":"","sources":["../../../../src/components/image/image.tsx"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport classnames from 'classnames';\nimport * as React from 'react';\nimport ReactDOM from 'react-dom';\nimport { IImageSettings } from '../..';\nimport { IAny, IGeneric } from '../../interfaces';\nimport { EditableField, FieldType } from '../../utilities/editable-fields/editable-field';\nimport { IImageProps, Viewport } from './IImage';\nimport { getImageResizeUrl, getLargestGridSettingViewportName, getSourceData } from './source-builder';\n\nexport const placeholderImageUrl = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAEALAAAAAABAAEAAAIBTAA7';\n\nexport interface IPictureState {\n    loadFailed: boolean;\n    src: string;\n}\n\n/**\n *  Image\n */\nexport class Image extends React.PureComponent<IImageProps, IPictureState> {\n    constructor(props: IImageProps) {\n        super(props);\n        this.state = {\n            loadFailed: false,\n            src: props.src\n        };\n    }\n\n    public componentDidUpdate(prevProps: IImageProps): void {\n        if (this.props.src !== prevProps.src || this.props.fallBackSrc !== prevProps.fallBackSrc) {\n            this.setState({ loadFailed: false, src: this.props.src });\n        }\n    }\n    public componentDidMount(): void {\n        // onError will sometimes fire before the react events get hooked up. So we\n        // cannot rely on it for determining when image load fails. Instead we also have\n        // to find the img that the Image component uses> If its complete, but naturalWidth\n        // is zero that means load failed\n        const node = ReactDOM.findDOMNode(this) as HTMLElement;\n\n        if (node && node.querySelector) {\n            const child = node.querySelector('img');\n            if (child && child.complete && child.naturalWidth === 0) {\n                if ((this.props.fallBackSrc && this.props.fallBackSrc === this.state.src) || !this.props.fallBackSrc) {\n                    this.setState({ loadFailed: true });\n                } else {\n                    this.setState({ src: this.props.fallBackSrc ? this.props.fallBackSrc : this.props.src });\n                }\n                return;\n            }\n        }\n    }\n\n    public render(): JSX.Element | null {\n        const { loadFailureBehavior, pictureAttributes = {}, gridSettings, fallBackSrc, ...imageAttributes } = this.props;\n        if (this.state.loadFailed || !this.props.src) {\n            if (loadFailureBehavior === 'hide') {\n                return null;\n            } else if (loadFailureBehavior === 'empty') {\n                return <div className={classnames('msc-empty_image', imageAttributes.className)} />;\n            }\n        }\n\n        const imageSettings = this.props.imageSettings || imageAttributes.imageSettings;\n        const largestGridSettingViewportName = getLargestGridSettingViewportName(gridSettings);\n\n        // Lazyload by default if nothing is specified\n        const lazyLoad = !imageSettings || !imageSettings.disableLazyLoad;\n\n        const sourceTags: (JSX.Element | undefined)[] =\n            imageSettings && imageSettings.viewports\n                ? Object.keys(imageSettings.viewports)\n                      .map(vp => this.getSourceTag(vp as Viewport, imageSettings, largestGridSettingViewportName, lazyLoad))\n                      .filter(Boolean) || []\n                : [];\n\n        sourceTags.push(this.defaultImage(largestGridSettingViewportName, imageAttributes, lazyLoad, imageSettings));\n        return <picture {...pictureAttributes}>{sourceTags}</picture>;\n    }\n\n    private defaultImage = (\n        largestGridSettingViewportName: Viewport,\n        imageAttributes: IGeneric<IAny>,\n        lazyLoad: boolean,\n        inputImageSettings?: IImageSettings\n    ) => {\n        const {\n            src,\n            className,\n            image,\n            imageSettings,\n            binaryHash,\n            altText,\n            quality,\n            focalRegion,\n            cropRegions,\n            description,\n            fileName,\n            fileSize,\n            imageStyle,\n            isLocalizable,\n            isDecorativeImage,\n            orientation,\n            _links,\n            ...attributes\n        } = imageAttributes;\n\n        const cssClassName = this.props.className || '';\n        const filteredClassName = lazyLoad ? (cssClassName ? `${cssClassName} lazyload` : 'lazyload') : cssClassName;\n        const viewports = inputImageSettings && inputImageSettings.viewports;\n        if (viewports && Object.keys(viewports).length) {\n            delete attributes.width;\n            delete attributes.height;\n        }\n\n        const largestViewport = viewports && viewports[largestGridSettingViewportName];\n        const urlSrc = getImageResizeUrl(this.state.src, largestViewport, inputImageSettings);\n\n        return (\n            <EditableField\n                type={FieldType.Image}\n                editPropKey={this.props.editProps && this.props.editProps.key}\n                requestContext={this.props.editProps && this.props.editProps.requestContext}\n                fieldProps={{\n                    alt: this.props.altText,\n                    ...(lazyLoad ? { src: placeholderImageUrl, 'data-src': urlSrc } : { src: urlSrc }),\n                    ...attributes,\n                    key: 'default-image',\n                    className: filteredClassName,\n                    onError: this.imageFailed,\n                    additionalProperties: this.props.additionalProperties\n                }}\n            />\n        );\n    };\n\n    private imageFailed = (...args: unknown[]) => {\n        if ((this.props.fallBackSrc && this.props.fallBackSrc === this.state.src) || !this.props.fallBackSrc) {\n            this.setState({ loadFailed: true });\n        } else {\n            this.setState({ src: this.props.fallBackSrc ? this.props.fallBackSrc : this.props.src });\n        }\n        if (typeof this.props.onError === 'function') {\n            this.props.onError(...args);\n        }\n    };\n\n    private getSourceTag = (\n        viewport: Viewport,\n        imageSettings: IImageSettings,\n        largestGridSettingViewportName: Viewport,\n        lazyLoad: boolean\n    ) => {\n        const srcData = getSourceData(\n            this.state.src,\n            this.props.gridSettings,\n            this.props,\n            imageSettings,\n            viewport,\n            largestGridSettingViewportName\n        );\n        if (!srcData) {\n            return;\n        }\n        return (\n            <source\n                key={viewport}\n                {...(lazyLoad ? { 'data-srcset': srcData.srcSet } : { srcSet: srcData.srcSet })}\n                {...(srcData.media ? { media: srcData.media } : {})}\n            />\n        );\n    };\n}\n"]}