/*!
 * Copyright (c) Microsoft Corporation.
 * All rights reserved. See LICENSE in the project root for license information.
 */
import { createDataActionHook, TelemetryEvent } from '@msdyn365-commerce/core';
import { getProductInfoFromCart } from './telemetry.action.helper';
const beforeRemoveFromCart = async (inputs, actionContext) => {
    try {
        const actionInput = Array.isArray(inputs) ? inputs[0] : inputs;
        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {
            const removeCartLinesParams = actionInput.queryParams();
            if (removeCartLinesParams && removeCartLinesParams.cartLineIds) {
                actionContext.requestContext.telemetryData[`removedCartLineIds`] = removeCartLinesParams.cartLineIds;
                return;
            }
        }
        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed - No removed cart lines found');
    }
    catch (e) {
        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed.', e);
    }
};
const afterRemoveFromCart = async (_inputs, cart, actionContext) => {
    if (window && window._msdyn365 && window._msdyn365.telemetry) {
        const removeCartLineIds = actionContext.requestContext.telemetryData[`removedCartLineIds`];
        const activeCart = actionContext.requestContext.telemetryData[`activeCart`];
        const productTransaction = actionContext.requestContext.telemetryData[TelemetryEvent.Purchase];
        const removedCartLines = [];
        if (removeCartLineIds && activeCart && activeCart.CartLines) {
            activeCart.CartLines.forEach((cartLine) => {
                if (cartLine.ProductId &&
                    removeCartLineIds.indexOf(cartLine.LineId ? cartLine.LineId : '') !== -1 &&
                    !(productTransaction &&
                        productTransaction.products &&
                        productTransaction.products.some(product => +product.productSku === cartLine.ProductId))) {
                    removedCartLines.push(cartLine);
                }
            });
        }
        if (removedCartLines && removedCartLines.length > 0) {
            window._msdyn365.telemetry.logEvent(TelemetryEvent.RemoveFromCart, getProductInfoFromCart({ ...{}, ...cart, ...{ CartLines: removedCartLines } }, actionContext.requestContext.telemetryData, actionContext.requestContext));
        }
        else {
            actionContext.telemetry.debug('No RemoveFromCart event fired, no removed cart lines found');
        }
    }
};
createDataActionHook({
    actionId: '@msdyn365-commerce/retail-proxy/Carts/RemoveCartLines',
    postReaderHook: afterRemoveFromCart,
    preReaderHook: beforeRemoveFromCart
});
//# sourceMappingURL=removeFromCart-telemetry.action.js.map