{"version":3,"file":"removeFromCart-telemetry.action.js","sourceRoot":"./src/","sources":["actions/removeFromCart-telemetry.action.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { createDataActionHook, IActionContext, IActionInput, IMSDyn365Window, TelemetryEvent } from '@msdyn365-commerce/core';\nimport { Cart, CartLine, IDataServiceRequest, IRemoveCartLinesParam } from '@msdyn365-commerce/retail-proxy';\nimport { IProductTransaction } from '@msdyn365-commerce/telemetry-internal';\nimport { getProductInfoFromCart } from './telemetry.action.helper';\n\ndeclare var window: IMSDyn365Window;\n\n/**\n * Saves info on cart lines removed before calling data action\n * @param inputs Data action inputs\n * @param actionContext Action context\n */\nconst beforeRemoveFromCart = async (inputs: IActionInput | IActionInput[], actionContext: IActionContext) => {\n    try {\n        const actionInput = Array.isArray(inputs) ? <IDataServiceRequest>inputs[0] : <IDataServiceRequest>inputs;\n\n        // If cart lines were removed\n        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {\n            const removeCartLinesParams = actionInput.queryParams<IRemoveCartLinesParam>();\n            if (removeCartLinesParams && removeCartLinesParams.cartLineIds) {\n                // Save info on removed cart lines for post data action hook to pick up\n                actionContext.requestContext.telemetryData[`removedCartLineIds`] = removeCartLinesParams.cartLineIds;\n                return;\n            }\n        }\n        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed - No removed cart lines found');\n    } catch (e) {\n        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed.', e);\n    }\n};\n\n/**\n * Fires a RemoveFromCart event after data action completed\n * @param _inputs Data action inputs\n * @param cart New cart object after cart lines have been removed\n * @param actionContext Action context\n */\nconst afterRemoveFromCart = async (_inputs: IActionInput | IActionInput[], cart: Cart | Cart[], actionContext: IActionContext) => {\n    if (window && window._msdyn365 && window._msdyn365.telemetry) {\n        const removeCartLineIds = <string[]>actionContext.requestContext.telemetryData[`removedCartLineIds`];\n        const activeCart = <Cart>actionContext.requestContext.telemetryData[`activeCart`];\n        const productTransaction = <IProductTransaction>actionContext.requestContext.telemetryData[TelemetryEvent.Purchase];\n        const removedCartLines: CartLine[] = [];\n\n        // Collect info on products removed from cart\n        if (removeCartLineIds && activeCart && activeCart.CartLines) {\n            activeCart.CartLines.forEach((cartLine: CartLine) => {\n                if (\n                    cartLine.ProductId &&\n                    removeCartLineIds.indexOf(cartLine.LineId ? cartLine.LineId : '') !== -1 &&\n                    !(\n                        productTransaction &&\n                        productTransaction.products &&\n                        productTransaction.products.some(product => +product.productSku === cartLine.ProductId)\n                    )\n                ) {\n                    removedCartLines.push(cartLine);\n                }\n            });\n        }\n\n        // Fire RemoveFromCart event if cart lines were removed\n        if (removedCartLines && removedCartLines.length > 0) {\n            window._msdyn365.telemetry.logEvent(\n                TelemetryEvent.RemoveFromCart,\n                getProductInfoFromCart(\n                    { ...{}, ...cart, ...{ CartLines: removedCartLines } },\n                    actionContext.requestContext.telemetryData,\n                    actionContext.requestContext\n                )\n            );\n        } else {\n            actionContext.telemetry.debug('No RemoveFromCart event fired, no removed cart lines found');\n        }\n    }\n};\n\ncreateDataActionHook({\n    actionId: '@msdyn365-commerce/retail-proxy/Carts/RemoveCartLines',\n    postReaderHook: afterRemoveFromCart,\n    preReaderHook: beforeRemoveFromCart\n});\n"]}