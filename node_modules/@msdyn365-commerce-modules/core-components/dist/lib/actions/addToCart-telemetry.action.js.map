{"version":3,"file":"addToCart-telemetry.action.js","sourceRoot":"./src/","sources":["actions/addToCart-telemetry.action.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAEH,OAAO,EAAE,oBAAoB,EAAgC,MAAM,yBAAyB,CAAC;AAG7F,OAAO,EAAE,cAAc,EAAE,MAAM,uCAAuC,CAAC;AACvE,OAAO,EAAE,sBAAsB,EAAE,MAAM,2BAA2B,CAAC;AASnE,MAAM,eAAe,GAAG,KAAK,EAAE,MAAqC,EAAE,aAA6B,EAAE,EAAE;IACnG,IAAI;QACA,MAAM,WAAW,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAsB,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAsB,MAAM,CAAC;QAGzG,IAAI,WAAW,CAAC,WAAW,IAAI,OAAO,WAAW,CAAC,WAAW,KAAK,UAAU,EAAE;YAC1E,MAAM,kBAAkB,GAAG,WAAW,CAAC,WAAW,EAAsB,CAAC;YACzE,IAAI,kBAAkB,IAAI,kBAAkB,CAAC,SAAS,EAAE;gBAEpD,aAAa,CAAC,cAAc,CAAC,aAAa,CAAC,gBAAgB,CAAC,GAAG,kBAAkB,CAAC,SAAS,CAAC;gBAC5F,OAAO;aACV;SACJ;QACD,aAAa,CAAC,SAAS,CAAC,KAAK,CAAC,mEAAmE,CAAC,CAAC;KACtG;IAAC,OAAO,CAAC,EAAE;QACR,aAAa,CAAC,SAAS,CAAC,KAAK,CAAC,wCAAwC,EAAE,CAAC,CAAC,CAAC;KAC9E;AACL,CAAC,CAAC;AAQF,MAAM,cAAc,GAAG,KAAK,EAAE,OAAsC,EAAE,IAAmB,EAAE,aAA6B,EAAE,EAAE;IACxH,IAAI,MAAM,IAAI,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,CAAC,SAAS,EAAE;QAC1D,MAAM,aAAa,GAAsB,EAAE,CAAC;QAC5C,MAAM,cAAc,GAAe,aAAa,CAAC,cAAc,CAAC,aAAa,CAAC,gBAAgB,CAAC,CAAC;QAGhG,IAAI,cAAc,EAAE;YAChB,cAAc,CAAC,OAAO,CAAC,CAAC,QAAkB,EAAE,EAAE;gBAC1C,IAAI,QAAQ,IAAI,QAAQ,CAAC,SAAS,EAAE;oBAChC,MAAM,YAAY,GAAG,aAAa,CAAC,cAAc,CAAC,aAAa,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;oBACpF,IAAI,YAAY,EAAE;wBACd,aAAa,CAAC,QAAQ,CAAC,SAAS,CAAC,GAAG,YAAY,CAAC;qBACpD;iBACJ;YACL,CAAC,CAAC,CAAC;SACN;QAGD,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,QAAQ,CAC/B,cAAc,CAAC,SAAS,EACxB,sBAAsB,CAAC,IAAI,EAAE,aAAa,EAAE,aAAa,CAAC,cAAc,CAAC,CAC5E,CAAC;KACL;AACL,CAAC,CAAC;AAEF,oBAAoB,CAAC;IACjB,QAAQ,EAAE,oDAAoD;IAC9D,cAAc,EAAE,cAAc;IAC9B,aAAa,EAAE,eAAe;CACjC,CAAC,CAAC","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { createDataActionHook, IActionContext, IActionInput } from '@msdyn365-commerce/core';\nimport { IAny, IDictionary, IMSDyn365Window } from '@msdyn365-commerce/core-internal';\nimport { Cart, CartLine, IAddCartLinesParam, IDataServiceRequest } from '@msdyn365-commerce/retail-proxy';\nimport { TelemetryEvent } from '@msdyn365-commerce/telemetry-internal';\nimport { getProductInfoFromCart } from './telemetry.action.helper';\n\ndeclare var window: IMSDyn365Window;\n\n/**\n * Saves info on cart lines added before calling data action\n * @param inputs Data action inputs\n * @param actionContext Action context\n */\nconst beforeAddToCart = async (inputs: IActionInput | IActionInput[], actionContext: IActionContext) => {\n    try {\n        const actionInput = Array.isArray(inputs) ? <IDataServiceRequest>inputs[0] : <IDataServiceRequest>inputs;\n\n        // If cart lines were added\n        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {\n            const addCartLinesParams = actionInput.queryParams<IAddCartLinesParam>();\n            if (addCartLinesParams && addCartLinesParams.cartLines) {\n                // Save info on added cart lines for post data action hook to pick up\n                actionContext.requestContext.telemetryData[`addedCartLines`] = addCartLinesParams.cartLines;\n                return;\n            }\n        }\n        actionContext.telemetry.debug('AddToCart pre-data action hook failed - No added cart lines found');\n    } catch (e) {\n        actionContext.telemetry.debug('AddToCart pre-data action hook failed.', e);\n    }\n};\n\n/**\n * Fires an AddToCart event after data action completed\n * @param _inputs Data action inputs\n * @param cart New cart object after cart lines have been added\n * @param actionContext Action context\n */\nconst afterAddToCart = async (_inputs: IActionInput | IActionInput[], cart: Cart | Cart[], actionContext: IActionContext) => {\n    if (window && window._msdyn365 && window._msdyn365.telemetry) {\n        const addedProducts: IDictionary<IAny> = {};\n        const addedCartLines = <CartLine[]>actionContext.requestContext.telemetryData[`addedCartLines`];\n\n        // If TelemetryData exists for added cart lines, collect product info\n        if (addedCartLines) {\n            addedCartLines.forEach((cartLine: CartLine) => {\n                if (cartLine && cartLine.ProductId) {\n                    const addedProduct = actionContext.requestContext.telemetryData[cartLine.ProductId];\n                    if (addedProduct) {\n                        addedProducts[cartLine.ProductId] = addedProduct;\n                    }\n                }\n            });\n        }\n\n        // Fire AddToCart event\n        window._msdyn365.telemetry.logEvent(\n            TelemetryEvent.AddToCart,\n            getProductInfoFromCart(cart, addedProducts, actionContext.requestContext)\n        );\n    }\n};\n\ncreateDataActionHook({\n    actionId: '@msdyn365-commerce/retail-proxy/Carts/AddCartLines',\n    postReaderHook: afterAddToCart,\n    preReaderHook: beforeAddToCart\n});\n"]}