/*!
 * Copyright (c) Microsoft Corporation.
 * All rights reserved. See LICENSE in the project root for license information.
 */

import 'jest';
import React from 'react';
import ReactDOM from 'react-dom';
import DefaultExternalScript from '../default-external-script';
import { IDefaultExternalScriptProps } from '../default-external-script.props.autogenerated';

describe('Script injector - Declarative API', () => {
    const container = document.createElement('div');

    // tslint:disable-next-line:no-any
    it('returns null, if the scriptSource is not a valid url', (done: any) => {
        const scriptProps: Readonly<IDefaultExternalScriptProps<{}>> = {
            config: {
                scriptSource: "console.log('Test');",
                async: true,
                defer: true,
                // @ts-ignore
                id: '12345'
            },
            data: '',
            dataActions: [],
            id: '12345',
            typeName: ''
        };

        ReactDOM.render(<DefaultExternalScript {...scriptProps} />, container);
        expect(container.getElementsByTagName('script').length).toBe(0);
        done();
    });

    // tslint:disable-next-line:no-any
    it('returns null, if the relative script source does not link to a js file', (done: any) => {
        const scriptProps: Readonly<IDefaultExternalScriptProps<{}>> = {
            config: {
                scriptSource: 'headStart/notajsfile.html',
                async: true,
                defer: true,
                // @ts-ignore
                id: '12345'
            },
            data: '',
            dataActions: [],
            id: '12345',
            typeName: ''
        };

        ReactDOM.render(<DefaultExternalScript {...scriptProps} />, container);
        expect(container.getElementsByTagName('script').length).toBe(0);
        done();
    });

    // tslint:disable-next-line:no-any
    it('validates that a relative script url is properly constructed with statics link', (done: any) => {
        const scriptProps: Readonly<IDefaultExternalScriptProps<{}>> = {
            config: {
                scriptSource: './js-statics/headStart.js',
                async: true,
                defer: true,
                // @ts-ignore
                id: '12345'
            },
            data: '',
            dataActions: [],
            id: '12345',
            typeName: '',
            context: {
                request: {
                    // @ts-ignore
                    url: {
                        staticCdnUrl: 'https://alpha.contoso.com/_scnr'
                    }
                }
            }
        };

        ReactDOM.render(<DefaultExternalScript {...scriptProps} />, container);
        expect(container.getElementsByTagName('script')[0].src).toEqual('https://alpha.contoso.com/_scnr/js-statics/headStart.js');
        done();
    });

    // tslint:disable-next-line:no-any
    it('validates that an external script is correctly placed', (done: any) => {
        const scriptProps: Readonly<IDefaultExternalScriptProps<{}>> = {
            config: {
                scriptSource: 'https://www.contoso.com/example.js',
                async: true,
                defer: true,
                // @ts-ignore
                id: '12345'
            },
            data: '',
            dataActions: [],
            id: '12345',
            typeName: ''
        };

        ReactDOM.render(<DefaultExternalScript {...scriptProps} />, container);
        expect(container.getElementsByTagName('script')[0].src).toEqual('https://www.contoso.com/example.js');
        done();
    });
});
