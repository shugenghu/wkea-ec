{"version":3,"file":"get-refiners-for-collection.js","sourceRoot":"./src/","sources":["modules/search-result-container/actions/get-refiners-for-collection.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IProductRefinerHierarchy } from '@msdyn365-commerce/commerce-entities';\nimport { createObservableDataAction, IAction, IActionContext, IActionInput, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { BaseCollectionInput, createBaseCollectionInput } from './base-collection-action';\nimport { getProductRefinerHierarchy } from './get-product-refiner-hierarchy';\n\n/**\n * Refiners-by-Collection Input action\n */\nexport class RefinersByCollectionInput extends BaseCollectionInput implements IActionInput {\n    public getCacheObjectType = () => 'ProductRefiner';\n    public dataCacheType = () => {\n        if (\n            this.pageType !== 'Category' ||\n            (this.refiners && this.refiners.length > 0) ||\n            (this.queryResultSettings && this.queryResultSettings.Sorting && this.queryResultSettings.Sorting.Columns && this.queryResultSettings.Sorting.Columns.length > 0)\n        ) {\n            return 'request';\n        } else {\n            return 'application';\n        }\n    }\n}\n\n/**\n * Create input method which creates an ActionInput for fetching list page refiners\n */\nconst createInput = (args: ICreateActionContext): IActionInput => {\n    return createBaseCollectionInput(args, RefinersByCollectionInput);\n};\n\n/**\n * Action method which fetches refiners for the given list page\n */\nasync function action(input:RefinersByCollectionInput, ctx: IActionContext): Promise<IProductRefinerHierarchy[]> {\n    let searchProductId;\n    if(input.pageType === 'Category') {\n        if(input.category) {\n            return getProductRefinerHierarchy(\n                {\n                    CategoryIds:[input.category],\n                    Context:  {\n                        ChannelId: input.apiSettings.channelId,\n                        CatalogId: input.apiSettings.catalogId\n                    }\n                },\n                input.queryResultSettings,\n                ctx);\n        } else {\n            throw new Error('[GetRefinersForCollection]Category Page Detected, but no global categoryId found');\n        }\n    } else {\n        if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.q)) {\n            return getProductRefinerHierarchy(\n                {\n                    SearchCondition: input.searchText,\n                    Context:  {\n                        ChannelId: input.apiSettings.channelId,\n                        CatalogId: input.apiSettings.catalogId\n                    }\n                },\n                input.queryResultSettings,\n                ctx);\n            } else {\n                if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.productId)) {\n                    searchProductId = Number(input.searchText);\n                    if (Number.isNaN(searchProductId)) {\n                        throw new Error('Failed to cast search product id into a number.');\n                    } else {\n                        return getProductRefinerHierarchy(\n                            {\n                                Context:  {\n                                    ChannelId: input.apiSettings.channelId,\n                                    CatalogId: input.apiSettings.catalogId\n                                },\n                                RecommendationListId: 'looks',\n                                Ids: [searchProductId || 0]\n                            },\n                            input.queryResultSettings,\n                            ctx);\n                    }\n                } else {\n                    throw new Error(\n                        '[GetFullProductsForCollection]Search Page Detected, but no q= or productId= query parameter found'\n                    );\n                }\n            }\n    }\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/search-result-container/get-refiners-for-collection',\n    action: <IAction<IProductRefinerHierarchy[]>>action,\n    input: createInput\n});"]}