import { wrapInResolvedAsyncResult } from '@msdyn365-commerce-modules/retail-actions';
import { buildHydratedMockActionContext, buildMockCoreContext, buildMockModuleProps } from '@msdyn365-commerce/core';
import * as StoreOperationsDataActions from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';
import { LoyaltyCard } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';
import { mount, render } from 'enzyme';
import * as React from 'react';
import AccountLoyalty, { IProps } from '../account-loyalty';
import { IAccountLoyaltyData } from '../account-loyalty.data';
import { HeadingTag, IAccountLoyaltyConfig, IAccountLoyaltyResources } from '../account-loyalty.props.autogenerated';
import renderView from '../account-loyalty.view';

const mockData: IAccountLoyaltyData = {
    loyaltyCard: wrapInResolvedAsyncResult({})
};

const mockConfig: IAccountLoyaltyConfig = {
    className: 'account-loyalty-test',
    heading: {
        tag: HeadingTag.h2,
        text: 'Loyalty Program'
    }
};

const mockResources: IAccountLoyaltyResources = {
    loyaltyCardLabel: 'Loyalty card',
    joinDateFormatted: 'Member since {0}',
    totalAvailablePointsLabel: 'Total available points',
    expiringPointsFormatLabel: 'Expiring points within {0} days',
    availablePointsLabel: 'Total available points',
    redeemedPointsLabel: 'Redeemed',
    earnedPointsLabel: 'Earned',
    pendingPointsLabel: 'Pending',
    adjustedPointsLabel: 'Adjusted',
    loyaltyActivityDateLabel: 'Date',
    loyaltyActivityBalanceLabel: 'Balance',
    backToShoppingText: 'Back to shopping'
};

const mockActionContext = buildHydratedMockActionContext();

const mockContext = buildMockCoreContext({});
mockContext.actionContext = mockActionContext;
mockContext.request.locale = 'en-us';

const mockActions = {};

jest.mock('@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g');
const mockPointsActivity = [
    {
        ActivityDate: '2020-01-06T00:00:00.000Z',
        ExtensibleLoyaltyRewardPointActivityEntryTypeValue: 1,
        LoyaltyPoints: 100,
        LoyaltyRewardPointTimelineEntryType: 'Expiring'
    },
    {
        ActivityDate: '2020-01-06T00:00:00.000Z',
        ExtensibleLoyaltyRewardPointActivityEntryTypeValue: 1,
        LoyaltyPoints: 30,
        LoyaltyRewardPointTimelineEntryType: 'Expiring'
    }
];
describe('AccountLoyalty test', () => {
    let moduleProps: IProps;

    beforeEach(() => {
        const mockDateNow = 1562698411742;
        Date.now = jest.spyOn(Date, 'now').mockImplementation(() => mockDateNow);

        const loyaltyCard: LoyaltyCard =  {
          CardNumber: '55215',
          LoyaltyEnrollmentDateLocal: '2020-01-06T00:00:00.000Z' as unknown as Date,
          RewardPoints: [
            {
                RewardPointId: 'Fabrikam rewards',
                RewardPointTypeValue: 1,
                RewardPointCurrency: 'USD',
                IsRedeemable: true,
                PointsExpiringSoon: 34,
                ActivePoints: 90,
                Description: 'Fabrikam awesome points'
            },
            {
                RewardPointId: 'ColSolare',
                RewardPointTypeValue: 1,
                RewardPointCurrency: 'USD',
                IsRedeemable: true,
                Description: 'Colsolare awesome points'
            },
          ]
        };

        mockData.loyaltyCard = wrapInResolvedAsyncResult(loyaltyCard);
        moduleProps = {
            ...(buildMockModuleProps(mockData, mockActions, mockConfig, mockContext) as IProps),
            resources: mockResources,
            // @ts-ignore
            renderView
        } as IProps;

        // @ts-ignore: Jest Mocking Confuses TS Complier
        StoreOperationsDataActions.getLoyaltyRewardPointActivityTimelineAsync.mockImplementation(() => Promise.resolve(mockPointsActivity));
        // @ts-ignore: Jest Mocking Confuses TS Complier
        StoreOperationsDataActions.getLoyaltyRewardPointsExpiringSoonAsync.mockImplementation(() => Promise.resolve(mockPointsActivity));
    });

    it('module renders correctly', () => {
        const accountLoyalty = render(<AccountLoyalty {...moduleProps} />);
        expect(accountLoyalty).toMatchSnapshot();
    });

    it('module should not render without loyalty card', () => {
        const noData = {};

        const noDataModuleProps = {
            ...buildMockModuleProps(noData, mockActions, mockConfig, mockContext),
            resources: mockResources,
            // @ts-ignore
            renderView
        } as IProps;

        const accountLoyalty = render(<AccountLoyalty {...noDataModuleProps} />);
        expect(accountLoyalty).toMatchSnapshot();
    });

    it('modal props', () => {
        const accountLoyalty = mount(<AccountLoyalty {...moduleProps} />);

        // open available modal
        let modalTrigger = accountLoyalty.find('.ms-account-loyalty__points-trigger').first();
        modalTrigger.simulate('click');
        let modal = accountLoyalty.find('.ms-account-loyalty__points-modal').first();

        // @ts-ignore
        expect(modal.props().isOpen).toBe(true);

        let closeButton = modal.find('button.msc-modal__close-button');
        closeButton.simulate('click');

        modal = accountLoyalty.find('.ms-account-loyalty__points-modal').first();

        // successfully close available modal
        expect(modal).toEqual({});

        // open expiring modal
        modalTrigger = accountLoyalty.find('.ms-account-loyalty__points-trigger').last();
        modalTrigger.simulate('click');
        modal = accountLoyalty.find('.ms-account-loyalty__points-modal').first();

        // @ts-ignore
        expect(modal.props().isOpen).toBe(true);

        closeButton = modal.find('button.msc-modal__close-button');
        closeButton.simulate('click');

        modal = accountLoyalty.find('.ms-account-loyalty__points-modal').first();

        // successfully close expiring modal
        expect(modal).toEqual({});
    });

    it('module rewardPoints section renders without RewardPointId ', () => {
        const mockLoyaltyCard: LoyaltyCard = {
            CardNumber: '45646846846',
            LoyaltyEnrollmentDateLocal: '2020-01-06T00:00:00.000Z' as unknown as Date,
            RewardPoints: [
                {
                    RewardPointTypeValue: 1,
                    RewardPointCurrency: 'USD',
                    IsRedeemable: true,
                    PointsExpiringSoon: 34,
                    ActivePoints: 90,
                    Description: 'Fabrikam awesome points'
                },
                {
                    RewardPointTypeValue: 1,
                    RewardPointCurrency: 'USD',
                    IsRedeemable: true,
                    Description: 'Colsolare awesome points'
                },
            ]
        };

        mockData.loyaltyCard = wrapInResolvedAsyncResult(mockLoyaltyCard);
        const noRewardsModuleProps = {
            ...buildMockModuleProps(mockData, mockActions, mockConfig),
            resources: mockResources,
            context: mockContext,
            // @ts-ignore
            renderView
        } as IProps;

        const accountLoyalty = render(<AccountLoyalty {...noRewardsModuleProps} />);
        expect(accountLoyalty).toMatchSnapshot();
    });
});