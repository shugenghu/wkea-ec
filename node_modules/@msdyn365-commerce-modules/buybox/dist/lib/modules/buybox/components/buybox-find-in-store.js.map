{"version":3,"file":"buybox-find-in-store.js","sourceRoot":"./src/","sources":["modules/buybox/components/buybox-find-in-store.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\n\nimport { Heading, INodeProps, IPopupProps, Popup } from '@msdyn365-commerce-modules/utilities';\nimport { getUrlSync, IImageSettings } from '@msdyn365-commerce/core';\nimport { ProductDimension } from '@msdyn365-commerce/retail-proxy';\n\nimport { IAddToCartFailureResult, PriceComponent } from '@msdyn365-commerce/components';\nimport { IBuyboxCallbacks, IBuyboxData, IBuyboxProps, IBuyboxState } from '../../../index';\nimport { getConfigureErrors, getGenericError } from '../utilities/error-utilities';\nimport { BuyboxErrorBlock } from './index';\n\nexport interface IFindInStoreFailureResult {\n    missingDimensions?: ProductDimension[];\n}\n\nexport interface IBuyboxFindInStoreViewProps {\n    storeSelector?: React.ReactNode;\n    heading?: React.ReactNode;\n    description?: React.ReactNode;\n    errors?: React.ReactNode;\n    button?: React.ReactNode;\n\n    modal?: React.ReactNode;\n\n    ContainerProps: INodeProps;\n\n    openFindInStoreDialog(): Promise<void>;\n}\n\n// tslint:disable-next-line:max-func-body-length\nexport function getBuyboxFindInStore(props: IBuyboxProps<IBuyboxData>, state: IBuyboxState, callbacks: IBuyboxCallbacks): IBuyboxFindInStoreViewProps | undefined {\n    const {\n        data,\n        slots: {\n            storeSelector\n        },\n        resources : {\n            priceFree,\n            originalPriceText,\n            currentPriceText,\n            findInStoreHeaderText,\n            findInStoreDescriptionText,\n            findInStoreLinkText,\n            buyBoxGoToCartText,\n            buyBoxContinueShoppingText,\n            buyBoxSingleItemText,\n            buyBoxMultiLineItemFormatText,\n            buyBoxHeaderMessageText\n        },\n        context: {\n            request: {\n                channel: {\n                    PickupDeliveryModeCode\n                } = { PickupDeliveryModeCode: undefined }\n            }\n        }\n    } = props;\n\n    const product = data?.product?.result;\n    const price = data?.productPrice?.result;\n    const storeSelectorStateManager = data?.storeSelectorStateManager?.result;\n    const cart = data?.cart?.result;\n    const deliveryOptions = data?.deliveryOptions?.result;\n\n    const\n    {\n        errorState: {\n            configureErrors,\n            quantityError,\n            otherError,\n            errorHost\n        },\n        modalOpen,\n        quantity\n    } = state;\n\n    const onClick = () => findInStoreOnClick(props, state, callbacks);\n\n    if (!product || !storeSelectorStateManager || storeSelector.length === 0) {\n        return undefined;\n    }\n\n    // If no delivery options present on the product, or none of the delivery options\n    // match the PickupDeliveryModeCode, that means the item cannot be used for BOPIS\n    if (!deliveryOptions ||\n        !deliveryOptions.DeliveryOptions ||\n        !PickupDeliveryModeCode ||\n        !deliveryOptions.DeliveryOptions.find(option => option.Code === PickupDeliveryModeCode)) {\n            return undefined;\n    }\n\n    const dialogStrings = {\n        goToCartText: buyBoxGoToCartText,\n        continueShoppingText: buyBoxContinueShoppingText,\n        headerItemOneText: buyBoxSingleItemText,\n        headerItemFormatText: buyBoxMultiLineItemFormatText,\n        headerMessageText: buyBoxHeaderMessageText,\n        freePriceText: priceFree,\n        originalPriceText: originalPriceText,\n        currentPriceText: currentPriceText\n    };\n\n    const priceComponent = price ? (\n        <PriceComponent\n            data={{price: price}}\n            context={props.context}\n            id={props.id}\n            typeName={props.typeName}\n            freePriceText={dialogStrings.freePriceText}\n            originalPriceText={dialogStrings.originalPriceText}\n            currentPriceText={dialogStrings.currentPriceText}\n        />) : '';\n\n    const defaultImageSettings: IImageSettings = {\n        viewports: {\n            xs: { q: `w=240&h=240&m=6`, w: 0, h: 0 },\n            lg: { q: `w=240&h=240&m=6`, w: 0, h: 0 },\n            xl: { q: `w=240&h=240&m=6`, w: 0, h: 0 }\n        },\n        lazyload: true\n    };\n\n    const popupProps: IPopupProps = {\n        context: props.context,\n        className: 'ms-buybox',\n        id: props.id,\n        typeName: props.typeName,\n        data: {product: props.data.product?.result, price: props.data.productPrice?.result},\n        dialogStrings: dialogStrings,\n        imageSettings: defaultImageSettings,\n        gridSettings: props.context.request.gridSettings,\n        productQuantity: quantity,\n        priceComponent: priceComponent,\n        navigationUrl: getUrlSync('cart', props.context.actionContext),\n        modalOpen: modalOpen,\n        setModalOpen: callbacks.changeModalOpen\n    };\n    const renderModalPopup = <Popup {...popupProps} />;\n\n    return {\n        ContainerProps: {\n            className: 'ms-buybox__find-in-store'\n        },\n\n        storeSelector: storeSelector[0],\n\n        openFindInStoreDialog: onClick,\n\n        heading: (\n            <Heading\n                className='ms-buybox__find-in-store-heading'\n                headingTag='h4'\n                text={findInStoreHeaderText}\n            />\n        ),\n\n        description: (\n            <p className='ms-buybox__find-in-store-description'>\n                {findInStoreDescriptionText}\n            </p>\n        ),\n\n        errors: (\n            <BuyboxErrorBlock\n                configureErrors={configureErrors}\n                quantityError={quantityError}\n                otherError={otherError}\n                resources={props.resources}\n                showError={errorHost === 'FINDINSTORE'}\n            />\n        ),\n\n        button: (\n            <button\n                className='ms-buybox__find-in-store-button'\n                onClick={onClick}\n                color='secondary'\n                aria-label={findInStoreLinkText}\n                disabled={cart === undefined}\n            >\n                {findInStoreLinkText}\n            </button>\n        ),\n\n        modal: renderModalPopup\n    };\n}\n\nasync function findInStoreOnClick(props: IBuyboxProps<IBuyboxData>, state: IBuyboxState, callbacks: IBuyboxCallbacks): Promise<void> {\n    const {\n        data: {\n            storeSelectorStateManager: {result: storeSelectorStateManager },\n            cart: {result: cart },\n            productAvailableQuantity: { result: productAvailableQuantity}\n        },\n        resources,\n        context\n    } = props;\n\n    const {\n        selectedProduct,\n        quantity\n    } = state;\n\n    let dataProduct = props.data.product.result;\n\n    if (selectedProduct) {\n        dataProduct = (await selectedProduct) || dataProduct;\n    }\n\n    if (!dataProduct || !storeSelectorStateManager) {\n        return;\n    }\n\n    const product = dataProduct;\n\n    const missingDimensions = product.Dimensions && product.Dimensions.filter(dimension => !(dimension.DimensionValue && dimension.DimensionValue.Value));\n\n    if (missingDimensions && missingDimensions.length > 0) {\n        if (callbacks.updateErrorState) {\n            callbacks.updateErrorState(\n                {\n                    errorHost: 'FINDINSTORE',\n                    configureErrors: getConfigureErrors(missingDimensions, resources),\n                }\n            );\n        }\n    } else {\n        storeSelectorStateManager.openDialog({\n            product,\n            onLocationSelected: orgUnitLocation => {\n                if (!cart) {\n                    return Promise.resolve();\n                }\n\n                const behavior = props.context?.app?.config?.addToCartBehavior;\n\n                return cart.addProductToCart({product: product, count: quantity, location: orgUnitLocation})\n                    .then(result => {\n                        if (result.status === 'FAILED' && result.substatus === 'MAXQUANTITY') {\n                            callbacks.changeModalOpen(false);\n\n                            const productAvailability = state.productAvailableQuantity ?\n                                state.productAvailableQuantity.ProductAvailableQuantity :\n                                    productAvailableQuantity && productAvailableQuantity.length?\n                                    productAvailableQuantity[0].ProductAvailableQuantity: undefined;\n\n                            const failureResult: IAddToCartFailureResult = {failureReason: 'CARTACTIONFAILED', cartActionResult: {status: result.status, substatus: result.substatus}};\n                            callbacks.updateErrorState({\n                                errorHost: 'ADDTOCART',\n                                configureErrors: {},\n                                otherError: getGenericError(failureResult, cart, resources, context, product, productAvailability, orgUnitLocation)\n                            });\n                        } else {\n                            if((behavior === undefined || behavior === 'goToCart')) {\n                                const navigationUrl = getUrlSync('cart', context.actionContext);\n\n                                if (result.status === 'SUCCESS' && navigationUrl) {\n                                    window.location.assign(navigationUrl);\n                                }\n                            } else if (behavior === 'showModal') {\n                                callbacks.updateErrorState({\n                                    configureErrors: {}\n                                });\n                                callbacks.changeModalOpen(true);\n                            }\n                        }\n                    }).catch((error: Error) => {\n                        if (props.telemetry) {\n                            props.telemetry.exception(error);\n                            props.telemetry.debug('Unable to add product to cart');\n                        }\n                        return;\n                    });\n                }\n        }).catch((error: Error) => {\n            if (props.telemetry) {\n                props.telemetry.error(error.message);\n                props.telemetry.debug('Unable to find in store');\n            }\n            return;\n        });\n    }\n\n    return;\n}"]}