/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

// tslint:disable-next-line:no-unused-variable
import { mount, shallow } from 'enzyme';
import * as React from 'react';
import IframeComponent, { IPaymentFrameElementProps, POST_MESSAGE_NAME } from '../../components/iframe';
import { paymentConnectorSubmitMessage } from '../../payment-instrument-message';

const mockPaymentAcceptPageContent = '<!DOCTYPE html><html><head></head><body>Mock Payment Connector</body></html>';
const mockSourceUrl = 'https://www.example.com/acceptPageUrl';
const mockCSS = '.body {}';

let mockIframeRef: React.RefObject<HTMLIFrameElement>;
let mockProps: IPaymentFrameElementProps;

const mockEventMap = {};
window.addEventListener = jest.fn((event, cb) => {
    mockEventMap[event] = cb;
});

describe('Checkout payment instrument unit tests - Iframe', () => {
    beforeEach(() => {
        mockIframeRef = {
            // @ts-ignore mock partial data
            current: {
                // @ts-ignore mock partial data
                contentWindow: {
                    postMessage: jest.fn()
                },
                contentDocument: {
                    open: jest.fn(),
                    write: jest.fn(),
                    close: jest.fn(),
                    // @ts-ignore mock partial data
                    head: {
                        appendChild: jest.fn()
                    }
                }
            }
        };

        mockProps = {
            className: 'mock-class',
            iframeAriaLabel: 'mock airea label',
            height: 500,
            onIFrameMessage: jest.fn()
        };
    });

    it('renders correctly', () => {
        mockProps = {
            ...mockProps,
            displayContent: mockPaymentAcceptPageContent,
            requestUrlOrigin: mockSourceUrl,
            css: mockCSS
        };
        const component = shallow(<IframeComponent {...mockProps} />);
        expect(component).toMatchSnapshot();
    });

    it('calls onIFrameMessage on post message event', () => {
        mockProps = {
            ...mockProps,
            requestUrlOrigin: mockSourceUrl
        };
        const mockEvent = { origin: 'https://www.example.com/acceptPageUrl' };
        const component = mount(<IframeComponent {...mockProps} />);
        mockEventMap[POST_MESSAGE_NAME](mockEvent);
        expect(mockProps.onIFrameMessage).toBeCalledWith(mockEvent);
        component.unmount();
    });

    it('will not call onIFrameMessage on post message event when orign does not match sourceUrl', () => {
        mockProps = {
            ...mockProps,
            sourceUrl: mockSourceUrl
        };
        const mockEvent = { origin: 'www.test.com' };
        const component = mount(<IframeComponent {...mockProps} />);
        mockEventMap[POST_MESSAGE_NAME](mockEvent);
        expect(mockProps.onIFrameMessage).not.toBeCalled();
        component.unmount();
    });

    it('will not onIFrameMessage on post message event when origin does not match serverPageUrl', () => {
        mockProps = {
            ...mockProps,
            requestUrlOrigin: mockSourceUrl
        };
        const mockEvent = { origin: 'www.test.com' };
        const component = mount(<IframeComponent {...mockProps} />);
        mockEventMap[POST_MESSAGE_NAME](mockEvent);
        expect(mockProps.onIFrameMessage).not.toBeCalled();
        component.unmount();
    });

    it('calls postMessage and send submit post message', () => {
        const component = mount(<IframeComponent {...mockProps} />);
        const iframeInstance = component.instance() as IframeComponent;
        const message = paymentConnectorSubmitMessage();

        // @ts-ignore private property
        iframeInstance.iframeRef = mockIframeRef;
        iframeInstance.postMessage(message);

        // @ts-ignore private property
        expect(iframeInstance.iframeRef.current.contentWindow.postMessage).toBeCalledWith(
            message.message,
            message.targetOrigin
        );

        component.unmount();
    });
});