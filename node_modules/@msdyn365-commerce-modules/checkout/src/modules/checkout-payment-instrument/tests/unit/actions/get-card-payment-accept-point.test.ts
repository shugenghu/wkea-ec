import * as globalState from '@msdyn365-commerce/global-state';
import * as CartsDataActions from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';
import {
    createCheckoutPaymentInstrumentInput,
    getCardPaymentAcceptPointAction,
    GetCardPaymentAcceptPointInput
} from '../../../actions/get-card-payment-accept-point';

jest.mock('@msdyn365-commerce/global-state');
jest.mock('@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g');

let mockCheckoutState = {};
let mockActionContext = {};

describe('Checkout unit tests - getCardPaymentAcceptPointAction', () => {
    beforeEach(() => {
        mockCheckoutState = {
            checkoutCart: {
                cart: {
                    Id: 'cart_1',
                    CartLines: [
                        {
                            LineId: 'line_1',
                            ProductId: 'p_1'
                        },
                        {
                            LineId: 'line_2'
                        }
                    ]
                }
            }
        };

        mockActionContext = {
            apiSettings: {
                channelId: 'channel-id',
                catalogId: 'catalog-id'
            },
            telemetry: {
                exception: jest.fn()
            },
            requestContext: {
                apiSettings: {},
                url: {
                    requestUrl: 'https://www.example.com/'
                }
            }
        };

        // @ts-ignore mock partial data action
        globalState.getCheckoutState = jest.fn(() => new Promise((resolve, reject) => resolve(mockCheckoutState)));
    });

    afterEach(() => {
        jest.resetAllMocks();
    });

    afterAll(() => {
        jest.unmock('@msdyn365-commerce/global-state');
        jest.unmock('@msdyn365-commerce-modules/retail-actions');
    });

    it('creates input', () => {
        const inputData = {
            apiSettings: {
                channelId: 'channel-id',
                catalogId: 'catalog-id'
            },
            paymenTenderType: 'tendertype'
        };

        // @ts-ignore mock partial data
        const input = new GetCardPaymentAcceptPointInput(inputData);
        expect(input.getCacheKey()).toBe('CardPaymentAcceptPoint-tendertype-chanId:channel-id-catId:catalog-id');
        expect(input.getCacheObjectType()).toBe('CardPaymentAcceptPoint');
        expect(input.dataCacheType()).toBe('none');
    });

    it('creates input on load', () => {
        const inputData = {
            config: {},
            requestContext: {
                apiSettings: {
                    channelId: 'channel-id',
                    catalogId: 'catalog-id'
                }
            }
        };
        // @ts-ignore mock partial data
        const input = createCheckoutPaymentInstrumentInput(inputData);
        expect(input.getCacheKey()).toBe('CardPaymentAcceptPoint-chanId:channel-id-catId:catalog-id');
        expect(input.getCacheObjectType()).toBe('CardPaymentAcceptPoint');
        expect(input.dataCacheType()).toBe('none');
    });

    it('creates input with showBillingAddress', () => {
        const inputData = {
            config: {
                showBillingAddress: true
            },
            requestContext: {
                apiSettings: {
                    channelId: 'channel-id',
                    catalogId: 'catalog-id'
                }
            }
        };
        // @ts-ignore mock partial data
        const input = createCheckoutPaymentInstrumentInput(inputData);
        expect(input.getCacheKey()).toBe('CardPaymentAcceptPoint-chanId:channel-id-catId:catalog-id');
        expect(input.getCacheObjectType()).toBe('CardPaymentAcceptPoint');
        expect(input.dataCacheType()).toBe('none');
    });

    it('gets payment accept points', async () => {
        const mockPaymentAcceptPoints = {
            AcceptPageUrl: '/url',
            AcceptPageContent: '<html/>'
        };

        const inputData = {
            config: {
                showBillingAddress: false
            },
            requestContext: {
                apiSettings: {}
            }
        };

        // @ts-ignore mock partial data action
        CartsDataActions.getCardPaymentAcceptPointAsync = jest.fn(() => new Promise((resolve, reject) => resolve(mockPaymentAcceptPoints)));

        // @ts-ignore mock partial data action
        await getCardPaymentAcceptPointAction(inputData, mockActionContext).then(data => {
            expect(data).toMatchObject(mockPaymentAcceptPoints);
        });
    });

    it('handles showBillingAddress is true', async () => {
        const mockPaymentAcceptPoints = {
            AcceptPageUrl: '/url',
            AcceptPageContent: '<html/>'
        };

        // @ts-ignore mock partial data action
        CartsDataActions.getCardPaymentAcceptPointAsync = jest.fn(() => new Promise((resolve, reject) => resolve(mockPaymentAcceptPoints)));

        // @ts-ignore mock partial data action
        await getCardPaymentAcceptPointAction({ showBillingAddress: true }, mockActionContext).then(data => {
            expect(data).toMatchObject(mockPaymentAcceptPoints);
        });
    });

    it('handles getCheckoutState fail', async () => {
        // @ts-ignore mock partial data action
        globalState.getCheckoutState = jest.fn(() => new Promise((resolve, reject) => reject('error')));

        try {
            // @ts-ignore mock partial data action
            await getCardPaymentAcceptPointAction({ showBillingAddress: false }, mockActionContext);
        } catch (e) {
            expect(e).toBeDefined();
        }
    });

    it('handles no cart line', async () => {
        // @ts-ignore mock partial data action
        globalState.getCheckoutState = jest.fn(
            () =>
                new Promise((resolve, reject) =>
                    resolve({
                        checkoutCart: {
                            cart: {
                                Id: 'cart_1',
                                CartLines: []
                            }
                        }
                    })
                )
        );

        try {
            // @ts-ignore mock partial data action
            await getCardPaymentAcceptPointAction({ showBillingAddress: false }, mockActionContext);
        } catch (e) {
            expect(e).toBeDefined();
        }
    });

    it('handles no input', async () => {
        try {
            // @ts-ignore mock partial data action
            await getCardPaymentAcceptPointAction(null, mockActionContext);
        } catch (e) {
            expect(e).toBeDefined();
        }
    });

    it('handles getCardPaymentAcceptPointAsync fails', async () => {
        // @ts-ignore mock partial data action
        CartsDataActions.getCardPaymentAcceptPointAsync = jest.fn(() => new Promise((resolve, reject) => reject('Error')));
        try {
            // @ts-ignore mock partial data action
            await getCardPaymentAcceptPointAction({ showBillingAddress: false }, mockActionContext);
        } catch (e) {
            expect(e).toBeDefined();
        }
    });

    it('handles invalid payment accept points', async () => {
        // @ts-ignore mock partial data action
        CartsDataActions.getCardPaymentAcceptPointAsync = jest.fn(() => new Promise((resolve, reject) => resolve({})));

        try {
            // @ts-ignore mock partial data action
            await getCardPaymentAcceptPointAction({ showBillingAddress: false }, mockActionContext);
        } catch (e) {
            expect(e).toBeDefined();
        }
    });
});
