{"version":3,"file":"get-categories-hierarchy.js","sourceRoot":"","sources":["../../src/get-categories-hierarchy.ts"],"names":[],"mappings":"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","sourcesContent":["import { CategoryHierarchy } from '@msdyn365-commerce/commerce-entities';\nimport { CacheType, IAction, IActionContext, IActionInput, ICommerceApiSettings } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IAny, ICreateActionContext, IGeneric, IRequestContext } from '@msdyn365-commerce/core';\nimport { Category } from '@msdyn365-commerce/retail-proxy';\nimport { TextValueTranslation } from '@msdyn365-commerce/retail-proxy';\nimport getCategoryAction, { CategoriesInput as RawCategoriesInput } from './get-categories';\nimport { getCategoryUrl } from './utilities/Url-builder';\nimport { buildCacheKey } from './utilities/utils';\n\n/**\n * Input for get-categories data action\n */\nexport class CategoriesInput implements IActionInput {\n    public readonly maxItems: number;\n    public readonly channelId: number;\n    private readonly sitePath: string;\n    private _mappedToHierarchy: boolean;\n    private apiSettings: ICommerceApiSettings;\n    private locale?:string;\n\n    constructor(context: IRequestContext, mappedToHierarchy: boolean, maxItems?: number) {\n        this._mappedToHierarchy = mappedToHierarchy;\n        this.maxItems = maxItems || 250;\n        this.channelId = context && context.apiSettings && context.apiSettings.channelId ? +context.apiSettings.channelId : 0;\n        this.sitePath = context && context.sitePath || '';\n        this.apiSettings = context.apiSettings;\n        this.locale = context.locale || '';\n    }\n\n    public getCacheKey = () => buildCacheKey(`${this.channelId}|${this.sitePath}|top-${this.maxItems || 250}`, this.apiSettings, this.locale);\n    public getCacheObjectType = () => (this._mappedToHierarchy ? 'CategoryHierarchy' : 'Category');\n    public dataCacheType = (): CacheType => 'application';\n    public getLocale = ():string => this.locale || '';\n}\n\nconst getFriendlyName = (locale?: string, nameTranslations?: TextValueTranslation[]): string | undefined => {\n    let nameTranslation: TextValueTranslation | undefined;\n    if (locale && nameTranslations && nameTranslations.length > 0) {\n        nameTranslation = nameTranslations.find(item => item.Language!.toLowerCase() === locale.toLowerCase());\n    }\n\n    return nameTranslation && nameTranslation.Text;\n};\n\nexport interface ICategoryMap {\n    [RecordId: number]: CategoryHierarchy;\n}\n\n/**\n * Creates a hierarchy of categories based on the ParentCategory property\n * @param categoryList Categories that will be converted into a hierarchy\n * @returns Hierarchy of categories in array\n */\nexport const mapCategoryToHierarchy = (categoryList: Category[], ctx: IActionContext, locale?: string ): CategoryHierarchy[] => {\n    if (!categoryList || !categoryList.length) {\n        return [];\n    }\n\n    const categoryMap: ICategoryMap = categoryList.reduce((memo: ICategoryMap, category: Category) => {\n        const localName = getFriendlyName(locale, category.NameTranslations);\n        const categoryHierarchy = <CategoryHierarchy> { ...category };\n        categoryHierarchy.NeutralizedName = category.Name;\n        categoryHierarchy.Name = localName || categoryHierarchy.NeutralizedName;\n        memo[category.RecordId] = categoryHierarchy;\n        return memo;\n    }, {});\n\n    let zeroCategory = categoryMap[0];\n\n    Object.keys(categoryMap).forEach((id: string) => {\n        const element = categoryMap[+id];\n        const parentId = element.ParentCategory;\n        element.Url = getCategoryUrl(element, ctx, categoryMap);\n        if (parentId === 0) {\n            zeroCategory = element;\n            return;\n        }\n\n        const parent = parentId && categoryMap[parentId];\n        if (parent) {\n            parent.Children = parent.Children || [];\n            parent.Children.push(element);\n        }\n    });\n\n    return (zeroCategory && zeroCategory.Children) || [];\n};\n\n/**\n * Creates the input required to make the retail api call\n */\nexport const createCategoriesHierarchyInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    const topItems = inputData.config && inputData.config.topCategories && parseInt(inputData.config.topCategories, 10);\n    return new CategoriesInput(inputData.requestContext, true, topItems);\n};\n\n/**\n * Calls the Retail API and returns all the categories as a hierarchy\n */\nexport async function getCategoryHierarchyAction(input: CategoriesInput, ctx: IActionContext): Promise<CategoryHierarchy[]> {\n    const categories = await getCategoryAction(\n        new RawCategoriesInput(ctx.requestContext, false, input.maxItems),\n        ctx\n    );\n    return mapCategoryToHierarchy(categories, ctx, input.getLocale());\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-categories-hierarchy',\n    action: <IAction<CategoryHierarchy[]>>getCategoryHierarchyAction,\n    input: createCategoriesHierarchyInput\n});\n"]}