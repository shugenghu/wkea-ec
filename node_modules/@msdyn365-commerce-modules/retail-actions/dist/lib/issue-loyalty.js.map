{"version":3,"file":"issue-loyalty.js","sourceRoot":"","sources":["../../src/issue-loyalty.ts"],"names":[],"mappings":"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","sourcesContent":["import { CacheType, createObservableDataAction, IAction, IActionContext, IActionInput, ICommerceApiSettings, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { getCartState, ICartState } from '@msdyn365-commerce/global-state';\nimport { LoyaltyCard } from '@msdyn365-commerce/retail-proxy';\nimport { issueLoyaltyCardAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport { getLoyaltyAction, GetLoyaltyCardInput} from './get-loyalty-card';\nimport { buildCacheKey } from './index';\n\n/**\n *  Input class for the issueLoyalty data action\n */\nexport class IssueLoyaltyInput implements IActionInput {\n    public userAccountNumber?: string;\n    public apiSettings: ICommerceApiSettings;\n\n    constructor(apiSettings: ICommerceApiSettings, userAccountNumber?: string) {\n        this.userAccountNumber = userAccountNumber;\n        this.apiSettings = apiSettings;\n    }\n\n    public getCacheKey = () => buildCacheKey(`IssueLoyalty-${this.userAccountNumber}`, this.apiSettings);\n    public getCacheObjectType = () => 'GetIssueLoyalty';\n    public dataCacheType = (): CacheType => 'request';\n}\n\n/**\n * createInput method for the issueLoyalty method\n * @param inputData The input data passed to the createInput method\n */\nexport const createIssueLoyaltyInput = (inputData: ICreateActionContext): IActionInput => {\n    const { requestContext } = inputData;\n\n    if (!requestContext.user.isAuthenticated) {\n        throw new Error('Unable to create issue loyalty input.  User is not authenticated.');\n    }\n\n    return new IssueLoyaltyInput(inputData.requestContext.apiSettings);\n};\n\n/**\n * The action method for the issueLoyalty data action\n * @param input The action input\n * @param ctx The action context\n */\nexport async function issueLoyaltyAction(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const promises: [Promise<ICartState>,Promise<LoyaltyCard>] = [ getCartState(ctx), _getLoyalty(input, ctx)];\n    return Promise.all(promises)\n            .then((result) => {\n                const cartState = result[0];\n                const card = result[1];\n                if (card && card.CardNumber) {\n                    updateCart(cartState, card);\n                    return card;\n                }\n                //@ts-ignore\n                //TO-DO: Remove after SDK bug fix https://msdyneng.visualstudio.com/FinOps/_workitems/edit/473891\n                return issueLoyaltyCardAsync({ callerContext: ctx }, { CustomerAccount: input.userAccountNumber || null })     \n                    .then((issuedCard: LoyaltyCard) => {\n                        updateCart(cartState, issuedCard);\n                        return issuedCard;\n                    })\n                    //@ts-ignore\n                    .catch(error => {\n                        ctx.telemetry.exception(error);\n                        ctx.telemetry.debug('Issuing loyalty card failed');\n                        throw new Error('Issuing loyalty card failed');\n                    });\n            })\n            .catch((error: Error) => {\n                ctx.telemetry.exception(error);\n                ctx.telemetry.debug('Unable to issue loyalty card');\n                throw new Error('Unable to issue loyalty card');\n            });\n}\n\nasync function _getLoyalty(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const loyaltyCardInput = new GetLoyaltyCardInput(input.apiSettings);\n    return getLoyaltyAction(loyaltyCardInput, ctx);\n}\n\nfunction updateCart(cartState: ICartState, card: LoyaltyCard): void {\n    cartState.updateLoyaltyCardId({loyaltyCardNumber: card.CardNumber});\n}\n\n/**\n * The getLoyaltyCard data action\n * Returns the loyalty card belonging to the customer\n */\nexport default createObservableDataAction<LoyaltyCard>({\n    id: '@msdyn365-commerce-modules/retail-actions/issue-loyalty',\n    action: <IAction<LoyaltyCard>>issueLoyaltyAction,\n    input: <(args: ICreateActionContext) => IActionInput>createIssueLoyaltyInput\n});\n"]}