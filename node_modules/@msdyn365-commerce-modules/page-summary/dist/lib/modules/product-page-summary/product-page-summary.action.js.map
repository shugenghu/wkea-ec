{"version":3,"file":"product-page-summary.action.js","sourceRoot":"./src/","sources":["modules/product-page-summary/product-page-summary.action.ts"],"names":[],"mappings":"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","sourcesContent":["import { buildCacheKey, getProductUrlSync, getSelectedProductIdFromActionInput, getSelectedVariant, SelectedVariantInput } from '@msdyn365-commerce-modules/retail-actions';\nimport { CacheType, createObservableDataAction, IAction, IActionContext,IActionInput, ICommerceApiSettings, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { IDefaultPageSummaryConfig } from '../default-page-summary/default-page-summary.props.autogenerated';\nimport { IPageSummaryData } from '../IPageSummaryData';\n\n/** Product Page Summary Input */\nexport class ProductPageSummaryInput implements IActionInput {\n    public apiSettings: ICommerceApiSettings;\n    public config: IDefaultPageSummaryConfig;\n\n    constructor(config: IDefaultPageSummaryConfig, apiSettings: ICommerceApiSettings) {\n        this.config = config || {};\n        this.apiSettings = apiSettings;\n    }\n\n    public getCacheObjectType = (): string => 'ProductPageSummary';\n    public getCacheKey = (): string => `${buildCacheKey('ProductPageSummary', this.apiSettings)}-${this.config.title}`;\n    public dataCacheType = (): CacheType => 'request';\n}\n\nconst createGetSelectedVariantInput = (inputData: IActionContext): SelectedVariantInput => {\n    const productId = getSelectedProductIdFromActionInput(inputData);\n\n    if (productId) {\n        return new SelectedVariantInput(+productId, +inputData.requestContext.apiSettings.channelId, []);\n    } else {\n        throw new Error('Unable to create SelectedVariantInput, no productId found on module config or query');\n    }\n};\n\nconst action = async (input: ProductPageSummaryInput, context: IActionContext): Promise<IPageSummaryData> => {\n    const { config } = input;\n    let simpleProductData;\n    try {\n        simpleProductData = await getSelectedVariant(createGetSelectedVariantInput(context), context);\n    } catch (e) {\n        // Do nothing, if there's an error we fall back to values defined from data\n    }\n    if (simpleProductData) {\n        let productUrl: string | undefined;\n        try {\n            productUrl = getProductUrlSync(simpleProductData, context);\n            // @ts-ignore - TODO: property exits in new version of SDK. Remove once released.\n            const canonicalDomain = context.requestContext.canonicalDomain;\n            if (productUrl && canonicalDomain) {\n                productUrl = `https://${canonicalDomain}${productUrl}`;\n            } else {\n                productUrl = undefined;\n            }\n        } catch (e) {\n            productUrl = undefined;\n        }\n        return {\n            title: simpleProductData.Name,\n            description: simpleProductData.Description,\n            sharingImageUrl: simpleProductData.PrimaryImageUrl,\n            canonicalUrl: productUrl,\n            faviconUrl: config && config.faviconUrl\n        };\n    // If the action fails fallback to values defined from data\n    } else if (config) {\n        return {\n            title: config.title,\n            description: config.description,\n            sharingImageUrl: config.sharingImage && config.sharingImage.src,\n            faviconUrl: config && config.faviconUrl\n        };\n    } else {\n        return {};\n    }\n};\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/page-summary/product-page-summary',\n    action: <IAction<IPageSummaryData>>action,\n    input: (args: ICreateActionContext) => {\n        return new ProductPageSummaryInput(<IDefaultPageSummaryConfig>args.config, args.requestContext.apiSettings);\n    }\n});"]}