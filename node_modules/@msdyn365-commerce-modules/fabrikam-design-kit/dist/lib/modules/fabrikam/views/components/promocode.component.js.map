{"version":3,"file":"promocode.component.js","sourceRoot":"./src/","sources":["modules/fabrikam/views/components/promocode.component.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\n\nimport { Button, format, getPayloadObject, getTelemetryAttributes, IPayLoad, ITelemetryContent, TelemetryConstant } from '@msdyn365-commerce-modules/utilities';\nimport { PriceComponent } from '@msdyn365-commerce/components';\nimport { IComponentProps } from '@msdyn365-commerce/core';\nimport { ICartState } from '@msdyn365-commerce/global-state';\nimport { Coupon } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\n\nexport interface IPromoCodeProps extends IComponentProps<{}> {\n    cart: ICartState | undefined;\n    promoCodeHeadingText: string;\n    appliedPromoCodeHeadingText: string;\n    removePromoAriaLabelFormat: string;\n    promoPlaceholderText: string;\n    promoCodeApplyButtonText: string;\n    collapseTimeOut: number;\n    removePromoText: string;\n    invalidPromoCodeErrorText: string;\n    failedToAddPromoCodeErrorText: string;\n    duplicatePromoCodeErrorText: string;\n    failedToRemovePromoCodeErrorText: string;\n    /** The telemetry content */\n    telemetryContent?: ITelemetryContent;\n    promoCodeApplyCallback?(): void;\n}\n\ninterface IPromoCodeState {\n    isCollapseOpen: boolean;\n    promoCodeInputValue: string;\n    error: string;\n    canApply: boolean;\n}\n\n/**\n *\n * The PromoCode component renders the promocode section.\n * @extends {React.PureComponent<IRefineSubmenuProps>}\n */\nclass PromoCode extends React.Component<IPromoCodeProps, IPromoCodeState> {\n\n    private payLoad: IPayLoad;\n\n    constructor(props: IPromoCodeProps, state: IPromoCodeState) {\n        super(props);\n        this.payLoad = getPayloadObject('click', this.props.telemetryContent!, TelemetryConstant.ApplyPromoCode);\n        this.state = {\n            isCollapseOpen: false,\n            promoCodeInputValue: '',\n            error: '',\n            canApply: false\n        };\n    }\n\n    public render(): JSX.Element {\n        return (\n            <div>\n                <div className='msc-promo-code-heading'>{this.props.promoCodeHeadingText}</div>\n                {this._renderForm(this.props.promoPlaceholderText, this.props.promoCodeApplyButtonText, this.props.cart)}\n                <p className={this.state.error ? 'msc-alert-danger' : ''}aria-live='assertive'>{this.state.error}</p>\n                {this._renderAppliedPromoCode(this.props)}\n            </div>\n        );\n    }\n\n    private _onInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const error = e.target.value === '' ? '' : this.state.error;\n        this.setState({\n            promoCodeInputValue: e.target.value, error: error,\n            canApply: e.target.value ? true : false\n        });\n    }\n\n    private _applyPromotion = (cartState: ICartState | undefined) => {\n        if (!cartState || !cartState.cart) {\n            return;\n        }\n        const appliedPromo = this.state.promoCodeInputValue;\n\n        cartState.addPromoCode({ promoCode: appliedPromo })\n            .then(result => {\n                if (result.status === 'SUCCESS') {\n                    // show success text\n                    this.setState({ promoCodeInputValue: '', error: '', canApply: false});\n                } else if (result.substatus === 'ALREADYADDED') {\n                    this.setState({ error: this.props.duplicatePromoCodeErrorText });\n                } else {\n                    this.setState({ error: this.props.invalidPromoCodeErrorText });\n                }\n            })\n            .catch(error => {\n                this.setState({ error: this.props.failedToAddPromoCodeErrorText });\n            });\n    }\n\n    private _renderForm = (promoPlaceholderText: string, promoCodeApplyButtonText: string, cartState: ICartState | undefined) => {\n        const _onSubmit = (event: React.FormEvent<HTMLFormElement>) => {event.preventDefault(); this._applyPromotion(cartState);};\n        const _applyPromotion = (event: React.MouseEvent<HTMLElement>) => {this._applyPromotion(cartState);};\n        const attributes = getTelemetryAttributes(this.props.telemetryContent!, this.payLoad);\n\n        return (\n            <form onSubmit={_onSubmit} className='msc-promo-code__form-container'>\n                <div className='msc-promo-code__group'>\n                    <input\n                        className='msc-promo-code__input-box'\n                        aria-label={promoPlaceholderText}\n                        onChange={this._onInputChange}\n                        value={this.state.promoCodeInputValue}\n                        placeholder={promoPlaceholderText}\n                    />\n                    <Button\n                        title={promoCodeApplyButtonText}\n                        className='msc-promo-code__apply-btn btn'\n                        onClick={_applyPromotion}\n                        disabled={!this.state.canApply}\n                        {...attributes}\n                    >\n                        {promoCodeApplyButtonText}\n                    </Button>\n                </div>\n            </form>\n        );\n    }\n\n    private _removePromotion = (cartState: ICartState | undefined, event: React.MouseEvent) => {\n        if (!cartState) {\n            return;\n        }\n        const code = event.currentTarget.getAttribute('data-value') || '';\n        cartState.removePromoCodes({\n            promoCodes: [\n                code\n            ]\n        })\n            .then(result => {\n                if (result.status === 'SUCCESS') {\n                    this.setState({ error: ''});\n                }\n            })\n            .catch(() => {\n                this.setState({ error: this.props.failedToRemovePromoCodeErrorText});\n            });\n\n    }\n    private _calculateDiscount = (code: string, cartState: ICartState | undefined) => {\n        if (!cartState || !cartState.cart || !cartState.cart.CartLines || cartState.cart.CartLines.length === 0 || !code) {\n            return;\n        }\n        let discountAmount = 0;\n        for (const line of cartState.cart.CartLines) {\n            if (line.DiscountLines) {\n                for (const discountLine of line.DiscountLines) {\n                    if (discountLine.DiscountCode === code) {\n                        discountAmount += discountLine.DiscountCost!;\n                    }\n                }\n            }\n        }\n        return discountAmount * -1;\n    }\n\n    private _renderAppliedPromoCode = (props: IPromoCodeProps) => {\n        if (!props.cart || !props.cart.cart || !props.cart.cart.Coupons || !(props.cart.cart.Coupons.length > 0)) {\n            return;\n        }\n\n        const _removePromotion = (event: React.MouseEvent<HTMLElement>) => {this._removePromotion(props.cart, event);};\n\n        const promoCodTotalDiscount = props.cart.cart.Coupons.reduce(\n            (count: number, coupon: Coupon) => {\n                return count + (this._calculateDiscount(coupon.Code || '', props.cart) || 0);\n            },\n            0);\n\n        return (\n            <>\n                <div className='msc-promo-code__discount'>\n                    <div className='msc-promo-code__discount-heading'>{this.props.appliedPromoCodeHeadingText}</div>\n                    <PriceComponent\n                        data={{\n                            price: {\n                                CustomerContextualPrice: promoCodTotalDiscount\n\n                            }\n                        }}\n                        context = {props.context}\n                        id = {props.id}\n                        typeName = {props.typeName}\n                        className = {'msc-promo-code__discount-value'}\n                    />\n                </div>\n                {\n                     props.cart.cart.Coupons.map((coupon: Coupon) => {\n                        const ariaLabel = props.removePromoAriaLabelFormat ? format(props.removePromoAriaLabelFormat, props.removePromoText, coupon.Code) : '';\n\n                        return (\n                            <div key={coupon.Code} className='msc-promo-code__line-container'>\n                                <div className='msc-promo-code__line-value'>\n                                    {coupon.Code} (\n                                        <PriceComponent\n                                            data={{\n                                                price: {\n                                                    CustomerContextualPrice: this._calculateDiscount(coupon.Code || '', props.cart)\n\n                                                }\n                                            }}\n                                            context = {props.context}\n                                            id = {props.id}\n                                            typeName = {props.typeName}\n                                            className = {'msc-promo-code__line-discount-value'}\n                                        />)\n                                </div>\n                                <Button\n                                    title={props.removePromoText}\n                                    className={'msc-promo-code__line__btn-remove'}\n                                    onClick={_removePromotion}\n                                    data-value={coupon.Code}\n                                    aria-label={ariaLabel}\n                                >\n                                    {props.removePromoText}\n                                </Button>\n                            </div>\n                        );\n                    })\n                }\n            </>\n        );\n    }\n}\n\nexport default PromoCode;"]}