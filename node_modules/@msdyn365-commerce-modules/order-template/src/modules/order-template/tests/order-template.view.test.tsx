/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

import { buildHydratedMockActionContext, buildMockModuleProps } from '@msdyn365-commerce/core';
import { render } from 'enzyme';
import * as React from 'react';

import { IOrderTemplateActionsViewProps, IOrderTemplateLineViewProps, OrderTemplateBulkActions } from '../components';
import { IOrderTemplateLinesCallbacks, IOrderTemplateViewProps } from '../order-template';
import { IOrderTemplateResources } from '../order-template.props.autogenerated';
import OrderTemplateLinesView from '../order-template.view';

const mockActionContext = buildHydratedMockActionContext();
// @ts-ignore partial mock
const mockContext: ICoreContext<{}> = {
    actionContext: mockActionContext,
    request: {},
    app: {
        config: {
            maxQuantityForCartLineItem: 10
        }
    }
};

const mockOrderAction: IOrderTemplateActionsViewProps = {
    addTemplateToBag: <div>Add to Template</div>,
    renameTemplate: <div>Rename Template</div>,
    removeTemplate: <div>Remove Template</div>
};

const mockResources: IOrderTemplateResources = {
    emptyOrderTemplateLinesText: 'Your order template lines is empty.',
    priceFree: 'Free',
    cancelBtnLabel: 'Cancel',
    orderTemplateTitle: 'orderTemplateTitle',
    renameOrderTemplateButtonText: 'Rename',
    renameOrderTemplateTitleText: 'Rename order template',
    renameTemplateButtonText: 'Rename template',
    removeItemFromOrderTemplateButtonText: 'Remove from order template',
    addOrderTemplateItemToBagButtonText: 'Add to bag',
    addSelectedToBagButtonText: 'Add Selected to bag',
    removeSelectedToBagButtonText: 'Remove Selected',
    waitingClass: 'waiting waiting-circular waiting-lg',
    addedToCartSuccessMessage: 'Added to your cart',
    addedToCartFailureMessage: 'Add to cart failed. Please refresh and retry',
    maxQuantityLimitText: 'You can only add {quantity} of this item to your shopping bag',
    originalPriceText: 'Original price',
    currentPriceText: 'Current price',
    productDimensionTypeColor: 'Color',
    productDimensionTypeSize: 'Size',
    productDimensionTypeStyle: 'Style',
    productDimensionTypeConfiguration: 'Configuration',
    errorGettingOrderTemplateLines: 'Sorry we are unable to load your order template lines at this moment, please try again later.',
    productNumberText: 'Product number',
    productText: 'Product',
    productUnitPriceText: 'Unit price',
    productUOMText: 'UOM',
    productQuantityText: 'Quantity',
    productActionsText: 'Actions',
    addTemplateToBagButtonText: 'Add template to bag',
    deleteTemplateButtonText: 'Delete template',
    inputQuantityAriaLabel: 'quantity input',
    decrementButtonAriaLabel: 'Press to decrease the quantity by 1',
    incrementButtonAriaLabel: 'Press to increment quantity by 1',
    addToCartFailureMessage: 'Add to cart failed. Please refresh and retry',
    addToCartSuccessMessage: 'Order template successfully added to cart',
    addToCartProcessMessage: 'Adding to cart',
    removeSelectedSuccessMessage: 'Selected lines successfully removed to cart',
    removeSelectedFailureMessage: 'Failed to remove selected lines, please try again',
    closeWindowButtonText: 'Close',
    deleteOrderTemplateFailedText: 'Failed to delete order template',
    flipperNext: 'flipperNext',
    flipperPrevious: 'flipperPrevious',
    paginationAriaLabel: 'paginationAriaLabel',
    viewCartButtonText: 'viewCartButtonText',
    orderTemplateCloseButtonText: 'orderTemplateCloseButtonText',
    linesAddedToCartHeaderItemsOneText: 'linesAddedToCartHeaderItemsOneText',
    linesAddedToCartHeaderLinesOneText: 'linesAddedToCartHeaderLinesOneText',
    linesAddedToCartHeaderLinesFormatText: 'linesAddedToCartHeaderLinesFormatText',
    linesAddedToCartHeaderMessageText: 'linesAddedToCartHeaderMessageText',
    itemAddedToCartHeaderItemOneText: 'itemAddedToCartHeaderItemOneText',
    itemAddedToCartHeaderItemFormatText: 'itemAddedToCartHeaderItemFormatText',
    itemAddedToCartHeaderMessageText: 'itemAddedToCartHeaderMessageText',
    freePriceText: 'freePriceText',
    addLineModalLinkText: 'Add a Line',
    addItemToTemplateText: 'Add to Template',
    selectProductButtonText: 'Select',
    backButtonText: 'Back to Products',
    searchModalPlaceholderText: 'Enter product search query',
    quantitySelectLabel: 'Quantity',
    notFoundSearchErrorNotice: 'No items found.',
    notFoundSearchErrorRedediation: 'Try entering a different keyword.',
    searchErrorMessage: 'Search Error',
    addLineProductUnitPricePrefix: 'Unit Price:',
    addLineProductUnitOfMeasurePrefix: 'UOM',
    searchButtonAriaLabel: 'Submit search',
    searchInputAriaLabel: 'Search query',
    searchResultsCountVerbage: 'We found $count $subject based on your search.',// @TODO figure out how to reliably test this count
    searchResultsCountSubject: 'product',
    addToTemplateConfirmation: '10 pair of sunglasses, green, regular have been added to template.',
    totalPriceLabel: 'Total',
    defaultOrderTemplateName: 'Untitled',
    progressNotificationText: 'Loading...',
    addToTemplateError: 'Error adding this product to this template.'
};

const mockOrderTemplateLines: IOrderTemplateLineViewProps[] = [
    {
        key: 'index1',
        productImage: <div>Product Image</div>,
        productListId: 'index1',
        productPrice: <div>Product Price</div>,
        addToBagButton: <div>Add to Cart Button</div>,
        removeButton: <div>Remove Button</div>,
        productName: 'Product Name',
        productNumber: <div>Product Number</div>,
        productInfo: <div>Product Info</div>,
        productLabel: <div>Product Label</div>,
        productUnitOfMeasure: <div>Product Unit Of Measure</div>,
        productQuantity: 1,
        productQuantityView: <div>Product Quantity View</div>,
        selectLine: <input/>
    },
    {
        key: 'index2',
        productImage: <div>Product Image</div>,
        productListId: 'index12',
        productPrice: <div>Product Price</div>,
        addToBagButton: <div>Add to Cart Button</div>,
        removeButton: <div>Remove Button</div>,
        productName: 'Product Name',
        productNumber: <div>Product Number</div>,
        productInfo: <div>Product Info</div>,
        productLabel: <div>Product Label</div>,
        productUnitOfMeasure: <div>Product Unit Of Measure</div>,
        productQuantity: 1,
        productQuantityView: <div>Product Quantity View</div>,
        selectLine: <input/>
    }
];

const mockOrderLinesCallbacks: IOrderTemplateLinesCallbacks = {
    updateQuantity: jest.fn()
};

describe('OrderTemplate', () => {
    it('renders correctly', () => {
        const moduleProps: IOrderTemplateViewProps = buildMockModuleProps({}, {}) as IOrderTemplateViewProps;

        const mockProps: IOrderTemplateViewProps = {
            ...moduleProps,
            OrderTemplateLines: {
                moduleProps: moduleProps,
                className: 'ms-order-template'
            },
            resources: mockResources,
            status: 'SUCCESS',
            productsStatusMessage: <div>Message</div>,
            heading: <div className={'ms-order-template__heading'}>Heading </div>,
            OrderTemplateActions: {
                className: 'ms-order-template-action-bar',
                tag: 'div'
            },
            ProductsTable: {
                className: 'ms-order-template__table',
                tag: 'table'
            },
            ProductsTableRow: {
                className: 'ms-order-template-table-line',
                tag: 'tr'
            },
            ProductsTableHeading: <div>Table Heading</div>,
            ProductDetails: {
                className: 'ms-order-template-table-line__link',
                tag: 'a'
            },
            orderLines: mockOrderTemplateLines,
            callbacks: mockOrderLinesCallbacks,
            orderActions: mockOrderAction,
            bulkOrderLineActions: OrderTemplateBulkActions({
                ...moduleProps,
                resources: mockResources,
                orderTemplateId: '1',
                onAddSelectionToBag: jest.fn(),
                onRemoveSelection: jest.fn()
            })
        };

        const component = render(<OrderTemplateLinesView {...mockProps} />);
        expect(component).toMatchSnapshot();
    });

    it('View renders status message correctly', () => {
        const moduleProps: IOrderTemplateViewProps = buildMockModuleProps({}, {}) as IOrderTemplateViewProps;

        const mockProps: IOrderTemplateViewProps = {
            ...moduleProps,
            OrderTemplateLines: {
                moduleProps: moduleProps,
                className: 'ms-order-template'
            },
            resources: mockResources,
            status: 'LOADING',
            statusMessage: <p>Waiting</p>,
            productsStatusMessage: <div>Message</div>,
            heading: <div className={'ms-order-template__heading'}>Heading </div>,
            OrderTemplateActions: {
                className: 'ms-order-template-action-bar',
                tag: 'div'
            },
            ProductsTable: {
                className: 'ms-order-template__table',
                tag: 'table'
            },
            ProductsTableRow: {
                className: 'ms-order-template-table-line',
                tag: 'tr'
            },
            ProductsTableHeading: <div>Table Heading</div>,
            ProductDetails: {
                className: 'ms-order-template-table-line__link',
                tag: 'a'
            },
            orderLines: mockOrderTemplateLines,
            callbacks: mockOrderLinesCallbacks,
            orderActions: mockOrderAction
        };

        const component = render(<OrderTemplateLinesView {...mockProps} />);
        expect(component).toMatchSnapshot();
    });
});
