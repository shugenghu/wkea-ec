{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/web.dom-collections.for-each.js\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{createDataActionHook}from'@msdyn365-commerce/core';import{TelemetryEvent}from'@msdyn365-commerce/telemetry-internal';import{getProductInfoFromCart}from'./telemetry.action.helper';const beforeAddToCart=async(inputs,actionContext)=>{try{const actionInput=Array.isArray(inputs)?inputs[0]:inputs;if(actionInput.queryParams&&typeof actionInput.queryParams==='function'){const addCartLinesParams=actionInput.queryParams();if(addCartLinesParams&&addCartLinesParams.cartLines){actionContext.requestContext.telemetryData[\"addedCartLines\"]=addCartLinesParams.cartLines;return;}}actionContext.telemetry.debug('AddToCart pre-data action hook failed - No added cart lines found');}catch(e){actionContext.telemetry.debug('AddToCart pre-data action hook failed.',e);}};const afterAddToCart=async(_inputs,cart,actionContext)=>{if(window&&window._msdyn365&&window._msdyn365.telemetry){const addedProducts={};const addedCartLines=actionContext.requestContext.telemetryData[\"addedCartLines\"];if(addedCartLines){addedCartLines.forEach(cartLine=>{if(cartLine&&cartLine.ProductId){const addedProduct=actionContext.requestContext.telemetryData[cartLine.ProductId];if(addedProduct){addedProducts[cartLine.ProductId]=addedProduct;}}});}window._msdyn365.telemetry.logEvent(TelemetryEvent.AddToCart,getProductInfoFromCart(cart,addedProducts,actionContext.requestContext));}};createDataActionHook({actionId:'@msdyn365-commerce/retail-proxy/Carts/AddCartLines',postReaderHook:afterAddToCart,preReaderHook:beforeAddToCart});","map":{"version":3,"sources":["actions/addToCart-telemetry.action.ts"],"names":[],"mappings":"8FAAA;;;AAGG,GAEH,OAAS,oBAAT,KAAmE,yBAAnE,CAGA,OAAS,cAAT,KAA+B,uCAA/B,CACA,OAAS,sBAAT,KAAuC,2BAAvC,CASA,KAAM,CAAA,eAAe,CAAG,MAAO,MAAP,CAA8C,aAA9C,GAA+E,CACnG,GAAI,CACA,KAAM,CAAA,WAAW,CAAG,KAAK,CAAC,OAAN,CAAc,MAAd,EAA6C,MAAM,CAAC,CAAD,CAAnD,CAA8E,MAAlG,CAGA,GAAI,WAAW,CAAC,WAAZ,EAA2B,MAAO,CAAA,WAAW,CAAC,WAAnB,GAAmC,UAAlE,CAA8E,CAC1E,KAAM,CAAA,kBAAkB,CAAG,WAAW,CAAC,WAAZ,EAA3B,CACA,GAAI,kBAAkB,EAAI,kBAAkB,CAAC,SAA7C,CAAwD,CAEpD,aAAa,CAAC,cAAd,CAA6B,aAA7B,mBAA+D,kBAAkB,CAAC,SAAlF,CACA,OACH,CACJ,CACD,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,mEAA9B,EACH,CAAC,MAAO,CAAP,CAAU,CACR,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,wCAA9B,CAAwE,CAAxE,EACH,CACJ,CAjBD,CAyBA,KAAM,CAAA,cAAc,CAAG,MAAO,OAAP,CAA+C,IAA/C,CAAoE,aAApE,GAAqG,CACxH,GAAI,MAAM,EAAI,MAAM,CAAC,SAAjB,EAA8B,MAAM,CAAC,SAAP,CAAiB,SAAnD,CAA8D,CAC1D,KAAM,CAAA,aAAa,CAAsB,EAAzC,CACA,KAAM,CAAA,cAAc,CAAe,aAAa,CAAC,cAAd,CAA6B,aAA7B,kBAAnC,CAGA,GAAI,cAAJ,CAAoB,CAChB,cAAc,CAAC,OAAf,CAAwB,QAAD,EAAuB,CAC1C,GAAI,QAAQ,EAAI,QAAQ,CAAC,SAAzB,CAAoC,CAChC,KAAM,CAAA,YAAY,CAAG,aAAa,CAAC,cAAd,CAA6B,aAA7B,CAA2C,QAAQ,CAAC,SAApD,CAArB,CACA,GAAI,YAAJ,CAAkB,CACd,aAAa,CAAC,QAAQ,CAAC,SAAV,CAAb,CAAoC,YAApC,CACH,CACJ,CACJ,CAPD,EAQH,CAGD,MAAM,CAAC,SAAP,CAAiB,SAAjB,CAA2B,QAA3B,CACI,cAAc,CAAC,SADnB,CAEI,sBAAsB,CAAC,IAAD,CAAO,aAAP,CAAsB,aAAa,CAAC,cAApC,CAF1B,EAIH,CACJ,CAvBD,CAyBA,oBAAoB,CAAC,CACjB,QAAQ,CAAE,oDADO,CAEjB,cAAc,CAAE,cAFC,CAGjB,aAAa,CAAE,eAHE,CAAD,CAApB","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { createDataActionHook, IActionContext, IActionInput } from '@msdyn365-commerce/core';\nimport { IAny, IDictionary, IMSDyn365Window } from '@msdyn365-commerce/core-internal';\nimport { Cart, CartLine, IAddCartLinesParam, IDataServiceRequest } from '@msdyn365-commerce/retail-proxy';\nimport { TelemetryEvent } from '@msdyn365-commerce/telemetry-internal';\nimport { getProductInfoFromCart } from './telemetry.action.helper';\n\ndeclare var window: IMSDyn365Window;\n\n/**\n * Saves info on cart lines added before calling data action\n * @param inputs Data action inputs\n * @param actionContext Action context\n */\nconst beforeAddToCart = async (inputs: IActionInput | IActionInput[], actionContext: IActionContext) => {\n    try {\n        const actionInput = Array.isArray(inputs) ? <IDataServiceRequest>inputs[0] : <IDataServiceRequest>inputs;\n\n        // If cart lines were added\n        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {\n            const addCartLinesParams = actionInput.queryParams<IAddCartLinesParam>();\n            if (addCartLinesParams && addCartLinesParams.cartLines) {\n                // Save info on added cart lines for post data action hook to pick up\n                actionContext.requestContext.telemetryData[`addedCartLines`] = addCartLinesParams.cartLines;\n                return;\n            }\n        }\n        actionContext.telemetry.debug('AddToCart pre-data action hook failed - No added cart lines found');\n    } catch (e) {\n        actionContext.telemetry.debug('AddToCart pre-data action hook failed.', e);\n    }\n};\n\n/**\n * Fires an AddToCart event after data action completed\n * @param _inputs Data action inputs\n * @param cart New cart object after cart lines have been added\n * @param actionContext Action context\n */\nconst afterAddToCart = async (_inputs: IActionInput | IActionInput[], cart: Cart | Cart[], actionContext: IActionContext) => {\n    if (window && window._msdyn365 && window._msdyn365.telemetry) {\n        const addedProducts: IDictionary<IAny> = {};\n        const addedCartLines = <CartLine[]>actionContext.requestContext.telemetryData[`addedCartLines`];\n\n        // If TelemetryData exists for added cart lines, collect product info\n        if (addedCartLines) {\n            addedCartLines.forEach((cartLine: CartLine) => {\n                if (cartLine && cartLine.ProductId) {\n                    const addedProduct = actionContext.requestContext.telemetryData[cartLine.ProductId];\n                    if (addedProduct) {\n                        addedProducts[cartLine.ProductId] = addedProduct;\n                    }\n                }\n            });\n        }\n\n        // Fire AddToCart event\n        window._msdyn365.telemetry.logEvent(\n            TelemetryEvent.AddToCart,\n            getProductInfoFromCart(cart, addedProducts, actionContext.requestContext)\n        );\n    }\n};\n\ncreateDataActionHook({\n    actionId: '@msdyn365-commerce/retail-proxy/Carts/AddCartLines',\n    postReaderHook: afterAddToCart,\n    preReaderHook: beforeAddToCart\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}