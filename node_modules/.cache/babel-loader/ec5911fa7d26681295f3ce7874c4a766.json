{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{isEmptyOrNullObject}from'@msdyn365-commerce/core-internal';import{EXCEPTION_INVALID_URL,LogLevel}from'@msdyn365-commerce/telemetry-internal';import{getRCSUversion}from'@msdyn365-commerce/utilities-internal';import axios from'axios';import*as bodyParser from'body-parser';import compression from'compression';import cookieSession from'cookie-session';import express from'express';import{httpsOverHttp}from'tunnel';import url from'url';import{getMockDataBasedOnRequestQueryString,getV3mockPageJson}from'../mock/mock-helper';import keystonePaths from'../paths';import{safeRoute}from'../utils/helpers';import{detectProxy,getCheckoutRoute,getRequestUrl,KEYSTONE_ENVIRONMENT,loadFeatureFlags,registerAttributeRenderers,renderPage,resolveRouteInformation,sanitizeUrlForLogging,setCorsHeaders,setResponseHeaders,setTelemetryObject,validateRouteAndChannelConfig}from'../utils/platform-utils';import{HttpException}from'./error';import{RSRequestInterceptor,RSRequestInterceptorErrorHandler,RSResponseInterceptor,RSResponseInterceptorErrorHandler}from'./inteceptors/rs-logging-interceptor';import{requestTimeout}from'./middleware/route-timeout';import{requestRouteTimer}from'./middleware/route-timers';import{getBodyConfig,mapRequestContextWithRenderingContext,mergeSwtichFromPlatformSettingsWithFeatureSwitch}from'./parse-request';import{preProcessRequest,serverExceptionParser}from'./request-routers';import experimentationRouter from'./request-routers/experimentation-router';import healthRouter from'./request-routers/health-router';import sdkRouter from'./request-routers/sdk-router';import staticsRouter,{parseHashedStaticsRequest}from'./request-routers/statics-router';import{HASHED_STATICS_PREFIX}from'./statics-pipeline/statics-helpers';import PageContractApiService from'./temp-page-contract-api-service';var computerName=process.env.COMPUTERNAME;var rcsuVersion=process.env.MSDyn365Commerce_RCSUVERSION;console.log(computerName);var environment=KEYSTONE_ENVIRONMENT;console.log(JSON.stringify(environment));console.log(JSON.stringify(keystonePaths));// In debug mode, add the proxy debug interceptor for all HTTP Requests\nif(process.env.NODE_ENV==='development'){axios.interceptors.request.use(function(config){// Only use the interceptor when debug flag is enabled\nif(process.env.NODE_USE_DEBUG_PROXY==='1'){config.httpsAgent=httpsOverHttp({proxy:{host:'127.0.0.1',port:8888,headers:{}}});}return config;});}// TODO: move these to server-initialization\naxios.interceptors.request.use(RSRequestInterceptor,RSRequestInterceptorErrorHandler);axios.interceptors.response.use(RSResponseInterceptor,RSResponseInterceptorErrorHandler);// tslint:disable-next-line:max-func-body-length\nexport function appFunc(_ref,env,options,appInsightsTelemetryClient){var clientStats=_ref.clientStats;var PUBLIC_DIR=process.env.PUBLIC_DIR||'build/public';var server=express();var sdkRouterInstance=sdkRouter(server);var staticsRouterInstance=staticsRouter(PUBLIC_DIR,clientStats);var healthRouterInstance=healthRouter();var experimentationRouterInstance=experimentationRouter();server.use(requestRouteTimer).use(cookieSession({name:'msdyn365c_aad',signed:false,maxAge:3600000// 1 hour in ms, the lifespan of an aad token\n})).disable('x-powered-by').disable('etag').use(bodyParser.urlencoded({limit:'50mb',extended:false})).use(bodyParser.json({limit:'50mb'})).use(express.urlencoded({extended:true})).use(detectProxy).use(compression()).use(loadFeatureFlags).use(setResponseHeaders).use(requestTimeout).use(express[\"static\"](PUBLIC_DIR,{// disable etag\netag:false,// disable special handling of ../ and ./\ndotfiles:'deny',// don't provide generated directory listings\nindex:false,// max cache timeout of a week\nmaxAge:process.env.NODE_ENV==='development'?1:604800000})).use(setTelemetryObject(appInsightsTelemetryClient)).use('/_sdk',sdkRouterInstance).use(experimentationRouterInstance).use('/version',function(req,res){res.sendFile(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);}).use('/sockjs-node',function(req,res){if(process.env.NODE_ENV==='development'&&req.query.t){// This is a workaround for dealing with sockjs requests to the wrong port\n// In local dev scenario, sock js requests should only be made to the dev server port\n// e.g. localhost:4001/sockjs-node/info?t=1587868046907 in most cases. However for some reason a sockjs request is made the http server as well\n// causing us to look up the server page (e.g. int2.fabrikam.com/sock-js) which is unnecessary and leads to console spam\n//\n// This change here will not impact HMR as changes are observed on the dev port not the http port. All this does is add a\n// workaround that will send a 404 back immediately so it doesn't go through our request flow and print out a bunch of errors in the console\n// TODO: Find out why something is sending request to http server\n// See https://github.com/webpack/webpack-dev-server/issues/1802#issuecomment-484372015 for a discussion of the issue. Apparently issue still\n// exists in webpack dev server v3.8.1\nres.status(404).send();}})/**\r\n         * Health check endpoints\r\n         */.use(healthRouterInstance).use([// statics route from 1rf with submission id\n\"/_scnr/\".concat(process.env.SUBMISSIONID||'statics'),// statics route from 1rf for hashed js statics\n\"/_scnr/\".concat(process.env.SUBMISSIONID||'statics',\"/j\"),// (legacy) route from 1rf without submission id\n\"/_scnr\",// local with submission id\n\"/\".concat(process.env.SUBMISSIONID||'statics'),// local hashed js statics\n\"/j\"],staticsRouterInstance)/**\r\n         * localhost serving of assets\r\n         */.get([// non-local route with submission ID\n\"/\".concat(HASHED_STATICS_PREFIX).concat(process.env.SUBMISSIONID,\"/:hashedUrl\"),// local routes without submission id\n\"/\".concat(HASHED_STATICS_PREFIX,\":hashedUrl\")],safeRoute(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(req,res,next){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",parseHashedStaticsRequest(req,res,next,{clientStats:clientStats,PUBLIC_DIR:PUBLIC_DIR},res.locals.telemetry));case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2,_x3){return _ref2.apply(this,arguments);};}()))/**\r\n         * Local development auth redirect route.\r\n         *  If the request is from AAD capture the auth information in the session and redirect to the requested\r\n         *  url as a get.\r\n         */.post('*',function(req,res,next){if(req.body&&req.body.id_token){// @ts-ignore\nreq.session&&(req.session.id_token=req.body.id_token);return res.redirect(url.format({protocol:req.protocol,host:req.get('host'),pathname:req.originalUrl}));}next();})/**\r\n         * Page Rendering Routes\r\n         */.use(function(req,res,next){res.locals.requestContext=preProcessRequest(req,res,process.env.COMPUTERNAME,res.locals.telemetry);next();})/**\r\n         * Create mock PageResponse for Modules routes\r\n         */.get('/modules',safeRoute(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(req,res,next){var content,context;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return getMockDataBasedOnRequestQueryString(req.query,res.locals.telemetry);case 2:content=_context2.sent;res.locals.isMockRequest=true;res.locals.pageResponse=content;context=res.locals.requestContext;context.locale=req.query.locale||context.locale;if(!context.locale){context.locale='en-us';}next();case 9:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x4,_x5,_x6){return _ref3.apply(this,arguments);};}())).get('/page/:themeName/:pageType/:layout',safeRoute(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(req,res,next){var context;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:context=res.locals.requestContext;context.locale=req.query.locale||context.locale;if(!req.params){_context3.next=6;break;}_context3.next=5;return PageContractApiService.getThemeLayout(req.params.themeName,req.params.pageType,req.params.layout,res.locals.telemetry);case 5:res.locals.pageResponse=_context3.sent;case 6:return _context3.abrupt(\"return\",renderPage(req,res,next,{clientStats:clientStats}));case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x7,_x8,_x9){return _ref4.apply(this,arguments);};}())).get('/segment/:themeName/:segmentName',safeRoute(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(req,res,next){var context,segmentJson,pageJsonV3;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:context=res.locals.requestContext;context.locale=req.query.locale||context.locale;if(!req.params){_context4.next=9;break;}_context4.next=5;return PageContractApiService.getThemeSegment(req.params.themeName,req.params.segmentName,res.locals.telemetry);case 5:segmentJson=_context4.sent;// Get the default mock page json\npageJsonV3=getV3mockPageJson();// @ts-ignore\npageJsonV3.pageRoot.modules.body[0].modules.primary[0].modules.content.push(segmentJson);res.locals.pageResponse=pageJsonV3;case 9:next();case 10:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x10,_x11,_x12){return _ref5.apply(this,arguments);};}()))/**\r\n         * Get Page Response for rendering\r\n         */.use(safeRoute(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(req,res,next){var serverHost,requestUrl,routeInfo,checkoutRoute,_res$locals$pageRespo;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:serverHost=req.query&&req.query.server&&req.query.server||process.env.MSDyn365_HOST||process.env.SERVER_HOST||undefined;// For POST /render routes, res.locals.pageResponse will already be set\nif(!(isEmptyOrNullObject(res.locals.pageResponse)&&serverHost)){_context5.next=4;break;}_context5.next=4;return PageContractApiService.handleGetPageResponse(req,res,serverHost);case 4:requestUrl=getRequestUrl(res);routeInfo=resolveRouteInformation(res,requestUrl);checkoutRoute=getCheckoutRoute(res);// If the RCSU version environment variable is not defined,\n// set it with API settings from the first request and save it for future requests\nif(!(!rcsuVersion||rcsuVersion==='--')){_context5.next=12;break;}if(!(res.locals.pageResponse&&res.locals.pageResponse.renderingContext&&(_res$locals$pageRespo=res.locals.pageResponse.renderingContext.apiSettings)!==null&&_res$locals$pageRespo!==void 0&&_res$locals$pageRespo.baseUrl)){_context5.next=12;break;}_context5.next=11;return getRCSUversion(res.locals.pageResponse.renderingContext.apiSettings.baseUrl);case 11:rcsuVersion=_context5.sent;case 12:if(routeInfo){res.locals.telemetry.log(LogLevel.Information,'Processing request for {URL} {route} by process {processId} with {SDKVersion}, {SSKVersion}, {RetailProxy} {RCSUVersion} {CheckoutRoute}',{values:[sanitizeUrlForLogging(requestUrl),routeInfo||'',process.pid,process.env.MSDyn365Commerce_SDK_VERSION,process.env.MSDyn365Commerce_SSK_VERSION,process.env.MSDyn365Commerce_RSVERSION,rcsuVersion,checkoutRoute]});}// Re-initialize request context against rendering context\nres.locals.requestContext=mapRequestContextWithRenderingContext(req,res.locals.requestContext,res.locals.pageResponse.renderingContext,res.locals.pageResponse.appContext,getBodyConfig(res.locals.pageResponse));// Set Feature switches if they could not be set above\nif(!res.locals.features||isEmptyOrNullObject(res.locals.features)&&res.locals.pageResponse.renderingContext){res.locals.requestContext.features=res.locals.pageResponse.renderingContext.features||{};}res.locals.requestContext=mergeSwtichFromPlatformSettingsWithFeatureSwitch(res.locals.requestContext);registerAttributeRenderers(res.locals.telemetry,res.locals.moduleTelemetry,res.locals.requestContext);next();case 18:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x13,_x14,_x15){return _ref6.apply(this,arguments);};}())).use(setCorsHeaders)/**\r\n         * Validate Route Middleware\r\n         */.use(validateRouteAndChannelConfig).get('/modules',safeRoute(/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(req,res,next){return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt(\"return\",renderPage(req,res,next,{clientStats:clientStats}));case 1:case\"end\":return _context6.stop();}}},_callee6);}));return function(_x16,_x17,_x18){return _ref7.apply(this,arguments);};}())).get('*',safeRoute(/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(req,res,next){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!isEmptyOrNullObject(res.locals.pageResponse)){_context7.next=2;break;}throw new HttpException(404,EXCEPTION_INVALID_URL);case 2:return _context7.abrupt(\"return\",renderPage(req,res,next,{clientStats:clientStats}));case 3:case\"end\":return _context7.stop();}}},_callee7);}));return function(_x19,_x20,_x21){return _ref8.apply(this,arguments);};}())).post('/render',safeRoute(/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(req,res,next){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:return _context8.abrupt(\"return\",renderPage(req,res,next,{clientStats:clientStats}));case 1:case\"end\":return _context8.stop();}}},_callee8);}));return function(_x22,_x23,_x24){return _ref9.apply(this,arguments);};}())).use(serverExceptionParser);return server;}","map":{"version":3,"sources":["../../../src/_server/index.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport {\n    IAny,\n    IDictionary,\n    IGeneric,\n    IPageConfig,\n    IPageResponse,\n    IRequestContext,\n    isEmptyOrNullObject\n} from '@msdyn365-commerce/core-internal';\nimport { EXCEPTION_INVALID_URL, LogLevel } from '@msdyn365-commerce/telemetry-internal';\nimport { TelemetryClient } from '@msdyn365-commerce/telemetry-internal/dist/lib/server';\nimport { getRCSUversion } from '@msdyn365-commerce/utilities-internal';\nimport axios from 'axios';\nimport * as bodyParser from 'body-parser';\nimport compression from 'compression';\nimport cookieSession from 'cookie-session';\nimport express, { Express, NextFunction, Request, Response } from 'express';\nimport { httpsOverHttp } from 'tunnel';\nimport url from 'url';\nimport { getMockDataBasedOnRequestQueryString, getV3mockPageJson } from '../mock/mock-helper';\nimport keystonePaths from '../paths';\nimport { safeRoute } from '../utils/helpers';\nimport {\n    detectProxy,\n    getCheckoutRoute,\n    getRequestUrl,\n    KEYSTONE_ENVIRONMENT,\n    loadFeatureFlags,\n    registerAttributeRenderers,\n    renderPage,\n    resolveRouteInformation,\n    sanitizeUrlForLogging,\n    setCorsHeaders,\n    setResponseHeaders,\n    setTelemetryObject,\n    validateRouteAndChannelConfig\n} from '../utils/platform-utils';\nimport { HttpException } from './error';\nimport {\n    RSRequestInterceptor,\n    RSRequestInterceptorErrorHandler,\n    RSResponseInterceptor,\n    RSResponseInterceptorErrorHandler\n} from './inteceptors/rs-logging-interceptor';\nimport { requestTimeout } from './middleware/route-timeout';\nimport { requestRouteTimer } from './middleware/route-timers';\nimport { getBodyConfig, mapRequestContextWithRenderingContext, mergeSwtichFromPlatformSettingsWithFeatureSwitch } from './parse-request';\nimport { preProcessRequest, serverExceptionParser } from './request-routers';\nimport experimentationRouter from './request-routers/experimentation-router';\nimport healthRouter from './request-routers/health-router';\nimport sdkRouter from './request-routers/sdk-router';\nimport staticsRouter, { parseHashedStaticsRequest } from './request-routers/statics-router';\nimport { HASHED_STATICS_PREFIX } from './statics-pipeline/statics-helpers';\nimport PageContractApiService from './temp-page-contract-api-service';\n\nconst computerName = process.env.COMPUTERNAME;\nlet rcsuVersion = process.env.MSDyn365Commerce_RCSUVERSION;\nconsole.log(computerName);\n\nconst environment = KEYSTONE_ENVIRONMENT;\n\nconsole.log(JSON.stringify(environment));\nconsole.log(JSON.stringify(keystonePaths));\n\n// In debug mode, add the proxy debug interceptor for all HTTP Requests\nif (process.env.NODE_ENV === 'development') {\n    axios.interceptors.request.use(config => {\n        // Only use the interceptor when debug flag is enabled\n        if (process.env.NODE_USE_DEBUG_PROXY === '1') {\n            config.httpsAgent = httpsOverHttp({\n                proxy: {\n                    host: '127.0.0.1',\n                    port: 8888,\n                    headers: {}\n                }\n            });\n        }\n\n        return config;\n    });\n}\n\n// TODO: move these to server-initialization\naxios.interceptors.request.use(RSRequestInterceptor, RSRequestInterceptorErrorHandler);\naxios.interceptors.response.use(RSResponseInterceptor, RSResponseInterceptorErrorHandler);\n\n// tslint:disable-next-line:max-func-body-length\nexport function appFunc(\n    { clientStats }: { clientStats: {} },\n    env: IDictionary<string>,\n    options: IGeneric<IAny>,\n    appInsightsTelemetryClient: TelemetryClient\n): Express {\n    const PUBLIC_DIR = process.env.PUBLIC_DIR || 'build/public';\n    const server = express();\n    const sdkRouterInstance = sdkRouter(server);\n    const staticsRouterInstance = staticsRouter(PUBLIC_DIR, clientStats);\n    const healthRouterInstance = healthRouter();\n    const experimentationRouterInstance = experimentationRouter();\n    server\n        .use(requestRouteTimer)\n        .use(\n            cookieSession({\n                name: 'msdyn365c_aad',\n                signed: false,\n                maxAge: 3600000 // 1 hour in ms, the lifespan of an aad token\n            })\n        )\n        .disable('x-powered-by')\n        .disable('etag')\n        .use(bodyParser.urlencoded({ limit: '50mb', extended: false }))\n        .use(bodyParser.json({ limit: '50mb' }))\n        .use(express.urlencoded({ extended: true }))\n        .use(detectProxy)\n        .use(compression())\n        .use(loadFeatureFlags)\n        .use(setResponseHeaders)\n        .use(requestTimeout)\n        .use(\n            express.static(PUBLIC_DIR, {\n                // disable etag\n                etag: false,\n                // disable special handling of ../ and ./\n                dotfiles: 'deny',\n                // don't provide generated directory listings\n                index: false,\n                // max cache timeout of a week\n                maxAge: process.env.NODE_ENV === 'development' ? 1 : 604800000\n            })\n        )\n        .use(setTelemetryObject(appInsightsTelemetryClient))\n        .use('/_sdk', sdkRouterInstance)\n        .use(experimentationRouterInstance)\n        .use('/version', (req: Request, res: Response) => {\n            res.sendFile(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);\n        })\n        .use('/sockjs-node', (req: Request, res: Response) => {\n            if (process.env.NODE_ENV === 'development' && req.query.t) {\n                // This is a workaround for dealing with sockjs requests to the wrong port\n                // In local dev scenario, sock js requests should only be made to the dev server port\n                // e.g. localhost:4001/sockjs-node/info?t=1587868046907 in most cases. However for some reason a sockjs request is made the http server as well\n                // causing us to look up the server page (e.g. int2.fabrikam.com/sock-js) which is unnecessary and leads to console spam\n                //\n                // This change here will not impact HMR as changes are observed on the dev port not the http port. All this does is add a\n                // workaround that will send a 404 back immediately so it doesn't go through our request flow and print out a bunch of errors in the console\n                // TODO: Find out why something is sending request to http server\n                // See https://github.com/webpack/webpack-dev-server/issues/1802#issuecomment-484372015 for a discussion of the issue. Apparently issue still\n                // exists in webpack dev server v3.8.1\n                res.status(404).send();\n            }\n        })\n        /**\n         * Health check endpoints\n         */\n        .use(healthRouterInstance)\n        .use(\n            [\n                // statics route from 1rf with submission id\n                `/_scnr/${process.env.SUBMISSIONID || 'statics'}`,\n                // statics route from 1rf for hashed js statics\n                `/_scnr/${process.env.SUBMISSIONID || 'statics'}/j`,\n                // (legacy) route from 1rf without submission id\n                `/_scnr`,\n                // local with submission id\n                `/${process.env.SUBMISSIONID || 'statics'}`,\n                // local hashed js statics\n                `/j`\n            ],\n            staticsRouterInstance\n        )\n        /**\n         * localhost serving of assets\n         */\n        .get(\n            [\n                // non-local route with submission ID\n                `/${HASHED_STATICS_PREFIX}${process.env.SUBMISSIONID}/:hashedUrl`,\n                // local routes without submission id\n                `/${HASHED_STATICS_PREFIX}:hashedUrl`\n            ],\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                return parseHashedStaticsRequest(req, res, next, { clientStats, PUBLIC_DIR }, res.locals.telemetry);\n            })\n        )\n        /**\n         * Local development auth redirect route.\n         *  If the request is from AAD capture the auth information in the session and redirect to the requested\n         *  url as a get.\n         */\n        .post('*', (req: Request, res: Response, next: NextFunction) => {\n            if (req.body && req.body.id_token) {\n                // @ts-ignore\n                req.session && (req.session.id_token = req.body.id_token);\n                return res.redirect(\n                    url.format({\n                        protocol: req.protocol,\n                        host: req.get('host'),\n                        pathname: req.originalUrl\n                    })\n                );\n            }\n            next();\n        })\n        /**\n         * Page Rendering Routes\n         */\n        .use((req: Request, res: Response, next: NextFunction) => {\n            res.locals.requestContext = preProcessRequest(req, res, process.env.COMPUTERNAME, res.locals.telemetry);\n            next();\n        })\n        /**\n         * Create mock PageResponse for Modules routes\n         */\n        .get(\n            '/modules',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                const content = await getMockDataBasedOnRequestQueryString(req.query, res.locals.telemetry);\n                res.locals.isMockRequest = true;\n                res.locals.pageResponse = content;\n\n                const context: IRequestContext = res.locals.requestContext;\n                context.locale = req.query.locale || context.locale;\n                if (!context.locale) {\n                    context.locale = 'en-us';\n                }\n\n                next();\n            })\n        )\n        .get(\n            '/page/:themeName/:pageType/:layout',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                const context: IRequestContext = res.locals.requestContext;\n                context.locale = req.query.locale || context.locale;\n\n                if (req.params) {\n                    res.locals.pageResponse = await PageContractApiService.getThemeLayout(\n                        req.params.themeName,\n                        req.params.pageType,\n                        req.params.layout,\n                        res.locals.telemetry\n                    );\n                }\n                return renderPage(req, res, next, { clientStats });\n            })\n        )\n        .get(\n            '/segment/:themeName/:segmentName',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                const context: IRequestContext = res.locals.requestContext;\n                context.locale = req.query.locale || context.locale;\n\n                if (req.params) {\n                    const segmentJson = await PageContractApiService.getThemeSegment(\n                        req.params.themeName,\n                        req.params.segmentName,\n                        res.locals.telemetry\n                    );\n                    // Get the default mock page json\n                    const pageJsonV3: IPageResponse = getV3mockPageJson();\n                    // @ts-ignore\n                    pageJsonV3.pageRoot.modules.body[0].modules.primary[0].modules.content.push(segmentJson);\n                    res.locals.pageResponse = pageJsonV3;\n                }\n                next();\n            })\n        )\n        /**\n         * Get Page Response for rendering\n         */\n        .use(\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                const serverHost =\n                    (req.query && req.query.server && req.query.server) ||\n                    process.env.MSDyn365_HOST ||\n                    process.env.SERVER_HOST ||\n                    undefined;\n\n                // For POST /render routes, res.locals.pageResponse will already be set\n                if (isEmptyOrNullObject(res.locals.pageResponse) && serverHost) {\n                    await PageContractApiService.handleGetPageResponse(req, res, serverHost);\n                }\n                const requestUrl = getRequestUrl(res);\n                const routeInfo = resolveRouteInformation(res, requestUrl);\n                const checkoutRoute = getCheckoutRoute(res);\n\n                // If the RCSU version environment variable is not defined,\n                // set it with API settings from the first request and save it for future requests\n                if (!rcsuVersion || rcsuVersion === '--') {\n                    if (res.locals.pageResponse && res.locals.pageResponse.renderingContext && res.locals.pageResponse.renderingContext.apiSettings?.baseUrl) {\n                        rcsuVersion = await getRCSUversion(res.locals.pageResponse.renderingContext.apiSettings.baseUrl);\n                    }\n                }\n\n                if (routeInfo) {\n                    res.locals.telemetry.log(\n                        LogLevel.Information,\n                        'Processing request for {URL} {route} by process {processId} with {SDKVersion}, {SSKVersion}, {RetailProxy} {RCSUVersion} {CheckoutRoute}',\n                        {\n                            values: [\n                                sanitizeUrlForLogging(requestUrl),\n                                routeInfo || '',\n                                process.pid,\n                                process.env.MSDyn365Commerce_SDK_VERSION,\n                                process.env.MSDyn365Commerce_SSK_VERSION,\n                                process.env.MSDyn365Commerce_RSVERSION,\n                                rcsuVersion,\n                                checkoutRoute\n                            ]\n                        }\n                    );\n                }\n\n                // Re-initialize request context against rendering context\n                res.locals.requestContext = mapRequestContextWithRenderingContext(\n                    req,\n                    res.locals.requestContext,\n                    res.locals.pageResponse.renderingContext,\n                    res.locals.pageResponse.appContext,\n                    <IPageConfig>getBodyConfig(res.locals.pageResponse)\n                );\n\n                // Set Feature switches if they could not be set above\n                if (!res.locals.features || (isEmptyOrNullObject(res.locals.features) && res.locals.pageResponse.renderingContext)) {\n                    res.locals.requestContext.features = res.locals.pageResponse.renderingContext.features || {};\n                }\n\n                res.locals.requestContext = mergeSwtichFromPlatformSettingsWithFeatureSwitch(res.locals.requestContext);\n                registerAttributeRenderers(res.locals.telemetry, res.locals.moduleTelemetry, res.locals.requestContext);\n                next();\n            })\n        )\n        .use(setCorsHeaders)\n        /**\n         * Validate Route Middleware\n         */\n        .use(validateRouteAndChannelConfig)\n        .get(\n            '/modules',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                return renderPage(req, res, next, { clientStats });\n            })\n        )\n        .get(\n            '*',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                // For invalid page, pageResponse is not set\n                if (isEmptyOrNullObject(res.locals.pageResponse)) {\n                    throw new HttpException(404, EXCEPTION_INVALID_URL);\n                }\n\n                return renderPage(req, res, next, { clientStats });\n            })\n        )\n        .post(\n            '/render',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                return renderPage(req, res, next, { clientStats });\n            })\n        )\n        .use(serverExceptionParser);\n    return server;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}