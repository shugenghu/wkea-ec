{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{__decorate}from\"tslib\";import classnames from'classnames';import _get from'lodash/get';import{action,computed,reaction,when}from'mobx';import{observer}from'mobx-react';import*as React from'react';import{withModuleState}from'@msdyn365-commerce-modules/checkout-utilities';import{Modal}from'@msdyn365-commerce-modules/utilities';import{getUrlSync}from'@msdyn365-commerce/core';import{retrieveCardPaymentAcceptResultAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';import{resolveCardTypesAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import getCardPaymentAcceptPointAction,{GetCardPaymentAcceptPointInput}from'./actions/get-card-payment-accept-point';import AddPaymentFormComponent from'./components/add-payment-form';import ErrorComponent from'./components/error';import PaymentInformationComponent from'./components/payment-information';import WaitingComponent from'./components/waiting';import withVisibilityObserver from'./components/with-visibility-observer';import{paymentConnectorExtraContextMessage,PaymentConnectorPostMessageType,paymentConnectorSubmitMessage}from'./payment-instrument-message';var CheckoutPaymentInstrument=/*#__PURE__*/function(_React$Component){_inherits(CheckoutPaymentInstrument,_React$Component);var _super=_createSuper(CheckoutPaymentInstrument);function CheckoutPaymentInstrument(){var _this;_classCallCheck(this,CheckoutPaymentInstrument);_this=_super.apply(this,arguments);_this.state={isFetchingPaymentConnector:true};_this.moduleClassName='ms-checkout-payment-instrument';_this.iframeRef=/*#__PURE__*/React.createRef();_this.onIFrameMessage=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(event){var _this$props$data$card;var result,paymentConnectorId,_result,type,value;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;if(!(typeof event.data!=='string')){_context.next=3;break;}return _context.abrupt(\"return\");case 3:result=JSON.parse(event.data);_context.next=10;break;case 6:_context.prev=6;_context.t0=_context[\"catch\"](0);_this.setTerminalError(_context.t0);return _context.abrupt(\"return\");case 10:paymentConnectorId=(_this$props$data$card=_this.props.data.cardPaymentAcceptPoint.result)===null||_this$props$data$card===void 0?void 0:_this$props$data$card.PaymentConnectorId;if(!(!result||!result.type||result.id!==paymentConnectorId)){_context.next=13;break;}return _context.abrupt(\"return\");case 13:_result=result,type=_result.type,value=_result.value;_context.t1=type;_context.next=_context.t1===PaymentConnectorPostMessageType.Height?17:_context.t1===PaymentConnectorPostMessageType.Result?19:_context.t1===PaymentConnectorPostMessageType.CardPrefix?21:_context.t1===PaymentConnectorPostMessageType.Error?24:_context.t1===PaymentConnectorPostMessageType.Redirect?26:_context.t1===PaymentConnectorPostMessageType.Showoverlay?28:_context.t1===PaymentConnectorPostMessageType.Hideoverlay?30:32;break;case 17:_this.setState({isFetchingPaymentConnector:false,paymentConnectorHeight:value});return _context.abrupt(\"return\");case 19:_this.handlePaymentResult(value);return _context.abrupt(\"return\");case 21:_context.next=23;return _this.handlePaymentCardPrefix(value);case 23:return _context.abrupt(\"return\");case 24:_this.handlePaymentError(value);return _context.abrupt(\"return\");case 26:_this.handlePaymentRedirect(value);return _context.abrupt(\"return\");case 28:_this.showOverlayModal(true);return _context.abrupt(\"return\");case 30:_this.showOverlayModal(false);return _context.abrupt(\"return\");case 32:return _context.abrupt(\"return\");case 33:case\"end\":return _context.stop();}}},_callee,null,[[0,6]]);}));return function(_x){return _ref.apply(this,arguments);};}();_this.handlePaymentResult=function(resultAccessCode){var _checkout$result,_cardPaymentAcceptPoi;var isRedirectedFromPaymentGateway=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var _this$props=_this.props,_this$props$data=_this$props.data,checkout=_this$props$data.checkout,cardPaymentAcceptPoint=_this$props$data.cardPaymentAcceptPoint,paymenTenderType=_this$props.config.paymenTenderType;var cartId=((_checkout$result=checkout.result)===null||_checkout$result===void 0?void 0:_checkout$result.checkoutCart.cart.Id)||'';var paymentConnectorId=(_cardPaymentAcceptPoi=cardPaymentAcceptPoint.result)===null||_cardPaymentAcceptPoi===void 0?void 0:_cardPaymentAcceptPoi.PaymentConnectorId;var settings=_objectSpread({ReturnUrl:_this.getReturnUrl()},paymentConnectorId&&{PaymentConnectorId:paymentConnectorId});retrieveCardPaymentAcceptResultAsync({callerContext:_this.props.context.actionContext},resultAccessCode,[],cartId,settings).then(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(cardPaymentAcceptResult){var _ref3,TenderLine,TokenizedPaymentCard,AdditionalContext,checkoutState,cardPrefix,cardTypeId,error,_this$props$data$chec;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_ref3=cardPaymentAcceptResult||{},TenderLine=_ref3.TenderLine,TokenizedPaymentCard=_ref3.TokenizedPaymentCard,AdditionalContext=_ref3.AdditionalContext;_context2.next=3;return _this.saveBillingAddress(TokenizedPaymentCard);case 3:if(!AdditionalContext){_context2.next=7;break;}_this.handleAdditionalContext(AdditionalContext);_context2.next=38;break;case 7:if(TokenizedPaymentCard){_context2.next=10;break;}_this.setTerminalError(new Error('No TokenizedPaymentCard found'));return _context2.abrupt(\"return\");case 10:checkoutState=_this.props.data.checkout.result;if(!checkoutState){_context2.next=38;break;}if(checkoutState.cardPrefix){_context2.next=17;break;}cardPrefix=TokenizedPaymentCard&&TokenizedPaymentCard.CardTokenInfo&&TokenizedPaymentCard.CardTokenInfo.MaskedCardNumber;if(!cardPrefix){_context2.next=17;break;}_context2.next=17;return checkoutState.updateCardPrefix({newCardPrefix:cardPrefix});case 17:if(TokenizedPaymentCard.CardTypeId){_context2.next=27;break;}_context2.next=20;return _this.getCardTypeId(checkoutState.cardPrefix||'');case 20:cardTypeId=_context2.sent;if(cardTypeId){_context2.next=26;break;}error=new Error('The specified card type is not supported.');error.name='CARDTYPENOTFOUND';_this.setTerminalError(error);return _context2.abrupt(\"return\");case 26:TokenizedPaymentCard.CardTypeId=cardTypeId;case 27:_context2.next=29;return checkoutState.updateTenderLine({newTenderLine:TenderLine});case 29:_context2.next=31;return checkoutState.updateTokenizedPaymentCard({newTokenizedPaymentCard:TokenizedPaymentCard});case 31:_context2.next=33;return checkoutState.updatePaymentTenderType({newPaymentTenderType:paymenTenderType});case 33:if(isRedirectedFromPaymentGateway){(_this$props$data$chec=_this.props.data.checkout.result)===null||_this$props$data$chec===void 0?void 0:_this$props$data$chec.checkoutCart.refreshCart({});}_this.props.moduleState.setHasError(false);_this.props.moduleState.onReady();_this.setState({terminalError:null,errorMessage:null});_this.props.moduleState.setIsSubmitContainer(true);case 38:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}())[\"catch\"](function(error){_this.updatePaymentAcceptPageData();_this.setTerminalError(error);return;})[\"finally\"](function(){_this.setState({isPaymentProcessing:false});});};_this.handlePaymentCardPrefix=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(cardPrefix){var checkoutState;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:checkoutState=_this.props.data.checkout.result;if(!checkoutState){_context3.next=4;break;}_context3.next=4;return checkoutState.updateCardPrefix({newCardPrefix:cardPrefix});case 4:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref4.apply(this,arguments);};}();_this.handlePaymentRedirect=function(redirectData){_this.setState({isPaymentVerificationRequried:true,paymentVerificationPostData:redirectData});_this.props.moduleState.setHasError(false);_this.props.moduleState.onReady();};_this.showOverlayModal=function(isShow){_this.setState({isOverlayModal:isShow});};_this.getCardTypeId=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var cardPrefix,response,_args4=arguments;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:cardPrefix=_args4.length>0&&_args4[0]!==undefined?_args4[0]:'';_context4.prev=1;_context4.next=4;return resolveCardTypesAsync({callerContext:_this.props.context.actionContext},cardPrefix,-1);case 4:response=_context4.sent;if(!(response&&response.length>0)){_context4.next=7;break;}return _context4.abrupt(\"return\",response[0].TypeId);case 7:_context4.next=12;break;case 9:_context4.prev=9;_context4.t0=_context4[\"catch\"](1);_this.props.context.telemetry.error('Call to resolveCardTypesAsync failed.',_context4.t0);case 12:return _context4.abrupt(\"return\",undefined);case 13:case\"end\":return _context4.stop();}}},_callee4,null,[[1,9]]);}));_this.redirectToPaymentVerification=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var _this$state,isPaymentVerificationRequried,paymentVerificationPostData,checkoutState,redirectInfo,url,data,form,_i,_Object$keys,propertyName,element;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_this$state=_this.state,isPaymentVerificationRequried=_this$state.isPaymentVerificationRequried,paymentVerificationPostData=_this$state.paymentVerificationPostData;if(!(!isPaymentVerificationRequried||!paymentVerificationPostData)){_context5.next=3;break;}return _context5.abrupt(\"return\");case 3:checkoutState=_this.props.data.checkout.result;if(!checkoutState){_context5.next=9;break;}_context5.next=7;return checkoutState.updatePaymentTenderType({newPaymentTenderType:_this.props.config.paymenTenderType});case 7:_context5.next=9;return checkoutState.saveDataInStorage({});case 9:redirectInfo=JSON.parse(paymentVerificationPostData);url=redirectInfo.url,data=redirectInfo.data;form=document.createElement('form');form.method='POST';form.action=url;for(_i=0,_Object$keys=Object.keys(data);_i<_Object$keys.length;_i++){propertyName=_Object$keys[_i];element=document.createElement('input');element.name=propertyName;element.value=data[propertyName];form.appendChild(element);}document.body.appendChild(form);form.submit();case 17:case\"end\":return _context5.stop();}}},_callee5);}));_this.handlePaymentError=function(value){var _this$props$resources=_this.props.resources.defaultSubmitErrorMessage,defaultSubmitErrorMessage=_this$props$resources===void 0?'An error occurred in payment method details. Please try again.':_this$props$resources;if(!value||value.length===0){_this.setErrorMessage(defaultSubmitErrorMessage);return;}_this.setErrorMessage(value.map(function(_value){return _value.Message;}).join('\\n'));};_this.getReturnUrl=function(){var returnUrl=getUrlSync('checkout',_this.props.context.actionContext)||'';var absoluteUrlRegExp=new RegExp('^(?:[a-z]+:)?//','i');var isAbsoluteUrl=absoluteUrlRegExp.test(returnUrl);if(window&&!isAbsoluteUrl){returnUrl=\"\".concat(window.location.origin).concat(returnUrl);}return\"\".concat(returnUrl).concat(returnUrl.indexOf('?')===-1?'?':'&',\"pv=1\");};_this.init=function(){_this.props.moduleState.init({onEdit:_this.onEdit,onCancel:_this.onCancel,onSubmit:_this.onSubmit,onContainerReady:_this.onContainerReady,isCancellable:false,status:_this.shouldPaidByCard?'updating':'disabled'});var _this$props2=_this.props,checkout=_this$props2.data.checkout,config=_this$props2.config;if(_this.isPaymentVerificationRedirection){var _checkout$result2;if(config.paymenTenderType===((_checkout$result2=checkout.result)===null||_checkout$result2===void 0?void 0:_checkout$result2.paymentTenderType)){var requestFormData=_this.props.context.request.requestFormData;var formData=btoa(JSON.stringify(requestFormData));_this.setState({isPaymentProcessing:true});_this.props.moduleState.onPending();_this.handlePaymentResult(formData,true);}else{_this.props.moduleState.onSkip();}}else{if(_this.asyncResultStatus==='FAILED'){_this.setState({isFetchingPaymentConnector:false});_this.setTerminalError(new Error('Failed in load data'));}}};_this.setTerminalError=function(terminalError){_this.props.telemetry.exception(terminalError);_this.props.moduleState.setHasError(true);_this.props.moduleState.onUpdating();var _this$props$resources2=_this.props.resources,genericErrorMessage=_this$props$resources2.genericErrorMessage,cardTypeErrorMessage=_this$props$resources2.cardTypeErrorMessage;var errorMessage=genericErrorMessage;switch(terminalError.name){case'CARDTYPENOTFOUND':{errorMessage=cardTypeErrorMessage;break;}default:}_this.setState({terminalError:terminalError,errorMessage:errorMessage});};_this.setErrorMessage=function(errorMessage){_this.props.telemetry.error(errorMessage);_this.props.moduleState.setHasError(true);_this.props.moduleState.onUpdating();_this.setState({errorMessage:errorMessage});};_this.updatePaymentAcceptPageData=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){var _this$props3,actionContext,_this$props3$config,showBillingAddress,paymenTenderType,apiSettings,checkout,input,checkoutState;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_this$props3=_this.props,actionContext=_this$props3.context.actionContext,_this$props3$config=_this$props3.config,showBillingAddress=_this$props3$config.showBillingAddress,paymenTenderType=_this$props3$config.paymenTenderType,apiSettings=_this$props3.context.request.apiSettings,checkout=_this$props3.data.checkout;input={showBillingAddress:showBillingAddress,paymenTenderType:paymenTenderType,apiSettings:apiSettings};_this.setState({isFetchingPaymentConnector:true});checkoutState=checkout.result;if(!checkoutState){_context6.next=11;break;}_context6.next=7;return checkoutState.updatePaymentTenderType({newPaymentTenderType:undefined});case 7:_context6.next=9;return checkoutState.updateTenderLine({newTenderLine:undefined});case 9:_context6.next=11;return checkoutState.updateTokenizedPaymentCard({newTokenizedPaymentCard:undefined});case 11:getCardPaymentAcceptPointAction(new GetCardPaymentAcceptPointInput(input),actionContext).then(function(paymentAcceptPoint){actionContext.update(new GetCardPaymentAcceptPointInput(input),{AcceptPageContent:'',AcceptPageUrl:''});actionContext.update(new GetCardPaymentAcceptPointInput(input),paymentAcceptPoint);_this.setState({paymentConnectorId:paymentAcceptPoint.PaymentConnectorId});})[\"catch\"](function(error){_this.setTerminalError(error);_this.setState({isFetchingPaymentConnector:false});actionContext.update(new GetCardPaymentAcceptPointInput(input),{AcceptPageContent:'',AcceptPageUrl:''});});case 12:case\"end\":return _context6.stop();}}},_callee6);}));_this.postMessageToIframe=function(message){var postMessage=_get(_this.iframeRef,'current.postMessage');if(postMessage){_this.props.moduleState.onPending();postMessage(message);}};_this.handleAdditionalContext=function(additionalContext){var message=paymentConnectorExtraContextMessage(additionalContext);_this.postMessageToIframe(message);};_this.saveBillingAddress=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(tokenizedPaymentCard){var showBillingAddress,checkoutState,billingAddress;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:showBillingAddress=_this.props.config.showBillingAddress;checkoutState=_this.props.data.checkout.result;if(!(checkoutState&&showBillingAddress&&tokenizedPaymentCard&&tokenizedPaymentCard.Zip)){_context7.next=6;break;}billingAddress={ThreeLetterISORegionName:tokenizedPaymentCard.Country,Name:tokenizedPaymentCard.House==='N/A'?'':tokenizedPaymentCard.House,Street:tokenizedPaymentCard.Address1,StreetNumber:tokenizedPaymentCard.Address2,City:tokenizedPaymentCard.City,State:tokenizedPaymentCard.State,ZipCode:tokenizedPaymentCard.Zip,Phone:tokenizedPaymentCard.Phone};_context7.next=6;return checkoutState.updateBillingAddress({newBillingAddress:billingAddress});case 6:case\"end\":return _context7.stop();}}},_callee7);}));return function(_x4){return _ref8.apply(this,arguments);};}();_this.togglePayment=function(){if(_this.shouldPaidByCard&&_this.props.moduleState.isDisabled){_this.props.moduleState.onUpdating();}else if(!_this.shouldPaidByCard&&!_this.props.moduleState.isDisabled){_this.props.moduleState.setHasError(false);_this.props.moduleState.onDisable();}};_this.onSubmit=function(){var _this$props$config$is=_this.props.config.isPrimaryPayment,isPrimaryPayment=_this$props$config$is===void 0?true:_this$props$config$is;if(isPrimaryPayment){_this.postMessageToIframe(paymentConnectorSubmitMessage());}else{_this.props.moduleState.onSkip();}};_this.onCancel=function(){if(_this.hasSelectedItem){_this.props.moduleState.onReady();}else{_this.props.moduleState.onUpdating();}};_this.onEdit=function(){_this.props.moduleState.onUpdating();_this.updatePaymentAcceptPageData();};_this.onContainerReady=function(){_this.redirectToPaymentVerification();_this.props.moduleState.setIsSubmitContainer(false);};return _this;}_createClass(CheckoutPaymentInstrument,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;when(function(){return _this2.asyncResultStatus!=='LOADING';},function(){_this2.init();});reaction(function(){return _this2.asyncResultStatus!=='FAILED'&&_this2.shouldPaidByCard;},function(){_this2.togglePayment();});}},{key:\"render\",value:function render(){var _this$state2=this.state,errorMessage=_this$state2.errorMessage,isFetchingPaymentConnector=_this$state2.isFetchingPaymentConnector,paymentConnectorHeight=_this$state2.paymentConnectorHeight,isPaymentVerificationRequried=_this$state2.isPaymentVerificationRequried,isPaymentProcessing=_this$state2.isPaymentProcessing,isOverlayModal=_this$state2.isOverlayModal;var _this$props4=this.props,_this$props4$moduleSt=_this$props4.moduleState,isReady=_this$props4$moduleSt.isReady,hasError=_this$props4$moduleSt.hasError,hasInitialized=_this$props4$moduleSt.hasInitialized,isPending=_this$props4$moduleSt.isPending,hasExternalSubmitGroup=_this$props4$moduleSt.hasExternalSubmitGroup,_this$props4$config=_this$props4.config,iFrameHeightOverride=_this$props4$config.iFrameHeightOverride,paymentStyleOverride=_this$props4$config.paymentStyleOverride,className=_this$props4$config.className,showBillingAddress=_this$props4$config.showBillingAddress,resources=_this$props4.resources,_this$props4$data=_this$props4.data,checkout=_this$props4$data.checkout,cardPaymentAcceptPoint=_this$props4$data.cardPaymentAcceptPoint,visibilityObserver=_this$props4.visibilityObserver;var isVisible=visibilityObserver&&visibilityObserver.isVisible;if(!hasInitialized||this.asyncResultStatus!=='FAILED'&&!this.shouldPaidByCard){this.props.context.telemetry.error('Checkout payment content is empty, module wont render');return null;}var _ref9=cardPaymentAcceptPoint.result||{AcceptPageUrl:undefined,AcceptPageContent:undefined,MessageOrigin:undefined},AcceptPageUrl=_ref9.AcceptPageUrl,AcceptPageContent=_ref9.AcceptPageContent,MessageOrigin=_ref9.MessageOrigin;var _ref10=checkout.result||{tokenizedPaymentCard:undefined,tenderLine:undefined,billingAddress:undefined},tokenizedPaymentCard=_ref10.tokenizedPaymentCard,tenderLine=_ref10.tenderLine,billingAddress=_ref10.billingAddress;var viewProps=_objectSpread(_objectSpread(_objectSpread({},this.props),this.state),{},{isVisible:isVisible,className:className,checkoutPaymentInstrument:{moduleProps:this.props,className:classnames(this.moduleClassName,className)},waiting:!isReady&&this.asyncResultStatus!=='FAILED'&&(this.asyncResultStatus==='LOADING'||isFetchingPaymentConnector||isPending)&&/*#__PURE__*/React.createElement(WaitingComponent,Object.assign({},{message:resources.loadingMessage})),alert:hasError&&errorMessage&&/*#__PURE__*/React.createElement(ErrorComponent,Object.assign({},{title:resources.errorMessageTitle,message:errorMessage})),paymentInformation:isReady&&!isPaymentVerificationRequried&&!isPaymentProcessing&&/*#__PURE__*/React.createElement(PaymentInformationComponent,{tokenizedPaymentCard:tokenizedPaymentCard,tenderLine:tenderLine,billingAddress:showBillingAddress?billingAddress:undefined,canEdit:!hasExternalSubmitGroup,onEdit:this.onEdit,resources:resources}),addPaymentForm:(!isReady||isPaymentVerificationRequried)&&!isPaymentProcessing&&(AcceptPageUrl||AcceptPageContent)&&isVisible&&/*#__PURE__*/React.createElement(AddPaymentFormComponent,{acceptPageUrl:AcceptPageUrl,acceptPageContent:AcceptPageContent,messageOrigin:MessageOrigin,onSubmit:this.onSubmit,onCancel:this.onCancel,onIFrameMessage:this.onIFrameMessage,iframeRef:this.iframeRef,canSubmit:!hasExternalSubmitGroup,canCancel:!hasExternalSubmitGroup&&this.hasSelectedItem,iFrameHeightOverride:iFrameHeightOverride||paymentConnectorHeight,requestUrlOrigin:this.requestUrlOrigin,isFetchingPaymentConnector:isFetchingPaymentConnector,paymentStyleOverride:paymentStyleOverride,resources:resources}),overlayModal:{modal:{tag:Modal,className:\"\".concat(this.moduleClassName,\"__overlay-modal\"),isOpen:isOverlayModal}}});return this.props.renderView(viewProps);}},{key:\"getLoyaltyAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;return checkoutState&&checkoutState.loyaltyAmount?checkoutState.loyaltyAmount:0;}},{key:\"getCustomerAccountAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;return checkoutState&&checkoutState.customerAccountAmount?checkoutState.customerAccountAmount:0;}},{key:\"getGiftCardTotalAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;if(!checkoutState||!checkoutState.giftCardExtends){return 0;}return checkoutState.giftCardExtends.reduce(function(count,giftCard){var balance=giftCard.Balance||0;return count+balance;},0);}},{key:\"shouldPaidByCard\",get:function get(){var _this$props5=this.props,checkout=_this$props5.data.checkout,config=_this$props5.config;if(!checkout.result){return false;}var checkoutResult=checkout.result;var cart=checkoutResult.checkoutCart.cart;if(!cart||!cart.CartLines||!cart.CartLines.length){return false;}var paymentTenderType=checkoutResult.paymentTenderType,tokenizedPaymentCard=checkoutResult.tokenizedPaymentCard;var isPaidByOtherPaymentSource=config.paymenTenderType!==paymentTenderType&&tokenizedPaymentCard;var amountDue=(cart.TotalAmount||0)-this.getGiftCardTotalAmount-this.getLoyaltyAmount-this.getCustomerAccountAmount;return amountDue>0&&!isPaidByOtherPaymentSource;}},{key:\"isCartContainsItemsForShipping\",get:function get(){var pickupDeliveryModeCode=_get(this.props,'context.request.channel.PickupDeliveryModeCode');return(_get(this.props,'data.checkout.result.checkoutCart.cart.CartLines')||[]).some(function(cartLine){return cartLine.DeliveryMode!==pickupDeliveryModeCode;});}},{key:\"isCartHasSelectedDeliveryMethods\",get:function get(){return(_get(this.props,'data.checkout.result.checkoutCart.cart.CartLines')||[]).every(function(cartLine){return!!cartLine.DeliveryMode;});}},{key:\"asyncResultStatus\",get:function get(){var isLoading=Object.values(this.props.data).some(function(data){return _get(data,'status')==='LOADING';});if(isLoading){return'LOADING';}var isSuccess=Object.values(this.props.data).every(function(data){return _get(data,'status')==='SUCCESS';});if(isSuccess){return'SUCCESS';}var isFailed=Object.values(this.props.data).some(function(data){return _get(data,'status')==='FAILED';});if(isFailed){return'FAILED';}return;}},{key:\"hasSelectedItem\",get:function get(){return!!_get(this.props.data,'checkoutState.result.tokenizedPaymentCard');}},{key:\"isPaymentVerificationRedirection\",get:function get(){var _this$props$context$r=this.props.context.request,requestFormData=_this$props$context$r.requestFormData,query=_this$props$context$r.query;return requestFormData&&query&&query.pv==='1'?true:false;}},{key:\"requestUrlOrigin\",get:function get(){var origin=_get(window,'location.origin');var requestUrl=typeof _get(this.props,'context.request.url.requestUrl')==='string'?new URL(_get(this.props,'context.request.url.requestUrl')):_get(this.props,'context.request.url.requestUrl');return origin||requestUrl.origin;}}]);return CheckoutPaymentInstrument;}(React.Component);__decorate([computed],CheckoutPaymentInstrument.prototype,\"getLoyaltyAmount\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"getCustomerAccountAmount\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"getGiftCardTotalAmount\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"shouldPaidByCard\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"isCartContainsItemsForShipping\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"isCartHasSelectedDeliveryMethods\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"asyncResultStatus\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"hasSelectedItem\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"isPaymentVerificationRedirection\",null);__decorate([computed],CheckoutPaymentInstrument.prototype,\"requestUrlOrigin\",null);__decorate([action],CheckoutPaymentInstrument.prototype,\"handlePaymentResult\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"handlePaymentCardPrefix\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"handlePaymentRedirect\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"init\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"setTerminalError\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"setErrorMessage\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"togglePayment\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"onSubmit\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"onCancel\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"onEdit\",void 0);__decorate([action],CheckoutPaymentInstrument.prototype,\"onContainerReady\",void 0);CheckoutPaymentInstrument=__decorate([withModuleState,observer],CheckoutPaymentInstrument);export{CheckoutPaymentInstrument};export default withVisibilityObserver(CheckoutPaymentInstrument);","map":{"version":3,"sources":["modules/checkout-payment-instrument/checkout-payment-instrument.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport classnames from 'classnames';\nimport get from 'lodash/get';\nimport { action, computed, reaction, when } from 'mobx';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\n\nimport { IModuleStateProps, withModuleState } from '@msdyn365-commerce-modules/checkout-utilities';\nimport { IModuleProps, INodeProps, Modal } from '@msdyn365-commerce-modules/utilities';\nimport { AsyncResultStatus, getUrlSync } from '@msdyn365-commerce/core';\nimport { IGiftCardExtend } from '@msdyn365-commerce/global-state';\nimport {\n    retrieveCardPaymentAcceptResultAsync\n} from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';\nimport {\n    resolveCardTypesAsync\n} from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport {\n    Address, CardType, CartLine, TokenizedPaymentCard\n} from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\n\nimport getCardPaymentAcceptPointAction, {\n    GetCardPaymentAcceptPointInput\n} from './actions/get-card-payment-accept-point';\nimport { ICheckoutPaymentInstrumentData } from './checkout-payment-instrument.data';\nimport { ICheckoutPaymentInstrumentProps } from './checkout-payment-instrument.props.autogenerated';\nimport AddPaymentFormComponent from './components/add-payment-form';\nimport ErrorComponent from './components/error';\nimport Iframe from './components/iframe';\nimport PaymentInformationComponent from './components/payment-information';\nimport WaitingComponent from './components/waiting';\nimport withVisibilityObserver, {\n    IVisibilyObserverProps\n} from './components/with-visibility-observer';\nimport {\n    paymentConnectorExtraContextMessage, PaymentConnectorPostMessageType,\n    paymentConnectorSubmitMessage\n} from './payment-instrument-message';\n\nexport interface ICheckoutPaymentInstrumentModuleProps extends ICheckoutPaymentInstrumentProps<ICheckoutPaymentInstrumentData>, IModuleStateProps, IVisibilyObserverProps { }\n\ninterface ICheckoutPaymentInstrumentState {\n    errorMessage?: string;\n    isFetchingPaymentConnector?: boolean;\n    paymentConnectorHeight?: number;\n    isPaymentVerificationRequried?: boolean;\n    paymentVerificationPostData?: string;\n    isPaymentProcessing?: boolean;\n    isOverlayModal?: boolean;\n}\n\nexport interface ICheckoutPaymentOverlayModal {\n    modal: INodeProps;\n}\n\nexport interface ICheckoutPaymentInstrumentViewProps extends ICheckoutPaymentInstrumentProps<{}>, ICheckoutPaymentInstrumentState {\n    className?: string;\n    checkoutPaymentInstrument: IModuleProps;\n    waiting?: React.ReactNode;\n    alert?: React.ReactNode;\n    paymentInformation?: React.ReactNode;\n    addPaymentForm?: React.ReactNode;\n    overlayModal?: ICheckoutPaymentOverlayModal;\n    isVisible?: boolean;\n}\n\n/**\n *\n * CheckoutPaymentInstrument component\n * @extends {React.Component<ICheckoutPaymentInstrumentProps<ICheckoutPaymentInstrumentData>>}\n */\n// @ts-ignore\n@withModuleState\n@observer\nexport class CheckoutPaymentInstrument extends React.Component<ICheckoutPaymentInstrumentModuleProps> {\n\n    @computed get getLoyaltyAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        return checkoutState && checkoutState.loyaltyAmount ? checkoutState.loyaltyAmount : 0;\n    }\n\n    @computed get getCustomerAccountAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        return checkoutState && checkoutState.customerAccountAmount ? checkoutState.customerAccountAmount : 0;\n    }\n\n    @computed get getGiftCardTotalAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        if (!checkoutState || !checkoutState.giftCardExtends) {\n            return 0;\n        }\n        return checkoutState.giftCardExtends.reduce((count: number, giftCard: IGiftCardExtend) => {\n            const balance: number = giftCard.Balance || 0;\n            return count + balance;\n            // tslint:disable-next-line:align\n        }, 0);\n    }\n\n    @computed get shouldPaidByCard(): boolean {\n        const {\n            data: {\n                checkout\n            },\n            config\n        } = this.props;\n        if (!checkout.result) {\n            return false;\n        }\n\n        const checkoutResult = checkout.result;\n        const cart = checkoutResult.checkoutCart.cart;\n        if (!cart || !cart.CartLines || !cart.CartLines.length) {\n            return false;\n        }\n\n        const { paymentTenderType, tokenizedPaymentCard } = checkoutResult;\n        const isPaidByOtherPaymentSource = config.paymenTenderType !== paymentTenderType && tokenizedPaymentCard;\n\n        // Use the card for payment after all other payment methods\n        const amountDue = (cart.TotalAmount || 0) - this.getGiftCardTotalAmount - this.getLoyaltyAmount - this.getCustomerAccountAmount;\n\n        return amountDue > 0 && !isPaidByOtherPaymentSource;\n    }\n\n    @computed get isCartContainsItemsForShipping(): boolean {\n        const pickupDeliveryModeCode = get(this.props, 'context.request.channel.PickupDeliveryModeCode');\n        return (get(this.props, 'data.checkout.result.checkoutCart.cart.CartLines') || []).some(\n            (cartLine: CartLine) => cartLine.DeliveryMode !== pickupDeliveryModeCode\n        );\n    }\n\n    @computed get isCartHasSelectedDeliveryMethods(): boolean {\n        return (get(this.props, 'data.checkout.result.checkoutCart.cart.CartLines') || []).every(\n            (cartLine: CartLine) => !!cartLine.DeliveryMode\n        );\n    }\n\n    @computed get asyncResultStatus(): AsyncResultStatus | undefined {\n        const isLoading = Object.values(this.props.data).some(data => get(data, 'status') === 'LOADING');\n        if (isLoading) {\n            return 'LOADING';\n        }\n\n        const isSuccess = Object.values(this.props.data).every(data => get(data, 'status') === 'SUCCESS');\n        if (isSuccess) {\n            return 'SUCCESS';\n        }\n\n        const isFailed = Object.values(this.props.data).some(data => get(data, 'status') === 'FAILED');\n        if (isFailed) {\n            return 'FAILED';\n        }\n\n        return;\n    }\n\n    @computed get hasSelectedItem(): boolean {\n        return !!get(this.props.data, 'checkoutState.result.tokenizedPaymentCard');\n    }\n\n    @computed get isPaymentVerificationRedirection(): boolean {\n        const { requestFormData, query } = this.props.context.request;\n        return (requestFormData && query && query.pv === '1') ? true : false;\n    }\n\n    @computed get requestUrlOrigin(): string {\n        const origin = get(window, 'location.origin');\n        const requestUrl =\n            typeof get(this.props, 'context.request.url.requestUrl') === 'string'\n                ? new URL(get(this.props, 'context.request.url.requestUrl'))\n                : get(this.props, 'context.request.url.requestUrl');\n        return origin || requestUrl.origin;\n    }\n\n    public state: ICheckoutPaymentInstrumentState = {\n        isFetchingPaymentConnector: true\n    };\n\n    private moduleClassName: string = 'ms-checkout-payment-instrument';\n    private iframeRef: React.RefObject<Iframe> = React.createRef();\n\n    public componentDidMount(): void {\n        // @ts-ignore: Compiler not reconizing condition check for function params\n        when(\n            () => this.asyncResultStatus !== 'LOADING',\n            () => {\n                this.init();\n            }\n        );\n\n        // @ts-ignore: Compiler not reconizing condition check for function params\n        reaction(\n            () => this.asyncResultStatus !== 'FAILED' && this.shouldPaidByCard,\n            () => {\n                this.togglePayment();\n            }\n        );\n    }\n\n    // tslint:disable-next-line:cyclomatic-complexity\n    public render(): JSX.Element | null {\n        const { errorMessage, isFetchingPaymentConnector, paymentConnectorHeight, isPaymentVerificationRequried, isPaymentProcessing, isOverlayModal } = this.state;\n        const {\n            moduleState: { isReady, hasError, hasInitialized, isPending, hasExternalSubmitGroup },\n            config: { iFrameHeightOverride, paymentStyleOverride, className, showBillingAddress },\n            resources,\n            data: { checkout, cardPaymentAcceptPoint },\n            visibilityObserver\n        } = this.props;\n\n        const isVisible = visibilityObserver && visibilityObserver.isVisible;\n\n        if (!hasInitialized || (this.asyncResultStatus !== 'FAILED' && !this.shouldPaidByCard)) {\n            this.props.context.telemetry.error('Checkout payment content is empty, module wont render');\n            return null;\n        }\n\n        const { AcceptPageUrl, AcceptPageContent, MessageOrigin } = cardPaymentAcceptPoint.result || {\n            AcceptPageUrl: undefined,\n            AcceptPageContent: undefined,\n            MessageOrigin: undefined\n        };\n\n        const { tokenizedPaymentCard, tenderLine, billingAddress } = checkout.result || {\n            tokenizedPaymentCard: undefined,\n            tenderLine: undefined,\n            billingAddress: undefined\n        };\n\n        const viewProps: ICheckoutPaymentInstrumentViewProps = {\n            ...this.props,\n            ...this.state,\n            isVisible,\n            className,\n\n            checkoutPaymentInstrument: {\n                moduleProps: this.props,\n                className: classnames(this.moduleClassName, className)\n            },\n            waiting: !isReady && this.asyncResultStatus !== 'FAILED' && (this.asyncResultStatus === 'LOADING' || isFetchingPaymentConnector || isPending) && (\n                <WaitingComponent {...{ message: resources.loadingMessage }} />\n            ),\n            alert: hasError && errorMessage && <ErrorComponent {...{ title: resources.errorMessageTitle, message: errorMessage }} />,\n            paymentInformation: isReady && !isPaymentVerificationRequried && !isPaymentProcessing && (\n                <PaymentInformationComponent\n                    tokenizedPaymentCard={tokenizedPaymentCard}\n                    tenderLine={tenderLine}\n                    billingAddress={showBillingAddress ? billingAddress : undefined}\n                    canEdit={!hasExternalSubmitGroup}\n                    onEdit={this.onEdit}\n                    resources={resources}\n                />\n            ),\n            addPaymentForm: (!isReady || isPaymentVerificationRequried) && !isPaymentProcessing && (AcceptPageUrl || AcceptPageContent) && isVisible && (\n                <AddPaymentFormComponent\n                    acceptPageUrl={AcceptPageUrl}\n                    acceptPageContent={AcceptPageContent}\n                    messageOrigin={MessageOrigin}\n                    onSubmit={this.onSubmit}\n                    onCancel={this.onCancel}\n                    onIFrameMessage={this.onIFrameMessage}\n                    iframeRef={this.iframeRef}\n                    canSubmit={!hasExternalSubmitGroup}\n                    canCancel={!hasExternalSubmitGroup && this.hasSelectedItem}\n                    iFrameHeightOverride={iFrameHeightOverride || paymentConnectorHeight}\n                    requestUrlOrigin={this.requestUrlOrigin}\n                    isFetchingPaymentConnector={isFetchingPaymentConnector}\n                    paymentStyleOverride={paymentStyleOverride}\n                    resources={resources}\n                />\n            ),\n            overlayModal: {\n                modal: {\n                    tag: Modal,\n                    className: `${this.moduleClassName}__overlay-modal`,\n                    isOpen: isOverlayModal\n                }\n            }\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    private onIFrameMessage = async (event: MessageEvent): Promise<void> => {\n        let result;\n        try {\n            if (typeof event.data !== 'string') {\n                return;\n            }\n            result = JSON.parse(event.data);\n        } catch (error) {\n            this.setTerminalError(error);\n            return;\n        }\n\n        const paymentConnectorId = this.props.data.cardPaymentAcceptPoint.result?.PaymentConnectorId;\n        if (!result || !result.type || result.id !== paymentConnectorId) {\n            return;\n        }\n\n        const { type, value } = result;\n\n        switch (type) {\n            case PaymentConnectorPostMessageType.Height:\n                // The payment connector will post height after it completes initialization\n                this.setState({\n                    isFetchingPaymentConnector: false,\n                    paymentConnectorHeight: value\n                });\n                return;\n            case PaymentConnectorPostMessageType.Result:\n                this.handlePaymentResult(value);\n                return;\n            case PaymentConnectorPostMessageType.CardPrefix:\n                await this.handlePaymentCardPrefix(value);\n                return;\n            case PaymentConnectorPostMessageType.Error:\n                this.handlePaymentError(value);\n                return;\n            case PaymentConnectorPostMessageType.Redirect:\n                this.handlePaymentRedirect(value);\n                return;\n            case PaymentConnectorPostMessageType.Showoverlay:\n                this.showOverlayModal(true);\n                return;\n            case PaymentConnectorPostMessageType.Hideoverlay:\n                this.showOverlayModal(false);\n                return;\n            default:\n                // Do nothing\n                return;\n        }\n    };\n\n    @action\n    private handlePaymentResult = (resultAccessCode: string, isRedirectedFromPaymentGateway: boolean = false): void => {\n        const {\n            data: {\n                checkout,\n                cardPaymentAcceptPoint\n            },\n            config: {\n                paymenTenderType\n            }\n        } = this.props;\n\n        const cartId = checkout.result?.checkoutCart.cart.Id || '';\n        const paymentConnectorId = cardPaymentAcceptPoint.result?.PaymentConnectorId;\n\n        const settings = {\n            ReturnUrl: this.getReturnUrl(),\n            ...(paymentConnectorId && { PaymentConnectorId: paymentConnectorId }),\n        };\n\n        retrieveCardPaymentAcceptResultAsync({ callerContext: this.props.context.actionContext }, resultAccessCode, [], cartId, settings)\n            .then(async cardPaymentAcceptResult => {\n                // tslint:disable-next-line:no-shadowed-variable\n                const { TenderLine, TokenizedPaymentCard, AdditionalContext } = cardPaymentAcceptResult || {};\n\n                await this.saveBillingAddress(TokenizedPaymentCard);\n\n                if (AdditionalContext) {\n                    this.handleAdditionalContext(AdditionalContext);\n                } else {\n                    if (!TokenizedPaymentCard) {\n                        this.setTerminalError(new Error('No TokenizedPaymentCard found'));\n                        return;\n                    }\n                    const checkoutState = this.props.data.checkout.result;\n                    if (checkoutState) {\n                        // Try to update card prefix, if it is not set already.\n                        // Adyen connector does not send msax-cc-cardprefix message\n                        // but it sets the card prefix in tokenized card\n                        if (!checkoutState.cardPrefix) {\n                            const cardPrefix =\n                                TokenizedPaymentCard &&\n                                TokenizedPaymentCard.CardTokenInfo &&\n                                TokenizedPaymentCard.CardTokenInfo.MaskedCardNumber;\n                            if (cardPrefix) {\n                                await checkoutState.updateCardPrefix({ newCardPrefix: cardPrefix });\n                            }\n                        }\n\n                        if (!TokenizedPaymentCard.CardTypeId) {\n                            const cardTypeId = await this.getCardTypeId(checkoutState.cardPrefix || '');\n                            if (!cardTypeId) {\n                                const error = new Error('The specified card type is not supported.');\n                                error.name = 'CARDTYPENOTFOUND';\n                                this.setTerminalError(error);\n                                return;\n                            }\n\n                            TokenizedPaymentCard.CardTypeId = cardTypeId;\n                        }\n\n                        await checkoutState.updateTenderLine({ newTenderLine: TenderLine });\n                        await checkoutState.updateTokenizedPaymentCard({ newTokenizedPaymentCard: TokenizedPaymentCard });\n                        await checkoutState.updatePaymentTenderType({ newPaymentTenderType: paymenTenderType });\n\n                        // In case of PSD2 redirect, cart we be updated in server side so refresh cart.\n                        if (isRedirectedFromPaymentGateway) {\n                            this.props.data.checkout.result?.checkoutCart.refreshCart({});\n                        }\n\n                        this.props.moduleState.setHasError(false);\n                        this.props.moduleState.onReady();\n                        this.setState({\n                            terminalError: null,\n                            errorMessage: null\n                        });\n                        this.props.moduleState.setIsSubmitContainer(true);\n                    }\n                }\n            })\n            .catch(error => {\n                // IMPORTANT: Call RS for getting a new payment session. It should not re-use the previous session for the security reason.\n                // tslint:disable-next-line:no-floating-promises\n                this.updatePaymentAcceptPageData();\n                this.setTerminalError(error);\n                return;\n            })\n            .finally(() => {\n                this.setState({\n                    isPaymentProcessing: false\n                });\n            });\n    };\n\n    @action\n    private handlePaymentCardPrefix = async (cardPrefix: string): Promise<void> => {\n        const checkoutState = this.props.data.checkout.result;\n        if (checkoutState) {\n            await checkoutState.updateCardPrefix({ newCardPrefix: cardPrefix });\n        }\n    };\n\n    @action\n    private handlePaymentRedirect = (redirectData: string): void => {\n        this.setState({\n            isPaymentVerificationRequried: true,\n            paymentVerificationPostData: redirectData\n        });\n        this.props.moduleState.setHasError(false);\n        this.props.moduleState.onReady();\n    };\n\n    private showOverlayModal = (isShow: boolean): void => {\n        this.setState({ isOverlayModal: isShow });\n    };\n\n    private getCardTypeId = async (cardPrefix: string = ''): Promise<string | undefined> => {\n        try {\n            const response = await resolveCardTypesAsync({ callerContext: this.props.context.actionContext }, cardPrefix, CardType.Unknown);\n            if (response && response.length > 0) {\n                return response[0].TypeId;\n            }\n        } catch (error) {\n            this.props.context.telemetry.error('Call to resolveCardTypesAsync failed.', error);\n        }\n        return undefined;\n    };\n\n    private redirectToPaymentVerification = async (): Promise<void> => {\n        const { isPaymentVerificationRequried, paymentVerificationPostData } = this.state;\n        if (!isPaymentVerificationRequried || !paymentVerificationPostData) {\n            return;\n        }\n\n        const checkoutState = this.props.data.checkout.result;\n        if (checkoutState) {\n            await checkoutState.updatePaymentTenderType({ newPaymentTenderType: this.props.config.paymenTenderType });\n            await checkoutState.saveDataInStorage({});\n        }\n\n        const redirectInfo = JSON.parse(paymentVerificationPostData);\n        const { url, data } = redirectInfo;\n        const form = document.createElement('form');\n\n        form.method = 'POST';\n        form.action = url;\n\n        for (const propertyName of Object.keys(data)) {\n            const element = document.createElement('input');\n            element.name = propertyName;\n            element.value = data[propertyName];\n            form.appendChild(element);\n        }\n\n        document.body.appendChild(form);\n        form.submit();\n    };\n\n    private handlePaymentError = (value?: { Message: string }[]): void => {\n        const {\n            resources: { defaultSubmitErrorMessage = 'An error occurred in payment method details. Please try again.' }\n        } = this.props;\n        if (!value || value.length === 0) {\n            // Fallback, if no message could be translated from payement accept page response\n            this.setErrorMessage(defaultSubmitErrorMessage);\n            return;\n        }\n        this.setErrorMessage(value.map((_value: { Message: string }) => _value.Message).join('\\n'));\n    };\n\n    private getReturnUrl = (): string => {\n        let returnUrl = getUrlSync('checkout', this.props.context.actionContext) || '';\n\n        const absoluteUrlRegExp = new RegExp('^(?:[a-z]+:)?//', 'i');\n        const isAbsoluteUrl = absoluteUrlRegExp.test(returnUrl);\n        if (window && !isAbsoluteUrl) {\n            returnUrl = `${window.location.origin}${returnUrl}`;\n        }\n\n        return `${returnUrl}${returnUrl.indexOf('?') === -1 ? '?' : '&'}pv=1`;\n    }\n\n    @action\n    private init = (): void => {\n        this.props.moduleState.init({\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n            onContainerReady: this.onContainerReady,\n            isCancellable: false,\n            status: this.shouldPaidByCard ? 'updating' : 'disabled'\n        });\n\n        const {\n            data: {\n                checkout\n            },\n            config\n        } = this.props;\n\n        if (this.isPaymentVerificationRedirection) {\n            if (config.paymenTenderType === checkout.result?.paymentTenderType) {\n                const { requestFormData } = this.props.context.request;\n\n                const formData = btoa(JSON.stringify(requestFormData));\n\n                this.setState({\n                    isPaymentProcessing: true\n                });\n\n                this.props.moduleState.onPending();\n                this.handlePaymentResult(formData, true);\n            } else {\n                this.props.moduleState.onSkip();\n            }\n        } else {\n            if (this.asyncResultStatus === 'FAILED') {\n                this.setState({\n                    isFetchingPaymentConnector: false\n                });\n                this.setTerminalError(new Error('Failed in load data'));\n            }\n        }\n    }\n\n    @action\n    private setTerminalError = (terminalError: Error): void => {\n        this.props.telemetry.exception(terminalError);\n        this.props.moduleState.setHasError(true);\n        this.props.moduleState.onUpdating();\n        const {\n            resources: { genericErrorMessage, cardTypeErrorMessage }\n        } = this.props;\n        let errorMessage = genericErrorMessage;\n\n        switch (terminalError.name) {\n            case 'CARDTYPENOTFOUND': {\n                errorMessage = cardTypeErrorMessage;\n                break;\n            }\n            default:\n        }\n\n        this.setState({\n            terminalError,\n            errorMessage: errorMessage\n        });\n    };\n\n    @action\n    private setErrorMessage = (errorMessage: string): void => {\n        this.props.telemetry.error(errorMessage);\n        this.props.moduleState.setHasError(true);\n        this.props.moduleState.onUpdating();\n        this.setState({\n            errorMessage\n        });\n    };\n\n    private updatePaymentAcceptPageData = async (): Promise<void> => {\n        const {\n            context: { actionContext },\n            config: { showBillingAddress, paymenTenderType },\n            context: { request: { apiSettings } },\n            data: { checkout }\n        } = this.props;\n\n        const input = {\n            showBillingAddress: showBillingAddress,\n            paymenTenderType: paymenTenderType,\n            apiSettings: apiSettings\n        };\n\n        this.setState({\n            isFetchingPaymentConnector: true\n        });\n\n        const checkoutState = checkout.result;\n        if (checkoutState) {\n            await checkoutState.updatePaymentTenderType({ newPaymentTenderType: undefined });\n            await checkoutState.updateTenderLine({ newTenderLine: undefined });\n            await checkoutState.updateTokenizedPaymentCard({ newTokenizedPaymentCard: undefined });\n        }\n\n        getCardPaymentAcceptPointAction(new GetCardPaymentAcceptPointInput(input), actionContext)\n            .then(paymentAcceptPoint => {\n                // In case, add form is not hidden. We need to explicty reset value to force re-rendering.\n                actionContext.update(new GetCardPaymentAcceptPointInput(input), { AcceptPageContent: '', AcceptPageUrl: '' });\n\n                // IMPORTANT: Do NOT set isFetchingPaymentConnector = false in getCardPaymentAcceptPointAction success response.\n                // The payment connector will post a message with content height when payment is ready.\n                actionContext.update(new GetCardPaymentAcceptPointInput(input), paymentAcceptPoint);\n                this.setState({ paymentConnectorId: paymentAcceptPoint.PaymentConnectorId });\n            })\n            .catch((error: Error) => {\n                this.setTerminalError(error);\n\n                this.setState({\n                    isFetchingPaymentConnector: false\n                });\n                // IMPORTANT: Clear the AcceptPageUrl and AcceptPageContent. It should not re-use the previous session for the security reason.\n                actionContext.update(new GetCardPaymentAcceptPointInput(input), { AcceptPageContent: '', AcceptPageUrl: '' });\n            });\n    };\n\n    private postMessageToIframe = (message: object) => {\n        const postMessage = get(this.iframeRef, 'current.postMessage');\n        if (postMessage) {\n            this.props.moduleState.onPending();\n            postMessage(message);\n        }\n    }\n\n    private handleAdditionalContext = (additionalContext: string): void => {\n        const message = paymentConnectorExtraContextMessage(additionalContext);\n        this.postMessageToIframe(message);\n    };\n\n    private saveBillingAddress = async (tokenizedPaymentCard?: TokenizedPaymentCard): Promise<void> => {\n        const { showBillingAddress } = this.props.config;\n        const checkoutState = this.props.data.checkout.result;\n        // If we use billing address provided by adyen, billing address returned in TokenizedPaymentCard.\n        if (checkoutState && showBillingAddress && tokenizedPaymentCard && tokenizedPaymentCard.Zip) {\n            const billingAddress: Address = {\n                ThreeLetterISORegionName: tokenizedPaymentCard.Country,\n                Name: tokenizedPaymentCard.House === 'N/A' ? '' : tokenizedPaymentCard.House,\n                Street: tokenizedPaymentCard.Address1,\n                StreetNumber: tokenizedPaymentCard.Address2,\n                City: tokenizedPaymentCard.City,\n                State: tokenizedPaymentCard.State,\n                ZipCode: tokenizedPaymentCard.Zip,\n                Phone: tokenizedPaymentCard.Phone\n            };\n            await checkoutState.updateBillingAddress({ newBillingAddress: billingAddress });\n        }\n    };\n\n    @action\n    private togglePayment = () => {\n        if (this.shouldPaidByCard && this.props.moduleState.isDisabled) {\n            this.props.moduleState.onUpdating();\n        } else if (!this.shouldPaidByCard && !this.props.moduleState.isDisabled) {\n            this.props.moduleState.setHasError(false);\n            this.props.moduleState.onDisable();\n        }\n    };\n\n    @action\n    private onSubmit = (): void => {\n        const { isPrimaryPayment = true } = this.props.config;\n        if (isPrimaryPayment) {\n            this.postMessageToIframe(paymentConnectorSubmitMessage());\n        } else {\n            this.props.moduleState.onSkip();\n        }\n    };\n\n    @action\n    private onCancel = (): void => {\n        if (this.hasSelectedItem) {\n            this.props.moduleState.onReady();\n        } else {\n            this.props.moduleState.onUpdating();\n        }\n    };\n\n    @action\n    private onEdit = (): void => {\n        this.props.moduleState.onUpdating();\n        // IMPORTANT: Call RS for getting a new payment session. It should not re-use the previous session for the security reason.\n        // tslint:disable-next-line:no-floating-promises\n        this.updatePaymentAcceptPageData();\n    };\n\n    @action\n    private onContainerReady = (): void => {\n        // tslint:disable-next-line:no-floating-promises\n        this.redirectToPaymentVerification();\n        this.props.moduleState.setIsSubmitContainer(false);\n    }\n}\n\nexport default withVisibilityObserver(CheckoutPaymentInstrument);"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}