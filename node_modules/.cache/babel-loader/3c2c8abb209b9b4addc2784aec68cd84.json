{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{EXCEPTION_INVALID_URL}from'@msdyn365-commerce/telemetry-internal';import express from'express';import path from'path';import url from'url';import{safeRoute}from'../../utils/helpers';import{createFileStreamResponse,HASHED_STATICS_PREFIX,mapAssetUrlToFiles}from'../statics-pipeline/statics-helpers';import{prepareErrorResponse}from'./request-router-helper';export var parseHashedStaticsRequest=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(req,res,next,additionalArgs,telemetry){var requestedJsAssets,streamResponse;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:res.setHeader('Content-Type','application/javascript; charset=UTF-8');res.setHeader('Accept-Ranges','bytes');requestedJsAssets=mapAssetUrlToFiles(req.params.hashedUrl,additionalArgs.clientStats);_context.next=5;return createFileStreamResponse(requestedJsAssets,additionalArgs.PUBLIC_DIR,telemetry);case 5:streamResponse=_context.sent;if(streamResponse){streamResponse.pipe(res);}else{res.end();}case 7:case\"end\":return _context.stop();}}},_callee);}));return function parseHashedStaticsRequest(_x,_x2,_x3,_x4,_x5){return _ref.apply(this,arguments);};}();export default function(PUBLIC_DIR,clientStats){var _staticsRouter=express.Router();/**\r\n     * Platform serving of assets\r\n     */_staticsRouter.get([// js endpoint for concatenated chunks\n\"/\".concat(process.env.SUBMISSIONID||'statics',\"/:hashedUrl\"),// legacy chunk concat ID\n\"/\".concat(HASHED_STATICS_PREFIX,\":hashedUrl\")],safeRoute(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(req,res,next){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt(\"return\",parseHashedStaticsRequest(req,res,next,{clientStats:clientStats,PUBLIC_DIR:PUBLIC_DIR},res.locals.telemetry));case 1:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x6,_x7,_x8){return _ref2.apply(this,arguments);};}()));_staticsRouter.get('/*',safeRoute(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(req,res,next){var telemetry,requestPath,resourcePath;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:telemetry=res.locals.telemetry;requestPath=url.parse(req.url,true);if(!(!requestPath.pathname||requestPath.pathname.indexOf('..')>0)){_context3.next=4;break;}return _context3.abrupt(\"return\",prepareErrorResponse(req,res,new Error(EXCEPTION_INVALID_URL),telemetry));case 4:// substring url after /_scnr/ will give resource path starts from static\nresourcePath=path.resolve(\"\".concat(PUBLIC_DIR,\"/\").concat(requestPath.pathname));return _context3.abrupt(\"return\",res.sendFile(resourcePath,{},function(error){if(error){return prepareErrorResponse(req,res,error,telemetry);}}));case 6:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x9,_x10,_x11){return _ref3.apply(this,arguments);};}()));return _staticsRouter;}","map":{"version":3,"sources":["../../../../src/_server/request-routers/statics-router.ts"],"names":[],"mappings":"uIAAA;;;AAGG,GAEH,OAAS,qBAAT,KAA6E,uCAA7E,CACA,MAAO,CAAA,OAAP,KAAiE,SAAjE,CACA,MAAO,CAAA,IAAP,KAAiB,MAAjB,CACA,MAAO,CAAA,GAAP,KAAgB,KAAhB,CACA,OAAS,SAAT,KAA0B,qBAA1B,CACA,OAAS,wBAAT,CAAmC,qBAAnC,CAA0D,kBAA1D,KAAoF,qCAApF,CACA,OAAS,oBAAT,KAAqC,yBAArC,CAEA,MAAO,IAAM,CAAA,yBAAyB,0FAAG,iBACrC,GADqC,CAErC,GAFqC,CAGrC,IAHqC,CAIrC,cAJqC,CAQrC,SARqC,uJAUrC,GAAG,CAAC,SAAJ,CAAc,cAAd,CAA8B,uCAA9B,EACA,GAAG,CAAC,SAAJ,CAAc,eAAd,CAA+B,OAA/B,EACM,iBAZ+B,CAYX,kBAAkB,CAAC,GAAG,CAAC,MAAJ,CAAW,SAAZ,CAAuB,cAAc,CAAC,WAAtC,CAZP,uBAaR,CAAA,wBAAwB,CAAC,iBAAD,CAAoB,cAAc,CAAC,UAAnC,CAA+C,SAA/C,CAbhB,QAa/B,cAb+B,eAcrC,GAAI,cAAJ,CAAoB,CAChB,cAAc,CAAC,IAAf,CAAoB,GAApB,EACH,CAFD,IAEO,CACH,GAAG,CAAC,GAAJ,GACH,CAlBoC,sDAAH,kBAAzB,CAAA,yBAAyB,4DAA/B,CAqBP,cAAc,UAAU,UAAV,CAA8B,WAA9B,CAA6C,CACvD,GAAM,CAAA,cAAc,CAAG,OAAO,CAAC,MAAR,EAAvB,CACA;;AAEG,OACH,cAAc,CAAC,GAAf,CACI,CACI;AADJ,WAEQ,OAAO,CAAC,GAAR,CAAY,YAAZ,EAA4B,SAFpC,gBAGI;AAHJ,WAIQ,qBAJR,eADJ,CAOI,SAAS,2FAAC,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,uJACC,yBAAyB,CAAC,GAAD,CAAM,GAAN,CAAW,IAAX,CAAiB,CAAE,WAAW,CAAX,WAAF,CAAe,UAAU,CAAV,UAAf,CAAjB,CAA8C,GAAG,CAAC,MAAJ,CAAW,SAAzD,CAD1B,0DAAD,yEAPb,EAWA,cAAc,CAAC,GAAf,CACI,IADJ,CAEI,SAAS,2FAAC,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,6JACA,SADA,CAC+B,GAAG,CAAC,MAAJ,CAAW,SAD1C,CAEA,WAFA,CAEc,GAAG,CAAC,KAAJ,CAAU,GAAG,CAAC,GAAd,CAAmB,IAAnB,CAFd,MAGF,CAAC,WAAW,CAAC,QAAb,EAAyB,WAAW,CAAC,QAAZ,CAAqB,OAArB,CAA6B,IAA7B,EAAqC,CAH5D,4DAIK,oBAAoB,CAAC,GAAD,CAAM,GAAN,CAAW,GAAI,CAAA,KAAJ,CAAU,qBAAV,CAAX,CAA6C,SAA7C,CAJzB,SAMN;AACM,YAPA,CAOe,IAAI,CAAC,OAAL,WAAgB,UAAhB,aAA8B,WAAW,CAAC,QAA1C,EAPf,kCASC,GAAG,CAAC,QAAJ,CAAa,YAAb,CAA2B,EAA3B,CAA+B,SAAC,KAAD,CAAiB,CACnD,GAAI,KAAJ,CAAW,CACP,MAAO,CAAA,oBAAoB,CAAC,GAAD,CAAM,GAAN,CAAW,KAAX,CAAkB,SAAlB,CAA3B,CACH,CACJ,CAJM,CATD,0DAAD,2EAFb,EAmBA,MAAO,CAAA,cAAP,CACH","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { EXCEPTION_INVALID_URL, IInternalTelemetry, InternalTelemetry } from '@msdyn365-commerce/telemetry-internal';\nimport express, { NextFunction, Request, Response, Router } from 'express';\nimport path from 'path';\nimport url from 'url';\nimport { safeRoute } from '../../utils/helpers';\nimport { createFileStreamResponse, HASHED_STATICS_PREFIX, mapAssetUrlToFiles } from '../statics-pipeline/statics-helpers';\nimport { prepareErrorResponse } from './request-router-helper';\n\nexport const parseHashedStaticsRequest = async (\n    req: Request,\n    res: Response,\n    next: NextFunction,\n    additionalArgs: {\n        clientStats: {};\n        PUBLIC_DIR: string;\n    },\n    telemetry: IInternalTelemetry\n) => {\n    res.setHeader('Content-Type', 'application/javascript; charset=UTF-8');\n    res.setHeader('Accept-Ranges', 'bytes');\n    const requestedJsAssets = mapAssetUrlToFiles(req.params.hashedUrl, additionalArgs.clientStats);\n    const streamResponse = await createFileStreamResponse(requestedJsAssets, additionalArgs.PUBLIC_DIR, telemetry);\n    if (streamResponse) {\n        streamResponse.pipe(res);\n    } else {\n        res.end();\n    }\n};\n\nexport default function(PUBLIC_DIR: string, clientStats: {}): Router {\n    const _staticsRouter = express.Router();\n    /**\n     * Platform serving of assets\n     */\n    _staticsRouter.get(\n        [\n            // js endpoint for concatenated chunks\n            `/${process.env.SUBMISSIONID || 'statics'}/:hashedUrl`,\n            // legacy chunk concat ID\n            `/${HASHED_STATICS_PREFIX}:hashedUrl`\n        ],\n        safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n            return parseHashedStaticsRequest(req, res, next, { clientStats, PUBLIC_DIR }, res.locals.telemetry);\n        })\n    );\n    _staticsRouter.get(\n        '/*',\n        safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n            const telemetry: InternalTelemetry = res.locals.telemetry;\n            const requestPath = url.parse(req.url, true);\n            if (!requestPath.pathname || requestPath.pathname.indexOf('..') > 0) {\n                return prepareErrorResponse(req, res, new Error(EXCEPTION_INVALID_URL), telemetry);\n            }\n            // substring url after /_scnr/ will give resource path starts from static\n            const resourcePath = path.resolve(`${PUBLIC_DIR}/${requestPath.pathname}`);\n\n            return res.sendFile(resourcePath, {}, (error: Error) => {\n                if (error) {\n                    return prepareErrorResponse(req, res, error, telemetry);\n                }\n            });\n        })\n    );\n\n    return _staticsRouter;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}