{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{readCachedExperimentsEntries,saveCachedExperimentsEntries}from'@msdyn365-commerce/cache-internal';import{EXPERIMENTATION_CACHE_TYPE,msdyn365Commerce,RefreshType}from'@msdyn365-commerce/core-internal';import{asSystemMetadata,LogLevel}from'@msdyn365-commerce/telemetry-internal';import express from'express';import{moduleListPage}from'../../components/module-list-page';import{DEFAULT_REQUEST_TIMEOUT,PROVIDER_GET_EXPERIMENTS_FAIL,RETAIL_SERVER_BASE_URL_HEADER_KEY}from'../../consts';import keystonePaths from'../../paths';import featureFlags from'../../settings/featureflags.settings.json';import{safeRoute,throwHelper}from'../../utils/helpers';import{getModuleDefinitions,getModulesList,getThemeModules,getThemeModulesList}from'../Definition/moduleDefinition';import{getStyles}from'../Definition/stylesDefinition';/**\r\n * Adds module details (name and default mock url) to a module type array\r\n *\r\n * @param moduleType The module type that the current module should be added to\r\n * @param moduleName The name of the module\r\n * @param modulesList The module list object containing the moduleType keys\r\n */var addToModuleType=function addToModuleType(moduleType,moduleName,modulesList){if(!modulesList[moduleType]){modulesList[moduleType]=[];}modulesList[moduleType].push({name:moduleName,mockUrl:\"/modules?type=\".concat(moduleName)});};/**\r\n * Returns a function used for resolving the behavior of the _sdk/allmodules route\r\n * which gets a list of registered modules from DAPI and categorizes\r\n * the modules by module type before sending that list module-list-page.tsx\r\n * to render a list of installed modules and their associated previews (if applicabile)\r\n */var getAllModulesRouteParser=function getAllModulesRouteParser(){return safeRoute(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(req,res,next){var registeredModules,modulesList,registeredModuleList;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getModuleDefinitions('',res.locals.telemetry);case 2:registeredModules=_context.sent;modulesList={};if(Array.isArray(registeredModules)){registeredModuleList=registeredModules;registeredModuleList.forEach(function(moduleDefinition){var moduleType=moduleDefinition.type?moduleDefinition.type:moduleDefinition.$type;if(moduleType&&moduleType!=='moduleDefinition'){addToModuleType(moduleType,moduleDefinition.name,modulesList);}else{addToModuleType('uncategorizedModules',moduleDefinition.name,modulesList);}});}res.send(moduleListPage(modulesList));case 6:case\"end\":return _context.stop();}}},_callee);}));return function(_x,_x2,_x3){return _ref.apply(this,arguments);};}());};/**\r\n * Returns a function for resolving the behvaior of the _sdk/featureflags route\r\n * Returns a json object containing information on the current feature\r\n */var getFeatureFlagsJson=function getFeatureFlagsJson(){return safeRoute(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(req,res,next){var features;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:features=featureFlags;if(process.env.MSDyn365Commerce_RSVERSION){features.retailServerVersion=process.env.MSDyn365Commerce_RSVERSION;features.SDKVersion=process.env.MSDyn365Commerce_SDK_VERSION;features.SSKVersion=process.env.MSDyn365Commerce_SSK_VERSION;}res.send(features);case 3:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x4,_x5,_x6){return _ref2.apply(this,arguments);};}());};var getExperimentsWithCache=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(res,retailServerBaseUrl,page,items){var experimentConnector,experimentList,experiments,refreshOption,cacheKey;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:experimentConnector=msdyn365Commerce.experimentationConnector&&msdyn365Commerce.experimentationConnector;if(experimentConnector){_context3.next=4;break;}res.status(204);return _context3.abrupt(\"return\",{});case 4:if(!(!page&&!items)){_context3.next=29;break;}refreshOption={refreshType:RefreshType.Experiments,parameters:[]};cacheKey={typeName:EXPERIMENTATION_CACHE_TYPE,key:experimentConnector.name};_context3.next=9;return readCachedExperimentsEntries(cacheKey,refreshOption,experimentConnector.provider,experimentConnector.name,retailServerBaseUrl);case 9:experimentList=_context3.sent;if(experimentList){_context3.next=26;break;}_context3.prev=11;_context3.next=14;return experimentConnector.provider.getExperiments(retailServerBaseUrl,experimentConnector.name);case 14:experiments=_context3.sent;experimentList=experiments&&experiments.experiments;if(!(experimentList&&experimentList.length>0)){_context3.next=19;break;}_context3.next=19;return saveCachedExperimentsEntries(cacheKey,experimentList);case 19:_context3.next=24;break;case 21:_context3.prev=21;_context3.t0=_context3[\"catch\"](11);res.locals.telemetry.log(LogLevel.Error,PROVIDER_GET_EXPERIMENTS_FAIL,{values:[asSystemMetadata(retailServerBaseUrl||'')],exception:_context3.t0});case 24:_context3.next=27;break;case 26:experiments={name:experimentConnector.name,experiments:experimentList};case 27:_context3.next=38;break;case 29:_context3.prev=29;_context3.next=32;return experimentConnector.provider.getExperiments(retailServerBaseUrl,experimentConnector.name,page,items);case 32:experiments=_context3.sent;_context3.next=38;break;case 35:_context3.prev=35;_context3.t1=_context3[\"catch\"](29);res.locals.telemetry.log(LogLevel.Error,PROVIDER_GET_EXPERIMENTS_FAIL,{values:[asSystemMetadata(retailServerBaseUrl||'')],exception:_context3.t1});case 38:return _context3.abrupt(\"return\",experiments||{});case 39:case\"end\":return _context3.stop();}}},_callee3,null,[[11,21],[29,35]]);}));return function getExperimentsWithCache(_x7,_x8,_x9,_x10){return _ref3.apply(this,arguments);};}();/**\r\n * Method to process dapi request\r\n * @param req request object\r\n * @param res response object\r\n * @param next next function in the route chain\r\n */var processDapiRequest=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(req,res,next){var resultDefinition,retailServerBaseUrl;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(req.stale){_context4.next=2;break;}return _context4.abrupt(\"return\",res.sendStatus(304));case 2:_context4.t0=req.params.resource;_context4.next=_context4.t0===\"modules\"/* Modules */?5:_context4.t0===\"modulelist\"/* ModuleList */?10:_context4.t0===\"styles\"/* Styles */?14:_context4.t0===\"experiments\"/* Experiments */?16:_context4.t0===\"appsettings\"/* AppSettings */?21:_context4.t0===\"imagesettings\"/* ImageSettings */?23:_context4.t0===\"themesettings\"/* ThemeSettings */?25:_context4.t0===\"themes\"/* Themes */?27:_context4.t0===\"themeslist\"/* ThemesList */?31:_context4.t0===\"resources\"/* Resources */?35:37;break;case 5:_context4.next=7;return getModuleDefinitions(req.query.type,res.locals.telemetry);case 7:resultDefinition=_context4.sent;if(Array.isArray(resultDefinition)&&resultDefinition.length>0){resultDefinition=resultDefinition.filter(function(moduleDef){return moduleDef.type!==\"themeModule\";}/* TYPE */);}return _context4.abrupt(\"break\",39);case 10:_context4.next=12;return getModulesList();case 12:resultDefinition=_context4.sent;return _context4.abrupt(\"break\",39);case 14:resultDefinition=getStyles();return _context4.abrupt(\"break\",39);case 16:retailServerBaseUrl=req.headers[RETAIL_SERVER_BASE_URL_HEADER_KEY];_context4.next=19;return getExperimentsWithCache(res,retailServerBaseUrl,req.query.page,req.query.items);case 19:resultDefinition=_context4.sent;return _context4.abrupt(\"break\",39);case 21:resultDefinition=msdyn365Commerce.appSettings;return _context4.abrupt(\"break\",39);case 23:resultDefinition=msdyn365Commerce.imageSettings;return _context4.abrupt(\"break\",39);case 25:resultDefinition=msdyn365Commerce.themeSettings;return _context4.abrupt(\"break\",39);case 27:_context4.next=29;return getThemeModules(req.query.type,res.locals.telemetry);case 29:resultDefinition=_context4.sent;return _context4.abrupt(\"break\",39);case 31:_context4.next=33;return getThemeModulesList(res.locals.telemetry);case 33:resultDefinition=_context4.sent;return _context4.abrupt(\"break\",39);case 35:resultDefinition=msdyn365Commerce.resourceManager?msdyn365Commerce.resourceManager.getAuthoringResources():{error:\"Resource manager is not defined\"};return _context4.abrupt(\"break\",39);case 37:resultDefinition={error:\"type not defined [\".concat(req.params.resource,\"]\")};res.status(404);case 39:return _context4.abrupt(\"return\",res.send(resultDefinition));case 40:case\"end\":return _context4.stop();}}},_callee4);}));return function processDapiRequest(_x11,_x12,_x13){return _ref4.apply(this,arguments);};}();// tslint:disable-next-line:typedef max-func-body-length\nexport default function(server){var sdkRouter=express.Router();sdkRouter.use(function(req,res,next){res.append('build-version',msdyn365Commerce.buildVersion);res.setHeader('ETag',\"\\\"\".concat(msdyn365Commerce.buildVersion,\"\\\"\"));res.setHeader('Cache-Control','max-age=3600, public');next();});sdkRouter// @TODO kopik: move test routes behind an env flag\n// route to test that exceptions will be caught\n.get('/test-throw',safeRoute(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(req,res,next){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:return _context5.abrupt(\"return\",throwHelper(req,res,next,'test-throw'));case 1:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x14,_x15,_x16){return _ref5.apply(this,arguments);};}()))// nested promise example\n.get('/test-throw-nested',safeRoute(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(req,res,next){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:return _context7.abrupt(\"return\",function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(req2,res2,next2){return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt(\"return\",throwHelper(req,res,next,'test-throw-2'));case 1:case\"end\":return _context6.stop();}}},_callee6);}));return function(_x20,_x21,_x22){return _ref7.apply(this,arguments);};}()(req,res,next));case 1:case\"end\":return _context7.stop();}}},_callee7);}));return function(_x17,_x18,_x19){return _ref6.apply(this,arguments);};}())).get('/test-timeout',/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(req,res,next){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:setTimeout(function(){try{res.send('timeout exceeded');}catch(e){// eat the error silently in case we've already closed the connection\n}// tslint:disable-next-line:align\n},DEFAULT_REQUEST_TIMEOUT+1000);case 1:case\"end\":return _context8.stop();}}},_callee8);}));return function(_x23,_x24,_x25){return _ref8.apply(this,arguments);};}());/**\r\n     * This route is for showing all registered routes and middleware in express. it's a raw dump,\r\n     * useful in debugging express\r\n     */sdkRouter.get('/debug',/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(req,res,next){return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:res.send(_objectSpread({},server._router));case 1:case\"end\":return _context9.stop();}}},_callee9);}));return function(_x26,_x27,_x28){return _ref9.apply(this,arguments);};}());// definition api routes\nsdkRouter.get('/dapi/:resource',safeRoute(processDapiRequest));sdkRouter.get('/allmodules',getAllModulesRouteParser());// version route\nsdkRouter.get('/version',function(req,res){res.sendFile(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);});// enabled features route\nsdkRouter.get('/features',getFeatureFlagsJson());sdkRouter.get('/yarn-lock',function(req,res){res.sendFile(keystonePaths.KEYSTONE_APP_YARN_LOCK);});sdkRouter.get('/registration/:resource',function(req,res){var bindings=msdyn365Commerce.bindings;switch(req.params.resource){case'views':res.send(Object.keys(bindings.views||[]));break;case'components':res.send(Object.keys(bindings.components||[]));break;case'modules':// filter modules\nres.send(Object.keys(bindings.modules||[]).map(function(key){return bindings.modules[key];}).filter(function(value){return value.$type!==\"themeModule\";}/* TYPE */).map(function(val){return{name:val.name,type:val.$type,packageName:val.packageName,moduleNamespace:val.moduleNamespace,isNodeModule:val.isNodeModule,dataActions:val.dataActions,parentDefinitionPath:val.parentDefinitionPath};}));break;case'themes':// filter theme modules\nres.send(Object.keys(bindings.modules||[]).map(function(key){return bindings.modules[key];}).filter(function(value){return value.$type===\"themeModule\";}/* TYPE */).map(function(val){return{name:val.name,packageName:val.packageName,moduleNamespace:val.moduleNamespace,isNodeModule:val.isNodeModule,definitionExtensions:val.definitionExtensions,views:Object.keys(bindings.views||[]).filter(function(view){return view.indexOf(\"|\".concat(val.name,\"|views|\"))>0;}),components:Object.keys(bindings.components||[]).filter(function(component){return component.indexOf(\"|\".concat(val.name,\"|views|components|\"))>0;}),themeSettings:val.themeSettings};}));break;case'data-actions':res.send(Object.keys(bindings.dataActions||[]));break;default:var resultDefinition={error:\"type not defined [\".concat(req.params.resource,\"]\")};res.status(404);return res.send(resultDefinition);}});return sdkRouter;}","map":{"version":3,"sources":["../../../../src/_server/request-routers/sdk-router.ts"],"names":[],"mappings":"0+BAAA;;;AAGG,GACH,OAAoB,4BAApB,CAAkD,4BAAlD,KAAsF,mCAAtF,CACA,OACI,0BADJ,CAKI,gBALJ,CAMI,WANJ,KAOO,kCAPP,CAQA,OAAS,gBAAT,CAA+C,QAA/C,KAA+D,uCAA/D,CACA,MAAO,CAAA,OAAP,KAAyD,SAAzD,CAEA,OAA2B,cAA3B,KAAiD,mCAAjD,CACA,OAAS,uBAAT,CAAkC,6BAAlC,CAAiE,iCAAjE,KAA0G,cAA1G,CACA,MAAO,CAAA,aAAP,KAA0B,aAA1B,CACA,MAAO,CAAA,YAAP,KAAyB,2CAAzB,CACA,OAAS,SAAT,CAAoB,WAApB,KAAuC,qBAAvC,CACA,OAEI,oBAFJ,CAGI,cAHJ,CAII,eAJJ,CAKI,mBALJ,KAOO,gCAPP,CAQA,OAAS,SAAT,KAA0B,gCAA1B,CAEA;;;;;;AAMG,GACH,GAAM,CAAA,eAAe,CAAG,QAAlB,CAAA,eAAkB,CAAC,UAAD,CAAqB,UAArB,CAAyC,WAAzC,CAA0E,CAC9F,GAAI,CAAC,WAAW,CAAC,UAAD,CAAhB,CAA8B,CAC1B,WAAW,CAAC,UAAD,CAAX,CAA0B,EAA1B,CACH,CACD,WAAW,CAAC,UAAD,CAAX,CAAwB,IAAxB,CAA6B,CAAE,IAAI,CAAE,UAAR,CAAoB,OAAO,yBAAmB,UAAnB,CAA3B,CAA7B,EACH,CALD,CAOA;;;;;AAKG,GACH,GAAM,CAAA,wBAAwB,CAAG,QAA3B,CAAA,wBAA2B,EAAK,CAClC,MAAO,CAAA,SAAS,0FAAC,iBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,+LAEmB,CAAA,oBAAoB,CAAC,EAAD,CAAK,GAAG,CAAC,MAAJ,CAAW,SAAhB,CAFvC,QAEP,iBAFO,eAGP,WAHO,CAGyB,EAHzB,CAIb,GAAI,KAAK,CAAC,OAAN,CAAc,iBAAd,CAAJ,CAAsC,CAC5B,oBAD4B,CAC8C,iBAD9C,CAElC,oBAAoB,CAAC,OAArB,CAA6B,SAAA,gBAAgB,CAAG,CAC5C,GAAM,CAAA,UAAU,CAAG,gBAAgB,CAAC,IAAjB,CAAwB,gBAAgB,CAAC,IAAzC,CAAgD,gBAAgB,CAAC,KAApF,CACA,GAAI,UAAU,EAAI,UAAU,GAAK,kBAAjC,CAAqD,CACjD,eAAe,CAAC,UAAD,CAAa,gBAAgB,CAAC,IAA9B,CAAoC,WAApC,CAAf,CACH,CAFD,IAEO,CACH,eAAe,CAAC,sBAAD,CAAyB,gBAAgB,CAAC,IAA1C,CAAgD,WAAhD,CAAf,CACH,CACJ,CAPD,EAQH,CACD,GAAG,CAAC,IAAJ,CAAS,cAAc,CAAC,WAAD,CAAvB,EAfa,sDAAD,uEAAhB,CAiBH,CAlBD,CA2BA;;;AAGG,GACH,GAAM,CAAA,mBAAmB,CAAG,QAAtB,CAAA,mBAAsB,EAAK,CAC7B,MAAO,CAAA,SAAS,2FAAC,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,mIACP,QADO,CACmB,YADnB,CAEb,GAAI,OAAO,CAAC,GAAR,CAAY,0BAAhB,CAA4C,CACxC,QAAQ,CAAC,mBAAT,CAA+B,OAAO,CAAC,GAAR,CAAY,0BAA3C,CACA,QAAQ,CAAC,UAAT,CAAsB,OAAO,CAAC,GAAR,CAAY,4BAAlC,CACA,QAAQ,CAAC,UAAT,CAAsB,OAAO,CAAC,GAAR,CAAY,4BAAlC,CACH,CACD,GAAG,CAAC,IAAJ,CAAS,QAAT,EAPa,wDAAD,yEAAhB,CASH,CAVD,CAYA,GAAM,CAAA,uBAAuB,2FAAG,kBAC5B,GAD4B,CAE5B,mBAF4B,CAG5B,IAH4B,CAI5B,KAJ4B,gMAMtB,mBANsB,CAMA,gBAAgB,CAAC,wBAAjB,EAA6C,gBAAgB,CAAC,wBAN9D,IAOvB,mBAPuB,0BAQxB,GAAG,CAAC,MAAJ,CAAW,GAAX,EARwB,iCASjB,EATiB,cAaxB,CAAC,IAAD,EAAS,CAAC,KAbc,4BAclB,aAdkB,CAcyB,CAC7C,WAAW,CAAE,WAAW,CAAC,WADoB,CAE7C,UAAU,CAAE,EAFiC,CAdzB,CAkBlB,QAlBkB,CAkBI,CACxB,QAAQ,CAAE,0BADc,CAExB,GAAG,CAAE,mBAAmB,CAAC,IAFD,CAlBJ,wBAsBD,CAAA,4BAA4B,CAC/C,QAD+C,CAE/C,aAF+C,CAG/C,mBAAmB,CAAC,QAH2B,CAI/C,mBAAmB,CAAC,IAJ2B,CAK/C,mBAL+C,CAtB3B,QAsBxB,cAtBwB,mBA6BnB,cA7BmB,qEA+BI,CAAA,mBAAmB,CAAC,QAApB,CAA6B,cAA7B,CAA4C,mBAA5C,CAAiE,mBAAmB,CAAC,IAArF,CA/BJ,SA+BhB,WA/BgB,gBAgChB,cAAc,CAAG,WAAW,EAAI,WAAW,CAAC,WAA5C,CAhCgB,KAiCZ,cAAc,EAAI,cAAc,CAAC,MAAf,CAAwB,CAjC9B,oDAkCN,CAAA,4BAA4B,CAAiB,QAAjB,CAA2B,cAA3B,CAlCtB,+FAqCK,GAAG,CAAC,MAAJ,CAAW,SAAX,CAAsB,GAAtB,CAA0B,QAAQ,CAAC,KAAnC,CAA0C,6BAA1C,CAAyE,CAC1F,MAAM,CAAE,CAAC,gBAAgB,CAAC,mBAAmB,EAAI,EAAxB,CAAjB,CADkF,CAE1F,SAAS,aAFiF,CAAzE,EArCL,wCA2CpB,WAAW,CAAG,CACV,IAAI,CAAE,mBAAmB,CAAC,IADhB,CAEV,WAAW,CAAE,cAFH,CAAd,CA3CoB,kFAkDA,CAAA,mBAAmB,CAAC,QAApB,CAA6B,cAA7B,CAA4C,mBAA5C,CAAiE,mBAAmB,CAAC,IAArF,CAA2F,IAA3F,CAAiG,KAAjG,CAlDA,SAkDpB,WAlDoB,sGAoDC,GAAG,CAAC,MAAJ,CAAW,SAAX,CAAsB,GAAtB,CAA0B,QAAQ,CAAC,KAAnC,CAA0C,6BAA1C,CAAyE,CAC1F,MAAM,CAAE,CAAC,gBAAgB,CAAC,mBAAmB,EAAI,EAAxB,CAAjB,CADkF,CAE1F,SAAS,aAFiF,CAAzE,EApDD,yCA0DrB,WAAW,EAAI,EA1DM,kFAAH,kBAAvB,CAAA,uBAAuB,2DAA7B,CA6DA;;;;;AAKG,GACH,GAAM,CAAA,kBAAkB,2FAAG,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,kKAClB,GAAG,CAAC,KADc,2DAEZ,GAAG,CAAC,UAAJ,CAAe,GAAf,CAFY,sBAKf,GAAG,CAAC,MAAJ,CAAW,QALI,+BAMnB,SAAA,aANmB,kBAanB,YAAA,gBAbmB,mBAgBnB,QAAA,YAhBmB,mBAmBnB,aAAA,iBAnBmB,mBAuBnB,aAAA,iBAvBmB,mBA0BnB,eAAA,mBA1BmB,mBA6BnB,eAAA,mBA7BmB,mBAgCnB,QAAA,YAhCmB,mBAmCnB,YAAA,gBAnCmB,mBAsCnB,WAAA,eAtCmB,2CAOU,CAAA,oBAAoB,CAAC,GAAG,CAAC,KAAJ,CAAU,IAAX,CAAiB,GAAG,CAAC,MAAJ,CAAW,SAA5B,CAP9B,QAOf,gBAPe,gBASf,GAAI,KAAK,CAAC,OAAN,CAAc,gBAAd,GAAmC,gBAAgB,CAAC,MAAjB,CAA0B,CAAjE,CAAoE,CAChE,gBAAgB,CAAG,gBAAgB,CAAC,MAAjB,CAAwB,SAAA,SAAS,QAAI,CAAA,SAAS,CAAC,IAAV,GAAc,aAAlB,EAAkB,UAAnD,CAAnB,CACH,CAXc,oEAcU,CAAA,cAAc,EAdxB,SAcf,gBAde,4DAiBf,gBAAgB,CAAG,SAAS,EAA5B,CAjBe,4CAoBT,mBApBS,CAoBqB,GAAG,CAAC,OAAJ,CAAY,iCAAZ,CApBrB,yBAqBU,CAAA,uBAAuB,CAAC,GAAD,CAAM,mBAAN,CAA2B,GAAG,CAAC,KAAJ,CAAU,IAArC,CAA2C,GAAG,CAAC,KAAJ,CAAU,KAArD,CArBjC,SAqBf,gBArBe,4DAwBf,gBAAgB,CAAG,gBAAgB,CAAC,WAApC,CAxBe,4CA2Bf,gBAAgB,CAAG,gBAAgB,CAAC,aAApC,CA3Be,4CA8Bf,gBAAgB,CAAG,gBAAgB,CAAC,aAApC,CA9Be,oEAiCU,CAAA,eAAe,CAAC,GAAG,CAAC,KAAJ,CAAU,IAAX,CAAiB,GAAG,CAAC,MAAJ,CAAW,SAA5B,CAjCzB,SAiCf,gBAjCe,oFAoCU,CAAA,mBAAmB,CAAC,GAAG,CAAC,MAAJ,CAAW,SAAZ,CApC7B,SAoCf,gBApCe,4DAuCf,gBAAgB,CAAG,gBAAgB,CAAC,eAAjB,CACb,gBAAgB,CAAC,eAAjB,CAAiC,qBAAjC,EADa,CAEb,CAAE,KAAK,kCAAP,CAFN,CAvCe,4CA4Cf,gBAAgB,CAAG,CAAE,KAAK,6BAAuB,GAAG,CAAC,MAAJ,CAAW,QAAlC,KAAP,CAAnB,CACA,GAAG,CAAC,MAAJ,CAAW,GAAX,EA7Ce,yCA+ChB,GAAG,CAAC,IAAJ,CAAS,gBAAT,CA/CgB,2DAAH,kBAAlB,CAAA,kBAAkB,yDAAxB,CAkDA;AACA,cAAc,UAAU,MAAV,CAAgB,CAC1B,GAAM,CAAA,SAAS,CAAG,OAAO,CAAC,MAAR,EAAlB,CAEA,SAAS,CAAC,GAAV,CAAc,SAAC,GAAD,CAAe,GAAf,CAA8B,IAA9B,CAA0D,CACpE,GAAG,CAAC,MAAJ,CAAW,eAAX,CAA4B,gBAAgB,CAAC,YAA7C,EACA,GAAG,CAAC,SAAJ,CAAc,MAAd,aAA0B,gBAAgB,CAAC,YAA3C,QACA,GAAG,CAAC,SAAJ,CAAc,eAAd,CAA+B,sBAA/B,EACA,IAAI,GACP,CALD,EAMA,SACI;AACA;AAFK,CAGJ,GAHL,CAIQ,aAJR,CAKQ,SAAS,2FAAC,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,uJACC,WAAW,CAAC,GAAD,CAAM,GAAN,CAAW,IAAX,CAAiB,YAAjB,CADZ,0DAAD,4EALjB,CASI;AATJ,CAUK,GAVL,CAWQ,oBAXR,CAYQ,SAAS,2FAAC,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,uJACC,6EAAC,kBAAO,IAAP,CAAsB,IAAtB,CAAsC,KAAtC,uJACG,WAAW,CAAC,GAAD,CAAM,GAAN,CAAW,IAAX,CAAiB,cAAjB,CADd,0DAAD,4EAEJ,GAFI,CAEC,GAFD,CAEM,IAFN,CADD,0DAAD,4EAZjB,EAkBK,GAlBL,CAkBS,eAlBT,2FAkB0B,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,sHAClB,UAAU,CAAC,UAAK,CACZ,GAAI,CACA,GAAG,CAAC,IAAJ,CAAS,kBAAT,EACH,CAAC,MAAO,CAAP,CAAU,CACR;AACH,CACD;AACH,CAPS,CAOP,uBAAuB,CAAG,IAPnB,CAAV,CADkB,wDAlB1B,6EA6BA;;;AAGG,OACH,SAAS,CAAC,GAAV,CAAc,QAAd,2FAAwB,kBAAO,GAAP,CAAqB,GAArB,CAAoC,IAApC,sHACpB,GAAG,CAAC,IAAJ,kBACO,MAAM,CAAC,OADd,GADoB,wDAAxB,6EAMA;AACA,SAAS,CAAC,GAAV,CAAc,iBAAd,CAAiC,SAAS,CAAC,kBAAD,CAA1C,EACA,SAAS,CAAC,GAAV,CAAc,aAAd,CAA6B,wBAAwB,EAArD,EACA;AACA,SAAS,CAAC,GAAV,CAAc,UAAd,CAA0B,SAAC,GAAD,CAAe,GAAf,CAAgC,CACtD,GAAG,CAAC,QAAJ,CAAa,aAAa,CAAC,4BAA3B,EACH,CAFD,EAGA;AACA,SAAS,CAAC,GAAV,CAAc,WAAd,CAA2B,mBAAmB,EAA9C,EACA,SAAS,CAAC,GAAV,CAAc,YAAd,CAA4B,SAAC,GAAD,CAAe,GAAf,CAAgC,CACxD,GAAG,CAAC,QAAJ,CAAa,aAAa,CAAC,sBAA3B,EACH,CAFD,EAGA,SAAS,CAAC,GAAV,CAAc,yBAAd,CAAyC,SAAC,GAAD,CAAe,GAAf,CAAgC,CACrE,GAAM,CAAA,QAAQ,CAA0C,gBAAkB,CAAC,QAA3E,CACA,OAAQ,GAAG,CAAC,MAAJ,CAAW,QAAnB,EACI,IAAK,OAAL,CACI,GAAG,CAAC,IAAJ,CAAS,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,KAAT,EAAkB,EAA9B,CAAT,EACA,MACJ,IAAK,YAAL,CACI,GAAG,CAAC,IAAJ,CAAS,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,UAAT,EAAuB,EAAnC,CAAT,EACA,MACJ,IAAK,SAAL,CACI;AACA,GAAG,CAAC,IAAJ,CACI,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,OAAT,EAAoB,EAAhC,EACK,GADL,CACS,SAAA,GAAG,QAAI,CAAA,QAAQ,CAAC,OAAT,CAAiB,GAAjB,CAAJ,EADZ,EAEK,MAFL,CAEY,SAAA,KAAK,QAAI,CAAA,KAAK,CAAC,KAAN,GAAW,aAAf,EAAe,UAFhC,EAGK,GAHL,CAGS,SAAA,GAAG,CAAG,CACP,MAAO,CACH,IAAI,CAAE,GAAG,CAAC,IADP,CAEH,IAAI,CAAE,GAAG,CAAC,KAFP,CAGH,WAAW,CAAE,GAAG,CAAC,WAHd,CAIH,eAAe,CAAE,GAAG,CAAC,eAJlB,CAKH,YAAY,CAAE,GAAG,CAAC,YALf,CAMH,WAAW,CAAE,GAAG,CAAC,WANd,CAOH,oBAAoB,CAAE,GAAG,CAAC,oBAPvB,CAAP,CASH,CAbL,CADJ,EAgBA,MACJ,IAAK,QAAL,CACI;AACA,GAAG,CAAC,IAAJ,CACI,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,OAAT,EAAoB,EAAhC,EACK,GADL,CACS,SAAA,GAAG,QAAI,CAAA,QAAQ,CAAC,OAAT,CAAiB,GAAjB,CAAJ,EADZ,EAEK,MAFL,CAEY,SAAA,KAAK,QAAI,CAAA,KAAK,CAAC,KAAN,GAAW,aAAf,EAAe,UAFhC,EAGK,GAHL,CAGS,SAAA,GAAG,CAAG,CACP,MAAO,CACH,IAAI,CAAE,GAAG,CAAC,IADP,CAEH,WAAW,CAAE,GAAG,CAAC,WAFd,CAGH,eAAe,CAAE,GAAG,CAAC,eAHlB,CAIH,YAAY,CAAE,GAAG,CAAC,YAJf,CAKH,oBAAoB,CAAE,GAAG,CAAC,oBALvB,CAMH,KAAK,CAAE,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,KAAT,EAAkB,EAA9B,EAAkC,MAAlC,CAAyC,SAAA,IAAI,QAAI,CAAA,IAAI,CAAC,OAAL,YAAiB,GAAG,CAAC,IAArB,aAAsC,CAA1C,EAA7C,CANJ,CAOH,UAAU,CAAE,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,UAAT,EAAuB,EAAnC,EAAuC,MAAvC,CACR,SAAA,SAAS,QAAI,CAAA,SAAS,CAAC,OAAV,YAAsB,GAAG,CAAC,IAA1B,wBAAsD,CAA1D,EADD,CAPT,CAUH,aAAa,CAAE,GAAG,CAAC,aAVhB,CAAP,CAYH,CAhBL,CADJ,EAmBA,MACJ,IAAK,cAAL,CACI,GAAG,CAAC,IAAJ,CAAS,MAAM,CAAC,IAAP,CAAY,QAAQ,CAAC,WAAT,EAAwB,EAApC,CAAT,EACA,MACJ,QACI,GAAM,CAAA,gBAAgB,CAAG,CAAE,KAAK,6BAAuB,GAAG,CAAC,MAAJ,CAAW,QAAlC,KAAP,CAAzB,CACA,GAAG,CAAC,MAAJ,CAAW,GAAX,EACA,MAAO,CAAA,GAAG,CAAC,IAAJ,CAAS,gBAAT,CAAP,CAtDR,CAwDH,CA1DD,EA4DA,MAAO,CAAA,SAAP,CACH","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\nimport { ICacheKey, readCachedExperimentsEntries, saveCachedExperimentsEntries } from '@msdyn365-commerce/cache-internal';\nimport {\n    EXPERIMENTATION_CACHE_TYPE,\n    IExperimentRefreshOptions,\n    IExperiments,\n    IExperimentsResult,\n    msdyn365Commerce,\n    RefreshType\n} from '@msdyn365-commerce/core-internal';\nimport { asSystemMetadata, IInternalTelemetry, LogLevel } from '@msdyn365-commerce/telemetry-internal';\nimport express, { NextFunction, Request, Response } from 'express';\nimport { IMSDyn365CommerceExtension } from '../../app-initialization/models';\nimport { IModuleListTypes, moduleListPage } from '../../components/module-list-page';\nimport { DEFAULT_REQUEST_TIMEOUT, PROVIDER_GET_EXPERIMENTS_FAIL, RETAIL_SERVER_BASE_URL_HEADER_KEY } from '../../consts';\nimport keystonePaths from '../../paths';\nimport featureFlags from '../../settings/featureflags.settings.json';\nimport { safeRoute, throwHelper } from '../../utils/helpers';\nimport {\n    DefinitionType,\n    getModuleDefinitions,\n    getModulesList,\n    getThemeModules,\n    getThemeModulesList,\n    THEME_MODULE\n} from '../Definition/moduleDefinition';\nimport { getStyles } from '../Definition/stylesDefinition';\n\n/**\n * Adds module details (name and default mock url) to a module type array\n *\n * @param moduleType The module type that the current module should be added to\n * @param moduleName The name of the module\n * @param modulesList The module list object containing the moduleType keys\n */\nconst addToModuleType = (moduleType: string, moduleName: string, modulesList: IModuleListTypes) => {\n    if (!modulesList[moduleType]) {\n        modulesList[moduleType] = [];\n    }\n    modulesList[moduleType].push({ name: moduleName, mockUrl: `/modules?type=${moduleName}` });\n};\n\n/**\n * Returns a function used for resolving the behavior of the _sdk/allmodules route\n * which gets a list of registered modules from DAPI and categorizes\n * the modules by module type before sending that list module-list-page.tsx\n * to render a list of installed modules and their associated previews (if applicabile)\n */\nconst getAllModulesRouteParser = () => {\n    return safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n        // Pass in empty string as the first argument so we get a list of all the modules\n        const registeredModules = await getModuleDefinitions('', res.locals.telemetry);\n        const modulesList: IModuleListTypes = {};\n        if (Array.isArray(registeredModules)) {\n            const registeredModuleList = <{ $type?: string; type?: string; name: string }[]>registeredModules;\n            registeredModuleList.forEach(moduleDefinition => {\n                const moduleType = moduleDefinition.type ? moduleDefinition.type : moduleDefinition.$type;\n                if (moduleType && moduleType !== 'moduleDefinition') {\n                    addToModuleType(moduleType, moduleDefinition.name, modulesList);\n                } else {\n                    addToModuleType('uncategorizedModules', moduleDefinition.name, modulesList);\n                }\n            });\n        }\n        res.send(moduleListPage(modulesList));\n    });\n};\n\nexport interface IFeatureFlags {\n    features: { name: string; dependencies?: { name: string; minVersion?: string; maxVersion?: string }[] }[];\n    retailServerVersion?: string;\n    SDKVersion?: string;\n    SSKVersion?: string;\n}\n\n/**\n * Returns a function for resolving the behvaior of the _sdk/featureflags route\n * Returns a json object containing information on the current feature\n */\nconst getFeatureFlagsJson = () => {\n    return safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n        const features: IFeatureFlags = featureFlags;\n        if (process.env.MSDyn365Commerce_RSVERSION) {\n            features.retailServerVersion = process.env.MSDyn365Commerce_RSVERSION;\n            features.SDKVersion = process.env.MSDyn365Commerce_SDK_VERSION;\n            features.SSKVersion = process.env.MSDyn365Commerce_SSK_VERSION;\n        }\n        res.send(features);\n    });\n};\n\nconst getExperimentsWithCache = async (\n    res: Response,\n    retailServerBaseUrl: string,\n    page?: string,\n    items?: string\n): Promise<IExperimentsResult> => {\n    const experimentConnector = msdyn365Commerce.experimentationConnector && msdyn365Commerce.experimentationConnector;\n    if (!experimentConnector) {\n        res.status(204);\n        return {};\n    }\n    let experimentList: IExperiments[] | undefined;\n    let experiments: IExperimentsResult | undefined;\n    if (!page && !items) {\n        const refreshOption: IExperimentRefreshOptions = {\n            refreshType: RefreshType.Experiments,\n            parameters: []\n        };\n        const cacheKey: ICacheKey = {\n            typeName: EXPERIMENTATION_CACHE_TYPE,\n            key: experimentConnector.name\n        };\n        experimentList = await readCachedExperimentsEntries<IExperiments[]>(\n            cacheKey,\n            refreshOption,\n            experimentConnector.provider,\n            experimentConnector.name,\n            retailServerBaseUrl\n        );\n        if (!experimentList) {\n            try {\n                experiments = await experimentConnector.provider.getExperiments(retailServerBaseUrl, experimentConnector.name);\n                experimentList = experiments && experiments.experiments;\n                if (experimentList && experimentList.length > 0) {\n                    await saveCachedExperimentsEntries<IExperiments[]>(cacheKey, experimentList);\n                }\n            } catch (e) {\n                (<IInternalTelemetry>res.locals.telemetry).log(LogLevel.Error, PROVIDER_GET_EXPERIMENTS_FAIL, {\n                    values: [asSystemMetadata(retailServerBaseUrl || '')],\n                    exception: e\n                });\n            }\n        } else {\n            experiments = {\n                name: experimentConnector.name,\n                experiments: experimentList\n            };\n        }\n    } else {\n        try {\n            experiments = await experimentConnector.provider.getExperiments(retailServerBaseUrl, experimentConnector.name, page, items);\n        } catch (e) {\n            (<IInternalTelemetry>res.locals.telemetry).log(LogLevel.Error, PROVIDER_GET_EXPERIMENTS_FAIL, {\n                values: [asSystemMetadata(retailServerBaseUrl || '')],\n                exception: e\n            });\n        }\n    }\n    return experiments || {};\n};\n\n/**\n * Method to process dapi request\n * @param req request object\n * @param res response object\n * @param next next function in the route chain\n */\nconst processDapiRequest = async (req: Request, res: Response, next: NextFunction) => {\n    if (!req.stale) {\n        return res.sendStatus(304);\n    }\n    let resultDefinition: unknown;\n    switch (req.params.resource) {\n        case DefinitionType.Modules:\n            resultDefinition = await getModuleDefinitions(req.query.type, res.locals.telemetry);\n\n            if (Array.isArray(resultDefinition) && resultDefinition.length > 0) {\n                resultDefinition = resultDefinition.filter(moduleDef => moduleDef.type !== THEME_MODULE.TYPE);\n            }\n            break;\n        case DefinitionType.ModuleList:\n            resultDefinition = await getModulesList();\n            break;\n        case DefinitionType.Styles:\n            resultDefinition = getStyles();\n            break;\n        case DefinitionType.Experiments:\n            const retailServerBaseUrl = <string>req.headers[RETAIL_SERVER_BASE_URL_HEADER_KEY];\n            resultDefinition = await getExperimentsWithCache(res, retailServerBaseUrl, req.query.page, req.query.items);\n            break;\n        case DefinitionType.AppSettings:\n            resultDefinition = msdyn365Commerce.appSettings;\n            break;\n        case DefinitionType.ImageSettings:\n            resultDefinition = msdyn365Commerce.imageSettings;\n            break;\n        case DefinitionType.ThemeSettings:\n            resultDefinition = msdyn365Commerce.themeSettings;\n            break;\n        case DefinitionType.Themes:\n            resultDefinition = await getThemeModules(req.query.type, res.locals.telemetry);\n            break;\n        case DefinitionType.ThemesList:\n            resultDefinition = await getThemeModulesList(res.locals.telemetry);\n            break;\n        case DefinitionType.Resources:\n            resultDefinition = msdyn365Commerce.resourceManager\n                ? msdyn365Commerce.resourceManager.getAuthoringResources()\n                : { error: `Resource manager is not defined` };\n            break;\n        default:\n            resultDefinition = { error: `type not defined [${req.params.resource}]` };\n            res.status(404);\n    }\n    return res.send(resultDefinition);\n};\n\n// tslint:disable-next-line:typedef max-func-body-length\nexport default function(server) {\n    const sdkRouter = express.Router();\n\n    sdkRouter.use((req: Request, res: Response, next: NextFunction): void => {\n        res.append('build-version', msdyn365Commerce.buildVersion);\n        res.setHeader('ETag', `\"${msdyn365Commerce.buildVersion}\"`);\n        res.setHeader('Cache-Control', 'max-age=3600, public');\n        next();\n    });\n    sdkRouter\n        // @TODO kopik: move test routes behind an env flag\n        // route to test that exceptions will be caught\n        .get(\n            '/test-throw',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                return throwHelper(req, res, next, 'test-throw');\n            })\n        )\n        // nested promise example\n        .get(\n            '/test-throw-nested',\n            safeRoute(async (req: Request, res: Response, next: NextFunction) => {\n                return (async (req2: Request, res2: Response, next2: NextFunction) => {\n                    return throwHelper(req, res, next, 'test-throw-2');\n                })(req, res, next);\n            })\n        )\n        .get('/test-timeout', async (req: Request, res: Response, next: NextFunction) => {\n            setTimeout(() => {\n                try {\n                    res.send('timeout exceeded');\n                } catch (e) {\n                    // eat the error silently in case we've already closed the connection\n                }\n                // tslint:disable-next-line:align\n            }, DEFAULT_REQUEST_TIMEOUT + 1000);\n        });\n\n    /**\n     * This route is for showing all registered routes and middleware in express. it's a raw dump,\n     * useful in debugging express\n     */\n    sdkRouter.get('/debug', async (req: Request, res: Response, next: NextFunction) => {\n        res.send({\n            ...server._router\n        });\n    });\n\n    // definition api routes\n    sdkRouter.get('/dapi/:resource', safeRoute(processDapiRequest));\n    sdkRouter.get('/allmodules', getAllModulesRouteParser());\n    // version route\n    sdkRouter.get('/version', (req: Request, res: Response) => {\n        res.sendFile(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);\n    });\n    // enabled features route\n    sdkRouter.get('/features', getFeatureFlagsJson());\n    sdkRouter.get('/yarn-lock', (req: Request, res: Response) => {\n        res.sendFile(keystonePaths.KEYSTONE_APP_YARN_LOCK);\n    });\n    sdkRouter.get('/registration/:resource', (req: Request, res: Response) => {\n        const bindings = (<IMSDyn365CommerceExtension>(<unknown>msdyn365Commerce)).bindings;\n        switch (req.params.resource) {\n            case 'views':\n                res.send(Object.keys(bindings.views || []));\n                break;\n            case 'components':\n                res.send(Object.keys(bindings.components || []));\n                break;\n            case 'modules':\n                // filter modules\n                res.send(\n                    Object.keys(bindings.modules || [])\n                        .map(key => bindings.modules[key])\n                        .filter(value => value.$type !== THEME_MODULE.TYPE)\n                        .map(val => {\n                            return {\n                                name: val.name,\n                                type: val.$type,\n                                packageName: val.packageName,\n                                moduleNamespace: val.moduleNamespace,\n                                isNodeModule: val.isNodeModule,\n                                dataActions: val.dataActions,\n                                parentDefinitionPath: val.parentDefinitionPath\n                            };\n                        })\n                );\n                break;\n            case 'themes':\n                // filter theme modules\n                res.send(\n                    Object.keys(bindings.modules || [])\n                        .map(key => bindings.modules[key])\n                        .filter(value => value.$type === THEME_MODULE.TYPE)\n                        .map(val => {\n                            return {\n                                name: val.name,\n                                packageName: val.packageName,\n                                moduleNamespace: val.moduleNamespace,\n                                isNodeModule: val.isNodeModule,\n                                definitionExtensions: val.definitionExtensions,\n                                views: Object.keys(bindings.views || []).filter(view => view.indexOf(`|${val.name}|views|`) > 0),\n                                components: Object.keys(bindings.components || []).filter(\n                                    component => component.indexOf(`|${val.name}|views|components|`) > 0\n                                ),\n                                themeSettings: val.themeSettings\n                            };\n                        })\n                );\n                break;\n            case 'data-actions':\n                res.send(Object.keys(bindings.dataActions || []));\n                break;\n            default:\n                const resultDefinition = { error: `type not defined [${req.params.resource}]` };\n                res.status(404);\n                return res.send(resultDefinition);\n        }\n    });\n\n    return sdkRouter;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}