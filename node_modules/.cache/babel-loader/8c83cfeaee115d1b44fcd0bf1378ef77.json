{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _assertThisInitialized from\"@babel/runtime/helpers/esm/assertThisInitialized\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{GetLoyaltyCardInput,issueLoyalty,IssueLoyaltyInput}from'@msdyn365-commerce-modules/retail-actions';import{getLoyaltyCardAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import{Button,getTelemetryObject}from'@msdyn365-commerce-modules/utilities';import{getUrlSync}from'@msdyn365-commerce/core';import classname from'classnames';import*as React from'react';import{LoyaltyTermsModal}from'./components/loyalty-terms-modal';var LoyaltyTerms=/*#__PURE__*/function(_React$Component){_inherits(LoyaltyTerms,_React$Component);var _super=_createSuper(LoyaltyTerms);function LoyaltyTerms(props){var _this;_classCallCheck(this,LoyaltyTerms);_this=_super.call(this,props);_this._toggle=_this._toggle.bind(_assertThisInitialized(_this));_this._submit=_this._submit.bind(_assertThisInitialized(_this));_this._checkboxChecked=_this._checkboxChecked.bind(_assertThisInitialized(_this));_this.toggleRef=/*#__PURE__*/React.createRef();_this.telemetryContent=getTelemetryObject(_this.props.context.request.telemetryPageName,_this.props.friendlyName,_this.props.telemetry);var search=_this.props.context.request.url.requestUrl.search;var isJoining=false;if(search){search=search.substring(1);var qsps=search.split('&');for(var i=0;i<qsps.length;i++){var splitQsp=qsps[i].split('=');isJoining=splitQsp[0]==='joiningLoyalty'&&splitQsp[1]==='true';if(isJoining){break;}}}_this.state={isModalOpen:isJoining,checked:false,clicked:false};return _this;}_createClass(LoyaltyTerms,[{key:\"render\",value:function render(){var _this$props=this.props,_this$props$config=_this$props.config,className=_this$props$config.className,hideToggle=_this$props$config.hideToggle,resources=_this$props.resources,serviceTerms=_this$props.slots.serviceTerms,loyaltyCard=_this$props.data.loyaltyCard,isAuthenticated=_this$props.context.request.user.isAuthenticated;var completeClass=classname('ms-loyalty-terms',className);var viewProps=_objectSpread(_objectSpread({},this.props),{},{className:completeClass,LoyaltyTerms:{moduleProps:this.props,className:completeClass},loading:loyaltyCard.status==='LOADING',modalToggle:hideToggle!==true&&/*#__PURE__*/React.createElement(Button,{className:'ms-loyalty-terms__toggle',onClick:this._toggle,innerRef:this.toggleRef},resources.joinLoyaltytermsToggleText),modal:isAuthenticated&&loyaltyCard.result&&loyaltyCard.result.CardNumber===undefined&&LoyaltyTermsModal({resources:_objectSpread({},resources),returnRef:this.toggleRef,checked:this.state.checked,isOpen:this.state.isModalOpen,terms:serviceTerms,telemetryContent:this.telemetryContent,onToggle:this._toggle,onSubmit:this._submit,onCheck:this._checkboxChecked})});return this.props.renderView(viewProps);}},{key:\"_toggle\",value:function _toggle(){this.setState({isModalOpen:!this.state.isModalOpen,checked:false});}},{key:\"_submit\",value:function _submit(){var _this2=this;if(this.props.context.request.user.isAuthenticated&&!this.state.clicked){this.setState({clicked:true});var input=new IssueLoyaltyInput(this.props.context.request.apiSettings);issueLoyalty(input,this.props.context.actionContext).then(function(card){if(_this2.props.config.redirectToLoyalty){window.location.assign(getUrlSync('loyalty',_this2.props.context.actionContext)||'');}else{getLoyaltyCardAsync({callerContext:_this2.props.context.actionContext},card.CardNumber||'').then(function(fullCard){_this2.props.context.actionContext.update(new GetLoyaltyCardInput(_this2.props.context.request.apiSettings),fullCard);})[\"catch\"](function(error){_this2.props.context.actionContext.update(new GetLoyaltyCardInput(_this2.props.context.request.apiSettings),card);_this2.props.telemetry.error(error.message);_this2.props.telemetry.debug('Unable to fetch loyalty card');});}})[\"catch\"](function(error){_this2.setState({clicked:false});_this2.props.telemetry.error(error.message);_this2.props.telemetry.debug('Unable to issue loyalty card');});}}},{key:\"_checkboxChecked\",value:function _checkboxChecked(){this.setState({checked:!this.state.checked});}}]);return LoyaltyTerms;}(React.Component);export default LoyaltyTerms;","map":{"version":3,"sources":["modules/loyalty-terms/loyalty-terms.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { GetLoyaltyCardInput, issueLoyalty, IssueLoyaltyInput } from '@msdyn365-commerce-modules/retail-actions';\nimport { getLoyaltyCardAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\n\nimport {\n    Button,\n    getTelemetryObject,\n    IModuleProps,\n    ITelemetryContent\n} from '@msdyn365-commerce-modules/utilities';\nimport { getUrlSync } from '@msdyn365-commerce/core';\nimport classname from 'classnames';\nimport * as React from 'react';\nimport {ILoyaltyTermsModalViewProps, LoyaltyTermsModal} from './components/loyalty-terms-modal';\nimport { ILoyaltyTermsData } from './loyalty-terms.data';\nimport { ILoyaltyTermsProps } from './loyalty-terms.props.autogenerated';\n\nexport interface ILoyaltyTermsState {\n    checked: boolean;\n    clicked: boolean;\n    isModalOpen: boolean;\n}\nexport interface ILoyaltyTermsViewProps extends ILoyaltyTermsProps<ILoyaltyTermsData> {\n    LoyaltyTerms: IModuleProps;\n    modalToggle: React.ReactElement;\n    modal: ILoyaltyTermsModalViewProps;\n    loading: boolean;\n}\n\n/**\n *\n * LoyaltyTerms component\n * @extends {React.Component<ILoyaltyTermsProps<ILoyaltyTermsData>>}\n */\nclass LoyaltyTerms extends React.Component<ILoyaltyTermsProps<ILoyaltyTermsData>, ILoyaltyTermsState> {\n    private toggleRef: React.RefObject<HTMLButtonElement>;\n    private telemetryContent: ITelemetryContent;\n\n    public constructor(props: ILoyaltyTermsProps<ILoyaltyTermsData>) {\n        super(props);\n        this._toggle = this._toggle.bind(this);\n        this._submit = this._submit.bind(this);\n        this._checkboxChecked = this._checkboxChecked.bind(this);\n        this.toggleRef = React.createRef();\n        this.telemetryContent = getTelemetryObject(this.props.context.request.telemetryPageName!, this.props.friendlyName, this.props.telemetry);\n        let search = this.props.context.request.url.requestUrl.search;\n        let isJoining = false;\n        if (search) {\n            search = search.substring(1);\n            const qsps = search.split('&');\n            for (let i = 0; i < qsps.length; i++) {\n                const splitQsp = qsps[i].split('=');\n                isJoining = splitQsp[0] === 'joiningLoyalty' && splitQsp[1] === 'true';\n                if(isJoining) {\n                    break;\n                }\n            }\n        }\n\n        this.state = {\n            isModalOpen: isJoining,\n            checked: false,\n            clicked: false\n        };\n    }\n\n    public render(): JSX.Element | null {\n        const {\n            config: { className, hideToggle },\n            resources,\n            slots: { serviceTerms },\n            data: { loyaltyCard },\n            context: {\n                request: {\n                    user: {\n                        isAuthenticated\n                    }\n                }\n            }\n        } = this.props;\n        const completeClass = classname('ms-loyalty-terms', className);\n\n        const viewProps = {\n            ...this.props,\n            className: completeClass,\n            LoyaltyTerms: {\n                moduleProps: this.props,\n                className: completeClass\n            },\n            loading: loyaltyCard.status === 'LOADING',\n            modalToggle: (hideToggle !== true) && <Button className='ms-loyalty-terms__toggle' onClick={this._toggle} innerRef={this.toggleRef}>{resources.joinLoyaltytermsToggleText}</Button>,\n            modal: isAuthenticated && loyaltyCard.result && loyaltyCard.result.CardNumber === undefined && LoyaltyTermsModal({\n                resources: {...resources},\n                returnRef: this.toggleRef,\n                checked: this.state.checked,\n                isOpen: this.state.isModalOpen,\n                terms: serviceTerms,\n                telemetryContent: this.telemetryContent,\n                onToggle: this._toggle,\n                onSubmit: this._submit,\n                onCheck: this._checkboxChecked\n            })\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    private _toggle(): void {\n        this.setState({isModalOpen: !this.state.isModalOpen, checked: false});\n    }\n\n    private _submit(): void {\n        if (this.props.context.request.user.isAuthenticated && !this.state.clicked) {\n            this.setState({ clicked: true });\n            const input = new IssueLoyaltyInput(this.props.context.request.apiSettings);\n\n            issueLoyalty(input, this.props.context.actionContext)\n                .then((card) => {\n                    if (this.props.config.redirectToLoyalty) {\n                        window.location.assign(getUrlSync('loyalty', this.props.context.actionContext) || '');\n                    } else {\n                        getLoyaltyCardAsync({ callerContext: this.props.context.actionContext }, card.CardNumber || '')\n                            .then((fullCard) => {\n                                this.props.context.actionContext.update(new GetLoyaltyCardInput(this.props.context.request.apiSettings), fullCard);\n                            })\n                            .catch((error: Error) => {\n                                this.props.context.actionContext.update(new GetLoyaltyCardInput(this.props.context.request.apiSettings), card);\n                                this.props.telemetry.error(error.message);\n                                this.props.telemetry.debug('Unable to fetch loyalty card');\n                            });\n                    }\n                })\n                .catch((error: Error) => {\n                    this.setState({ clicked: false });\n                    this.props.telemetry.error(error.message);\n                    this.props.telemetry.debug('Unable to issue loyalty card');\n                });\n        }\n    }\n\n    private _checkboxChecked(): void {\n        this.setState({checked: !this.state.checked});\n    }\n}\n\nexport default LoyaltyTerms;"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}