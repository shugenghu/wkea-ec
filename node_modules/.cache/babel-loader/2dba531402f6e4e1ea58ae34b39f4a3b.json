{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import{createObservableDataAction}from'@msdyn365-commerce/core';import{refineSearchByCategoryAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import getFullProducts,{FullProductInput,ProductDetailsCriteria}from'./get-full-products';import{QueryResultSettingsProxy}from'./utilities/QueryResultSettingsProxy';import{getProductDetailsCriteriaFromActionInput}from'./utilities/utils';/**\r\n * Refine search for full products input\r\n */export var FullProductsRefineSearchByCategoryInput=function FullProductsRefineSearchByCategoryInput(queryResultSettingsProxy,categoryId,channelId,refinementCriteria,catalogId,criteria){_classCallCheck(this,FullProductsRefineSearchByCategoryInput);this.getCacheKey=function(){return\"FullProductsRefineSearchByCategoryInputCache\";};this.getCacheObjectType=function(){return'FullProductsRefineSearchByCategoryInput';};this.dataCacheType=function(){return'none';};this.queryResultSettingsProxy=queryResultSettingsProxy;this.categoryId=categoryId;this.channelId=channelId;this.refinementCriteria=refinementCriteria||[];this.catalogId=catalogId||0;this.ProductDetailsCriteria=criteria;};/**\r\n * Creates the input required to make the core action calls\r\n */export var createFullProductsRefineSearchByCategoryInput=function createFullProductsRefineSearchByCategoryInput(inputData){var refinementCriteria=inputData.config&&inputData.config.refinementCriteria;var queryResultSettingsProxy=QueryResultSettingsProxy.fromInputData(inputData);if(!Array.isArray(refinementCriteria)){return new FullProductsRefineSearchByCategoryInput(queryResultSettingsProxy);}if(inputData&&inputData.requestContext&&inputData.requestContext.query&&inputData.requestContext.query.categoryId){var categoryId=Number(inputData.requestContext.query.categoryId);var channelId=inputData.requestContext.apiSettings.channelId;var catalogId=inputData.requestContext.apiSettings.catalogId;var productDetailsCriteria=getProductDetailsCriteriaFromActionInput(inputData);return new FullProductsRefineSearchByCategoryInput(queryResultSettingsProxy,categoryId,+channelId,refinementCriteria,catalogId,productDetailsCriteria);}throw new Error('Please specify categoryId, refinerId, and refinerSourceValue query string in request.');};/**\r\n * Calls the refine-search-by-category action.\r\n * Based on search result calls get-full-products to get all the product details.\r\n */export function getFullProductsByRefineSearchCategoryAction(_x,_x2){return _getFullProductsByRefineSearchCategoryAction.apply(this,arguments);}function _getFullProductsByRefineSearchCategoryAction(){_getFullProductsByRefineSearchCategoryAction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var hasSortingColumn,apiSettings,refinementCriteria,fullProductInputs,productResult;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!input||!input.refinementCriteria)){_context.next=3;break;}ctx.trace('[getFullProductsByRefineSearchCategoryAction] Invalid input.');return _context.abrupt(\"return\",{});case 3:hasSortingColumn=input.queryResultSettingsProxy.QueryResultSettings&&input.queryResultSettingsProxy.QueryResultSettings.Sorting&&input.queryResultSettingsProxy.QueryResultSettings.Sorting.Columns&&input.queryResultSettingsProxy.QueryResultSettings.Sorting.Columns.length>0;if(!(!input.refinementCriteria.length&&!hasSortingColumn)){_context.next=7;break;}ctx.telemetry.trace('[getFullProductsByRefineSearchCategoryAction] No refiners or sorting specified.');return _context.abrupt(\"return\",{});case 7:apiSettings=ctx.requestContext.apiSettings;refinementCriteria=[];_context.next=11;return refineSearchByCategoryAsync({callerContext:ctx,queryResultSettings:input.queryResultSettingsProxy.QueryResultSettings},input.channelId||0,input.catalogId,input.categoryId||0,input.refinementCriteria).then(function(searchResults){refinementCriteria=input.refinementCriteria;return searchResults.map(function(product){return new FullProductInput(product.RecordId,apiSettings,input.ProductDetailsCriteria||new ProductDetailsCriteria());});});case 11:fullProductInputs=_context.sent;if(!(fullProductInputs.length>0)){_context.next=19;break;}_context.next=15;return getFullProducts(fullProductInputs,ctx);case 15:productResult=_context.sent;return _context.abrupt(\"return\",{productSearchResult:productResult,refinementCriteria:refinementCriteria});case 19:return _context.abrupt(\"return\",{productSearchResult:[],refinementCriteria:refinementCriteria});case 20:case\"end\":return _context.stop();}}},_callee);}));return _getFullProductsByRefineSearchCategoryAction.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/get-full-products-by-refine-search-category',action:getFullProductsByRefineSearchCategoryAction,input:createFullProductsRefineSearchByCategoryInput,isBatched:false});","map":{"version":3,"sources":["../../src/get-full-products-by-refine-search-category.ts"],"names":[],"mappings":"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","sourcesContent":["import { FullProduct, IRefineFullProductSearchOutput } from '@msdyn365-commerce/commerce-entities';\nimport { CacheType, IAction, IActionInput } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IActionContext, IAny, ICreateActionContext, IGeneric } from '@msdyn365-commerce/core';\nimport { ProductRefinerValue, ProductSearchResult } from '@msdyn365-commerce/retail-proxy';\nimport { refineSearchByCategoryAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport getFullProducts, { FullProductInput, ProductDetailsCriteria } from './get-full-products';\nimport { QueryResultSettingsProxy } from './utilities/QueryResultSettingsProxy';\nimport { getProductDetailsCriteriaFromActionInput } from './utilities/utils';\n\n/**\n * Refine search for full products input\n */\nexport class FullProductsRefineSearchByCategoryInput implements IActionInput {\n    public readonly categoryId?: number;\n    public readonly channelId?: number;\n    public readonly refinementCriteria: ProductRefinerValue[];\n    public readonly catalogId: number;\n    public ProductDetailsCriteria?: ProductDetailsCriteria;\n    public readonly queryResultSettingsProxy: QueryResultSettingsProxy;\n\n    constructor(\n        queryResultSettingsProxy: QueryResultSettingsProxy,\n        categoryId?: number,\n        channelId?: number,\n        refinementCriteria?: ProductRefinerValue[],\n        catalogId?: number,\n        criteria?: ProductDetailsCriteria\n\n    ) {\n        this.queryResultSettingsProxy = queryResultSettingsProxy;\n        this.categoryId = categoryId;\n        this.channelId = channelId;\n        this.refinementCriteria = refinementCriteria || [];\n        this.catalogId = catalogId || 0;\n        this.ProductDetailsCriteria = criteria;\n    }\n\n    public getCacheKey = () => `FullProductsRefineSearchByCategoryInputCache`;\n    public getCacheObjectType = () => 'FullProductsRefineSearchByCategoryInput';\n    public dataCacheType = (): CacheType => 'none';\n}\n\n/**\n * Creates the input required to make the core action calls\n */\nexport const createFullProductsRefineSearchByCategoryInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    const refinementCriteria = inputData.config && inputData.config.refinementCriteria;\n    const queryResultSettingsProxy = QueryResultSettingsProxy.fromInputData(inputData);\n    if (!Array.isArray(refinementCriteria)) {\n        return new FullProductsRefineSearchByCategoryInput(queryResultSettingsProxy);\n    }\n\n    if (inputData && inputData.requestContext && inputData.requestContext.query && inputData.requestContext.query.categoryId) {\n        const categoryId = Number(inputData.requestContext.query.categoryId);\n        const channelId = inputData.requestContext.apiSettings.channelId;\n        const catalogId = inputData.requestContext.apiSettings.catalogId;\n        const productDetailsCriteria = getProductDetailsCriteriaFromActionInput(inputData);\n        return new FullProductsRefineSearchByCategoryInput(\n            queryResultSettingsProxy,\n            categoryId,\n            +channelId,\n            refinementCriteria,\n            catalogId,\n            productDetailsCriteria\n        );\n    }\n\n    throw new Error('Please specify categoryId, refinerId, and refinerSourceValue query string in request.');\n};\n\n/**\n * Calls the refine-search-by-category action.\n * Based on search result calls get-full-products to get all the product details.\n */\nexport async function getFullProductsByRefineSearchCategoryAction(\n    input: FullProductsRefineSearchByCategoryInput,\n    ctx: IActionContext\n): Promise<IRefineFullProductSearchOutput> {\n    if (!input || !input.refinementCriteria) {\n        ctx.trace('[getFullProductsByRefineSearchCategoryAction] Invalid input.');\n        return <IRefineFullProductSearchOutput>{};\n    }\n\n    const hasSortingColumn = input.queryResultSettingsProxy.QueryResultSettings &&\n        input.queryResultSettingsProxy.QueryResultSettings.Sorting &&\n        input.queryResultSettingsProxy.QueryResultSettings.Sorting.Columns &&\n        input.queryResultSettingsProxy.QueryResultSettings.Sorting.Columns.length > 0;\n    if (!input.refinementCriteria.length && !hasSortingColumn) {\n        ctx.telemetry.trace('[getFullProductsByRefineSearchCategoryAction] No refiners or sorting specified.');\n        return <IRefineFullProductSearchOutput>{};\n    }\n    const { apiSettings } = ctx.requestContext;\n\n    let refinementCriteria: ProductRefinerValue[] = [];\n    const fullProductInputs = await refineSearchByCategoryAsync(\n        { callerContext: ctx, queryResultSettings:  input.queryResultSettingsProxy.QueryResultSettings },\n        input.channelId || 0,\n        input.catalogId,\n        input.categoryId || 0,\n        input.refinementCriteria\n        ).then(searchResults => {\n            refinementCriteria = input.refinementCriteria;\n            return searchResults.map(\n                (product: ProductSearchResult): FullProductInput => {\n                    return new FullProductInput(product.RecordId, apiSettings, input.ProductDetailsCriteria || new ProductDetailsCriteria());\n                }\n            );\n        });\n\n    if (fullProductInputs.length > 0) {\n        const productResult = await <Promise<FullProduct[]>>getFullProducts(fullProductInputs, ctx);\n        return {\n            productSearchResult: productResult,\n            refinementCriteria: refinementCriteria\n        };\n    } else {\n        return {\n            productSearchResult: [],\n            refinementCriteria: refinementCriteria\n        };\n    }\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-full-products-by-refine-search-category',\n    action: <IAction<IRefineFullProductSearchOutput>>getFullProductsByRefineSearchCategoryAction,\n    input: createFullProductsRefineSearchByCategoryInput,\n    isBatched: false\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}