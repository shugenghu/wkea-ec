{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import*as React from'react';import{getGiftCardAsync,getTenderTypesAsync,resolveCardTypesAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import classname from'classnames';import{OPERATIONS}from'../checkout';import{getForm}from'./components/get-form';import{getItem}from'./components/get-item';export var GiftCardBalanceCheck=/*#__PURE__*/function(_React$Component){_inherits(GiftCardBalanceCheck,_React$Component);var _super=_createSuper(GiftCardBalanceCheck);function GiftCardBalanceCheck(){var _this;_classCallCheck(this,GiftCardBalanceCheck);_this=_super.apply(this,arguments);_this.state={isFetchingGiftCard:false,errorMessage:'',giftCardNumber:'',giftCardPin:'',giftCardExp:''};_this.inputRef=/*#__PURE__*/React.createRef();_this.inputPinRef=/*#__PURE__*/React.createRef();_this.inputExpRef=/*#__PURE__*/React.createRef();_this._isEnabled=function(){if(!_this.props.context.request.user.isAuthenticated&&_this.props.context.app.config.giftCardSupported!==\"external\"){return false;}return true;};_this._getFormattedPrice=function(){var price=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var currencyCode=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'USD';return _this.props.context.cultureFormatter.formatCurrency(price,currencyCode);};_this._enterGiftCardNumber=function(giftCardNumber){_this.setState({giftCardNumber:giftCardNumber});_this._clearError();};_this._enterGiftCardPin=function(giftCardPin){_this.setState({giftCardPin:giftCardPin});_this._clearError();};_this._enterGiftCardExp=function(giftCardExp){_this.setState({giftCardExp:giftCardExp});_this._clearError();};_this._clearError=function(){_this.setState({errorMessage:''});};_this._setError=function(errorMessage){_this.props.telemetry.error('Error',errorMessage);_this.props.telemetry.debug('Error',errorMessage);_this.setState({errorMessage:errorMessage});};_this._applyGiftCard=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var giftCardNumber,giftCardPin,giftCardExp,giftCardTypes,giftCardType,isPinRequired,isExpRequired,tenderTypeId,giftCard,input;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!_this.state.isFetchingGiftCard){_context.next=2;break;}return _context.abrupt(\"return\");case 2:_this.setState({isFetchingGiftCard:true});giftCardNumber=_this.state.giftCardNumber.trim();giftCardPin=_this.state.giftCardPin.trim();giftCardExp=_this.state.giftCardExp.trim();_context.next=8;return _this._getGiftCardTypes(giftCardNumber);case 8:giftCardTypes=_context.sent;giftCardType=giftCardTypes&&giftCardTypes[0];isPinRequired=giftCardType&&giftCardType.IsPinRequired;isExpRequired=giftCardType&&giftCardType.IsExpirationDateRequired;tenderTypeId=giftCardType&&giftCardType.PaymentMethodId;_context.next=15;return _this._getGiftCard(giftCardNumber,giftCardPin,giftCardExp,isPinRequired,isExpRequired,tenderTypeId);case 15:giftCard=_context.sent;if(!giftCard){_context.next=22;break;}_this._clearError();_this.setState({giftCardNumber:'',giftCardPin:'',giftCardExp:'',isFetchingGiftCard:false,giftCard:giftCard});return _context.abrupt(\"return\",Promise.resolve());case 22:input=_this.inputRef&&_this.inputRef.current&&_this.inputRef.current.focus&&_this.inputRef.current;input&&input.focus();_this.setState({isFetchingGiftCard:false,giftCard:undefined});case 25:case\"end\":return _context.stop();}}},_callee);}));_this._findGiftcardTenderTypes=function(tenderTypes,operationId,giftcardType){var matchedTenderTypes;switch(giftcardType){case\"internal\":matchedTenderTypes=tenderTypes.filter(function(tenderType){return tenderType.OperationId===operationId&&tenderType.ConnectorId==='';});break;case\"external\":matchedTenderTypes=tenderTypes.filter(function(tenderType){return tenderType.OperationId===operationId&&tenderType.ConnectorId!=='';});break;default:throw new Error('Invalid gift card type');}if(matchedTenderTypes){return matchedTenderTypes.map(function(tenderType){return tenderType.TenderTypeId||'';});}return;};_this._getGiftCard=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(giftCardNumber,giftCardPin,giftCardExp,isPinRequired,isExpRequired,tenderTypeId){var _this$props$resources,invalidCardTypeError,noBalanceError,invalidCardInfoError,noCardPinError,noCardExpError,supportedGiftCardType,tenderTypes,internalGiftcardTenderTypes,externalGiftcardTenderTypes,month,year;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this$props$resources=_this.props.resources,invalidCardTypeError=_this$props$resources.invalidCardTypeError,noBalanceError=_this$props$resources.noBalanceError,invalidCardInfoError=_this$props$resources.invalidCardInfoError,noCardPinError=_this$props$resources.noCardPinError,noCardExpError=_this$props$resources.noCardExpError;supportedGiftCardType=_this.props.context.app.config.giftCardSupported;if(tenderTypeId){_context2.next=4;break;}return _context2.abrupt(\"return\",undefined);case 4:_context2.next=6;return getTenderTypesAsync({callerContext:_this.props.context.actionContext,queryResultSettings:{}})[\"catch\"](function(error){throw error;});case 6:tenderTypes=_context2.sent;if(tenderTypes){_context2.next=9;break;}throw new Error('Fail to get gift card tender line');case 9:internalGiftcardTenderTypes=_this._findGiftcardTenderTypes(tenderTypes,OPERATIONS.PayGiftCertificate,\"internal\");externalGiftcardTenderTypes=_this._findGiftcardTenderTypes(tenderTypes,OPERATIONS.PayGiftCertificate,\"external\");_context2.t0=supportedGiftCardType;_context2.next=_context2.t0===undefined?14:_context2.t0===\"internal\"?14:_context2.t0===\"external\"?18:_context2.t0===\"both\"?22:26;break;case 14:if(internalGiftcardTenderTypes!==null&&internalGiftcardTenderTypes!==void 0&&internalGiftcardTenderTypes.includes(tenderTypeId)){_context2.next=17;break;}_this._setError(invalidCardTypeError);return _context2.abrupt(\"return\",undefined);case 17:return _context2.abrupt(\"break\",27);case 18:if(externalGiftcardTenderTypes!==null&&externalGiftcardTenderTypes!==void 0&&externalGiftcardTenderTypes.includes(tenderTypeId)){_context2.next=21;break;}_this._setError(invalidCardTypeError);return _context2.abrupt(\"return\",undefined);case 21:return _context2.abrupt(\"break\",27);case 22:if(!(!(internalGiftcardTenderTypes!==null&&internalGiftcardTenderTypes!==void 0&&internalGiftcardTenderTypes.includes(tenderTypeId))&&!(externalGiftcardTenderTypes!==null&&externalGiftcardTenderTypes!==void 0&&externalGiftcardTenderTypes.includes(tenderTypeId)))){_context2.next=25;break;}_this._setError(invalidCardTypeError);return _context2.abrupt(\"return\",undefined);case 25:return _context2.abrupt(\"break\",27);case 26:throw new Error('Unsupported gift card type');case 27:if(!(!_this.props.context.request.user.isAuthenticated&&internalGiftcardTenderTypes!==null&&internalGiftcardTenderTypes!==void 0&&internalGiftcardTenderTypes.includes(tenderTypeId))){_context2.next=30;break;}_this._setError(invalidCardTypeError);return _context2.abrupt(\"return\",undefined);case 30:if(!(isPinRequired&&giftCardPin==='')){_context2.next=33;break;}_this._setError(noCardPinError);return _context2.abrupt(\"return\",undefined);case 33:if(!(isExpRequired&&giftCardExp==='')){_context2.next=36;break;}_this._setError(noCardExpError);return _context2.abrupt(\"return\",undefined);case 36:month=parseInt(giftCardExp.split('/')[0],10);year=parseInt(giftCardExp.split('/')[1],10);return _context2.abrupt(\"return\",getGiftCardAsync({callerContext:_this.props.context.actionContext},giftCardNumber,tenderTypeId,giftCardPin,month,year).then(function(activeGiftCard){if(!activeGiftCard.Balance||activeGiftCard.Balance===0){_this._setError(noBalanceError);return;}return activeGiftCard;})[\"catch\"](function(error){_this._setError(invalidCardInfoError);return undefined;}));case 39:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x,_x2,_x3,_x4,_x5,_x6){return _ref2.apply(this,arguments);};}();_this._getGiftCardTypes=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(giftCardNumber){var _this$props$resources2,emptyInputError,invalidCodeError,GIFTCARDTYPE;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_this$props$resources2=_this.props.resources,emptyInputError=_this$props$resources2.emptyInputError,invalidCodeError=_this$props$resources2.invalidCodeError;if(giftCardNumber){_context3.next=4;break;}_this._setError(emptyInputError);return _context3.abrupt(\"return\",undefined);case 4:GIFTCARDTYPE=7;return _context3.abrupt(\"return\",resolveCardTypesAsync({callerContext:_this.props.context.actionContext},giftCardNumber,GIFTCARDTYPE).then(function(giftCardTypes){if(!giftCardTypes||giftCardTypes.length===0||giftCardTypes[0]===undefined){_this._setError(invalidCodeError);return;}return giftCardTypes;})[\"catch\"](function(error){_this._setError(invalidCodeError);return undefined;}));case 6:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x7){return _ref3.apply(this,arguments);};}();return _this;}_createClass(GiftCardBalanceCheck,[{key:\"render\",value:function render(){var _this$props=this.props,_this$props$config=_this$props.config,className=_this$props$config.className,showAdditionalFields=_this$props$config.showAdditionalFields,resources=_this$props.resources;var _this$state=this.state,errorMessage=_this$state.errorMessage,giftCardNumber=_this$state.giftCardNumber,giftCardPin=_this$state.giftCardPin,giftCardExp=_this$state.giftCardExp;var supportedGiftCardType=this.props.context.app.config.giftCardSupported;if(!this._isEnabled()){this.props.context.telemetry.error('Gift card balance check is not supported, module wont render');return null;}var supportExternalGiftCard=supportedGiftCardType===\"internal\"?false:true;var moduleClassName=classname('ms-gift-card-balance-check',className);var viewProps=_objectSpread(_objectSpread(_objectSpread({},this.props),this.state),{},{className:moduleClassName,giftCardBalanceCheckProps:{moduleProps:this.props,className:moduleClassName},enterGiftCardNumber:this._enterGiftCardNumber,enterGiftCardPin:this._enterGiftCardPin,enterGiftCardExp:this._enterGiftCardExp,applyGiftCard:this._applyGiftCard,form:getForm({errorMessage:errorMessage,giftCardNumber:giftCardNumber,giftCardPin:giftCardPin,giftCardExp:giftCardExp,inputRef:this.inputRef,inputPinRef:this.inputPinRef,inputExpRef:this.inputExpRef,resources:resources,supportExternalGiftCard:supportExternalGiftCard,additionalFields:showAdditionalFields,onEnterGiftCardNumber:this._enterGiftCardNumber,onEnterGiftCardPin:this._enterGiftCardPin,onEnterGiftCardExp:this._enterGiftCardExp,onApplyGiftCard:this._applyGiftCard}),item:this.state.giftCard&&getItem({giftCard:this.state.giftCard,getFormattedPrice:this._getFormattedPrice,resources:resources})});return this.props.renderView(viewProps);}}]);return GiftCardBalanceCheck;}(React.Component);export default GiftCardBalanceCheck;","map":{"version":3,"sources":["modules/gift-card-balance-check/gift-card-balance-check.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as React from 'react';\n\nimport { IModuleProps } from '@msdyn365-commerce-modules/utilities';\nimport { getGiftCardAsync, getTenderTypesAsync, resolveCardTypesAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport {\n    CardType, CardTypeInfo, GiftCard, RetailOperation, TenderType\n} from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport classname from 'classnames';\nimport { OPERATIONS } from '../checkout';\nimport { getForm, IForm } from './components/get-form';\nimport { getItem, IItem } from './components/get-item';\nimport { IGiftCardBalanceCheckProps } from './gift-card-balance-check.props.autogenerated';\n\ninterface IGiftCardBalanceCheckState {\n    isFetchingGiftCard: boolean;\n    errorMessage: string;\n    giftCardNumber: string;\n    giftCardPin: string;\n    giftCardExp: string;\n    giftCard?: GiftCard;\n}\n\nconst enum SupportedGiftCardType {\n    Internal = 'internal',\n    External = 'external',\n    Both = 'both'\n}\n\nexport interface IGiftCardBalanceCheckModuleProps extends IGiftCardBalanceCheckProps<{}> { }\n\nexport interface IGiftCardBalanceCheckViewProps extends IGiftCardBalanceCheckProps<{}>, IGiftCardBalanceCheckState {\n    className?: string;\n\n    form: IForm;\n    item?: IItem;\n\n    giftCardBalanceCheckProps: IModuleProps;\n\n    enterGiftCardNumber?(giftCardNumber: string): void;\n    enterGiftCardPin?(giftCardPin: string): void;\n    enterGiftCardExp?(giftCardExp: string): void;\n    applyGiftCard?(): void;\n}\n\n/**\n *\n * GiftCardBalanceCheck component\n * @extends {React.Component<IGiftCardBalanceCheckModuleProps, IGiftCardBalanceCheckState>}\n */\nexport class GiftCardBalanceCheck extends React.Component<IGiftCardBalanceCheckModuleProps, IGiftCardBalanceCheckState> {\n    public state: IGiftCardBalanceCheckState = {\n        isFetchingGiftCard: false,\n        errorMessage: '',\n        giftCardNumber: '',\n        giftCardPin: '',\n        giftCardExp: ''\n    };\n\n    private inputRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    private inputPinRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    private inputExpRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    public render(): JSX.Element | null {\n        const {\n            config: { className, showAdditionalFields },\n            resources\n        } = this.props;\n        const { errorMessage, giftCardNumber, giftCardPin, giftCardExp } = this.state;\n\n        const supportedGiftCardType = this.props.context.app.config.giftCardSupported;\n\n        if (!this._isEnabled()) {\n            this.props.context.telemetry.error('Gift card balance check is not supported, module wont render');\n            return null;\n        }\n\n        const supportExternalGiftCard = supportedGiftCardType === SupportedGiftCardType.Internal ? false : true;\n\n        const moduleClassName = classname('ms-gift-card-balance-check', className);\n\n        const viewProps: IGiftCardBalanceCheckViewProps = {\n            ...this.props,\n            ...this.state,\n            className: moduleClassName,\n            giftCardBalanceCheckProps: { moduleProps: this.props, className: moduleClassName },\n\n            enterGiftCardNumber: this._enterGiftCardNumber,\n            enterGiftCardPin: this._enterGiftCardPin,\n            enterGiftCardExp: this._enterGiftCardExp,\n            applyGiftCard: this._applyGiftCard,\n\n            form: getForm({\n                errorMessage,\n                giftCardNumber,\n                giftCardPin,\n                giftCardExp,\n                inputRef: this.inputRef,\n                inputPinRef: this.inputPinRef,\n                inputExpRef: this.inputExpRef,\n                resources,\n                supportExternalGiftCard,\n                additionalFields: showAdditionalFields,\n                onEnterGiftCardNumber: this._enterGiftCardNumber,\n                onEnterGiftCardPin: this._enterGiftCardPin,\n                onEnterGiftCardExp: this._enterGiftCardExp,\n                onApplyGiftCard: this._applyGiftCard\n            }),\n            item: this.state.giftCard && getItem({\n                giftCard: this.state.giftCard,\n                getFormattedPrice: this._getFormattedPrice,\n                resources\n            })\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    private _isEnabled = (): boolean => {\n        if (!this.props.context.request.user.isAuthenticated && this.props.context.app.config.giftCardSupported !== SupportedGiftCardType.External) {\n            return false;\n        }\n        return true;\n    };\n\n    private _getFormattedPrice = (price: number = 0, currencyCode: string = 'USD'): string => {\n        return this.props.context.cultureFormatter.formatCurrency(price, currencyCode);\n    };\n\n    private _enterGiftCardNumber = (giftCardNumber: string): void => {\n        this.setState({\n            giftCardNumber\n        });\n        this._clearError();\n    }\n\n    private _enterGiftCardPin = (giftCardPin: string): void => {\n        this.setState({\n            giftCardPin\n        });\n        this._clearError();\n    };\n\n    private _enterGiftCardExp = (giftCardExp: string): void => {\n        this.setState({\n            giftCardExp\n        });\n        this._clearError();\n    };\n\n    private _clearError = (): void => {\n        this.setState({\n            errorMessage: ''\n        });\n    };\n\n    private _setError = (errorMessage: string): void => {\n        this.props.telemetry.error('Error', errorMessage);\n        this.props.telemetry.debug('Error', errorMessage);\n        this.setState({\n            errorMessage\n        });\n    };\n\n    private _applyGiftCard = async (): Promise<void> => {\n        if (this.state.isFetchingGiftCard) {\n            return;\n        }\n        this.setState({\n            isFetchingGiftCard: true\n        });\n\n        const giftCardNumber = this.state.giftCardNumber.trim();\n        const giftCardPin = this.state.giftCardPin.trim();\n        const giftCardExp = this.state.giftCardExp.trim();\n\n        const giftCardTypes = await this._getGiftCardTypes(giftCardNumber);\n        const giftCardType = giftCardTypes && giftCardTypes[0];\n        const isPinRequired = giftCardType && giftCardType.IsPinRequired;\n        const isExpRequired = giftCardType && giftCardType.IsExpirationDateRequired;\n        const tenderTypeId = giftCardType && giftCardType.PaymentMethodId;\n        const giftCard = await this._getGiftCard(giftCardNumber, giftCardPin, giftCardExp, isPinRequired, isExpRequired, tenderTypeId);\n\n        if (giftCard) {\n            this._clearError();\n            this.setState({\n                giftCardNumber: '',\n                giftCardPin: '',\n                giftCardExp: '',\n                isFetchingGiftCard: false,\n                giftCard: giftCard\n            });\n            return Promise.resolve();\n        } else {\n            const input =\n                this.inputRef && this.inputRef.current && this.inputRef.current.focus && (this.inputRef.current as HTMLElement);\n            input && input.focus();\n            this.setState({\n                isFetchingGiftCard: false,\n                giftCard: undefined\n            });\n        }\n    };\n\n    private _findGiftcardTenderTypes = (tenderTypes: TenderType[], operationId: RetailOperation, giftcardType: string): string[] | undefined => {\n        let matchedTenderTypes: TenderType[] | undefined;\n\n        switch (giftcardType) {\n            case SupportedGiftCardType.Internal:\n                matchedTenderTypes = tenderTypes.filter(tenderType => (tenderType.OperationId === operationId && tenderType.ConnectorId === ''));\n                break;\n            case SupportedGiftCardType.External:\n                matchedTenderTypes = tenderTypes.filter(tenderType => (tenderType.OperationId === operationId && tenderType.ConnectorId !== ''));\n                break;\n            default:\n                throw new Error('Invalid gift card type');\n        }\n\n        if (matchedTenderTypes) {\n            return matchedTenderTypes.map(tenderType => tenderType.TenderTypeId || '');\n        }\n        return;\n    };\n\n    private _getGiftCard = async (giftCardNumber: string, giftCardPin: string, giftCardExp: string, isPinRequired: boolean | undefined, isExpRequired: boolean | undefined, tenderTypeId: string | undefined): Promise<GiftCard | undefined> => {\n        const {\n            resources: { invalidCardTypeError, noBalanceError, invalidCardInfoError, noCardPinError, noCardExpError }\n        } = this.props;\n\n        const supportedGiftCardType = this.props.context.app.config.giftCardSupported;\n\n        if (!tenderTypeId) {\n            return undefined;\n        }\n\n        const tenderTypes = await getTenderTypesAsync({ callerContext: this.props.context.actionContext, queryResultSettings: {} }).catch(error => {\n            throw error;\n        });\n\n        if (!tenderTypes) {\n            throw new Error('Fail to get gift card tender line');\n        }\n\n        const internalGiftcardTenderTypes = this._findGiftcardTenderTypes(tenderTypes, OPERATIONS.PayGiftCertificate, SupportedGiftCardType.Internal);\n        const externalGiftcardTenderTypes = this._findGiftcardTenderTypes(tenderTypes, OPERATIONS.PayGiftCertificate, SupportedGiftCardType.External);\n\n        switch (supportedGiftCardType) {\n            case undefined:\n            case SupportedGiftCardType.Internal:\n                if (!internalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this._setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            case SupportedGiftCardType.External:\n                if (!externalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this._setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            case SupportedGiftCardType.Both:\n                if (!internalGiftcardTenderTypes?.includes(tenderTypeId) && !externalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this._setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            default:\n                throw new Error('Unsupported gift card type');\n        }\n\n        if (!this.props.context.request.user.isAuthenticated && internalGiftcardTenderTypes?.includes(tenderTypeId)) {\n            this._setError(invalidCardTypeError);\n            return undefined;\n        }\n\n        if (isPinRequired && giftCardPin === '') {\n            this._setError(noCardPinError);\n            return undefined;\n        }\n\n        if (isExpRequired && giftCardExp === '') {\n            this._setError(noCardExpError);\n            return undefined;\n        }\n\n        const month = parseInt(giftCardExp.split('/')[0], 10);\n        const year = parseInt(giftCardExp.split('/')[1], 10);\n\n        return getGiftCardAsync({ callerContext: this.props.context.actionContext }, giftCardNumber, tenderTypeId, giftCardPin, month, year)\n            .then(activeGiftCard => {\n                if (!activeGiftCard.Balance || activeGiftCard.Balance === 0) {\n                    this._setError(noBalanceError);\n                    return;\n                }\n                return activeGiftCard;\n            })\n            .catch(error => {\n                this._setError(invalidCardInfoError);\n                return undefined;\n            });\n    };\n\n    private _getGiftCardTypes = async (giftCardNumber: string): Promise<CardTypeInfo[] | undefined> => {\n        const {\n            resources: { emptyInputError, invalidCodeError },\n        } = this.props;\n\n        if (!giftCardNumber) {\n            this._setError(emptyInputError);\n            return undefined;\n        }\n\n        const GIFTCARDTYPE =  7 as CardType.GiftCard; // This is a workaround. ts-jest doesn't support 'const enum'\n        return resolveCardTypesAsync({ callerContext: this.props.context.actionContext }, giftCardNumber, GIFTCARDTYPE)\n            .then(giftCardTypes => {\n                if (!giftCardTypes || giftCardTypes.length === 0 || giftCardTypes[0] === undefined) {\n                    this._setError(invalidCodeError);\n                    return;\n                }\n                return giftCardTypes;\n            })\n            .catch(error => {\n                this._setError(invalidCodeError);\n                return undefined;\n            });\n    };\n}\n\nexport default GiftCardBalanceCheck;\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}