{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/web.dom-collections.iterator.js\";import{createObservableDataAction}from'@msdyn365-commerce/core';import{getCartState}from'@msdyn365-commerce/global-state';import{issueLoyaltyCardAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import{getLoyaltyAction,GetLoyaltyCardInput}from'./get-loyalty-card';import{buildCacheKey}from'./index';/**\r\n *  Input class for the issueLoyalty data action\r\n */export class IssueLoyaltyInput{constructor(apiSettings,userAccountNumber){this.getCacheKey=()=>buildCacheKey(\"IssueLoyalty-\".concat(this.userAccountNumber),this.apiSettings);this.getCacheObjectType=()=>'GetIssueLoyalty';this.dataCacheType=()=>'request';this.userAccountNumber=userAccountNumber;this.apiSettings=apiSettings;}}/**\r\n * createInput method for the issueLoyalty method\r\n * @param inputData The input data passed to the createInput method\r\n */export const createIssueLoyaltyInput=inputData=>{const{requestContext}=inputData;if(!requestContext.user.isAuthenticated){throw new Error('Unable to create issue loyalty input.  User is not authenticated.');}return new IssueLoyaltyInput(inputData.requestContext.apiSettings);};/**\r\n * The action method for the issueLoyalty data action\r\n * @param input The action input\r\n * @param ctx The action context\r\n */export async function issueLoyaltyAction(input,ctx){const promises=[getCartState(ctx),_getLoyalty(input,ctx)];return Promise.all(promises).then(result=>{const cartState=result[0];const card=result[1];if(card&&card.CardNumber){updateCart(cartState,card);return card;}//@ts-ignore\n//TO-DO: Remove after SDK bug fix https://msdyneng.visualstudio.com/FinOps/_workitems/edit/473891\nreturn issueLoyaltyCardAsync({callerContext:ctx},{CustomerAccount:input.userAccountNumber||null}).then(issuedCard=>{updateCart(cartState,issuedCard);return issuedCard;})//@ts-ignore\n.catch(error=>{ctx.telemetry.exception(error);ctx.telemetry.debug('Issuing loyalty card failed');throw new Error('Issuing loyalty card failed');});}).catch(error=>{ctx.telemetry.exception(error);ctx.telemetry.debug('Unable to issue loyalty card');throw new Error('Unable to issue loyalty card');});}async function _getLoyalty(input,ctx){const loyaltyCardInput=new GetLoyaltyCardInput(input.apiSettings);return getLoyaltyAction(loyaltyCardInput,ctx);}function updateCart(cartState,card){cartState.updateLoyaltyCardId({loyaltyCardNumber:card.CardNumber});}/**\r\n * The getLoyaltyCard data action\r\n * Returns the loyalty card belonging to the customer\r\n */export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/issue-loyalty',action:issueLoyaltyAction,input:createIssueLoyaltyInput});","map":{"version":3,"sources":["../../src/issue-loyalty.ts"],"names":[],"mappings":"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","sourcesContent":["import { CacheType, createObservableDataAction, IAction, IActionContext, IActionInput, ICommerceApiSettings, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { getCartState, ICartState } from '@msdyn365-commerce/global-state';\nimport { LoyaltyCard } from '@msdyn365-commerce/retail-proxy';\nimport { issueLoyaltyCardAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport { getLoyaltyAction, GetLoyaltyCardInput} from './get-loyalty-card';\nimport { buildCacheKey } from './index';\n\n/**\n *  Input class for the issueLoyalty data action\n */\nexport class IssueLoyaltyInput implements IActionInput {\n    public userAccountNumber?: string;\n    public apiSettings: ICommerceApiSettings;\n\n    constructor(apiSettings: ICommerceApiSettings, userAccountNumber?: string) {\n        this.userAccountNumber = userAccountNumber;\n        this.apiSettings = apiSettings;\n    }\n\n    public getCacheKey = () => buildCacheKey(`IssueLoyalty-${this.userAccountNumber}`, this.apiSettings);\n    public getCacheObjectType = () => 'GetIssueLoyalty';\n    public dataCacheType = (): CacheType => 'request';\n}\n\n/**\n * createInput method for the issueLoyalty method\n * @param inputData The input data passed to the createInput method\n */\nexport const createIssueLoyaltyInput = (inputData: ICreateActionContext): IActionInput => {\n    const { requestContext } = inputData;\n\n    if (!requestContext.user.isAuthenticated) {\n        throw new Error('Unable to create issue loyalty input.  User is not authenticated.');\n    }\n\n    return new IssueLoyaltyInput(inputData.requestContext.apiSettings);\n};\n\n/**\n * The action method for the issueLoyalty data action\n * @param input The action input\n * @param ctx The action context\n */\nexport async function issueLoyaltyAction(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const promises: [Promise<ICartState>,Promise<LoyaltyCard>] = [ getCartState(ctx), _getLoyalty(input, ctx)];\n    return Promise.all(promises)\n            .then((result) => {\n                const cartState = result[0];\n                const card = result[1];\n                if (card && card.CardNumber) {\n                    updateCart(cartState, card);\n                    return card;\n                }\n                //@ts-ignore\n                //TO-DO: Remove after SDK bug fix https://msdyneng.visualstudio.com/FinOps/_workitems/edit/473891\n                return issueLoyaltyCardAsync({ callerContext: ctx }, { CustomerAccount: input.userAccountNumber || null })     \n                    .then((issuedCard: LoyaltyCard) => {\n                        updateCart(cartState, issuedCard);\n                        return issuedCard;\n                    })\n                    //@ts-ignore\n                    .catch(error => {\n                        ctx.telemetry.exception(error);\n                        ctx.telemetry.debug('Issuing loyalty card failed');\n                        throw new Error('Issuing loyalty card failed');\n                    });\n            })\n            .catch((error: Error) => {\n                ctx.telemetry.exception(error);\n                ctx.telemetry.debug('Unable to issue loyalty card');\n                throw new Error('Unable to issue loyalty card');\n            });\n}\n\nasync function _getLoyalty(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const loyaltyCardInput = new GetLoyaltyCardInput(input.apiSettings);\n    return getLoyaltyAction(loyaltyCardInput, ctx);\n}\n\nfunction updateCart(cartState: ICartState, card: LoyaltyCard): void {\n    cartState.updateLoyaltyCardId({loyaltyCardNumber: card.CardNumber});\n}\n\n/**\n * The getLoyaltyCard data action\n * Returns the loyalty card belonging to the customer\n */\nexport default createObservableDataAction<LoyaltyCard>({\n    id: '@msdyn365-commerce-modules/retail-actions/issue-loyalty',\n    action: <IAction<LoyaltyCard>>issueLoyaltyAction,\n    input: <(args: ICreateActionContext) => IActionInput>createIssueLoyaltyInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}