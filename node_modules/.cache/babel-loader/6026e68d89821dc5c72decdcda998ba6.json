{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";/*---------------------------------------------------------------------------------------------\r\n *  Copyright (c) Microsoft Corporation. All rights reserved.\r\n *  Licensed under the MIT License. See License.txt in the project root for license information.\r\n *--------------------------------------------------------------------------------------------*/import{createObservableDataAction}from'@msdyn365-commerce/core';import{getRelatedProductsAsync,getRelationTypesAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import getFullProducts,{FullProductInput}from'./get-full-products';import{QueryResultSettingsProxy}from'./utilities/QueryResultSettingsProxy';import{getProductDetailsCriteriaFromActionInput}from'./utilities/utils';/**\r\n * GetRelatedProducts Input Action\r\n */export var GetRelatedProductsInput=function GetRelatedProductsInput(productId,catalogId,relationType,queryResultSettingsProxy,criteria){var _this=this;_classCallCheck(this,GetRelatedProductsInput);this.getCacheKey=function(){return\"\".concat(_this.productId,\"|\").concat(_this.catalogId,\"|\").concat(_this.relationType.toLowerCase(),\"|\").concat(_this.queryResultSettingsProxy.cacheKeyHint,\"|\").concat(_this.ProductDetailsCriteria.getPrice);};this.getCacheObjectType=function(){return'GetRelatedProducts';};this.dataCacheType=function(){return'none';};this.productId=productId;this.catalogId=catalogId;this.relationType=relationType;this.queryResultSettingsProxy=queryResultSettingsProxy;this.ProductDetailsCriteria=criteria;};/**\r\n * Creates the input required to make GetRelatedProducts retail api call\r\n */export var createGetRelatedProductsInput=function createGetRelatedProductsInput(inputData){if(inputData&&inputData.requestContext&&inputData.config){var catalogId=inputData.requestContext.apiSettings.catalogId;var relationType=inputData.config.relationType;// @ts-ignore: URLTokens not properly types\nvar productId=inputData.requestContext.urlTokens?Number(inputData.requestContext.urlTokens.recordId):0;var productDetailsCriteria=getProductDetailsCriteriaFromActionInput(inputData);if(!relationType){throw new Error('Input relation type is invalid.');}// Query string may override the product id from url\nif(inputData.requestContext.query&&inputData.requestContext.query.productId){productId=Number(inputData.requestContext.query.productId);}if(Number.isNaN(productId)||productId<=0){throw new Error('No valid product id available in url or query string.');}if(Number.isNaN(catalogId)){throw new Error('Failed to cast catalog id into a number.');}var queryResultSettingsProxy=QueryResultSettingsProxy.fromInputData(inputData);return new GetRelatedProductsInput(productId,catalogId,relationType,queryResultSettingsProxy,productDetailsCriteria);}throw new Error('Invalid input data or request context');};export function searchProductRelationType(productRelationTypes,_productRelationType){var foundProductRelationTypeId;_productRelationType=_productRelationType.toLowerCase();productRelationTypes.forEach(function(productRelationType){if(productRelationType.Name&&productRelationType.Name.toLowerCase()===_productRelationType){return foundProductRelationTypeId=productRelationType.RecordId;}});return foundProductRelationTypeId;}function getRelatedProductsAction(_x,_x2){return _getRelatedProductsAction.apply(this,arguments);}/**\r\n * The getRelatedProducts data action\r\n * Uses a productId URL Token and finds the relation types for said product\r\n * using the getRelationTypes RetailServer API, and then finds and retusn all products that\r\n * share that relation type via the getRelatedProducts RetailServer API\r\n */function _getRelatedProductsAction(){_getRelatedProductsAction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var apiSettings,querySettings,productRelationTypes,productRelationTypeId,productInputs;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:apiSettings=ctx.requestContext.apiSettings;querySettings=input.queryResultSettingsProxy.QueryResultSettings;_context.next=4;return getRelationTypesAsync({callerContext:ctx,queryResultSettings:querySettings},input.productId,+apiSettings.channelId,input.catalogId);case 4:productRelationTypes=_context.sent;if(productRelationTypes){_context.next=8;break;}ctx.trace(\"[getProductRelationType] Unable to get product relation types for product \".concat(input.productId));return _context.abrupt(\"return\",[]);case 8:productRelationTypeId=searchProductRelationType(productRelationTypes,input.relationType);if(productRelationTypeId){_context.next=12;break;}ctx.trace(\"[getRelatedProducts] Unable to find relation type \".concat(input.relationType,\" for product \").concat(input.productId));return _context.abrupt(\"return\",[]);case 12:_context.next=14;return getRelatedProductsAsync({callerContext:ctx,queryResultSettings:querySettings},input.productId,+apiSettings.channelId,input.catalogId,productRelationTypeId).then(function(response){if(response&&response.length){return response.map(function(product){return new FullProductInput(product.RecordId,apiSettings,input.ProductDetailsCriteria);});}ctx.trace('[getRelatedProductsAction] Invalid response from server');return[];})[\"catch\"](function(error){ctx.trace(error.message);ctx.trace(error.stack||'');ctx.telemetry.exception(error);ctx.telemetry.debug(\"[getRelatedProductsAction] Unable to Fetch Products.\");ctx.trace(\"[getRelatedProductsAction] Unable to Fetch Products.\");return[];});case 14:productInputs=_context.sent;if(!(productInputs.length>0)){_context.next=19;break;}return _context.abrupt(\"return\",getFullProducts(productInputs,ctx));case 19:return _context.abrupt(\"return\",[]);case 20:case\"end\":return _context.stop();}}},_callee);}));return _getRelatedProductsAction.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/get-related-products',action:getRelatedProductsAction,input:createGetRelatedProductsInput});","map":{"version":3,"sources":["../../src/get-related-products.ts"],"names":[],"mappings":"8MAAA;;;AAGgG,gGAIhG,OAAS,0BAAT,KAAiG,yBAAjG,CACA,OAAS,uBAAT,CAAkC,qBAAlC,KAA+D,wEAA/D,CAGA,MAAO,CAAA,eAAP,EAA0B,gBAA1B,KAA0E,qBAA1E,CACA,OAAS,wBAAT,KAAyC,sCAAzC,CACA,OAAS,wCAAT,KAAyD,mBAAzD,CAEA;;AAEG,GACH,UAAa,CAAA,uBAAb,CAOI,iCACI,SADJ,CAEI,SAFJ,CAGI,YAHJ,CAII,wBAJJ,CAKI,QALJ,CAKoC,8DAS7B,KAAA,WAAA,CAAc,2BACd,KAAI,CAAC,SADS,aACI,KAAI,CAAC,SADT,aACsB,KAAI,CAAC,YAAL,CAAkB,WAAlB,EADtB,aACyD,KAAI,CAAC,wBAAL,CAA8B,YADvF,aAEb,KAAI,CAAC,sBAAL,CAA4B,QAFf,GAAd,CAIA,KAAA,kBAAA,CAAqB,iBAAM,oBAAN,EAArB,CACA,KAAA,aAAA,CAAgB,iBAAiB,MAAjB,EAAhB,CAZH,KAAK,SAAL,CAAiB,SAAjB,CACA,KAAK,SAAL,CAAiB,SAAjB,CACA,KAAK,YAAL,CAAoB,YAApB,CACA,KAAK,wBAAL,CAAgC,wBAAhC,CACA,KAAK,sBAAL,CAA8B,QAA9B,CACH,CAnBL,CA6BA;;AAEG,GACH,MAAO,IAAM,CAAA,6BAA6B,CAAG,QAAhC,CAAA,6BAAgC,CAAC,SAAD,CAAkE,CAC3G,GAAI,SAAS,EAAI,SAAS,CAAC,cAAvB,EAAyC,SAAS,CAAC,MAAvD,CAA+D,CAC3D,GAAM,CAAA,SAAS,CAAG,SAAS,CAAC,cAAV,CAAyB,WAAzB,CAAqC,SAAvD,CACA,GAAM,CAAA,YAAY,CAAG,SAAS,CAAC,MAAV,CAAiB,YAAtC,CAEA;AACA,GAAI,CAAA,SAAS,CAAG,SAAS,CAAC,cAAV,CAAyB,SAAzB,CAAqC,MAAM,CAAC,SAAS,CAAC,cAAV,CAAyB,SAAzB,CAAmC,QAApC,CAA3C,CAA2F,CAA3G,CACA,GAAM,CAAA,sBAAsB,CAAG,wCAAwC,CAAC,SAAD,CAAvE,CACA,GAAI,CAAC,YAAL,CAAmB,CACf,KAAM,IAAI,CAAA,KAAJ,CAAU,iCAAV,CAAN,CACH,CAED;AACA,GAAI,SAAS,CAAC,cAAV,CAAyB,KAAzB,EAAkC,SAAS,CAAC,cAAV,CAAyB,KAAzB,CAA+B,SAArE,CAAgF,CAC5E,SAAS,CAAG,MAAM,CAAC,SAAS,CAAC,cAAV,CAAyB,KAAzB,CAA+B,SAAhC,CAAlB,CACH,CAED,GAAI,MAAM,CAAC,KAAP,CAAa,SAAb,GAA2B,SAAS,EAAI,CAA5C,CAA+C,CAC3C,KAAM,IAAI,CAAA,KAAJ,CAAU,uDAAV,CAAN,CACH,CAED,GAAI,MAAM,CAAC,KAAP,CAAa,SAAb,CAAJ,CAA6B,CACzB,KAAM,IAAI,CAAA,KAAJ,CAAU,0CAAV,CAAN,CACH,CAED,GAAM,CAAA,wBAAwB,CAAG,wBAAwB,CAAC,aAAzB,CAAuC,SAAvC,CAAjC,CACA,MAAO,IAAI,CAAA,uBAAJ,CAA4B,SAA5B,CAAuC,SAAvC,CAAkD,YAAlD,CAAgE,wBAAhE,CAA0F,sBAA1F,CAAP,CACH,CAED,KAAM,IAAI,CAAA,KAAJ,CAAU,uCAAV,CAAN,CACH,CA9BM,CAgCP,MAAM,SAAU,CAAA,yBAAV,CAAoC,oBAApC,CAAiF,oBAAjF,CAA6G,CAC/G,GAAI,CAAA,0BAAJ,CACA,oBAAoB,CAAG,oBAAoB,CAAC,WAArB,EAAvB,CACA,oBAAoB,CAAC,OAArB,CAA6B,SAAC,mBAAD,CAA6C,CACtE,GAAI,mBAAmB,CAAC,IAApB,EAA4B,mBAAmB,CAAC,IAApB,CAAyB,WAAzB,KAA2C,oBAA3E,CAAiG,CAC7F,MAAQ,CAAA,0BAA0B,CAAG,mBAAmB,CAAC,QAAzD,CACH,CACJ,CAJD,EAMA,MAAO,CAAA,0BAAP,CACH,C,QAEc,CAAA,wB,iEAuDf;;;;;AAKG,G,uHA5DH,iBAAwC,KAAxC,CAAwE,GAAxE,yMACU,WADV,CACwB,GAAG,CAAC,cAAJ,CAAmB,WAD3C,CAEU,aAFV,CAE0B,KAAK,CAAC,wBAAN,CAA+B,mBAFzD,uBAIuC,CAAA,qBAAqB,CACpD,CAAE,aAAa,CAAE,GAAjB,CAAsB,mBAAmB,CAAE,aAA3C,CADoD,CAEpD,KAAK,CAAC,SAF8C,CAGpD,CAAC,WAAW,CAAC,SAHuC,CAIpD,KAAK,CAAC,SAJ8C,CAJ5D,QAIU,oBAJV,kBAUS,oBAVT,yBAWQ,GAAG,CAAC,KAAJ,qFAAuF,KAAK,CAAC,SAA7F,GAXR,gCAY8B,EAZ9B,SAcU,qBAdV,CAckC,yBAAyB,CAAC,oBAAD,CAAuB,KAAK,CAAC,YAA7B,CAd3D,IAeS,qBAfT,0BAgBQ,GAAG,CAAC,KAAJ,6DAA+D,KAAK,CAAC,YAArE,yBAAiG,KAAK,CAAC,SAAvG,GAhBR,gCAiB8B,EAjB9B,iCAoBgC,CAAA,uBAAuB,CAC/C,CAAE,aAAa,CAAE,GAAjB,CAAsB,mBAAmB,CAAE,aAA3C,CAD+C,CAE/C,KAAK,CAAC,SAFyC,CAG/C,CAAC,WAAW,CAAC,SAHkC,CAI/C,KAAK,CAAC,SAJyC,CAK/C,qBAL+C,CAAvB,CAOvB,IAPuB,CAOlB,SAAA,QAAQ,CAAG,CACb,GAAI,QAAQ,EAAI,QAAQ,CAAC,MAAzB,CAAiC,CAC7B,MAAO,CAAA,QAAQ,CAAC,GAAT,CACH,SAAC,OAAD,CAAmD,CAC/C,MAAO,IAAI,CAAA,gBAAJ,CAAqB,OAAO,CAAC,QAA7B,CAAuC,WAAvC,CAAoD,KAAK,CAAC,sBAA1D,CAAP,CACH,CAHE,CAAP,CAKH,CAED,GAAG,CAAC,KAAJ,CAAU,yDAAV,EACA,MAA2B,EAA3B,CACH,CAlBuB,WAmBjB,SAAC,KAAD,CAAiB,CACpB,GAAG,CAAC,KAAJ,CAAU,KAAK,CAAC,OAAhB,EACA,GAAG,CAAC,KAAJ,CAAU,KAAK,CAAC,KAAN,EAAe,EAAzB,EACA,GAAG,CAAC,SAAJ,CAAc,SAAd,CAAwB,KAAxB,EACA,GAAG,CAAC,SAAJ,CAAc,KAAd,yDACA,GAAG,CAAC,KAAJ,yDACA,MAA2B,EAA3B,CACH,CA1BuB,CApBhC,SAoBU,aApBV,oBAgDQ,aAAa,CAAC,MAAd,CAAuB,CAhD/B,2DAiDe,eAAe,CAAC,aAAD,CAAgB,GAAhB,CAjD9B,0CAmD8B,EAnD9B,yD,2DA6DA,cAAe,CAAA,0BAA0B,CAAC,CACtC,EAAE,CAAE,gEADkC,CAEtC,MAAM,CAA0B,wBAFM,CAGtC,KAAK,CAAE,6BAH+B,CAAD,CAAzC","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { FullProduct } from '@msdyn365-commerce/commerce-entities';\nimport { CacheType, IAction, IActionInput } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IActionContext, IAny, ICreateActionContext, IGeneric } from '@msdyn365-commerce/core';\nimport { getRelatedProductsAsync, getRelationTypesAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport { ProductRelationType, ProductSearchResult } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\n\nimport getFullProducts, { FullProductInput, ProductDetailsCriteria } from './get-full-products';\nimport { QueryResultSettingsProxy } from './utilities/QueryResultSettingsProxy';\nimport { getProductDetailsCriteriaFromActionInput } from './utilities/utils';\n\n/**\n * GetRelatedProducts Input Action\n */\nexport class GetRelatedProductsInput implements IActionInput {\n    public readonly productId: number;\n    public readonly catalogId: number;\n    public readonly relationType: string;\n    public ProductDetailsCriteria: ProductDetailsCriteria;\n    public readonly queryResultSettingsProxy: QueryResultSettingsProxy;\n\n    constructor(\n        productId: number,\n        catalogId: number,\n        relationType: string,\n        queryResultSettingsProxy: QueryResultSettingsProxy,\n        criteria: ProductDetailsCriteria\n    ) {\n        this.productId = productId;\n        this.catalogId = catalogId;\n        this.relationType = relationType;\n        this.queryResultSettingsProxy = queryResultSettingsProxy;\n        this.ProductDetailsCriteria = criteria;\n    }\n\n    public getCacheKey = () =>\n        `${this.productId}|${this.catalogId}|${this.relationType.toLowerCase()}|${this.queryResultSettingsProxy.cacheKeyHint}|${\n            this.ProductDetailsCriteria.getPrice\n        }`;\n    public getCacheObjectType = () => 'GetRelatedProducts';\n    public dataCacheType = (): CacheType => 'none';\n}\n\n/**\n * Creates the input required to make GetRelatedProducts retail api call\n */\nexport const createGetRelatedProductsInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    if (inputData && inputData.requestContext && inputData.config) {\n        const catalogId = inputData.requestContext.apiSettings.catalogId;\n        const relationType = inputData.config.relationType;\n\n        // @ts-ignore: URLTokens not properly types\n        let productId = inputData.requestContext.urlTokens ? Number(inputData.requestContext.urlTokens.recordId) : 0;\n        const productDetailsCriteria = getProductDetailsCriteriaFromActionInput(inputData);\n        if (!relationType) {\n            throw new Error('Input relation type is invalid.');\n        }\n\n        // Query string may override the product id from url\n        if (inputData.requestContext.query && inputData.requestContext.query.productId) {\n            productId = Number(inputData.requestContext.query.productId);\n        }\n\n        if (Number.isNaN(productId) || productId <= 0) {\n            throw new Error('No valid product id available in url or query string.');\n        }\n\n        if (Number.isNaN(catalogId)) {\n            throw new Error('Failed to cast catalog id into a number.');\n        }\n\n        const queryResultSettingsProxy = QueryResultSettingsProxy.fromInputData(inputData);\n        return new GetRelatedProductsInput(productId, catalogId, relationType, queryResultSettingsProxy, productDetailsCriteria);\n    }\n\n    throw new Error('Invalid input data or request context');\n};\n\nexport function searchProductRelationType(productRelationTypes: ProductRelationType[], _productRelationType: string): number | undefined {\n    let foundProductRelationTypeId;\n    _productRelationType = _productRelationType.toLowerCase();\n    productRelationTypes.forEach((productRelationType: ProductRelationType) => {\n        if (productRelationType.Name && productRelationType.Name.toLowerCase() === _productRelationType) {\n            return (foundProductRelationTypeId = productRelationType.RecordId);\n        }\n    });\n\n    return foundProductRelationTypeId;\n}\n\nasync function getRelatedProductsAction(input: GetRelatedProductsInput, ctx: IActionContext): Promise<FullProduct[]> {\n    const apiSettings = ctx.requestContext.apiSettings;\n    const querySettings = input.queryResultSettingsProxy.QueryResultSettings;\n\n    const productRelationTypes = await getRelationTypesAsync(\n        { callerContext: ctx, queryResultSettings: querySettings },\n        input.productId,\n        +apiSettings.channelId,\n        input.catalogId\n    );\n    if (!productRelationTypes) {\n        ctx.trace(`[getProductRelationType] Unable to get product relation types for product ${input.productId}`);\n        return <FullProduct[]>[];\n    }\n    const productRelationTypeId = searchProductRelationType(productRelationTypes, input.relationType);\n    if (!productRelationTypeId) {\n        ctx.trace(`[getRelatedProducts] Unable to find relation type ${input.relationType} for product ${input.productId}`);\n        return <FullProduct[]>[];\n    }\n\n    const productInputs = await getRelatedProductsAsync(\n        { callerContext: ctx, queryResultSettings: querySettings },\n        input.productId,\n        +apiSettings.channelId,\n        input.catalogId,\n        productRelationTypeId\n    )\n        .then(response => {\n            if (response && response.length) {\n                return response.map(\n                    (product: ProductSearchResult): FullProductInput => {\n                        return new FullProductInput(product.RecordId, apiSettings, input.ProductDetailsCriteria);\n                    }\n                );\n            }\n\n            ctx.trace('[getRelatedProductsAction] Invalid response from server');\n            return <FullProductInput[]>[];\n        })\n        .catch((error: Error) => {\n            ctx.trace(error.message);\n            ctx.trace(error.stack || '');\n            ctx.telemetry.exception(error);\n            ctx.telemetry.debug(`[getRelatedProductsAction] Unable to Fetch Products.`);\n            ctx.trace(`[getRelatedProductsAction] Unable to Fetch Products.`);\n            return <FullProductInput[]>[];\n        });\n\n    if (productInputs.length > 0) {\n        return getFullProducts(productInputs, ctx);\n    } else {\n        return <FullProduct[]>[];\n    }\n}\n\n/**\n * The getRelatedProducts data action\n * Uses a productId URL Token and finds the relation types for said product\n * using the getRelationTypes RetailServer API, and then finds and retusn all products that\n * share that relation type via the getRelatedProducts RetailServer API\n */\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-related-products',\n    action: <IAction<FullProduct[]>>getRelatedProductsAction,\n    input: createGetRelatedProductsInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}