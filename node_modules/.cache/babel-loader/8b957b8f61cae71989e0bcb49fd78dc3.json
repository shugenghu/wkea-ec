{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import{addDiscountCodeAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';export default function addPromoCode(_x,_x2,_x3){return _addPromoCode.apply(this,arguments);}function _addPromoCode(){_addPromoCode=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(cart,promoCode,actionContext){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(cart){_context.next=2;break;}return _context.abrupt(\"return\",{cart:undefined,status:'FAILED'});case 2:if(!hasPromoCode(cart,promoCode)){_context.next=4;break;}return _context.abrupt(\"return\",{cart:undefined,status:'FAILED',substatus:'ALREADYADDED'});case 4:return _context.abrupt(\"return\",addDiscountCodeAsync({callerContext:actionContext},cart.Id,promoCode).then(function(newCart){// Retail server will still return success if a promo code is not valid,\n// but it won't actually add that promo code. So need to check if promo\n// code is actually in the new cart\nif(hasPromoCode(newCart,promoCode)){return{cart:newCart,status:'SUCCESS'};}else{return{cart:undefined,status:'FAILED'};}})[\"catch\"](function(error){actionContext.telemetry.warning(error);return{cart:undefined,status:'FAILED'};}));case 5:case\"end\":return _context.stop();}}},_callee);}));return _addPromoCode.apply(this,arguments);}function hasPromoCode(cart,code){var codes=cart.Coupons?cart.Coupons.map(function(coupon){return coupon.Code.toLowerCase();}):[];return codes.indexOf(code.toLowerCase())>-1;}","map":{"version":3,"sources":["cart-state/add-promo-code.ts"],"names":[],"mappings":"uIACA,OAAS,oBAAT,KAAqC,qEAArC,CAIA,uBAA8B,CAAA,YAA9B,yD,+FAAe,iBAA4B,IAA5B,CAA8D,SAA9D,CAAiF,aAAjF,qHACN,IADM,yDAEA,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAFA,aAKP,YAAY,CAAC,IAAD,CAAO,SAAP,CALL,yDAMA,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAqC,SAAS,CAAE,cAAhD,CANA,yCASJ,oBAAoB,CAAC,CAAE,aAAa,CAAE,aAAjB,CAAD,CAAmC,IAAI,CAAC,EAAxC,CAA4C,SAA5C,CAApB,CACF,IADE,CACG,SAAA,OAAO,CAAG,CACZ;AACA;AACA;AACA,GAAI,YAAY,CAAC,OAAD,CAAU,SAAV,CAAhB,CAAsC,CAClC,MAAmC,CAAE,IAAI,CAAE,OAAR,CAAiB,MAAM,CAAE,SAAzB,CAAnC,CACH,CAFD,IAEO,CACH,MAAmC,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAnC,CACH,CACJ,CAVE,WAUM,SAAA,KAAK,CAAG,CACb,aAAa,CAAC,SAAd,CAAwB,OAAxB,CAAgC,KAAhC,EAEA,MAAmC,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAnC,CACH,CAdE,CATI,wD,+CA0Bf,QAAS,CAAA,YAAT,CAAsB,IAAtB,CAAkC,IAAlC,CAA8C,CAC1C,GAAM,CAAA,KAAK,CAAG,IAAI,CAAC,OAAL,CAAe,IAAI,CAAC,OAAL,CAAa,GAAb,CAAiB,SAAC,MAAD,CAAmB,CAAG,MAAO,CAAA,MAAM,CAAC,IAAP,CAAa,WAAb,EAAP,CAAoC,CAA3E,CAAf,CAA8F,EAA5G,CACA,MAAO,CAAA,KAAK,CAAC,OAAN,CAAc,IAAI,CAAC,WAAL,EAAd,EAAoC,CAAC,CAA5C,CACH","sourcesContent":["import { IActionContext } from '@msdyn365-commerce/core';\nimport { addDiscountCodeAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';\nimport { Cart, Coupon } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport { ICartActionResultWithCart } from './cart-action-result';\n\nexport default async function addPromoCode(cart: Readonly<Cart | undefined>, promoCode: string, actionContext: IActionContext): Promise<ICartActionResultWithCart> {\n    if (!cart) {\n        return { cart: undefined, status: 'FAILED'};\n    }\n\n    if (hasPromoCode(cart, promoCode)) {\n        return { cart: undefined, status: 'FAILED', substatus: 'ALREADYADDED' };\n    }\n\n    return addDiscountCodeAsync({ callerContext: actionContext }, cart.Id, promoCode)\n        .then(newCart => {\n            // Retail server will still return success if a promo code is not valid,\n            // but it won't actually add that promo code. So need to check if promo\n            // code is actually in the new cart\n            if (hasPromoCode(newCart, promoCode)) {\n                return <ICartActionResultWithCart> { cart: newCart, status: 'SUCCESS' };\n            } else {\n                return <ICartActionResultWithCart> { cart: undefined, status: 'FAILED' };\n            }\n        }).catch(error => {\n            actionContext.telemetry.warning(error);\n\n            return <ICartActionResultWithCart> { cart: undefined, status: 'FAILED' };\n        });\n}\n\nfunction hasPromoCode(cart: Cart, code: string): boolean {\n    const codes = cart.Coupons ? cart.Coupons.map((coupon: Coupon) => { return coupon.Code!.toLowerCase(); }) : [];\n    return codes.indexOf(code.toLowerCase()) > -1;\n}\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}