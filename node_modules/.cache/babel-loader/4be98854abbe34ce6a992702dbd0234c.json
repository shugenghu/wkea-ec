{"ast":null,"code":"import\"core-js/modules/es.array.reduce.js\";import\"core-js/modules/es.promise.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{createObservableDataAction}from'@msdyn365-commerce/core';import getCategoryAction,{CategoriesInput as RawCategoriesInput}from'./get-categories';import{getCategoryUrl}from'./utilities/Url-builder';import{buildCacheKey}from'./utilities/utils';/**\r\n * Input for get-categories data action\r\n */export class CategoriesInput{constructor(context,mappedToHierarchy,maxItems){this.getCacheKey=()=>buildCacheKey(\"\".concat(this.channelId,\"|\").concat(this.sitePath,\"|top-\").concat(this.maxItems||250),this.apiSettings,this.locale);this.getCacheObjectType=()=>this._mappedToHierarchy?'CategoryHierarchy':'Category';this.dataCacheType=()=>'application';this.getLocale=()=>this.locale||'';this._mappedToHierarchy=mappedToHierarchy;this.maxItems=maxItems||250;this.channelId=context&&context.apiSettings&&context.apiSettings.channelId?+context.apiSettings.channelId:0;this.sitePath=context&&context.sitePath||'';this.apiSettings=context.apiSettings;this.locale=context.locale||'';}}const getFriendlyName=(locale,nameTranslations)=>{let nameTranslation;if(locale&&nameTranslations&&nameTranslations.length>0){nameTranslation=nameTranslations.find(item=>item.Language.toLowerCase()===locale.toLowerCase());}return nameTranslation&&nameTranslation.Text;};/**\r\n * Creates a hierarchy of categories based on the ParentCategory property\r\n * @param categoryList Categories that will be converted into a hierarchy\r\n * @returns Hierarchy of categories in array\r\n */export const mapCategoryToHierarchy=(categoryList,ctx,locale)=>{if(!categoryList||!categoryList.length){return[];}const categoryMap=categoryList.reduce((memo,category)=>{const localName=getFriendlyName(locale,category.NameTranslations);const categoryHierarchy=_objectSpread({},category);categoryHierarchy.NeutralizedName=category.Name;categoryHierarchy.Name=localName||categoryHierarchy.NeutralizedName;memo[category.RecordId]=categoryHierarchy;return memo;},{});let zeroCategory=categoryMap[0];Object.keys(categoryMap).forEach(id=>{const element=categoryMap[+id];const parentId=element.ParentCategory;element.Url=getCategoryUrl(element,ctx,categoryMap);if(parentId===0){zeroCategory=element;return;}const parent=parentId&&categoryMap[parentId];if(parent){parent.Children=parent.Children||[];parent.Children.push(element);}});return zeroCategory&&zeroCategory.Children||[];};/**\r\n * Creates the input required to make the retail api call\r\n */export const createCategoriesHierarchyInput=inputData=>{const topItems=inputData.config&&inputData.config.topCategories&&parseInt(inputData.config.topCategories,10);return new CategoriesInput(inputData.requestContext,true,topItems);};/**\r\n * Calls the Retail API and returns all the categories as a hierarchy\r\n */export async function getCategoryHierarchyAction(input,ctx){const categories=await getCategoryAction(new RawCategoriesInput(ctx.requestContext,false,input.maxItems),ctx);return mapCategoryToHierarchy(categories,ctx,input.getLocale());}export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/get-categories-hierarchy',action:getCategoryHierarchyAction,input:createCategoriesHierarchyInput});","map":{"version":3,"sources":["../../src/get-categories-hierarchy.ts"],"names":[],"mappings":"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","sourcesContent":["import { CategoryHierarchy } from '@msdyn365-commerce/commerce-entities';\nimport { CacheType, IAction, IActionContext, IActionInput, ICommerceApiSettings } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IAny, ICreateActionContext, IGeneric, IRequestContext } from '@msdyn365-commerce/core';\nimport { Category } from '@msdyn365-commerce/retail-proxy';\nimport { TextValueTranslation } from '@msdyn365-commerce/retail-proxy';\nimport getCategoryAction, { CategoriesInput as RawCategoriesInput } from './get-categories';\nimport { getCategoryUrl } from './utilities/Url-builder';\nimport { buildCacheKey } from './utilities/utils';\n\n/**\n * Input for get-categories data action\n */\nexport class CategoriesInput implements IActionInput {\n    public readonly maxItems: number;\n    public readonly channelId: number;\n    private readonly sitePath: string;\n    private _mappedToHierarchy: boolean;\n    private apiSettings: ICommerceApiSettings;\n    private locale?:string;\n\n    constructor(context: IRequestContext, mappedToHierarchy: boolean, maxItems?: number) {\n        this._mappedToHierarchy = mappedToHierarchy;\n        this.maxItems = maxItems || 250;\n        this.channelId = context && context.apiSettings && context.apiSettings.channelId ? +context.apiSettings.channelId : 0;\n        this.sitePath = context && context.sitePath || '';\n        this.apiSettings = context.apiSettings;\n        this.locale = context.locale || '';\n    }\n\n    public getCacheKey = () => buildCacheKey(`${this.channelId}|${this.sitePath}|top-${this.maxItems || 250}`, this.apiSettings, this.locale);\n    public getCacheObjectType = () => (this._mappedToHierarchy ? 'CategoryHierarchy' : 'Category');\n    public dataCacheType = (): CacheType => 'application';\n    public getLocale = ():string => this.locale || '';\n}\n\nconst getFriendlyName = (locale?: string, nameTranslations?: TextValueTranslation[]): string | undefined => {\n    let nameTranslation: TextValueTranslation | undefined;\n    if (locale && nameTranslations && nameTranslations.length > 0) {\n        nameTranslation = nameTranslations.find(item => item.Language!.toLowerCase() === locale.toLowerCase());\n    }\n\n    return nameTranslation && nameTranslation.Text;\n};\n\nexport interface ICategoryMap {\n    [RecordId: number]: CategoryHierarchy;\n}\n\n/**\n * Creates a hierarchy of categories based on the ParentCategory property\n * @param categoryList Categories that will be converted into a hierarchy\n * @returns Hierarchy of categories in array\n */\nexport const mapCategoryToHierarchy = (categoryList: Category[], ctx: IActionContext, locale?: string ): CategoryHierarchy[] => {\n    if (!categoryList || !categoryList.length) {\n        return [];\n    }\n\n    const categoryMap: ICategoryMap = categoryList.reduce((memo: ICategoryMap, category: Category) => {\n        const localName = getFriendlyName(locale, category.NameTranslations);\n        const categoryHierarchy = <CategoryHierarchy> { ...category };\n        categoryHierarchy.NeutralizedName = category.Name;\n        categoryHierarchy.Name = localName || categoryHierarchy.NeutralizedName;\n        memo[category.RecordId] = categoryHierarchy;\n        return memo;\n    }, {});\n\n    let zeroCategory = categoryMap[0];\n\n    Object.keys(categoryMap).forEach((id: string) => {\n        const element = categoryMap[+id];\n        const parentId = element.ParentCategory;\n        element.Url = getCategoryUrl(element, ctx, categoryMap);\n        if (parentId === 0) {\n            zeroCategory = element;\n            return;\n        }\n\n        const parent = parentId && categoryMap[parentId];\n        if (parent) {\n            parent.Children = parent.Children || [];\n            parent.Children.push(element);\n        }\n    });\n\n    return (zeroCategory && zeroCategory.Children) || [];\n};\n\n/**\n * Creates the input required to make the retail api call\n */\nexport const createCategoriesHierarchyInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    const topItems = inputData.config && inputData.config.topCategories && parseInt(inputData.config.topCategories, 10);\n    return new CategoriesInput(inputData.requestContext, true, topItems);\n};\n\n/**\n * Calls the Retail API and returns all the categories as a hierarchy\n */\nexport async function getCategoryHierarchyAction(input: CategoriesInput, ctx: IActionContext): Promise<CategoryHierarchy[]> {\n    const categories = await getCategoryAction(\n        new RawCategoriesInput(ctx.requestContext, false, input.maxItems),\n        ctx\n    );\n    return mapCategoryToHierarchy(categories, ctx, input.getLocale());\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-categories-hierarchy',\n    action: <IAction<CategoryHierarchy[]>>getCategoryHierarchyAction,\n    input: createCategoriesHierarchyInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}