{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{__decorate}from\"tslib\";import{action}from'mobx';import{BaseStoreSelectorStateManager}from'./base-store-selector-state-manager';/**\r\n * Instance of IStoreSelectorStateManager manager that uses Map service\r\n * for geo location\r\n */export var MapStoreSelectorStateManager=/*#__PURE__*/function(_BaseStoreSelectorSta){_inherits(MapStoreSelectorStateManager,_BaseStoreSelectorSta);var _super=_createSuper(MapStoreSelectorStateManager);function MapStoreSelectorStateManager(){var _this;_classCallCheck(this,MapStoreSelectorStateManager);_this=_super.apply(this,arguments);_this.SERVICE_ENDPOINT='https://dev.virtualearth.net/REST/v1/';_this.MAP_API_ENDPOINT='https://www.bing.com/api/maps/mapcontrol?callback=mapAPIReady';return _this;}_createClass(MapStoreSelectorStateManager,[{key:\"geoLocate\",value:function(){var _geoLocate=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(searchTerm,actionContext){var jsonp,query,key,geolocationApiUrl,requestUrl;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!searchTerm||!actionContext.requestContext.channel||!actionContext.requestContext.channel.BingMapsApiKey||!actionContext.requestContext.channel.BingMapsEnabled)){_context.next=2;break;}return _context.abrupt(\"return\",undefined);case 2:jsonp=\"mapSearchCallback_\".concat(crypto.getRandomValues(new Uint32Array(1))[0]);query=encodeURI(searchTerm);key=encodeURI(actionContext.requestContext.channel.BingMapsApiKey);geolocationApiUrl=actionContext.requestContext.app&&actionContext.requestContext.app.config&&actionContext.requestContext.app.config.geolocationApiUrl;requestUrl=\"\".concat(geolocationApiUrl?geolocationApiUrl:this.SERVICE_ENDPOINT,\"/Locations?query=\").concat(query,\"&key=\").concat(key,\"&jsonp=\").concat(jsonp);return _context.abrupt(\"return\",new Promise(function(resolve){var script=document.createElement('script');script.setAttribute('type','text/javascript');script.setAttribute('src',requestUrl);window[jsonp]=function(data){delete window[jsonp];document.body.removeChild(script);if(data&&data.resourceSets&&data.resourceSets.length>0&&data.resourceSets[0].resources.length>0){resolve({latitude:data.resourceSets[0].resources[0].point.coordinates[0],longitude:data.resourceSets[0].resources[0].point.coordinates[1]});}resolve(undefined);};document.body.appendChild(script);}));case 8:case\"end\":return _context.stop();}}},_callee,this);}));function geoLocate(_x,_x2){return _geoLocate.apply(this,arguments);}return geoLocate;}()},{key:\"loadMapApi\",value:function(){var _loadMapApi=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(input){var _document,_this2=this;var isScriptAlreadyLoaded,url;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:isScriptAlreadyLoaded=(_document=document)!==null&&_document!==void 0&&_document.getElementById('msdyn_map-api-script')?true:false;if(!isScriptAlreadyLoaded){_context2.next=3;break;}return _context2.abrupt(\"return\",Promise.resolve());case 3:url=\"\".concat(this.MAP_API_ENDPOINT).concat(input.key?\"&key=\".concat(input.key):'').concat(input.lang?\"&setLang=\".concat(input.lang):'').concat(input.market?\"&setMkt=\".concat(input.market):'');return _context2.abrupt(\"return\",new Promise(function(resolve,reject){var _document2,_document3,_document3$body;var script=(_document2=document)===null||_document2===void 0?void 0:_document2.createElement('script');script.type='text/javascript';script.async=true;script.defer=true;script.src=url;script.id='msdyn_map-api-script';if(window){window.mapAPIReady=function(){_this2.isMapApiLoaded=true;resolve();};}script.onerror=function(error){reject(error);};(_document3=document)===null||_document3===void 0?void 0:(_document3$body=_document3.body)===null||_document3$body===void 0?void 0:_document3$body.appendChild(script);}));case 5:case\"end\":return _context2.stop();}}},_callee2,this);}));function loadMapApi(_x3){return _loadMapApi.apply(this,arguments);}return loadMapApi;}()}]);return MapStoreSelectorStateManager;}(BaseStoreSelectorStateManager);__decorate([action],MapStoreSelectorStateManager.prototype,\"geoLocate\",null);__decorate([action],MapStoreSelectorStateManager.prototype,\"loadMapApi\",null);","map":{"version":3,"sources":["store-selector-state-manager/map-store-selector-state-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { action } from 'mobx';\n\nimport { IActionContext } from '@msdyn365-commerce/core';\nimport { BaseStoreSelectorStateManager } from './base-store-selector-state-manager';\nimport { ILoadMapApiInput, IStoreSelectorLocation } from './i-store-selection-state-manager';\nimport { MapLocationsResult, IMapWindow } from './models/map-data';\n\ndeclare const window: IMapWindow;\n/**\n * Instance of IStoreSelectorStateManager manager that uses Map service\n * for geo location\n */\nexport class MapStoreSelectorStateManager extends BaseStoreSelectorStateManager {\n    private readonly SERVICE_ENDPOINT: string = 'https://dev.virtualearth.net/REST/v1/';\n    private readonly MAP_API_ENDPOINT: string = 'https://www.bing.com/api/maps/mapcontrol?callback=mapAPIReady';\n\n    @action\n    public async geoLocate(searchTerm: string, actionContext: IActionContext): Promise<IStoreSelectorLocation | undefined> {\n        if (!searchTerm ||\n            !actionContext.requestContext.channel ||\n            !actionContext.requestContext.channel.BingMapsApiKey ||\n            !actionContext.requestContext.channel.BingMapsEnabled) {\n            return undefined;\n        }\n\n        const jsonp = `mapSearchCallback_${crypto.getRandomValues(new Uint32Array(1))[0]}`;\n        const query = encodeURI(searchTerm);\n        const key = encodeURI(actionContext.requestContext.channel.BingMapsApiKey);\n\n        const geolocationApiUrl = actionContext.requestContext.app && actionContext.requestContext.app.config && actionContext.requestContext.app.config.geolocationApiUrl;\n        const requestUrl = `${geolocationApiUrl ? geolocationApiUrl : this.SERVICE_ENDPOINT}/Locations?query=${query}&key=${key}&jsonp=${jsonp}`;\n\n        return new Promise<IStoreSelectorLocation | undefined>((resolve) => {\n            const script = document.createElement('script');\n            script.setAttribute('type', 'text/javascript');\n            script.setAttribute('src', requestUrl);\n\n            window[jsonp] = (data: MapLocationsResult) => {\n                delete window[jsonp];\n                document.body.removeChild(script);\n\n                if (data && data.resourceSets && data.resourceSets.length > 0 && data.resourceSets[0].resources.length > 0) {\n                    resolve({\n                        latitude: data.resourceSets[0].resources[0].point.coordinates[0],\n                        longitude: data.resourceSets[0].resources[0].point.coordinates[1]\n                    });\n                }\n\n                resolve(undefined);\n            };\n\n            document.body.appendChild(script);\n        });\n\n    }\n\n    @action\n    public async loadMapApi(input: ILoadMapApiInput): Promise<void> {\n        const isScriptAlreadyLoaded = document?.getElementById('msdyn_map-api-script') ? true : false;\n\n        if (isScriptAlreadyLoaded) {\n            // Prevents from loading multiple script into the body\n            return Promise.resolve();\n        }\n\n        const url = `${this.MAP_API_ENDPOINT}${input.key ? `&key=${input.key}` : ''}${input.lang ? `&setLang=${input.lang}` : ''}${input.market ? `&setMkt=${input.market}` : ''}`;\n\n        return new Promise((resolve, reject) => {\n            const script = document?.createElement('script');\n            script.type = 'text/javascript';\n            script.async = true;\n            script.defer = true;\n            script.src = url;\n            script.id = 'msdyn_map-api-script';\n            if (window) {\n                window.mapAPIReady = () => {\n                    this.isMapApiLoaded = true;\n                    resolve();\n                };\n            }\n            script.onerror = (error: string | Event) => {\n                reject(error);\n            };\n            document?.body?.appendChild(script);\n        });\n    }\n\n}"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}