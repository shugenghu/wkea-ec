{"ast":null,"code":"import _typeof from\"@babel/runtime/helpers/esm/typeof\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";import _wrapNativeSuper from\"@babel/runtime/helpers/esm/wrapNativeSuper\";import _merge2 from\"lodash/merge\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _wrapRegExp(re,groups){_wrapRegExp=function _wrapRegExp(re,groups){return new BabelRegExp(re,undefined,groups);};var _RegExp=_wrapNativeSuper(RegExp);var _super=RegExp.prototype;var _groups=new WeakMap();function BabelRegExp(re,flags,groups){var _this=_RegExp.call(this,re,flags);_groups.set(_this,groups||_groups.get(re));return _this;}_inherits(BabelRegExp,_RegExp);BabelRegExp.prototype.exec=function(str){var result=_super.exec.call(this,str);if(result)result.groups=buildGroups(result,this);return result;};BabelRegExp.prototype[Symbol.replace]=function(str,substitution){if(typeof substitution===\"string\"){var groups=_groups.get(this);return _super[Symbol.replace].call(this,str,substitution.replace(/\\$<([^>]+)>/g,function(_,name){return\"$\"+groups[name];}));}else if(typeof substitution===\"function\"){var _this=this;return _super[Symbol.replace].call(this,str,function(){var args=[];args.push.apply(args,arguments);if(_typeof(args[args.length-1])!==\"object\"){args.push(buildGroups(args,_this));}return substitution.apply(this,args);});}else{return _super[Symbol.replace].call(this,str,substitution);}};function buildGroups(result,re){var g=_groups.get(re);return Object.keys(g).reduce(function(groups,name){groups[name]=result[g[name]];return groups;},Object.create(null));}return _wrapRegExp.apply(this,arguments);}/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{msdyn365Commerce}from'@msdyn365-commerce/core-internal';import{StaticTelemetry}from'@msdyn365-commerce/telemetry-internal';import{safeGetAllFilesPath,safeReadJson}from'@msdyn365-commerce/utilities-internal';import path from'path';import{getModuleDefinition,getThemeModules}from'../_server/Definition/moduleDefinition';import keystonePaths from'../paths';import{hoistedAuthoringResourcesPathPattern,hoistedModulesResourcesPathPattern,installedAuthoringResourcesPathPattern,installedModulesResourcesPathPattern,localAuthoringResourcesPathPattern,localModulesResourcesPathPattern}from'./constants';var GLOBAL_LOCALE='global';var RESOURCE_DETAILS_REGEX=/*#__PURE__*/_wrapRegExp(/\\/node_modules\\/(.*)\\/(.*)\\/dist\\/lib\\/.*/,{namespace:1,packageName:2});/**\r\n * Resource manager implementation\r\n */export var ResourceManager=/*#__PURE__*/function(){function ResourceManager(){_classCallCheck(this,ResourceManager);this.authoringResourcesMap={};this.moduleResourcesMap={};this.moduleResourceKeys={};this.moduleNamespaceMap={};}/**\r\n     * @function        {init}          - Method to initialize and load all the resource strings\r\n     */_createClass(ResourceManager,[{key:\"init\",value:function(){var _init=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(platformSettings){var _this2=this;var resourcesDapi,localAuthoringResourceFiles,localModulesResourceFiles;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(platformSettings&&!!!platformSettings.disableDAPIOptimizations)){_context3.next=12;break;}_context3.next=3;return safeReadJson(keystonePaths.KEYSTONE_APP_RESOURCES_DAPI_FILEPATH);case 3:_context3.t0=_context3.sent;if(_context3.t0){_context3.next=6;break;}_context3.t0={};case 6:resourcesDapi=_context3.t0;this.authoringResourcesMap=resourcesDapi.authoringResourcesMap||{};this.moduleResourcesMap=resourcesDapi.moduleResourcesMap||{};this.moduleResourceKeys=resourcesDapi.moduleResourceKeys||{};this.moduleNamespaceMap=resourcesDapi.moduleNamespaceMap||{};return _context3.abrupt(\"return\");case 12:_context3.next=14;return this._readAuthoringResourceFiles();case 14:_context3.next=16;return safeGetAllFilesPath(localAuthoringResourcesPathPattern);case 16:localAuthoringResourceFiles=_context3.sent;if(!(localAuthoringResourceFiles.length>0)){_context3.next=20;break;}_context3.next=20;return Promise.all(localAuthoringResourceFiles.map(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(resourceFile){var locale,content;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:locale=path.basename(resourceFile,'.json').toLocaleLowerCase();_context.next=3;return safeReadJson(resourceFile);case 3:content=_context.sent;if(!(!content||!content.modules)){_context.next=6;break;}return _context.abrupt(\"return\");case 6:_this2.authoringResourcesMap[locale]=_this2.authoringResourcesMap[locale]||{settings:{},modules:{},themes:{}};content.modules&&Object.keys(content.modules).forEach(function(moduleName){_this2.authoringResourcesMap[locale].modules[moduleName]=_this2._getMergedAuthoringResources(_this2.authoringResourcesMap[locale].modules[moduleName],content.modules[moduleName]);if(content.settings){_this2.authoringResourcesMap[locale].settings=content.settings;}_this2.authoringResourcesMap[locale].themes={};});if(content.themes){Object.keys(content.themes).forEach(function(themeName){_this2.authoringResourcesMap[locale].themes[themeName]=_merge2(_this2.authoringResourcesMap[locale].themes[themeName],content.themes[themeName]);});}case 9:case\"end\":return _context.stop();}}},_callee);}));return function(_x2){return _ref.apply(this,arguments);};}()));case 20:_context3.next=22;return this._readModuleResourceFiles();case 22:_context3.next=24;return safeGetAllFilesPath(localModulesResourcesPathPattern);case 24:localModulesResourceFiles=_context3.sent;if(!(localModulesResourceFiles.length>0)){_context3.next=28;break;}_context3.next=28;return Promise.all(localModulesResourceFiles.map(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(resourceFile){var locale,content,resourceKeys;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:locale=path.basename(resourceFile,'.json').toLocaleLowerCase();_context2.next=3;return safeReadJson(resourceFile);case 3:content=_context2.sent;if(content){_context2.next=6;break;}return _context2.abrupt(\"return\");case 6:_this2.moduleResourcesMap[locale]=_this2.moduleResourcesMap[locale]||{};resourceKeys=Object.keys(content);resourceKeys.forEach(function(resourceKey){if(content[resourceKey].value){_this2.moduleResourcesMap[locale][resourceKey]=content[resourceKey].value;}});case 9:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x3){return _ref2.apply(this,arguments);};}()));case 28:_context3.next=30;return this._getAllModuleDefinitions();case 30:case\"end\":return _context3.stop();}}},_callee3,this);}));function init(_x){return _init.apply(this,arguments);}return init;}()/**\r\n     * @function    {getModuleResources}    - Method to fetch resource strings of a module for given locale\r\n     * @param       {moduleName}            - name of the module\r\n     * @param       {locale}                - locale for which resource strings need to be fetched\r\n     */},{key:\"getModuleResources\",value:function getModuleResources(moduleName,locale){var _this3=this;if(!this.moduleResourceKeys||!this.moduleResourceKeys[moduleName]||!this.moduleNamespaceMap||!this.moduleNamespaceMap[moduleName]){return{};}var parentFallbackLocale=locale.length>0?locale.split('-',1)[0].toLocaleLowerCase():'';locale=locale?locale.toLocaleLowerCase():GLOBAL_LOCALE;var resourcesObj={};var moduleNamespace=this.moduleNamespaceMap[moduleName];var resourceKeys=Object.keys(this.moduleResourceKeys[moduleName]);var fillModuleResources=function fillModuleResources(resourceKey,localeStr){if(_this3.moduleResourcesMap[localeStr]){if(moduleNamespace==='__local__'&&_this3.moduleResourcesMap[localeStr][resourceKey]){resourcesObj[resourceKey]=_this3.moduleResourcesMap[localeStr][resourceKey];}else if(_this3.moduleResourcesMap[localeStr][\"\".concat(moduleNamespace,\".\").concat(resourceKey)]){resourcesObj[resourceKey]=_this3.moduleResourcesMap[localeStr][\"\".concat(moduleNamespace,\".\").concat(resourceKey)];}}};resourceKeys.forEach(function(resourceKey){fillModuleResources(resourceKey,locale);// Fallback to parent locale resource, eg: if `es-ar` then parent fallback is `es`\nif(!resourcesObj[resourceKey]){fillModuleResources(resourceKey,parentFallbackLocale);}// Fallback to global locale resource\nif(!resourcesObj[resourceKey]){fillModuleResources(resourceKey,GLOBAL_LOCALE);}// Fall back to defaults in module definition\nif(!resourcesObj[resourceKey]){resourcesObj[resourceKey]=_this3.moduleResourceKeys[moduleName][resourceKey];}});return resourcesObj;}},{key:\"getAuthoringResources\",value:function getAuthoringResources(){return this.authoringResourcesMap;}},{key:\"_readAuthoringResourceFiles\",value:function(){var _readAuthoringResourceFiles2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var _this4=this;var installedAuthoringResourceFiles;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return safeGetAllFilesPath(installedAuthoringResourcesPathPattern);case 2:installedAuthoringResourceFiles=_context5.sent;_context5.t0=installedAuthoringResourceFiles;_context5.next=6;return safeGetAllFilesPath(hoistedAuthoringResourcesPathPattern);case 6:_context5.t1=_context5.sent;installedAuthoringResourceFiles=_context5.t0.concat.call(_context5.t0,_context5.t1);_context5.next=10;return Promise.all(installedAuthoringResourceFiles.map(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(resourceFile){var locale,content;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:locale=path.basename(resourceFile,'.json').toLocaleLowerCase();_context4.next=3;return safeReadJson(resourceFile);case 3:content=_context4.sent;if(content){_this4.authoringResourcesMap[locale]=content;}case 5:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x4){return _ref3.apply(this,arguments);};}()));case 10:case\"end\":return _context5.stop();}}},_callee5);}));function _readAuthoringResourceFiles(){return _readAuthoringResourceFiles2.apply(this,arguments);}return _readAuthoringResourceFiles;}()},{key:\"_readModuleResourceFiles\",value:function(){var _readModuleResourceFiles2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var _this5=this;var installedModulesResourceFiles;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return safeGetAllFilesPath(installedModulesResourcesPathPattern);case 2:installedModulesResourceFiles=_context7.sent;_context7.t0=installedModulesResourceFiles;_context7.next=6;return safeGetAllFilesPath(hoistedModulesResourcesPathPattern);case 6:_context7.t1=_context7.sent;installedModulesResourceFiles=_context7.t0.concat.call(_context7.t0,_context7.t1);_context7.next=10;return Promise.all(installedModulesResourceFiles.map(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(resourceFile){var matchResult,moduleNamespace,locale,content;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:matchResult=resourceFile.match(RESOURCE_DETAILS_REGEX);moduleNamespace='__installed__';if(matchResult!==null&&matchResult.groups&&matchResult.groups.namespace){moduleNamespace=matchResult.groups.namespace;}locale=path.basename(resourceFile,'.json').toLocaleLowerCase();_context6.next=6;return safeReadJson(resourceFile);case 6:content=_context6.sent;if(content){_context6.next=9;break;}return _context6.abrupt(\"return\");case 9:_this5.moduleResourcesMap[locale]=_this5.moduleResourcesMap[locale]||{};Object.keys(content).forEach(function(resourceKey){if(content[resourceKey].value){_this5.moduleResourcesMap[locale][\"\".concat(moduleNamespace,\".\").concat(resourceKey)]=content[resourceKey].value;}});case 11:case\"end\":return _context6.stop();}}},_callee6);}));return function(_x5){return _ref4.apply(this,arguments);};}()));case 10:case\"end\":return _context7.stop();}}},_callee7);}));function _readModuleResourceFiles(){return _readModuleResourceFiles2.apply(this,arguments);}return _readModuleResourceFiles;}()},{key:\"_getAllModuleDefinitions\",value:function(){var _getAllModuleDefinitions2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(){var _this6=this;var modules,themeModules,defExtResources;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:// tslint:disable-next-line:no-any\nmodules=msdyn365Commerce.getAllModuleBinder();_context9.next=3;return getThemeModules(null,StaticTelemetry);case 3:themeModules=_context9.sent;defExtResources={};// Get resources object from definition extensions of theme modules\nif(themeModules&&Array.isArray(themeModules)){(themeModules||[]).map(function(themeModule){Object.keys(themeModule.definitionExtensions||[]).map(function(moduleName){if(defExtResources[moduleName]){defExtResources[moduleName]=_objectSpread(_objectSpread({},defExtResources[moduleName]),themeModule.definitionExtensions[moduleName].resources||{});}else{defExtResources[moduleName]=themeModule.definitionExtensions[moduleName].resources||{};}});});}return _context9.abrupt(\"return\",Promise.all(modules.map(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(moduleBinder){var definition,moduleResources,resourcesObject;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return getModuleDefinition(moduleBinder,StaticTelemetry);case 2:definition=_context8.sent;_this6.moduleNamespaceMap[moduleBinder.name]=moduleBinder.moduleNamespace;moduleResources=definition.resources||{};// Merge definition extension resources\nif(defExtResources[moduleBinder.name]){moduleResources=_objectSpread(_objectSpread({},moduleResources),defExtResources[moduleBinder.name]);}resourcesObject={};Object.keys(moduleResources).map(function(key){resourcesObject[key]=moduleResources[key].value;});_this6.moduleResourceKeys[definition.name]=resourcesObject;return _context8.abrupt(\"return\",definition);case 10:case\"end\":return _context8.stop();}}},_callee8);}));return function(_x6){return _ref5.apply(this,arguments);};}())));case 7:case\"end\":return _context9.stop();}}},_callee9);}));function _getAllModuleDefinitions(){return _getAllModuleDefinitions2.apply(this,arguments);}return _getAllModuleDefinitions;}()},{key:\"_getMergedAuthoringResources\",value:function _getMergedAuthoringResources(moduleAuthoringResources,overrideModuleAuthoringResources){moduleAuthoringResources=moduleAuthoringResources||{};overrideModuleAuthoringResources=overrideModuleAuthoringResources||{};var mergedModuleAuthoringResources=_objectSpread(_objectSpread({},moduleAuthoringResources),overrideModuleAuthoringResources);// Do explicit merge of each properties as '...' does not do recursive merge\nvar moduleAuthoringResourceProperties=Object.keys(moduleAuthoringResources);if(moduleAuthoringResourceProperties){moduleAuthoringResourceProperties.forEach(function(property){if(overrideModuleAuthoringResources[property]){mergedModuleAuthoringResources[property]=_objectSpread(_objectSpread({},moduleAuthoringResources[property]),overrideModuleAuthoringResources[property]||{});}});}return mergedModuleAuthoringResources;}}]);return ResourceManager;}();","map":{"version":3,"sources":["../../../src/resources/resource-manager.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport {\n    IAuthoringResourceDefinition,\n    IDictionary,\n    IModuleAuthoringResourceDefinition,\n    IPlatformSettings,\n    IResourceManager,\n    IResourceProperty,\n    IThemeModule,\n    msdyn365Commerce\n} from '@msdyn365-commerce/core-internal';\nimport { StaticTelemetry } from '@msdyn365-commerce/telemetry-internal';\nimport { safeGetAllFilesPath, safeReadJson } from '@msdyn365-commerce/utilities-internal';\nimport { merge as _merge } from 'lodash';\nimport path from 'path';\nimport { getModuleDefinition, getThemeModules, isDAPIOptimizationDisabled } from '../_server/Definition/moduleDefinition';\nimport { IModuleBinder } from '../app-initialization/models';\nimport keystonePaths from '../paths';\nimport {\n    hoistedAuthoringResourcesPathPattern,\n    hoistedModulesResourcesPathPattern,\n    installedAuthoringResourcesPathPattern,\n    installedModulesResourcesPathPattern,\n    localAuthoringResourcesPathPattern,\n    localModulesResourcesPathPattern\n} from './constants';\n\nconst GLOBAL_LOCALE = 'global';\nconst RESOURCE_DETAILS_REGEX = /\\/node_modules\\/(?<namespace>.*)\\/(?<packageName>.*)\\/dist\\/lib\\/.*/;\n\ninterface IResourcesDAPI {\n    authoringResourcesMap: IDictionary<IAuthoringResourceDefinition>;\n    moduleResourcesMap: IDictionary<IDictionary<string>>;\n    moduleResourceKeys: IDictionary<IDictionary<string>>;\n    moduleNamespaceMap: IDictionary<string>;\n}\n\n/**\n * Resource manager implementation\n */\nexport class ResourceManager implements IResourceManager {\n    private authoringResourcesMap: IDictionary<IAuthoringResourceDefinition>;\n\n    private moduleResourcesMap: IDictionary<IDictionary<string>>;\n\n    private moduleResourceKeys: IDictionary<IDictionary<string>>;\n\n    private moduleNamespaceMap: IDictionary<string>;\n\n    public constructor() {\n        this.authoringResourcesMap = {};\n        this.moduleResourcesMap = {};\n        this.moduleResourceKeys = {};\n        this.moduleNamespaceMap = {};\n    }\n\n    /**\n     * @function        {init}          - Method to initialize and load all the resource strings\n     */\n    public async init(platformSettings: IPlatformSettings): Promise<void> {\n        if (platformSettings && !!!platformSettings.disableDAPIOptimizations) {\n            const resourcesDapi: IResourcesDAPI =\n                <IResourcesDAPI>await safeReadJson(keystonePaths.KEYSTONE_APP_RESOURCES_DAPI_FILEPATH) || {};\n            this.authoringResourcesMap = resourcesDapi.authoringResourcesMap || {};\n            this.moduleResourcesMap = resourcesDapi.moduleResourcesMap || {};\n            this.moduleResourceKeys = resourcesDapi.moduleResourceKeys || {};\n            this.moduleNamespaceMap = resourcesDapi.moduleNamespaceMap || {};\n            return;\n        }\n\n        await this._readAuthoringResourceFiles();\n\n        const localAuthoringResourceFiles = await safeGetAllFilesPath(localAuthoringResourcesPathPattern);\n\n        if (localAuthoringResourceFiles.length > 0) {\n            await Promise.all(\n                localAuthoringResourceFiles.map(async (resourceFile: string) => {\n                    const locale = path.basename(resourceFile, '.json').toLocaleLowerCase();\n                    const content: IAuthoringResourceDefinition = <IAuthoringResourceDefinition>await safeReadJson(resourceFile);\n\n                    if (!content || !content.modules) {\n                        return;\n                    }\n\n                    this.authoringResourcesMap[locale] = this.authoringResourcesMap[locale] || {\n                        settings: {},\n                        modules: {},\n                        themes: {}\n                    };\n\n                    content.modules &&\n                        Object.keys(content.modules).forEach(moduleName => {\n                            this.authoringResourcesMap[locale].modules[moduleName] = this._getMergedAuthoringResources(\n                                this.authoringResourcesMap[locale].modules[moduleName],\n                                content.modules[moduleName]\n                            );\n\n                            if (content.settings) {\n                                this.authoringResourcesMap[locale].settings = content.settings;\n                            }\n                            this.authoringResourcesMap[locale].themes = {};\n                        });\n\n                    if (content.themes) {\n                        Object.keys(content.themes).forEach(themeName => {\n                            this.authoringResourcesMap[locale].themes[themeName] = _merge(\n                                this.authoringResourcesMap[locale].themes[themeName],\n                                content.themes[themeName]\n                            );\n                        });\n                    }\n                })\n            );\n        }\n\n        await this._readModuleResourceFiles();\n\n        const localModulesResourceFiles = await safeGetAllFilesPath(localModulesResourcesPathPattern);\n\n        if (localModulesResourceFiles.length > 0) {\n            await Promise.all(\n                localModulesResourceFiles.map(async (resourceFile: string) => {\n                    const locale = path.basename(resourceFile, '.json').toLocaleLowerCase();\n                    const content: IDictionary<IResourceProperty> = <IDictionary<IResourceProperty>>await safeReadJson(resourceFile);\n\n                    if (!content) {\n                        return;\n                    }\n\n                    this.moduleResourcesMap[locale] = this.moduleResourcesMap[locale] || {};\n                    const resourceKeys = Object.keys(content);\n                    resourceKeys.forEach(resourceKey => {\n                        if (content[resourceKey].value) {\n                            this.moduleResourcesMap[locale][resourceKey] = content[resourceKey].value;\n                        }\n                    });\n                })\n            );\n        }\n\n        await this._getAllModuleDefinitions();\n    }\n\n    /**\n     * @function    {getModuleResources}    - Method to fetch resource strings of a module for given locale\n     * @param       {moduleName}            - name of the module\n     * @param       {locale}                - locale for which resource strings need to be fetched\n     */\n    public getModuleResources(moduleName: string, locale: string): IDictionary<string> {\n        if (\n            !this.moduleResourceKeys ||\n            !this.moduleResourceKeys[moduleName] ||\n            !this.moduleNamespaceMap ||\n            !this.moduleNamespaceMap[moduleName]\n        ) {\n            return {};\n        }\n\n        const parentFallbackLocale = locale.length > 0 ? locale.split('-', 1)[0].toLocaleLowerCase() : '';\n        locale = locale ? locale.toLocaleLowerCase() : GLOBAL_LOCALE;\n\n        const resourcesObj = {};\n        const moduleNamespace = this.moduleNamespaceMap[moduleName];\n        const resourceKeys = Object.keys(this.moduleResourceKeys[moduleName]);\n\n        const fillModuleResources = (resourceKey: string, localeStr: string) => {\n            if (this.moduleResourcesMap[localeStr]) {\n                if (moduleNamespace === '__local__' && this.moduleResourcesMap[localeStr][resourceKey]) {\n                    resourcesObj[resourceKey] = this.moduleResourcesMap[localeStr][resourceKey];\n                } else if (this.moduleResourcesMap[localeStr][`${moduleNamespace}.${resourceKey}`]) {\n                    resourcesObj[resourceKey] = this.moduleResourcesMap[localeStr][`${moduleNamespace}.${resourceKey}`];\n                }\n            }\n        };\n        resourceKeys.forEach(resourceKey => {\n            fillModuleResources(resourceKey, locale);\n\n            // Fallback to parent locale resource, eg: if `es-ar` then parent fallback is `es`\n            if (!resourcesObj[resourceKey]) {\n                fillModuleResources(resourceKey, parentFallbackLocale);\n            }\n\n            // Fallback to global locale resource\n            if (!resourcesObj[resourceKey]) {\n                fillModuleResources(resourceKey, GLOBAL_LOCALE);\n            }\n\n            // Fall back to defaults in module definition\n            if (!resourcesObj[resourceKey]) {\n                resourcesObj[resourceKey] = this.moduleResourceKeys[moduleName][resourceKey];\n            }\n        });\n\n        return resourcesObj;\n    }\n\n    public getAuthoringResources(): IDictionary<IAuthoringResourceDefinition> {\n        return this.authoringResourcesMap;\n    }\n\n    private async _readAuthoringResourceFiles(): Promise<void> {\n        let installedAuthoringResourceFiles = await safeGetAllFilesPath(installedAuthoringResourcesPathPattern);\n        installedAuthoringResourceFiles = installedAuthoringResourceFiles.concat(\n            await safeGetAllFilesPath(hoistedAuthoringResourcesPathPattern)\n        );\n\n        await Promise.all(\n            installedAuthoringResourceFiles.map(async (resourceFile: string) => {\n                const locale = path.basename(resourceFile, '.json').toLocaleLowerCase();\n                const content = await safeReadJson<IAuthoringResourceDefinition>(resourceFile);\n                if (content) {\n                    this.authoringResourcesMap[locale] = content;\n                }\n            })\n        );\n    }\n\n    private async _readModuleResourceFiles(): Promise<void> {\n        let installedModulesResourceFiles = await safeGetAllFilesPath(installedModulesResourcesPathPattern);\n        installedModulesResourceFiles = installedModulesResourceFiles.concat(await safeGetAllFilesPath(hoistedModulesResourcesPathPattern));\n\n        await Promise.all(\n            installedModulesResourceFiles.map(async (resourceFile: string) => {\n                const matchResult = resourceFile.match(RESOURCE_DETAILS_REGEX);\n                let moduleNamespace = '__installed__';\n                if (matchResult !== null && matchResult.groups && matchResult.groups.namespace) {\n                    moduleNamespace = matchResult.groups.namespace;\n                }\n\n                const locale = path.basename(resourceFile, '.json').toLocaleLowerCase();\n                const content: IDictionary<IResourceProperty> = <IDictionary<IResourceProperty>>await safeReadJson(resourceFile);\n\n                if (!content) {\n                    return;\n                }\n\n                this.moduleResourcesMap[locale] = this.moduleResourcesMap[locale] || {};\n                Object.keys(content).forEach(resourceKey => {\n                    if (content[resourceKey].value) {\n                        this.moduleResourcesMap[locale][`${moduleNamespace}.${resourceKey}`] = content[resourceKey].value;\n                    }\n                });\n            })\n        );\n    }\n\n    private async _getAllModuleDefinitions(): Promise<object[]> {\n        // tslint:disable-next-line:no-any\n        const modules = (<any>msdyn365Commerce).getAllModuleBinder();\n        const themeModules = <IThemeModule[]>await getThemeModules(null, StaticTelemetry);\n        const defExtResources = {};\n\n        // Get resources object from definition extensions of theme modules\n        if (themeModules && Array.isArray(themeModules)) {\n            (themeModules || []).map(themeModule => {\n                Object.keys(themeModule.definitionExtensions || []).map(moduleName => {\n                    if (defExtResources[moduleName]) {\n                        defExtResources[moduleName] = {\n                            ...defExtResources[moduleName],\n                            ...(themeModule.definitionExtensions[moduleName].resources || {})\n                        };\n                    } else {\n                        defExtResources[moduleName] = themeModule.definitionExtensions[moduleName].resources || {};\n                    }\n                });\n            });\n        }\n\n        return Promise.all(\n            modules.map(async (moduleBinder: IModuleBinder) => {\n                const definition = await getModuleDefinition(moduleBinder, StaticTelemetry);\n                this.moduleNamespaceMap[moduleBinder.name] = moduleBinder.moduleNamespace;\n                let moduleResources = definition.resources || {};\n\n                // Merge definition extension resources\n                if (defExtResources[moduleBinder.name]) {\n                    moduleResources = {\n                        ...moduleResources,\n                        ...defExtResources[moduleBinder.name]\n                    };\n                }\n\n                const resourcesObject = {};\n                Object.keys(moduleResources).map(key => {\n                    resourcesObject[key] = moduleResources[key].value;\n                });\n\n                this.moduleResourceKeys[definition.name] = resourcesObject;\n\n                return definition;\n            })\n        );\n    }\n\n    private _getMergedAuthoringResources(\n        moduleAuthoringResources: IModuleAuthoringResourceDefinition,\n        overrideModuleAuthoringResources: IModuleAuthoringResourceDefinition\n    ): IModuleAuthoringResourceDefinition {\n        moduleAuthoringResources = moduleAuthoringResources || {};\n        overrideModuleAuthoringResources = overrideModuleAuthoringResources || {};\n\n        const mergedModuleAuthoringResources = {\n            ...moduleAuthoringResources,\n            ...overrideModuleAuthoringResources\n        };\n\n        // Do explicit merge of each properties as '...' does not do recursive merge\n\n        const moduleAuthoringResourceProperties = Object.keys(moduleAuthoringResources);\n        if (moduleAuthoringResourceProperties) {\n            moduleAuthoringResourceProperties.forEach(property => {\n                if (overrideModuleAuthoringResources[property]) {\n                    mergedModuleAuthoringResources[property] = {\n                        ...moduleAuthoringResources[property],\n                        ...(overrideModuleAuthoringResources[property] || {})\n                    };\n                }\n            });\n        }\n\n        return mergedModuleAuthoringResources;\n    }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}