{"ast":null,"code":"import\"core-js/modules/es.string.includes.js\";import\"core-js/modules/es.string.split.js\";import\"core-js/modules/es.string.starts-with.js\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{EditError,PROPERTY_INIT}from'@msdyn365-commerce/core-internal';import{CLIENT_DATA_UPDATE_EVENT,MSDYN365_WYSIWYG_DISABLED_PROPS}from'../consts';const MODULE_NAME_PATH='__MODULE_NAME__';const MODULE_TYPE_PATH='__MODULE_TYPE__';const PARENT_PROP_PATH='__PARENT_PROP__';export const getWrappedProxyObject=(config,moduleName,typeName)=>{// tslint:disable-next-line:no-typeof-undefined\nif(typeof window==='undefined'){return config;}return getProxyHandler(config,moduleName,typeName);};/**\r\n * Get parent module id\r\n */export const disableChildModules=(parentModule,requestCache)=>{const slotKeys=Object.keys(parentModule.modules||[]);for(let i=0;i<slotKeys.length;++i){const childModules=parentModule.modules[slotKeys[i]];for(let j=0;j<childModules.length;++j){requestCache.put({typeName:MSDYN365_WYSIWYG_DISABLED_PROPS,key:childModules[j].id},{item:['*']});disableChildModules(childModules[j],requestCache);}}};/**\r\n * helper function to find module from page contract\r\n * @param moduleId module to be searched\r\n * @param pageRoot page root object\r\n */export const findModule=(moduleId,pageRoot)=>{if(pageRoot.id===moduleId){return pageRoot;}const slotKeys=Object.keys(pageRoot.modules||[]);for(let i=0;i<slotKeys.length;++i){const childModules=pageRoot.modules[slotKeys[i]];for(let j=0;j<childModules.length;++j){const res=findModule(moduleId,childModules[j]);if(res){return res;}}}return undefined;};/**\r\n * Returns proxy object with get and set traps\r\n */const getProxyHandler=(config,moduleName,moduleType)=>{const handler={get(target,key){// store current module name on the proxy object\nif(!target[MODULE_NAME_PATH]){target[MODULE_NAME_PATH]=moduleName;}if(!target[MODULE_TYPE_PATH]){target[MODULE_TYPE_PATH]=moduleType;}if(typeof target[key]==='object'&&target[key]!==null){// store current prop path as parent and return new proxy (for objects)\ntarget[key][PARENT_PROP_PATH]=target[PARENT_PROP_PATH]?\"\".concat(target[PARENT_PROP_PATH],\".\").concat(key):key;return new Proxy(target[key],handler);}else{return target[key];}},// tslint:disable-next-line:no-any\nset(target,key,newValue){let disabledProperties=[];const moduleId=target[MODULE_NAME_PATH];const typeName=target[MODULE_TYPE_PATH];let propertyPath=[key];if(target[PARENT_PROP_PATH]){// @ts-ignore\nconst parentPath=target[PARENT_PROP_PATH].split('.');propertyPath=key==='$type'?parentPath:parentPath.concat([key]);}// @ts-ignore\ndisabledProperties=window._msdyn365.authoringHelper.getDisabledProperties(moduleId);if((disabledProperties||[]).length>0){// if the value is '*' all properties are disabled\nif(disabledProperties.length===1&&disabledProperties[0]==='*'){throw new EditError('cannot set disabled property');}const fullPath=propertyPath.join('.');// properties disabled in template are disabled at root property path - and will only contain part of the updated property's full path\n// e.g. disabledProperties = ['heading','links'], updatedProperty = 'heading.text' and 'links.1.linkText' are disabled\n// we check for fullPath.startsWith(`${p}.`) to handle cases where 'heading' prop is disabled and edited property is 'headingLink'\nif(disabledProperties.filter(p=>fullPath===p||fullPath.startsWith(\"\".concat(p,\".\"))).length>0){throw new EditError('cannot set disabled property');}}if(newValue==='__MSDYN365_WYSIWYG_INIT__'){// for events that are called as part of initialization, do no set any value\n// as the initialization is to check if a property is disabled\nconst requiredProperties=getRequiredProperties(typeName)||[];throw new EditError('cannot set disabled property',PROPERTY_INIT,requiredProperties.includes(propertyPath.join('.')));}document.dispatchEvent(new CustomEvent(CLIENT_DATA_UPDATE_EVENT,{detail:{moduleId,value:newValue,property:propertyPath}}));return true;}};return new Proxy(config,handler);};/**\r\n * helper method to get required properties\r\n */const getRequiredProperties=typeName=>{if(!(typeof window===undefined)){// @ts-ignore\nconst authoringHelper=window._msdyn365.authoringHelper;return authoringHelper&&authoringHelper.renderingHelper&&authoringHelper.renderingHelper.moduleRequiredProperties(typeName);}return[];};","map":{"version":3,"sources":["../../../src/store/authoring-edit-helper.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { ICache } from '@msdyn365-commerce/cache-internal';\nimport { EditError, IDictionary, IModuleContract, PROPERTY_INIT } from '@msdyn365-commerce/core-internal';\nimport { get as _get } from 'lodash';\nimport { CLIENT_DATA_UPDATE_EVENT, MSDYN365_WYSIWYG_DISABLED_PROPS } from '../consts';\n\nconst MODULE_NAME_PATH = '__MODULE_NAME__';\n\nconst MODULE_TYPE_PATH = '__MODULE_TYPE__';\n\nconst PARENT_PROP_PATH = '__PARENT_PROP__';\n\nexport interface IDisabledProperties {\n    modules: IDictionary<string[]>;\n}\n\nexport const getWrappedProxyObject = (config: IDictionary<{}>, moduleName: string, typeName: string) => {\n    // tslint:disable-next-line:no-typeof-undefined\n    if (typeof window === 'undefined') {\n        return config;\n    }\n\n    return getProxyHandler(config, moduleName, typeName);\n};\n\n/**\n * Get parent module id\n */\nexport const disableChildModules = (parentModule: IModuleContract, requestCache: ICache) => {\n    const slotKeys = Object.keys(parentModule.modules || []);\n    for (let i = 0; i < slotKeys.length; ++i) {\n        const childModules: IModuleContract[] = parentModule.modules![slotKeys[i]];\n        for (let j = 0; j < childModules.length; ++j) {\n            requestCache.put({ typeName: MSDYN365_WYSIWYG_DISABLED_PROPS, key: childModules[j].id }, { item: ['*'] });\n            disableChildModules(childModules[j], requestCache);\n        }\n    }\n};\n\n/**\n * helper function to find module from page contract\n * @param moduleId module to be searched\n * @param pageRoot page root object\n */\nexport const findModule = (moduleId: string, pageRoot: IModuleContract): IModuleContract | undefined => {\n    if (pageRoot.id === moduleId) {\n        return pageRoot;\n    }\n\n    const slotKeys = Object.keys(pageRoot.modules || []);\n    for (let i = 0; i < slotKeys.length; ++i) {\n        const childModules: IModuleContract[] = pageRoot.modules![slotKeys[i]];\n        for (let j = 0; j < childModules.length; ++j) {\n            const res = findModule(moduleId, childModules[j]);\n            if (res) {\n                return res;\n            }\n        }\n    }\n\n    return undefined;\n};\n\n/**\n * Returns proxy object with get and set traps\n */\nconst getProxyHandler = (config: IDictionary<{}>, moduleName: string, moduleType: string): unknown => {\n    const handler: ProxyHandler<IDictionary<{}>> = {\n        get(target: IDictionary<{}>, key: string): IDictionary<{}> | string {\n            // store current module name on the proxy object\n            if (!target[MODULE_NAME_PATH]) {\n                target[MODULE_NAME_PATH] = moduleName;\n            }\n\n            if (!target[MODULE_TYPE_PATH]) {\n                target[MODULE_TYPE_PATH] = moduleType;\n            }\n\n            if (typeof target[key] === 'object' && target[key] !== null) {\n                // store current prop path as parent and return new proxy (for objects)\n                target[key][PARENT_PROP_PATH] = target[PARENT_PROP_PATH] ? `${target[PARENT_PROP_PATH]}.${key}` : key;\n                return new Proxy(target[key], handler);\n            } else {\n                return target[key];\n            }\n        },\n\n        // tslint:disable-next-line:no-any\n        set(target: IDictionary<{}>, key: string, newValue: any): boolean {\n            let disabledProperties: string[] = [];\n            const moduleId = target[MODULE_NAME_PATH];\n            const typeName: string = <string>target[MODULE_TYPE_PATH];\n            let propertyPath = [key];\n\n            if (target[PARENT_PROP_PATH]) {\n                // @ts-ignore\n                const parentPath = target[PARENT_PROP_PATH].split('.');\n                propertyPath = key === '$type' ? parentPath : parentPath.concat([key]);\n            }\n\n            // @ts-ignore\n            disabledProperties = window._msdyn365.authoringHelper.getDisabledProperties(moduleId);\n\n            if ((disabledProperties || []).length > 0) {\n                // if the value is '*' all properties are disabled\n                if (disabledProperties.length === 1 && disabledProperties[0] === '*') {\n                    throw new EditError('cannot set disabled property');\n                }\n\n                const fullPath = propertyPath.join('.');\n                // properties disabled in template are disabled at root property path - and will only contain part of the updated property's full path\n                // e.g. disabledProperties = ['heading','links'], updatedProperty = 'heading.text' and 'links.1.linkText' are disabled\n                // we check for fullPath.startsWith(`${p}.`) to handle cases where 'heading' prop is disabled and edited property is 'headingLink'\n                if (disabledProperties.filter(p => fullPath === p || fullPath.startsWith(`${p}.`)).length > 0) {\n                    throw new EditError('cannot set disabled property');\n                }\n            }\n\n            if (newValue === '__MSDYN365_WYSIWYG_INIT__') {\n                // for events that are called as part of initialization, do no set any value\n                // as the initialization is to check if a property is disabled\n                const requiredProperties: string[] = getRequiredProperties(typeName) || [];\n                throw new EditError('cannot set disabled property', PROPERTY_INIT, requiredProperties.includes(propertyPath.join('.')));\n            }\n\n            document.dispatchEvent(\n                new CustomEvent(CLIENT_DATA_UPDATE_EVENT, {\n                    detail: { moduleId, value: newValue, property: propertyPath }\n                })\n            );\n            return true;\n        }\n    };\n\n    return new Proxy(config, handler);\n};\n\n/**\n * helper method to get required properties\n */\nconst getRequiredProperties = (typeName: string) => {\n    if (!(typeof window === undefined)) {\n        // @ts-ignore\n        const authoringHelper = window._msdyn365.authoringHelper;\n        return authoringHelper && authoringHelper.renderingHelper && authoringHelper.renderingHelper.moduleRequiredProperties(typeName);\n    }\n\n    return [];\n};\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}