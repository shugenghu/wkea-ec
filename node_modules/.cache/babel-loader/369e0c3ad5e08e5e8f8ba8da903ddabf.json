{"ast":null,"code":"import\"core-js/modules/es.object.assign.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{msdyn365Commerce}from'@msdyn365-commerce/core-internal';import{asSystemMetadata,EXCEPTION_NOMODULEBINDER,LogLevel}from'@msdyn365-commerce/telemetry-internal';import React from'react';import{getModuleName}from'../utils/helpers';const getModuleBinder=typeName=>msdyn365Commerce.moduleBinder(typeName);const getBinder=lookupKey=>{const view=msdyn365Commerce.componentBinder(lookupKey);if(view){return{key:lookupKey,view};}return undefined;};/* component will be read in following hierarchy\r\n        1) __local__/__local__|views/theme1/BuyBox/Components/PriceComponent\r\n        2) __local__/__local__|views/theme1/Components/PriceComponent\r\n        3) @msdyn-365-commerce-modules/theme1/views/BuyBox/Components/PriceComponent\r\n        4) @msdyn-365-commerce-modules/theme1/views/Components/PriceComponent\r\n    */const lookupFunc=(moduleBinder,themeBinder,name)=>{name=name.toLowerCase();return themeBinder&&(getBinder(\"__local__|__local__|themes|\".concat(themeBinder.name,\"|views|\").concat(moduleBinder.name,\"|components|\").concat(name))||getBinder(\"__local__|__local__|themes|\".concat(themeBinder.name,\"|views|components|\").concat(name))||getBinder(\"\".concat(themeBinder.moduleNamespace,\"|\").concat(themeBinder.packageName,\"|modules|\").concat(themeBinder.name,\"|views|components|\").concat(moduleBinder.name,\"|\").concat(name))||getBinder(\"\".concat(themeBinder.moduleNamespace,\"|\").concat(themeBinder.packageName,\"|modules|\").concat(themeBinder.name,\"|views|components|\").concat(name)))||getBinder(\"\".concat(moduleBinder.moduleNamespace,\"|\").concat(moduleBinder.packageName,\"|views|\").concat(moduleBinder.name,\"|components|\").concat(name));};/**\r\n * Component will be read from the module\r\n *  @msdyn-365-commerce-modules/BuyBox/views/BuyBox/Components/PriceComponent\r\n */const defaultComponentLookupFunc=(moduleBinder,name)=>{const parentModuleBinder=getModuleBinder(getModuleName(moduleBinder.parentDefinitionPath));return getBinder(\"\".concat(moduleBinder.moduleNamespace,\"|\").concat(moduleBinder.packageName,\"|views|\").concat(moduleBinder.name,\"|components|\").concat(name))||parentModuleBinder&&getBinder(\"\".concat(parentModuleBinder.moduleNamespace,\"|\").concat(parentModuleBinder.packageName,\"|views|\").concat(parentModuleBinder.name,\"|components|\").concat(name));};const getComponent=(name,moduleBinder,themeBinder,context)=>{if(!moduleBinder){return{view:null};}// tslint:disable-next-line:no-any\nconst cache=msdyn365Commerce.getAppCache(context.actionContext.requestContext);const cacheKey={key:\"\".concat(name,\"|\").concat(moduleBinder.name,\"|\").concat(themeBinder?themeBinder.name:'no-theme'),typeName:'__ComponentCacheKey__'};const lookupKey=cache.getValue(cacheKey);if(lookupKey){context.telemetry.log(LogLevel.Debug,\"lookup key for component [\".concat(cacheKey.key,\"] found at - [\").concat(lookupKey,\"]\"));// @ts-ignore\n!msdyn365Commerce.isBrowser&&context.actionContext.requestCache.put(cacheKey,{item:lookupKey});return getBinder(lookupKey)||{view:null};}let component=lookupFunc(moduleBinder,themeBinder,name);// If no component found in the theme, search in parent theme (in case of inherited theme)\nif(!component&&themeBinder){const parentThemeName=getModuleName(themeBinder.parentDefinitionPath);const parentThemeBinder=getModuleBinder(parentThemeName);component=lookupFunc(moduleBinder,parentThemeBinder,name);}// If no component file found, fall back to module's default component\nif(!component){component=defaultComponentLookupFunc(moduleBinder,name);}if(component){context.telemetry.log(LogLevel.Debug,\"lookup key for component [\".concat(cacheKey.key,\"] found at - [\").concat(component.key,\"]\"));cache.put(cacheKey,{item:component.key});// @ts-ignore\ncontext.actionContext.requestCache.put(cacheKey,{item:component.key});return component;}return{view:null};};export const createComponent=(name,componentObj)=>props=>{props.context.telemetry.log(LogLevel.Debug,\"rendering component-'\".concat(name,\"' within module-'\").concat(props.id,\"-\").concat(props.typeName,\"'\"));const moduleBinder=getModuleBinder(props.typeName);if(!moduleBinder){props.context.telemetry.log(LogLevel.Error,EXCEPTION_NOMODULEBINDER,{values:[asSystemMetadata(props.typeName)]});return null;}const themeBinder=getModuleBinder(props.context.actionContext.requestContext.params.theme);const{view}=getComponent(name,moduleBinder,themeBinder,props.context);const mergedComponent=view?_objectSpread(_objectSpread({},componentObj),view):componentObj;const Component=mergedComponent.component;return/*#__PURE__*/React.createElement(Component,Object.assign({},props));};","map":{"version":3,"sources":["../../../src/app-initialization/render-component.tsx"],"names":[],"mappings":"+4BAKA,OAA4E,gBAA5E,KAAoG,kCAApG,CACA,OAAS,gBAAT,CAA2B,wBAA3B,CAAqD,QAArD,KAAqE,uCAArE,CAEA,MAAO,CAAA,KAAP,KAAkB,OAAlB,CAEA,OAAS,aAAT,KAA8B,kBAA9B,CAMA,KAAM,CAAA,eAAe,CAAI,QAAD,EAAwB,gBAA2D,CAAC,YAA5D,CAAyE,QAAzE,CAAhD,CAEA,KAAM,CAAA,SAAS,CAAI,SAAD,EAAsB,CACpC,KAAM,CAAA,IAAI,CAAK,gBAA2D,CAAC,eAA5D,CAA4E,SAA5E,CAAf,CACA,GAAI,IAAJ,CAAU,CACN,MAAO,CAAE,GAAG,CAAE,SAAP,CAAkB,IAAlB,CAAP,CACH,CACD,MAAO,CAAA,SAAP,CACH,CAND,CAQA;;;;;AAKM,MACN,KAAM,CAAA,UAAU,CAAG,CAAC,YAAD,CAAe,WAAf,CAA4B,IAA5B,GAAoC,CACnD,IAAI,CAAG,IAAI,CAAC,WAAL,EAAP,CACA,MACK,CAAA,WAAW,GACP,SAAS,sCAA+B,WAAW,CAAC,IAA3C,mBAAyD,YAAY,CAAC,IAAtE,wBAAyF,IAAzF,EAAT,EACG,SAAS,sCAA+B,WAAW,CAAC,IAA3C,8BAAoE,IAApE,EADZ,EAEG,SAAS,WACF,WAAW,CAAC,eADV,aAC6B,WAAW,CAAC,WADzC,qBACgE,WAAW,CAAC,IAD5E,8BACqG,YAAY,CAAC,IADlH,aAC0H,IAD1H,EAFZ,EAKG,SAAS,WACF,WAAW,CAAC,eADV,aAC6B,WAAW,CAAC,WADzC,qBACgE,WAAW,CAAC,IAD5E,8BACqG,IADrG,EANL,CAAZ,EASA,SAAS,WAAI,YAAY,CAAC,eAAjB,aAAoC,YAAY,CAAC,WAAjD,mBAAsE,YAAY,CAAC,IAAnF,wBAAsG,IAAtG,EAVb,CAYH,CAdD,CAgBA;;;AAGG,GACH,KAAM,CAAA,0BAA0B,CAAG,CAAC,YAAD,CAAe,IAAf,GAAuB,CACtD,KAAM,CAAA,kBAAkB,CAAG,eAAe,CAAC,aAAa,CAAC,YAAY,CAAC,oBAAd,CAAd,CAA1C,CAEA,MACI,CAAA,SAAS,WAAI,YAAY,CAAC,eAAjB,aAAoC,YAAY,CAAC,WAAjD,mBAAsE,YAAY,CAAC,IAAnF,wBAAsG,IAAtG,EAAT,EACC,kBAAkB,EACf,SAAS,WACF,kBAAkB,CAAC,eADjB,aACoC,kBAAkB,CAAC,WADvD,mBAC4E,kBAAkB,CAAC,IAD/F,wBACkH,IADlH,EAHjB,CAOH,CAVD,CAYA,KAAM,CAAA,YAAY,CAAG,CAAC,IAAD,CAAO,YAAP,CAAqB,WAArB,CAAkC,OAAlC,GAA2D,CAC5E,GAAI,CAAC,YAAL,CAAmB,CACf,MAAO,CAAE,IAAI,CAAE,IAAR,CAAP,CACH,CAED;AACA,KAAM,CAAA,KAAK,CAAY,gBAAwB,CAAC,WAAzB,CAAqC,OAAO,CAAC,aAAR,CAAsB,cAA3D,CAAvB,CACA,KAAM,CAAA,QAAQ,CAAc,CACxB,GAAG,WAAK,IAAL,aAAa,YAAY,CAAC,IAA1B,aAAkC,WAAW,CAAG,WAAW,CAAC,IAAf,CAAsB,UAAnE,CADqB,CAExB,QAAQ,CAAE,uBAFc,CAA5B,CAIA,KAAM,CAAA,SAAS,CAAG,KAAK,CAAC,QAAN,CAAuB,QAAvB,CAAlB,CAEA,GAAI,SAAJ,CAAe,CACX,OAAO,CAAC,SAAR,CAAkB,GAAlB,CAAsB,QAAQ,CAAC,KAA/B,qCAAmE,QAAQ,CAAC,GAA5E,0BAAgG,SAAhG,OACA;AACA,CAAC,gBAAgB,CAAC,SAAlB,EAA+B,OAAO,CAAC,aAAR,CAAsB,YAAtB,CAAmC,GAAnC,CAAuC,QAAvC,CAAiD,CAAE,IAAI,CAAE,SAAR,CAAjD,CAA/B,CACA,MAAO,CAAA,SAAS,CAAC,SAAD,CAAT,EAAwB,CAAE,IAAI,CAAE,IAAR,CAA/B,CACH,CAED,GAAI,CAAA,SAAS,CAAG,UAAU,CAAC,YAAD,CAAe,WAAf,CAA4B,IAA5B,CAA1B,CAEA;AACA,GAAI,CAAC,SAAD,EAAc,WAAlB,CAA+B,CAC3B,KAAM,CAAA,eAAe,CAAG,aAAa,CAAC,WAAW,CAAC,oBAAb,CAArC,CACA,KAAM,CAAA,iBAAiB,CAAG,eAAe,CAAC,eAAD,CAAzC,CACA,SAAS,CAAG,UAAU,CAAC,YAAD,CAAe,iBAAf,CAAkC,IAAlC,CAAtB,CACH,CAED;AACA,GAAI,CAAC,SAAL,CAAgB,CACZ,SAAS,CAAG,0BAA0B,CAAC,YAAD,CAAe,IAAf,CAAtC,CACH,CAED,GAAI,SAAJ,CAAe,CACX,OAAO,CAAC,SAAR,CAAkB,GAAlB,CAAsB,QAAQ,CAAC,KAA/B,qCAAmE,QAAQ,CAAC,GAA5E,0BAAgG,SAAS,CAAC,GAA1G,OACA,KAAK,CAAC,GAAN,CAAU,QAAV,CAAoB,CAAE,IAAI,CAAE,SAAS,CAAC,GAAlB,CAApB,EACA;AACA,OAAO,CAAC,aAAR,CAAsB,YAAtB,CAAmC,GAAnC,CAAuC,QAAvC,CAAiD,CAAE,IAAI,CAAE,SAAS,CAAC,GAAlB,CAAjD,EACA,MAAO,CAAA,SAAP,CACH,CAED,MAAO,CAAE,IAAI,CAAE,IAAR,CAAP,CACH,CA3CD,CA6CA,MAAO,MAAM,CAAA,eAAe,CAAG,CAAwC,IAAxC,CAA6D,YAA7D,GAC3B,KAD4G,EAE5G,CACA,KAAK,CAAC,OAAN,CAAc,SAAd,CAAwB,GAAxB,CAA4B,QAAQ,CAAC,KAArC,gCAAoE,IAApE,6BAA4F,KAAK,CAAC,EAAlG,aAAwG,KAAK,CAAC,QAA9G,OACA,KAAM,CAAA,YAAY,CAAG,eAAe,CAAC,KAAK,CAAC,QAAP,CAApC,CACA,GAAI,CAAC,YAAL,CAAmB,CACf,KAAK,CAAC,OAAN,CAAc,SAAd,CAAwB,GAAxB,CAA4B,QAAQ,CAAC,KAArC,CAA4C,wBAA5C,CAAsE,CAAE,MAAM,CAAE,CAAC,gBAAgB,CAAC,KAAK,CAAC,QAAP,CAAjB,CAAV,CAAtE,EACA,MAAO,KAAP,CACH,CAED,KAAM,CAAA,WAAW,CAAG,eAAe,CAAC,KAAK,CAAC,OAAN,CAAc,aAAd,CAA4B,cAA5B,CAA2C,MAA3C,CAAkD,KAAnD,CAAnC,CACA,KAAM,CAAE,IAAF,EAAW,YAAY,CAAC,IAAD,CAAO,YAAP,CAAqB,WAArB,CAAkC,KAAK,CAAC,OAAxC,CAA7B,CACA,KAAM,CAAA,eAAe,CAAG,IAAI,gCAAU,YAAV,EAAkD,IAAlD,EAA2D,YAAvF,CACA,KAAM,CAAA,SAAS,CAAG,eAAe,CAAC,SAAlC,CACA,mBAAO,KAAA,CAAA,aAAA,CAAC,SAAD,CAAU,MAAA,CAAA,MAAA,CAAA,EAAA,CAAK,KAAL,CAAV,CAAP,CACH,CAfM","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\nimport { ICache, ICacheKey } from '@msdyn365-commerce/cache-internal';\nimport { ComponentType, IComponent, IComponentProps, ICoreContext, IModule, msdyn365Commerce } from '@msdyn365-commerce/core-internal';\nimport { asSystemMetadata, EXCEPTION_NOMODULEBINDER, LogLevel } from '@msdyn365-commerce/telemetry-internal';\nimport * as path from 'path';\nimport React from 'react';\nimport { IMSDyn365CommerceExtension } from '../app-initialization/models';\nimport { getModuleName } from '../utils/helpers';\n\nexport interface IModuleWithView extends IModule {\n    View: React.FunctionComponent;\n}\n\nconst getModuleBinder = (typeName: string) => ((msdyn365Commerce as unknown) as IMSDyn365CommerceExtension).moduleBinder(typeName);\n\nconst getBinder = (lookupKey: string) => {\n    const view = ((msdyn365Commerce as unknown) as IMSDyn365CommerceExtension).componentBinder(lookupKey);\n    if (view) {\n        return { key: lookupKey, view };\n    }\n    return undefined;\n};\n\n/* component will be read in following hierarchy\n        1) __local__/__local__|views/theme1/BuyBox/Components/PriceComponent\n        2) __local__/__local__|views/theme1/Components/PriceComponent\n        3) @msdyn-365-commerce-modules/theme1/views/BuyBox/Components/PriceComponent\n        4) @msdyn-365-commerce-modules/theme1/views/Components/PriceComponent\n    */\nconst lookupFunc = (moduleBinder, themeBinder, name) => {\n    name = name.toLowerCase();\n    return (\n        (themeBinder &&\n            (getBinder(`__local__|__local__|themes|${themeBinder.name}|views|${moduleBinder.name}|components|${name}`) ||\n                getBinder(`__local__|__local__|themes|${themeBinder.name}|views|components|${name}`) ||\n                getBinder(\n                    `${themeBinder.moduleNamespace}|${themeBinder.packageName}|modules|${themeBinder.name}|views|components|${moduleBinder.name}|${name}`\n                ) ||\n                getBinder(\n                    `${themeBinder.moduleNamespace}|${themeBinder.packageName}|modules|${themeBinder.name}|views|components|${name}`\n                ))) ||\n        getBinder(`${moduleBinder.moduleNamespace}|${moduleBinder.packageName}|views|${moduleBinder.name}|components|${name}`)\n    );\n};\n\n/**\n * Component will be read from the module\n *  @msdyn-365-commerce-modules/BuyBox/views/BuyBox/Components/PriceComponent\n */\nconst defaultComponentLookupFunc = (moduleBinder, name) => {\n    const parentModuleBinder = getModuleBinder(getModuleName(moduleBinder.parentDefinitionPath));\n\n    return (\n        getBinder(`${moduleBinder.moduleNamespace}|${moduleBinder.packageName}|views|${moduleBinder.name}|components|${name}`) ||\n        (parentModuleBinder &&\n            getBinder(\n                `${parentModuleBinder.moduleNamespace}|${parentModuleBinder.packageName}|views|${parentModuleBinder.name}|components|${name}`\n            ))\n    );\n};\n\nconst getComponent = (name, moduleBinder, themeBinder, context: ICoreContext) => {\n    if (!moduleBinder) {\n        return { view: null };\n    }\n\n    // tslint:disable-next-line:no-any\n    const cache: ICache = (msdyn365Commerce as any).getAppCache(context.actionContext.requestContext);\n    const cacheKey: ICacheKey = {\n        key: `${name}|${moduleBinder.name}|${themeBinder ? themeBinder.name : 'no-theme'}`,\n        typeName: '__ComponentCacheKey__'\n    };\n    const lookupKey = cache.getValue<string>(cacheKey);\n\n    if (lookupKey) {\n        context.telemetry.log(LogLevel.Debug, `lookup key for component [${cacheKey.key}] found at - [${lookupKey}]`);\n        // @ts-ignore\n        !msdyn365Commerce.isBrowser && context.actionContext.requestCache.put(cacheKey, { item: lookupKey });\n        return getBinder(lookupKey) || { view: null };\n    }\n\n    let component = lookupFunc(moduleBinder, themeBinder, name);\n\n    // If no component found in the theme, search in parent theme (in case of inherited theme)\n    if (!component && themeBinder) {\n        const parentThemeName = getModuleName(themeBinder.parentDefinitionPath);\n        const parentThemeBinder = getModuleBinder(parentThemeName);\n        component = lookupFunc(moduleBinder, parentThemeBinder, name);\n    }\n\n    // If no component file found, fall back to module's default component\n    if (!component) {\n        component = defaultComponentLookupFunc(moduleBinder, name);\n    }\n\n    if (component) {\n        context.telemetry.log(LogLevel.Debug, `lookup key for component [${cacheKey.key}] found at - [${component.key}]`);\n        cache.put(cacheKey, { item: component.key });\n        // @ts-ignore\n        context.actionContext.requestCache.put(cacheKey, { item: component.key });\n        return component;\n    }\n\n    return { view: null };\n};\n\nexport const createComponent = <T extends IComponent<IComponentProps>>(name: ComponentType, componentObj: T) => (\n    props: IComponentProps\n) => {\n    props.context.telemetry.log(LogLevel.Debug, `rendering component-'${name}' within module-'${props.id}-${props.typeName}'`);\n    const moduleBinder = getModuleBinder(props.typeName);\n    if (!moduleBinder) {\n        props.context.telemetry.log(LogLevel.Error, EXCEPTION_NOMODULEBINDER, { values: [asSystemMetadata(props.typeName)] });\n        return null;\n    }\n\n    const themeBinder = getModuleBinder(props.context.actionContext.requestContext.params.theme);\n    const { view } = getComponent(name, moduleBinder, themeBinder, props.context);\n    const mergedComponent = view ? { ...((componentObj as unknown) as object), ...view } : componentObj;\n    const Component = mergedComponent.component;\n    return <Component {...props} />;\n};\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}