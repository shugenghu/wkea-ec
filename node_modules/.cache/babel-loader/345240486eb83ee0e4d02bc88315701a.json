{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import{createObservableDataAction}from'@msdyn365-commerce/core';import{copyAsync,readAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';import{getCartState}from'./get-cart-state';/**\r\n * Input class for getCheckoutCart data action\r\n */export var GetCheckoutCartInput=function GetCheckoutCartInput(apiSettings){var _this=this;_classCallCheck(this,GetCheckoutCartInput);this.getCacheKey=function(){return\"CheckoutCart-chanId:\".concat(_this.apiSettings.channelId,\"-catId:\").concat(_this.apiSettings.catalogId);};this.getCacheObjectType=function(){return'CheckoutCart';};this.dataCacheType=function(){return'request';};this.apiSettings=apiSettings;};var createInput=function createInput(inputData){return new GetCheckoutCartInput(inputData.requestContext.apiSettings);};/**\r\n * Data action to copy the cart for checkout actions\r\n */export function getCheckoutCart(_x,_x2){return _getCheckoutCart.apply(this,arguments);}function _getCheckoutCart(){_getCheckoutCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var savedCheckoutCartId,cartCookieParts,checkoutCartId,isAuthenticated,checkoutCart,cartState;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:savedCheckoutCartId=ctx.requestContext.cookies.getCheckoutCartCookie();cartCookieParts=savedCheckoutCartId.split(':');checkoutCartId=null;isAuthenticated=ctx.requestContext.user.isAuthenticated;if(isAuthenticated&&cartCookieParts[0]===\"t\"/* Auth */||!isAuthenticated&&cartCookieParts[0]===\"p\"/* Anon */){checkoutCartId=cartCookieParts[1];}if(!checkoutCartId){_context.next=16;break;}_context.prev=6;_context.next=9;return readAsync({callerContext:ctx,bypassCache:'none'},checkoutCartId);case 9:checkoutCart=_context.sent;_context.next=16;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](6);ctx.telemetry.error('Error getting checkout cart based on saved checkout card id');ctx.telemetry.exception(_context.t0);case 16:_context.next=18;return getCartState(ctx);case 18:cartState=_context.sent;if(!(cartState&&cartState.cart.Id!==undefined)){_context.next=23;break;}if(!(checkoutCart&&checkoutCart.Version&&cartState.cart.Version&&checkoutCart.Version>cartState.cart.Version)){_context.next=22;break;}return _context.abrupt(\"return\",Promise.resolve(checkoutCart));case 22:return _context.abrupt(\"return\",copyAsync({callerContext:ctx},cartState.cart.Id,2).then(function(cart){ctx.requestContext.cookies.setCheckoutCartCookie(cart,isAuthenticated);return cart;})[\"catch\"](function(error){ctx.telemetry.error('Error copying cart');ctx.telemetry.exception(error);return undefined;}));case 23:return _context.abrupt(\"return\",undefined);case 24:case\"end\":return _context.stop();}}},_callee,null,[[6,12]]);}));return _getCheckoutCart.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce/global-state/get-checkout-cart',action:getCheckoutCart,input:createInput});","map":{"version":3,"sources":["data-actions/get-checkout-cart.ts"],"names":[],"mappings":"8MAAA,OAAoB,0BAApB,KAAyI,yBAAzI,CAEA,OAAS,SAAT,CAAoB,SAApB,KAAqC,qEAArC,CACA,OAAS,YAAT,KAA6B,kBAA7B,CAEA;;AAEG,GACH,UAAa,CAAA,oBAAb,CAGI,8BAAY,WAAZ,CAA6C,2DAItC,KAAA,WAAA,CAAc,+CAA6B,KAAI,CAAC,WAAL,CAAiB,SAA9C,mBAAiE,KAAI,CAAC,WAAL,CAAiB,SAAlF,GAAd,CACA,KAAA,kBAAA,CAAqB,iBAAM,cAAN,EAArB,CACA,KAAA,aAAA,CAAgB,iBAAiB,SAAjB,EAAhB,CALH,KAAK,WAAL,CAAmB,WAAnB,CACH,CALL,CAiBA,GAAM,CAAA,WAAW,CAAG,QAAd,CAAA,WAAc,CAAC,SAAD,CAAoC,CACpD,MAAO,IAAI,CAAA,oBAAJ,CAAyB,SAAS,CAAC,cAAV,CAAyB,WAAlD,CAAP,CACH,CAFD,CAIA;;AAEG,GACH,eAAsB,CAAA,eAAtB,wD,qGAAO,iBAA+B,KAA/B,CAA4D,GAA5D,gNACC,mBADD,CACuB,GAAG,CAAC,cAAJ,CAAmB,OAAnB,CAA2B,qBAA3B,EADvB,CAEG,eAFH,CAE+B,mBAAmB,CAAC,KAApB,CAA0B,GAA1B,CAF/B,CAGC,cAHD,CAGkB,IAHlB,CAIG,eAJH,CAIqB,GAAG,CAAC,cAAJ,CAAmB,IAAnB,CAAwB,eAJ7C,CAMH,GAAK,eAAe,EAAI,eAAe,CAAC,CAAD,CAAf,GAAkB,GAAA,UAAtC,EAAqE,CAAC,eAAD,EAAoB,eAAe,CAAC,CAAD,CAAf,GAAkB,GAAA,UAA/G,CAA2I,CACvI,cAAc,CAAG,eAAe,CAAC,CAAD,CAAhC,CACH,CARE,IAYC,cAZD,gEAc0B,CAAA,SAAS,CAAC,CAAE,aAAa,CAAE,GAAjB,CAAsB,WAAW,CAAE,MAAnC,CAAD,CAA8C,cAA9C,CAdnC,QAcK,YAdL,gGAgBK,GAAG,CAAC,SAAJ,CAAc,KAAd,CAAoB,6DAApB,EACA,GAAG,CAAC,SAAJ,CAAc,SAAd,cAjBL,+BAqBqB,CAAA,YAAY,CAAC,GAAD,CArBjC,SAqBG,SArBH,oBAsBC,SAAS,EAAI,SAAS,CAAC,IAAV,CAAe,EAAf,GAAsB,SAtBpC,gCAuBK,YAAY,EAAI,YAAY,CAAC,OAA7B,EAAwC,SAAS,CAAC,IAAV,CAAe,OAAvD,EAAkE,YAAY,CAAC,OAAb,CAAuB,SAAS,CAAC,IAAV,CAAe,OAvB7G,2DAwBY,OAAO,CAAC,OAAR,CAAsB,YAAtB,CAxBZ,0CA2BQ,SAAS,CAAC,CAAE,aAAa,CAAE,GAAjB,CAAD,CAAyB,SAAS,CAAC,IAAV,CAAe,EAAxC,CAA4C,CAA5C,CAAT,CACF,IADE,CACG,SAAA,IAAI,CAAG,CACT,GAAG,CAAC,cAAJ,CAAmB,OAAnB,CAA2B,qBAA3B,CAAiD,IAAjD,CAAuD,eAAvD,EACA,MAAO,CAAA,IAAP,CACH,CAJE,WAKI,SAAA,KAAK,CAAG,CACX,GAAG,CAAC,SAAJ,CAAc,KAAd,CAAoB,oBAApB,EACA,GAAG,CAAC,SAAJ,CAAc,SAAd,CAAwB,KAAxB,EACA,MAAO,CAAA,SAAP,CACH,CATE,CA3BR,0CAuCI,SAvCJ,uE,kDA0CP,cAAe,CAAA,0BAA0B,CAAC,CACtC,EAAE,CAAE,mDADkC,CAEtC,MAAM,CAA6B,eAFG,CAGtC,KAAK,CAAE,WAH+B,CAAD,CAAzC","sourcesContent":["import { CacheType, createObservableDataAction, IAction, IActionContext, IActionInput, ICommerceApiSettings, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { Cart } from '@msdyn365-commerce/retail-proxy';\nimport { copyAsync, readAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';\nimport { getCartState } from './get-cart-state';\n\n/**\n * Input class for getCheckoutCart data action\n */\nexport class GetCheckoutCartInput implements IActionInput {\n    private apiSettings: ICommerceApiSettings;\n\n    constructor(apiSettings: ICommerceApiSettings) {\n        this.apiSettings = apiSettings;\n    }\n\n    public getCacheKey = () => `CheckoutCart-chanId:${this.apiSettings.channelId}-catId:${this.apiSettings.catalogId}`;\n    public getCacheObjectType = () => 'CheckoutCart';\n    public dataCacheType = (): CacheType => 'request';\n}\n\nconst enum CartTokenPrefix {\n    Auth = 't',\n    Anon = 'p'\n}\n\nconst createInput = (inputData: ICreateActionContext) => {\n    return new GetCheckoutCartInput(inputData.requestContext.apiSettings);\n};\n\n/**\n * Data action to copy the cart for checkout actions\n */\nexport async function getCheckoutCart(input: GetCheckoutCartInput, ctx: IActionContext): Promise<Cart | undefined> {\n    let savedCheckoutCartId = ctx.requestContext.cookies.getCheckoutCartCookie();\n    const cartCookieParts: string[] = savedCheckoutCartId.split(':');\n    let checkoutCartId = null;\n    const isAuthenticated = ctx.requestContext.user.isAuthenticated;\n\n    if ((isAuthenticated && cartCookieParts[0] === CartTokenPrefix.Auth) || (!isAuthenticated && cartCookieParts[0] === CartTokenPrefix.Anon)) {\n        checkoutCartId = cartCookieParts[1];\n    }\n\n    let checkoutCart: Cart | undefined;\n\n    if (checkoutCartId) {\n        try {\n            checkoutCart = await readAsync({ callerContext: ctx, bypassCache: 'none' }, checkoutCartId);\n        } catch (error) {\n            ctx.telemetry.error('Error getting checkout cart based on saved checkout card id');\n            ctx.telemetry.exception(error);\n        }\n    }\n\n    const cartState = await getCartState(ctx);\n    if (cartState && cartState.cart.Id !== undefined) {\n        if (checkoutCart && checkoutCart.Version && cartState.cart.Version && checkoutCart.Version > cartState.cart.Version) {\n            return Promise.resolve(<Cart>checkoutCart);\n        }\n\n        return copyAsync({ callerContext: ctx }, cartState.cart.Id, 2)\n            .then(cart => {\n                ctx.requestContext.cookies.setCheckoutCartCookie(cart, isAuthenticated);\n                return cart;\n            })\n            .catch(error => {\n                ctx.telemetry.error('Error copying cart');\n                ctx.telemetry.exception(error);\n                return undefined;\n            });\n    }\n\n    return undefined;\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce/global-state/get-checkout-cart',\n    action: <IAction<Cart | undefined>>getCheckoutCart,\n    input: createInput\n});"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}