{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/es.string.includes.js\";import\"core-js/modules/es.string.split.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import\"core-js/modules/web.dom-collections.iterator.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _set2 from\"lodash/set\";import _remove2 from\"lodash/remove\";import _pullAt2 from\"lodash/pullAt\";import _isEqual2 from\"lodash/isEqual\";import _get2 from\"lodash/get\";import _cloneDeep2 from\"lodash/cloneDeep\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{CoreContext,onDrag as _onDrag,removePlaceholder as _removePlaceholder,setDraggable as _setDraggable}from'@msdyn365-commerce/core-internal';import{generateEventNameHash}from'@msdyn365-commerce/telemetry-internal';import{toJS}from'mobx';import React from'react';import ReactDOM from'react-dom';import{SafeRenderModule}from'../components/safe-render-module';import{LAYOUT_MOUNT_POINT,MODULE_ACTION_KEY,MODULE_CACHE_KEY,MODULE_CONFIG_ERRORS_KEY,MODULE_CONFIG_KEY,MODULE_DATA_KEY,MSDYN365_WYSIWYG_CANADDMODULE,MSDYN365_WYSIWYG_DISABLED_PROPS}from'../consts';import{loadData}from'../data/load-data';import{hydrateProductList}from'../hydrators/product-list-hydrator';import{disableChildModules,findModule}from'../store/authoring-edit-helper';import{constructVideoInformation,constructViewportInformationForImage,deleteCacheEntriesForModuleId,getPropertyFromDataIAttribute,moveArrayItem,resolveTypesInConfig}from'./authoring-tools-helper-utils';import{getFlattenedListOfModulesForFragment}from'./get-modules-flat-list';var MODULE_OPERATION;(function(MODULE_OPERATION){MODULE_OPERATION[MODULE_OPERATION[\"Find\"]=0]=\"Find\";MODULE_OPERATION[MODULE_OPERATION[\"Remove\"]=1]=\"Remove\";MODULE_OPERATION[MODULE_OPERATION[\"Add\"]=2]=\"Add\";MODULE_OPERATION[MODULE_OPERATION[\"Move\"]=3]=\"Move\";})(MODULE_OPERATION||(MODULE_OPERATION={}));/**\r\n * Provides the CMS tooling a way to update the CMS content\r\n */export class AuthoringToolsHelper{constructor(actionContext,themeSettings,coreContext,pageContext,moduleTelemetry){this.didFindModule=false;this.enableAuthoringRemoveAndAddModule=false;this.cache=pageContext.requestCache;this.actionContext=actionContext;this.themeSettings=themeSettings;this.coreContext=coreContext;this.pageContext=pageContext;this.moduleTelemetry=moduleTelemetry;this.enableAuthoringRemoveAndAddModule=coreContext.request.features&&coreContext.request.features.enableAuthoringRemoveAndAddModule;}initRenderingHelper(renderingHelper){this.renderingHelper=renderingHelper;}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModule(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  {\r\n     *     \"data\": {\r\n     *          \"myTitle\": {\"$type\":\"heading\",\"_id\":\"xekqxgmtadc\", \"text\":\"Hello World Heading\"},\r\n     *          \"myText\": {\"$type\":\"simpleText\",\"_id\":\"hkd849ztr3x\", \"text\":\"Hello............\"}\r\n     *      },\r\n     *     \"config\": {\r\n     *          showText: \"test 123\"\r\n     *     },\r\n     *     \"configErrors\": []\r\n     * })\r\n     */updateModule(moduleId,content){if(!moduleId||!moduleId.length){// TODO: Log to telemetry\nreturn false;}if(!content||!content.data&&!content.config){return false;}let updated=false;if(content.data){updated=this.cache.put({typeName:MODULE_DATA_KEY,key:moduleId},{item:content.data});}if(content.config){updated=this.cache.put({typeName:MODULE_CONFIG_KEY,key:moduleId},{item:content.config})||updated;}if(content.configErrors){updated=this.cache.put({typeName:MODULE_CONFIG_ERRORS_KEY,key:moduleId},{item:content.configErrors});}return updated;}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleConfig(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  {\r\n     *          showText: \"test 123\"\r\n     * })\r\n     */updateModuleConfig(moduleId,config,configErrors){if(!moduleId||!moduleId.length||!config||!configErrors){// TODO: Log to telemetry\nconsole.log('configErrors is a required argument to updateModuleConfig');return false;}// In case of errors, first update module config errors so that the module does not try to render\n// In the case of no errors, put the valid config object in first so that module does render\nif(configErrors.length>0){this.updateModuleConfigErrors(moduleId,configErrors);return this.cache.put({typeName:MODULE_CONFIG_KEY,key:moduleId},{item:config});}else{this.cache.put({typeName:MODULE_CONFIG_KEY,key:moduleId},{item:config});return this.updateModuleConfigErrors(moduleId,configErrors);}}updateModuleClassName(moduleId,propertyName,oldValue,newValue,configErrors){if(!moduleId||!moduleId.length||!propertyName||!configErrors){return false;}const moduleConfig=this.cache.get({typeName:MODULE_CONFIG_KEY,key:moduleId});if(!moduleConfig){return false;}let moduleConfigItem=moduleConfig.item;if(!moduleConfigItem){moduleConfigItem={};}const className=_get2(moduleConfigItem,'className','');const classNameParts=className.split(' ');let oldPropertyKeyValue=\"\".concat(propertyName,\"__\").concat(oldValue);let newPropertyKeyValue=\"\".concat(propertyName,\"__\").concat(newValue);// If property is class name root, set the old and new property keys to the old and new class name root values.\n// Otherwise, leave it as <propertyName>__<value> and update the config item property.\nif(propertyName==='className'){oldPropertyKeyValue=oldValue;newPropertyKeyValue=newValue;}else{_set2(moduleConfigItem,propertyName,newValue);}// If new value is set, replace the old <propertyName>__<value> pair with the new one.\n// Otherwise, push the new <propertyName>__<value> pair to the end of class name.\nif(newValue){const partIdx=classNameParts.findIndex(part=>part.includes(oldPropertyKeyValue));if(partIdx>=0){classNameParts[partIdx]=newPropertyKeyValue;}else{classNameParts.push(newPropertyKeyValue);}}else{// If new value is not set, remove old <propertyName>__<value> pair from class name.\n_remove2(classNameParts,part=>part.includes(oldPropertyKeyValue));}// Update class name according to all its parts.\n_set2(moduleConfigItem,'className',classNameParts.join(' '));return this.updateModuleConfig(moduleId,moduleConfigItem,configErrors);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleConfigErrors(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  [{\r\n     *          message: \"heading_text is not configured\",\r\n     *          property: \"heading_text\"\r\n     *  }])\r\n     */updateModuleConfigErrors(moduleId,configErrors){if(!moduleId||!moduleId.length){// TODO: Log to telemetry\nreturn false;}return this.cache.put({typeName:MODULE_CONFIG_ERRORS_KEY,key:moduleId},{item:configErrors});}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleImage(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  \"['images', '0', 'primaryImage'\"],\r\n     *   {\r\n     *       \"source\": \"https://image-url-here\",\r\n     *       \"altText\": \"alt-text\",\r\n     *       \"$type\": \"image\",\r\n     *       \"imageQuality\": 80\r\n     *       \"title\": \"image title\"\r\n     *  }, []);\r\n     */updateModuleImage(moduleId,pathToField,imageData){var _this$cache$get,_this$cache$get$item,_moduleConfig$item;let configErrors=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(!moduleId||!moduleId.length){return false;}const moduleConfig=this.cache.get({typeName:MODULE_CONFIG_KEY,key:moduleId});// @ts-ignore typename exists on the cache entry for module\nconst moduleType=(_this$cache$get=this.cache.get({typeName:MODULE_CACHE_KEY,key:moduleId}))===null||_this$cache$get===void 0?void 0:(_this$cache$get$item=_this$cache$get.item)===null||_this$cache$get$item===void 0?void 0:_this$cache$get$item.typeName;if(!moduleConfig){return false;}let moduleConfigItem=toJS(moduleConfig.item);if(!moduleConfigItem){moduleConfigItem={};}// @ts-ignore - this is known property that tools will set for the module layout\nconst moduleLayout=(_moduleConfig$item=moduleConfig.item)===null||_moduleConfig$item===void 0?void 0:_moduleConfig$item.msdyn365__moduleLayout;// Construct the viewport image settings information using the current theme and module\nconst viewportInfo=constructViewportInformationForImage(moduleType,moduleLayout,pathToField,imageData.imageQuality,this.themeSettings,imageData.focalRegion,imageData.cropRegions,imageData.format).viewports;_set2(moduleConfigItem,pathToField,{src:imageData.source,$type:imageData.$type,altText:imageData.altText,title:imageData.title,imageSettings:{quality:imageData.imageQuality,viewports:viewportInfo}});return this.updateModuleConfig(moduleId,moduleConfigItem,configErrors);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleVideo(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  \"['videos', '0', 'primaryVideo'\"],\r\n     *   {\r\n     *       binaryReferences: [\r\n     *           {\r\n     *           $type: 'videoBinaryReference',\r\n     *           alias: '1001',\r\n     *           contentType: 'video/mp4',\r\n     *           extension: '.mp4',\r\n     *           sourceHref: 'https://streaming-west-prod.cms.commerce.dynamics.com/0c38a35a-159e-4603-9ad6-82b721f07274/1dc55c98-7d32-4ab8-9be9-5da298b4ce81.mp4',\r\n     *           format: '1001',\r\n     *           clientHref: 'https://streaming-west-prod.cms.commerce.dynamics.com/0c38a35a-159e-4603-9ad6-82b721f07274/1dc55c98-7d32-4ab8-9be9-5da298b4ce81.mp4'\r\n     *           },\r\n     *       title: 'Homepage video',\r\n     *       fileName: '7e181ddf-1d45-497c-ba99-d17af574_650.mp4',\r\n     *       playtime: 13,\r\n     *       thumbnail: {\r\n     *           $type: 'image',\r\n     *           source: 'https://cms-ppe-imageresizer-mr.trafficmanager.net/cms/api/phpjqgrmtp/imageFileData/MAkOl',\r\n     *           title: 'Homepage video Thumbnail',\r\n     *           imageQuality: 70,\r\n     *       },\r\n     *       interactiveTriggersEnabled: false\r\n     *       }, []);\r\n     */updateModuleVideo(moduleId,pathToField,videoData){let configErrors=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(!moduleId||!moduleId.length){return false;}const moduleConfig=this.cache.get({typeName:MODULE_CONFIG_KEY,key:moduleId});if(!moduleConfig){return false;}let moduleConfigItem=toJS(moduleConfig.item);if(!moduleConfigItem){moduleConfigItem={};}// Construct the viewport image settings information using the current theme and module\nconst video=constructVideoInformation(videoData,moduleId);_set2(moduleConfigItem,pathToField,video);return this.updateModuleConfig(moduleId,moduleConfigItem,configErrors);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleProductCollection(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  \"['productCollection', 'products'\"],\r\n     *   {\r\n     *       \"listType\": \"recommendation\",\r\n     *       \"recommendationListId\": \"fbt\"\r\n     *  });\r\n     */async updateModuleProductCollection(moduleId,pathToField,listMetadata){let configErrors=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(!moduleId||!moduleId.length){return false;}const moduleConfig=this.cache.get({typeName:MODULE_CONFIG_KEY,key:moduleId});if(!moduleConfig){return false;}let moduleConfigItem=toJS(moduleConfig.item);if(!moduleConfigItem){moduleConfigItem={};}await hydrateProductList(listMetadata,this.actionContext);if(!listMetadata.products){return false;}_set2(moduleConfigItem,pathToField,listMetadata);return this.updateModuleConfig(moduleId,moduleConfigItem,configErrors);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.removeModule(\"HELLO-WORLD__0\", []);\r\n     * window._msdyn365.authoringHelper.removeModule(\"DEFAULT-CONTAINER__0\", [\"HERO__0\", \"HERO__1\"]);\r\n     */removeModule(moduleId,childrenIds){let removeFromPageFragment=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const pageRoot=this._checkForFeatureFlagAndGetPageRoot(removeFromPageFragment);if(!pageRoot){return false;}// Remove module from the pageRoot\nthis._findModule(pageRoot,moduleId,MODULE_OPERATION.Remove,{});// Remove module and its children from _moduleList\n// @ts-ignore _moduleList is a private property of pageContext\nthis.pageContext._moduleList=this.pageContext._moduleList.filter(obj=>{return obj.id!==moduleId&&childrenIds.indexOf(obj.id)===-1;});deleteCacheEntriesForModuleId(moduleId,this.cache);for(let i=0;i<childrenIds.length;i++){deleteCacheEntriesForModuleId(childrenIds[i],this.cache);}return this._renderPage(moduleId);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.moveModule(\"HELLO-WORLD__0\", \"DEFAULT-CONTAINER__0\", 0);\r\n     *\r\n     * If slot name is not provided the module will be moved within its current slot and cannot be moved to a new parent\r\n     */moveModule(moduleId,parentId,newIndex,moduleSlotName){let moveFromPageFragment=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;const pageRoot=this._checkForFeatureFlagAndGetPageRoot(moveFromPageFragment);if(!pageRoot){return false;}// If no slot name is provided move the module within its own slot\nif(!moduleSlotName){this._findModule(pageRoot,moduleId,MODULE_OPERATION.Move,{newIndex:newIndex});}else{// Find and grab reference to the module that is supposed to be moved\nthis._findModule(pageRoot,moduleId,MODULE_OPERATION.Find,{deleteAfterFind:true});const moduleToMove=this.foundModule;// Now find and grab a reference to the parent to which this module should be moved to\nthis._findModule(pageRoot,parentId,MODULE_OPERATION.Find,{});const parentModule=this.foundModule;// Move module to new parent\n// If the slot doesn't exist, create it\nif(!parentModule.modules||!parentModule.modules[moduleSlotName]){_set2(parentModule,['modules',moduleSlotName],[]);}moveArrayItem(parentModule.modules[moduleSlotName],newIndex,moduleToMove);}try{return this._renderPage(moduleId);}catch(err){console.log(\"Uncaught error when moving module \".concat(moduleId));console.log(err);return false;}}/**\r\n     * Helper function used to sync the placeholder between rendering and tools in drag/drop scenarios\r\n     * @param parentId module id where the module/container needs to be dropped\r\n     * @param index index position for the module drop\r\n     * @param slotId slot id where the module/container needs to be dropped\r\n     */onDrag(parentId,index,slotId,moduleId){_onDrag(parentId,index,slotId,moduleId);}/**\r\n     * Helper function used to set modules as draggable in drag/drop scenarios.\r\n     * @param sourceModuleId The module to be set as draggable.\r\n     */setDraggable(sourceModuleId){_setDraggable(sourceModuleId);}/**\r\n     * Helper function used to remove the placeholder between rendering and tools in drag/drop scenarios\r\n     */removePlaceholder(){_removePlaceholder();}/**\r\n     * usage: _msdyn365.authoringHelper.addModule('hero', 'hero__2', 'primaryArea__0', {config:{moduleConfig: 'config value'}});\r\n     */async addModule(moduleType,moduleId,parentId,content){let moduleSlotName=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'content';let addIndex=arguments.length>5?arguments[5]:undefined;let addFromPageFragment=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;// Construct the module object that needs to be added\nconst moduleToAdd={typeName:moduleType,id:moduleId,modules:undefined,config:content.config,data:{},dataActions:[],friendlyName:content.friendlyName,configErrors:content.configErrors};return this._addModuleFragment(moduleId,parentId,moduleToAdd,false,moduleSlotName,addIndex,addFromPageFragment);}async addFragment(fragmentId,parentId,pageFragment){let moduleSlotName=arguments.length>3&&arguments[3]!==undefined?arguments[3]:'content';let addIndex=arguments.length>4?arguments[4]:undefined;let addFromPageFragment=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;return this._addModuleFragment(fragmentId,parentId,pageFragment,true,moduleSlotName,addIndex,addFromPageFragment);}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.updateModuleData(\r\n     *  \"HELLO-WORLD__0\",\r\n     *  {\r\n     *      \"myTitle\": {\"$type\":\"heading\",\"_id\":\"xekqxgmtadc\", \"text\":\"Hello World Heading\"},\r\n     *      \"myText\": {\"$type\":\"simpleText\",\"_id\":\"hkd849ztr3x\", \"text\":\"Hello............\"}\r\n     *  })\r\n     */updateModuleData(moduleId,data){if(!moduleId||!moduleId.length||!data){// TODO: Log to telemetry\nreturn false;}return this.cache.put({typeName:MODULE_DATA_KEY,key:moduleId},{item:data});}updateDisabledProperties(moduleName,disabledProperties,isFragment){const cacheKey={typeName:MSDYN365_WYSIWYG_DISABLED_PROPS,key:moduleName};if(_isEqual2(this.cache.getValue(cacheKey),disabledProperties)){// skip re-render if the module already has disabled properties\nreturn;}this.cache.put(cacheKey,{item:disabledProperties});// In case of fragment, disable all child modules\nif(!!isFragment){const currentModule=findModule(moduleName,this.pageContext.pageRoot);if(currentModule){disableChildModules(currentModule,this.cache);}}}/**\r\n     * Helper function used to update the slots available in a container to add modules\r\n     * @param moduleId module id thats being updated\r\n     * @param addSlots lists of slots in the module where modules can be added\r\n     */updateAddModuleProperties(moduleId,addSlots){this.cache.put({typeName:MSDYN365_WYSIWYG_CANADDMODULE,key:moduleId},{item:addSlots});}getDisabledProperties(moduleName){return this.cache.getValue({typeName:MSDYN365_WYSIWYG_DISABLED_PROPS,key:moduleName})||[];}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.getModuleConfig(\"HELLO-WORLD__0\");\r\n     */getModuleConfig(moduleId){if(!moduleId||!moduleId.length){// TODO: Log to telemetry\nreturn null;}const config=this.cache.get({typeName:MODULE_CONFIG_KEY,key:moduleId});if(config&&config.item){return toJS(config.item);}return null;}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.getModuleConfigErrors(\"HELLO-WORLD__0\");\r\n     */getModuleConfigErrors(moduleId){if(!moduleId||!moduleId.length){// TODO: Log to telemetry\nreturn null;}const configErrors=this.cache.get({typeName:MODULE_CONFIG_ERRORS_KEY,key:moduleId});if(configErrors&&configErrors.item){return toJS(configErrors.item);}return null;}/**\r\n     * usage:\r\n     * window._msdyn365.authoringHelper.getModuleData(\"HELLO-WORLD__0\");\r\n     */getModuleData(moduleId){if(!moduleId||!moduleId.length){// TODO: Log to telemetry\nreturn null;}const data=this.cache.get({typeName:MODULE_DATA_KEY,key:moduleId});if(data&&data.item){return toJS(data.item);}return null;}/**\r\n     * This function is deprecated please use the updated function\r\n     * getExperimentEventHashesForModule\r\n     * @deprecated\r\n     * @param moduleId\r\n     */getExperimentEventIdsForModule(moduleId){const plainEventIds={};const eventNameToHashes=this.getExperimentEventHashesForModule(moduleId);Object.keys(eventNameToHashes).forEach(key=>{plainEventIds[key]=eventNameToHashes[key].map(value=>value.eventIdName);});return plainEventIds;}/**\r\n     * Returns mapping of moduleId to an array of objects containing exp event name (\r\n     * and the SHA-256 hash of its friendly name (used for the actual track event calls)\r\n     * @param moduleId\r\n     */getExperimentEventHashesForModule(moduleId){const moduleIdToEventIds={};const moduleIds=[moduleId];// Find the element in the DOM\nconst parentElement=document.querySelector(\"[data-i*=\\\"id:\".concat(moduleId,\"\\\"]\"));if(!parentElement){console.warn(\"Unable to find module \".concat(moduleId,\" on the page\"));return moduleIdToEventIds;}// Determine if there are any children modules and those to the list to search for experiment event ids\nparentElement.querySelectorAll(\"[data-i*=\\\"id:\\\"]\").forEach(moduleElement=>{const dataIAttribute=moduleElement.getAttribute('data-i');if(dataIAttribute){const childModuleId=getPropertyFromDataIAttribute(dataIAttribute,'id');if(childModuleId){moduleIds.push(childModuleId);}}});for(let i=0;i<moduleIds.length;i++){const currentModuleId=moduleIds[i];// Selects a module with module id that has the data-exp-event-id attribute on its element or on one of its child elements\nconst selector=\"[data-i*=\\\"id:\".concat(currentModuleId,\",\\\"][data-exp-event-id],[data-i*=\\\"id:\").concat(currentModuleId,\",\\\"] [data-exp-event-id]\");const elements=document.querySelectorAll(selector);const expEventIds=[];for(let j=0;j<elements.length;j++){const element=elements[j];const eventId=element.getAttribute('data-exp-event-id');if(eventId){const hash=generateEventNameHash(eventId);expEventIds.push({eventIdName:eventId,eventIdHash:hash});}}moduleIdToEventIds[currentModuleId]=expEventIds;}return moduleIdToEventIds;}_checkForFeatureFlagAndGetPageRoot(){let addFromPageFragment=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!this.enableAuthoringRemoveAndAddModule){console.log(\"Authoring helper functionality for add/remove/move module is turned off. Please turn on 'enableAuthoringRemoveAndAddModule' feature to use this API\");return undefined;}const pageRoot=this._getPageRoot(addFromPageFragment);if(!pageRoot){return undefined;}return pageRoot;}_getPageRoot(){let addFromPageFragment=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;const pageRoot=this.pageContext.pageRoot;if(pageRoot){var _pageRoot$modules;const body=(_pageRoot$modules=pageRoot.modules)===null||_pageRoot$modules===void 0?void 0:_pageRoot$modules.body;if(!body&&addFromPageFragment){return[pageRoot];}return body;}}/**\r\n     * Renders the page again with the updated page structure\r\n     */_renderPage(moduleId){// Used to generate unique keys so that even reused module ID will still trigger re-render\nconst uniqueTime=new Date().getTime();// Get the page structure to pass on to SafeRenderModule\nconst pageRoot=this.pageContext.pageRoot;const body=pageRoot.modules&&pageRoot.modules.body;const props=body&&body.length>0?body[0]:pageRoot;// Re-hydrate page with new page structure\nReactDOM.hydrate(/*#__PURE__*/React.createElement(CoreContext.Provider,{value:this.coreContext},/*#__PURE__*/React.createElement(SafeRenderModule,_objectSpread(_objectSpread({},props),{},{context:this.coreContext,key:\"\".concat(moduleId,\":\").concat(uniqueTime),telemetry:this.moduleTelemetry,internalTelemetry:window._msdyn365.telemetry,store:this.pageContext}))),document.getElementById(LAYOUT_MOUNT_POINT));return true;}_findModule(obj,moduleId,method,options){this.didFindModule=false;this.foundModule=undefined;this._findModuleHelper(obj,moduleId,method,options);}// Recurses through the pageRoot structure to find and either remove the module and all of its children\n// or add a module depending on whether addModule is passed in\n_findModuleHelper(obj,moduleId,method,options){if(!obj||this.didFindModule){return;}if(Array.isArray(obj)){for(let i=0;i<obj.length;i++){if(obj[i].id&&obj[i].id===moduleId){// Remove module scenario\nif(method===MODULE_OPERATION.Remove){_pullAt2(obj,i);// Add/Move module scenario\n}else if(method===MODULE_OPERATION.Add){this._processAddModule(obj[i],options);// Find module scenario\n}else if(method===MODULE_OPERATION.Find){// If delete after find is set, remove the element\nif(options.deleteAfterFind){this.foundModule=_cloneDeep2(obj[i]);_pullAt2(obj,i);}else{this.foundModule=obj[i];}}else if(method===MODULE_OPERATION.Move&&options.newIndex!==undefined){// Moves a module within its own slot\nconst itemToMove=_pullAt2(obj,i);moveArrayItem(obj,options.newIndex,itemToMove[0]);}this.didFindModule=true;return;}this._findModuleHelper(obj[i],moduleId,method,options);}}else if(typeof obj==='object'&&obj){const children=Object.keys(obj);if(children.length>0){for(let i=0;i<children.length;i++){this._findModuleHelper(obj[children[i]],moduleId,method,options);}}}}_processAddModule(parentModule,options){if(!options.moduleSlotName){options.moduleSlotName='content';}if(!parentModule.modules||!parentModule.modules[options.moduleSlotName]){parentModule.modules={};parentModule.modules[options.moduleSlotName]=[];}if(options.newIndex){parentModule.modules[options.moduleSlotName].splice(options.newIndex,0,options.moduleToAdd);}else{parentModule.modules[options.moduleSlotName].push(options.moduleToAdd);}this.foundModule=parentModule;}async _addModuleFragment(fragmentId,parentId,pageFragment,isFragmentType){let moduleSlotName=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'content';let addIndex=arguments.length>5?arguments[5]:undefined;let addFromPageFragment=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;const pageRoot=this._checkForFeatureFlagAndGetPageRoot(addFromPageFragment);if(!pageRoot){return false;}// Get flattened list of modules\n// If adding a fragment type pass along the fragment id to prepend this id to every module id inside the fragment to avoid any cache collisions\n// with existing modules on the page\nconst flatListModules=getFlattenedListOfModulesForFragment(pageFragment,isFragmentType?fragmentId:'');// Invoke the helper function to find the parent module and add the module(s) to the page structure\nthis._findModule(pageRoot,parentId,MODULE_OPERATION.Add,{moduleSlotName:moduleSlotName,moduleToAdd:pageFragment,newIndex:addIndex});if(!this.foundModule){throw new Error(\"Unable to find parent module with id \".concat(parentId));}// Add items to the cache for the new module(s)\nfor(let i=0;i<flatListModules.length;i++){var _curModule$config;const curModule=flatListModules[i];this.cache.put({typeName:MODULE_CACHE_KEY,key:curModule.id},{item:{id:curModule.id,typeName:curModule.typeName}});// @ts-ignore - this is known property that tools will set for the module layout\nconst moduleLayout=(_curModule$config=curModule.config)===null||_curModule$config===void 0?void 0:_curModule$config.msdyn365__moduleLayout;resolveTypesInConfig(curModule.config,curModule.id,curModule.typeName,moduleLayout,this.themeSettings);this.cache.put({typeName:MODULE_CONFIG_KEY,key:curModule.id},{item:curModule.config||{}});this.cache.put({typeName:MODULE_CONFIG_ERRORS_KEY,key:curModule.id},{item:curModule.configErrors||[]});}// Load any data actions that the new modules(s) are dependent on\ntry{await loadData(flatListModules,this.pageContext.requestContext,window._msdyn365.telemetry,this.moduleTelemetry,this.cache,null);// @ts-ignore - Ignoring complaint that _moduleList is a private property of pageContext\nthis.pageContext._moduleList.push(...flatListModules);// Put results of the data action into the cache for the module(s) that are being added\nfor(let i=0;i<flatListModules.length;i++){const curModule=flatListModules[i];this.cache.put({typeName:MODULE_DATA_KEY,key:curModule.id},{item:curModule.data});this.cache.put({typeName:MODULE_ACTION_KEY,key:curModule.id},{item:curModule.dataActions});}// Finally, call render to render the new modules in context of the parent module\ntry{return this._renderPage(fragmentId);}catch(err){console.log(\"Uncaught error when adding module/fragment: \".concat(fragmentId));console.log(err);return false;}}catch(err){console.log(\"Error running load data when adding module/fragment: \".concat(fragmentId));console.log(err);return false;}}}","map":{"version":3,"sources":["../../../src/utils/authoring-tools-helper.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n// tslint:disable: no-any\nimport { ICache } from '@msdyn365-commerce/cache-internal';\nimport {\n    CoreContext,\n    IActionContext,\n    IAddModuleSlot,\n    IConfigError,\n    ICoreContext,\n    IModuleContract,\n    IPartnerThemeSettings,\n    IRenderingHelper,\n    onDrag as _onDrag,\n    PROPERTY_INIT,\n    removePlaceholder as _removePlaceholder,\n    setDraggable as _setDraggable\n} from '@msdyn365-commerce/core-internal';\nimport { IDictionary, IProductList } from '@msdyn365-commerce/retail-proxy';\nimport { generateEventNameHash, InternalTelemetry, Telemetry } from '@msdyn365-commerce/telemetry-internal';\nimport { cloneDeep as _cloneDeep, get as _get, isEqual as _isEqual, pullAt as _pullAt, remove as _remove, set as _set } from 'lodash';\nimport { toJS } from 'mobx';\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport { SafeRenderModule } from '../components/safe-render-module';\nimport {\n    LAYOUT_MOUNT_POINT,\n    MODULE_ACTION_KEY,\n    MODULE_CACHE_KEY,\n    MODULE_CONFIG_ERRORS_KEY,\n    MODULE_CONFIG_KEY,\n    MODULE_DATA_KEY,\n    MSDYN365_WYSIWYG_CANADDMODULE,\n    MSDYN365_WYSIWYG_DISABLED_PROPS\n} from '../consts';\nimport { loadData } from '../data/load-data';\nimport { IProductListMetaData } from '../hydrators/hydrator-action-inputs';\nimport { hydrateProductList } from '../hydrators/product-list-hydrator';\nimport { disableChildModules, findModule } from '../store/authoring-edit-helper';\nimport { PageContext } from '../store/page-context';\nimport {\n    constructVideoInformation,\n    constructViewportInformationForImage,\n    deleteCacheEntriesForModuleId,\n    getPropertyFromDataIAttribute,\n    IImageData,\n    IVideoData,\n    moveArrayItem,\n    resolveTypesInConfig\n} from './authoring-tools-helper-utils';\nimport { getFlattenedListOfModulesForFragment } from './get-modules-flat-list';\n\ndeclare var window: ClientWindow;\n\ninterface IModuleContent {\n    data?: unknown;\n    config?: unknown;\n    friendlyName: string;\n    configErrors?: IConfigError[];\n}\n\nenum MODULE_OPERATION {\n    Find,\n    Remove,\n    Add,\n    Move\n}\n\ninterface IExpEventName {\n    eventIdName: string;\n    eventIdHash: string;\n}\n\ninterface IModuleOperationInfo {\n    moduleSlotName?: string;\n    moduleToAdd?: any;\n    newIndex?: number;\n    deleteAfterFind?: boolean;\n}\n\n/**\n * Provides the CMS tooling a way to update the CMS content\n */\nexport class AuthoringToolsHelper {\n    // helper class on site builder which SDK can call for information/context about site builder\n    public renderingHelper: IRenderingHelper | undefined;\n    private cache: ICache;\n    private readonly actionContext: IActionContext;\n    private readonly themeSettings: IPartnerThemeSettings;\n    private coreContext: ICoreContext;\n    private pageContext: PageContext;\n    private moduleTelemetry: Telemetry;\n    private didFindModule: boolean = false;\n    private foundModule: any;\n    private enableAuthoringRemoveAndAddModule: boolean = false;\n\n    constructor(\n        actionContext: IActionContext,\n        themeSettings: IPartnerThemeSettings,\n        coreContext: ICoreContext,\n        pageContext: PageContext,\n        moduleTelemetry: Telemetry\n    ) {\n        this.cache = pageContext.requestCache;\n        this.actionContext = actionContext;\n        this.themeSettings = themeSettings;\n        this.coreContext = coreContext;\n        this.pageContext = pageContext;\n        this.moduleTelemetry = moduleTelemetry;\n        this.enableAuthoringRemoveAndAddModule =\n            coreContext.request.features && coreContext.request.features.enableAuthoringRemoveAndAddModule;\n    }\n\n    public initRenderingHelper(renderingHelper: IRenderingHelper): void {\n        this.renderingHelper = renderingHelper;\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModule(\n     *  \"HELLO-WORLD__0\",\n     *  {\n     *     \"data\": {\n     *          \"myTitle\": {\"$type\":\"heading\",\"_id\":\"xekqxgmtadc\", \"text\":\"Hello World Heading\"},\n     *          \"myText\": {\"$type\":\"simpleText\",\"_id\":\"hkd849ztr3x\", \"text\":\"Hello............\"}\n     *      },\n     *     \"config\": {\n     *          showText: \"test 123\"\n     *     },\n     *     \"configErrors\": []\n     * })\n     */\n    public updateModule(moduleId: string, content: IModuleContent): boolean {\n        if (!moduleId || !moduleId.length) {\n            // TODO: Log to telemetry\n            return false;\n        }\n\n        if (!content || (!content.data && !content.config)) {\n            return false;\n        }\n\n        let updated: boolean = false;\n        if (content.data) {\n            updated = this.cache.put({ typeName: MODULE_DATA_KEY, key: moduleId }, { item: content.data });\n        }\n\n        if (content.config) {\n            updated = this.cache.put({ typeName: MODULE_CONFIG_KEY, key: moduleId }, { item: content.config }) || updated;\n        }\n\n        if (content.configErrors) {\n            updated = this.cache.put({ typeName: MODULE_CONFIG_ERRORS_KEY, key: moduleId }, { item: content.configErrors });\n        }\n\n        return updated;\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleConfig(\n     *  \"HELLO-WORLD__0\",\n     *  {\n     *          showText: \"test 123\"\n     * })\n     */\n    public updateModuleConfig(moduleId: string, config: unknown, configErrors: IConfigError[]): boolean {\n        if (!moduleId || !moduleId.length || !config || !configErrors) {\n            // TODO: Log to telemetry\n            console.log('configErrors is a required argument to updateModuleConfig');\n            return false;\n        }\n        // In case of errors, first update module config errors so that the module does not try to render\n        // In the case of no errors, put the valid config object in first so that module does render\n        if (configErrors.length > 0) {\n            this.updateModuleConfigErrors(moduleId, configErrors);\n            return this.cache.put({ typeName: MODULE_CONFIG_KEY, key: moduleId }, { item: config });\n        } else {\n            this.cache.put({ typeName: MODULE_CONFIG_KEY, key: moduleId }, { item: config });\n            return this.updateModuleConfigErrors(moduleId, configErrors);\n        }\n    }\n\n    public updateModuleClassName(\n        moduleId: string,\n        propertyName: string,\n        oldValue: string,\n        newValue: string,\n        configErrors: IConfigError[]\n    ): boolean {\n        if (!moduleId || !moduleId.length || !propertyName || !configErrors) {\n            return false;\n        }\n\n        const moduleConfig = this.cache.get<object>({ typeName: MODULE_CONFIG_KEY, key: moduleId });\n        if (!moduleConfig) {\n            return false;\n        }\n        let moduleConfigItem = moduleConfig.item;\n        if (!moduleConfigItem) {\n            moduleConfigItem = {};\n        }\n\n        const className: string = _get(moduleConfigItem, 'className', '');\n        const classNameParts: string[] = className.split(' ');\n\n        let oldPropertyKeyValue = `${propertyName}__${oldValue}`;\n        let newPropertyKeyValue = `${propertyName}__${newValue}`;\n        // If property is class name root, set the old and new property keys to the old and new class name root values.\n        // Otherwise, leave it as <propertyName>__<value> and update the config item property.\n        if (propertyName === 'className') {\n            oldPropertyKeyValue = oldValue;\n            newPropertyKeyValue = newValue;\n        } else {\n            _set(moduleConfigItem, propertyName, newValue);\n        }\n\n        // If new value is set, replace the old <propertyName>__<value> pair with the new one.\n        // Otherwise, push the new <propertyName>__<value> pair to the end of class name.\n        if (newValue) {\n            const partIdx = classNameParts.findIndex(part => part.includes(oldPropertyKeyValue));\n            if (partIdx >= 0) {\n                classNameParts[partIdx] = newPropertyKeyValue;\n            } else {\n                classNameParts.push(newPropertyKeyValue);\n            }\n        } else {\n            // If new value is not set, remove old <propertyName>__<value> pair from class name.\n            _remove(classNameParts, part => part.includes(oldPropertyKeyValue));\n        }\n\n        // Update class name according to all its parts.\n        _set(moduleConfigItem, 'className', classNameParts.join(' '));\n\n        return this.updateModuleConfig(moduleId, moduleConfigItem, configErrors);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleConfigErrors(\n     *  \"HELLO-WORLD__0\",\n     *  [{\n     *          message: \"heading_text is not configured\",\n     *          property: \"heading_text\"\n     *  }])\n     */\n    public updateModuleConfigErrors(moduleId: string, configErrors: IConfigError[]): boolean {\n        if (!moduleId || !moduleId.length) {\n            // TODO: Log to telemetry\n            return false;\n        }\n\n        return this.cache.put({ typeName: MODULE_CONFIG_ERRORS_KEY, key: moduleId }, { item: configErrors });\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleImage(\n     *  \"HELLO-WORLD__0\",\n     *  \"['images', '0', 'primaryImage'\"],\n     *   {\n     *       \"source\": \"https://image-url-here\",\n     *       \"altText\": \"alt-text\",\n     *       \"$type\": \"image\",\n     *       \"imageQuality\": 80\n     *       \"title\": \"image title\"\n     *  }, []);\n     */\n    public updateModuleImage(moduleId: string, pathToField: string[], imageData: IImageData, configErrors: IConfigError[] = []): boolean {\n        if (!moduleId || !moduleId.length) {\n            return false;\n        }\n\n        const moduleConfig = this.cache.get<object>({ typeName: MODULE_CONFIG_KEY, key: moduleId });\n        // @ts-ignore typename exists on the cache entry for module\n        const moduleType = this.cache.get<object>({ typeName: MODULE_CACHE_KEY, key: moduleId })?.item?.typeName;\n        if (!moduleConfig) {\n            return false;\n        }\n        let moduleConfigItem = toJS(moduleConfig.item);\n        if (!moduleConfigItem) {\n            moduleConfigItem = {};\n        }\n\n        // @ts-ignore - this is known property that tools will set for the module layout\n        const moduleLayout = moduleConfig.item?.msdyn365__moduleLayout;\n        // Construct the viewport image settings information using the current theme and module\n        const viewportInfo = constructViewportInformationForImage(\n            moduleType,\n            moduleLayout,\n            pathToField,\n            imageData.imageQuality,\n            this.themeSettings,\n            imageData.focalRegion,\n            imageData.cropRegions,\n            imageData.format\n        ).viewports;\n\n        _set(moduleConfigItem, pathToField, {\n            src: imageData.source,\n            $type: imageData.$type,\n            altText: imageData.altText,\n            title: imageData.title,\n            imageSettings: {\n                quality: imageData.imageQuality,\n                viewports: viewportInfo\n            }\n        });\n\n        return this.updateModuleConfig(moduleId, moduleConfigItem, configErrors);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleVideo(\n     *  \"HELLO-WORLD__0\",\n     *  \"['videos', '0', 'primaryVideo'\"],\n     *   {\n     *       binaryReferences: [\n     *           {\n     *           $type: 'videoBinaryReference',\n     *           alias: '1001',\n     *           contentType: 'video/mp4',\n     *           extension: '.mp4',\n     *           sourceHref: 'https://streaming-west-prod.cms.commerce.dynamics.com/0c38a35a-159e-4603-9ad6-82b721f07274/1dc55c98-7d32-4ab8-9be9-5da298b4ce81.mp4',\n     *           format: '1001',\n     *           clientHref: 'https://streaming-west-prod.cms.commerce.dynamics.com/0c38a35a-159e-4603-9ad6-82b721f07274/1dc55c98-7d32-4ab8-9be9-5da298b4ce81.mp4'\n     *           },\n     *       title: 'Homepage video',\n     *       fileName: '7e181ddf-1d45-497c-ba99-d17af574_650.mp4',\n     *       playtime: 13,\n     *       thumbnail: {\n     *           $type: 'image',\n     *           source: 'https://cms-ppe-imageresizer-mr.trafficmanager.net/cms/api/phpjqgrmtp/imageFileData/MAkOl',\n     *           title: 'Homepage video Thumbnail',\n     *           imageQuality: 70,\n     *       },\n     *       interactiveTriggersEnabled: false\n     *       }, []);\n     */\n    public updateModuleVideo(moduleId: string, pathToField: string[], videoData: IVideoData, configErrors: IConfigError[] = []): boolean {\n        if (!moduleId || !moduleId.length) {\n            return false;\n        }\n\n        const moduleConfig = this.cache.get<object>({ typeName: MODULE_CONFIG_KEY, key: moduleId });\n        if (!moduleConfig) {\n            return false;\n        }\n        let moduleConfigItem = toJS(moduleConfig.item);\n        if (!moduleConfigItem) {\n            moduleConfigItem = {};\n        }\n\n        // Construct the viewport image settings information using the current theme and module\n        const video = constructVideoInformation(videoData, moduleId);\n\n        _set(moduleConfigItem, pathToField, video);\n\n        return this.updateModuleConfig(moduleId, moduleConfigItem, configErrors);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleProductCollection(\n     *  \"HELLO-WORLD__0\",\n     *  \"['productCollection', 'products'\"],\n     *   {\n     *       \"listType\": \"recommendation\",\n     *       \"recommendationListId\": \"fbt\"\n     *  });\n     */\n    public async updateModuleProductCollection(\n        moduleId: string,\n        pathToField: string[],\n        listMetadata: IProductListMetaData,\n        configErrors: IConfigError[] = []\n    ): Promise<boolean> {\n        if (!moduleId || !moduleId.length) {\n            return false;\n        }\n\n        const moduleConfig = this.cache.get<object>({ typeName: MODULE_CONFIG_KEY, key: moduleId });\n        if (!moduleConfig) {\n            return false;\n        }\n        let moduleConfigItem = toJS(moduleConfig.item);\n        if (!moduleConfigItem) {\n            moduleConfigItem = {};\n        }\n\n        await hydrateProductList(listMetadata, this.actionContext);\n        if (!(<IProductList>(<unknown>listMetadata)).products) {\n            return false;\n        }\n\n        _set(moduleConfigItem, pathToField, listMetadata);\n        return this.updateModuleConfig(moduleId, moduleConfigItem, configErrors);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.removeModule(\"HELLO-WORLD__0\", []);\n     * window._msdyn365.authoringHelper.removeModule(\"DEFAULT-CONTAINER__0\", [\"HERO__0\", \"HERO__1\"]);\n     */\n    public removeModule(moduleId: string, childrenIds: string[], removeFromPageFragment: boolean = false): boolean {\n        const pageRoot = this._checkForFeatureFlagAndGetPageRoot(removeFromPageFragment);\n        if (!pageRoot) {\n            return false;\n        }\n\n        // Remove module from the pageRoot\n        this._findModule(pageRoot, moduleId, MODULE_OPERATION.Remove, {});\n\n        // Remove module and its children from _moduleList\n        // @ts-ignore _moduleList is a private property of pageContext\n        this.pageContext._moduleList = this.pageContext._moduleList.filter(obj => {\n            return obj.id !== moduleId && childrenIds.indexOf(obj.id) === -1;\n        });\n\n        deleteCacheEntriesForModuleId(moduleId, this.cache);\n\n        for (let i = 0; i < childrenIds.length; i++) {\n            deleteCacheEntriesForModuleId(childrenIds[i], this.cache);\n        }\n        return this._renderPage(moduleId);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.moveModule(\"HELLO-WORLD__0\", \"DEFAULT-CONTAINER__0\", 0);\n     *\n     * If slot name is not provided the module will be moved within its current slot and cannot be moved to a new parent\n     */\n    public moveModule(\n        moduleId: string,\n        parentId: string,\n        newIndex: number,\n        moduleSlotName?: string,\n        moveFromPageFragment: boolean = false\n    ): boolean {\n        const pageRoot = this._checkForFeatureFlagAndGetPageRoot(moveFromPageFragment);\n        if (!pageRoot) {\n            return false;\n        }\n\n        // If no slot name is provided move the module within its own slot\n        if (!moduleSlotName) {\n            this._findModule(pageRoot, moduleId, MODULE_OPERATION.Move, { newIndex: newIndex });\n        } else {\n            // Find and grab reference to the module that is supposed to be moved\n            this._findModule(pageRoot, moduleId, MODULE_OPERATION.Find, { deleteAfterFind: true });\n            const moduleToMove = this.foundModule;\n\n            // Now find and grab a reference to the parent to which this module should be moved to\n            this._findModule(pageRoot, parentId, MODULE_OPERATION.Find, {});\n            const parentModule = this.foundModule;\n\n            // Move module to new parent\n            // If the slot doesn't exist, create it\n            if (!parentModule.modules || !parentModule.modules[moduleSlotName]) {\n                _set(parentModule, ['modules', moduleSlotName], []);\n            }\n            moveArrayItem(parentModule.modules[moduleSlotName], newIndex, moduleToMove);\n        }\n\n        try {\n            return this._renderPage(moduleId);\n        } catch (err) {\n            console.log(`Uncaught error when moving module ${moduleId}`);\n            console.log(err);\n            return false;\n        }\n    }\n\n    /**\n     * Helper function used to sync the placeholder between rendering and tools in drag/drop scenarios\n     * @param parentId module id where the module/container needs to be dropped\n     * @param index index position for the module drop\n     * @param slotId slot id where the module/container needs to be dropped\n     */\n    public onDrag(parentId: string, index: number, slotId: string, moduleId?: string): void {\n        _onDrag(parentId, index, slotId, moduleId);\n    }\n\n    /**\n     * Helper function used to set modules as draggable in drag/drop scenarios.\n     * @param sourceModuleId The module to be set as draggable.\n     */\n    public setDraggable(sourceModuleId: string): void {\n        _setDraggable(sourceModuleId);\n    }\n\n    /**\n     * Helper function used to remove the placeholder between rendering and tools in drag/drop scenarios\n     */\n    public removePlaceholder(): void {\n        _removePlaceholder();\n    }\n\n    /**\n     * usage: _msdyn365.authoringHelper.addModule('hero', 'hero__2', 'primaryArea__0', {config:{moduleConfig: 'config value'}});\n     */\n    public async addModule(\n        moduleType: string,\n        moduleId: string,\n        parentId: string,\n        content: IModuleContent,\n        moduleSlotName: string = 'content',\n        addIndex?: number,\n        addFromPageFragment: boolean = false\n    ): Promise<boolean> {\n        // Construct the module object that needs to be added\n        const moduleToAdd: IModuleContract = {\n            typeName: moduleType,\n            id: moduleId,\n            modules: undefined,\n            config: content.config,\n            data: {},\n            dataActions: [],\n            friendlyName: content.friendlyName,\n            configErrors: content.configErrors\n        };\n        return this._addModuleFragment(moduleId, parentId, moduleToAdd, false, moduleSlotName, addIndex, addFromPageFragment);\n    }\n\n    public async addFragment(\n        fragmentId: string,\n        parentId: string,\n        pageFragment: IModuleContract,\n        moduleSlotName: string = 'content',\n        addIndex?: number,\n        addFromPageFragment: boolean = false\n    ): Promise<boolean> {\n        return this._addModuleFragment(fragmentId, parentId, pageFragment, true, moduleSlotName, addIndex, addFromPageFragment);\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.updateModuleData(\n     *  \"HELLO-WORLD__0\",\n     *  {\n     *      \"myTitle\": {\"$type\":\"heading\",\"_id\":\"xekqxgmtadc\", \"text\":\"Hello World Heading\"},\n     *      \"myText\": {\"$type\":\"simpleText\",\"_id\":\"hkd849ztr3x\", \"text\":\"Hello............\"}\n     *  })\n     */\n    public updateModuleData(moduleId: string, data: unknown): boolean {\n        if (!moduleId || !moduleId.length || !data) {\n            // TODO: Log to telemetry\n            return false;\n        }\n\n        return this.cache.put({ typeName: MODULE_DATA_KEY, key: moduleId }, { item: data });\n    }\n\n    public updateDisabledProperties(moduleName: string, disabledProperties: string[], isFragment?: boolean): void {\n        const cacheKey = { typeName: MSDYN365_WYSIWYG_DISABLED_PROPS, key: moduleName };\n        if (_isEqual(this.cache.getValue(cacheKey), disabledProperties)) {\n            // skip re-render if the module already has disabled properties\n            return;\n        }\n\n        this.cache.put(cacheKey, { item: disabledProperties });\n\n        // In case of fragment, disable all child modules\n        if (!!isFragment) {\n            const currentModule = findModule(moduleName, this.pageContext.pageRoot);\n            if (currentModule) {\n                disableChildModules(currentModule, this.cache);\n            }\n        }\n    }\n\n    /**\n     * Helper function used to update the slots available in a container to add modules\n     * @param moduleId module id thats being updated\n     * @param addSlots lists of slots in the module where modules can be added\n     */\n    public updateAddModuleProperties(moduleId: string, addSlots: IAddModuleSlot[]): void {\n        this.cache.put({ typeName: MSDYN365_WYSIWYG_CANADDMODULE, key: moduleId }, { item: addSlots });\n    }\n\n    public getDisabledProperties(moduleName: string): string[] {\n        return this.cache.getValue<string[]>({ typeName: MSDYN365_WYSIWYG_DISABLED_PROPS, key: moduleName }) || [];\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.getModuleConfig(\"HELLO-WORLD__0\");\n     */\n    public getModuleConfig(moduleId: string): unknown {\n        if (!moduleId || !moduleId.length) {\n            // TODO: Log to telemetry\n            return null;\n        }\n\n        const config = this.cache.get({ typeName: MODULE_CONFIG_KEY, key: moduleId });\n\n        if (config && config.item) {\n            return toJS(config.item);\n        }\n\n        return null;\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.getModuleConfigErrors(\"HELLO-WORLD__0\");\n     */\n    public getModuleConfigErrors(moduleId: string): IConfigError[] | null {\n        if (!moduleId || !moduleId.length) {\n            // TODO: Log to telemetry\n            return null;\n        }\n\n        const configErrors = this.cache.get<IConfigError[]>({ typeName: MODULE_CONFIG_ERRORS_KEY, key: moduleId });\n\n        if (configErrors && configErrors.item) {\n            return toJS(configErrors.item);\n        }\n\n        return null;\n    }\n\n    /**\n     * usage:\n     * window._msdyn365.authoringHelper.getModuleData(\"HELLO-WORLD__0\");\n     */\n    public getModuleData(moduleId: string): unknown {\n        if (!moduleId || !moduleId.length) {\n            // TODO: Log to telemetry\n            return null;\n        }\n\n        const data = this.cache.get({ typeName: MODULE_DATA_KEY, key: moduleId });\n\n        if (data && data.item) {\n            return toJS(data.item);\n        }\n\n        return null;\n    }\n\n    /**\n     * This function is deprecated please use the updated function\n     * getExperimentEventHashesForModule\n     * @deprecated\n     * @param moduleId\n     */\n    public getExperimentEventIdsForModule(moduleId: string): IDictionary<string[]> {\n        const plainEventIds: IDictionary<string[]> = {};\n        const eventNameToHashes = this.getExperimentEventHashesForModule(moduleId);\n        Object.keys(eventNameToHashes).forEach((key: string) => {\n            plainEventIds[key] = eventNameToHashes[key].map((value: IExpEventName) => value.eventIdName);\n        });\n        return plainEventIds;\n    }\n\n    /**\n     * Returns mapping of moduleId to an array of objects containing exp event name (\n     * and the SHA-256 hash of its friendly name (used for the actual track event calls)\n     * @param moduleId\n     */\n    public getExperimentEventHashesForModule(moduleId: string): IDictionary<IExpEventName[]> {\n        const moduleIdToEventIds: IDictionary<IExpEventName[]> = {};\n        const moduleIds = [moduleId];\n\n        // Find the element in the DOM\n        const parentElement = document.querySelector(`[data-i*=\"id:${moduleId}\"]`);\n        if (!parentElement) {\n            console.warn(`Unable to find module ${moduleId} on the page`);\n            return moduleIdToEventIds;\n        }\n        // Determine if there are any children modules and those to the list to search for experiment event ids\n        parentElement.querySelectorAll(`[data-i*=\"id:\"]`).forEach((moduleElement: Element) => {\n            const dataIAttribute = moduleElement.getAttribute('data-i');\n            if (dataIAttribute) {\n                const childModuleId = getPropertyFromDataIAttribute(dataIAttribute, 'id');\n                if (childModuleId) {\n                    moduleIds.push(childModuleId);\n                }\n            }\n        });\n        for (let i = 0; i < moduleIds.length; i++) {\n            const currentModuleId = moduleIds[i];\n            // Selects a module with module id that has the data-exp-event-id attribute on its element or on one of its child elements\n            const selector = `[data-i*=\"id:${currentModuleId},\"][data-exp-event-id],[data-i*=\"id:${currentModuleId},\"] [data-exp-event-id]`;\n            const elements = document.querySelectorAll(selector);\n\n            const expEventIds: IExpEventName[] = [];\n            for (let j = 0; j < elements.length; j++) {\n                const element: Element = elements[j];\n                const eventId = element.getAttribute('data-exp-event-id');\n                if (eventId) {\n                    const hash = generateEventNameHash(eventId);\n                    expEventIds.push({ eventIdName: eventId, eventIdHash: hash });\n                }\n            }\n            moduleIdToEventIds[currentModuleId] = expEventIds;\n        }\n        return moduleIdToEventIds;\n    }\n\n    private _checkForFeatureFlagAndGetPageRoot(addFromPageFragment: boolean = false): IModuleContract[] | undefined {\n        if (!this.enableAuthoringRemoveAndAddModule) {\n            console.log(\n                `Authoring helper functionality for add/remove/move module is turned off. Please turn on 'enableAuthoringRemoveAndAddModule' feature to use this API`\n            );\n            return undefined;\n        }\n\n        const pageRoot = this._getPageRoot(addFromPageFragment);\n\n        if (!pageRoot) {\n            return undefined;\n        }\n        return pageRoot;\n    }\n\n    private _getPageRoot(addFromPageFragment: boolean = false): IModuleContract[] | undefined {\n        const pageRoot = this.pageContext.pageRoot;\n        if (pageRoot) {\n            const body = pageRoot.modules?.body;\n            if (!body && addFromPageFragment) {\n                return [pageRoot];\n            }\n            return body;\n        }\n    }\n\n    /**\n     * Renders the page again with the updated page structure\n     */\n    private _renderPage(moduleId: string): boolean {\n        // Used to generate unique keys so that even reused module ID will still trigger re-render\n        const uniqueTime = new Date().getTime();\n        // Get the page structure to pass on to SafeRenderModule\n        const pageRoot = <any>this.pageContext.pageRoot;\n        const body = pageRoot.modules && pageRoot.modules.body;\n        const props = body && body.length > 0 ? body[0] : pageRoot;\n        // Re-hydrate page with new page structure\n        ReactDOM.hydrate(\n            React.createElement(\n                CoreContext.Provider,\n                { value: this.coreContext },\n                React.createElement(SafeRenderModule, {\n                    ...props,\n                    context: this.coreContext,\n                    key: `${moduleId}:${uniqueTime}`,\n                    telemetry: this.moduleTelemetry,\n                    internalTelemetry: window._msdyn365.telemetry,\n                    store: this.pageContext\n                })\n            ),\n            document.getElementById(LAYOUT_MOUNT_POINT)\n        );\n        return true;\n    }\n\n    private _findModule(obj: unknown, moduleId: string, method: MODULE_OPERATION, options: IModuleOperationInfo): void {\n        this.didFindModule = false;\n        this.foundModule = undefined;\n        this._findModuleHelper(obj, moduleId, method, options);\n    }\n\n    // Recurses through the pageRoot structure to find and either remove the module and all of its children\n    // or add a module depending on whether addModule is passed in\n    private _findModuleHelper(obj: unknown, moduleId: string, method: MODULE_OPERATION, options: IModuleOperationInfo): void {\n        if (!obj || this.didFindModule) {\n            return;\n        }\n        if (Array.isArray(obj)) {\n            for (let i = 0; i < obj.length; i++) {\n                if (obj[i].id && obj[i].id === moduleId) {\n                    // Remove module scenario\n                    if (method === MODULE_OPERATION.Remove) {\n                        _pullAt(obj, i);\n                        // Add/Move module scenario\n                    } else if (method === MODULE_OPERATION.Add) {\n                        this._processAddModule(obj[i], options);\n                        // Find module scenario\n                    } else if (method === MODULE_OPERATION.Find) {\n                        // If delete after find is set, remove the element\n                        if (options.deleteAfterFind) {\n                            this.foundModule = _cloneDeep(obj[i]);\n                            _pullAt(obj, i);\n                        } else {\n                            this.foundModule = obj[i];\n                        }\n                    } else if (method === MODULE_OPERATION.Move && options.newIndex !== undefined) {\n                        // Moves a module within its own slot\n                        const itemToMove = _pullAt(obj, i);\n                        moveArrayItem(obj, options.newIndex, itemToMove[0]);\n                    }\n                    this.didFindModule = true;\n                    return;\n                }\n                this._findModuleHelper(obj[i], moduleId, method, options);\n            }\n        } else if (typeof obj === 'object' && obj) {\n            const children = Object.keys(obj);\n            if (children.length > 0) {\n                for (let i = 0; i < children.length; i++) {\n                    this._findModuleHelper(obj[children[i]], moduleId, method, options);\n                }\n            }\n        }\n    }\n\n    private _processAddModule(parentModule: any, options: IModuleOperationInfo): void {\n        if (!options.moduleSlotName) {\n            options.moduleSlotName = 'content';\n        }\n        if (!parentModule.modules || !parentModule.modules[options.moduleSlotName]) {\n            parentModule.modules = {};\n            parentModule.modules[options.moduleSlotName] = [];\n        }\n        if (options.newIndex) {\n            parentModule.modules[options.moduleSlotName].splice(options.newIndex, 0, options.moduleToAdd);\n        } else {\n            parentModule.modules[options.moduleSlotName].push(options.moduleToAdd);\n        }\n        this.foundModule = parentModule;\n    }\n\n    private async _addModuleFragment(\n        fragmentId: string,\n        parentId: string,\n        pageFragment: IModuleContract,\n        isFragmentType: boolean,\n        moduleSlotName: string = 'content',\n        addIndex?: number,\n        addFromPageFragment: boolean = false\n    ): Promise<boolean> {\n        const pageRoot = this._checkForFeatureFlagAndGetPageRoot(addFromPageFragment);\n        if (!pageRoot) {\n            return false;\n        }\n\n        // Get flattened list of modules\n        // If adding a fragment type pass along the fragment id to prepend this id to every module id inside the fragment to avoid any cache collisions\n        // with existing modules on the page\n        const flatListModules = getFlattenedListOfModulesForFragment(pageFragment, isFragmentType ? fragmentId : '');\n\n        // Invoke the helper function to find the parent module and add the module(s) to the page structure\n        this._findModule(pageRoot, parentId, MODULE_OPERATION.Add, {\n            moduleSlotName: moduleSlotName,\n            moduleToAdd: pageFragment,\n            newIndex: addIndex\n        });\n\n        if (!this.foundModule) {\n            throw new Error(`Unable to find parent module with id ${parentId}`);\n        }\n\n        // Add items to the cache for the new module(s)\n        for (let i = 0; i < flatListModules.length; i++) {\n            const curModule = flatListModules[i];\n            this.cache.put({ typeName: MODULE_CACHE_KEY, key: curModule.id }, { item: { id: curModule.id, typeName: curModule.typeName } });\n            // @ts-ignore - this is known property that tools will set for the module layout\n            const moduleLayout = curModule.config?.msdyn365__moduleLayout;\n            resolveTypesInConfig(<any>curModule.config, curModule.id, curModule.typeName, moduleLayout, this.themeSettings);\n            this.cache.put({ typeName: MODULE_CONFIG_KEY, key: curModule.id }, { item: curModule.config || {} });\n            this.cache.put({ typeName: MODULE_CONFIG_ERRORS_KEY, key: curModule.id }, { item: curModule.configErrors || [] });\n        }\n\n        // Load any data actions that the new modules(s) are dependent on\n        try {\n            await loadData(\n                flatListModules,\n                this.pageContext.requestContext,\n                <InternalTelemetry>window._msdyn365.telemetry,\n                this.moduleTelemetry,\n                this.cache,\n                null\n            );\n\n            // @ts-ignore - Ignoring complaint that _moduleList is a private property of pageContext\n            this.pageContext._moduleList.push(...flatListModules);\n\n            // Put results of the data action into the cache for the module(s) that are being added\n            for (let i = 0; i < flatListModules.length; i++) {\n                const curModule = flatListModules[i];\n                this.cache.put({ typeName: MODULE_DATA_KEY, key: curModule.id }, { item: curModule.data });\n                this.cache.put({ typeName: MODULE_ACTION_KEY, key: curModule.id }, { item: curModule.dataActions });\n            }\n\n            // Finally, call render to render the new modules in context of the parent module\n            try {\n                return this._renderPage(fragmentId);\n            } catch (err) {\n                console.log(`Uncaught error when adding module/fragment: ${fragmentId}`);\n                console.log(err);\n                return false;\n            }\n        } catch (err) {\n            console.log(`Error running load data when adding module/fragment: ${fragmentId}`);\n            console.log(err);\n            return false;\n        }\n    }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}