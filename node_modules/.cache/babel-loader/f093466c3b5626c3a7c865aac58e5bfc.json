{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import{createObservableDataAction}from'@msdyn365-commerce/core';import{getCartState}from'@msdyn365-commerce/global-state';import{issueLoyaltyCardAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import{getLoyaltyAction,GetLoyaltyCardInput}from'./get-loyalty-card';import{buildCacheKey}from'./index';/**\r\n *  Input class for the issueLoyalty data action\r\n */export var IssueLoyaltyInput=function IssueLoyaltyInput(apiSettings,userAccountNumber){var _this=this;_classCallCheck(this,IssueLoyaltyInput);this.getCacheKey=function(){return buildCacheKey(\"IssueLoyalty-\".concat(_this.userAccountNumber),_this.apiSettings);};this.getCacheObjectType=function(){return'GetIssueLoyalty';};this.dataCacheType=function(){return'request';};this.userAccountNumber=userAccountNumber;this.apiSettings=apiSettings;};/**\r\n * createInput method for the issueLoyalty method\r\n * @param inputData The input data passed to the createInput method\r\n */export var createIssueLoyaltyInput=function createIssueLoyaltyInput(inputData){var requestContext=inputData.requestContext;if(!requestContext.user.isAuthenticated){throw new Error('Unable to create issue loyalty input.  User is not authenticated.');}return new IssueLoyaltyInput(inputData.requestContext.apiSettings);};/**\r\n * The action method for the issueLoyalty data action\r\n * @param input The action input\r\n * @param ctx The action context\r\n */export function issueLoyaltyAction(_x,_x2){return _issueLoyaltyAction.apply(this,arguments);}function _issueLoyaltyAction(){_issueLoyaltyAction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var promises;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:promises=[getCartState(ctx),_getLoyalty(input,ctx)];return _context.abrupt(\"return\",Promise.all(promises).then(function(result){var cartState=result[0];var card=result[1];if(card&&card.CardNumber){updateCart(cartState,card);return card;}//@ts-ignore\n//TO-DO: Remove after SDK bug fix https://msdyneng.visualstudio.com/FinOps/_workitems/edit/473891\nreturn issueLoyaltyCardAsync({callerContext:ctx},{CustomerAccount:input.userAccountNumber||null}).then(function(issuedCard){updateCart(cartState,issuedCard);return issuedCard;})//@ts-ignore\n[\"catch\"](function(error){ctx.telemetry.exception(error);ctx.telemetry.debug('Issuing loyalty card failed');throw new Error('Issuing loyalty card failed');});})[\"catch\"](function(error){ctx.telemetry.exception(error);ctx.telemetry.debug('Unable to issue loyalty card');throw new Error('Unable to issue loyalty card');}));case 2:case\"end\":return _context.stop();}}},_callee);}));return _issueLoyaltyAction.apply(this,arguments);}function _getLoyalty(_x3,_x4){return _getLoyalty2.apply(this,arguments);}function _getLoyalty2(){_getLoyalty2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(input,ctx){var loyaltyCardInput;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:loyaltyCardInput=new GetLoyaltyCardInput(input.apiSettings);return _context2.abrupt(\"return\",getLoyaltyAction(loyaltyCardInput,ctx));case 2:case\"end\":return _context2.stop();}}},_callee2);}));return _getLoyalty2.apply(this,arguments);}function updateCart(cartState,card){cartState.updateLoyaltyCardId({loyaltyCardNumber:card.CardNumber});}/**\r\n * The getLoyaltyCard data action\r\n * Returns the loyalty card belonging to the customer\r\n */export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/issue-loyalty',action:issueLoyaltyAction,input:createIssueLoyaltyInput});","map":{"version":3,"sources":["../../src/issue-loyalty.ts"],"names":[],"mappings":"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","sourcesContent":["import { CacheType, createObservableDataAction, IAction, IActionContext, IActionInput, ICommerceApiSettings, ICreateActionContext } from '@msdyn365-commerce/core';\nimport { getCartState, ICartState } from '@msdyn365-commerce/global-state';\nimport { LoyaltyCard } from '@msdyn365-commerce/retail-proxy';\nimport { issueLoyaltyCardAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport { getLoyaltyAction, GetLoyaltyCardInput} from './get-loyalty-card';\nimport { buildCacheKey } from './index';\n\n/**\n *  Input class for the issueLoyalty data action\n */\nexport class IssueLoyaltyInput implements IActionInput {\n    public userAccountNumber?: string;\n    public apiSettings: ICommerceApiSettings;\n\n    constructor(apiSettings: ICommerceApiSettings, userAccountNumber?: string) {\n        this.userAccountNumber = userAccountNumber;\n        this.apiSettings = apiSettings;\n    }\n\n    public getCacheKey = () => buildCacheKey(`IssueLoyalty-${this.userAccountNumber}`, this.apiSettings);\n    public getCacheObjectType = () => 'GetIssueLoyalty';\n    public dataCacheType = (): CacheType => 'request';\n}\n\n/**\n * createInput method for the issueLoyalty method\n * @param inputData The input data passed to the createInput method\n */\nexport const createIssueLoyaltyInput = (inputData: ICreateActionContext): IActionInput => {\n    const { requestContext } = inputData;\n\n    if (!requestContext.user.isAuthenticated) {\n        throw new Error('Unable to create issue loyalty input.  User is not authenticated.');\n    }\n\n    return new IssueLoyaltyInput(inputData.requestContext.apiSettings);\n};\n\n/**\n * The action method for the issueLoyalty data action\n * @param input The action input\n * @param ctx The action context\n */\nexport async function issueLoyaltyAction(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const promises: [Promise<ICartState>,Promise<LoyaltyCard>] = [ getCartState(ctx), _getLoyalty(input, ctx)];\n    return Promise.all(promises)\n            .then((result) => {\n                const cartState = result[0];\n                const card = result[1];\n                if (card && card.CardNumber) {\n                    updateCart(cartState, card);\n                    return card;\n                }\n                //@ts-ignore\n                //TO-DO: Remove after SDK bug fix https://msdyneng.visualstudio.com/FinOps/_workitems/edit/473891\n                return issueLoyaltyCardAsync({ callerContext: ctx }, { CustomerAccount: input.userAccountNumber || null })     \n                    .then((issuedCard: LoyaltyCard) => {\n                        updateCart(cartState, issuedCard);\n                        return issuedCard;\n                    })\n                    //@ts-ignore\n                    .catch(error => {\n                        ctx.telemetry.exception(error);\n                        ctx.telemetry.debug('Issuing loyalty card failed');\n                        throw new Error('Issuing loyalty card failed');\n                    });\n            })\n            .catch((error: Error) => {\n                ctx.telemetry.exception(error);\n                ctx.telemetry.debug('Unable to issue loyalty card');\n                throw new Error('Unable to issue loyalty card');\n            });\n}\n\nasync function _getLoyalty(input: IssueLoyaltyInput, ctx: IActionContext): Promise<LoyaltyCard> {\n    const loyaltyCardInput = new GetLoyaltyCardInput(input.apiSettings);\n    return getLoyaltyAction(loyaltyCardInput, ctx);\n}\n\nfunction updateCart(cartState: ICartState, card: LoyaltyCard): void {\n    cartState.updateLoyaltyCardId({loyaltyCardNumber: card.CardNumber});\n}\n\n/**\n * The getLoyaltyCard data action\n * Returns the loyalty card belonging to the customer\n */\nexport default createObservableDataAction<LoyaltyCard>({\n    id: '@msdyn365-commerce-modules/retail-actions/issue-loyalty',\n    action: <IAction<LoyaltyCard>>issueLoyaltyAction,\n    input: <(args: ICreateActionContext) => IActionInput>createIssueLoyaltyInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}