{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _merge2 from\"lodash/merge\";function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol===\"undefined\"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e){throw _e;},f:F};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]();},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e2){didErr=true;err=_e2;},f:function f(){try{if(!normalCompletion&&it[\"return\"]!=null)it[\"return\"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */ // tslint:disable:typedef\n// tslint:disable:no-string-literal\nimport{isEmptyOrNullObject,isObject,resolveRef,safeFileExists,safeGetAllFilesPath,safeGetAllFilesPathSync,safeReadJson,safeWriteJson}from'@msdyn365-commerce/utilities-internal';import*as path from'path';import{msdyn365Commerce}from'@msdyn365-commerce/core-internal';import{EVENT_DAPI_GETALLMODULES_START,EVENT_DAPI_GETALLMODULES_STOP,LogLevel,METRIC_DAPI_NO_RESULT}from'@msdyn365-commerce/telemetry-internal';import keystonePaths from'../../paths';import{getModuleBinder,getModuleName,isSSK2App}from'../../utils/helpers';import{getAvailableThemes}from'./stylesDefinition';var defaults={page:undefined};var classNameDefnProperty={friendlyName:'Default CSS Class Name(s)',description:'Provides a way to set configurable default css class(es) to apply to your module.',type:'css'};var globallyFailedModules=[];var getOriginalModuleDefs=function getOriginalModuleDefs(moduleName){var bindings=msdyn365Commerce.bindings;if(bindings.dapi&&bindings.dapi.modules){return bindings.dapi.modules[moduleName];}return{};};export function getFailedModulesList(){return globallyFailedModules;}/**\r\n * route [/dapi/modulelist] to return list of all register modules.\r\n */ // tslint:disable:no-any\nexport function getModulesList(){return _getModulesList.apply(this,arguments);}function _getModulesList(){_getModulesList=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee17(){var bindings;return _regeneratorRuntime.wrap(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:bindings=msdyn365Commerce.getAllModuleBinder();if(!(!bindings||bindings.length===0)){_context17.next=3;break;}return _context17.abrupt(\"return\",['No module registration found']);case 3:return _context17.abrupt(\"return\",bindings.map(function(moduleBinder){return moduleBinder.name;}));case 4:case\"end\":return _context17.stop();}}},_callee17);}));return _getModulesList.apply(this,arguments);}var getPageDefaults=function getPageDefaults(){if(!defaults.page){// TODO: move this to json file?\nvar temp={className:{friendlyName:'ClassName',description:'class properties',type:'string',\"default\":'',group:'Page Layout'},pageTheme:{friendlyName:'Page theme',description:'Page theme',type:'string',\"enum\":{},group:'Theme'}};temp.pageTheme[\"enum\"]=_objectSpread({},getAvailableThemes());defaults.page=temp;}return defaults.page;};var renameKeyInObject=function renameKeyInObject(value,oldkey,newkey,depth){if(isObject(value)&&isEmptyOrNullObject(value)){return value;}if(oldkey!==newkey&&value.hasOwnProperty(oldkey)){// @ts-ignore\nObject.defineProperty(value,newkey,Object.getOwnPropertyDescriptor(value,oldkey));delete value[oldkey];}// if depth === undefined, then rename till all depth\nif(depth!==undefined&&depth===0){return;}Object.keys(value).forEach(function(key){var childObject=value[key];if(isObject(childObject)){renameKeyInObject(childObject,oldkey,newkey,depth&&depth-1);}});};var parseModuleDefinition=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(defN,definitionPath,telemetry){var definitionWithResolvedRef;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return resolveRef(defN,definitionPath,telemetry);case 2:definitionWithResolvedRef=_context.sent;definitionWithResolvedRef['module']&&delete definitionWithResolvedRef['module'];renameKeyInObject(definitionWithResolvedRef,'$type','type',0);return _context.abrupt(\"return\",definitionWithResolvedRef);case 6:case\"end\":return _context.stop();}}},_callee);}));return function parseModuleDefinition(_x,_x2,_x3){return _ref.apply(this,arguments);};}();export var getModuleDefinition=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(moduleBinder,telemetry){var pageDefault,definition;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:// read from cache or fs\npageDefault=getPageDefaults();_context2.next=3;return getModuleDefinitionObj(moduleBinder,telemetry);case 3:definition=_context2.sent;if(definition&&definition.categories&&definition.categories.indexOf&&definition.categories.indexOf('page')!==-1){definition.config=_objectSpread(_objectSpread({},definition.config),pageDefault);}if(definition&&moduleBinder.$type===\"themeModule\"/* TYPE */){definition.pages=moduleBinder.pages||{};definition.segments=moduleBinder.segments||[];}return _context2.abrupt(\"return\",definition);case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function getModuleDefinition(_x4,_x5){return _ref2.apply(this,arguments);};}();export var isDAPIOptimizationDisabled=function isDAPIOptimizationDisabled(platformSettings){platformSettings=platformSettings||msdyn365Commerce.platformSettings;return platformSettings&&!!platformSettings.disableDAPIOptimizations;};var getModuleDefinitionObj=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(moduleBinder,telemetry){var definitionFile,definitionError;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!isDAPIOptimizationDisabled()){_context3.next=9;break;}_context3.next=3;return safeReadJson(moduleBinder.definitionPath,{error:function error(input){telemetry.log(LogLevel.Error,\"Couldn't read definition file [\".concat(moduleBinder.definitionPath,\"]\"),{exception:input});}});case 3:definitionFile=_context3.sent;if(!(!definitionFile||isEmptyOrNullObject(definitionFile))){_context3.next=8;break;}definitionError={error:\"problem found with definition file [\".concat(moduleBinder.definitionPath,\"] for module [\").concat(moduleBinder.name,\"]\")};globallyFailedModules.push(definitionError);return _context3.abrupt(\"return\",definitionError);case 8:return _context3.abrupt(\"return\",parseModuleDefinition(definitionFile,moduleBinder.definitionPath,telemetry));case 9:return _context3.abrupt(\"return\",getOriginalModuleDefs(moduleBinder.name));case 10:case\"end\":return _context3.stop();}}},_callee3);}));return function getModuleDefinitionObj(_x6,_x7){return _ref3.apply(this,arguments);};}();var getAllModuleDefinitions=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(modules,telemetry){var definitions;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:telemetry.trackEvent(EVENT_DAPI_GETALLMODULES_START);_context5.next=3;return Promise.all(modules.map(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(moduleBinder){var definition,dataJson;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!isDAPIOptimizationDisabled()){_context4.next=9;break;}_context4.next=3;return getModuleDefinition(moduleBinder,telemetry);case 3:definition=_context4.sent;_context4.next=6;return getDataJsonAndParse(moduleBinder,telemetry);case 6:dataJson=_context4.sent;!isEmptyOrNullObject(dataJson)&&(definition['data']=dataJson);return _context4.abrupt(\"return\",definition);case 9:return _context4.abrupt(\"return\",getModuleDefinition(moduleBinder,telemetry));case 10:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x10){return _ref5.apply(this,arguments);};}()));case 3:definitions=_context5.sent;// filter out any deprecated modules, if its an SSK 2.0 app\nif(isSSK2App()&&definitions){definitions=definitions.filter(function(item){return item&&!(item['attributes']&&item['attributes']['deprecate']);});}telemetry.trackEvent(EVENT_DAPI_GETALLMODULES_STOP);return _context5.abrupt(\"return\",definitions);case 7:case\"end\":return _context5.stop();}}},_callee5);}));return function getAllModuleDefinitions(_x8,_x9){return _ref4.apply(this,arguments);};}();/**\r\n * Adds any default properties the module config should have\r\n * to the dapi response\r\n *\r\n * @param result List of modules\r\n */var addDefaultModuleConfigProperties=function addDefaultModuleConfigProperties(defJson){var type=defJson.type||defJson.$type;if(defJson&&(type==='contentModule'||type==='containerModule'||type==='pageModule'||type==='definitionExtension')){// Every module should have a class name property added if missing from the definition json\nif(!defJson.config){defJson.config={};}if(!defJson.config.className){defJson.config.className=classNameDefnProperty;}else{// if className is defined ensure type is set to 'css'\ndefJson.config.className.type='css';}}};/**\r\n * Get theme definition extensions\r\n * @param themeModuleName name of the theme module\r\n * @param themeModuleBinder theme module binder object\r\n */var getThemeDefinitionExtensions=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(themeModuleName,themeModuleBinder){var themeDefinitionExtensions,parentThemeName,parentThemeBinder,_iterator,_step,moduleName,pathToDefinition,defExtensionJson,_iterator2,_step2,_moduleName,_pathToDefinition,_defExtensionJson,partnerDefinitionExtensions,_iterator3,_step3,pathToDefExt,partnerDefExtensionJson,_moduleName2;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:themeDefinitionExtensions={};// In case of extended theme module, read parent theme definiton extensions first\nif(!themeModuleBinder.parentDefinitionPath){_context6.next=31;break;}parentThemeName=getModuleName(themeModuleBinder.parentDefinitionPath);parentThemeBinder=getModuleBinder(parentThemeName);parentThemeBinder.definitionExtensions=parentThemeBinder.definitionExtensions||[];_iterator=_createForOfIteratorHelper(parentThemeBinder.definitionExtensions);_context6.prev=6;_iterator.s();case 8:if((_step=_iterator.n()).done){_context6.next=23;break;}moduleName=_step.value;pathToDefinition=path.join(parentThemeBinder.moduleDirectory,\"definition-extensions\"/* DEF_EXTENSIONS */,\"\".concat(moduleName,\".definition.ext.json\"/* DEF_EXT_FILE */));_context6.next=13;return safeReadJson(pathToDefinition);case 13:_context6.t0=_context6.sent;if(_context6.t0){_context6.next=16;break;}_context6.t0={};case 16:defExtensionJson=_context6.t0;addDefaultModuleConfigProperties(defExtensionJson);_context6.next=20;return resolveRef(defExtensionJson,pathToDefinition);case 20:themeDefinitionExtensions[moduleName]=_context6.sent;case 21:_context6.next=8;break;case 23:_context6.next=28;break;case 25:_context6.prev=25;_context6.t1=_context6[\"catch\"](6);_iterator.e(_context6.t1);case 28:_context6.prev=28;_iterator.f();return _context6.finish(28);case 31:// Read theme module definition extensions\nthemeModuleBinder.definitionExtensions=themeModuleBinder.definitionExtensions||[];_iterator2=_createForOfIteratorHelper(themeModuleBinder.definitionExtensions);_context6.prev=33;_iterator2.s();case 35:if((_step2=_iterator2.n()).done){_context6.next=50;break;}_moduleName=_step2.value;_pathToDefinition=path.join(themeModuleBinder.moduleDirectory,\"definition-extensions\"/* DEF_EXTENSIONS */,\"\".concat(_moduleName,\".definition.ext.json\"/* DEF_EXT_FILE */));_context6.next=40;return safeReadJson(_pathToDefinition);case 40:_context6.t2=_context6.sent;if(_context6.t2){_context6.next=43;break;}_context6.t2={};case 43:_defExtensionJson=_context6.t2;addDefaultModuleConfigProperties(_defExtensionJson);_context6.next=47;return resolveRef(_defExtensionJson,_pathToDefinition);case 47:themeDefinitionExtensions[_moduleName]=_context6.sent;case 48:_context6.next=35;break;case 50:_context6.next=55;break;case 52:_context6.prev=52;_context6.t3=_context6[\"catch\"](33);_iterator2.e(_context6.t3);case 55:_context6.prev=55;_iterator2.f();return _context6.finish(55);case 58:_context6.next=60;return safeGetAllFilesPath(path.join(keystonePaths.KEYSTONE_THEMES_DIR,themeModuleName,\"definition-extensions\"/* DEF_EXTENSIONS */,\"*\".concat(\".definition.ext.json\"/* DEF_EXT_FILE */)));case 60:_context6.t4=_context6.sent;if(_context6.t4){_context6.next=63;break;}_context6.t4=[];case 63:partnerDefinitionExtensions=_context6.t4;_iterator3=_createForOfIteratorHelper(partnerDefinitionExtensions);_context6.prev=65;_iterator3.s();case 67:if((_step3=_iterator3.n()).done){_context6.next=82;break;}pathToDefExt=_step3.value;_context6.next=71;return safeFileExists(pathToDefExt);case 71:if(!_context6.sent){_context6.next=80;break;}_context6.next=74;return safeReadJson(pathToDefExt);case 74:_context6.t5=_context6.sent;if(_context6.t5){_context6.next=77;break;}_context6.t5={};case 77:partnerDefExtensionJson=_context6.t5;_moduleName2=path.basename(pathToDefExt,\".definition.ext.json\"/* DEF_EXT_FILE */);themeDefinitionExtensions[_moduleName2]=_merge2(themeDefinitionExtensions[_moduleName2],partnerDefExtensionJson);case 80:_context6.next=67;break;case 82:_context6.next=87;break;case 84:_context6.prev=84;_context6.t6=_context6[\"catch\"](65);_iterator3.e(_context6.t6);case 87:_context6.prev=87;_iterator3.f();return _context6.finish(87);case 90:// Check and remove config properties present from config of theme definition extension, if duplicate property exists in dependncies of definition extension\nthemeDefinitionExtensions=filterConfigProperties(themeDefinitionExtensions);return _context6.abrupt(\"return\",themeDefinitionExtensions);case 92:case\"end\":return _context6.stop();}}},_callee6,null,[[6,25,28,31],[33,52,55,58],[65,84,87,90]]);}));return function getThemeDefinitionExtensions(_x11,_x12){return _ref6.apply(this,arguments);};}();/**\r\n * Filters config properties present from config of Definition extension, if same property exists in dependncies of definition extension\r\n * @param themeDefinitionExtensions Final response of theme definition extension\r\n */var filterConfigProperties=function filterConfigProperties(themeDefinitionExtensions){var properties=Object.keys(themeDefinitionExtensions);if(properties.length>0){for(var i=0;i<properties.length;i++){var DefinitionExtension=themeDefinitionExtensions[properties[i]];var config=DefinitionExtension['config'];if(config&&DefinitionExtension['dependencies']){var dependencies=DefinitionExtension.dependencies.moduleLayout.oneOf;for(var j=0;j<dependencies.length;j++){var extendedproperties=dependencies[j].properties;for(var _i=0,_Object$keys=Object.keys(extendedproperties);_i<_Object$keys.length;_i++){var propertyKey=_Object$keys[_i];if(config[propertyKey]){delete config[propertyKey];}}}}}}return themeDefinitionExtensions;};/**\r\n * Get default theme style presets definition extensions\r\n * @param themeModuleName name of the theme module\r\n * @param themeModuleBinder theme module binder object\r\n */var getDefaultThemeStylePreset=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(themeModuleName,themeModuleBinder){var pathToThemeStylesDefinition,themeStylePresets,pathToPartnerThemeStylePresets,partnerThemeStylesDefinition;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:pathToThemeStylesDefinition=path.join(themeModuleBinder.moduleDirectory,\"styles\"/* STYLES */,\"\".concat(themeModuleName,\".definition.scss.json\"/* STYLE_PRESET_DEFINITION_FILE */));_context7.t0=resolveRef;_context7.next=4;return safeReadJson(pathToThemeStylesDefinition);case 4:_context7.t1=_context7.sent;if(_context7.t1){_context7.next=7;break;}_context7.t1={};case 7:_context7.t2=_context7.t1;_context7.t3=pathToThemeStylesDefinition;_context7.next=11;return(0,_context7.t0)(_context7.t2,_context7.t3);case 11:themeStylePresets=_context7.sent;pathToPartnerThemeStylePresets=path.join(keystonePaths.KEYSTONE_THEMES_DIR,themeModuleName,\"styles\"/* STYLES */,\"\".concat(themeModuleName,\".definition.scss.json\"/* STYLE_PRESET_DEFINITION_FILE */));_context7.t4=resolveRef;_context7.next=16;return safeReadJson(pathToPartnerThemeStylePresets);case 16:_context7.t5=_context7.sent;if(_context7.t5){_context7.next=19;break;}_context7.t5={};case 19:_context7.t6=_context7.t5;_context7.t7=pathToPartnerThemeStylePresets;_context7.next=23;return(0,_context7.t4)(_context7.t6,_context7.t7);case 23:partnerThemeStylesDefinition=_context7.sent;return _context7.abrupt(\"return\",_merge2(themeStylePresets,partnerThemeStylesDefinition));case 25:case\"end\":return _context7.stop();}}},_callee7);}));return function getDefaultThemeStylePreset(_x13,_x14){return _ref7.apply(this,arguments);};}();/**\r\n * Get additional theme style presets extensions\r\n * @param themeModuleName name of the theme module\r\n * @param themeModuleBinder theme module binder object\r\n */var getThemeStylePresetInstances=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(themeModuleName,themeModuleBinder){var mergedFiles,keystoneThemeFilePath,getThemeFilePaths,getKeystoneFilePaths,i,stylePresetName,additionalThemeStylePresets;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:mergedFiles={};keystoneThemeFilePath=path.join(keystonePaths.KEYSTONE_THEMES_DIR,themeModuleName,\"styles\"/* STYLES */);_context8.next=4;return safeGetAllFilesPath(path.join(themeModuleBinder.moduleDirectory,\"styles\"/* STYLES */,\"/*\".concat(\".scss.json\"/* STYLE_PRESET_INSTANCE_FILE */)));case 4:getThemeFilePaths=_context8.sent.filter(function(p){return!p.endsWith(\".definition.scss.json\"/* STYLE_PRESET_DEFINITION_FILE */);});getKeystoneFilePaths=safeGetAllFilesPathSync(path.join(keystoneThemeFilePath,\"/*\".concat(\".scss.json\"/* STYLE_PRESET_INSTANCE_FILE */))).filter(function(p){return!p.endsWith(\".definition.scss.json\"/* STYLE_PRESET_DEFINITION_FILE */);});Array.prototype.push.apply(getThemeFilePaths,getKeystoneFilePaths);if(!(getThemeFilePaths.length>0)){_context8.next=21;break;}i=0;case 9:if(!(i<getThemeFilePaths.length)){_context8.next=21;break;}stylePresetName=path.basename(getThemeFilePaths[i],'.scss.json');_context8.next=13;return safeReadJson(getThemeFilePaths[i]);case 13:_context8.t0=_context8.sent;if(_context8.t0){_context8.next=16;break;}_context8.t0={};case 16:additionalThemeStylePresets=_context8.t0;mergedFiles[stylePresetName]=_merge2(mergedFiles[stylePresetName],additionalThemeStylePresets);case 18:i++;_context8.next=9;break;case 21:return _context8.abrupt(\"return\",mergedFiles);case 22:case\"end\":return _context8.stop();}}},_callee8);}));return function getThemeStylePresetInstances(_x15,_x16){return _ref8.apply(this,arguments);};}();var getDataJsonPath=function getDataJsonPath(definitionPath,isNodeModule){var filePath=(isNodeModule?definitionPath:definitionPath.replace('src/modules','build/definitions')).replace('.definition.json','.data.json');return path.resolve(filePath);};export var getDataJsonAndParse=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(moduleBinder,telemetry){var dataJsonPathFromDefinitionPath,dataJsonFileExists,dataJsonFile,dataJson;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:dataJsonPathFromDefinitionPath=getDataJsonPath(moduleBinder.definitionPath,moduleBinder.isNodeModule);_context9.next=3;return safeFileExists(dataJsonPathFromDefinitionPath);case 3:dataJsonFileExists=_context9.sent;if(!(!dataJsonFileExists&&moduleBinder.parentDefinitionPath)){_context9.next=9;break;}dataJsonPathFromDefinitionPath=getDataJsonPath(moduleBinder.parentDefinitionPath,moduleBinder.isNodeModule);_context9.next=8;return safeFileExists(dataJsonPathFromDefinitionPath);case 8:dataJsonFileExists=_context9.sent;case 9:if(dataJsonFileExists){_context9.next=11;break;}return _context9.abrupt(\"return\",{});case 11:_context9.next=13;return safeReadJson(dataJsonPathFromDefinitionPath,{error:function error(input){telemetry.log(LogLevel.Error,\"Couldn't read data json file [\".concat(dataJsonPathFromDefinitionPath,\"]\"),{exception:input});}});case 13:dataJsonFile=_context9.sent;dataJson=dataJsonFile&&dataJsonFile['properties'];if(dataJson){_context9.next=17;break;}return _context9.abrupt(\"return\",{});case 17:Object.keys(dataJson).forEach(function(eachDataTypePropertyKey){var eachDataTypeProperty=dataJson[eachDataTypePropertyKey];if(eachDataTypeProperty.filterFromDAPI){delete dataJson[eachDataTypePropertyKey];}});renameKeyInObject(dataJson,'$ref','type',3);return _context9.abrupt(\"return\",dataJson);case 20:case\"end\":return _context9.stop();}}},_callee9);}));return function getDataJsonAndParse(_x17,_x18){return _ref9.apply(this,arguments);};}();export var getModuleDefinitionApiFile=/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(modules,telemetry){var moduleDefinitionApiFileExists,definitions;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:if(!(process.env.NODE_ENV==='production')){_context10.next=13;break;}_context10.next=3;return safeFileExists(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH,{debug:function debug(input){telemetry.log(LogLevel.Debug,input);},error:function error(input){telemetry.log(LogLevel.Error,input);}});case 3:moduleDefinitionApiFileExists=_context10.sent;if(!moduleDefinitionApiFileExists){_context10.next=6;break;}return _context10.abrupt(\"return\",safeReadJson(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH,{error:function error(input){telemetry.log(LogLevel.Error,\"Couldn't read definition api file [\".concat(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH,\"]\"),{exception:input});}}));case 6:_context10.next=8;return getAllModuleDefinitions(modules,telemetry);case 8:definitions=_context10.sent;if(!(definitions&&definitions.length>0)){_context10.next=12;break;}_context10.next=12;return safeWriteJson(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH,definitions);case 12:return _context10.abrupt(\"return\",definitions);case 13:return _context10.abrupt(\"return\",getAllModuleDefinitions(modules,telemetry));case 14:case\"end\":return _context10.stop();}}},_callee10);}));return function getModuleDefinitionApiFile(_x19,_x20){return _ref10.apply(this,arguments);};}();/**\r\n * route to return definition JSON\r\n * [/dapi/modules] - return all modules defintion\r\n * [/dapi/modules?type=<moduleType>] - return specific module type defintion\r\n * @param moduleType\r\n * @param telemetry\r\n */export function getModuleDefinitions(_x21,_x22){return _getModuleDefinitions.apply(this,arguments);}/**\r\n * route to return definition JSON\r\n * [/dapi/themes] - return all modules defintion\r\n * [/dapi/themes?type=<moduleType>] - return specific module type defintion\r\n * @param moduleType\r\n * @param telemetry\r\n */function _getModuleDefinitions(){_getModuleDefinitions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee18(moduleType,telemetry){var result,message,i,defN;return _regeneratorRuntime.wrap(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:if(!(moduleType&&!msdyn365Commerce.moduleBinder(moduleType))){_context18.next=2;break;}return _context18.abrupt(\"return\",JSON.stringify({error:\"type [\".concat(moduleType,\"] not defined\")}));case 2:if(!isDAPIOptimizationDisabled()){_context18.next=8;break;}_context18.next=5;return getModuleDefinitionApiFile(msdyn365Commerce.getAllModuleBinder(),telemetry);case 5:_context18.t0=_context18.sent;_context18.next=11;break;case 8:_context18.next=10;return getAllModuleDefinitions(msdyn365Commerce.getAllModuleBinder(),telemetry);case 10:_context18.t0=_context18.sent;case 11:result=_context18.t0;if(result){_context18.next=16;break;}message=\"DefinitionAPI: There is no information in the result.\";telemetry.trackMetric(METRIC_DAPI_NO_RESULT,1);return _context18.abrupt(\"return\",message);case 16:// Add default module config properties to DAPI response\nfor(i=0;i<result.length;i++){addDefaultModuleConfigProperties(result[i]);}if(!(moduleType&&result.length>0)){_context18.next=24;break;}defN=result.map(function(definition){return definition&&definition.name&&definition.name===moduleType&&definition;}).filter(Boolean);if(!(defN&&defN.length>0)){_context18.next=23;break;}return _context18.abrupt(\"return\",defN);case 23:return _context18.abrupt(\"return\",\"{ error: 'type not found [\".concat(moduleType,\"]'}\"));case 24:return _context18.abrupt(\"return\",result);case 25:case\"end\":return _context18.stop();}}},_callee18);}));return _getModuleDefinitions.apply(this,arguments);}var getAllThemeModules=/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(telemetry){var themeModules,allModulesBinder,allThemeModulesBinder;return _regeneratorRuntime.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:themeModules=msdyn365Commerce.themeModules||[];if(!themeModules.length){_context12.next=3;break;}return _context12.abrupt(\"return\",themeModules);case 3:_context12.next=5;return msdyn365Commerce.getAllModuleBinder();case 5:allModulesBinder=_context12.sent;if(!Array.isArray(allModulesBinder)){_context12.next=10;break;}allThemeModulesBinder=allModulesBinder.filter(function(def){return def.$type===\"themeModule\";}/* TYPE */);_context12.next=10;return Promise.all(allThemeModulesBinder.map(/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(themeModuleBinder){var themeModule,themeStylePresets;return _regeneratorRuntime.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return getModuleDefinition(themeModuleBinder,telemetry);case 2:themeModule=_context11.sent;_context11.next=5;return getThemePages(themeModuleBinder);case 5:themeModule.pages=_context11.sent;_context11.next=8;return getThemeSegments(themeModuleBinder);case 8:themeModule.segments=_context11.sent;_context11.next=11;return getThemeDefinitionExtensions(themeModule.name,themeModuleBinder);case 11:themeModule.definitionExtensions=_context11.sent;_context11.next=14;return getDefaultThemeStylePreset(themeModule.name,themeModuleBinder);case 14:themeStylePresets=_context11.sent;_context11.t0=themeStylePresets;if(!(Object.entries(themeStylePresets).length!==0)){_context11.next=22;break;}_context11.next=19;return getThemeStylePresetInstances(themeModule.name,themeModuleBinder);case 19:_context11.t1=_context11.sent;_context11.next=23;break;case 22:_context11.t1={};case 23:_context11.t2=_context11.t1;themeModule.styles={definition:_context11.t0,presets:_context11.t2};themeModules.push(themeModule);case 26:case\"end\":return _context11.stop();}}},_callee11);}));return function(_x24){return _ref12.apply(this,arguments);};}()));case 10:msdyn365Commerce.setThemeModules(themeModules);return _context12.abrupt(\"return\",themeModules);case 12:case\"end\":return _context12.stop();}}},_callee12);}));return function getAllThemeModules(_x23){return _ref11.apply(this,arguments);};}();/**\r\n * Gets the pages in the given theme module\r\n * @param themeModuleBinder binder for the theme module object\r\n */var getThemePages=/*#__PURE__*/function(){var _ref13=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee13(themeModuleBinder){var pageNames,themePages,_i2,_pageNames,pageName,layouts,_iterator4,_step4,layout,pathToPageLayout,pageLayoutJson;return _regeneratorRuntime.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:pageNames=Object.keys(themeModuleBinder.pages||{});themePages={};_i2=0,_pageNames=pageNames;case 3:if(!(_i2<_pageNames.length)){_context13.next=35;break;}pageName=_pageNames[_i2];layouts=themeModuleBinder.pages[pageName]||[];_iterator4=_createForOfIteratorHelper(layouts);_context13.prev=7;_iterator4.s();case 9:if((_step4=_iterator4.n()).done){_context13.next=24;break;}layout=_step4.value;pathToPageLayout=path.join(themeModuleBinder.moduleDirectory,\"layouts\"/* LAYOUTS */,\"pages\"/* PAGES */,pageName,\"\".concat(layout,\".page.json\"/* PAGE_FILE */));_context13.next=14;return safeReadJson(pathToPageLayout);case 14:_context13.t0=_context13.sent;if(_context13.t0){_context13.next=17;break;}_context13.t0={};case 17:pageLayoutJson=_context13.t0;themePages[pageName]=themePages[pageName]||{};_context13.next=21;return resolveRef(pageLayoutJson,pathToPageLayout);case 21:themePages[pageName][layout]=_context13.sent;case 22:_context13.next=9;break;case 24:_context13.next=29;break;case 26:_context13.prev=26;_context13.t1=_context13[\"catch\"](7);_iterator4.e(_context13.t1);case 29:_context13.prev=29;_iterator4.f();return _context13.finish(29);case 32:_i2++;_context13.next=3;break;case 35:return _context13.abrupt(\"return\",themePages);case 36:case\"end\":return _context13.stop();}}},_callee13,null,[[7,26,29,32]]);}));return function getThemePages(_x25){return _ref13.apply(this,arguments);};}();/**\r\n * Gets the segments in the given theme module\r\n * @param themeModuleBinder binder for the theme module object\r\n */var getThemeSegments=/*#__PURE__*/function(){var _ref14=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee14(themeModuleBinder){var segments,_iterator5,_step5,segment,pathToSegment,segmentJson;return _regeneratorRuntime.wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:segments={};themeModuleBinder.segments=themeModuleBinder.segments||[];_iterator5=_createForOfIteratorHelper(themeModuleBinder.segments);_context14.prev=3;_iterator5.s();case 5:if((_step5=_iterator5.n()).done){_context14.next=19;break;}segment=_step5.value;pathToSegment=path.join(themeModuleBinder.moduleDirectory,\"layouts\"/* LAYOUTS */,\"segments\"/* SEGMENTS */,\"\".concat(segment,\".segment.json\"/* SEGMENT_FILE */));_context14.next=10;return safeReadJson(pathToSegment);case 10:_context14.t0=_context14.sent;if(_context14.t0){_context14.next=13;break;}_context14.t0={};case 13:segmentJson=_context14.t0;_context14.next=16;return resolveRef(segmentJson,pathToSegment);case 16:segments[segment]=_context14.sent;case 17:_context14.next=5;break;case 19:_context14.next=24;break;case 21:_context14.prev=21;_context14.t1=_context14[\"catch\"](3);_iterator5.e(_context14.t1);case 24:_context14.prev=24;_iterator5.f();return _context14.finish(24);case 27:return _context14.abrupt(\"return\",segments);case 28:case\"end\":return _context14.stop();}}},_callee14,null,[[3,21,24,27]]);}));return function getThemeSegments(_x26){return _ref14.apply(this,arguments);};}();/**\r\n * Method to return the full theme module object with layouts and segments\r\n * @param moduleName theme module name to be filtered\r\n * @param telemetry\r\n */export var getThemeModules=/*#__PURE__*/function(){var _ref15=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee15(moduleName,telemetry){var bindings,themeModules,defN;return _regeneratorRuntime.wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:if(!(moduleName&&!msdyn365Commerce.moduleBinder(moduleName))){_context15.next=2;break;}return _context15.abrupt(\"return\",JSON.stringify({error:\"theme module [\".concat(moduleName,\"] not found\")}));case 2:bindings=msdyn365Commerce.bindings;if(!isDAPIOptimizationDisabled()){_context15.next=9;break;}_context15.next=6;return getAllThemeModules(telemetry);case 6:_context15.t0=_context15.sent;_context15.next=10;break;case 9:_context15.t0=bindings.dapi.themes||[];case 10:themeModules=_context15.t0;if(!(moduleName&&themeModules.length>0)){_context15.next=18;break;}defN=themeModules.map(function(definition){return definition&&definition.name&&definition.name===moduleName&&definition;}).filter(Boolean);if(!(defN&&defN.length>0)){_context15.next=17;break;}return _context15.abrupt(\"return\",defN);case 17:return _context15.abrupt(\"return\",\"{ error: 'type not found [\".concat(moduleName,\"]'}\"));case 18:return _context15.abrupt(\"return\",Promise.resolve(themeModules));case 19:case\"end\":return _context15.stop();}}},_callee15);}));return function getThemeModules(_x27,_x28){return _ref15.apply(this,arguments);};}();/**\r\n * Method to return list of theme modules names\r\n * @param telemetry\r\n */export var getThemeModulesList=/*#__PURE__*/function(){var _ref16=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee16(telemetry){var themeModulesList;return _regeneratorRuntime.wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:_context16.next=2;return getThemeModules(null,telemetry);case 2:themeModulesList=_context16.sent;return _context16.abrupt(\"return\",Array.isArray(themeModulesList)?themeModulesList.map(function(themeModule){return themeModule.name;}):[]);case 4:case\"end\":return _context16.stop();}}},_callee16);}));return function getThemeModulesList(_x29){return _ref16.apply(this,arguments);};}();","map":{"version":3,"sources":["../../../../src/_server/Definition/moduleDefinition.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\n// tslint:disable:typedef\n// tslint:disable:no-string-literal\nimport {\n    isEmptyOrNullObject,\n    isObject,\n    resolveRef,\n    safeFileExists,\n    safeGetAllFilesPath,\n    safeGetAllFilesPathSync,\n    safeReadJson,\n    safeWriteJson\n} from '@msdyn365-commerce/utilities-internal';\nimport * as path from 'path';\n\nimport { IPlatformSettings, IThemeModule, msdyn365Commerce } from '@msdyn365-commerce/core-internal';\nimport {\n    EVENT_DAPI_GETALLMODULES_START,\n    EVENT_DAPI_GETALLMODULES_STOP,\n    IInternalTelemetry,\n    LogLevel,\n    METRIC_DAPI_FILTER,\n    METRIC_DAPI_NO_RESULT\n} from '@msdyn365-commerce/telemetry-internal';\nimport { merge as _merge } from 'lodash';\nimport { IModuleBinder, IMSDyn365CommerceExtension } from '../../app-initialization/models';\nimport keystonePaths from '../../paths';\nimport { getModuleBinder, getModuleName, isSSK2App } from '../../utils/helpers';\nimport { getAvailableThemes } from './stylesDefinition';\n\nexport const enum THEME_MODULE {\n    TYPE = 'themeModule',\n    PAGES = 'pages',\n    LAYOUTS = 'layouts',\n    SEGMENTS = 'segments',\n    STYLES = 'styles',\n    STYLE_PRESET_DEFINITION_FILE = '.definition.scss.json',\n    STYLE_PRESET_INSTANCE_FILE = '.scss.json',\n    DEF_EXTENSIONS = 'definition-extensions',\n    VIEWS = 'views',\n    DEF_EXT_FILE = '.definition.ext.json',\n    SETTINGS_FILE = '.theme.settings.json',\n    PAGE_FILE = '.page.json',\n    SEGMENT_FILE = '.segment.json',\n    DEFINITION_FILE = '.definition.json'\n}\n\nexport const enum DefinitionType {\n    Modules = 'modules',\n    ModuleList = 'modulelist',\n    /**\n     * Contains themes & styles definitions\n     */\n    Styles = 'styles',\n    AppSettings = 'appsettings',\n    ImageSettings = 'imagesettings',\n    ThemeSettings = 'themesettings',\n    Themes = 'themes',\n    ThemesList = 'themeslist',\n    Resources = 'resources',\n    Experiments = 'experiments'\n}\n\nconst defaults: { page: Object | undefined } = {\n    page: undefined\n};\n\nconst classNameDefnProperty = {\n    friendlyName: 'Default CSS Class Name(s)',\n    description: 'Provides a way to set configurable default css class(es) to apply to your module.',\n    type: 'css'\n};\n\nconst globallyFailedModules: Object[] = [];\nconst getOriginalModuleDefs = (moduleName: string) => {\n    const bindings = (<IMSDyn365CommerceExtension>(<unknown>msdyn365Commerce)).bindings;\n\n    if (bindings.dapi && bindings.dapi.modules) {\n        return bindings.dapi.modules[moduleName];\n    }\n\n    return {};\n};\n\nexport function getFailedModulesList() {\n    return globallyFailedModules;\n}\n\n/**\n * route [/dapi/modulelist] to return list of all register modules.\n */\n// tslint:disable:no-any\nexport async function getModulesList(): Promise<string[]> {\n    const bindings = (<any>msdyn365Commerce).getAllModuleBinder();\n    if (!bindings || bindings.length === 0) {\n        return ['No module registration found'];\n    }\n\n    return bindings.map((moduleBinder: IModuleBinder) => {\n        return moduleBinder.name;\n    });\n}\n\nconst getPageDefaults = () => {\n    if (!defaults.page) {\n        // TODO: move this to json file?\n        const temp = <any>{\n            className: {\n                friendlyName: 'ClassName',\n                description: 'class properties',\n                type: 'string',\n                default: '',\n                group: 'Page Layout'\n            },\n            pageTheme: {\n                friendlyName: 'Page theme',\n                description: 'Page theme',\n                type: 'string',\n                enum: {},\n                group: 'Theme'\n            }\n        };\n\n        temp.pageTheme.enum = {\n            ...getAvailableThemes()\n        };\n        defaults.page = temp;\n    }\n    return defaults.page;\n};\n\nconst renameKeyInObject = (value: object, oldkey: string, newkey: string, depth?: number) => {\n    if (isObject(value) && isEmptyOrNullObject(value)) {\n        return value;\n    }\n\n    if (oldkey !== newkey && value.hasOwnProperty(oldkey)) {\n        // @ts-ignore\n        Object.defineProperty(value, newkey, Object.getOwnPropertyDescriptor(value, oldkey));\n        delete value[oldkey];\n    }\n\n    // if depth === undefined, then rename till all depth\n    if (depth !== undefined && depth === 0) {\n        return;\n    }\n\n    Object.keys(value).forEach((key: string) => {\n        const childObject = value[key];\n        if (isObject(childObject)) {\n            renameKeyInObject(childObject, oldkey, newkey, depth && depth - 1);\n        }\n    });\n};\n\nconst parseModuleDefinition = async (defN, definitionPath, telemetry) => {\n    const definitionWithResolvedRef = await resolveRef(defN, definitionPath, telemetry);\n    definitionWithResolvedRef['module'] && delete definitionWithResolvedRef['module'];\n    renameKeyInObject(definitionWithResolvedRef, '$type', 'type', 0);\n    return definitionWithResolvedRef;\n};\n\nexport const getModuleDefinition = async (moduleBinder: IModuleBinder, telemetry: IInternalTelemetry) => {\n    // read from cache or fs\n    const pageDefault = getPageDefaults();\n\n    const definition: any = await getModuleDefinitionObj(moduleBinder, telemetry);\n\n    if (definition && definition.categories && definition.categories.indexOf && definition.categories.indexOf('page') !== -1) {\n        definition.config = {\n            ...definition.config,\n            ...pageDefault\n        };\n    }\n\n    if (definition && moduleBinder.$type === THEME_MODULE.TYPE) {\n        definition.pages = moduleBinder.pages || {};\n        definition.segments = moduleBinder.segments || [];\n    }\n\n    return definition;\n};\n\nexport const isDAPIOptimizationDisabled = (platformSettings?: IPlatformSettings) => {\n    platformSettings = platformSettings || msdyn365Commerce.platformSettings;\n    return platformSettings && !!platformSettings.disableDAPIOptimizations;\n};\n\nconst getModuleDefinitionObj = async (moduleBinder: IModuleBinder, telemetry: IInternalTelemetry) => {\n    if (isDAPIOptimizationDisabled()) {\n        const definitionFile = await safeReadJson<object>(moduleBinder.definitionPath, {\n            error: (input: Error) => {\n                telemetry.log(LogLevel.Error, `Couldn't read definition file [${moduleBinder.definitionPath}]`, { exception: input });\n            }\n        });\n        if (!definitionFile || isEmptyOrNullObject(definitionFile)) {\n            const definitionError = {\n                error: `problem found with definition file [${moduleBinder.definitionPath}] for module [${moduleBinder.name}]`\n            };\n            globallyFailedModules.push(definitionError);\n            return definitionError;\n        }\n\n        return parseModuleDefinition(definitionFile, moduleBinder.definitionPath, telemetry);\n    }\n\n    return getOriginalModuleDefs(moduleBinder.name);\n};\n\nconst getAllModuleDefinitions = async (modules: IModuleBinder[], telemetry: IInternalTelemetry): Promise<object[]> => {\n    telemetry.trackEvent(EVENT_DAPI_GETALLMODULES_START);\n    let definitions = await Promise.all(\n        modules.map(async (moduleBinder: IModuleBinder) => {\n            if (isDAPIOptimizationDisabled()) {\n                const definition = await getModuleDefinition(moduleBinder, telemetry);\n                const dataJson = await getDataJsonAndParse(moduleBinder, telemetry);\n                !isEmptyOrNullObject(dataJson) && (definition['data'] = dataJson);\n                return definition;\n            }\n\n            return getModuleDefinition(moduleBinder, telemetry);\n        })\n    );\n\n    // filter out any deprecated modules, if its an SSK 2.0 app\n    if (isSSK2App() && definitions) {\n        definitions = definitions.filter(item => item && !(item['attributes'] && item['attributes']['deprecate']));\n    }\n\n    telemetry.trackEvent(EVENT_DAPI_GETALLMODULES_STOP);\n    return definitions;\n};\n\n/**\n * Adds any default properties the module config should have\n * to the dapi response\n *\n * @param result List of modules\n */\nconst addDefaultModuleConfigProperties = (defJson: any) => {\n    const type = defJson.type || defJson.$type;\n    if (defJson && (type === 'contentModule' || type === 'containerModule' || type === 'pageModule' || type === 'definitionExtension')) {\n        // Every module should have a class name property added if missing from the definition json\n        if (!defJson.config) {\n            defJson.config = {};\n        }\n        if (!defJson.config.className) {\n            defJson.config.className = classNameDefnProperty;\n        } else {\n            // if className is defined ensure type is set to 'css'\n            defJson.config.className.type = 'css';\n        }\n    }\n};\n\n/**\n * Get theme definition extensions\n * @param themeModuleName name of the theme module\n * @param themeModuleBinder theme module binder object\n */\nconst getThemeDefinitionExtensions = async (themeModuleName: string, themeModuleBinder: IModuleBinder): Promise<any> => {\n    let themeDefinitionExtensions = {};\n\n    // In case of extended theme module, read parent theme definiton extensions first\n    if (themeModuleBinder.parentDefinitionPath) {\n        const parentThemeName = getModuleName(themeModuleBinder.parentDefinitionPath);\n        const parentThemeBinder = getModuleBinder(parentThemeName);\n        parentThemeBinder.definitionExtensions = parentThemeBinder.definitionExtensions || [];\n        for (const moduleName of parentThemeBinder.definitionExtensions) {\n            const pathToDefinition = path.join(\n                parentThemeBinder.moduleDirectory,\n                THEME_MODULE.DEF_EXTENSIONS,\n                `${moduleName}${THEME_MODULE.DEF_EXT_FILE}`\n            );\n\n            const defExtensionJson = (await safeReadJson(pathToDefinition)) || {};\n            addDefaultModuleConfigProperties(defExtensionJson);\n            themeDefinitionExtensions[moduleName] = await resolveRef(defExtensionJson, pathToDefinition);\n        }\n    }\n\n    // Read theme module definition extensions\n    themeModuleBinder.definitionExtensions = themeModuleBinder.definitionExtensions || [];\n    for (const moduleName of themeModuleBinder.definitionExtensions) {\n        const pathToDefinition = path.join(\n            themeModuleBinder.moduleDirectory,\n            THEME_MODULE.DEF_EXTENSIONS,\n            `${moduleName}${THEME_MODULE.DEF_EXT_FILE}`\n        );\n\n        const defExtensionJson = (await safeReadJson(pathToDefinition)) || {};\n        addDefaultModuleConfigProperties(defExtensionJson);\n        themeDefinitionExtensions[moduleName] = await resolveRef(defExtensionJson, pathToDefinition);\n    }\n\n    // Read partner level definition extensions\n    const partnerDefinitionExtensions =\n        (await safeGetAllFilesPath(\n            path.join(keystonePaths.KEYSTONE_THEMES_DIR, themeModuleName, THEME_MODULE.DEF_EXTENSIONS, `*${THEME_MODULE.DEF_EXT_FILE}`)\n        )) || [];\n    for (const pathToDefExt of partnerDefinitionExtensions) {\n        // Check if partner has definition extension override for this theme and merge\n        if (await safeFileExists(pathToDefExt)) {\n            const partnerDefExtensionJson = (await safeReadJson(pathToDefExt)) || {};\n            const moduleName = path.basename(pathToDefExt, THEME_MODULE.DEF_EXT_FILE);\n            themeDefinitionExtensions[moduleName] = _merge(themeDefinitionExtensions[moduleName], partnerDefExtensionJson);\n        }\n    }\n\n    // Check and remove config properties present from config of theme definition extension, if duplicate property exists in dependncies of definition extension\n    themeDefinitionExtensions = filterConfigProperties(themeDefinitionExtensions);\n    return themeDefinitionExtensions;\n};\n\n/**\n * Filters config properties present from config of Definition extension, if same property exists in dependncies of definition extension\n * @param themeDefinitionExtensions Final response of theme definition extension\n */\nconst filterConfigProperties = themeDefinitionExtensions => {\n    const properties = Object.keys(themeDefinitionExtensions);\n    if (properties.length > 0) {\n        for (let i = 0; i < properties.length; i++) {\n            const DefinitionExtension = themeDefinitionExtensions[properties[i]];\n            const config = DefinitionExtension['config'];\n            if (config && DefinitionExtension['dependencies']) {\n                const dependencies = DefinitionExtension.dependencies.moduleLayout.oneOf;\n                for (let j = 0; j < dependencies.length; j++) {\n                    const extendedproperties = dependencies[j].properties;\n                    for (const propertyKey of Object.keys(extendedproperties)) {\n                        if (config[propertyKey]) {\n                            delete config[propertyKey];\n                        }\n                    }\n                }\n            }\n        }\n    }\n    return themeDefinitionExtensions;\n};\n\n/**\n * Get default theme style presets definition extensions\n * @param themeModuleName name of the theme module\n * @param themeModuleBinder theme module binder object\n */\nconst getDefaultThemeStylePreset = async (themeModuleName: string, themeModuleBinder: IModuleBinder): Promise<any> => {\n    const pathToThemeStylesDefinition = path.join(\n        themeModuleBinder.moduleDirectory,\n        THEME_MODULE.STYLES,\n        `${themeModuleName}${THEME_MODULE.STYLE_PRESET_DEFINITION_FILE}`\n    );\n\n    const themeStylePresets = await resolveRef((await safeReadJson(pathToThemeStylesDefinition)) || {}, pathToThemeStylesDefinition);\n    const pathToPartnerThemeStylePresets = path.join(\n        keystonePaths.KEYSTONE_THEMES_DIR,\n        themeModuleName,\n        THEME_MODULE.STYLES,\n        `${themeModuleName}${THEME_MODULE.STYLE_PRESET_DEFINITION_FILE}`\n    );\n\n    const partnerThemeStylesDefinition = await resolveRef(\n        (await safeReadJson(pathToPartnerThemeStylePresets)) || {},\n        pathToPartnerThemeStylePresets\n    );\n    return _merge(themeStylePresets, partnerThemeStylesDefinition);\n};\n\n/**\n * Get additional theme style presets extensions\n * @param themeModuleName name of the theme module\n * @param themeModuleBinder theme module binder object\n */\nconst getThemeStylePresetInstances = async (themeModuleName: string, themeModuleBinder: IModuleBinder): Promise<any> => {\n    const mergedFiles = {};\n    const keystoneThemeFilePath = path.join(keystonePaths.KEYSTONE_THEMES_DIR, themeModuleName, THEME_MODULE.STYLES);\n\n    const getThemeFilePaths = (\n        await safeGetAllFilesPath(\n            path.join(themeModuleBinder.moduleDirectory, THEME_MODULE.STYLES, `/*${THEME_MODULE.STYLE_PRESET_INSTANCE_FILE}`)\n        )\n    ).filter(p => !p.endsWith(THEME_MODULE.STYLE_PRESET_DEFINITION_FILE));\n\n    const getKeystoneFilePaths = safeGetAllFilesPathSync(\n        path.join(keystoneThemeFilePath, `/*${THEME_MODULE.STYLE_PRESET_INSTANCE_FILE}`)\n    ).filter(p => !p.endsWith(THEME_MODULE.STYLE_PRESET_DEFINITION_FILE));\n\n    Array.prototype.push.apply(getThemeFilePaths, getKeystoneFilePaths);\n\n    if (getThemeFilePaths.length > 0) {\n        for (let i = 0; i < getThemeFilePaths.length; i++) {\n            const stylePresetName = path.basename(getThemeFilePaths[i], '.scss.json');\n            const additionalThemeStylePresets = (await safeReadJson(getThemeFilePaths[i])) || {};\n\n            mergedFiles[stylePresetName] = _merge(mergedFiles[stylePresetName], additionalThemeStylePresets);\n        }\n    }\n\n    return mergedFiles;\n};\n\nconst getDataJsonPath = (definitionPath: string, isNodeModule: boolean): string => {\n    const filePath = (isNodeModule ? definitionPath : definitionPath.replace('src/modules', 'build/definitions')).replace(\n        '.definition.json',\n        '.data.json'\n    );\n    return path.resolve(filePath);\n};\n\nexport const getDataJsonAndParse = async (moduleBinder: IModuleBinder, telemetry: IInternalTelemetry) => {\n    let dataJsonPathFromDefinitionPath = getDataJsonPath(moduleBinder.definitionPath, moduleBinder.isNodeModule);\n    let dataJsonFileExists = await safeFileExists(dataJsonPathFromDefinitionPath);\n\n    // Look for parent data definition file - in case of $ref module\n    if (!dataJsonFileExists && moduleBinder.parentDefinitionPath) {\n        dataJsonPathFromDefinitionPath = getDataJsonPath(moduleBinder.parentDefinitionPath, moduleBinder.isNodeModule);\n        dataJsonFileExists = await safeFileExists(dataJsonPathFromDefinitionPath);\n    }\n\n    if (!dataJsonFileExists) {\n        return {};\n    }\n\n    const dataJsonFile = await safeReadJson<object>(dataJsonPathFromDefinitionPath, {\n        error: (input: Error) => {\n            telemetry.log(LogLevel.Error, `Couldn't read data json file [${dataJsonPathFromDefinitionPath}]`, { exception: input });\n        }\n    });\n\n    const dataJson = dataJsonFile && dataJsonFile['properties'];\n    if (!dataJson) {\n        return {};\n    }\n\n    Object.keys(dataJson).forEach(eachDataTypePropertyKey => {\n        const eachDataTypeProperty = dataJson[eachDataTypePropertyKey];\n\n        if (eachDataTypeProperty.filterFromDAPI) {\n            delete dataJson[eachDataTypePropertyKey];\n        }\n    });\n\n    renameKeyInObject(dataJson, '$ref', 'type', 3);\n    return dataJson;\n};\n\nexport const getModuleDefinitionApiFile = async (\n    modules: IModuleBinder[],\n    telemetry: IInternalTelemetry\n): Promise<object[] | undefined> => {\n    if (process.env.NODE_ENV === 'production') {\n        const moduleDefinitionApiFileExists = await safeFileExists(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH, {\n            debug: input => {\n                telemetry.log(LogLevel.Debug, input);\n            },\n            error: input => {\n                telemetry.log(LogLevel.Error, input);\n            }\n        });\n        if (moduleDefinitionApiFileExists) {\n            return safeReadJson<object[]>(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH, {\n                error: (input: Error) => {\n                    telemetry.log(LogLevel.Error, `Couldn't read definition api file [${keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH}]`, {\n                        exception: input\n                    });\n                }\n            });\n        }\n\n        const definitions = await getAllModuleDefinitions(modules, telemetry);\n        if (definitions && definitions.length > 0) {\n            await safeWriteJson(keystonePaths.KEYSTONE_APP_DEFINITION_FILEPATH, definitions);\n        }\n        return definitions;\n    }\n\n    return getAllModuleDefinitions(modules, telemetry);\n};\n\n/**\n * route to return definition JSON\n * [/dapi/modules] - return all modules defintion\n * [/dapi/modules?type=<moduleType>] - return specific module type defintion\n * @param moduleType\n * @param telemetry\n */\nexport async function getModuleDefinitions(moduleType: string, telemetry: IInternalTelemetry): Promise<string | object[]> {\n    if (moduleType && !(<any>msdyn365Commerce).moduleBinder(moduleType)) {\n        return JSON.stringify({ error: `type [${moduleType}] not defined` });\n    }\n\n    const result = isDAPIOptimizationDisabled()\n        ? await getModuleDefinitionApiFile((<any>msdyn365Commerce).getAllModuleBinder(), telemetry)\n        : await getAllModuleDefinitions((<any>msdyn365Commerce).getAllModuleBinder(), telemetry);\n\n    if (!result) {\n        const message = `DefinitionAPI: There is no information in the result.`;\n        telemetry.trackMetric(METRIC_DAPI_NO_RESULT, 1);\n        return message;\n    }\n\n    // Add default module config properties to DAPI response\n    for (let i = 0; i < result.length; i++) {\n        addDefaultModuleConfigProperties(result[i]);\n    }\n\n    if (moduleType && result.length > 0) {\n        const defN = result\n            .map((definition: any) => definition && definition.name && definition.name === moduleType && definition)\n            .filter(Boolean);\n        if (defN && defN.length > 0) {\n            return defN;\n        } else {\n            return `{ error: 'type not found [${moduleType}]'}`;\n        }\n    }\n    return result;\n}\n\n/**\n * route to return definition JSON\n * [/dapi/themes] - return all modules defintion\n * [/dapi/themes?type=<moduleType>] - return specific module type defintion\n * @param moduleType\n * @param telemetry\n */\nconst getAllThemeModules = async (telemetry: IInternalTelemetry): Promise<IThemeModule[]> => {\n    const themeModules = msdyn365Commerce.themeModules || [];\n    if (themeModules.length) {\n        return themeModules;\n    }\n\n    const allModulesBinder = await (<any>msdyn365Commerce).getAllModuleBinder();\n    if (Array.isArray(allModulesBinder)) {\n        const allThemeModulesBinder = <IModuleBinder[]>allModulesBinder.filter(def => (<IModuleBinder>def).$type === THEME_MODULE.TYPE);\n        await Promise.all(\n            allThemeModulesBinder.map(async (themeModuleBinder: IModuleBinder) => {\n                const themeModule = await getModuleDefinition(themeModuleBinder, telemetry);\n                themeModule.pages = await getThemePages(themeModuleBinder);\n                themeModule.segments = await getThemeSegments(themeModuleBinder);\n\n                themeModule.definitionExtensions = await getThemeDefinitionExtensions(themeModule.name, themeModuleBinder);\n\n                const themeStylePresets = await getDefaultThemeStylePreset(themeModule.name, themeModuleBinder);\n                themeModule.styles = {\n                    definition: themeStylePresets,\n                    presets:\n                        Object.entries(themeStylePresets).length !== 0\n                            ? await getThemeStylePresetInstances(themeModule.name, themeModuleBinder)\n                            : {}\n                };\n\n                themeModules.push(themeModule);\n            })\n        );\n    }\n\n    msdyn365Commerce.setThemeModules(themeModules);\n    return themeModules;\n};\n\n/**\n * Gets the pages in the given theme module\n * @param themeModuleBinder binder for the theme module object\n */\nconst getThemePages = async (themeModuleBinder: IModuleBinder) => {\n    const pageNames = Object.keys(themeModuleBinder.pages || {});\n    const themePages = {};\n    for (const pageName of pageNames) {\n        const layouts = themeModuleBinder.pages![pageName] || [];\n        for (const layout of layouts) {\n            const pathToPageLayout = path.join(\n                themeModuleBinder.moduleDirectory,\n                THEME_MODULE.LAYOUTS,\n                THEME_MODULE.PAGES,\n                pageName,\n                `${layout}${THEME_MODULE.PAGE_FILE}`\n            );\n            const pageLayoutJson = (await safeReadJson(pathToPageLayout)) || {};\n            themePages[pageName] = themePages[pageName] || {};\n            themePages[pageName][layout] = await resolveRef(pageLayoutJson, pathToPageLayout);\n        }\n    }\n\n    return themePages;\n};\n\n/**\n * Gets the segments in the given theme module\n * @param themeModuleBinder binder for the theme module object\n */\nconst getThemeSegments = async (themeModuleBinder: IModuleBinder) => {\n    const segments = {};\n    themeModuleBinder.segments = themeModuleBinder.segments || [];\n    for (const segment of themeModuleBinder.segments) {\n        const pathToSegment = path.join(\n            themeModuleBinder.moduleDirectory,\n            THEME_MODULE.LAYOUTS,\n            THEME_MODULE.SEGMENTS,\n            `${segment}${THEME_MODULE.SEGMENT_FILE}`\n        );\n        const segmentJson = (await safeReadJson(pathToSegment)) || {};\n        segments[segment] = await resolveRef(segmentJson, pathToSegment);\n    }\n\n    return segments;\n};\n\n/**\n * Method to return the full theme module object with layouts and segments\n * @param moduleName theme module name to be filtered\n * @param telemetry\n */\nexport const getThemeModules = async (moduleName: string | null, telemetry: IInternalTelemetry): Promise<string | IThemeModule[]> => {\n    if (moduleName && !(<any>msdyn365Commerce).moduleBinder(moduleName)) {\n        return JSON.stringify({ error: `theme module [${moduleName}] not found` });\n    }\n\n    const bindings = (<IMSDyn365CommerceExtension>(<unknown>msdyn365Commerce)).bindings;\n    const themeModules: IThemeModule[] = isDAPIOptimizationDisabled() ? await getAllThemeModules(telemetry) : bindings.dapi.themes || [];\n    if (moduleName && themeModules.length > 0) {\n        const defN = themeModules\n            .map((definition: any) => definition && definition.name && definition.name === moduleName && definition)\n            .filter(Boolean);\n        if (defN && defN.length > 0) {\n            return defN;\n        } else {\n            return `{ error: 'type not found [${moduleName}]'}`;\n        }\n    }\n\n    return Promise.resolve(themeModules);\n};\n\n/**\n * Method to return list of theme modules names\n * @param telemetry\n */\nexport const getThemeModulesList = async (telemetry: IInternalTelemetry) => {\n    const themeModulesList = await getThemeModules(null, telemetry);\n    return Array.isArray(themeModulesList) ? themeModulesList.map(themeModule => themeModule.name) : [];\n};\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}