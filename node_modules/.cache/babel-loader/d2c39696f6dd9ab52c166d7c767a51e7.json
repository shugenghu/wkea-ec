{"ast":null,"code":"import _slicedToArray from\"@babel/runtime/helpers/esm/slicedToArray\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _merge from\"lodash/merge\";function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol===\"undefined\"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e){throw _e;},f:F};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]();},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e2){didErr=true;err=_e2;},f:function f(){try{if(!normalCompletion&&it[\"return\"]!=null)it[\"return\"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{AppCache}from'@msdyn365-commerce/cache-internal';import{MSDyn365Commerce,msdyn365Commerce}from'@msdyn365-commerce/core-internal';import{safeFileExists,safeFileExistsSync,safeReadJson}from'@msdyn365-commerce/utilities-internal';import axios from'axios';import{useStaticRendering}from'mobx-react';import{dirname,join,resolve}from'path';import{isDAPIOptimizationDisabled}from'../_server/Definition/moduleDefinition';import{HttpsRequestInterceptor}from'../_server/inteceptors/https-agent-inteceptor';import keystonePaths from'../paths';import{ResourceManager}from'../resources/resource-manager';import sdkAppSettings from'../settings/app.settings.json';import{getModuleName}from'../utils/helpers';import{getAppSecretsCacheSetings,getCacheSettings,getExperimentsCacheSettings,getPlatformSettingsSync}from'../utils/platform-utils';import{SecretManager}from'../utils/secret-manager';import{initializeApp}from'./initialization';import{createComponent}from'./render-component';var APP_SETTINGS='app.settings';var IMAGE_SETTINGS='image.settings';var THEME_SETTINGS='theme.settings';var ROOT_SITE='__root_site__';var CONNECTOR_SETTINGS='connector.settings';var PLATFORM_SETTINGS='platform.settings';/**\r\n * @function {getAppSettings}   - Method to return merged object of both sdk and partner app settings\r\n */var getAppSettings=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(bindings){var appSettings,partnerAppSettings,themeModules;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:appSettings={app:{config:{},routes:{}},msdyn365:{config:sdkAppSettings.config,contentSecurityPolicy:sdkAppSettings.contentSecurityPolicy}};_context.next=3;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR,\"\".concat(APP_SETTINGS,\".json\")));case 3:partnerAppSettings=_context.sent;if(partnerAppSettings){appSettings.app=partnerAppSettings;}if(sdkAppSettings.routes){appSettings.app.routes=_merge({},sdkAppSettings.routes,appSettings.app.routes||{});}if(msdyn365Commerce.themes&&msdyn365Commerce.themes.themes){appSettings.app.themes=_merge({},msdyn365Commerce.themes.themes,appSettings.app.themes||{});}// Add friendly name to theme where applicable\nthemeModules=isDAPIOptimizationDisabled()?msdyn365Commerce.themeModules:bindings.dapi.themes;themeModules.forEach(function(themeModule){if(appSettings.app.themes&&appSettings.app.themes[themeModule.name]&&!appSettings.app.themes[themeModule.name].friendlyName){appSettings.app.themes[themeModule.name].friendlyName=themeModule.friendlyName;}});return _context.abrupt(\"return\",appSettings);case 10:case\"end\":return _context.stop();}}},_callee);}));return function getAppSettings(_x){return _ref.apply(this,arguments);};}();/**\r\n * @function {getImageSettings}   - Method to return merged object of both sdk and partner image settings\r\n */var getImageSettings=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR,\"\".concat(IMAGE_SETTINGS,\".json\")));case 2:_context2.t0=_context2.sent;if(_context2.t0){_context2.next=5;break;}_context2.t0={};case 5:return _context2.abrupt(\"return\",_context2.t0);case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function getImageSettings(){return _ref2.apply(this,arguments);};}();/**\r\n * @function {getThemeSettings}   - Method to return partner theme settings\r\n */var getThemeSettings=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(platformSettings){var themeSettings,partnerThemeSettings,generatedThemeSettings,allModulesBinder,themeModules;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:themeSettings={};// theme settings defined prior to serviceability\n_context4.next=3;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR,\"\".concat(THEME_SETTINGS,\".json\")));case 3:_context4.t0=_context4.sent;if(_context4.t0){_context4.next=6;break;}_context4.t0={};case 6:partnerThemeSettings=_context4.t0;if(isDAPIOptimizationDisabled(platformSettings)){_context4.next=12;break;}_context4.next=10;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DAPI_FILEPATH));case 10:generatedThemeSettings=_context4.sent;return _context4.abrupt(\"return\",_objectSpread({\"default\":partnerThemeSettings},generatedThemeSettings));case 12:_context4.next=14;return msdyn365Commerce.getAllModuleBinder();case 14:_context4.t1=_context4.sent;if(_context4.t1){_context4.next=17;break;}_context4.t1=[];case 17:allModulesBinder=_context4.t1;themeModules=allModulesBinder.filter(function(def){return def.$type==='themeModule';});_context4.next=21;return Promise.all(themeModules.map(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(themeModule){var settings,parentModuleName,parentSettingsPath,overrideSettings,overrideSettingsFile;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:settings={};if(!themeModule.themeSettings){_context3.next=8;break;}_context3.next=4;return safeReadJson(resolve(themeModule.moduleDirectory,themeModule.themeSettings));case 4:_context3.t0=_context3.sent;if(_context3.t0){_context3.next=7;break;}_context3.t0={};case 7:settings=_context3.t0;case 8:if(!themeModule.parentDefinitionPath){_context3.next=23;break;}parentModuleName=getModuleName(themeModule.parentDefinitionPath);parentSettingsPath=join(dirname(themeModule.parentDefinitionPath),\"\".concat(parentModuleName,\".theme.settings.json\"/* SETTINGS_FILE */));_context3.next=13;return safeFileExists(parentSettingsPath);case 13:if(!_context3.sent){_context3.next=23;break;}_context3.t1=_merge;_context3.t2=settings;_context3.next=18;return safeReadJson(parentSettingsPath);case 18:_context3.t3=_context3.sent;if(_context3.t3){_context3.next=21;break;}_context3.t3={};case 21:_context3.t4=_context3.t3;settings=(0,_context3.t1)(_context3.t2,_context3.t4);case 23:overrideSettings={};overrideSettingsFile=resolve(keystonePaths.KEYSTONE_THEMES_DIR,themeModule.name,\"\".concat(themeModule.name,\".theme.settings.json\"/* SETTINGS_FILE */));_context3.next=27;return safeFileExists(overrideSettingsFile);case 27:if(!_context3.sent){_context3.next=34;break;}_context3.next=30;return safeReadJson(overrideSettingsFile);case 30:_context3.t5=_context3.sent;if(_context3.t5){_context3.next=33;break;}_context3.t5={};case 33:overrideSettings=_context3.t5;case 34:themeSettings[themeModule.name]=_merge(settings,overrideSettings);case 35:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref4.apply(this,arguments);};}()));case 21:return _context4.abrupt(\"return\",_objectSpread({\"default\":partnerThemeSettings},themeSettings));case 22:case\"end\":return _context4.stop();}}},_callee4);}));return function getThemeSettings(_x2){return _ref3.apply(this,arguments);};}();var getPlatformSettings=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var platFormSettings;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR,\"\".concat(PLATFORM_SETTINGS,\".json\")));case 2:platFormSettings=_context5.sent;return _context5.abrupt(\"return\",platFormSettings?platFormSettings:{});case 4:case\"end\":return _context5.stop();}}},_callee5);}));return function getPlatformSettings(){return _ref5.apply(this,arguments);};}();var getExperimentationCache=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){var connectorCacheSettings,cacheSetting;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:connectorCacheSettings=getExperimentsCacheSettings();cacheSetting=getCacheSettings();cacheSetting=_merge(cacheSetting,connectorCacheSettings);return _context6.abrupt(\"return\",new AppCache(cacheSetting));case 4:case\"end\":return _context6.stop();}}},_callee6);}));return function getExperimentationCache(){return _ref6.apply(this,arguments);};}();/**\r\n * Creates and returns a refernce to the app cache used to store\r\n * RS access token and any C1 secrets\r\n */var createAppSecretsCache=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var cacheSettings;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:cacheSettings=getAppSecretsCacheSetings();return _context7.abrupt(\"return\",new AppCache(cacheSettings));case 2:case\"end\":return _context7.stop();}}},_callee7);}));return function createAppSecretsCache(){return _ref7.apply(this,arguments);};}();/**\r\n * During local development, we capture the secrets file stored locally\r\n * to read necessary secret values\r\n */var getLocalSecretsFile=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){var localSecrets;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(!safeFileExistsSync(resolve(keystonePaths.KEYSTONE_SECRETS_DIR,\"secrets.json\"))){_context8.next=4;break;}_context8.next=3;return safeReadJson(resolve(keystonePaths.KEYSTONE_SECRETS_DIR,\"secrets.json\"));case 3:localSecrets=_context8.sent;case 4:return _context8.abrupt(\"return\",localSecrets);case 5:case\"end\":return _context8.stop();}}},_callee8);}));return function getLocalSecretsFile(){return _ref8.apply(this,arguments);};}();/**\r\n * During local development, read and store the credentials json file to mock user signed in behavior\r\n */var getLocalCredentialsFile=/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(){var localCreds;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(!safeFileExistsSync(resolve(keystonePaths.KEYSTONE_SECRETS_DIR,\"credentials.json\"))){_context9.next=4;break;}_context9.next=3;return safeReadJson(resolve(keystonePaths.KEYSTONE_SECRETS_DIR,\"credentials.json\"));case 3:localCreds=_context9.sent;case 4:return _context9.abrupt(\"return\",localCreds);case 5:case\"end\":return _context9.stop();}}},_callee9);}));return function getLocalCredentialsFile(){return _ref9.apply(this,arguments);};}();var getExperimentaionConnector=/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(secretManager){var connectorSettings,_msdyn365Commerce$get,connectorSettingsForExperimentation,experimentationProvider,experimentReady;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.next=2;return safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR,\"\".concat(CONNECTOR_SETTINGS,\".json\")));case 2:connectorSettings=_context10.sent;if(!(connectorSettings&&connectorSettings.experimentation)){_context10.next=23;break;}connectorSettingsForExperimentation=connectorSettings.experimentation;experimentationProvider=// @ts-ignore - Compiler indicates that types of IMSDyn365CommerceExtension and MSDyn365Commerce do not overlap\n// but typeof IMSDyn365CommerceWithPrototype = typeof MSDyn365Commerce & IPrototype\n// See initialization.ts for an explanation of why we use prototype in conjunction with IMSDyn365CommerceWithPrototype\n(_msdyn365Commerce$get=msdyn365Commerce.getConnector(connectorSettingsForExperimentation.name))===null||_msdyn365Commerce$get===void 0?void 0:_msdyn365Commerce$get.provider;if(!experimentationProvider){_context10.next=21;break;}_context10.prev=7;_context10.next=10;return experimentationProvider.initialize(connectorSettingsForExperimentation.config,secretManager);case 10:experimentReady=_context10.sent;if(experimentReady){_context10.next=14;break;}console.error(\"experimentation connector registered with name \".concat(connectorSettingsForExperimentation.name,\" not initialized successfully\"));return _context10.abrupt(\"return\",undefined);case 14:_context10.next=20;break;case 16:_context10.prev=16;_context10.t0=_context10[\"catch\"](7);console.error(\"experimentation connector registered error \".concat(_context10.t0,\" with name \").concat(connectorSettingsForExperimentation.name));return _context10.abrupt(\"return\",undefined);case 20:return _context10.abrupt(\"return\",{name:connectorSettingsForExperimentation.name,provider:experimentationProvider});case 21:console.error(\"No experimentation connector registered with name \".concat(connectorSettingsForExperimentation.name));return _context10.abrupt(\"return\",undefined);case 23:return _context10.abrupt(\"return\",undefined);case 24:case\"end\":return _context10.stop();}}},_callee10,null,[[7,16]]);}));return function getExperimentaionConnector(_x4){return _ref10.apply(this,arguments);};}();var getDAPIBindings=/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(){return _regeneratorRuntime.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return safeReadJson(keystonePaths.KEYSTONE_APP_DAPI_FILEPATH);case 2:_context11.t0=_context11.sent;if(_context11.t0){_context11.next=5;break;}_context11.t0={};case 5:_context11.t1=_context11.t0;_context11.next=8;return safeReadJson(keystonePaths.KEYSTONE_APP_THEMES_DAPI_FILEPATH);case 8:_context11.t2=_context11.sent;if(_context11.t2){_context11.next=11;break;}_context11.t2=[];case 11:_context11.t3=_context11.t2;return _context11.abrupt(\"return\",{modules:_context11.t1,themes:_context11.t3});case 13:case\"end\":return _context11.stop();}}},_callee11);}));return function getDAPIBindings(){return _ref11.apply(this,arguments);};}();/**\r\n * @function {getAppCacheForRootSite} - Method to return app cache instance for root site\r\n */var getAppCacheForRootSite=function getAppCacheForRootSite(){var appCacheDictionary={};appCacheDictionary[ROOT_SITE]=new AppCache(getCacheSettings());return appCacheDictionary;};var removeExcludedModues=function removeExcludedModues(bindings){// remove excluded modules from binding\nvar platformSettings=getPlatformSettingsSync();var excludedModules=platformSettings.excludedModules;if(excludedModules&&excludedModules.length>0){var _iterator=_createForOfIteratorHelper(excludedModules),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var moduleName=_step.value;delete bindings.modules[\"\".concat(moduleName)];}}catch(err){_iterator.e(err);}finally{_iterator.f();}}};// tslint:disable:no-invalid-this\nexport var initializeServerApp=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(bindings){var packageVersion,appSecretsCache,platformSettings,localAppSecrets,localCredentials,secretManager,appSettingsPromise,imageSettingsPromise,themeSettingsPromise,experimentationConnectorPromise,experimentationCachePromise,_yield$Promise$all,_yield$Promise$all2,appSettings,imageSettings,themeSettings,experimentationConnector,experimentationCache,resourceManager;return _regeneratorRuntime.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.next=2;return getDAPIBindings();case 2:bindings.dapi=_context12.sent;removeExcludedModues(bindings);initializeApp(bindings);useStaticRendering(true);axios.interceptors.request.use(HttpsRequestInterceptor);_context12.next=9;return safeReadJson(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);case 9:packageVersion=_context12.sent;_context12.next=12;return createAppSecretsCache();case 12:appSecretsCache=_context12.sent;_context12.next=15;return getPlatformSettings();case 15:platformSettings=_context12.sent;if(!(process.env.NODE_ENV==='development')){_context12.next=23;break;}_context12.next=19;return getLocalSecretsFile();case 19:localAppSecrets=_context12.sent;_context12.next=22;return getLocalCredentialsFile();case 22:localCredentials=_context12.sent;case 23:secretManager=new SecretManager(appSecretsCache,localAppSecrets);appSettingsPromise=getAppSettings(bindings);imageSettingsPromise=getImageSettings();themeSettingsPromise=getThemeSettings(platformSettings);experimentationConnectorPromise=getExperimentaionConnector(secretManager);experimentationCachePromise=getExperimentationCache();_context12.next=31;return Promise.all([appSettingsPromise,imageSettingsPromise,themeSettingsPromise,experimentationConnectorPromise,experimentationCachePromise]);case 31:_yield$Promise$all=_context12.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,5);appSettings=_yield$Promise$all2[0];imageSettings=_yield$Promise$all2[1];themeSettings=_yield$Promise$all2[2];experimentationConnector=_yield$Promise$all2[3];experimentationCache=_yield$Promise$all2[4];resourceManager=new ResourceManager();_context12.next=41;return resourceManager.init(platformSettings);case 41:MSDyn365Commerce.prototype.updatePrivateVariable=function(){// @ts-ignore\nthis._buildVersion=packageVersion&&packageVersion.buildVersion;// @ts-ignore\nthis._resourceManager=resourceManager;// @ts-ignore\nthis._appSettings=appSettings;// @ts-ignore\nthis._imageSettings=imageSettings;// @ts-ignore\nthis._themeSettings=themeSettings;// @ts-ignore\nthis.createComponent=createComponent;// @ts-ignore\nthis._experimentationCache=experimentationCache;// @ts-ignore\nthis._secretManager=secretManager;// @ts-ignore\nthis._experimentationConnector=experimentationConnector;// @ts-ignore\nthis._platformSettings=platformSettings;// @ts-ignore\nthis._localCredentials=localCredentials;};MSDyn365Commerce.prototype.appCache=getAppCacheForRootSite();MSDyn365Commerce.prototype.getAppCache=function(requestContext){if(!requestContext||!requestContext.apiSettings){return this.appCache[ROOT_SITE];}var appCacheKey=\"\".concat(requestContext.apiSettings.baseUrl,\"-\").concat(requestContext.apiSettings.channelId);if(!this.appCache[appCacheKey]){this.appCache[appCacheKey]=new AppCache(getCacheSettings());}var appCache=this.appCache[appCacheKey];appCache.setRequestContext(requestContext);return appCache;};msdyn365Commerce.updatePrivateVariable();case 45:case\"end\":return _context12.stop();}}},_callee12);}));return function initializeServerApp(_x5){return _ref12.apply(this,arguments);};}();","map":{"version":3,"sources":["../../../src/app-initialization/server-initialization.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { AppCache, ICache, ICacheSettings } from '@msdyn365-commerce/cache-internal';\nimport {\n    IAny,\n    IAppSettings,\n    IConnectorSettings,\n    IDictionary,\n    IExperimentationConnector,\n    IExperimentationProvider,\n    IGeneric,\n    ILocalCredentials,\n    IPartnerImageSettings,\n    IPlatformSettings,\n    IRequestContext,\n    ISecretManager,\n    IThemeModule,\n    MSDyn365Commerce,\n    msdyn365Commerce\n} from '@msdyn365-commerce/core-internal';\nimport { safeFileExists, safeFileExistsSync, safeReadJson } from '@msdyn365-commerce/utilities-internal';\nimport axios from 'axios';\nimport { merge } from 'lodash';\nimport { useStaticRendering } from 'mobx-react';\nimport { dirname, join, resolve } from 'path';\nimport { isDAPIOptimizationDisabled, THEME_MODULE } from '../_server/Definition/moduleDefinition';\nimport { HttpsRequestInterceptor } from '../_server/inteceptors/https-agent-inteceptor';\nimport keystonePaths from '../paths';\nimport { ResourceManager } from '../resources/resource-manager';\nimport sdkAppSettings from '../settings/app.settings.json';\nimport { getModuleName } from '../utils/helpers';\nimport { getAppSecretsCacheSetings, getCacheSettings, getExperimentsCacheSettings, getPlatformSettingsSync } from '../utils/platform-utils';\nimport { SecretManager } from '../utils/secret-manager';\nimport { initializeApp } from './initialization';\nimport { IBinding, IModuleBinder, IModuleDefinition, IMSDyn365CommerceExtension, IMSDyn365CommerceWithPrototype } from './models';\nimport { createComponent } from './render-component';\n\nconst APP_SETTINGS = 'app.settings';\nconst IMAGE_SETTINGS = 'image.settings';\nconst THEME_SETTINGS = 'theme.settings';\nconst ROOT_SITE = '__root_site__';\nconst CONNECTOR_SETTINGS = 'connector.settings';\nconst PLATFORM_SETTINGS = 'platform.settings';\n\n/**\n * @function {getAppSettings}   - Method to return merged object of both sdk and partner app settings\n */\nconst getAppSettings = async (bindings: IBinding) => {\n    const appSettings = {\n        app: <IAppSettings>{ config: {}, routes: {} },\n        msdyn365: { config: sdkAppSettings.config, contentSecurityPolicy: sdkAppSettings.contentSecurityPolicy }\n    };\n\n    const partnerAppSettings = <IAppSettings>await safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR, `${APP_SETTINGS}.json`));\n\n    if (partnerAppSettings) {\n        appSettings.app = partnerAppSettings;\n    }\n\n    if (sdkAppSettings.routes) {\n        appSettings.app.routes = merge({}, sdkAppSettings.routes, appSettings.app.routes || {});\n    }\n\n    if (msdyn365Commerce.themes && msdyn365Commerce.themes.themes) {\n        appSettings.app.themes = merge({}, msdyn365Commerce.themes.themes, appSettings.app.themes || {});\n    }\n\n    // Add friendly name to theme where applicable\n    const themeModules = isDAPIOptimizationDisabled() ? msdyn365Commerce.themeModules : bindings.dapi.themes;\n    themeModules.forEach((themeModule: IThemeModule) => {\n        if (appSettings.app.themes && appSettings.app.themes[themeModule.name] && !appSettings.app.themes[themeModule.name].friendlyName) {\n            appSettings.app.themes[themeModule.name].friendlyName = themeModule.friendlyName;\n        }\n    });\n\n    return appSettings;\n};\n\n/**\n * @function {getImageSettings}   - Method to return merged object of both sdk and partner image settings\n */\nconst getImageSettings = async () => {\n    return <IPartnerImageSettings>await safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR, `${IMAGE_SETTINGS}.json`)) || {};\n};\n\n/**\n * @function {getThemeSettings}   - Method to return partner theme settings\n */\nconst getThemeSettings = async (platformSettings: IPlatformSettings) => {\n    const themeSettings = {};\n    // theme settings defined prior to serviceability\n    const partnerThemeSettings =\n        <IPartnerImageSettings>await safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR, `${THEME_SETTINGS}.json`)) || {};\n\n    if (!isDAPIOptimizationDisabled(platformSettings)) {\n        const generatedThemeSettings = await safeReadJson(resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DAPI_FILEPATH));\n        return {\n            default: partnerThemeSettings,\n            ...generatedThemeSettings\n        };\n    }\n\n    const allModulesBinder = (await (<IGeneric<IAny>>msdyn365Commerce).getAllModuleBinder()) || [];\n    const themeModules = <IModuleBinder[]>allModulesBinder.filter(def => (<IModuleBinder>def).$type === 'themeModule');\n    await Promise.all(\n        themeModules.map(async themeModule => {\n            let settings = {};\n            if (themeModule.themeSettings) {\n                settings = (await safeReadJson(resolve(themeModule.moduleDirectory, themeModule.themeSettings))) || {};\n            }\n\n            if (themeModule.parentDefinitionPath) {\n                const parentModuleName = getModuleName(themeModule.parentDefinitionPath);\n                const parentSettingsPath = join(\n                    dirname(themeModule.parentDefinitionPath),\n                    `${parentModuleName}${THEME_MODULE.SETTINGS_FILE}`\n                );\n                if (await safeFileExists(parentSettingsPath)) {\n                    settings = merge(settings, (await safeReadJson(parentSettingsPath)) || {});\n                }\n            }\n\n            let overrideSettings = {};\n            const overrideSettingsFile = resolve(\n                keystonePaths.KEYSTONE_THEMES_DIR,\n                themeModule.name,\n                `${themeModule.name}${THEME_MODULE.SETTINGS_FILE}`\n            );\n            if (await safeFileExists(overrideSettingsFile)) {\n                overrideSettings = (await safeReadJson(overrideSettingsFile)) || {};\n            }\n\n            themeSettings[themeModule.name] = merge(settings, overrideSettings);\n        })\n    );\n\n    return {\n        default: partnerThemeSettings,\n        ...themeSettings\n    };\n};\n\nconst getPlatformSettings = async () => {\n    const platFormSettings = await safeReadJson<IPlatformSettings>(\n        resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR, `${PLATFORM_SETTINGS}.json`)\n    );\n    return platFormSettings ? platFormSettings : {};\n};\n\nconst getExperimentationCache = async (): Promise<ICache> => {\n    const connectorCacheSettings = getExperimentsCacheSettings();\n    let cacheSetting: ICacheSettings = getCacheSettings();\n    cacheSetting = merge(cacheSetting, connectorCacheSettings);\n    return new AppCache(cacheSetting);\n};\n\n/**\n * Creates and returns a refernce to the app cache used to store\n * RS access token and any C1 secrets\n */\nconst createAppSecretsCache = async (): Promise<ICache> => {\n    const cacheSettings = getAppSecretsCacheSetings();\n    return new AppCache(cacheSettings);\n};\n\n/**\n * During local development, we capture the secrets file stored locally\n * to read necessary secret values\n */\nconst getLocalSecretsFile = async (): Promise<IDictionary<string> | undefined> => {\n    let localSecrets: IDictionary<string> | undefined;\n    if (safeFileExistsSync(resolve(keystonePaths.KEYSTONE_SECRETS_DIR, `secrets.json`))) {\n        localSecrets = await safeReadJson<IDictionary<string>>(resolve(keystonePaths.KEYSTONE_SECRETS_DIR, `secrets.json`));\n    }\n    return localSecrets;\n};\n\n/**\n * During local development, read and store the credentials json file to mock user signed in behavior\n */\nconst getLocalCredentialsFile = async (): Promise<IDictionary<ILocalCredentials> | undefined> => {\n    let localCreds: IDictionary<ILocalCredentials> | undefined;\n    if (safeFileExistsSync(resolve(keystonePaths.KEYSTONE_SECRETS_DIR, `credentials.json`))) {\n        localCreds = await safeReadJson<IDictionary<ILocalCredentials>>(resolve(keystonePaths.KEYSTONE_SECRETS_DIR, `credentials.json`));\n    }\n    return localCreds;\n};\n\nconst getExperimentaionConnector = async (secretManager: ISecretManager): Promise<IExperimentationConnector | undefined> => {\n    const connectorSettings = await safeReadJson<IConnectorSettings>(\n        resolve(keystonePaths.KEYSTONE_APP_SETTINGS_DIR, `${CONNECTOR_SETTINGS}.json`)\n    );\n\n    if (connectorSettings && connectorSettings.experimentation) {\n        const connectorSettingsForExperimentation = connectorSettings.experimentation;\n\n        const experimentationProvider = <IExperimentationProvider>(\n            // @ts-ignore - Compiler indicates that types of IMSDyn365CommerceExtension and MSDyn365Commerce do not overlap\n            // but typeof IMSDyn365CommerceWithPrototype = typeof MSDyn365Commerce & IPrototype\n            // See initialization.ts for an explanation of why we use prototype in conjunction with IMSDyn365CommerceWithPrototype\n            (<IMSDyn365CommerceExtension>msdyn365Commerce).getConnector(connectorSettingsForExperimentation.name)?.provider\n        );\n        if (experimentationProvider) {\n            try {\n                const experimentReady = await experimentationProvider.initialize(connectorSettingsForExperimentation.config, secretManager);\n                if (!experimentReady) {\n                    console.error(\n                        `experimentation connector registered with name ${connectorSettingsForExperimentation.name} not initialized successfully`\n                    );\n                    return undefined;\n                }\n            } catch (err) {\n                console.error(`experimentation connector registered error ${err} with name ${connectorSettingsForExperimentation.name}`);\n                return undefined;\n            }\n            return { name: connectorSettingsForExperimentation.name, provider: experimentationProvider };\n        }\n        console.error(`No experimentation connector registered with name ${connectorSettingsForExperimentation.name}`);\n        return undefined;\n    }\n    return undefined;\n};\n\nconst getDAPIBindings = async () => {\n    return {\n        modules: (await safeReadJson<{}>(keystonePaths.KEYSTONE_APP_DAPI_FILEPATH)) || {},\n        themes: (await safeReadJson<IThemeModule[]>(keystonePaths.KEYSTONE_APP_THEMES_DAPI_FILEPATH)) || []\n    };\n};\n\n/**\n * @function {getAppCacheForRootSite} - Method to return app cache instance for root site\n */\nconst getAppCacheForRootSite = (): IDictionary<ICache> => {\n    const appCacheDictionary: IDictionary<ICache> = {};\n    appCacheDictionary[ROOT_SITE] = new AppCache(getCacheSettings());\n    return appCacheDictionary;\n};\n\nconst removeExcludedModues = (bindings: IBinding) => {\n    // remove excluded modules from binding\n    const platformSettings = getPlatformSettingsSync();\n    const excludedModules = platformSettings.excludedModules;\n    if (excludedModules && excludedModules.length > 0) {\n        for (const moduleName of excludedModules) {\n            delete bindings.modules[`${moduleName}`];\n        }\n    }\n};\n\n// tslint:disable:no-invalid-this\nexport const initializeServerApp = async (bindings: IBinding) => {\n    bindings.dapi = await getDAPIBindings();\n    removeExcludedModues(bindings);\n    initializeApp(bindings);\n    useStaticRendering(true);\n    axios.interceptors.request.use(HttpsRequestInterceptor);\n\n    const packageVersion = await safeReadJson(keystonePaths.KEYSTONE_APP_PACKAGE_VERSION);\n    const appSecretsCache = await createAppSecretsCache();\n    const platformSettings = await getPlatformSettings();\n\n    // In local dev mode read local secrets file and credentials file\n    let localAppSecrets: IDictionary<string> | undefined;\n    let localCredentials: IDictionary<ILocalCredentials> | undefined;\n    if (process.env.NODE_ENV === 'development') {\n        localAppSecrets = await getLocalSecretsFile();\n        localCredentials = await getLocalCredentialsFile();\n    }\n\n    const secretManager: ISecretManager = new SecretManager(appSecretsCache, localAppSecrets);\n\n    const appSettingsPromise = getAppSettings(bindings);\n\n    const imageSettingsPromise = getImageSettings();\n\n    const themeSettingsPromise = getThemeSettings(platformSettings);\n\n    const experimentationConnectorPromise = getExperimentaionConnector(secretManager);\n\n    const experimentationCachePromise = getExperimentationCache();\n\n    const [appSettings, imageSettings, themeSettings, experimentationConnector, experimentationCache] = await Promise.all([\n        appSettingsPromise,\n        imageSettingsPromise,\n        themeSettingsPromise,\n        experimentationConnectorPromise,\n        experimentationCachePromise\n    ]);\n\n    const resourceManager = new ResourceManager();\n    await resourceManager.init(platformSettings);\n\n    (<IMSDyn365CommerceWithPrototype>MSDyn365Commerce).prototype.updatePrivateVariable = function(): void {\n        // @ts-ignore\n        this._buildVersion = packageVersion && packageVersion.buildVersion;\n\n        // @ts-ignore\n        this._resourceManager = resourceManager;\n\n        // @ts-ignore\n        this._appSettings = appSettings;\n\n        // @ts-ignore\n        this._imageSettings = imageSettings;\n\n        // @ts-ignore\n        this._themeSettings = themeSettings;\n\n        // @ts-ignore\n        this.createComponent = createComponent;\n\n        // @ts-ignore\n        this._experimentationCache = experimentationCache;\n\n        // @ts-ignore\n        this._secretManager = secretManager;\n\n        // @ts-ignore\n        this._experimentationConnector = experimentationConnector;\n        // @ts-ignore\n        this._platformSettings = platformSettings;\n        // @ts-ignore\n        this._localCredentials = localCredentials;\n    };\n\n    (<IMSDyn365CommerceWithPrototype>MSDyn365Commerce).prototype.appCache = getAppCacheForRootSite();\n\n    (<IMSDyn365CommerceWithPrototype>MSDyn365Commerce).prototype.getAppCache = function(requestContext: IRequestContext): ICache {\n        if (!requestContext || !requestContext.apiSettings) {\n            return this.appCache[ROOT_SITE];\n        }\n\n        const appCacheKey = `${requestContext.apiSettings.baseUrl}-${requestContext.apiSettings.channelId}`;\n        if (!this.appCache[appCacheKey]) {\n            this.appCache[appCacheKey] = new AppCache(getCacheSettings());\n        }\n        const appCache = <AppCache>this.appCache[appCacheKey];\n        appCache.setRequestContext(requestContext);\n        return appCache;\n    };\n\n    (<IGeneric<IAny>>msdyn365Commerce).updatePrivateVariable();\n};\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}