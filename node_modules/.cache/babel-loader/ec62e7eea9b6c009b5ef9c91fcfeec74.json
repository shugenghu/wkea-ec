{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import{addDiscountCodeAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';export default async function addPromoCode(cart,promoCode,actionContext){if(!cart){return{cart:undefined,status:'FAILED'};}if(hasPromoCode(cart,promoCode)){return{cart:undefined,status:'FAILED',substatus:'ALREADYADDED'};}return addDiscountCodeAsync({callerContext:actionContext},cart.Id,promoCode).then(newCart=>{// Retail server will still return success if a promo code is not valid,\n// but it won't actually add that promo code. So need to check if promo\n// code is actually in the new cart\nif(hasPromoCode(newCart,promoCode)){return{cart:newCart,status:'SUCCESS'};}else{return{cart:undefined,status:'FAILED'};}}).catch(error=>{actionContext.telemetry.warning(error);return{cart:undefined,status:'FAILED'};});}function hasPromoCode(cart,code){const codes=cart.Coupons?cart.Coupons.map(coupon=>{return coupon.Code.toLowerCase();}):[];return codes.indexOf(code.toLowerCase())>-1;}","map":{"version":3,"sources":["cart-state/add-promo-code.ts"],"names":[],"mappings":"sCACA,OAAS,oBAAT,KAAqC,qEAArC,CAIA,cAAe,eAAe,CAAA,YAAf,CAA4B,IAA5B,CAA8D,SAA9D,CAAiF,aAAjF,CAA8G,CACzH,GAAI,CAAC,IAAL,CAAW,CACP,MAAO,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAP,CACH,CAED,GAAI,YAAY,CAAC,IAAD,CAAO,SAAP,CAAhB,CAAmC,CAC/B,MAAO,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAqC,SAAS,CAAE,cAAhD,CAAP,CACH,CAED,MAAO,CAAA,oBAAoB,CAAC,CAAE,aAAa,CAAE,aAAjB,CAAD,CAAmC,IAAI,CAAC,EAAxC,CAA4C,SAA5C,CAApB,CACF,IADE,CACG,OAAO,EAAG,CACZ;AACA;AACA;AACA,GAAI,YAAY,CAAC,OAAD,CAAU,SAAV,CAAhB,CAAsC,CAClC,MAAmC,CAAE,IAAI,CAAE,OAAR,CAAiB,MAAM,CAAE,SAAzB,CAAnC,CACH,CAFD,IAEO,CACH,MAAmC,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAnC,CACH,CACJ,CAVE,EAUA,KAVA,CAUM,KAAK,EAAG,CACb,aAAa,CAAC,SAAd,CAAwB,OAAxB,CAAgC,KAAhC,EAEA,MAAmC,CAAE,IAAI,CAAE,SAAR,CAAmB,MAAM,CAAE,QAA3B,CAAnC,CACH,CAdE,CAAP,CAeH,CAED,QAAS,CAAA,YAAT,CAAsB,IAAtB,CAAkC,IAAlC,CAA8C,CAC1C,KAAM,CAAA,KAAK,CAAG,IAAI,CAAC,OAAL,CAAe,IAAI,CAAC,OAAL,CAAa,GAAb,CAAkB,MAAD,EAAmB,CAAG,MAAO,CAAA,MAAM,CAAC,IAAP,CAAa,WAAb,EAAP,CAAoC,CAA3E,CAAf,CAA8F,EAA5G,CACA,MAAO,CAAA,KAAK,CAAC,OAAN,CAAc,IAAI,CAAC,WAAL,EAAd,EAAoC,CAAC,CAA5C,CACH","sourcesContent":["import { IActionContext } from '@msdyn365-commerce/core';\nimport { addDiscountCodeAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';\nimport { Cart, Coupon } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport { ICartActionResultWithCart } from './cart-action-result';\n\nexport default async function addPromoCode(cart: Readonly<Cart | undefined>, promoCode: string, actionContext: IActionContext): Promise<ICartActionResultWithCart> {\n    if (!cart) {\n        return { cart: undefined, status: 'FAILED'};\n    }\n\n    if (hasPromoCode(cart, promoCode)) {\n        return { cart: undefined, status: 'FAILED', substatus: 'ALREADYADDED' };\n    }\n\n    return addDiscountCodeAsync({ callerContext: actionContext }, cart.Id, promoCode)\n        .then(newCart => {\n            // Retail server will still return success if a promo code is not valid,\n            // but it won't actually add that promo code. So need to check if promo\n            // code is actually in the new cart\n            if (hasPromoCode(newCart, promoCode)) {\n                return <ICartActionResultWithCart> { cart: newCart, status: 'SUCCESS' };\n            } else {\n                return <ICartActionResultWithCart> { cart: undefined, status: 'FAILED' };\n            }\n        }).catch(error => {\n            actionContext.telemetry.warning(error);\n\n            return <ICartActionResultWithCart> { cart: undefined, status: 'FAILED' };\n        });\n}\n\nfunction hasPromoCode(cart: Cart, code: string): boolean {\n    const codes = cart.Coupons ? cart.Coupons.map((coupon: Coupon) => { return coupon.Code!.toLowerCase(); }) : [];\n    return codes.indexOf(code.toLowerCase()) > -1;\n}\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}