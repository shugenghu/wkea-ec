{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{createDataActionHook,TelemetryEvent}from'@msdyn365-commerce/core';import{getProductInfoFromCart}from'./telemetry.action.helper';const beforeRemoveFromCart=async(inputs,actionContext)=>{try{const actionInput=Array.isArray(inputs)?inputs[0]:inputs;if(actionInput.queryParams&&typeof actionInput.queryParams==='function'){const removeCartLinesParams=actionInput.queryParams();if(removeCartLinesParams&&removeCartLinesParams.cartLineIds){actionContext.requestContext.telemetryData[\"removedCartLineIds\"]=removeCartLinesParams.cartLineIds;return;}}actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed - No removed cart lines found');}catch(e){actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed.',e);}};const afterRemoveFromCart=async(_inputs,cart,actionContext)=>{if(window&&window._msdyn365&&window._msdyn365.telemetry){const removeCartLineIds=actionContext.requestContext.telemetryData[\"removedCartLineIds\"];const activeCart=actionContext.requestContext.telemetryData[\"activeCart\"];const productTransaction=actionContext.requestContext.telemetryData[TelemetryEvent.Purchase];const removedCartLines=[];if(removeCartLineIds&&activeCart&&activeCart.CartLines){activeCart.CartLines.forEach(cartLine=>{if(cartLine.ProductId&&removeCartLineIds.indexOf(cartLine.LineId?cartLine.LineId:'')!==-1&&!(productTransaction&&productTransaction.products&&productTransaction.products.some(product=>+product.productSku===cartLine.ProductId))){removedCartLines.push(cartLine);}});}if(removedCartLines&&removedCartLines.length>0){window._msdyn365.telemetry.logEvent(TelemetryEvent.RemoveFromCart,getProductInfoFromCart(_objectSpread(_objectSpread(_objectSpread({},{}),cart),{CartLines:removedCartLines}),actionContext.requestContext.telemetryData,actionContext.requestContext));}else{actionContext.telemetry.debug('No RemoveFromCart event fired, no removed cart lines found');}}};createDataActionHook({actionId:'@msdyn365-commerce/retail-proxy/Carts/RemoveCartLines',postReaderHook:afterRemoveFromCart,preReaderHook:beforeRemoveFromCart});","map":{"version":3,"sources":["actions/removeFromCart-telemetry.action.ts"],"names":[],"mappings":"i8BAAA;;;AAGG,GAEH,OAAS,oBAAT,CAA8E,cAA9E,KAAoG,yBAApG,CAGA,OAAS,sBAAT,KAAuC,2BAAvC,CASA,KAAM,CAAA,oBAAoB,CAAG,MAAO,MAAP,CAA8C,aAA9C,GAA+E,CACxG,GAAI,CACA,KAAM,CAAA,WAAW,CAAG,KAAK,CAAC,OAAN,CAAc,MAAd,EAA6C,MAAM,CAAC,CAAD,CAAnD,CAA8E,MAAlG,CAGA,GAAI,WAAW,CAAC,WAAZ,EAA2B,MAAO,CAAA,WAAW,CAAC,WAAnB,GAAmC,UAAlE,CAA8E,CAC1E,KAAM,CAAA,qBAAqB,CAAG,WAAW,CAAC,WAAZ,EAA9B,CACA,GAAI,qBAAqB,EAAI,qBAAqB,CAAC,WAAnD,CAAgE,CAE5D,aAAa,CAAC,cAAd,CAA6B,aAA7B,uBAAmE,qBAAqB,CAAC,WAAzF,CACA,OACH,CACJ,CACD,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,0EAA9B,EACH,CAAC,MAAO,CAAP,CAAU,CACR,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,6CAA9B,CAA6E,CAA7E,EACH,CACJ,CAjBD,CAyBA,KAAM,CAAA,mBAAmB,CAAG,MAAO,OAAP,CAA+C,IAA/C,CAAoE,aAApE,GAAqG,CAC7H,GAAI,MAAM,EAAI,MAAM,CAAC,SAAjB,EAA8B,MAAM,CAAC,SAAP,CAAiB,SAAnD,CAA8D,CAC1D,KAAM,CAAA,iBAAiB,CAAa,aAAa,CAAC,cAAd,CAA6B,aAA7B,sBAApC,CACA,KAAM,CAAA,UAAU,CAAS,aAAa,CAAC,cAAd,CAA6B,aAA7B,cAAzB,CACA,KAAM,CAAA,kBAAkB,CAAwB,aAAa,CAAC,cAAd,CAA6B,aAA7B,CAA2C,cAAc,CAAC,QAA1D,CAAhD,CACA,KAAM,CAAA,gBAAgB,CAAe,EAArC,CAGA,GAAI,iBAAiB,EAAI,UAArB,EAAmC,UAAU,CAAC,SAAlD,CAA6D,CACzD,UAAU,CAAC,SAAX,CAAqB,OAArB,CAA8B,QAAD,EAAuB,CAChD,GACI,QAAQ,CAAC,SAAT,EACA,iBAAiB,CAAC,OAAlB,CAA0B,QAAQ,CAAC,MAAT,CAAkB,QAAQ,CAAC,MAA3B,CAAoC,EAA9D,IAAsE,CAAC,CADvE,EAEA,EACI,kBAAkB,EAClB,kBAAkB,CAAC,QADnB,EAEA,kBAAkB,CAAC,QAAnB,CAA4B,IAA5B,CAAiC,OAAO,EAAI,CAAC,OAAO,CAAC,UAAT,GAAwB,QAAQ,CAAC,SAA7E,CAHJ,CAHJ,CAQE,CACE,gBAAgB,CAAC,IAAjB,CAAsB,QAAtB,EACH,CACJ,CAZD,EAaH,CAGD,GAAI,gBAAgB,EAAI,gBAAgB,CAAC,MAAjB,CAA0B,CAAlD,CAAqD,CACjD,MAAM,CAAC,SAAP,CAAiB,SAAjB,CAA2B,QAA3B,CACI,cAAc,CAAC,cADnB,CAEI,sBAAsB,8CACb,EADa,EACN,IADM,EACG,CAAE,SAAS,CAAE,gBAAb,CADH,EAElB,aAAa,CAAC,cAAd,CAA6B,aAFX,CAGlB,aAAa,CAAC,cAHI,CAF1B,EAQH,CATD,IASO,CACH,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,4DAA9B,EACH,CACJ,CACJ,CAtCD,CAwCA,oBAAoB,CAAC,CACjB,QAAQ,CAAE,uDADO,CAEjB,cAAc,CAAE,mBAFC,CAGjB,aAAa,CAAE,oBAHE,CAAD,CAApB","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { createDataActionHook, IActionContext, IActionInput, IMSDyn365Window, TelemetryEvent } from '@msdyn365-commerce/core';\nimport { Cart, CartLine, IDataServiceRequest, IRemoveCartLinesParam } from '@msdyn365-commerce/retail-proxy';\nimport { IProductTransaction } from '@msdyn365-commerce/telemetry-internal';\nimport { getProductInfoFromCart } from './telemetry.action.helper';\n\ndeclare var window: IMSDyn365Window;\n\n/**\n * Saves info on cart lines removed before calling data action\n * @param inputs Data action inputs\n * @param actionContext Action context\n */\nconst beforeRemoveFromCart = async (inputs: IActionInput | IActionInput[], actionContext: IActionContext) => {\n    try {\n        const actionInput = Array.isArray(inputs) ? <IDataServiceRequest>inputs[0] : <IDataServiceRequest>inputs;\n\n        // If cart lines were removed\n        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {\n            const removeCartLinesParams = actionInput.queryParams<IRemoveCartLinesParam>();\n            if (removeCartLinesParams && removeCartLinesParams.cartLineIds) {\n                // Save info on removed cart lines for post data action hook to pick up\n                actionContext.requestContext.telemetryData[`removedCartLineIds`] = removeCartLinesParams.cartLineIds;\n                return;\n            }\n        }\n        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed - No removed cart lines found');\n    } catch (e) {\n        actionContext.telemetry.debug('RemoveFromCart pre-data action hook failed.', e);\n    }\n};\n\n/**\n * Fires a RemoveFromCart event after data action completed\n * @param _inputs Data action inputs\n * @param cart New cart object after cart lines have been removed\n * @param actionContext Action context\n */\nconst afterRemoveFromCart = async (_inputs: IActionInput | IActionInput[], cart: Cart | Cart[], actionContext: IActionContext) => {\n    if (window && window._msdyn365 && window._msdyn365.telemetry) {\n        const removeCartLineIds = <string[]>actionContext.requestContext.telemetryData[`removedCartLineIds`];\n        const activeCart = <Cart>actionContext.requestContext.telemetryData[`activeCart`];\n        const productTransaction = <IProductTransaction>actionContext.requestContext.telemetryData[TelemetryEvent.Purchase];\n        const removedCartLines: CartLine[] = [];\n\n        // Collect info on products removed from cart\n        if (removeCartLineIds && activeCart && activeCart.CartLines) {\n            activeCart.CartLines.forEach((cartLine: CartLine) => {\n                if (\n                    cartLine.ProductId &&\n                    removeCartLineIds.indexOf(cartLine.LineId ? cartLine.LineId : '') !== -1 &&\n                    !(\n                        productTransaction &&\n                        productTransaction.products &&\n                        productTransaction.products.some(product => +product.productSku === cartLine.ProductId)\n                    )\n                ) {\n                    removedCartLines.push(cartLine);\n                }\n            });\n        }\n\n        // Fire RemoveFromCart event if cart lines were removed\n        if (removedCartLines && removedCartLines.length > 0) {\n            window._msdyn365.telemetry.logEvent(\n                TelemetryEvent.RemoveFromCart,\n                getProductInfoFromCart(\n                    { ...{}, ...cart, ...{ CartLines: removedCartLines } },\n                    actionContext.requestContext.telemetryData,\n                    actionContext.requestContext\n                )\n            );\n        } else {\n            actionContext.telemetry.debug('No RemoveFromCart event fired, no removed cart lines found');\n        }\n    }\n};\n\ncreateDataActionHook({\n    actionId: '@msdyn365-commerce/retail-proxy/Carts/RemoveCartLines',\n    postReaderHook: afterRemoveFromCart,\n    preReaderHook: beforeRemoveFromCart\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}