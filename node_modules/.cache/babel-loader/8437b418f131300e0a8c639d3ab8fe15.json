{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/web.dom-collections.iterator.js\";import{generateProductImageUrl}from'@msdyn365-commerce-modules/retail-actions';import MsDyn365,{createObservableDataAction}from'@msdyn365-commerce/core';import{searchByCriteriaAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import{BaseCollectionInput,createBaseCollectionInput}from'./base-collection-action';import{ListPageStateInput}from'../list-page-state';export class GetFullProductsByCollectionInput extends BaseCollectionInput{constructor(){super(...arguments);this.getCacheObjectType=()=>'FullProductSearchResult';this.dataCacheType=()=>{if(this.pageType!=='Category'||this.refiners&&this.refiners.length>0||this.queryResultSettings&&this.queryResultSettings.Sorting&&this.queryResultSettings.Sorting.Columns&&this.queryResultSettings.Sorting.Columns.length>0){return'request';}else{return'application';}};}}const createInput=args=>{const input=createBaseCollectionInput(args,GetFullProductsByCollectionInput);if(input.queryResultSettings.Paging&&args.config){input.queryResultSettings.Paging.Top=args.config.itemsPerPage||1;}if(input.queryResultSettings.Paging&&args.requestContext.query&&args.requestContext.query.skip){input.queryResultSettings.Paging.Skip=+args.requestContext.query.skip;}input.queryResultSettings.count=true;return input;};async function action(input,ctx){let productSearchResults;let promise;let searchProductId;const searchCriteriaInput={};searchCriteriaInput.Context={ChannelId:ctx.requestContext.apiSettings.channelId,CatalogId:ctx.requestContext.apiSettings.catalogId};searchCriteriaInput.Refinement=input.refiners;searchCriteriaInput.IncludeAttributes=input.includeAttributes;if(input.pageType==='Category'||ctx.requestContext.query&&ctx.requestContext.query.categoryId){if(input.category){searchCriteriaInput.CategoryIds=[input.category||0];promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);}else{throw new Error('[GetFullProductsForCollection]Category Page Detected, but no global categoryId found');}}else{if(input.searchText&&ctx.requestContext.query&&ctx.requestContext.query.q){searchCriteriaInput.SearchCondition=input.searchText;promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);}else{if(input.searchText&&ctx.requestContext.query&&ctx.requestContext.query.productId){searchProductId=Number(input.searchText);if(Number.isNaN(searchProductId)){throw new Error('Failed to cast search product id into a number.');}else{searchCriteriaInput.RecommendationListId='looks';searchCriteriaInput.Ids=[searchProductId||0];promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);}}else{throw new Error('[GetFullProductsForCollection]Search Page Detected, but no q= or productId= query parameter found');}}}productSearchResults=await promise;const mappedProducts=productSearchResults.map(productSearchResult=>{const newImageUrl=generateProductImageUrl(productSearchResult,ctx.requestContext.apiSettings);if(newImageUrl){productSearchResult.PrimaryImageUrl=newImageUrl;}return productSearchResult;});if(!MsDyn365.isBrowser){ctx.update(new ListPageStateInput(),{totalProductCount:promise.metadata.count||0,activeFilters:input.refiners});}return{products:mappedProducts,count:promise.metadata.count||0};}export default createObservableDataAction({id:'@msdyn365-commerce-modules/search-result-container/get-full-products-by-collection',action:action,input:createInput});","map":{"version":3,"sources":["modules/search-result-container/actions/get-full-products-by-collection.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { generateProductImageUrl } from '@msdyn365-commerce-modules/retail-actions';\nimport MsDyn365, {\n    createObservableDataAction,\n    IAction,\n    IActionContext,\n    IActionInput,\n    ICreateActionContext\n} from '@msdyn365-commerce/core';\nimport { AsyncResult, ProductSearchCriteria,ProductSearchResult } from '@msdyn365-commerce/retail-proxy';\nimport { searchByCriteriaAsync} from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport {\n    BaseCollectionInput,\n    createBaseCollectionInput\n} from './base-collection-action';\n\nimport { ListPageStateInput } from '../list-page-state';\n\n/**\n * GetFullProductsByCollection Action Input\n */\nexport class GetFullProductsByCollectionInput extends BaseCollectionInput implements IActionInput {\n    public getCacheObjectType = () => 'FullProductSearchResult';\n    public dataCacheType = () => {\n        if (\n            this.pageType !== 'Category' ||\n            (this.refiners && this.refiners.length > 0) ||\n            (this.queryResultSettings && this.queryResultSettings.Sorting && this.queryResultSettings.Sorting.Columns && this.queryResultSettings.Sorting.Columns.length > 0)\n        ) {\n            return 'request';\n        } else {\n            return 'application';\n        }\n    }\n}\n\nexport interface IFullProductsSearchResultsWithCount {\n    products: ProductSearchResult[];\n    count: number;\n}\n\n/**\n * createInput function which creates and actionInput used to fetch products for a list page.\n */\nconst createInput = (args: ICreateActionContext<{ itemsPerPage: number ;includedAttributes:boolean | undefined}>): IActionInput => {\n    const input = createBaseCollectionInput(args, GetFullProductsByCollectionInput);\n\n    // Set Top\n    if (input.queryResultSettings.Paging && args.config) {\n        input.queryResultSettings.Paging.Top = args.config.itemsPerPage || 1;\n    }\n\n    // Set Skip\n    if (input.queryResultSettings.Paging && args.requestContext.query && args.requestContext.query.skip) {\n        input.queryResultSettings.Paging.Skip = +args.requestContext.query.skip;\n    }\n\n    input.queryResultSettings.count = true;\n\n    return input;\n};\n\n/**\n * Action function to fetch products for a list page\n */\nasync function action(\n    input: GetFullProductsByCollectionInput,\n    ctx: IActionContext\n): Promise<IFullProductsSearchResultsWithCount> {\n    let productSearchResults: ProductSearchResult[];\n    let promise: AsyncResult<ProductSearchResult[]>;\n    let searchProductId;\n    const searchCriteriaInput: ProductSearchCriteria = {};\n    searchCriteriaInput.Context = { ChannelId: ctx.requestContext.apiSettings.channelId, CatalogId: ctx.requestContext.apiSettings.catalogId };\n    searchCriteriaInput.Refinement = input.refiners;\n    searchCriteriaInput.IncludeAttributes = input.includeAttributes;\n\n    if (input.pageType === 'Category' || (ctx.requestContext.query && ctx.requestContext.query.categoryId)) {\n        if (input.category) {\n            searchCriteriaInput.CategoryIds = [input.category || 0];\n            promise = searchByCriteriaAsync(\n                {\n                    callerContext: ctx,\n                    queryResultSettings: input.queryResultSettings\n                },\n                searchCriteriaInput\n            );\n        } else {\n            throw new Error(\n                '[GetFullProductsForCollection]Category Page Detected, but no global categoryId found'\n            );\n        }\n    } else {\n        if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.q)) {\n            searchCriteriaInput.SearchCondition = input.searchText;\n            promise = searchByCriteriaAsync(\n                {\n                    callerContext: ctx,\n                    queryResultSettings: input.queryResultSettings\n                },\n                searchCriteriaInput\n            );\n        } else {\n            if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.productId)) {\n                searchProductId = Number(input.searchText);\n                if (Number.isNaN(searchProductId)) {\n                    throw new Error('Failed to cast search product id into a number.');\n                } else {\n                    searchCriteriaInput.RecommendationListId = 'looks';\n                    searchCriteriaInput.Ids = [searchProductId || 0];\n                    promise = searchByCriteriaAsync(\n                        {\n                            callerContext: ctx,\n                            queryResultSettings: input.queryResultSettings\n                        },\n                        searchCriteriaInput\n                    );\n                }\n            } else {\n                throw new Error(\n                    '[GetFullProductsForCollection]Search Page Detected, but no q= or productId= query parameter found'\n                );\n            }\n        }\n    }\n\n    productSearchResults = await promise;\n\n    const mappedProducts = productSearchResults.map(productSearchResult => {\n        const newImageUrl = generateProductImageUrl(\n            productSearchResult,\n            ctx.requestContext.apiSettings\n        );\n\n        if (newImageUrl) {\n            productSearchResult.PrimaryImageUrl = newImageUrl;\n        }\n\n        return (productSearchResult);\n    });\n\n    // Update ListPageState For SSR\n    if (!MsDyn365.isBrowser) {\n        ctx.update(new ListPageStateInput(), { totalProductCount: promise.metadata.count || 0, activeFilters: input.refiners });\n\n    }\n\n    return {\n        products: mappedProducts,\n        count: promise.metadata.count || 0\n    };\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/search-result-container/get-full-products-by-collection',\n    action: <IAction<IFullProductsSearchResultsWithCount>>action,\n    input: createInput\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}