{"ast":null,"code":"import _typeof from\"@babel/runtime/helpers/esm/typeof\";import _slicedToArray from\"@babel/runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _escape from\"lodash/escape\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{msdyn365Commerce,SDK_FRAGMENT_NAME,SDK_FRAGMENT_NAME_REGEX}from'@msdyn365-commerce/core-internal';import{EXCEPTION_EXPECTED501,StaticTelemetry}from'@msdyn365-commerce/telemetry-internal';import*as fs from'fs';import{getCurrency}from'locale-currency';import*as path from'path';import{renderToString}from'react-dom/server';import*as semver from'semver';import{HttpException}from'../_server/error';export var MODULE_ERROR_TYPE_NAME_FOR_CACHE='__ME';export var EMPTY_MODULE_RESULT_VALUE='empty-module-result';export var UNREGISTERED_MODULE_VALUE='unregistered-module';// Used to deprecate older modules starting SSK V2\nexport var SSK2_VERSION='2.0.0';/**\r\n * Creates and returns an ICacheKey object for storing\r\n * results of module render errors inside the RequestCache\r\n *\r\n * @param id The id of the module that encountered an error\r\n */export var createCacheKeyForModuleError=function createCacheKeyForModuleError(id){return{typeName:MODULE_ERROR_TYPE_NAME_FOR_CACHE,key:id};};/**\r\n * Creates and returns an ICacheItem object that inidcates\r\n * a module render result was null or empty\r\n */export var createCacheValueForEmptyModule=function createCacheValueForEmptyModule(){return{item:EMPTY_MODULE_RESULT_VALUE};};/**\r\n * Creates and returns an ICacheItem object that inidcates\r\n * a module was unregistered and thus not rendered\r\n */export var createCacheValueForUnregisteredModule=function createCacheValueForUnregisteredModule(){return{item:UNREGISTERED_MODULE_VALUE};};/**\r\n * Utility function to async check if file exists\r\n * @param filePath file path to check\r\n */export var fileExists=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(filePath,telemetry){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",new Promise(function(resolve,reject){if(!filePath){resolve(undefined);}fs.access(filePath,fs.constants.R_OK,function(err){if(err){resolve(undefined);}resolve(filePath);});}));case 1:case\"end\":return _context.stop();}}},_callee);}));return function fileExists(_x,_x2){return _ref.apply(this,arguments);};}();/**\r\n * Utility function to access the site builder rendering helper\r\n */export var getRenderingHelper=function getRenderingHelper(){// @ts-ignore\nreturn window._msdyn365.authoringHelper&&window._msdyn365.authoringHelper.renderingHelper;};/**\r\n * Converts a readable stream (that has yet to emit 'data') to a string\r\n *\r\n * @param stream Stream-like object\r\n */export var streamToString=function streamToString(stream){return new Promise(function(resolve){var stringParts=[];stream.on('data',function(buffer){stringParts.push(buffer.toString());});stream.on('end',function(){resolve(stringParts.join(''));});});};/**\r\n * Checks is value is truthy\r\n * @param value value to check\r\n */export var isTruthy=function isTruthy(value){if(value===undefined||value===null){return false;}switch(String(value).toLocaleLowerCase()){case'1':case'true':case'yes':return true;case'0':case'false':case'no':case'undefined':case'':return false;default:return!!value;}};/**\r\n * Checks optional QSP value and returns as a structured type\r\n *\r\n * @param qspValue QSP value to check\r\n */export var parseToQSPObject=function parseToQSPObject(qspValue){return{hasValue:qspValue!==undefined,isTruthy:isTruthy(String(qspValue)),value:qspValue};};/**\r\n * Server has whitelisting of QSPs, so QSPs going through Server have be put beind a whitelisted QSP such as item.\r\n *\r\n * Example:\r\n *  In localhost, we'll have `?debug=true` but when running through Server, this is equivalent to ?item=debug:true\r\n *\r\n * This method also supports parsing out a comma separated item list, makes assumption that everything is properly URIEncoded\r\n *  e.g. ?item=debug:true,foo:bar,bar:123\r\n *\r\n * @param itemQueryString the `item` query string value\r\n */export var parseItemQSP=function parseItemQSP(itemQueryString){var result={};if(itemQueryString===undefined||itemQueryString===null){return result;}var decodedUriParts=decodeURIComponent(itemQueryString).split(',');decodedUriParts.forEach(function(qsp){var qspParts=qsp.split(':');if(qspParts&&qspParts.length===2){var _qspParts=_slicedToArray(qspParts,2),key=_qspParts[0],value=_qspParts[1];if(key.length&&value.length){result[key]=value;}}});return result;};export var LinkTag=function LinkTag(baseUrl,preloadAttribute){return function(src){return\"<link rel=\\\"stylesheet\\\" href=\\\"\".concat(baseUrl).concat(src,\"\\\" \").concat(preloadAttribute,\" crossOrigin=\\\"anonymous\\\" />\");};};export var CommentTag=function CommentTag(comment){if(_typeof(comment)==='object'){return Object.keys(comment).map(function(key){return\"<!-- key: \".concat(_escape(key),\", value: \").concat(_escape(JSON.stringify(comment[key])),\" -->\");}).join('');}return\"<!-- \".concat(_escape(comment),\" -->\");};// tslint:disable:no-any\n/**\r\n * Wraps express routes and makes sure to catch & rethrow any errors.\r\n * Actual handling will be done by the handlerServerError method that logs error and sends response\r\n * @param fn Function for wrapped route\r\n */export var safeRoute=function safeRoute(fn){return function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}return fn.apply(void 0,args)[\"catch\"](function(error){args[2]&&args[2](error);});};};// tslint:enable:no-any\n/**\r\n * Sample helper\r\n * @param res Response\r\n */export var throwHelper=function throwHelper(req,res,next,message){throw new HttpException(501,StaticTelemetry.stringFormat(EXCEPTION_EXPECTED501,[message]));};export var getAbsoluteUri=function getAbsoluteUri(req){return\"\".concat(req.protocol,\"://\").concat(req.get('host')).concat(req.originalUrl);};/**\r\n * Wrapped render to string method that replaces the SDK Fragment element with nothing\r\n * used as a drop-in for renderToString on elements where we blindly set innerHTML.\r\n *\r\n * @param element the element to render\r\n */ // tslint:disable-next-line:no-any\nexport var patchedRenderToString=function patchedRenderToString(element,disableServerSideErrorChecking){var renderResult=renderToString(element);if(disableServerSideErrorChecking||!renderResult.startsWith(\"<\".concat(SDK_FRAGMENT_NAME))){return renderResult;}return renderResult.replace(SDK_FRAGMENT_NAME_REGEX,'');};export var CurrencyCodeIdentifier='cc';export var getCurrencyCodeFromContext=function getCurrencyCodeFromContext(requestContext){return requestContext&&requestContext.query&&requestContext.query[CurrencyCodeIdentifier]||requestContext.cookies&&requestContext.cookies.get(CurrencyCodeIdentifier).value||requestContext.channel&&requestContext.channel.Currency||getCurrency(requestContext.locale);};/**\r\n * Extracts the name of the module from the path to its definition file\r\n * @param definitionPath path to the definition file\r\n */export var getModuleName=function getModuleName(definitionPath){if(!definitionPath||definitionPath===''){return'';}return path.basename(definitionPath,\".definition.json\"/* DEFINITION_FILE */);};/**\r\n * Returns the binder object for the given module\r\n * @param typeName name of the module\r\n */export var getModuleBinder=function getModuleBinder(typeName){return msdyn365Commerce.moduleBinder(typeName);};/**\r\n * Returns name of the parent module for given module name\r\n * @param moduleName name of the module\r\n */export var getParentModuleName=function getParentModuleName(moduleName){var moduleBinder=getModuleBinder(moduleName);if(!moduleBinder){return'';}return getModuleName(moduleBinder.parentDefinitionPath);};export var isSSK2App=function isSSK2App(){var sskVersion=!process.env.MSDyn365Commerce_SSK_VERSION||process.env.MSDyn365Commerce_SSK_VERSION==='--'?'0.0':process.env.MSDyn365Commerce_SSK_VERSION;return semver.gt(semver.coerce(sskVersion)||'',SSK2_VERSION);};","map":{"version":3,"sources":["../../../src/utils/helpers.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { ICacheItem, ICacheKey } from '@msdyn365-commerce/cache-internal';\nimport {\n    IDictionary,\n    IParsedQSP,\n    IRenderingHelper,\n    IRequestContext,\n    msdyn365Commerce,\n    MSDyn365Commerce,\n    SDK_FRAGMENT_NAME,\n    SDK_FRAGMENT_NAME_REGEX\n} from '@msdyn365-commerce/core-internal';\nimport { EXCEPTION_EXPECTED501, IInternalTelemetry, StaticTelemetry } from '@msdyn365-commerce/telemetry-internal';\nimport { NextFunction, Request, Response } from 'express';\nimport * as fs from 'fs';\nimport { getCurrency } from 'locale-currency';\nimport { escape } from 'lodash';\nimport * as path from 'path';\nimport { ReactElement } from 'react';\nimport { renderToString } from 'react-dom/server';\nimport * as semver from 'semver';\nimport { Stream } from 'stream';\nimport { THEME_MODULE } from '../_server/Definition/moduleDefinition';\nimport { HttpException } from '../_server/error';\nimport { IMSDyn365CommerceExtension } from '../app-initialization/models';\n\nexport const MODULE_ERROR_TYPE_NAME_FOR_CACHE: string = '__ME';\nexport const EMPTY_MODULE_RESULT_VALUE = 'empty-module-result';\nexport const UNREGISTERED_MODULE_VALUE = 'unregistered-module';\n\n// Used to deprecate older modules starting SSK V2\nexport const SSK2_VERSION = '2.0.0';\n\n/**\n * Creates and returns an ICacheKey object for storing\n * results of module render errors inside the RequestCache\n *\n * @param id The id of the module that encountered an error\n */\nexport const createCacheKeyForModuleError = (id: string): ICacheKey => {\n    return { typeName: MODULE_ERROR_TYPE_NAME_FOR_CACHE, key: id };\n};\n\n/**\n * Creates and returns an ICacheItem object that inidcates\n * a module render result was null or empty\n */\nexport const createCacheValueForEmptyModule = (): ICacheItem<string> => {\n    return { item: EMPTY_MODULE_RESULT_VALUE };\n};\n\n/**\n * Creates and returns an ICacheItem object that inidcates\n * a module was unregistered and thus not rendered\n */\nexport const createCacheValueForUnregisteredModule = (): ICacheItem<string> => {\n    return { item: UNREGISTERED_MODULE_VALUE };\n};\n\n/**\n * Utility function to async check if file exists\n * @param filePath file path to check\n */\nexport const fileExists = async (filePath: string, telemetry: IInternalTelemetry) => {\n    return new Promise((resolve: (pathToFileThatExists?: string) => void, reject: () => void) => {\n        if (!filePath) {\n            resolve(undefined);\n        }\n\n        fs.access(filePath, fs.constants.R_OK, (err: NodeJS.ErrnoException | null) => {\n            if (err) {\n                resolve(undefined);\n            }\n            resolve(filePath);\n        });\n    });\n};\n\n/**\n * Utility function to access the site builder rendering helper\n */\nexport const getRenderingHelper = (): IRenderingHelper | undefined => {\n    // @ts-ignore\n    return window._msdyn365.authoringHelper && window._msdyn365.authoringHelper.renderingHelper;\n};\n\n/**\n * Converts a readable stream (that has yet to emit 'data') to a string\n *\n * @param stream Stream-like object\n */\nexport const streamToString = (stream: Stream): Promise<string> => {\n    return new Promise((resolve: (streamAsString: string) => void) => {\n        const stringParts: string[] = [];\n        stream.on('data', (buffer: Buffer) => {\n            stringParts.push(buffer.toString());\n        });\n        stream.on('end', () => {\n            resolve(stringParts.join(''));\n        });\n    });\n};\n\n/**\n * Checks is value is truthy\n * @param value value to check\n */\nexport const isTruthy = (value: number | boolean | string | undefined | null) => {\n    if (value === undefined || value === null) {\n        return false;\n    }\n    switch (String(value).toLocaleLowerCase()) {\n        case '1':\n        case 'true':\n        case 'yes':\n            return true;\n        case '0':\n        case 'false':\n        case 'no':\n        case 'undefined':\n        case '':\n            return false;\n        default:\n            return !!value;\n    }\n};\n\n/**\n * Checks optional QSP value and returns as a structured type\n *\n * @param qspValue QSP value to check\n */\nexport const parseToQSPObject = <TValue>(qspValue: TValue): IParsedQSP<TValue> => {\n    return {\n        hasValue: qspValue !== undefined,\n        isTruthy: isTruthy(String(qspValue)),\n        value: qspValue\n    };\n};\n\n/**\n * Server has whitelisting of QSPs, so QSPs going through Server have be put beind a whitelisted QSP such as item.\n *\n * Example:\n *  In localhost, we'll have `?debug=true` but when running through Server, this is equivalent to ?item=debug:true\n *\n * This method also supports parsing out a comma separated item list, makes assumption that everything is properly URIEncoded\n *  e.g. ?item=debug:true,foo:bar,bar:123\n *\n * @param itemQueryString the `item` query string value\n */\nexport const parseItemQSP = (itemQueryString: string | undefined | null): IDictionary<string> => {\n    const result: IDictionary<string> = {};\n    if (itemQueryString === undefined || itemQueryString === null) {\n        return result;\n    }\n    const decodedUriParts = decodeURIComponent(itemQueryString).split(',');\n    decodedUriParts.forEach((qsp: string) => {\n        const qspParts = qsp.split(':');\n        if (qspParts && qspParts.length === 2) {\n            const [key, value] = qspParts;\n            if (key.length && value.length) {\n                result[key] = value;\n            }\n        }\n    });\n    return result;\n};\n\nexport const LinkTag = (baseUrl: string, preloadAttribute: string) => (src: string) =>\n    `<link rel=\"stylesheet\" href=\"${baseUrl}${src}\" ${preloadAttribute} crossOrigin=\"anonymous\" />`;\n\nexport const CommentTag = (comment: string | object) => {\n    if (typeof comment === 'object') {\n        return Object.keys(comment)\n            .map(key => `<!-- key: ${escape(key)}, value: ${escape(JSON.stringify(comment[key]))} -->`)\n            .join('');\n    }\n    return `<!-- ${escape(comment)} -->`;\n};\n\n// tslint:disable:no-any\n/**\n * Wraps express routes and makes sure to catch & rethrow any errors.\n * Actual handling will be done by the handlerServerError method that logs error and sends response\n * @param fn Function for wrapped route\n */\nexport const safeRoute = fn => (...args: any[]) =>\n    fn(...args).catch((error: Error) => {\n        args[2] && args[2](error);\n    });\n// tslint:enable:no-any\n\n/**\n * Sample helper\n * @param res Response\n */\nexport const throwHelper = (req: Request, res: Response, next: NextFunction, message: string) => {\n    throw new HttpException(501, StaticTelemetry.stringFormat(EXCEPTION_EXPECTED501, [message]));\n};\n\nexport const getAbsoluteUri = (req): string => {\n    return `${req.protocol}://${req.get('host')}${req.originalUrl}`;\n};\n\n/**\n * Wrapped render to string method that replaces the SDK Fragment element with nothing\n * used as a drop-in for renderToString on elements where we blindly set innerHTML.\n *\n * @param element the element to render\n */\n// tslint:disable-next-line:no-any\nexport const patchedRenderToString = (element: ReactElement, disableServerSideErrorChecking: boolean) => {\n    const renderResult = renderToString(element);\n    if (disableServerSideErrorChecking || !renderResult.startsWith(`<${SDK_FRAGMENT_NAME}`)) {\n        return renderResult;\n    }\n    return renderResult.replace(SDK_FRAGMENT_NAME_REGEX, '');\n};\n\nexport const CurrencyCodeIdentifier = 'cc';\nexport const getCurrencyCodeFromContext = (requestContext: IRequestContext) => {\n    return (\n        (requestContext && requestContext.query && requestContext.query[CurrencyCodeIdentifier]) ||\n        (requestContext.cookies && requestContext.cookies.get<string>(CurrencyCodeIdentifier).value) ||\n        (requestContext.channel && requestContext.channel.Currency) ||\n        getCurrency(requestContext.locale)\n    );\n};\n\n/**\n * Extracts the name of the module from the path to its definition file\n * @param definitionPath path to the definition file\n */\nexport const getModuleName = (definitionPath: string) => {\n    if (!definitionPath || definitionPath === '') {\n        return '';\n    }\n\n    return path.basename(definitionPath, THEME_MODULE.DEFINITION_FILE);\n};\n\n/**\n * Returns the binder object for the given module\n * @param typeName name of the module\n */\nexport const getModuleBinder = (typeName: string) => (<IMSDyn365CommerceExtension>(<unknown>msdyn365Commerce)).moduleBinder(typeName);\n\n/**\n * Returns name of the parent module for given module name\n * @param moduleName name of the module\n */\nexport const getParentModuleName = (moduleName: string) => {\n    const moduleBinder = getModuleBinder(moduleName);\n\n    if (!moduleBinder) {\n        return '';\n    }\n\n    return getModuleName(moduleBinder.parentDefinitionPath);\n};\n\nexport const isSSK2App = () => {\n    const sskVersion =\n        !process.env.MSDyn365Commerce_SSK_VERSION || process.env.MSDyn365Commerce_SSK_VERSION === '--'\n            ? '0.0'\n            : process.env.MSDyn365Commerce_SSK_VERSION;\n\n    return semver.gt(semver.coerce(sskVersion) || '', SSK2_VERSION);\n};\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}