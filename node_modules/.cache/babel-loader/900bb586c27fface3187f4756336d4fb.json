{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import{generateImageUrl}from'@msdyn365-commerce-modules/retail-actions';import{createObservableDataAction}from'@msdyn365-commerce/core';import{getSearchSuggestionsAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';export var AutoSuggestInput=function AutoSuggestInput(searchText,top,suggestionType,hitPrefix,hitSuffix){_classCallCheck(this,AutoSuggestInput);this.getCacheKey=function(){return\"AutoSuggestSearchSuggestions\";};this.getCacheObjectType=function(){return'AutoSuggestSearchSuggestions';};this.dataCacheType=function(){return'none';};this.searchQuery=searchText;this.topResultsCount=top;this.suggestionType=suggestionType;this.hitPrefix=hitPrefix;this.hitSuffix=hitSuffix;};var createInput=function createInput(inputData){return new AutoSuggestInput();};export function getSearchSuggestionsAction(_x,_x2){return _getSearchSuggestionsAction.apply(this,arguments);}function _getSearchSuggestionsAction(){_getSearchSuggestionsAction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var autosuggest,autoSuggestPromises;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!input||!input.searchQuery)){_context.next=2;break;}throw new Error('[getSearchSuggestionsAction]No valid Input was provided, failing');case 2:autosuggest={};autoSuggestPromises=[_getAutoSuggest(input,autosuggest,ctx)];return _context.abrupt(\"return\",Promise.all(autoSuggestPromises).then(function(){return autosuggest;}));case 5:case\"end\":return _context.stop();}}},_callee);}));return _getSearchSuggestionsAction.apply(this,arguments);}function _getAutoSuggest(_x3,_x4,_x5){return _getAutoSuggest2.apply(this,arguments);}function _getAutoSuggest2(){_getAutoSuggest2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(input,autosuggest,ctx){var searchCriteria,searchSuggestions;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:searchCriteria={ProductSearchCriteria:{SearchCondition:input.searchQuery&&input.searchQuery.length>0?input.searchQuery:'',Context:{ChannelId:+ctx.requestContext.apiSettings.channelId,CatalogId:+ctx.requestContext.apiSettings.catalogId}},HitPrefix:input.hitPrefix,HitSuffix:input.hitSuffix,SuggestionType:input.suggestionType};_context2.next=3;return getSearchSuggestionsAsync({callerContext:ctx,queryResultSettings:{Paging:{Top:input.topResultsCount}}},searchCriteria);case 3:searchSuggestions=_context2.sent;if(searchSuggestions&&searchSuggestions.length>0){searchSuggestions.map(function(item){return item.ImageUrl=item.ImageUrl?generateImageUrl(item.ImageUrl,ctx.requestContext.apiSettings):'';});autosuggest.AllSearchResults=searchSuggestions;}else{ctx.telemetry.error(\"[getSearchSuggestionsAction] unable to get availabilites for search with suggestion type \".concat(searchCriteria.SuggestionType));}case 5:case\"end\":return _context2.stop();}}},_callee2);}));return _getAutoSuggest2.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce-modules/search/get-auto-suggest-suggestions',action:getSearchSuggestionsAction,input:createInput});","map":{"version":3,"sources":["modules/search/actions/get-auto-suggest-suggestions.ts"],"names":[],"mappings":"8MAAA,OAAS,gBAAT,KAAiC,2CAAjC,CAEA,OACe,0BADf,KAGO,yBAHP,CAKA,OACI,yBADJ,KAEO,+EAFP,CAeA,UAAa,CAAA,gBAAb,CAOI,0BAAY,UAAZ,CAAiC,GAAjC,CAA+C,cAA/C,CAAwE,SAAxE,CAA4F,SAA5F,CAA8G,wCAQvG,KAAA,WAAA,CAAc,iDAAd,CACA,KAAA,kBAAA,CAAqB,iBAAM,8BAAN,EAArB,CACA,KAAA,aAAA,CAAgB,iBAAiB,MAAjB,EAAhB,CATH,KAAK,WAAL,CAAmB,UAAnB,CACA,KAAK,eAAL,CAAuB,GAAvB,CACA,KAAK,cAAL,CAAsB,cAAtB,CACA,KAAK,SAAL,CAAiB,SAAjB,CACA,KAAK,SAAL,CAAiB,SAAjB,CACH,CAbL,CAoBA,GAAM,CAAA,WAAW,CAAG,QAAd,CAAA,WAAc,CAAC,SAAD,CAAoC,CACpD,MAAO,IAAI,CAAA,gBAAJ,EAAP,CACH,CAFD,CAOA,eAAsB,CAAA,0BAAtB,mE,2HAAO,iBAA0C,KAA1C,CAAmE,GAAnE,2JAEC,CAAC,KAAD,EAAU,CAAC,KAAK,CAAC,WAFlB,+BAGO,IAAI,CAAA,KAAJ,CAAU,kEAAV,CAHP,QAMG,WANH,CAMkC,EANlC,CAQG,mBARH,CAQyB,CACxB,eAAe,CAAC,KAAD,CAAQ,WAAR,CAAqB,GAArB,CADS,CARzB,iCAWI,OAAO,CAAC,GAAR,CAAY,mBAAZ,EAAiC,IAAjC,CAAsC,UAAK,CAC9C,MAAO,CAAA,WAAP,CACH,CAFM,CAXJ,wD,qEAgBQ,CAAA,e,kKAAf,kBACI,KADJ,CAEI,WAFJ,CAGI,GAHJ,2JAKU,cALV,CAKqD,CAC7C,qBAAqB,CAAE,CACnB,eAAe,CAAE,KAAK,CAAC,WAAN,EAAqB,KAAK,CAAC,WAAN,CAAkB,MAAlB,CAA2B,CAAhD,CAAoD,KAAK,CAAC,WAA1D,CAAwE,EADtE,CAEnB,OAAO,CAAE,CACL,SAAS,CAAE,CAAC,GAAG,CAAC,cAAJ,CAAmB,WAAnB,CAA+B,SADtC,CAEL,SAAS,CAAE,CAAC,GAAG,CAAC,cAAJ,CAAmB,WAAnB,CAA+B,SAFtC,CAFU,CADsB,CAQ7C,SAAS,CAAE,KAAK,CAAC,SAR4B,CAS7C,SAAS,CAAE,KAAK,CAAC,SAT4B,CAU7C,cAAc,CAAE,KAAK,CAAC,cAVuB,CALrD,wBAkBoC,CAAA,yBAAyB,CACrD,CAAE,aAAa,CAAE,GAAjB,CAAsB,mBAAmB,CAAE,CAAE,MAAM,CAAE,CAAE,GAAG,CAAE,KAAK,CAAC,eAAb,CAAV,CAA3C,CADqD,CAErD,cAFqD,CAlB7D,QAkBU,iBAlBV,gBAuBI,GAAI,iBAAiB,EAAI,iBAAiB,CAAC,MAAlB,CAA2B,CAApD,CAAuD,CAEnD,iBAAiB,CAAC,GAAlB,CACI,SAAC,IAAD,QACK,CAAA,IAAI,CAAC,QAAL,CAAgB,IAAI,CAAC,QAAL,CAAgB,gBAAgB,CAAC,IAAI,CAAC,QAAN,CAAgB,GAAG,CAAC,cAAJ,CAAmB,WAAnC,CAAhC,CAAkF,EADvG,EADJ,EAKA,WAAW,CAAC,gBAAZ,CAA+B,iBAA/B,CACH,CARD,IAQO,CACH,GAAG,CAAC,SAAJ,CAAc,KAAd,oGAAgH,cAAc,CAAC,cAA/H,GACH,CAjCL,wD,kDAoCA,cAAe,CAAA,0BAA0B,CAAC,CACtC,EAAE,CAAE,gEADkC,CAEtC,MAAM,CAA4B,0BAFI,CAGtC,KAAK,CAAE,WAH+B,CAAD,CAAzC","sourcesContent":["import { generateImageUrl } from '@msdyn365-commerce-modules/retail-actions';\nimport { Autosuggestions } from '@msdyn365-commerce/commerce-entities';\nimport {\n    CacheType, createObservableDataAction, IAction, IActionContext, IActionInput,\n    ICreateActionContext\n} from '@msdyn365-commerce/core';\nimport { SearchSuggestion, SearchSuggestionCriteria } from '@msdyn365-commerce/retail-proxy';\nimport {\n    getSearchSuggestionsAsync\n} from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\n\n// @ts-ignore\nexport const enum SuggestionType {\n    Category = 'ScopedCategory',\n    Keyword = 'Keyword',\n    Product = 'Product',\n    None = 'None'\n}\n\n/**\n * Input class for auto suggest search input\n */\nexport class AutoSuggestInput implements IActionInput {\n    public searchQuery?: string;\n    public topResultsCount?: number;\n    public suggestionType?: string;\n    public hitPrefix?: string;\n    public hitSuffix?: string;\n\n    constructor(searchText?: string, top?: number, suggestionType?: string, hitPrefix?: string, hitSuffix?: string) {\n        this.searchQuery = searchText;\n        this.topResultsCount = top;\n        this.suggestionType = suggestionType;\n        this.hitPrefix = hitPrefix;\n        this.hitSuffix = hitSuffix;\n    }\n\n    public getCacheKey = () => `AutoSuggestSearchSuggestions`;\n    public getCacheObjectType = () => 'AutoSuggestSearchSuggestions';\n    public dataCacheType = (): CacheType => 'none';\n}\n\nconst createInput = (inputData: ICreateActionContext) => {\n    return new AutoSuggestInput();\n};\n\n/**\n * Calls the Retail API and returns a auto-suggest suggestions\n */\nexport async function getSearchSuggestionsAction(input: AutoSuggestInput, ctx: IActionContext): Promise<Autosuggestions | null> {\n    // If no input is provided fail out\n    if (!input || !input.searchQuery) {\n        throw new Error('[getSearchSuggestionsAction]No valid Input was provided, failing');\n    }\n\n    const autosuggest: Autosuggestions = {};\n\n    const autoSuggestPromises = [\n        _getAutoSuggest(input, autosuggest, ctx),\n    ];\n    return Promise.all(autoSuggestPromises).then(() => {\n        return autosuggest;\n    });\n}\n\nasync function _getAutoSuggest(\n    input: AutoSuggestInput,\n    autosuggest: Autosuggestions,\n    ctx: IActionContext\n): Promise<void> {\n    const searchCriteria: SearchSuggestionCriteria = {\n        ProductSearchCriteria: {\n            SearchCondition: input.searchQuery && input.searchQuery.length > 0 ? input.searchQuery : '',\n            Context: {\n                ChannelId: +ctx.requestContext.apiSettings.channelId,\n                CatalogId: +ctx.requestContext.apiSettings.catalogId\n            }\n        },\n        HitPrefix: input.hitPrefix,\n        HitSuffix: input.hitSuffix,\n        SuggestionType: input.suggestionType\n    };\n\n    const searchSuggestions = await getSearchSuggestionsAsync(\n        { callerContext: ctx, queryResultSettings: { Paging: { Top: input.topResultsCount } } },\n        searchCriteria\n    );\n\n    if (searchSuggestions && searchSuggestions.length > 0) {\n        // Generate image url\n        searchSuggestions.map(\n            (item: SearchSuggestion) =>\n                (item.ImageUrl = item.ImageUrl ? generateImageUrl(item.ImageUrl, ctx.requestContext.apiSettings) : '')\n        );\n\n        autosuggest.AllSearchResults = searchSuggestions;\n    } else {\n        ctx.telemetry.error(`[getSearchSuggestionsAction] unable to get availabilites for search with suggestion type ${searchCriteria.SuggestionType}`);\n    }\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/search/get-auto-suggest-suggestions',\n    action: <IAction<Autosuggestions>>getSearchSuggestionsAction,\n    input: createInput\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}