{"ast":null,"code":"import\"core-js/modules/es.array.reduce.js\";import\"core-js/modules/es.number.to-fixed.js\";import\"core-js/modules/es.promise.js\";import\"core-js/modules/es.regexp.to-string.js\";import\"core-js/modules/es.string.replace.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{getDimensionsForSelectedVariant,GetDimensionsForSelectedVariantInput,getFallbackImageUrl,getPriceForSelectedVariant,getProductAvailabilitiesForSelectedVariant,getSelectedVariant,PriceForSelectedVariantInput,ProductAvailabilitiesForSelectedVariantInput,SelectedVariantInput}from'@msdyn365-commerce-modules/retail-actions';import{Button}from'@msdyn365-commerce-modules/utilities';import{Image}from'@msdyn365-commerce/core';import classnames from'classnames';import React from'react';import{Dropdown}from'.';import OrderTemplateQuantity from'../common/order-template-quantity';export class ProductConfiguration extends React.Component{constructor(props){super(props);this._addToTemplateHandler=async event=>{this.setState({isBusy:true,showAddConfirmation:false,showAddError:false});this.props.addToTemplateHandler(_objectSpread({},this.state)).then(status=>{if(status.ProductListId){this.setState({isBusy:false,showAddConfirmation:true});}}).catch(error=>{this.setState({isBusy:false,showAddError:true});this.props.context.telemetry.error('Error adding item to order template');});};this._onQuantityChange=newValue=>{this.setState({quantity:newValue,totalPrice:newValue*this.props.product.Price});};this._onDimensionChanged=async selection=>{this.setState({isBusy:false,showAddConfirmation:false,showAddError:false,buttonDisabled:true});const{product,dimensions,context}=this.props;const{actionContext,request:{apiSettings:{channelId}}}=context;const mappedDimensions=dimensions===null||dimensions===void 0?void 0:dimensions.map(dimension=>{var _dimension$DimensionV;return{DimensionTypeValue:dimension.DimensionTypeValue,DimensionValue:(_dimension$DimensionV=dimension.DimensionValues)===null||_dimension$DimensionV===void 0?void 0:_dimension$DimensionV.find(value=>value.RecordId===+selection.selectId),ExtensionProperties:dimension.ExtensionProperties};}).filter(dimension=>{return dimension&&dimension.DimensionValue;});mappedDimensions.forEach(dimension=>{this.state.selectedDimensions[dimension.DimensionTypeValue]=dimension.DimensionValue;});const variantProduct=await getSelectedVariant(new SelectedVariantInput(product.MasterProductId?product.MasterProductId:product.RecordId,channelId,mappedDimensions),actionContext);if(!variantProduct){this.props.context.telemetry.error(\"Error retrieving variant product for product \".concat(product.MasterProductId?product.MasterProductId:product.RecordId));return;}const dimensionInput=new GetDimensionsForSelectedVariantInput(variantProduct.RecordId,channelId,mappedDimensions);const variantDimensions=await getDimensionsForSelectedVariant(dimensionInput,actionContext);if(!variantDimensions){this.props.context.telemetry.error('Error retrieving dimensions for reconfigured product variant');this.setState({buttonDisabled:false});return;}const availabilityInput=new ProductAvailabilitiesForSelectedVariantInput(product.MasterProductId?product.MasterProductId:product.RecordId,channelId);const newAvailableQuantity=await getProductAvailabilitiesForSelectedVariant(availabilityInput,actionContext);const priceInput=new PriceForSelectedVariantInput(product.RecordId,channelId);const productPrice=await getPriceForSelectedVariant(priceInput,actionContext);if(!productPrice){this.props.context.telemetry.error('Error retrieving price for reconfigured product variant');this.setState({buttonDisabled:false});return;}this.setState({buttonDisabled:false,productAvailableQuantity:newAvailableQuantity&&newAvailableQuantity[0]||undefined,unitPrice:+(productPrice.BasePrice||product.Price),dimensions:variantDimensions,product:variantProduct});};this._getDropdownName=(dimensionType,resources)=>{switch(dimensionType){case 1:return resources.productDimensionTypeColor;case 2:return resources.productDimensionTypeConfiguration;case 3:return resources.productDimensionTypeSize;case 4:return resources.productDimensionTypeStyle;default:return'';}};this.state={quantity:1,unitPrice:props.product.Price,totalPrice:props.product.Price,product:props.product,dimensions:props.dimensions,selectedDimensions:{},buttonDisabled:false,showAddConfirmation:false,showAddError:false};this.selectedDimensions=props.dimensions.reduce((result,d)=>{result[\"\".concat(d.DimensionTypeValue)]=d.DimensionValues[0].Value;return result;},{});}render(){const{context:{actionContext:{requestContext:{apiSettings}},request:{gridSettings}},resources:{addItemToTemplateText,addLineProductUnitPricePrefix,decrementButtonAriaLabel,incrementButtonAriaLabel,quantitySelectLabel,addLineProductUnitOfMeasurePrefix,addToTemplateConfirmation,addToTemplateError,totalPriceLabel},imageSettings,highlightSearchTerm}=this.props;const{buttonDisabled,product,quantity,unitPrice,totalPrice,showAddConfirmation,showAddError}=this.state;const confirmationMessage=addToTemplateConfirmation.replace('{count}',this.state.quantity.toString()).replace('{productAndDimensions}',\"\".concat(this.state.product.Name,\", \").concat(Object.values(this.selectedDimensions).join(', ')));return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product-config'},/*#__PURE__*/React.createElement(Image,{src:(product===null||product===void 0?void 0:product.PrimaryImageUrl)||'',fallBackSrc:getFallbackImageUrl(product===null||product===void 0?void 0:product.ItemId,apiSettings)||'',className:'thumbnail',imageSettings:imageSettings,gridSettings:gridSettings,loadFailureBehavior:'empty'}),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__attributes'},/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__id'},product===null||product===void 0?void 0:product.RecordId),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__name'},highlightSearchTerm((product===null||product===void 0?void 0:product.Name)||'')),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__unit-price'},addLineProductUnitPricePrefix,\" \",this._formatPrice(unitPrice)),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__uom'},addLineProductUnitOfMeasurePrefix,\" \",product===null||product===void 0?void 0:product.DefaultUnitOfMeasure)),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product-config__dimensions'},this._getDimensionsNodes())),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{className:'quantity-container'},/*#__PURE__*/React.createElement(\"div\",null,quantitySelectLabel),/*#__PURE__*/React.createElement(OrderTemplateQuantity,{id:'msc-add-line-to-template__product-config__quantity',currentCount:quantity,onChange:this._onQuantityChange,inputQuantityAriaLabel:'Press to increment quantity by 1',max:Number.MAX_VALUE,decrementButtonAriaLabel:decrementButtonAriaLabel,incrementButtonAriaLabel:incrementButtonAriaLabel})),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__total-price'},totalPriceLabel,\" \",this._formatPrice(totalPrice)))),showAddConfirmation&&/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__add-success msc-alert-success msc-alert'},/*#__PURE__*/React.createElement(\"span\",{\"aria-hidden\":'true'}),confirmationMessage),showAddError&&/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__add-error msc-alert-danger msc-alert'},/*#__PURE__*/React.createElement(\"span\",{className:'msi-exclamation-triangle',\"aria-hidden\":'true'}),addToTemplateError),/*#__PURE__*/React.createElement(Button,{className:classnames('msc-add-line-to-template__add-configured-product-button',{'is-busy':this.state.isBusy}),\"aria-label\":addItemToTemplateText,onClick:this._addToTemplateHandler,disabled:buttonDisabled},addItemToTemplateText));}_getDimensionsNodes(){const{dimensions}=this.state;const{resources}=this.props;return dimensions===null||dimensions===void 0?void 0:dimensions.map(dimension=>{const{DimensionValues,DimensionTypeValue}=dimension;const mapDimensions=value=>({id:value.RecordId,value:value.Value||''});const dropdownList=DimensionValues?DimensionValues.map(mapDimensions):[];return/*#__PURE__*/React.createElement(\"div\",{key:DimensionTypeValue},/*#__PURE__*/React.createElement(\"div\",null,this._getDropdownName(DimensionTypeValue,resources)),/*#__PURE__*/React.createElement(Dropdown,{dropdownId:DimensionTypeValue,dropdownName:this._getDropdownName(DimensionTypeValue,resources),dropdownList:dropdownList,onChange:this._onDimensionChanged}));});}_formatPrice(price){const{context:{cultureFormatter:{formatCurrency,currencyCode}}}=this.props;return formatCurrency(price.toFixed(2),currencyCode);}}","map":{"version":3,"sources":["modules/order-template/components/add-line/product-configuration.tsx"],"names":[],"mappings":"snCAAA,OACI,+BADJ,CAEI,oCAFJ,CAGI,mBAHJ,CAII,0BAJJ,CAKI,0CALJ,CAMI,kBANJ,CAQI,4BARJ,CASI,4CATJ,CAUI,oBAVJ,KAWQ,2CAXR,CAYA,OAAS,MAAT,KAA0C,sCAA1C,CAEA,OAAyB,KAAzB,KAAsC,yBAAtC,CAGA,MAAO,CAAA,UAAP,KAAuB,YAAvB,CACA,MAAO,CAAA,KAAP,KAAkB,OAAlB,CACA,OAAS,QAAT,KAAyH,GAAzH,CACA,MAAO,CAAA,qBAAP,KAAkC,mCAAlC,CA4BA,MAAM,MAAO,CAAA,oBAAP,QAAoC,CAAA,KAAK,CAAC,SAAiE,CAG7G,WAAA,CAAY,KAAZ,CAA6C,CACzC,MAAM,KAAN,EAgII,KAAA,qBAAA,CAAwB,KAAO,CAAA,KAAP,EAAiE,CAE7F,KAAK,QAAL,CAAc,CACV,MAAM,CAAE,IADE,CAEV,mBAAmB,CAAE,KAFX,CAGV,YAAY,CAAE,KAHJ,CAAd,EAMA,KAAK,KAAL,CAAW,oBAAX,kBAAoC,KAAK,KAAzC,GACK,IADL,CACU,MAAM,EAAG,CAEX,GAAI,MAAM,CAAC,aAAX,CAA0B,CACtB,KAAK,QAAL,CAAc,CACV,MAAM,CAAE,KADE,CAEV,mBAAmB,CAAE,IAFX,CAAd,EAIH,CACJ,CATL,EASO,KATP,CASa,KAAK,EAAG,CACb,KAAK,QAAL,CAAc,CACV,MAAM,CAAE,KADE,CAEV,YAAY,CAAE,IAFJ,CAAd,EAIA,KAAK,KAAL,CAAW,OAAX,CAAmB,SAAnB,CAA6B,KAA7B,CAAmC,qCAAnC,EACH,CAfL,EAgBH,CAxBO,CA0BA,KAAA,iBAAA,CAAqB,QAAD,EAAqB,CAC7C,KAAK,QAAL,CAAc,CACV,QAAQ,CAAE,QADA,CAEV,UAAU,CAAE,QAAQ,CAAG,KAAK,KAAL,CAAW,OAAX,CAAmB,KAFhC,CAAd,EAIH,CALO,CAQA,KAAA,mBAAA,CAAsB,KAAO,CAAA,SAAP,EAAyD,CACnF,KAAK,QAAL,CAAc,CACV,MAAM,CAAE,KADE,CAEV,mBAAmB,CAAE,KAFX,CAGV,YAAY,CAAE,KAHJ,CAIV,cAAc,CAAE,IAJN,CAAd,EAOA,KAAM,CAAE,OAAF,CAAW,UAAX,CAAuB,OAAvB,EAAmC,KAAK,KAA9C,CACA,KAAM,CACF,aADE,CAEF,OAAO,CAAE,CAAE,WAAW,CAAE,CAAE,SAAF,CAAf,CAFP,EAGF,OAHJ,CAKA,KAAM,CAAA,gBAAgB,CAAG,UAAH,SAAG,UAAH,iBAAG,UAAU,CAAE,GAAZ,CAAgB,SAAS,EAAG,2BACjD,MAAO,CACH,kBAAkB,CAAE,SAAS,CAAC,kBAD3B,CAEH,cAAc,wBAAE,SAAS,CAAC,eAAZ,gDAAE,sBAA2B,IAA3B,CAAgC,KAAK,EAAI,KAAK,CAAC,QAAN,GAAmB,CAAC,SAAS,CAAC,QAAvE,CAFb,CAGH,mBAAmB,CAAE,SAAS,CAAC,mBAH5B,CAAP,CAKH,CANwB,EAMtB,MANsB,CAMf,SAAS,EAAG,CAClB,MAAO,CAAA,SAAS,EAAI,SAAS,CAAC,cAA9B,CACH,CARwB,CAAzB,CAUA,gBAAgB,CAAC,OAAjB,CAAyB,SAAS,EAAG,CACjC,KAAK,KAAL,CAAW,kBAAX,CAA8B,SAAS,CAAC,kBAAxC,EAA8D,SAAS,CAAC,cAAxE,CACH,CAFD,EAIA,KAAM,CAAA,cAAc,CAAI,KAAM,CAAA,kBAAkB,CAC5C,GAAI,CAAA,oBAAJ,CACI,OAAO,CAAC,eAAR,CAA0B,OAAO,CAAC,eAAlC,CAAoD,OAAO,CAAC,QADhE,CAEI,SAFJ,CAGI,gBAHJ,CAD4C,CAM5C,aAN4C,CAAhD,CASA,GAAI,CAAC,cAAL,CAAqB,CACjB,KAAK,KAAL,CAAW,OAAX,CAAmB,SAAnB,CAA6B,KAA7B,wDAAmF,OAAO,CAAC,eAAR,CAA0B,OAAO,CAAC,eAAlC,CAAoD,OAAO,CAAC,QAA/I,GACA,OACH,CAED,KAAM,CAAA,cAAc,CAAG,GAAI,CAAA,oCAAJ,CACnB,cAAc,CAAC,QADI,CAEnB,SAFmB,CAGnB,gBAHmB,CAAvB,CAKA,KAAM,CAAA,iBAAiB,CAAG,KAAM,CAAA,+BAA+B,CAAC,cAAD,CAAiB,aAAjB,CAA/D,CAEA,GAAI,CAAC,iBAAL,CAAwB,CACpB,KAAK,KAAL,CAAW,OAAX,CAAmB,SAAnB,CAA6B,KAA7B,CAAmC,8DAAnC,EACA,KAAK,QAAL,CAAc,CACV,cAAc,CAAE,KADN,CAAd,EAGA,OACH,CAED,KAAM,CAAA,iBAAiB,CAAG,GAAI,CAAA,4CAAJ,CACtB,OAAO,CAAC,eAAR,CAA0B,OAAO,CAAC,eAAlC,CAAoD,OAAO,CAAC,QADtC,CAEtB,SAFsB,CAA1B,CAKA,KAAM,CAAA,oBAAoB,CAAG,KAAM,CAAA,0CAA0C,CAAC,iBAAD,CAAoB,aAApB,CAA7E,CACA,KAAM,CAAA,UAAU,CAAG,GAAI,CAAA,4BAAJ,CAAiC,OAAO,CAAC,QAAzC,CAAmD,SAAnD,CAAnB,CACA,KAAM,CAAA,YAAY,CAAG,KAAM,CAAA,0BAA0B,CAAC,UAAD,CAAa,aAAb,CAArD,CAEA,GAAI,CAAC,YAAL,CAAmB,CACf,KAAK,KAAL,CAAW,OAAX,CAAmB,SAAnB,CAA6B,KAA7B,CAAmC,yDAAnC,EACA,KAAK,QAAL,CAAc,CACV,cAAc,CAAE,KADN,CAAd,EAGA,OACH,CAED,KAAK,QAAL,CAAc,CACV,cAAc,CAAE,KADN,CAEV,wBAAwB,CAAE,oBAAoB,EAAI,oBAAoB,CAAC,CAAD,CAA5C,EAAmD,SAFnE,CAGV,SAAS,CAAE,EAAE,YAAY,CAAC,SAAb,EAA0B,OAAO,CAAC,KAApC,CAHD,CAIV,UAAU,CAAE,iBAJF,CAKV,OAAO,CAAE,cALC,CAAd,EAOH,CAjFO,CAmFA,KAAA,gBAAA,CAAmB,CAAC,aAAD,CAAwB,SAAxB,GAA0E,CACjG,OAAQ,aAAR,EACI,IAAK,EAAL,CACI,MAAO,CAAA,SAAS,CAAC,yBAAjB,CACJ,IAAK,EAAL,CACI,MAAO,CAAA,SAAS,CAAC,iCAAjB,CACJ,IAAK,EAAL,CACI,MAAO,CAAA,SAAS,CAAC,wBAAjB,CACJ,IAAK,EAAL,CACI,MAAO,CAAA,SAAS,CAAC,yBAAjB,CACJ,QACI,MAAO,EAAP,CAVR,CAYH,CAbO,CAnPJ,KAAK,KAAL,CAAa,CACT,QAAQ,CAAE,CADD,CAET,SAAS,CAAE,KAAK,CAAC,OAAN,CAAc,KAFhB,CAGT,UAAU,CAAE,KAAK,CAAC,OAAN,CAAc,KAHjB,CAIT,OAAO,CAAE,KAAK,CAAC,OAJN,CAKT,UAAU,CAAE,KAAK,CAAC,UALT,CAMT,kBAAkB,CAAE,EANX,CAOT,cAAc,CAAE,KAPP,CAQT,mBAAmB,CAAE,KARZ,CAST,YAAY,CAAE,KATL,CAAb,CAYA,KAAK,kBAAL,CAA0B,KAAK,CAAC,UAAN,CAAiB,MAAjB,CAAwB,CAAC,MAAD,CAAS,CAAT,GAAc,CAC5D,MAAM,WAAI,CAAC,CAAC,kBAAN,EAAN,CAAoC,CAAC,CAAC,eAAF,CAAmB,CAAnB,EAAsB,KAA1D,CACA,MAAO,CAAA,MAAP,CACH,CAHyB,CAGwB,EAHxB,CAA1B,CAIH,CAEM,MAAM,EAAA,CACT,KAAM,CACF,OAAO,CAAE,CACL,aAAa,CAAE,CACX,cAAc,CAAE,CAAE,WAAF,CADL,CADV,CAIL,OAAO,CAAE,CAAE,YAAF,CAJJ,CADP,CAOD,SAAS,CAAE,CACR,qBADQ,CAER,6BAFQ,CAGR,wBAHQ,CAIR,wBAJQ,CAKR,mBALQ,CAMR,iCANQ,CAOR,yBAPQ,CAQR,kBARQ,CASR,eATQ,CAPV,CAkBF,aAlBE,CAmBF,mBAnBE,EAoBF,KAAK,KApBT,CAqBA,KAAM,CAAE,cAAF,CAAkB,OAAlB,CAA2B,QAA3B,CAAqC,SAArC,CAAgD,UAAhD,CAA4D,mBAA5D,CAAiF,YAAjF,EAAkG,KAAK,KAA7G,CAEA,KAAM,CAAA,mBAAmB,CAAG,yBAAyB,CAChD,OADuB,CACf,SADe,CACJ,KAAK,KAAL,CAAW,QAAX,CAAoB,QAApB,EADI,EAEvB,OAFuB,CAEf,wBAFe,WAEc,KAAK,KAAL,CAAW,OAAX,CAAmB,IAFjC,cAE0C,MAAM,CAAC,MAAP,CAAc,KAAK,kBAAnB,EAAuC,IAAvC,CAA4C,IAA5C,CAF1C,EAA5B,CAIA,mBACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,CAAA,IAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,0CAAf,CAAA,cACI,KAAA,CAAA,aAAA,CAAC,KAAD,CAAM,CACF,GAAG,CAAE,CAAA,OAAO,OAAP,EAAA,OAAO,SAAP,QAAA,OAAO,CAAE,eAAT,GAA4B,EAD/B,CAEF,WAAW,CACP,mBAAmB,CAAC,OAAD,SAAC,OAAD,iBAAC,OAAO,CAAE,MAAV,CAAkB,WAAlB,CAAnB,EAAqD,EAHvD,CAKF,SAAS,CAAE,WALT,CAMF,aAAa,CAAE,aANb,CAOF,YAAY,CAAE,YAPZ,CAQF,mBAAmB,CAAC,OARlB,CAAN,CADJ,cAWI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,+CAAf,CAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,IAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,uCAAf,CAAA,CAAwD,OAAxD,SAAwD,OAAxD,iBAAwD,OAAO,CAAE,QAAjE,CADJ,cAEI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,yCAAf,CAAA,CAA0D,mBAAmB,CAAC,CAAA,OAAO,OAAP,EAAA,OAAO,SAAP,QAAA,OAAO,CAAE,IAAT,GAAiB,EAAlB,CAA7E,CAFJ,cAGI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,+CAAf,CAAA,CAAgE,6BAAhE,C,GAAA,CAAgG,KAAK,YAAL,CAAkB,SAAlB,CAAhG,CAHJ,cAII,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,wCAAf,CAAA,CAAyD,iCAAzD,C,GAAA,CAA6F,OAA7F,SAA6F,OAA7F,iBAA6F,OAAO,CAAE,oBAAtG,CAJJ,CADJ,cAOI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,sDAAf,CAAA,CACK,KAAK,mBAAL,EADL,CAPJ,CAXJ,cAsBI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,IAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,oBAAf,CAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,IAAA,CAAM,mBAAN,CADJ,cAEI,KAAA,CAAA,aAAA,CAAC,qBAAD,CAAsB,CAClB,EAAE,CAAE,oDADc,CAElB,YAAY,CAAE,QAFI,CAGlB,QAAQ,CAAE,KAAK,iBAHG,CAIlB,sBAAsB,CAAC,kCAJL,CAKlB,GAAG,CAAE,MAAM,CAAC,SALM,CAMlB,wBAAwB,CAAE,wBANR,CAOlB,wBAAwB,CAAE,wBAPR,CAAtB,CAFJ,CADJ,cAaI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,gDAAf,CAAA,CAAiE,eAAjE,C,GAAA,CAAmF,KAAK,YAAL,CAAkB,UAAlB,CAAnF,CAbJ,CAtBJ,CADJ,CAuCK,mBAAmB,eAAI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,mEAAf,CAAA,cAAmF,KAAA,CAAA,aAAA,CAAA,MAAA,CAAA,CAAA,cAAkB,MAAlB,CAAA,CAAnF,CAA8G,mBAA9G,CAvC5B,CAwCK,YAAY,eAAI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,SAAS,CAAC,gEAAf,CAAA,cAAgF,KAAA,CAAA,aAAA,CAAA,MAAA,CAAA,CAAM,SAAS,CAAC,0BAAhB,CAA0C,cAAa,MAAvD,CAAA,CAAhF,CAAgJ,kBAAhJ,CAxCrB,cAyCQ,KAAA,CAAA,aAAA,CAAC,MAAD,CAAO,CACH,SAAS,CAAE,UAAU,CAAC,yDAAD,CAA4D,CAAE,UAAW,KAAK,KAAL,CAAW,MAAxB,CAA5D,CADlB,CAC+G,aACtG,qBAFT,CAGH,OAAO,CAAE,KAAK,qBAHX,CAIH,QAAQ,CAAE,cAJP,CAAP,CAMK,qBANL,CAzCR,CADJ,CAoDH,CAEO,mBAAmB,EAAA,CACvB,KAAM,CAAE,UAAF,EAAiB,KAAK,KAA5B,CACA,KAAM,CAAE,SAAF,EAAgB,KAAK,KAA3B,CAEA,MAAO,CAAA,UAAP,SAAO,UAAP,iBAAO,UAAU,CAAE,GAAZ,CAAiB,SAAD,EAAoC,CACvD,KAAM,CAAE,eAAF,CAAmB,kBAAnB,EAA0C,SAAhD,CACA,KAAM,CAAA,aAAa,CAAI,KAAD,GAAuD,CACzE,EAAE,CAAE,KAAK,CAAC,QAD+D,CAEzE,KAAK,CAAE,KAAK,CAAC,KAAN,EAAe,EAFmD,CAAvD,CAAtB,CAIA,KAAM,CAAA,YAAY,CAAyB,eAAe,CAAG,eAAe,CAAC,GAAhB,CAAwC,aAAxC,CAAH,CAA4D,EAAtH,CAEA,mBACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,CAAK,GAAG,CAAE,kBAAV,CAAA,cACI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,IAAA,CAAM,KAAK,gBAAL,CAAsB,kBAAtB,CAA0C,SAA1C,CAAN,CADJ,cAEI,KAAA,CAAA,aAAA,CAAC,QAAD,CAAS,CACL,UAAU,CAAE,kBADP,CAEL,YAAY,CAAE,KAAK,gBAAL,CAAsB,kBAAtB,CAA0C,SAA1C,CAFT,CAGL,YAAY,CAAE,YAHT,CAIL,QAAQ,CAAE,KAAK,mBAJV,CAAT,CAFJ,CADJ,CAWH,CAnBM,CAAP,CAoBH,CAsIO,YAAY,CAAC,KAAD,CAAc,CAC9B,KAAM,CACF,OAAO,CAAE,CACL,gBAAgB,CAAE,CACd,cADc,CAGd,YAHc,CADb,CADP,EAQF,KAAK,KART,CAUA,MAAO,CAAA,cAAc,CAAC,KAAK,CAAC,OAAN,CAAc,CAAd,CAAD,CAAmB,YAAnB,CAArB,CACH,CApR4G","sourcesContent":["import {\n    getDimensionsForSelectedVariant,\n    GetDimensionsForSelectedVariantInput,\n    getFallbackImageUrl,\n    getPriceForSelectedVariant,\n    getProductAvailabilitiesForSelectedVariant,\n    getSelectedVariant,\n    IProductInventoryInformation,\n    PriceForSelectedVariantInput,\n    ProductAvailabilitiesForSelectedVariantInput,\n    SelectedVariantInput\n } from '@msdyn365-commerce-modules/retail-actions';\nimport { Button, ITelemetryContent } from '@msdyn365-commerce-modules/utilities';\nimport { ProductDimensionFull } from '@msdyn365-commerce/commerce-entities';\nimport { IImageSettings, Image } from '@msdyn365-commerce/core';\nimport { ProductDimensionValue, ProductListLine } from '@msdyn365-commerce/retail-proxy';\nimport { SimpleProduct } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport classnames from 'classnames';\nimport React from 'react';\nimport { Dropdown, IAddLineToTemplateProps, IAddLineToTemplateResources, IDropdownItemProps, IDropdownOnSelection } from '.';\nimport OrderTemplateQuantity from '../common/order-template-quantity';\n\nexport interface IProductCnnfigurationProps extends IAddLineToTemplateProps {\n    product: SimpleProduct;\n    dimensions: ProductDimensionFull[];\n    imageSettings: IImageSettings;\n    telemetryContent?: ITelemetryContent;\n    addToTemplateHandler(params: IProductConfigurationState): Promise<ProductListLine>;\n    highlightSearchTerm(name: string): React.ReactNode;\n}\n\nexport interface IProductConfigurationState {\n    quantity: number;\n    unitPrice: number;\n    totalPrice: number;\n    product: SimpleProduct;\n    dimensions: ProductDimensionFull[];\n    selectedDimensions: {};\n    productAvailableQuantity?: IProductInventoryInformation;\n    buttonDisabled: boolean;\n    showAddConfirmation: boolean;\n    showAddError: boolean;\n    isBusy: boolean;\n}\n\n/**\n * Configure selected product for addition to order template\n */\nexport class ProductConfiguration extends React.Component<IProductCnnfigurationProps, IProductConfigurationState> {\n    private selectedDimensions: {};\n\n    constructor(props: IProductCnnfigurationProps) {\n        super(props);\n\n        this.state = {\n            quantity: 1,\n            unitPrice: props.product.Price,\n            totalPrice: props.product.Price,\n            product: props.product,\n            dimensions: props.dimensions,\n            selectedDimensions: {},\n            buttonDisabled: false,\n            showAddConfirmation: false,\n            showAddError: false\n        } as IProductConfigurationState;\n\n        this.selectedDimensions = props.dimensions.reduce((result, d) => {\n            result[`${d.DimensionTypeValue}`] = d.DimensionValues![0].Value;\n            return result;\n        },                                                {});\n    }\n\n    public render(): JSX.Element {\n        const {\n            context: {\n                actionContext: {\n                    requestContext: { apiSettings }\n                },\n                request: { gridSettings }\n             },\n             resources: {\n                addItemToTemplateText,\n                addLineProductUnitPricePrefix,\n                decrementButtonAriaLabel,\n                incrementButtonAriaLabel,\n                quantitySelectLabel,\n                addLineProductUnitOfMeasurePrefix,\n                addToTemplateConfirmation,\n                addToTemplateError,\n                totalPriceLabel\n            },\n            imageSettings,\n            highlightSearchTerm\n        } = this.props;\n        const { buttonDisabled, product, quantity, unitPrice, totalPrice, showAddConfirmation, showAddError } = this.state;\n\n        const confirmationMessage = addToTemplateConfirmation\n            .replace('{count}', this.state.quantity.toString())\n            .replace('{productAndDimensions}', `${this.state.product.Name}, ${Object.values(this.selectedDimensions).join(', ')}`);\n\n        return (\n            <>\n                <div className='msc-add-line-to-template__product-config'>\n                    <Image\n                        src={product?.PrimaryImageUrl || ''}\n                        fallBackSrc={\n                            getFallbackImageUrl(product?.ItemId, apiSettings) || ''\n                        }\n                        className={'thumbnail'}\n                        imageSettings={imageSettings}\n                        gridSettings={gridSettings!}\n                        loadFailureBehavior='empty'\n                    />\n                    <div className='msc-add-line-to-template__product__attributes'>\n                        <div>\n                            <div className='msc-add-line-to-template__product__id'>{product?.RecordId}</div>\n                            <div className='msc-add-line-to-template__product__name'>{highlightSearchTerm(product?.Name || '')}</div>\n                            <div className='msc-add-line-to-template__product__unit-price'>{addLineProductUnitPricePrefix} {this._formatPrice(unitPrice)}</div>\n                            <div className='msc-add-line-to-template__product__uom'>{addLineProductUnitOfMeasurePrefix} {product?.DefaultUnitOfMeasure}</div>\n                        </div>\n                        <div className='msc-add-line-to-template__product-config__dimensions'>\n                            {this._getDimensionsNodes()}\n                        </div>\n                    </div>\n                    <div>\n                        <div className='quantity-container'>\n                            <div>{quantitySelectLabel}</div>\n                            <OrderTemplateQuantity\n                                id={'msc-add-line-to-template__product-config__quantity'}\n                                currentCount={quantity}\n                                onChange={this._onQuantityChange}\n                                inputQuantityAriaLabel='Press to increment quantity by 1'\n                                max={Number.MAX_VALUE}\n                                decrementButtonAriaLabel={decrementButtonAriaLabel}\n                                incrementButtonAriaLabel={incrementButtonAriaLabel}\n                            />\n                        </div>\n                        <div className='msc-add-line-to-template__product__total-price'>{totalPriceLabel} {this._formatPrice(totalPrice)}</div>\n                    </div>\n                </div>\n                {showAddConfirmation && <div className='msc-add-line-to-template__add-success msc-alert-success msc-alert'><span aria-hidden='true'/>{confirmationMessage}</div>}\n                {showAddError && <div className='msc-add-line-to-template__add-error msc-alert-danger msc-alert'><span className='msi-exclamation-triangle' aria-hidden='true'/>{addToTemplateError}</div>}\n                    <Button\n                        className={classnames('msc-add-line-to-template__add-configured-product-button', { 'is-busy': this.state.isBusy })}\n                        aria-label={addItemToTemplateText}\n                        onClick={this._addToTemplateHandler}\n                        disabled={buttonDisabled}\n                    >\n                        {addItemToTemplateText}\n                    </Button>\n            </>\n        );\n    }\n\n    private _getDimensionsNodes(): React.ReactElement[] {\n        const { dimensions } = this.state;\n        const { resources } = this.props;\n\n        return dimensions?.map((dimension: ProductDimensionFull) => {\n            const { DimensionValues, DimensionTypeValue } = dimension;\n            const mapDimensions = (value: ProductDimensionValue): IDropdownItemProps => ({\n                id: value.RecordId,\n                value: value.Value || ''\n            });\n            const dropdownList: IDropdownItemProps[] = DimensionValues ? DimensionValues.map<IDropdownItemProps>(mapDimensions) : [];\n\n            return (\n                <div key={DimensionTypeValue}>\n                    <div>{this._getDropdownName(DimensionTypeValue, resources)}</div>\n                    <Dropdown\n                        dropdownId={DimensionTypeValue}\n                        dropdownName={this._getDropdownName(DimensionTypeValue, resources)}\n                        dropdownList={dropdownList}\n                        onChange={this._onDimensionChanged}\n                    />\n                </div>\n            );\n        });\n    }\n\n    private _addToTemplateHandler = async (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => {\n        // hide confirmation when adding multiple items\n        this.setState({\n            isBusy: true,\n            showAddConfirmation: false,\n            showAddError: false\n        });\n\n        this.props.addToTemplateHandler({...this.state})\n            .then(status => {\n                // validate against the existance of a ProductListId\n                if (status.ProductListId) {\n                    this.setState({\n                        isBusy: false,\n                        showAddConfirmation: true\n                    });\n                }\n            }).catch(error => {\n                this.setState({\n                    isBusy: false,\n                    showAddError: true\n                });\n                this.props.context.telemetry.error('Error adding item to order template');\n            });\n    };\n\n    private _onQuantityChange = (newValue: number) => {\n        this.setState({\n            quantity: newValue,\n            totalPrice: newValue * this.props.product.Price\n        });\n    }\n\n    // rehydrate the selected variants price, available dimensions & sizes\n    private _onDimensionChanged = async (selection: IDropdownOnSelection): Promise<void> => {\n        this.setState({\n            isBusy: false,\n            showAddConfirmation: false,\n            showAddError: false,\n            buttonDisabled: true\n        });\n\n        const { product, dimensions, context } = this.props;\n        const {\n            actionContext,\n            request: { apiSettings: { channelId } }\n        } = context;\n\n        const mappedDimensions = dimensions?.map(dimension => {\n            return {\n                DimensionTypeValue: dimension.DimensionTypeValue,\n                DimensionValue: dimension.DimensionValues?.find(value => value.RecordId === +selection.selectId),\n                ExtensionProperties: dimension.ExtensionProperties\n            };\n        }).filter(dimension => {\n            return dimension && dimension.DimensionValue;\n        });\n\n        mappedDimensions.forEach(dimension => {\n            this.state.selectedDimensions[dimension.DimensionTypeValue] = dimension.DimensionValue;\n        });\n\n        const variantProduct = (await getSelectedVariant(\n            new SelectedVariantInput(\n                product.MasterProductId ? product.MasterProductId : product.RecordId,\n                channelId,\n                mappedDimensions\n            ),\n            actionContext\n        ));\n\n        if (!variantProduct) {\n            this.props.context.telemetry.error(`Error retrieving variant product for product ${product.MasterProductId ? product.MasterProductId : product.RecordId}`);\n            return;\n        }\n\n        const dimensionInput = new GetDimensionsForSelectedVariantInput(\n            variantProduct.RecordId,\n            channelId,\n            mappedDimensions\n        );\n        const variantDimensions = await getDimensionsForSelectedVariant(dimensionInput, actionContext);\n\n        if (!variantDimensions) {\n            this.props.context.telemetry.error('Error retrieving dimensions for reconfigured product variant');\n            this.setState({\n                buttonDisabled: false\n            });\n            return;\n        }\n\n        const availabilityInput = new ProductAvailabilitiesForSelectedVariantInput(\n            product.MasterProductId ? product.MasterProductId : product.RecordId,\n            channelId\n        );\n        // @TODO sync UX quantity w/ actual availibility\n        const newAvailableQuantity = await getProductAvailabilitiesForSelectedVariant(availabilityInput, actionContext);\n        const priceInput = new PriceForSelectedVariantInput(product.RecordId, channelId);\n        const productPrice = await getPriceForSelectedVariant(priceInput, actionContext);\n\n        if (!productPrice) {\n            this.props.context.telemetry.error('Error retrieving price for reconfigured product variant');\n            this.setState({\n                buttonDisabled: false\n            });\n            return;\n        }\n\n        this.setState({\n            buttonDisabled: false,\n            productAvailableQuantity: newAvailableQuantity && newAvailableQuantity[0] || undefined,\n            unitPrice: +(productPrice.BasePrice || product.Price),\n            dimensions: variantDimensions,\n            product: variantProduct\n        });\n    }\n\n    private _getDropdownName = (dimensionType: number, resources: IAddLineToTemplateResources): string => {\n        switch (dimensionType) {\n            case 1: // Color\n                return resources.productDimensionTypeColor;\n            case 2: // Configuration\n                return resources.productDimensionTypeConfiguration;\n            case 3: // Size\n                return resources.productDimensionTypeSize;\n            case 4: // Style\n                return resources.productDimensionTypeStyle;\n            default:\n                return '';\n        }\n    };\n\n    private _formatPrice(price: number): string {\n        const {\n            context: {\n                cultureFormatter: {\n                    formatCurrency,\n                    // @ts-ignore\n                    currencyCode\n                }\n            }\n        } = this.props;\n\n        return formatCurrency(price.toFixed(2), currencyCode);\n    }\n}"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}