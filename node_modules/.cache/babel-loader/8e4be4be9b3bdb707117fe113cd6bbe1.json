{"ast":null,"code":"import\"core-js/modules/es.number.to-fixed.js\";import\"core-js/modules/es.promise.js\";import\"core-js/modules/es.regexp.to-string.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{__decorate}from\"tslib\";import classnames from'classnames';import{computed,reaction,when}from'mobx';import{observer}from'mobx-react';import*as React from'react';import{withModuleState}from'@msdyn365-commerce-modules/checkout-utilities';import{GetLoyaltyTransactionEstimationInput}from'@msdyn365-commerce-modules/retail-actions';import{Button,Drawer,Heading}from'@msdyn365-commerce-modules/utilities';import{PriceComponent}from'@msdyn365-commerce/components';import{callActionOrExecute}from'@msdyn365-commerce/retail-proxy';import{createGetMaxLoyaltyPointsToRedeemForTransactionBalanceInput}from'@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';import InputComponent from'./components/checkout-loyalty-input';import LabelComponent from'./components/checkout-loyalty-label';import TextComponent from'./components/checkout-loyalty-text';let CheckoutLoyalty=class CheckoutLoyalty extends React.Component{constructor(props){super(props);this.moduleClassName='ms-checkout-loyalty';this.init=async()=>{var _this$props$data$chec;this.props.moduleState.init(_objectSpread({onEdit:this.onEdit,onCancel:this.onCancel,onSubmit:this.onSubmit,isRequired:false},!this.isEnabled()&&{status:'disabled'}));const savedLoyaltyAmount=(_this$props$data$chec=this.props.data.checkout.result)===null||_this$props$data$chec===void 0?void 0:_this$props$data$chec.loyaltyAmount;if(savedLoyaltyAmount){this.props.moduleState.onReady();}else if(this.isPaymentVerificationRedirection){this.props.moduleState.onSkip();}else if(this.props.data.loyaltyCard.result&&this.props.data.checkout.result&&this.props.data.loyaltyCard.result.CardNumber!==this.props.data.checkout.result.checkoutCart.cart.LoyaltyCardId){this.props.data.checkout.result.checkoutCart.updateLoyaltyCardId({loyaltyCardNumber:this.props.data.loyaltyCard.result.CardNumber}).catch(error=>{if(this.context.telemetry){this.context.telemetry.warning(error);this.context.telemetry.debug('Unable to update the loyalty card');}});}};this.onEdit=()=>{this.props.moduleState.onUpdating();};this.onCancel=()=>{this.handleCancelOrSubmit();};this.onSubmit=()=>{this.handleCancelOrSubmit();};this.handleCancelOrSubmit=()=>{const checkoutState=this.props.data.checkout.result;if(checkoutState&&checkoutState.loyaltyAmount>0){this.props.moduleState.onReady();}else{this.props.moduleState.onSkip();}};this.isEnabled=()=>{return this.props.context.request.user.isAuthenticated&&this.props.data.loyaltyCard.result&&this.props.data.loyaltyCard.result.CardNumber&&this.shouldPayLoyalty;};this._dialogToggleRef=/*#__PURE__*/React.createRef();this._applyLoyaltyPoints=this._applyLoyaltyPoints.bind(this);this._removeLoyaltyPoints=this._removeLoyaltyPoints.bind(this);this._onInputChange=this._onInputChange.bind(this);this._onBlur=this._onBlur.bind(this);this.state={dollarsApplied:this.maxDollars,isFetchingLoyaltyCard:false};}get shouldPayLoyalty(){const cart=this.props.data.checkout.result?this.props.data.checkout.result.checkoutCart.cart:undefined;if(!cart){return false;}const amountDue=cart.TotalAmount||0;return amountDue>0;}get isDataReady(){return(this.props.data.checkout.result&&this.props.data.checkout.status)==='SUCCESS'&&(this.props.data.loyaltyCard&&this.props.data.loyaltyCard.status)!=='LOADING'&&(this.props.data.loyaltyTransactionEstimation&&this.props.data.loyaltyTransactionEstimation.status)!=='LOADING';}get maxDollars(){return this.props.data.loyaltyTransactionEstimation.result&&this.props.data.loyaltyTransactionEstimation.result.MaxCurrencyValueOfLoyaltyPoints?this.props.data.loyaltyTransactionEstimation.result.MaxCurrencyValueOfLoyaltyPoints:0;}get isPaymentVerificationRedirection(){const{requestFormData,query}=this.props.context.request;return requestFormData&&query&&query.pv==='1'?true:false;}async componentDidMount(){when(()=>this.isDataReady,async()=>{await this.init();});reaction(()=>this.props.data.checkout.result&&this.props.data.checkout.result.checkoutCart.cart,async()=>{this._updateEstimate();});reaction(()=>this.props.data.loyaltyCard.result,async()=>{this._updateLoyalty();});}render(){const{resources,renderView,moduleState:{isReady}}=this.props;if(this.props.data.loyaltyCard&&this.props.data.loyaltyCard.result&&this.props.data.loyaltyCard.result.CardNumber&&this.shouldPayLoyalty){const loyaltyCard=this.props.data.loyaltyCard.result;const checkoutState=this.props.data.checkout.result;let isShowLoyalty=false;if(isReady){if(!checkoutState||checkoutState.loyaltyAmount===0){return null;}else{isShowLoyalty=true;}}const viewProps=_objectSpread(_objectSpread({},this.props),{},{viewState:{isShowLoyalty:isShowLoyalty,isShowAddLoyalty:!isReady},checkoutLoyalty:{moduleProps:this.props,className:classnames(this.moduleClassName,{[\"\".concat(this.moduleClassName,\"__applied\")]:isShowLoyalty},this.props.config.className)},showLoyalty:{heading:/*#__PURE__*/React.createElement(Heading,{headingTag:'h3',className:\"\".concat(this.moduleClassName,\"__heading\"),text:resources.loyaltyHeadingText}),coveredAmountText:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__text\"),text:resources.loyaltyCoveredAmountText}),amount:/*#__PURE__*/React.createElement(PriceComponent,{className:\"\".concat(this.moduleClassName,\"__applied-value\"),id:this.props.id,typeName:this.props.typeName,context:this.props.context,data:{price:{CustomerContextualPrice:checkoutState&&checkoutState.loyaltyAmount}}})},addLoyalty:{heading:/*#__PURE__*/React.createElement(Heading,{headingTag:'h3',className:\"\".concat(this.moduleClassName,\"__heading\"),text:resources.loyaltyHeadingText}),drawer:{tag:Drawer,className:\"\".concat(this.moduleClassName,\"__drawer\"),toggleButtonText:this._drawerHeader(),openGlyph:\"\".concat(this.moduleClassName,\"__drawer-open\"),closeGlyph:\"\".concat(this.moduleClassName,\"__drawer-close\"),glyphPlacement:'end'},cardNumber:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__card-number\"),text:loyaltyCard.CardNumber||''}),rewardPoints:loyaltyCard.RewardPoints&&loyaltyCard.RewardPoints.map((points,index)=>{return this._renderPointSection(points,resources.availablePointsLabel,resources.expiringLoyaltyPointsLabel);}),loyaltyAmountContainer:{className:\"\".concat(this.moduleClassName,\"__amount\")},appliedLoyaltyAmountContainer:{className:\"\".concat(this.moduleClassName,\"__applied-amount\")},loyaltyAmountLabel:/*#__PURE__*/React.createElement(LabelComponent,{className:\"\".concat(this.moduleClassName,\"__amount-label\"),text:resources.payWithLoyaltyAmountLabel,htmlFor:\"\".concat(this.props.id,\"-label\")}),loyaltyAmountInput:/*#__PURE__*/React.createElement(InputComponent,{className:\"\".concat(this.moduleClassName,\"__amount-input\"),onChange:this._onInputChange,onBlur:this._onBlur,type:'number',step:'.01',value:this.state.dollarsApplied,min:0,max:this.maxDollars,ariaValueMax:this.maxDollars,ariaValueMin:0,ariaValueNow:this.state.dollarsApplied,id:\"\".concat(this.props.id,\"-label\")}),loyaltyAmountApplyButton:/*#__PURE__*/React.createElement(Button,{className:\"\".concat(this.moduleClassName,\"__amount-button\"),title:this.props.resources.applyCheckoutLoyaltyPaymentText,onClick:this._applyLoyaltyPoints,disabled:this.state.dollarsApplied>this.maxDollars||this.state.dollarsApplied<=0||this.state.isFetchingLoyaltyCard},this.props.resources.applyCheckoutLoyaltyPaymentText),showAppliedAmount:checkoutState&&checkoutState.loyaltyAmount>0,loyaltyAmountAppliedText:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__applied-text\"),text:resources.loyaltyCoveredAmountText}),loyaltyAmountAppliedPrice:/*#__PURE__*/React.createElement(PriceComponent,{className:\"\".concat(this.moduleClassName,\"__applied-value\"),id:this.props.id,typeName:this.props.typeName,context:this.props.context,data:{price:{CustomerContextualPrice:checkoutState&&checkoutState.loyaltyAmount}}}),loyaltyAmountRemoveButton:/*#__PURE__*/React.createElement(Button,{className:'ms-checkout-loyalty-remove-btn',title:this.props.resources.removeCheckoutLoyaltyPaymentText,onClick:this._removeLoyaltyPoints,innerRef:this._dialogToggleRef},this.props.resources.removeCheckoutLoyaltyPaymentText)}});return renderView(viewProps);}this.props.context.telemetry.error('Checkout loyalty content is empty, module wont render');return null;}_drawerHeader(){return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"p\",{className:\"\".concat(this.moduleClassName,\"__covered-text\")},this.props.resources.loyaltyCoveredAmountText),/*#__PURE__*/React.createElement(PriceComponent,{className:\"\".concat(this.moduleClassName,\"__applied-value\"),id:this.props.id,typeName:this.props.typeName,context:this.props.context,data:{price:{CustomerContextualPrice:this.maxDollars}}}));}_renderPointSection(point,loyaltyCoveredAmountText,expiringLoyaltyPointsLabel){return{key:point.RewardPointId||'',checkoutLoyaltyRewardPoint:{className:\"\".concat(this.moduleClassName,\"__program\")},title:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__program-title\"),text:point.Description}),availablePointsText:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__program-available\"),text:loyaltyCoveredAmountText}),activePoints:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__program-points\"),text:(point&&point.ActivePoints).toString()}),expiringPointsText:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__program-expiring\"),text:expiringLoyaltyPointsLabel}),expiringPoints:/*#__PURE__*/React.createElement(TextComponent,{className:\"\".concat(this.moduleClassName,\"__program-points\"),text:(point&&point.PointsExpiringSoon).toString()})};}async _applyLoyaltyPoints(){const checkoutState=this.props.data.checkout.result;if(!checkoutState){return;}await checkoutState.updateLoyaltyAmount({newAmount:parseFloat(this.state.dollarsApplied.toString())});this.setState({isFetchingLoyaltyCard:true});}async _removeLoyaltyPoints(){const checkoutState=this.props.data.checkout.result;if(!checkoutState){return;}await checkoutState.updateLoyaltyAmount({newAmount:0});this.setState({dollarsApplied:0});}_onInputChange(event){const value=event.currentTarget.value;this.setState({dollarsApplied:value.length?Number(value):parseFloat(value),isFetchingLoyaltyCard:false});}_onBlur(event){const num=parseFloat(event.currentTarget.value).toFixed(2);const element=document.getElementById(\"\".concat(this.props.id,\"-label\"));if(element&&num){element.value=num;this.setState({dollarsApplied:parseFloat(num)});}}_updateLoyalty(){if(this.props.moduleState.isDisabled&&this.isEnabled()){this._updateEstimate();this.props.moduleState.onUpdating();}}_updateEstimate(){const card=this.props.data.loyaltyCard.result;const cart=this.props.data.checkout.result?this.props.data.checkout.result.checkoutCart.cart:undefined;const channelConfig=this.props.context.request.channel;if(card&&cart&&channelConfig){const currencyCode=channelConfig.Currency||'';const loyalPointsRequest=createGetMaxLoyaltyPointsToRedeemForTransactionBalanceInput(cart.Id,card.CardNumber,currencyCode);loyalPointsRequest._query.options.bypassCache='get';callActionOrExecute(loyalPointsRequest,this.props.context.actionContext).then(async points=>{this.props.context.actionContext.update(new GetLoyaltyTransactionEstimationInput(this.props.context.request.apiSettings),points);const newMaxPoints=points&&points.MaxCurrencyValueOfLoyaltyPoints||0;if(this.props.data.checkout.result&&this.props.data.checkout.result.loyaltyAmount>newMaxPoints){await this.props.data.checkout.result.updateLoyaltyAmount({newAmount:newMaxPoints});}if(this.state.dollarsApplied>newMaxPoints){this.setState({dollarsApplied:newMaxPoints});}}).catch(error=>{this.props.context.actionContext.telemetry.exception(error);this.props.context.actionContext.telemetry.debug('Error getting Loyalty Point Redemption Estimate');});}}};__decorate([computed],CheckoutLoyalty.prototype,\"shouldPayLoyalty\",null);__decorate([computed],CheckoutLoyalty.prototype,\"isDataReady\",null);__decorate([computed],CheckoutLoyalty.prototype,\"maxDollars\",null);__decorate([computed],CheckoutLoyalty.prototype,\"isPaymentVerificationRedirection\",null);CheckoutLoyalty=__decorate([withModuleState,observer],CheckoutLoyalty);export default CheckoutLoyalty;","map":{"version":3,"sources":["modules/checkout-loyalty/checkout-loyalty.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport classnames from 'classnames';\nimport { computed, reaction, when } from 'mobx';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\n\nimport { IModuleStateProps, withModuleState } from '@msdyn365-commerce-modules/checkout-utilities';\nimport { GetLoyaltyTransactionEstimationInput } from '@msdyn365-commerce-modules/retail-actions';\nimport { Button, Drawer, Heading, IModuleProps, INodeProps } from '@msdyn365-commerce-modules/utilities';\nimport { PriceComponent } from '@msdyn365-commerce/components';\nimport { callActionOrExecute } from '@msdyn365-commerce/retail-proxy';\nimport { createGetMaxLoyaltyPointsToRedeemForTransactionBalanceInput } from '@msdyn365-commerce/retail-proxy/dist/DataActions/CartsDataActions.g';\nimport { LoyaltyPointRedemptionEstimate, LoyaltyRewardPoint } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\n\nimport { ICheckoutLoyaltyData } from './checkout-loyalty.data';\nimport { ICheckoutLoyaltyProps } from './checkout-loyalty.props.autogenerated';\nimport InputComponent from './components/checkout-loyalty-input';\nimport LabelComponent from './components/checkout-loyalty-label';\nimport TextComponent from './components/checkout-loyalty-text';\n\nexport interface ICheckoutLoyaltyState {\n    dollarsApplied: number;\n    isFetchingLoyaltyCard: boolean;\n}\n\nexport interface ICheckoutLoyaltyModuleProps extends ICheckoutLoyaltyProps<ICheckoutLoyaltyData>, IModuleStateProps {}\n\nexport interface ICheckoutLoyaltyViewState {\n    isShowLoyalty: boolean;\n    isShowAddLoyalty: boolean;\n}\n\nexport interface ICheckoutLoyaltyShow {\n    heading: React.ReactNode;\n    coveredAmountText: React.ReactNode;\n    amount: React.ReactNode;\n}\n\nexport interface ICheckoutLoyaltyRewardPoint {\n    checkoutLoyaltyRewardPoint: INodeProps;\n    key: string;\n    title: React.ReactNode;\n    availablePointsText: React.ReactNode;\n    activePoints: React.ReactNode;\n    expiringPointsText: React.ReactNode;\n    expiringPoints: React.ReactNode;\n}\n\nexport interface ICheckoutLoyaltyAdd {\n    heading: React.ReactNode;\n    cardNumber: React.ReactNode;\n    drawer: INodeProps;\n    rewardPoints: ICheckoutLoyaltyRewardPoint[];\n    loyaltyAmountContainer: INodeProps;\n    appliedLoyaltyAmountContainer: INodeProps;\n    loyaltyAmountLabel: React.ReactNode;\n    loyaltyAmountInput: React.ReactNode;\n    loyaltyAmountApplyButton: React.ReactNode;\n    showAppliedAmount: boolean;\n    loyaltyAmountAppliedText: React.ReactNode;\n    loyaltyAmountAppliedPrice: React.ReactNode;\n    loyaltyAmountRemoveButton: React.ReactNode;\n}\n\nexport interface ICheckoutLoyaltyViewProps extends ICheckoutLoyaltyModuleProps {\n    checkoutLoyalty: IModuleProps;\n    viewState: ICheckoutLoyaltyViewState;\n    showLoyalty: ICheckoutLoyaltyShow;\n    addLoyalty: ICheckoutLoyaltyAdd;\n}\n\n/**\n *\n * CheckoutLoyalty component\n * @extends {React.Component<ICheckoutLoyaltyProps<ICheckoutLoyaltyData>>}\n */\n// @ts-ignore\n@withModuleState\n@observer\nclass CheckoutLoyalty extends React.Component<ICheckoutLoyaltyModuleProps, ICheckoutLoyaltyState> {\n    private _dialogToggleRef: React.RefObject<HTMLButtonElement> | undefined;\n    private moduleClassName: string = 'ms-checkout-loyalty';\n\n    constructor(props: ICheckoutLoyaltyModuleProps) {\n        super(props);\n        this._dialogToggleRef = React.createRef();\n        this._applyLoyaltyPoints = this._applyLoyaltyPoints.bind(this);\n        this._removeLoyaltyPoints = this._removeLoyaltyPoints.bind(this);\n        this._onInputChange = this._onInputChange.bind(this);\n        this._onBlur = this._onBlur.bind(this);\n        this.state = { dollarsApplied: this.maxDollars, isFetchingLoyaltyCard: false };\n    }\n\n    @computed get shouldPayLoyalty(): boolean {\n        const cart = this.props.data.checkout.result ? this.props.data.checkout.result.checkoutCart.cart : undefined;\n        if (!cart) {\n            return false;\n        }\n        // Use loyalty when cart is not full of free items\n        const amountDue = cart.TotalAmount || 0;\n        return amountDue > 0;\n    }\n\n    @computed get isDataReady(): boolean {\n        return (\n            (this.props.data.checkout.result && this.props.data.checkout.status) === 'SUCCESS' &&\n            (this.props.data.loyaltyCard && this.props.data.loyaltyCard.status) !== 'LOADING' &&\n            (this.props.data.loyaltyTransactionEstimation && this.props.data.loyaltyTransactionEstimation.status) !== 'LOADING'\n        );\n    }\n\n    @computed get maxDollars(): number {\n        return this.props.data.loyaltyTransactionEstimation.result &&\n            this.props.data.loyaltyTransactionEstimation.result.MaxCurrencyValueOfLoyaltyPoints\n            ? this.props.data.loyaltyTransactionEstimation.result.MaxCurrencyValueOfLoyaltyPoints\n            : 0;\n    }\n\n    @computed get isPaymentVerificationRedirection(): boolean {\n        const { requestFormData, query } = this.props.context.request;\n        return requestFormData && query && query.pv === '1' ? true : false;\n    }\n\n    public async componentDidMount(): Promise<void> {\n        when(\n            () => this.isDataReady,\n            async () => {\n                await this.init();\n            }\n        );\n\n        reaction(\n            () => this.props.data.checkout.result && this.props.data.checkout.result.checkoutCart.cart,\n            async () => {\n                this._updateEstimate();\n            }\n        );\n\n        reaction(\n            () => this.props.data.loyaltyCard.result,\n            async () => {\n                this._updateLoyalty();\n            }\n        );\n    }\n\n    // tslint:disable-next-line:max-func-body-length\n    public render(): JSX.Element | null {\n        const {\n            resources,\n            renderView,\n            moduleState: { isReady }\n        } = this.props;\n\n        if (\n            this.props.data.loyaltyCard &&\n            this.props.data.loyaltyCard.result &&\n            this.props.data.loyaltyCard.result.CardNumber &&\n            this.shouldPayLoyalty\n        ) {\n            const loyaltyCard = this.props.data.loyaltyCard.result;\n            const checkoutState = this.props.data.checkout.result;\n            let isShowLoyalty = false;\n\n            if (isReady) {\n                if (!checkoutState || checkoutState.loyaltyAmount === 0) {\n                    return null;\n                } else {\n                    isShowLoyalty = true;\n                }\n            }\n\n            const viewProps = {\n                ...this.props,\n                viewState: {\n                    isShowLoyalty: isShowLoyalty,\n                    isShowAddLoyalty: !isReady\n                },\n                checkoutLoyalty: {\n                    moduleProps: this.props,\n                    className: classnames(\n                        this.moduleClassName,\n                        { [`${this.moduleClassName}__applied`]: isShowLoyalty },\n                        this.props.config.className\n                    )\n                },\n                showLoyalty: {\n                    heading: <Heading headingTag='h3' className={`${this.moduleClassName}__heading`} text={resources.loyaltyHeadingText} />,\n                    coveredAmountText: (\n                        <TextComponent className={`${this.moduleClassName}__text`} text={resources.loyaltyCoveredAmountText} />\n                    ),\n                    amount: (\n                        <PriceComponent\n                            className={`${this.moduleClassName}__applied-value`}\n                            id={this.props.id}\n                            typeName={this.props.typeName}\n                            context={this.props.context}\n                            data={{ price: { CustomerContextualPrice: checkoutState && checkoutState.loyaltyAmount } }}\n                        />\n                    )\n                },\n                addLoyalty: {\n                    heading: <Heading headingTag='h3' className={`${this.moduleClassName}__heading`} text={resources.loyaltyHeadingText} />,\n                    drawer: {\n                        tag: Drawer,\n                        className: `${this.moduleClassName}__drawer`,\n                        toggleButtonText: this._drawerHeader(),\n                        openGlyph: `${this.moduleClassName}__drawer-open`,\n                        closeGlyph: `${this.moduleClassName}__drawer-close`,\n                        glyphPlacement: 'end'\n                    },\n                    cardNumber: <TextComponent className={`${this.moduleClassName}__card-number`} text={loyaltyCard.CardNumber || ''} />,\n                    rewardPoints:\n                        loyaltyCard.RewardPoints &&\n                        loyaltyCard.RewardPoints.map((points, index) => {\n                            return this._renderPointSection(points, resources.availablePointsLabel, resources.expiringLoyaltyPointsLabel);\n                        }),\n                    loyaltyAmountContainer: {\n                        className: `${this.moduleClassName}__amount`\n                    },\n                    appliedLoyaltyAmountContainer: {\n                        className: `${this.moduleClassName}__applied-amount`\n                    },\n                    loyaltyAmountLabel: (\n                        <LabelComponent\n                            className={`${this.moduleClassName}__amount-label`}\n                            text={resources.payWithLoyaltyAmountLabel}\n                            htmlFor={`${this.props.id}-label`}\n                        />\n                    ),\n                    loyaltyAmountInput: (\n                        <InputComponent\n                            className={`${this.moduleClassName}__amount-input`}\n                            onChange={this._onInputChange}\n                            onBlur={this._onBlur}\n                            type='number'\n                            step='.01'\n                            value={this.state.dollarsApplied}\n                            min={0}\n                            max={this.maxDollars}\n                            ariaValueMax={this.maxDollars}\n                            ariaValueMin={0}\n                            ariaValueNow={this.state.dollarsApplied}\n                            id={`${this.props.id}-label`}\n                        />\n                    ),\n                    loyaltyAmountApplyButton: (\n                        <Button\n                            className={`${this.moduleClassName}__amount-button`}\n                            title={this.props.resources.applyCheckoutLoyaltyPaymentText}\n                            onClick={this._applyLoyaltyPoints}\n                            disabled={\n                                this.state.dollarsApplied > this.maxDollars ||\n                                this.state.dollarsApplied <= 0 ||\n                                this.state.isFetchingLoyaltyCard\n                            }\n                        >\n                            {this.props.resources.applyCheckoutLoyaltyPaymentText}\n                        </Button>\n                    ),\n                    showAppliedAmount: checkoutState && checkoutState.loyaltyAmount > 0,\n                    loyaltyAmountAppliedText: (\n                        <TextComponent className={`${this.moduleClassName}__applied-text`} text={resources.loyaltyCoveredAmountText} />\n                    ),\n                    loyaltyAmountAppliedPrice: (\n                        <PriceComponent\n                            className={`${this.moduleClassName}__applied-value`}\n                            id={this.props.id}\n                            typeName={this.props.typeName}\n                            context={this.props.context}\n                            data={{ price: { CustomerContextualPrice: checkoutState && checkoutState.loyaltyAmount } }}\n                        />\n                    ),\n                    loyaltyAmountRemoveButton: (\n                        <Button\n                            className='ms-checkout-loyalty-remove-btn'\n                            title={this.props.resources.removeCheckoutLoyaltyPaymentText}\n                            onClick={this._removeLoyaltyPoints}\n                            innerRef={this._dialogToggleRef}\n                        >\n                            {this.props.resources.removeCheckoutLoyaltyPaymentText}\n                        </Button>\n                    )\n                }\n            };\n\n            return renderView(viewProps) as React.ReactElement;\n        }\n        this.props.context.telemetry.error('Checkout loyalty content is empty, module wont render');\n        return null;\n    }\n\n    private _drawerHeader(): JSX.Element {\n        return (\n            <React.Fragment>\n                <p className={`${this.moduleClassName}__covered-text`}>{this.props.resources.loyaltyCoveredAmountText}</p>\n                <PriceComponent\n                    className={`${this.moduleClassName}__applied-value`}\n                    id={this.props.id}\n                    typeName={this.props.typeName}\n                    context={this.props.context}\n                    data={{ price: { CustomerContextualPrice: this.maxDollars } }}\n                />\n            </React.Fragment>\n        );\n    }\n\n    private _renderPointSection(\n        point: LoyaltyRewardPoint,\n        loyaltyCoveredAmountText: string,\n        expiringLoyaltyPointsLabel: string\n    ): ICheckoutLoyaltyRewardPoint {\n        return {\n            key: point.RewardPointId || '',\n            checkoutLoyaltyRewardPoint: {\n                className: `${this.moduleClassName}__program`\n            },\n            title: <TextComponent className={`${this.moduleClassName}__program-title`} text={point.Description} />,\n            availablePointsText: <TextComponent className={`${this.moduleClassName}__program-available`} text={loyaltyCoveredAmountText} />,\n            activePoints: (\n                <TextComponent className={`${this.moduleClassName}__program-points`} text={(point && point.ActivePoints!).toString()} />\n            ),\n            expiringPointsText: <TextComponent className={`${this.moduleClassName}__program-expiring`} text={expiringLoyaltyPointsLabel} />,\n            expiringPoints: (\n                <TextComponent\n                    className={`${this.moduleClassName}__program-points`}\n                    text={(point && point.PointsExpiringSoon!).toString()}\n                />\n            )\n        };\n    }\n\n    private init = async (): Promise<void> => {\n        this.props.moduleState.init({\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n            isRequired: false,\n            ...(!this.isEnabled() && { status: 'disabled' })\n        });\n\n        const savedLoyaltyAmount = this.props.data.checkout.result?.loyaltyAmount;\n        if (savedLoyaltyAmount) {\n            this.props.moduleState.onReady();\n        } else if (this.isPaymentVerificationRedirection) {\n            this.props.moduleState.onSkip();\n        } else if (\n            this.props.data.loyaltyCard.result &&\n            this.props.data.checkout.result &&\n            this.props.data.loyaltyCard.result.CardNumber !== this.props.data.checkout.result.checkoutCart.cart.LoyaltyCardId\n        ) {\n            this.props.data.checkout.result.checkoutCart\n                .updateLoyaltyCardId({ loyaltyCardNumber: this.props.data.loyaltyCard.result.CardNumber })\n                .catch(error => {\n                    if (this.context.telemetry) {\n                        this.context.telemetry.warning(error);\n                        this.context.telemetry.debug('Unable to update the loyalty card');\n                    }\n                });\n        }\n    };\n\n    private onEdit = () => {\n        this.props.moduleState.onUpdating();\n    };\n\n    private onCancel = () => {\n        this.handleCancelOrSubmit();\n    };\n\n    private onSubmit = () => {\n        this.handleCancelOrSubmit();\n    };\n\n    private handleCancelOrSubmit = () => {\n        const checkoutState = this.props.data.checkout.result;\n        if (checkoutState && checkoutState.loyaltyAmount > 0) {\n            // Show summary screen\n            this.props.moduleState.onReady();\n        } else {\n            // Skip the module\n            this.props.moduleState.onSkip();\n        }\n    };\n\n    private isEnabled = () => {\n        return (\n            this.props.context.request.user.isAuthenticated &&\n            this.props.data.loyaltyCard.result &&\n            this.props.data.loyaltyCard.result.CardNumber &&\n            this.shouldPayLoyalty\n        );\n    };\n\n    private async _applyLoyaltyPoints(): Promise<void> {\n        const checkoutState = this.props.data.checkout.result;\n\n        if (!checkoutState) {\n            return;\n        }\n\n        await checkoutState.updateLoyaltyAmount({ newAmount: parseFloat(this.state.dollarsApplied.toString()) });\n        this.setState({\n            isFetchingLoyaltyCard: true\n        });\n    }\n\n    private async _removeLoyaltyPoints(): Promise<void> {\n        const checkoutState = this.props.data.checkout.result;\n\n        if (!checkoutState) {\n            return;\n        }\n\n        await checkoutState.updateLoyaltyAmount({ newAmount: 0 });\n        this.setState({\n            dollarsApplied: 0\n        });\n    }\n\n    private _onInputChange(event: React.ChangeEvent<HTMLInputElement>): void {\n        const value = event.currentTarget.value;\n        this.setState({ dollarsApplied: value.length ? Number(value) : parseFloat(value), isFetchingLoyaltyCard: false });\n    }\n\n    private _onBlur(event: React.FocusEvent<HTMLInputElement>): void {\n        const num = parseFloat(event.currentTarget.value).toFixed(2);\n        const element = document.getElementById(`${this.props.id}-label`) as HTMLInputElement;\n        if (element && num) {\n            element.value = num;\n            this.setState({ dollarsApplied: parseFloat(num) });\n        }\n    }\n\n    private _updateLoyalty(): void {\n        if (this.props.moduleState.isDisabled && this.isEnabled()) {\n            this._updateEstimate();\n            this.props.moduleState.onUpdating();\n        }\n    }\n\n    private _updateEstimate(): void {\n        const card = this.props.data.loyaltyCard.result;\n        const cart = this.props.data.checkout.result ? this.props.data.checkout.result.checkoutCart.cart : undefined;\n        const channelConfig = this.props.context.request.channel;\n        if (card && cart && channelConfig) {\n            const currencyCode = channelConfig.Currency || '';\n            const loyalPointsRequest = createGetMaxLoyaltyPointsToRedeemForTransactionBalanceInput(cart.Id, card.CardNumber!, currencyCode);\n\n            // @ts-ignore\n            // Due to bug 23214358, this is getting improperly cached. Need to turn on cache bypass for now to work around issue\n            loyalPointsRequest._query.options.bypassCache = 'get';\n\n            callActionOrExecute<LoyaltyPointRedemptionEstimate>(loyalPointsRequest, this.props.context.actionContext)\n                .then(async points => {\n                    this.props.context.actionContext.update(\n                        new GetLoyaltyTransactionEstimationInput(this.props.context.request.apiSettings),\n                        points\n                    );\n                    const newMaxPoints = (points && points.MaxCurrencyValueOfLoyaltyPoints) || 0;\n\n                    // If points are already applied, ensure you don't apply more points than max\n                    if (this.props.data.checkout.result && this.props.data.checkout.result.loyaltyAmount > newMaxPoints) {\n                        await this.props.data.checkout.result.updateLoyaltyAmount({ newAmount: newMaxPoints });\n                    }\n\n                    // If input amount is already equal to max, keep it at new max. Also if input amount would be more than new max, set it to new max\n                    if (this.state.dollarsApplied > newMaxPoints) {\n                        this.setState({ dollarsApplied: newMaxPoints });\n                    }\n                })\n                .catch(error => {\n                    this.props.context.actionContext.telemetry.exception(error);\n                    this.props.context.actionContext.telemetry.debug('Error getting Loyalty Point Redemption Estimate');\n                });\n        }\n    }\n}\n\nexport default CheckoutLoyalty;\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}