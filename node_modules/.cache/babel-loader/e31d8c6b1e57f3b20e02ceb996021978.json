{"ast":null,"code":"import\"core-js/modules/es.object.assign.js\";import\"core-js/modules/es.promise.js\";import\"core-js/modules/es.regexp.constructor.js\";import\"core-js/modules/es.regexp.to-string.js\";import\"core-js/modules/es.string.replace.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _get from\"lodash/get\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{__decorate}from\"tslib\";import{addItemToOrderTemplate,AddItemToOrderTemplateInput,getDimensionsForSelectedVariant,GetDimensionsForSelectedVariantInput,getSelectedVariant,SelectedVariantInput}from'@msdyn365-commerce-modules/retail-actions';import{Button,Modal,ModalBody}from'@msdyn365-commerce-modules/utilities';import{searchByCriteriaAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import{computed}from'mobx';import React from'react';import{NotFoundComponent,ProductConfiguration,ProductList}from'./';var CONTENT;(function(CONTENT){CONTENT[CONTENT[\"Search\"]=0]=\"Search\";CONTENT[CONTENT[\"ProductList\"]=1]=\"ProductList\";CONTENT[CONTENT[\"ProductConfiguration\"]=2]=\"ProductConfiguration\";CONTENT[CONTENT[\"NotFound\"]=3]=\"NotFound\";CONTENT[CONTENT[\"Error\"]=4]=\"Error\";CONTENT[CONTENT[\"Loading\"]=5]=\"Loading\";})(CONTENT||(CONTENT={}));export class AddLineToTemplate extends React.Component{constructor(props){super(props);this.state={isOpen:false,query:'',products:[],content:CONTENT.Search,selectedProduct:null};this.defaultImageSettings={viewports:{xs:{q:\"w=64&h=64&m=6\",w:0,h:0},lg:{q:\"w=64&h=64&m=6\",w:0,h:0},xl:{q:\"w=64&h=64&m=6\",w:0,h:0}},lazyload:true};this.searchTextInput=/*#__PURE__*/React.createRef();this._onSearchSubmit=event=>{event.preventDefault();const query=_get(this,'searchTextInput.current.value',null);if(!query){return;}this.setState({content:CONTENT.Loading});this._getSearchResults(query).then(result=>{if(result.length===0){this.setState({content:CONTENT.NotFound});}else{this.setState({products:result,content:CONTENT.ProductList});}}).catch(error=>{this.setState({content:CONTENT.Error});});};this._onQuantityChangeHandler=event=>{this.setState({selectedQuantity:+event.target.value});};this._onSelectItem=async product=>{const{actionContext,request:{apiSettings:{channelId}}}=this.props.context;const varianteInput=new SelectedVariantInput(product.RecordId,channelId,[]);const productVariant=await getSelectedVariant(varianteInput,actionContext);if(!productVariant){this.props.context.telemetry.error('Error retrieving product variant');return;}const dimensions=await this._getProductDimensions(product);this.setState({selectedProductDimensions:dimensions,content:CONTENT.ProductConfiguration,selectedProduct:productVariant});};this._onInputChange=event=>{this.setState({query:event.target.value});};this._onBackButtonClickHandler=()=>{console.log('on back button');this.setState({content:CONTENT.ProductList});};this._highlightSearchTerm=name=>{const parsedName=name&&unescape(name.replace(new RegExp(this.state.query,'i'),'<span>$&</span>'));return/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__product__name',dangerouslySetInnerHTML:{__html:parsedName||''}});};this._addItemToTemplateHandler=async config=>{const{orderTemplateId,context:{actionContext}}=this.props;const input=new AddItemToOrderTemplateInput(orderTemplateId,config.product.RecordId,config.quantity,config.product.DefaultUnitOfMeasure||'ea');const result=await addItemToOrderTemplate(input,actionContext);this.setState({reloadPage:true});return result;};this._toggleModalHandler=()=>{this.setState({isOpen:!this.state.isOpen,content:CONTENT.Search});if(this.state.reloadPage){window.location.reload();this.setState({reloadPage:false});}};}onComponentDidMount(){var _this$searchTextInput;(_this$searchTextInput=this.searchTextInput.current)===null||_this$searchTextInput===void 0?void 0:_this$searchTextInput.focus();}onComponentDidUpdate(){var _this$searchTextInput2;(_this$searchTextInput2=this.searchTextInput.current)===null||_this$searchTextInput2===void 0?void 0:_this$searchTextInput2.focus();}get showBackArrow(){return this.state.content===CONTENT.ProductConfiguration;}render(){const{resources:{addLineModalLinkText,searchButtonAriaLabel,searchInputAriaLabel,searchModalPlaceholderText}}=this.props;const modalProps=_objectSpread(_objectSpread({},this.props),{},{className:'msc-add-line-to-template',toggle:this._toggleModalHandler,isOpen:this.state.isOpen});return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Modal,Object.assign({},modalProps),/*#__PURE__*/React.createElement(\"div\",{className:'msc-modal__header'},this.showBackArrow&&/*#__PURE__*/React.createElement(\"button\",{type:'button',className:'msc-modal__back-button',\"aria-label\":'Back to search results',onClick:this._onBackButtonClickHandler}),/*#__PURE__*/React.createElement(\"h5\",{className:'msc-modal__title'},addLineModalLinkText),/*#__PURE__*/React.createElement(\"button\",{type:'button',className:'msc-modal__close-button',\"aria-label\":'Close',onClick:this._toggleModalHandler})),/*#__PURE__*/React.createElement(ModalBody,null,/*#__PURE__*/React.createElement(\"form\",{className:'msc-add-line-to-template__search-form',\"aria-label\":searchButtonAriaLabel,name:'add-line-to-template-search-form',role:'form',autoComplete:'off',onSubmit:this._onSearchSubmit},/*#__PURE__*/React.createElement(\"input\",{type:'text',autoFocus:true,\"aria-label\":searchInputAriaLabel,className:'msc-form-control msc-add-line-to-template__search-input',placeholder:searchModalPlaceholderText,value:this.state.query,onChange:this._onInputChange,ref:this.searchTextInput}),/*#__PURE__*/React.createElement(\"button\",{className:'msc-add-line-to-template__search-button',\"aria-label\":'Add To Template Search Button',color:'primary'})),this._renderContent())),/*#__PURE__*/React.createElement(Button,{className:'msc-add-line-to-template__button',\"aria-label\":addLineModalLinkText,onClick:this._toggleModalHandler},/*#__PURE__*/React.createElement(\"span\",null),addLineModalLinkText));}_renderContent(){switch(this.state.content){case CONTENT.ProductConfiguration:const{selectedProduct,selectedProductDimensions}=this.state;const viewProps=_objectSpread(_objectSpread({},this.props),{},{imageSettings:this.props.imageSettings||this.defaultImageSettings,product:selectedProduct,dimensions:selectedProductDimensions,addToTemplateHandler:this._addItemToTemplateHandler,onQuantityChangeHandler:this._onQuantityChangeHandler,highlightSearchTerm:this._highlightSearchTerm});return/*#__PURE__*/React.createElement(ProductConfiguration,Object.assign({},viewProps));case CONTENT.ProductList:const productProps=_objectSpread(_objectSpread({},this.props),{},{imageSettings:this.props.imageSettings||this.defaultImageSettings,clickHandler:this._onSelectItem,products:this.state.products,highlightSearchTerm:this._highlightSearchTerm});return/*#__PURE__*/React.createElement(ProductList,Object.assign({},productProps));case CONTENT.Loading:return/*#__PURE__*/React.createElement(Loader,{msg:this.props.resources.progressNotificationText});case CONTENT.NotFound:const{notFoundSearchErrorNotice,notFoundSearchErrorRedediation}=this.props.resources;return/*#__PURE__*/React.createElement(NotFoundComponent,{error:notFoundSearchErrorNotice,msg:notFoundSearchErrorRedediation});case CONTENT.Error:return/*#__PURE__*/React.createElement(\"div\",{className:'msc-alert-danger'},this.props.resources.searchErrorMessage);default:return null;}}_getSearchResults(searchText){const{context:{actionContext,request:{apiSettings:{channelId,catalogId}}}}=this.props;const searchCriteriaInput={};searchCriteriaInput.Context={ChannelId:channelId,CatalogId:catalogId};searchCriteriaInput.IncludeAttributes=true;searchCriteriaInput.SearchCondition=searchText;return searchByCriteriaAsync({callerContext:actionContext},searchCriteriaInput);}async _getProductDimensions(product){const{context:{actionContext,request:{apiSettings:{channelId}}}}=this.props;const id=product.MasterProductId?product.MasterProductId:product.RecordId;return getDimensionsForSelectedVariant(new GetDimensionsForSelectedVariantInput(id,channelId,[]),actionContext);}}__decorate([computed],AddLineToTemplate.prototype,\"showBackArrow\",null);const Loader=props=>/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__loading__icon'}),/*#__PURE__*/React.createElement(\"div\",{className:'msc-add-line-to-template__loading__msg'},props.msg));","map":{"version":3,"sources":["modules/order-template/components/add-line/add-line.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n    addItemToOrderTemplate,\n    AddItemToOrderTemplateInput,\n    getDimensionsForSelectedVariant,\n    GetDimensionsForSelectedVariantInput,\n    getSelectedVariant,\n    SelectedVariantInput\n} from '@msdyn365-commerce-modules/retail-actions';\nimport { Button, Modal, ModalBody } from '@msdyn365-commerce-modules/utilities';\nimport { ProductDimensionFull } from '@msdyn365-commerce/commerce-entities';\nimport { ICoreContext, IImageSettings } from '@msdyn365-commerce/core';\nimport { ProductListLine, ProductSearchCriteria, ProductSearchResult } from '@msdyn365-commerce/retail-proxy';\nimport { searchByCriteriaAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport { SimpleProduct } from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport { get } from 'lodash';\nimport { computed } from 'mobx';\nimport React from 'react';\nimport { IProductConfigurationState, NotFoundComponent, ProductConfiguration, ProductList } from './';\n\nexport interface IAddLineToTemplateProps {\n    context: ICoreContext;\n    resources: IAddLineToTemplateResources;\n    orderTemplateId: string;\n    imageSettings?: IImageSettings;\n}\n\nexport interface IAddLineToTemplateResources {\n    addLineModalLinkText: string;\n    searchButtonAriaLabel: string;\n    searchInputAriaLabel: string;\n    searchModalPlaceholderText: string;\n    selectProductButtonText: string;\n    addItemToTemplateText: string;\n    addLineProductUnitPricePrefix: string;\n    backButtonText: string;\n    decrementButtonAriaLabel: string;\n    incrementButtonAriaLabel: string;\n    quantitySelectLabel: string;\n    addLineProductUnitOfMeasurePrefix: string;\n    notFoundSearchErrorNotice: string;\n    notFoundSearchErrorRedediation: string;\n    searchErrorMessage: string;\n    productDimensionTypeColor: string;\n    productDimensionTypeConfiguration: string;\n    productDimensionTypeSize: string;\n    productDimensionTypeStyle: string;\n    searchResultsCountVerbage: string;\n    searchResultsCountSubject: string;\n    addToTemplateConfirmation: string;\n    totalPriceLabel: string;\n    progressNotificationText: string;\n    addToTemplateError: string;\n}\n\nenum CONTENT {\n    Search,\n    ProductList,\n    ProductConfiguration,\n    NotFound,\n    Error,\n    Loading\n}\n\ninterface IAddLineToTemplateState {\n    isOpen: boolean;\n    query: string;\n    products: ProductSearchResult[];\n    content: number;\n    selectedProduct: SimpleProduct | null;\n    selectedProductDimensions?: ProductDimensionFull[];\n    selectedQuantity?: number;\n    reloadPage?: boolean;\n}\n\n/**\n * Add Lines to order template\n */\nexport class AddLineToTemplate extends React.Component<IAddLineToTemplateProps, IAddLineToTemplateState> {\n    public state: IAddLineToTemplateState = {\n        isOpen: false,\n        query: '',\n        products: [],\n        content: CONTENT.Search,\n        selectedProduct: null,\n    };\n    public defaultImageSettings: IImageSettings = {\n        viewports: {\n            xs: { q: `w=64&h=64&m=6`, w: 0, h: 0 },\n            lg: { q: `w=64&h=64&m=6`, w: 0, h: 0 },\n            xl: { q: `w=64&h=64&m=6`, w: 0, h: 0 }\n        },\n        lazyload: true\n    };\n    public searchTextInput: React.RefObject<HTMLInputElement> = React.createRef();// @TODO public/private\n\n    constructor(props: IAddLineToTemplateProps) {\n        super(props);\n    }\n\n    public onComponentDidMount(): void {\n        this.searchTextInput.current?.focus();\n    }\n\n    public onComponentDidUpdate(): void {\n        this.searchTextInput.current?.focus();\n    }\n\n    // @ts-ignore\n    @computed get showBackArrow(): boolean {\n        return this.state.content === CONTENT.ProductConfiguration;\n    }\n\n    public render(): JSX.Element {\n        const {\n            resources: { addLineModalLinkText, searchButtonAriaLabel, searchInputAriaLabel, searchModalPlaceholderText }\n         } = this.props;\n\n        const modalProps = {\n             ...this.props,\n            className: 'msc-add-line-to-template',\n            toggle: this._toggleModalHandler,\n            isOpen: this.state.isOpen\n        };\n\n        return (\n            <>\n                <Modal {...modalProps}>\n                    <div className='msc-modal__header'>\n                    {this.showBackArrow && <button\n                        type='button'\n                        className='msc-modal__back-button'\n                        aria-label='Back to search results'\n                        onClick={this._onBackButtonClickHandler}\n                    />}<h5 className='msc-modal__title'>{addLineModalLinkText}\n                    </h5><button\n                        type='button'\n                        className='msc-modal__close-button'\n                        aria-label='Close'\n                        onClick={this._toggleModalHandler}\n                    />\n                    </div>\n                    <ModalBody>\n                        <form\n                            className='msc-add-line-to-template__search-form'\n                            aria-label={searchButtonAriaLabel}\n                            name='add-line-to-template-search-form'\n                            role='form'\n                            autoComplete='off'\n                            onSubmit={this._onSearchSubmit}\n                        >\n                            <input\n                                type='text'\n                                autoFocus\n                                aria-label={searchInputAriaLabel}\n                                className={'msc-form-control msc-add-line-to-template__search-input'}\n                                placeholder={searchModalPlaceholderText}\n                                value={this.state.query}\n                                onChange={this._onInputChange}\n                                ref={this.searchTextInput}\n                            />\n                            <button\n                                className={'msc-add-line-to-template__search-button'}\n                                aria-label={'Add To Template Search Button'}\n                                color={'primary'}\n                            />\n                        </form>\n                        {this._renderContent()}\n                    </ModalBody>\n                </Modal>\n                <Button className={'msc-add-line-to-template__button'} aria-label={addLineModalLinkText} onClick={this._toggleModalHandler}><span/>{addLineModalLinkText}</Button>\n            </>\n        );\n    }\n\n    private _onSearchSubmit = (event: React.FormEvent): void => {\n        event.preventDefault();\n\n        const query = get(this, 'searchTextInput.current.value', null);\n\n        if (!query) {\n            return;\n        }\n\n        this.setState({\n            content: CONTENT.Loading,\n        });\n\n        this._getSearchResults(query)\n            .then(result => {\n                if (result.length === 0) {\n                    this.setState({\n                        content: CONTENT.NotFound,\n                    });\n                } else {\n                    this.setState({\n                        products: result,\n                        content: CONTENT.ProductList,\n                    });\n                }\n            })\n            .catch(error => {\n                this.setState({\n                    content: CONTENT.Error,\n                });\n            });\n    };\n\n    private _onQuantityChangeHandler = (event: React.ChangeEvent<HTMLInputElement>) => {\n        this.setState({\n            selectedQuantity: +event.target.value\n        });\n    }\n\n    private _onSelectItem = async (product: ProductSearchResult): Promise<void> => {\n        const {\n            actionContext,\n            request: { apiSettings: { channelId } }\n        } = this.props.context;\n        const varianteInput = new SelectedVariantInput(product.RecordId, channelId, []);\n        const productVariant = await getSelectedVariant(varianteInput, actionContext);\n\n        if (!productVariant) {\n            this.props.context.telemetry.error('Error retrieving product variant');\n            return;\n        }\n\n        const dimensions = await this._getProductDimensions(product as SimpleProduct);\n\n        this.setState({\n            selectedProductDimensions: dimensions,\n            content: CONTENT.ProductConfiguration,\n            selectedProduct: productVariant\n        });\n    };\n\n    private _onInputChange = (event: React.ChangeEvent<HTMLInputElement>): void => {\n        this.setState({\n            query: event.target.value\n        });\n    };\n\n    private _onBackButtonClickHandler = (): void => {\n        console.log('on back button');\n        this.setState({\n            content: CONTENT.ProductList\n        });\n    }\n\n    private _highlightSearchTerm = (name: string) => {\n        const parsedName = name && unescape(name.replace(new RegExp(this.state.query, 'i'), '<span>$&</span>'));\n        // tslint:disable-next-line:react-no-dangerous-html\n        return <div className='msc-add-line-to-template__product__name' dangerouslySetInnerHTML={{__html: parsedName || ''}}/>;\n    };\n\n    private _renderContent(): React.ReactNode | null {\n        switch (this.state.content) {\n            case CONTENT.ProductConfiguration:\n                const { selectedProduct, selectedProductDimensions } = this.state;\n                const viewProps = {\n                    ...this.props,\n                    imageSettings: this.props.imageSettings || this.defaultImageSettings,\n                    product: selectedProduct!,\n                    dimensions: selectedProductDimensions!,\n                    addToTemplateHandler: this._addItemToTemplateHandler,\n                    onQuantityChangeHandler: this._onQuantityChangeHandler,\n                    highlightSearchTerm: this._highlightSearchTerm\n                };\n                return <ProductConfiguration {...viewProps}/>;\n\n            case CONTENT.ProductList:\n                const productProps = {\n                    ...this.props,\n                    imageSettings: this.props.imageSettings || this.defaultImageSettings,\n                    clickHandler: this._onSelectItem,\n                    products: this.state.products,\n                    highlightSearchTerm: this._highlightSearchTerm\n                };\n\n                return <ProductList {...productProps}/>;\n\n            case CONTENT.Loading:\n                return <Loader msg={this.props.resources.progressNotificationText}/>;\n\n            case CONTENT.NotFound:\n                const { notFoundSearchErrorNotice, notFoundSearchErrorRedediation } = this.props.resources;\n\n                return <NotFoundComponent error={notFoundSearchErrorNotice} msg={notFoundSearchErrorRedediation}/>;\n\n            case CONTENT.Error:\n                return <div className='msc-alert-danger'>{this.props.resources.searchErrorMessage}</div>;\n\n            default:\n                return null;\n        }\n    }\n\n    // tslint:disable-next-line:no-any\n    private _addItemToTemplateHandler = async (config: IProductConfigurationState): Promise<ProductListLine> => {\n        const { orderTemplateId, context: { actionContext } } = this.props;\n        const input = new AddItemToOrderTemplateInput(\n            orderTemplateId,\n            config.product.RecordId,\n            config.quantity,\n            config.product.DefaultUnitOfMeasure || 'ea'\n        );\n\n        const result = await addItemToOrderTemplate(input, actionContext);\n\n        this.setState({\n            reloadPage: true\n        });\n\n        return result;\n    }\n\n    private _getSearchResults(searchText: string): Promise<ProductSearchResult[]> {\n        const {\n            context: {\n                actionContext,\n                request: {\n                    apiSettings: { channelId, catalogId }\n                }\n            }\n        } = this.props;\n        const searchCriteriaInput: ProductSearchCriteria = {};\n\n        searchCriteriaInput.Context = {\n            ChannelId: channelId,\n            CatalogId: catalogId\n        };\n        searchCriteriaInput.IncludeAttributes = true;\n        searchCriteriaInput.SearchCondition = searchText;\n\n        return searchByCriteriaAsync({ callerContext: actionContext }, searchCriteriaInput);\n    }\n\n    private async _getProductDimensions(product: SimpleProduct): Promise<ProductDimensionFull[]> {\n        const {\n            context: {\n                actionContext,\n                request: {\n                    apiSettings: { channelId }\n                }\n            }\n        } = this.props;\n        const id = product.MasterProductId ? product.MasterProductId : product.RecordId;\n\n        return getDimensionsForSelectedVariant(\n            new GetDimensionsForSelectedVariantInput(id, channelId, []),\n            actionContext\n        );\n    }\n\n    private _toggleModalHandler = () => {\n        this.setState({\n            isOpen: !this.state.isOpen,\n            content: CONTENT.Search\n        });\n\n        if (this.state.reloadPage) {\n            window.location.reload();\n            this.setState({\n                reloadPage: false\n            });\n        }\n\n    };\n}\n\nconst Loader = (props: { msg: string }) => (\n    <>\n        <div className='msc-add-line-to-template__loading__icon'/>\n        <div className='msc-add-line-to-template__loading__msg'>{props.msg}</div>\n    </>\n);\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}