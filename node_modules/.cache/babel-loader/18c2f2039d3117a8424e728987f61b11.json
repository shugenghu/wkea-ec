{"ast":null,"code":"import _toConsumableArray from\"@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{__decorate}from\"tslib\";import{withModuleState}from'@msdyn365-commerce-modules/checkout-utilities';import{getGiftCardAsync,getTenderTypesAsync,resolveCardTypesAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import classname from'classnames';import{computed,when}from'mobx';import{observer}from'mobx-react';import*as React from'react';import{OPERATIONS}from'../checkout';import{getForm}from'./components/get-form';import{getList}from'./components/get-list';import TitleCompoent from'./components/title';export*from'./components/get-form';export*from'./components/get-item';export*from'./components/get-list';var CheckoutGiftCard=/*#__PURE__*/function(_React$Component){_inherits(CheckoutGiftCard,_React$Component);var _super=_createSuper(CheckoutGiftCard);function CheckoutGiftCard(){var _this;_classCallCheck(this,CheckoutGiftCard);_this=_super.apply(this,arguments);_this.state={isFetchingGiftCard:false,errorMessage:'',giftCardNumber:'',giftCardPin:'',giftCardExp:''};_this.inputRef=/*#__PURE__*/React.createRef();_this.inputPinRef=/*#__PURE__*/React.createRef();_this.inputExpRef=/*#__PURE__*/React.createRef();_this.init=function(){var _this$props$data$chec;_this.props.moduleState.init(_objectSpread({onEdit:_this.onEdit,onCancel:_this.onCancel,onSubmit:_this.onSubmit,isRequired:false},!_this.isEnabled()&&{status:'disabled'}));var giftCards=(_this$props$data$chec=_this.props.data.checkout.result)===null||_this$props$data$chec===void 0?void 0:_this$props$data$chec.giftCardExtends;if(giftCards&&giftCards.length>0){_this.props.moduleState.onReady();}else if(_this.isPaymentVerificationRedirection){_this.props.moduleState.onSkip();}};_this.couldPaidByGiftCard=function(){var cart=_this.props.data.checkout.result?_this.props.data.checkout.result.checkoutCart.cart:undefined;if(!cart){return false;}return(cart.TotalAmount||0)>0;};_this.isEnabled=function(){if(!_this.props.context.request.user.isAuthenticated&&_this.props.context.app.config.giftCardSupported!=='external'){return false;}return _this.couldPaidByGiftCard();};_this.onEdit=function(){_this.props.moduleState.onUpdating();};_this.onCancel=function(){_this.handleCancelOrSubmit();};_this.onSubmit=function(){_this.handleCancelOrSubmit();};_this.handleCancelOrSubmit=function(){if(_this.hasSelectedItem){_this.props.moduleState.onReady();}else{_this.props.moduleState.onSkip();}};_this.getFormattedPrice=function(){var price=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var currencyCode=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'USD';return _this.props.context.cultureFormatter.formatCurrency(price,currencyCode);};_this.enterGiftCardNumber=function(giftCardNumber){_this.setState({giftCardNumber:giftCardNumber});_this.clearError();};_this.enterGiftCardPin=function(giftCardPin){_this.setState({giftCardPin:giftCardPin});_this.clearError();};_this.enterGiftCardExp=function(giftCardExp){_this.setState({giftCardExp:giftCardExp});_this.clearError();};_this.setError=function(errorMessage){_this.props.telemetry.error('Error',errorMessage);_this.props.telemetry.debug('Error',errorMessage);_this.props.moduleState.setHasError(true);_this.setState({errorMessage:errorMessage});};_this.clearError=function(){_this.props.moduleState.setHasError(false);_this.setState({errorMessage:''});};_this.removeGiftCard=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(giftCardNumber){var checkoutState;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:checkoutState=_this.props.data.checkout.result;if(checkoutState){_context.next=3;break;}return _context.abrupt(\"return\");case 3:_context.next=5;return checkoutState.removeGiftCard({giftCardNumber:giftCardNumber});case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.applyGiftCard=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var checkoutState,giftCardNumber,giftCardPin,giftCardExp,giftCardTypes,giftCardType,isPinRequired,isExpRequired,tenderTypeId,giftCard,input;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!_this.state.isFetchingGiftCard){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:_this.setState({isFetchingGiftCard:true});checkoutState=_this.props.data.checkout.result;giftCardNumber=_this.state.giftCardNumber.trim();giftCardPin=_this.state.giftCardPin.trim();giftCardExp=_this.state.giftCardExp.trim();_context2.next=9;return _this.getGiftCardTypes(giftCardNumber);case 9:giftCardTypes=_context2.sent;giftCardType=giftCardTypes&&giftCardTypes[0];isPinRequired=giftCardType&&giftCardType.IsPinRequired;isExpRequired=giftCardType&&giftCardType.IsExpirationDateRequired;tenderTypeId=giftCardType&&giftCardType.PaymentMethodId;_context2.next=16;return _this.getGiftCard(giftCardNumber,giftCardPin,giftCardExp,isPinRequired,isExpRequired,tenderTypeId);case 16:giftCard=_context2.sent;if(!(checkoutState&&giftCard)){_context2.next=25;break;}_context2.next=20;return checkoutState.addGiftCard({giftCard:giftCard,additionalProperties:{Pin:giftCardPin,ExpirationDate:giftCardExp,TenderTypeId:tenderTypeId}});case 20:_this.clearError();_this.setState({giftCardNumber:'',giftCardPin:'',giftCardExp:'',isFetchingGiftCard:false});return _context2.abrupt(\"return\",Promise.resolve());case 25:input=_this.inputRef&&_this.inputRef.current&&_this.inputRef.current.focus&&_this.inputRef.current;input&&input.focus();_this.setState({isFetchingGiftCard:false});case 28:case\"end\":return _context2.stop();}}},_callee2);}));_this.findGiftcardTenderTypes=function(tenderTypes,operationId,giftcardType){var matchedTenderTypes;switch(giftcardType){case\"internal\":matchedTenderTypes=tenderTypes.filter(function(tenderType){return tenderType.OperationId===operationId&&tenderType.ConnectorId==='';});break;case\"external\":matchedTenderTypes=tenderTypes.filter(function(tenderType){return tenderType.OperationId===operationId&&tenderType.ConnectorId!=='';});break;default:throw new Error('Invalid gift card type');}if(matchedTenderTypes){return matchedTenderTypes.map(function(tenderType){return tenderType.TenderTypeId||'';});}return;};_this.getGiftCard=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(giftCardNumber,giftCardPin,giftCardExp,isPinRequired,isExpRequired,tenderTypeId){var _this$props$resources,noBalanceError,invalidCardInfoError,invalidCardTypeError,noCardPinError,noCardExpError,supportedGiftCardType,tenderTypes,internalGiftcardTenderTypes,externalGiftcardTenderTypes,month,year;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_this$props$resources=_this.props.resources,noBalanceError=_this$props$resources.noBalanceError,invalidCardInfoError=_this$props$resources.invalidCardInfoError,invalidCardTypeError=_this$props$resources.invalidCardTypeError,noCardPinError=_this$props$resources.noCardPinError,noCardExpError=_this$props$resources.noCardExpError;supportedGiftCardType=_this.props.context.app.config.giftCardSupported;if(tenderTypeId){_context3.next=4;break;}return _context3.abrupt(\"return\",undefined);case 4:_context3.next=6;return getTenderTypesAsync({callerContext:_this.props.context.actionContext,queryResultSettings:{}})[\"catch\"](function(error){throw error;});case 6:tenderTypes=_context3.sent;if(tenderTypes){_context3.next=9;break;}throw new Error('Fail to get gift card tender line');case 9:internalGiftcardTenderTypes=_this.findGiftcardTenderTypes(tenderTypes,OPERATIONS.PayGiftCertificate,\"internal\");externalGiftcardTenderTypes=_this.findGiftcardTenderTypes(tenderTypes,OPERATIONS.PayGiftCertificate,\"external\");_context3.t0=supportedGiftCardType;_context3.next=_context3.t0===undefined?14:_context3.t0===\"internal\"?14:_context3.t0===\"external\"?18:_context3.t0===\"both\"?22:26;break;case 14:if(internalGiftcardTenderTypes!==null&&internalGiftcardTenderTypes!==void 0&&internalGiftcardTenderTypes.includes(tenderTypeId)){_context3.next=17;break;}_this.setError(invalidCardTypeError);return _context3.abrupt(\"return\",undefined);case 17:return _context3.abrupt(\"break\",27);case 18:if(externalGiftcardTenderTypes!==null&&externalGiftcardTenderTypes!==void 0&&externalGiftcardTenderTypes.includes(tenderTypeId)){_context3.next=21;break;}_this.setError(invalidCardTypeError);return _context3.abrupt(\"return\",undefined);case 21:return _context3.abrupt(\"break\",27);case 22:if(!(!(internalGiftcardTenderTypes!==null&&internalGiftcardTenderTypes!==void 0&&internalGiftcardTenderTypes.includes(tenderTypeId))&&!(externalGiftcardTenderTypes!==null&&externalGiftcardTenderTypes!==void 0&&externalGiftcardTenderTypes.includes(tenderTypeId)))){_context3.next=25;break;}_this.setError(invalidCardTypeError);return _context3.abrupt(\"return\",undefined);case 25:return _context3.abrupt(\"break\",27);case 26:throw new Error('Unsupported gift card type');case 27:if(!(isPinRequired&&giftCardPin==='')){_context3.next=30;break;}_this.setError(noCardPinError);return _context3.abrupt(\"return\",undefined);case 30:if(!(isExpRequired&&giftCardExp==='')){_context3.next=33;break;}_this.setError(noCardExpError);return _context3.abrupt(\"return\",undefined);case 33:month=parseInt(giftCardExp.split('/')[0],10);year=parseInt(giftCardExp.split('/')[1],10);return _context3.abrupt(\"return\",getGiftCardAsync({callerContext:_this.props.context.actionContext},giftCardNumber,tenderTypeId,giftCardPin,month,year).then(function(activeGiftCard){if(!activeGiftCard.Balance||activeGiftCard.Balance===0){_this.setError(noBalanceError);return;}return activeGiftCard;})[\"catch\"](function(error){_this.setError(invalidCardInfoError);return undefined;}));case 36:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x2,_x3,_x4,_x5,_x6,_x7){return _ref3.apply(this,arguments);};}();_this.getGiftCardTypes=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(giftCardNumber){var _this$props,_this$props$resources2,emptyInputError,duplicatedCodeError,invalidCodeError,checkout,isDuplicated,GIFTCARDTYPE;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_this$props=_this.props,_this$props$resources2=_this$props.resources,emptyInputError=_this$props$resources2.emptyInputError,duplicatedCodeError=_this$props$resources2.duplicatedCodeError,invalidCodeError=_this$props$resources2.invalidCodeError,checkout=_this$props.data.checkout;if(giftCardNumber){_context4.next=4;break;}_this.setError(emptyInputError);return _context4.abrupt(\"return\",undefined);case 4:isDuplicated=checkout.result&&checkout.result.giftCardExtends.some(function(card){return card.Id===giftCardNumber;});if(!isDuplicated){_context4.next=8;break;}_this.setError(duplicatedCodeError);return _context4.abrupt(\"return\",undefined);case 8:GIFTCARDTYPE=7;return _context4.abrupt(\"return\",resolveCardTypesAsync({callerContext:_this.props.context.actionContext},giftCardNumber,GIFTCARDTYPE).then(function(giftCardTypes){if(!giftCardTypes||giftCardTypes.length===0||giftCardTypes[0]===undefined){_this.setError(invalidCodeError);return;}return giftCardTypes;})[\"catch\"](function(error){_this.setError(invalidCodeError);return undefined;}));case 10:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x8){return _ref4.apply(this,arguments);};}();return _this;}_createClass(CheckoutGiftCard,[{key:\"componentDidMount\",value:function componentDidMount(){var _this2=this;when(function(){return _this2.isDataReady;},function(){_this2.init();});}},{key:\"render\",value:function render(){var _this$props2=this.props,isReady=_this$props2.moduleState.isReady,checkout=_this$props2.data.checkout,_this$props2$config=_this$props2.config,className=_this$props2$config.className,showAdditionalFields=_this$props2$config.showAdditionalFields,resources=_this$props2.resources;var _this$state=this.state,errorMessage=_this$state.errorMessage,giftCardNumber=_this$state.giftCardNumber,giftCardPin=_this$state.giftCardPin,giftCardExp=_this$state.giftCardExp;var giftCards=checkout.result&&checkout.result.giftCardExtends;var additionalFields=showAdditionalFields;var supportedGiftCardType=this.props.context.app.config.giftCardSupported;if(!this.isEnabled()||!this.shouldPayGiftCard&&!isReady){this.props.context.telemetry.error('Checkout giftcard content is empty, module wont render');return null;}var supportExternalGiftCard=supportedGiftCardType===\"internal\"?false:true;var moduleClassName=classname('ms-checkout-gift-card',className,isReady?'show':'add');var viewProps=_objectSpread(_objectSpread(_objectSpread({},this.props),this.state),{},{className:moduleClassName,checkoutGiftCardProps:{moduleProps:this.props,className:moduleClassName},couldPaidByGiftCard:this.couldPaidByGiftCard(),isEnabled:this.isEnabled(),onEdit:this.onEdit,onCancel:this.onCancel,onSubmit:this.onSubmit,enterGiftCardNumber:this.enterGiftCardNumber,enterGiftCardPin:this.enterGiftCardPin,enterGiftCardExp:this.enterGiftCardExp,removeGiftCard:this.removeGiftCard,applyGiftCard:this.applyGiftCard,showGiftCard:isReady?{title:/*#__PURE__*/React.createElement(TitleCompoent,{title:resources.giftCardFormLabel}),list:getList({canRemove:false,getFormattedPrice:this.getFormattedPrice,giftCards:giftCards&&_toConsumableArray(giftCards),onRemoveGiftCard:this.removeGiftCard,resources:resources})}:undefined,addGiftCard:!isReady?{form:getForm({errorMessage:errorMessage,giftCardNumber:giftCardNumber,giftCardPin:giftCardPin,giftCardExp:giftCardExp,inputRef:this.inputRef,inputPinRef:this.inputPinRef,inputExpRef:this.inputExpRef,resources:resources,onEnterGiftCardNumber:this.enterGiftCardNumber,onEnterGiftCardPin:this.enterGiftCardPin,onEnterGiftCardExp:this.enterGiftCardExp,onApplyGiftCard:this.applyGiftCard,supportExternalGiftCard:supportExternalGiftCard,additionalFields:additionalFields}),list:getList({canRemove:true,getFormattedPrice:this.getFormattedPrice,giftCards:giftCards&&_toConsumableArray(giftCards),onRemoveGiftCard:this.removeGiftCard,resources:resources})}:undefined});return this.props.renderView(viewProps);}},{key:\"isDataReady\",get:function get(){return(this.props.data.checkout.result&&this.props.data.checkout.status)==='SUCCESS';}},{key:\"getLoyaltyAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;if(!checkoutState||!checkoutState.loyaltyAmount){return 0;}return checkoutState.loyaltyAmount;}},{key:\"shouldPayGiftCard\",get:function get(){var cart=this.props.data.checkout.result?this.props.data.checkout.result.checkoutCart.cart:undefined;if(!cart){return false;}var amountDue=(cart.TotalAmount||0)-this.getLoyaltyAmount;return amountDue>0;}},{key:\"hasSelectedItem\",get:function get(){var checkout=this.props.data.checkout;var giftCards=checkout.result&&checkout.result.giftCardExtends;return!!giftCards&&giftCards.length>0;}},{key:\"isPaymentVerificationRedirection\",get:function get(){var _this$props$context$r=this.props.context.request,requestFormData=_this$props$context$r.requestFormData,query=_this$props$context$r.query;return requestFormData&&query&&query.pv==='1'?true:false;}}]);return CheckoutGiftCard;}(React.Component);__decorate([computed],CheckoutGiftCard.prototype,\"isDataReady\",null);__decorate([computed],CheckoutGiftCard.prototype,\"getLoyaltyAmount\",null);__decorate([computed],CheckoutGiftCard.prototype,\"shouldPayGiftCard\",null);__decorate([computed],CheckoutGiftCard.prototype,\"hasSelectedItem\",null);__decorate([computed],CheckoutGiftCard.prototype,\"isPaymentVerificationRedirection\",null);CheckoutGiftCard=__decorate([observer],CheckoutGiftCard);export{CheckoutGiftCard};export default withModuleState(CheckoutGiftCard);","map":{"version":3,"sources":["modules/checkout-gift-card/checkout-gift-card.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IModuleStateProps, withModuleState } from '@msdyn365-commerce-modules/checkout-utilities';\nimport { IModuleProps } from '@msdyn365-commerce-modules/utilities';\nimport {\n    getGiftCardAsync, getTenderTypesAsync, resolveCardTypesAsync\n} from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport {\n    CardType, CardTypeInfo, GiftCard, RetailOperation, TenderType\n} from '@msdyn365-commerce/retail-proxy/dist/Entities/CommerceTypes.g';\nimport classname from 'classnames';\nimport { computed, when } from 'mobx';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\n\nimport { OPERATIONS } from '../checkout';\nimport { ICheckoutGiftCardData } from './checkout-gift-card.data';\nimport { ICheckoutGiftCardProps } from './checkout-gift-card.props.autogenerated';\nimport { getForm, IForm } from './components/get-form';\nimport { getList, IList } from './components/get-list';\nimport TitleCompoent from './components/title';\n\nexport * from './components/get-form';\nexport * from './components/get-item';\nexport * from './components/get-list';\n\ninterface ICheckoutGiftCardState {\n    isFetchingGiftCard: boolean;\n    errorMessage: string;\n    giftCardNumber: string;\n    giftCardPin: string;\n    giftCardExp: string;\n}\n\nconst enum SupportedGiftCardType {\n    Internal = 'internal',\n    External = 'external',\n    Both = 'both'\n}\n\nexport interface ICheckoutGiftCardModuleProps extends ICheckoutGiftCardProps<ICheckoutGiftCardData>, IModuleStateProps { }\n\nexport interface IShowResource {\n    title: React.ReactNode;\n    list?: IList;\n}\n\nexport interface IAddResource {\n    form: IForm;\n    list?: IList;\n}\n\nexport interface ICheckoutGiftCardViewProps extends ICheckoutGiftCardProps<{}>, ICheckoutGiftCardState {\n    className?: string;\n\n    showGiftCard?: IShowResource;\n    addGiftCard?: IAddResource;\n\n    checkoutGiftCardProps: IModuleProps;\n    couldPaidByGiftCard?: boolean;\n    isEnabled?: boolean;\n    onEdit?(): void;\n    onCancel?(): void;\n    onSubmit?(): void;\n    enterGiftCardNumber?(giftCardNumber: string): void;\n    enterGiftCardPin?(giftCardNumber: string): void;\n    enterGiftCardExp?(giftCardNumber: string): void;\n    removeGiftCard?(giftCardNumber: string): void;\n    applyGiftCard?(): void;\n}\n\n/**\n *\n * CheckoutGiftCard component\n * @extends {React.Component<ICheckoutGiftCardProps<ICheckoutGiftCardData>, ICheckoutGiftCardState>}\n */\n@observer\nexport class CheckoutGiftCard extends React.Component<ICheckoutGiftCardModuleProps, ICheckoutGiftCardState> {\n    public state: ICheckoutGiftCardState = {\n        isFetchingGiftCard: false,\n        errorMessage: '',\n        giftCardNumber: '',\n        giftCardPin: '',\n        giftCardExp: ''\n    };\n\n    private inputRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    private inputPinRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    private inputExpRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    @computed get isDataReady(): boolean {\n        return (this.props.data.checkout.result && this.props.data.checkout.status) === 'SUCCESS';\n    }\n\n    @computed get getLoyaltyAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        if (!checkoutState || !checkoutState.loyaltyAmount) {\n            return 0;\n        }\n        return checkoutState.loyaltyAmount;\n    }\n\n    @computed get shouldPayGiftCard(): boolean {\n        const cart = this.props.data.checkout.result ? this.props.data.checkout.result.checkoutCart.cart : undefined;\n        if (!cart) {\n            return false;\n        }\n        // Use gift card card when loyalty points do not cover the total amount\n        const amountDue = (cart.TotalAmount || 0) - this.getLoyaltyAmount;\n        return amountDue > 0;\n    }\n\n    @computed get hasSelectedItem(): boolean {\n        const {\n            data: { checkout }\n        } = this.props;\n        const giftCards = checkout.result && checkout.result.giftCardExtends;\n        return !!giftCards && giftCards.length > 0;\n    }\n\n    @computed get isPaymentVerificationRedirection(): boolean {\n        const { requestFormData, query } = this.props.context.request;\n        return (requestFormData && query && query.pv === '1') ? true : false;\n    }\n\n    public componentDidMount(): void {\n        // @ts-ignore: Compiler not reconizing condition check for function params\n        when(\n            () => this.isDataReady,\n            () => {\n                this.init();\n            }\n        );\n    }\n\n    public render(): JSX.Element | null {\n        const {\n            moduleState: { isReady },\n            data: { checkout },\n            config: { className, showAdditionalFields },\n            resources\n        } = this.props;\n        const { errorMessage, giftCardNumber, giftCardPin, giftCardExp } = this.state;\n        const giftCards = checkout.result && checkout.result.giftCardExtends;\n        const additionalFields = showAdditionalFields;\n        const supportedGiftCardType = this.props.context.app.config.giftCardSupported;\n\n        if (!this.isEnabled() || (!this.shouldPayGiftCard && !isReady)) {\n            this.props.context.telemetry.error('Checkout giftcard content is empty, module wont render');\n            return null;\n        }\n\n        const supportExternalGiftCard = supportedGiftCardType === SupportedGiftCardType.Internal ? false : true;\n\n        const moduleClassName = classname('ms-checkout-gift-card', className, isReady ? 'show' : 'add');\n\n        const viewProps: ICheckoutGiftCardViewProps = {\n            ...this.props,\n            ...this.state,\n            className: moduleClassName,\n\n            checkoutGiftCardProps: { moduleProps: this.props, className: moduleClassName },\n            couldPaidByGiftCard: this.couldPaidByGiftCard(),\n            isEnabled: this.isEnabled(),\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n            enterGiftCardNumber: this.enterGiftCardNumber,\n            enterGiftCardPin: this.enterGiftCardPin,\n            enterGiftCardExp: this.enterGiftCardExp,\n            removeGiftCard: this.removeGiftCard,\n            applyGiftCard: this.applyGiftCard,\n            showGiftCard: isReady\n                ? {\n                    title: <TitleCompoent title={resources.giftCardFormLabel} />,\n                    list: getList({\n                        canRemove: false,\n                        getFormattedPrice: this.getFormattedPrice,\n                        giftCards: giftCards && [...giftCards], // Note: ReadOnly Checkout State GiftCard[] is not assignable to GiftCard[] type\n                        onRemoveGiftCard: this.removeGiftCard,\n                        resources\n                    })\n                }\n                : undefined,\n            addGiftCard: !isReady\n                ? {\n                    form: getForm({\n                        errorMessage,\n                        giftCardNumber,\n                        giftCardPin,\n                        giftCardExp,\n                        inputRef: this.inputRef,\n                        inputPinRef: this.inputPinRef,\n                        inputExpRef: this.inputExpRef,\n                        resources,\n                        onEnterGiftCardNumber: this.enterGiftCardNumber,\n                        onEnterGiftCardPin: this.enterGiftCardPin,\n                        onEnterGiftCardExp: this.enterGiftCardExp,\n                        onApplyGiftCard: this.applyGiftCard,\n                        supportExternalGiftCard,\n                        additionalFields\n                    }),\n                    list: getList({\n                        canRemove: true,\n                        getFormattedPrice: this.getFormattedPrice,\n                        giftCards: giftCards && [...giftCards], // Note: ReadOnly Checkout State GiftCard[] is not assignable to GiftCard[] type\n                        onRemoveGiftCard: this.removeGiftCard,\n                        resources\n                    })\n                }\n                : undefined\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    private init = (): void => {\n        this.props.moduleState.init({\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n            isRequired: false,\n            ...(!this.isEnabled() && { status: 'disabled' })\n        });\n\n        const giftCards = this.props.data.checkout.result?.giftCardExtends;\n        if (giftCards && giftCards.length > 0) {\n            this.props.moduleState.onReady();\n        } else if (this.isPaymentVerificationRedirection) {\n            this.props.moduleState.onSkip();\n        }\n\n    };\n\n    private couldPaidByGiftCard = (): boolean => {\n        const cart = this.props.data.checkout.result ? this.props.data.checkout.result.checkoutCart.cart : undefined;\n        if (!cart) {\n            return false;\n        }\n        // Use gift card when it is not free\n        return (cart.TotalAmount || 0) > 0;\n    };\n\n    private isEnabled = (): boolean => {\n        if (!this.props.context.request.user.isAuthenticated && this.props.context.app.config.giftCardSupported !== 'external') {\n            return false;\n        }\n        return this.couldPaidByGiftCard();\n    };\n\n    private onEdit = (): void => {\n        // Show add gift card form\n        this.props.moduleState.onUpdating();\n    };\n\n    private onCancel = (): void => {\n        this.handleCancelOrSubmit();\n    };\n\n    private onSubmit = (): void => {\n        this.handleCancelOrSubmit();\n    };\n\n    private handleCancelOrSubmit = () => {\n        if (this.hasSelectedItem) {\n            // Show summary screen\n            this.props.moduleState.onReady();\n        } else {\n            // Skip the module\n            this.props.moduleState.onSkip();\n        }\n    };\n\n    private getFormattedPrice = (price: number = 0, currencyCode: string = 'USD'): string => {\n        return this.props.context.cultureFormatter.formatCurrency(price, currencyCode);\n    };\n\n    private enterGiftCardNumber = (giftCardNumber: string): void => {\n        this.setState({\n            giftCardNumber\n        });\n        this.clearError();\n    };\n\n    private enterGiftCardPin = (giftCardPin: string): void => {\n        this.setState({\n            giftCardPin\n        });\n        this.clearError();\n    };\n\n    private enterGiftCardExp = (giftCardExp: string): void => {\n        this.setState({\n            giftCardExp\n        });\n        this.clearError();\n    };\n\n    private setError = (errorMessage: string): void => {\n        this.props.telemetry.error('Error', errorMessage);\n        this.props.telemetry.debug('Error', errorMessage);\n        this.props.moduleState.setHasError(true);\n        this.setState({\n            errorMessage\n        });\n    };\n\n    private clearError = (): void => {\n        this.props.moduleState.setHasError(false);\n        this.setState({\n            errorMessage: ''\n        });\n    };\n\n    private removeGiftCard = async (giftCardNumber: string): Promise<void> => {\n        const checkoutState = this.props.data.checkout.result;\n        if (!checkoutState) {\n            return;\n        }\n\n        await checkoutState.removeGiftCard({ giftCardNumber });\n    };\n\n    private applyGiftCard = async (): Promise<void> => {\n        if (this.state.isFetchingGiftCard) {\n            return;\n        }\n        this.setState({\n            isFetchingGiftCard: true\n        });\n\n        const checkoutState = this.props.data.checkout.result;\n        const giftCardNumber = this.state.giftCardNumber.trim();\n        const giftCardPin = this.state.giftCardPin.trim();\n        const giftCardExp = this.state.giftCardExp.trim();\n\n        const giftCardTypes = await this.getGiftCardTypes(giftCardNumber);\n        const giftCardType = giftCardTypes && giftCardTypes[0];\n        const isPinRequired = giftCardType && giftCardType.IsPinRequired;\n        const isExpRequired = giftCardType && giftCardType.IsExpirationDateRequired;\n        const tenderTypeId = giftCardType && giftCardType.PaymentMethodId;\n        const giftCard = await this.getGiftCard(giftCardNumber, giftCardPin, giftCardExp, isPinRequired, isExpRequired, tenderTypeId);\n\n        if (checkoutState && giftCard) {\n            await checkoutState.addGiftCard({ giftCard: giftCard, additionalProperties: { Pin: giftCardPin, ExpirationDate: giftCardExp, TenderTypeId: tenderTypeId } });\n            this.clearError();\n            this.setState({\n                giftCardNumber: '',\n                giftCardPin: '',\n                giftCardExp: '',\n                isFetchingGiftCard: false\n            });\n            return Promise.resolve();\n        } else {\n            const input =\n                this.inputRef && this.inputRef.current && this.inputRef.current.focus && (this.inputRef.current as HTMLElement);\n            input && input.focus();\n            this.setState({\n                isFetchingGiftCard: false\n            });\n        }\n    };\n\n    private findGiftcardTenderTypes = (tenderTypes: TenderType[], operationId: RetailOperation, giftcardType: string): string[] | undefined => {\n        let matchedTenderTypes: TenderType[] | undefined;\n\n        switch (giftcardType) {\n            case SupportedGiftCardType.Internal:\n                matchedTenderTypes = tenderTypes.filter(tenderType => (tenderType.OperationId === operationId && tenderType.ConnectorId === ''));\n                break;\n            case SupportedGiftCardType.External:\n                matchedTenderTypes = tenderTypes.filter(tenderType => (tenderType.OperationId === operationId && tenderType.ConnectorId !== ''));\n                break;\n            default:\n                throw new Error('Invalid gift card type');\n        }\n\n        if (matchedTenderTypes) {\n            return matchedTenderTypes.map(tenderType => tenderType.TenderTypeId || '');\n        }\n        return;\n    };\n\n    private getGiftCard = async (giftCardNumber: string, giftCardPin: string, giftCardExp: string, isPinRequired: boolean | undefined, isExpRequired: boolean | undefined, tenderTypeId: string | undefined): Promise<GiftCard | undefined> => {\n        const {\n            resources: { noBalanceError, invalidCardInfoError, invalidCardTypeError, noCardPinError, noCardExpError }\n        } = this.props;\n\n        const supportedGiftCardType = this.props.context.app.config.giftCardSupported;\n\n        if (!tenderTypeId) {\n            return undefined;\n        }\n\n        const tenderTypes = await getTenderTypesAsync({ callerContext: this.props.context.actionContext, queryResultSettings: {} }).catch(error => {\n            throw error;\n        });\n\n        if (!tenderTypes) {\n            throw new Error('Fail to get gift card tender line');\n        }\n        const internalGiftcardTenderTypes = this.findGiftcardTenderTypes(tenderTypes, OPERATIONS.PayGiftCertificate, SupportedGiftCardType.Internal);\n        const externalGiftcardTenderTypes = this.findGiftcardTenderTypes(tenderTypes, OPERATIONS.PayGiftCertificate, SupportedGiftCardType.External);\n\n        switch (supportedGiftCardType) {\n            case undefined:\n            case SupportedGiftCardType.Internal:\n                if (!internalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this.setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            case SupportedGiftCardType.External:\n                if (!externalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this.setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            case SupportedGiftCardType.Both:\n                if (!internalGiftcardTenderTypes?.includes(tenderTypeId) && !externalGiftcardTenderTypes?.includes(tenderTypeId)) {\n                    this.setError(invalidCardTypeError);\n                    return undefined;\n                }\n                break;\n            default:\n                throw new Error('Unsupported gift card type');\n        }\n\n        if (isPinRequired && giftCardPin === '') {\n            this.setError(noCardPinError);\n            return undefined;\n        }\n\n        if (isExpRequired && giftCardExp === '') {\n            this.setError(noCardExpError);\n            return undefined;\n        }\n\n        const month = parseInt(giftCardExp.split('/')[0], 10);\n        const year = parseInt(giftCardExp.split('/')[1], 10);\n\n        return getGiftCardAsync({ callerContext: this.props.context.actionContext }, giftCardNumber, tenderTypeId, giftCardPin, month, year)\n            .then(activeGiftCard => {\n                if (!activeGiftCard.Balance || activeGiftCard.Balance === 0) {\n                    this.setError(noBalanceError);\n                    return;\n                }\n                return activeGiftCard;\n            })\n            .catch(error => {\n                this.setError(invalidCardInfoError);\n                return undefined;\n            });\n    };\n\n    private getGiftCardTypes = async (giftCardNumber: string): Promise<CardTypeInfo[] | undefined> => {\n        const {\n            resources: { emptyInputError, duplicatedCodeError, invalidCodeError },\n            data: { checkout }\n        } = this.props;\n\n        if (!giftCardNumber) {\n            this.setError(emptyInputError);\n            return undefined;\n        }\n\n        const isDuplicated = checkout.result && checkout.result.giftCardExtends.some((card: GiftCard) => card.Id === giftCardNumber);\n        if (isDuplicated) {\n            this.setError(duplicatedCodeError);\n            return undefined;\n        }\n\n        const GIFTCARDTYPE =  7 as CardType.GiftCard; // This is a workaround. ts-jest doesn't support 'const enum'\n\n        return resolveCardTypesAsync({ callerContext: this.props.context.actionContext }, giftCardNumber, GIFTCARDTYPE)\n            .then(giftCardTypes => {\n                if (!giftCardTypes || giftCardTypes.length === 0 || giftCardTypes[0] === undefined) {\n                    this.setError(invalidCodeError);\n                    return;\n                }\n                return giftCardTypes;\n            })\n            .catch(error => {\n                this.setError(invalidCodeError);\n                return undefined;\n            });\n    };\n}\n\nexport default withModuleState(CheckoutGiftCard);"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}