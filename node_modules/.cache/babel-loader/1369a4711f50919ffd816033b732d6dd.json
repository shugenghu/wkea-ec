{"ast":null,"code":"import\"core-js/modules/es.object.assign.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _get2 from\"lodash/get\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{__decorate,__metadata}from\"tslib\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */ // tslint:disable:no-use-before-declare\nimport{CoreContext,isAuthoringEditEnabled,msdyn365Commerce,SDK_FRAGMENT_NAME,WithContext}from'@msdyn365-commerce/core-internal';import{asSystemMetadata,EXCEPTION_MISSINGMODULECONFIG,EXCEPTION_MODULERENDERFAIL,EXCEPTION_NOMODULEBINDER,EXCEPTION_UNREGISTEREDMODULEID,LogLevel}from'@msdyn365-commerce/telemetry-internal';import{observer}from'mobx-react';import*as React from'react';import ReactDOM from'react-dom';import{ReportChunks}from'react-universal-component';import{LAYOUT_MOUNT_POINT,MODULE_CONFIG_ERRORS_KEY,MODULE_LAYOUT_FIELD}from'../consts';import{AddControlMode,AddModuleControl}from'./add-module-control';import{AddModuleWrapper}from'./add-module-wrapper';import{ErrorModule,renderErrorOrPlaceHolderModules}from'./error-module';import{renderView}from'./render-view';/**\r\n * Component to render module\r\n */let SafeRenderModule=class SafeRenderModule extends React.Component{constructor(props){super(props);this.shouldDisplayErrors=false;this.isRenderAttrributeCalled=false;this.disableDefer=false;this.renderModuleAttributes=props=>{var _props$context$reques;this.isRenderAttrributeCalled=true;if(!props||!props.id){return{};}// Construct telemetry attributes for module\nconst telemetryId=props.friendlyName||props.id;const telemetryAttributes=this.props.internalTelemetry&&this.props.internalTelemetry.setTelemetryAttribute?this.props.internalTelemetry.setTelemetryAttribute(telemetryId):{};const moduleAttributes=_objectSpread({'data-m-t':props.typeName},telemetryAttributes);if(this.shouldDisplayErrors||this._isEditorial()){moduleAttributes['data-i']=this._setDataInfoAttribute(props);}if(props.platform&&typeof props.platform==='object'){Object.keys(props.platform).forEach(key=>{moduleAttributes[\"data-m-\".concat(key)]=props.platform[key];});}// If a module is associated with an experiment, add this attribtue to track when to activate the experiment\nif(props.context.request&&(_props$context$reques=props.context.request.experiments)!==null&&_props$context$reques!==void 0&&_props$context$reques.moduleIdToExperimentIdMap){if(props.context.request.experiments.moduleIdToExperimentIdMap[props.id]){moduleAttributes[\"data-exp\"]=\"id:\".concat(props.context.request.experiments.moduleIdToExperimentIdMap[props.id]);}}// In editor scenario, Authoring will update the module layout by sending us updates on\n// the MODULE_LAYOUT_FIELD in the config object\nif(this._isEditorial()&&props.config&&props.config[MODULE_LAYOUT_FIELD]){moduleAttributes[\"data-m-layout\"]=props.config[MODULE_LAYOUT_FIELD];}return moduleAttributes;};this.state={error:undefined,info:undefined,isConfigured:true,isRegistered:true,mounted:false};this.componentRef=/*#__PURE__*/React.createRef();this.shouldDisplayErrors=props&&props.context?props.context.request.params.isDebug:true;// Modules should use defer render strategy if in editor or debug mode\nthis.disableDefer=props.context&&props.app&&props.app.config&&props.app.config.disableServerSideErrorChecking&&!props.context.request.params.isDebug&&!props.context.request.params.isEditor;this.props.internalTelemetry.log(LogLevel.Debug,\"Safe Render module constructor type-'{typeName}' with id-'{id} and is \".concat(this.disableDefer?'not ':'',\"using defer module.'\"),{values:[asSystemMetadata(this.props.typeName),asSystemMetadata(this.props.id)]});}static getDerivedStateFromError(error){return{error:error};}componentDidMount(){if(!this.state.mounted){this.setState({mounted:true});}if(this.isRenderAttrributeCalled){return;}this._setErrorStates();this._setDataAttributes();}shouldComponentUpdate(nextProps,nextState){if(this._isEditorial()){if(nextState.error){this.props.store.requestCache.put({typeName:MODULE_CONFIG_ERRORS_KEY,key:this.props.id},{item:[{property:this.props.id,message:nextState.error.message}]});}}return true;}componentDidUpdate(){if(this.isRenderAttrributeCalled){return;}this._setErrorStates();this._setDataAttributes();}componentDidCatch(error,info){this.setState({error,info});}// tslint:disable-next-line:cyclomatic-complexity\nrender(){const config=this.props.config;const{internalTelemetry}=this.props;internalTelemetry.log(LogLevel.Debug,\"Safe Render module render type-'{typeName}' with id-'{id}'\",{values:[asSystemMetadata(this.props.typeName),asSystemMetadata(this.props.id)]});const mappedProps=mapStateToProps(this.props.store,this.props);const{id,typeName}=mappedProps&&mappedProps.id?mappedProps:this.props;const configErrors=mappedProps.configErrors;const Component=mappedProps.component;if(!Component){const message=internalTelemetry.stringFormat(EXCEPTION_UNREGISTEREDMODULEID,[id,typeName]);internalTelemetry.log(LogLevel.Error,message);return/*#__PURE__*/React.createElement(ErrorModule,Object.assign({errorType:'unregistered'},_objectSpread(_objectSpread({},this.props),mappedProps),{error:new Error(message),renderModuleAttributes:this.renderModuleAttributes,renderView:renderView}));}const err=this.state.error||configErrors&&configErrors.length&&new Error(configErrors.map(x=>x.message).join(', '));if(err){const element=renderErrorOrPlaceHolderModules(err,internalTelemetry,mappedProps,this.state,this.props,this._isEditorial(),this.renderModuleAttributes);if(element){return element;}}if(process.env.CURRENT_ENVIRONMENT==='node'){if(config&&config.hasOwnProperty('clientRender')&&config.clientRender&&!this._isEditorial()){return/*#__PURE__*/React.createElement(React.Fragment,null);}else{return this._doServerSideRender(mappedProps,Component,internalTelemetry);}}else if(!this.state.mounted&&(this.disableDefer||this.props.store.deferred(this.props.id))){// module needs two passes\nreturn null;}else if(config&&config.hasOwnProperty('clientRender')&&config.clientRender&&!this._isEditorial()){if(this.state.mounted){return/*#__PURE__*/React.createElement(Component,Object.assign({},mappedProps,{ref:this.componentRef},{renderModuleAttributes:this.renderModuleAttributes,renderView:renderView}));}else{return/*#__PURE__*/React.createElement(React.Fragment,null);}}return/*#__PURE__*/React.createElement(Component,Object.assign({},mappedProps,{ref:this.componentRef},{renderModuleAttributes:this.renderModuleAttributes,renderView:renderView}));}/**\r\n     * Set the data info attribute to be added to the modules\r\n     * @param props The module props.\r\n     */_setDataInfoAttribute(props){const dataInfo=[\"id:\".concat(props.id)];props.slotId&&dataInfo.push(\"s:\".concat(props.slotId));props.parentId&&dataInfo.push(\"p:\".concat(props.parentId));props.typeName&&dataInfo.push(\"t:\".concat(props.typeName));props.friendlyName&&dataInfo.push(\"fn:\".concat(props.friendlyName));// @ts-ignore\nconst moduleBinder=msdyn365Commerce.moduleBinder(props.typeName);if(moduleBinder){moduleBinder.$type&&dataInfo.push(\"mt:\".concat(moduleBinder.$type));}props.errorType&&dataInfo.push(\"e:\".concat(props.errorType));return\"{\".concat(dataInfo.join(','),\"}\");}/**\r\n     * isEditor\r\n     * Determines if request is coming from the editor\r\n     */_isEditorial(){return _get2(this.props,['context','request','params','isEditor'],false);}/**\r\n     * Creates data info string to be used by cms e.g '{id:prop-id,s:content,p:parent-id}'\r\n     */_generateDataInfo(){const dataInfo=[\"id:\".concat(this.props.id)];this.props.slotId&&dataInfo.push(\"s:\".concat(this.props.slotId));this.props.parentId&&dataInfo.push(\"p:\".concat(this.props.parentId));this.props.typeName&&dataInfo.push(\"t:\".concat(this.props.typeName));this.props.friendlyName&&dataInfo.push(\"fn:\".concat(this.props.friendlyName));// @ts-ignore\nconst moduleBinder=msdyn365Commerce.moduleBinder(this.props.typeName);if(moduleBinder){moduleBinder.$type&&dataInfo.push(\"mt:\".concat(moduleBinder.$type));}// Error scenarios\n// 1. Empty module\n// 2. Unregistered module\n// 3. Generic error\n!this.state.isConfigured&&dataInfo.push('e:empty');!this.state.isRegistered&&dataInfo.push('e:unregistered');this.state.error&&dataInfo.push('e:error');return\"{\".concat(dataInfo.join(','),\"}\");}/**\r\n     * Conducts the server side render and returns the result.\r\n     * If disable defer flag is turned on, the React Element is returned immediately,\r\n     * otherwise the render result is calculated using renderToString to catch errors\r\n     * and defer modules (used for editor and debug scenarios)\r\n     */ // tslint:disable-next-line: no-any\n_doServerSideRender(// tslint:disable-next-line: no-any\nmappedProps,// tslint:disable-next-line: no-any\nComponent,internalTelemetry){let renderHtmlString;const renderHtml=/*#__PURE__*/React.createElement(CoreContext.Provider,{value:this.props.context},/*#__PURE__*/React.createElement(ReportChunks,{report:this.props.addChunk},/*#__PURE__*/React.createElement(Component,Object.assign({},mappedProps,{renderModuleAttributes:this.renderModuleAttributes,renderView:renderView}))));if(this.disableDefer){// In non editorial or non debug mode and if app setting to disable server side error checking is turned on\n// return the JSX directly without computing the render result to save time and compute cost\nreturn renderHtml;}else{try{// tslint:disable-next-line:no-require-imports\nrenderHtmlString=require('react-dom/server').renderToString(renderHtml);if(!renderHtmlString.length){// module returned null\nthis.props.store.markModuleAsDeferred(this.props.id);}}catch(e){internalTelemetry.log(LogLevel.Error,\"Safe Render module Failed to render type-'{typeName}' with id-'{id}'\",{exception:e,values:[asSystemMetadata(this.props.typeName),asSystemMetadata(this.props.id)]});return/*#__PURE__*/React.createElement(ErrorModule,Object.assign({},mappedProps,{errorType:'error',error:e,message:e&&e.stack,renderModuleAttributes:this.renderModuleAttributes,renderView:renderView}));}// tslint:disable:react-no-dangerous-html -- intentionally set inner html\nreturn/*#__PURE__*/React.createElement(SDK_FRAGMENT_NAME,{key:this.props.id,dangerouslySetInnerHTML:{__html:renderHtmlString}});}}/**\r\n     * Assignes data-i and data-t attributes to child component if isEditor is enabled\r\n     */_setDataAttributes(){let refNode;if(this._isEditorial()){// If type name only exists on the props then this module is not registered.\nif(this.state.error||!this.state.isRegistered||!this.state.isConfigured){refNode=document.getElementById(this.props.id);}else if(this.componentRef.current){refNode=this.props.root?document.getElementById(LAYOUT_MOUNT_POINT):ReactDOM.findDOMNode(this.componentRef.current);}}if(refNode&&typeof refNode.setAttribute==='function'){refNode.setAttribute('data-i',this._generateDataInfo());}}_setErrorStates(){const mappedProps=mapStateToProps(this.props.store,this.props);// Registration check\nconst isRegistered=!!mappedProps.component;if(isRegistered!==this.state.isRegistered){this.setState(_objectSpread(_objectSpread({},this.state),{},{isRegistered:isRegistered}));return;}// Configuration check\nconst isConfigured=!(mappedProps.configErrors&&mappedProps.configErrors.length>0);if(isConfigured!==this.state.isConfigured){this.setState(_objectSpread(_objectSpread({},this.state),{},{isConfigured:isConfigured}));return;}}};SafeRenderModule=__decorate([observer,__metadata(\"design:paramtypes\",[Object])],SafeRenderModule);export{SafeRenderModule};export const getRenderSlotComponent=(parentProps,moduleConfigs,slotId,addSiblingIndices)=>{if(!moduleConfigs){return[];}const canAddAtIndex=index=>{return addSiblingIndices?addSiblingIndices.indexOf(index+1)>=0:false;};// if addSiblingIndices is not undefined, we add the AddModuleControl components between each module; but in hidden state if index value isnt provider\n// this prevents re-rendering of the module when the AddModuleControl components are enabled/disabled\n// in preview mode, addSiblingIndices will be undefined and we will only render the modules\nreturn moduleConfigs.map((moduleConfig,index)=>{return addSiblingIndices?/*#__PURE__*/React.createElement(AddModuleWrapper,{safeRenderProps:_objectSpread(_objectSpread({key:moduleConfig.id},moduleConfig),{},{parentId:parentProps.id,slotId:slotId,store:parentProps.store,addChunk:parentProps.addChunk}),addModuleProps:{moduleId:parentProps.id,index:index+1,enabled:canAddAtIndex(index),slotId:slotId,mode:AddControlMode.Sibling}}):/*#__PURE__*/React.createElement(SafeRenderModuleWithContext,Object.assign({key:moduleConfig.id},moduleConfig,{parentId:parentProps.id,slotId:slotId,store:parentProps.store,addChunk:parentProps.addChunk}));});};/**\r\n * Maps the application state to the modules props\r\n * @param state The application state\r\n * @param ownProps The props for the specific module\r\n */const mapStateToProps=(store,props)=>{try{const{internalTelemetry}=props;const moduleConfig=getModuleConfig(store,props.id);if(!moduleConfig){internalTelemetry.log(LogLevel.Error,internalTelemetry.stringFormat(EXCEPTION_MISSINGMODULECONFIG,[props.id,props.typeName]));return{};}// TODO - following statements introducing side effect in render method (props should not change in render). Please take a look after public preview\n// Pull value out of stuff that came from cache (doing this gives us reactivity via MobX)\nObject.keys(moduleConfig.data).forEach(key=>{if(moduleConfig.data[key]&&moduleConfig.data[key].Item){moduleConfig.data[key]=moduleConfig.data[key].Item;}});// @ts-ignore\nconst moduleBinder=msdyn365Commerce.moduleBinder(moduleConfig.typeName);if(!moduleBinder){internalTelemetry.log(LogLevel.Error,EXCEPTION_NOMODULEBINDER,{values:[asSystemMetadata(moduleConfig.typeName)]});return{};}const enableAddModuleControls=isAuthoringEditEnabled(store.requestContext);return _objectSpread(_objectSpread(_objectSpread({},props),moduleConfig),{},{component:moduleBinder.component,slots:enableAddModuleControls?getSlotDictionary(props,moduleConfig.slotsForAddModule):getSlotDictionary(props)});}catch(e){props.internalTelemetry.log(LogLevel.Error,props.internalTelemetry.stringFormat(EXCEPTION_MODULERENDERFAIL,[props.id]),{exception:e});return{};}};const getModuleConfig=(store,moduleId)=>{return store.modules(moduleId);};const getSlotDictionary=(props,slotsForAddModule)=>{const slotDictionary={};const{modules}=props;const slotsWithAddModuleControls=(slotsForAddModule||[]).filter(a=>!a.index&&a.slotName);const addSiblingIndexDictionary={};(slotsForAddModule||[]).filter(a=>a.index&&!a.slotName).forEach(a=>{addSiblingIndexDictionary[a.slotId]=a.index||[];});// removes placeholder 'click here to configure' modules\n// tslint:disable-next-line:no-any\nconst getNonPlaceholderModules=mods=>{return mods.filter(a=>a.typeName!=='place-holder-for-container-preview');};if(modules){Object.keys(modules).forEach(key=>{slotDictionary[key]=getRenderSlotComponent(props,getNonPlaceholderModules(modules[key]),key,slotsForAddModule?addSiblingIndexDictionary[key]||[]:undefined);});}slotsWithAddModuleControls.forEach(slot=>{if(!modules||!modules[slot.slotId]||getNonPlaceholderModules(modules[slot.slotId]).length===0){slotDictionary[slot.slotId]=[/*#__PURE__*/ // tslint:disable-next-line:jsx-wrap-multiline\nReact.createElement(AddModuleControl,{key:\"\".concat(props.id,\".\").concat(slot),moduleId:props.id,enabled:true,slotId:slot.slotId,parentId:props.parentId,slotName:slot.slotName,mode:AddControlMode.EmptySlot})];}});return slotDictionary;};const SafeRenderModuleWithContext=WithContext(SafeRenderModule);export default SafeRenderModuleWithContext;","map":{"version":3,"sources":["../../../src/components/safe-render-module.tsx"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n// tslint:disable:no-use-before-declare\nimport {\n    CoreContext,\n    IAddModuleSlot,\n    IAny,\n    IDictionary,\n    IGeneric,\n    IModule,\n    IModuleContract,\n    isAuthoringEditEnabled,\n    msdyn365Commerce,\n    SDK_FRAGMENT_NAME,\n    WithContext\n} from '@msdyn365-commerce/core-internal';\nimport {\n    asSystemMetadata,\n    EXCEPTION_MISSINGMODULECONFIG,\n    EXCEPTION_MODULERENDERFAIL,\n    EXCEPTION_NOMODULEBINDER,\n    EXCEPTION_UNREGISTEREDMODULEID,\n    InternalTelemetry,\n    ITelemetry,\n    LogLevel\n} from '@msdyn365-commerce/telemetry-internal';\nimport { get as _get, union } from 'lodash';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\nimport ReactDOM from 'react-dom';\nimport { ReportChunks } from 'react-universal-component';\nimport { LAYOUT_MOUNT_POINT, MODULE_CONFIG_ERRORS_KEY, MODULE_LAYOUT_FIELD } from '../consts';\nimport { PageContext } from '../store/page-context';\nimport { AddControlMode, AddModuleControl } from './add-module-control';\nimport { AddModuleWrapper } from './add-module-wrapper';\nimport { ErrorModule, renderErrorOrPlaceHolderModules } from './error-module';\nimport { renderView } from './render-view';\n\ntype ErrorInfo = {\n    componentStack: string;\n};\n\nexport type TSafeRenderModuleState = {\n    error?: Error;\n    info?: ErrorInfo;\n    isRegistered?: boolean;\n    isConfigured?: boolean;\n    mounted?: boolean;\n};\n\n/**\n * Known types on the props\n */\nexport type TSafeRenderModuleProps = IGeneric<IAny> & {\n    telemetry: ITelemetry;\n    internalTelemetry: InternalTelemetry;\n};\n\n/**\n * Component to render module\n */\n@observer\nexport class SafeRenderModule extends React.Component<TSafeRenderModuleProps, TSafeRenderModuleState> {\n    // tslint:disable-next-line:no-any\n    private componentRef: React.RefObject<React.Component<{}, any>>;\n    private shouldDisplayErrors: boolean = false;\n    private isRenderAttrributeCalled: boolean = false;\n    private disableDefer?: boolean = false;\n\n    public static getDerivedStateFromError(error: Error): TSafeRenderModuleState {\n        return { error: error };\n    }\n\n    constructor(props: TSafeRenderModuleProps) {\n        super(props);\n\n        this.state = {\n            error: undefined,\n            info: undefined,\n            isConfigured: true,\n            isRegistered: true,\n            mounted: false\n        };\n        this.componentRef = React.createRef();\n        this.shouldDisplayErrors = props && props.context ? props.context.request.params.isDebug : true;\n        // Modules should use defer render strategy if in editor or debug mode\n        this.disableDefer =\n            props.context &&\n            props.app &&\n            props.app.config &&\n            props.app.config.disableServerSideErrorChecking &&\n            !props.context.request.params.isDebug &&\n            !props.context.request.params.isEditor;\n\n        this.props.internalTelemetry.log(\n            LogLevel.Debug,\n            `Safe Render module constructor type-'{typeName}' with id-'{id} and is ${this.disableDefer ? 'not ' : ''}using defer module.'`,\n            {\n                values: [asSystemMetadata(this.props.typeName), asSystemMetadata(this.props.id)]\n            }\n        );\n    }\n\n    public componentDidMount(): void {\n        if (!this.state.mounted) {\n            this.setState({ mounted: true });\n        }\n\n        if (this.isRenderAttrributeCalled) {\n            return;\n        }\n\n        this._setErrorStates();\n        this._setDataAttributes();\n    }\n\n    public shouldComponentUpdate(nextProps: TSafeRenderModuleProps, nextState: TSafeRenderModuleState): boolean {\n        if (this._isEditorial()) {\n            if (nextState.error) {\n                this.props.store.requestCache.put(\n                    { typeName: MODULE_CONFIG_ERRORS_KEY, key: this.props.id },\n                    { item: [{ property: this.props.id, message: nextState.error.message }] }\n                );\n            }\n        }\n        return true;\n    }\n\n    public componentDidUpdate(): void {\n        if (this.isRenderAttrributeCalled) {\n            return;\n        }\n\n        this._setErrorStates();\n        this._setDataAttributes();\n    }\n\n    public componentDidCatch(error: Error, info: ErrorInfo): void {\n        this.setState({ error, info });\n    }\n\n    // tslint:disable-next-line:cyclomatic-complexity\n    public render(): JSX.Element | null {\n        const config = this.props.config;\n        const { internalTelemetry } = this.props;\n        internalTelemetry.log(LogLevel.Debug, `Safe Render module render type-'{typeName}' with id-'{id}'`, {\n            values: [asSystemMetadata(this.props.typeName), asSystemMetadata(this.props.id)]\n        });\n        const mappedProps = mapStateToProps(this.props.store, this.props);\n        const { id, typeName } = mappedProps && mappedProps.id ? mappedProps : this.props;\n        const configErrors = mappedProps.configErrors;\n\n        const Component = mappedProps.component as React.ComponentClass;\n        if (!Component) {\n            const message = internalTelemetry.stringFormat(EXCEPTION_UNREGISTEREDMODULEID, [id, typeName]);\n            internalTelemetry.log(LogLevel.Error, message);\n            return (\n                <ErrorModule\n                    errorType='unregistered'\n                    {...{ ...this.props, ...mappedProps }}\n                    error={new Error(message)}\n                    renderModuleAttributes={this.renderModuleAttributes}\n                    renderView={renderView}\n                />\n            );\n        }\n\n        const err = this.state.error || (configErrors && configErrors.length && new Error(configErrors.map(x => x.message).join(', ')));\n        if (err) {\n            const element = renderErrorOrPlaceHolderModules(\n                err,\n                internalTelemetry,\n                mappedProps,\n                this.state,\n                this.props,\n                this._isEditorial(),\n                this.renderModuleAttributes\n            );\n            if (element) {\n                return element;\n            }\n        }\n\n        if (process.env.CURRENT_ENVIRONMENT === 'node') {\n            if (config && config.hasOwnProperty('clientRender') && config.clientRender && !this._isEditorial()) {\n                return <React.Fragment />;\n            } else {\n                return this._doServerSideRender(mappedProps, Component, internalTelemetry);\n            }\n        } else if (!this.state.mounted && (this.disableDefer || this.props.store.deferred(this.props.id))) {\n            // module needs two passes\n            return null;\n        } else if (config && config.hasOwnProperty('clientRender') && config.clientRender && !this._isEditorial()) {\n            if (this.state.mounted) {\n                return (\n                    <Component\n                        {...mappedProps}\n                        ref={this.componentRef}\n                        {...{ renderModuleAttributes: this.renderModuleAttributes, renderView: renderView }}\n                    />\n                );\n            } else {\n                return <React.Fragment />;\n            }\n        }\n\n        return (\n            <Component\n                {...mappedProps}\n                ref={this.componentRef}\n                {...{ renderModuleAttributes: this.renderModuleAttributes, renderView: renderView }}\n            />\n        );\n    }\n\n    private renderModuleAttributes = (props: IGeneric<IAny>): IDictionary<string> => {\n        this.isRenderAttrributeCalled = true;\n\n        if (!props || !props.id) {\n            return {};\n        }\n\n        // Construct telemetry attributes for module\n        const telemetryId: string = props.friendlyName || props.id;\n        const telemetryAttributes: IDictionary<string> =\n            this.props.internalTelemetry && this.props.internalTelemetry.setTelemetryAttribute\n                ? this.props.internalTelemetry.setTelemetryAttribute(telemetryId)\n                : {};\n\n        const moduleAttributes: IDictionary<string> = { 'data-m-t': props.typeName, ...telemetryAttributes };\n        if (this.shouldDisplayErrors || this._isEditorial()) {\n            moduleAttributes['data-i'] = this._setDataInfoAttribute(props);\n        }\n\n        if (props.platform && typeof props.platform === 'object') {\n            Object.keys(props.platform).forEach(key => {\n                moduleAttributes[`data-m-${key}`] = props.platform[key];\n            });\n        }\n\n        // If a module is associated with an experiment, add this attribtue to track when to activate the experiment\n        if (props.context.request && props.context.request.experiments?.moduleIdToExperimentIdMap) {\n            if (props.context.request.experiments.moduleIdToExperimentIdMap[props.id]) {\n                moduleAttributes[`data-exp`] = `id:${props.context.request.experiments.moduleIdToExperimentIdMap[props.id]}`;\n            }\n        }\n        // In editor scenario, Authoring will update the module layout by sending us updates on\n        // the MODULE_LAYOUT_FIELD in the config object\n        if (this._isEditorial() && props.config && props.config[MODULE_LAYOUT_FIELD]) {\n            moduleAttributes[`data-m-layout`] = props.config[MODULE_LAYOUT_FIELD];\n        }\n\n        return moduleAttributes;\n    };\n\n    /**\n     * Set the data info attribute to be added to the modules\n     * @param props The module props.\n     */\n    private _setDataInfoAttribute(props: IGeneric<IAny>): string {\n        const dataInfo = [`id:${props.id}`];\n        props.slotId && dataInfo.push(`s:${props.slotId}`);\n        props.parentId && dataInfo.push(`p:${props.parentId}`);\n        props.typeName && dataInfo.push(`t:${props.typeName}`);\n        props.friendlyName && dataInfo.push(`fn:${props.friendlyName}`);\n        // @ts-ignore\n        const moduleBinder = msdyn365Commerce.moduleBinder(props.typeName);\n        if (moduleBinder) {\n            moduleBinder.$type && dataInfo.push(`mt:${moduleBinder.$type}`);\n        }\n        props.errorType && dataInfo.push(`e:${props.errorType}`);\n        return `{${dataInfo.join(',')}}`;\n    }\n\n    /**\n     * isEditor\n     * Determines if request is coming from the editor\n     */\n    private _isEditorial(): boolean {\n        return _get(this.props, ['context', 'request', 'params', 'isEditor'], false);\n    }\n\n    /**\n     * Creates data info string to be used by cms e.g '{id:prop-id,s:content,p:parent-id}'\n     */\n    private _generateDataInfo(): string {\n        const dataInfo = [`id:${this.props.id}`];\n        this.props.slotId && dataInfo.push(`s:${this.props.slotId}`);\n        this.props.parentId && dataInfo.push(`p:${this.props.parentId}`);\n        this.props.typeName && dataInfo.push(`t:${this.props.typeName}`);\n        this.props.friendlyName && dataInfo.push(`fn:${this.props.friendlyName}`);\n        // @ts-ignore\n        const moduleBinder = msdyn365Commerce.moduleBinder(this.props.typeName);\n        if (moduleBinder) {\n            moduleBinder.$type && dataInfo.push(`mt:${moduleBinder.$type}`);\n        }\n\n        // Error scenarios\n        // 1. Empty module\n        // 2. Unregistered module\n        // 3. Generic error\n        !this.state.isConfigured && dataInfo.push('e:empty');\n        !this.state.isRegistered && dataInfo.push('e:unregistered');\n        this.state.error && dataInfo.push('e:error');\n\n        return `{${dataInfo.join(',')}}`;\n    }\n\n    /**\n     * Conducts the server side render and returns the result.\n     * If disable defer flag is turned on, the React Element is returned immediately,\n     * otherwise the render result is calculated using renderToString to catch errors\n     * and defer modules (used for editor and debug scenarios)\n     */\n    // tslint:disable-next-line: no-any\n    private _doServerSideRender(\n        // tslint:disable-next-line: no-any\n        mappedProps: any,\n        // tslint:disable-next-line: no-any\n        Component: React.ComponentClass<{}, any>,\n        internalTelemetry: InternalTelemetry\n    ): JSX.Element {\n        let renderHtmlString: string;\n        const renderHtml = (\n            <CoreContext.Provider value={this.props.context}>\n                <ReportChunks report={this.props.addChunk}>\n                    <Component {...mappedProps} {...{ renderModuleAttributes: this.renderModuleAttributes, renderView: renderView }} />\n                </ReportChunks>\n            </CoreContext.Provider>\n        );\n        if (this.disableDefer) {\n            // In non editorial or non debug mode and if app setting to disable server side error checking is turned on\n            // return the JSX directly without computing the render result to save time and compute cost\n            return renderHtml;\n        } else {\n            try {\n                // tslint:disable-next-line:no-require-imports\n                renderHtmlString = require('react-dom/server').renderToString(renderHtml);\n                if (!renderHtmlString.length) {\n                    // module returned null\n                    this.props.store.markModuleAsDeferred(this.props.id);\n                }\n            } catch (e) {\n                internalTelemetry.log(LogLevel.Error, `Safe Render module Failed to render type-'{typeName}' with id-'{id}'`, {\n                    exception: e,\n                    values: [asSystemMetadata(this.props.typeName), asSystemMetadata(this.props.id)]\n                });\n                return (\n                    <ErrorModule\n                        {...mappedProps}\n                        errorType='error'\n                        error={e}\n                        message={e && e.stack}\n                        renderModuleAttributes={this.renderModuleAttributes}\n                        renderView={renderView}\n                    />\n                );\n            }\n            // tslint:disable:react-no-dangerous-html -- intentionally set inner html\n            return React.createElement(SDK_FRAGMENT_NAME, { key: this.props.id, dangerouslySetInnerHTML: { __html: renderHtmlString } });\n        }\n    }\n\n    /**\n     * Assignes data-i and data-t attributes to child component if isEditor is enabled\n     */\n    private _setDataAttributes(): void {\n        let refNode;\n        if (this._isEditorial()) {\n            // If type name only exists on the props then this module is not registered.\n            if (this.state.error || !this.state.isRegistered || !this.state.isConfigured) {\n                refNode = document.getElementById(this.props.id);\n            } else if (this.componentRef.current) {\n                refNode = this.props.root\n                    ? document.getElementById(LAYOUT_MOUNT_POINT)\n                    : (ReactDOM.findDOMNode(this.componentRef.current) as Element);\n            }\n        }\n\n        if (refNode && typeof refNode.setAttribute === 'function') {\n            refNode.setAttribute('data-i', this._generateDataInfo());\n        }\n    }\n\n    private _setErrorStates(): void {\n        const mappedProps = mapStateToProps(this.props.store, this.props);\n\n        // Registration check\n        const isRegistered = !!mappedProps.component;\n        if (isRegistered !== this.state.isRegistered) {\n            this.setState({ ...this.state, isRegistered: isRegistered });\n            return;\n        }\n\n        // Configuration check\n        const isConfigured = !(mappedProps.configErrors && mappedProps.configErrors.length > 0);\n        if (isConfigured !== this.state.isConfigured) {\n            this.setState({ ...this.state, isConfigured: isConfigured });\n            return;\n        }\n    }\n}\n\nexport const getRenderSlotComponent = (\n    parentProps: IGeneric<IAny>,\n    moduleConfigs: IModuleContract[],\n    slotId: string,\n    addSiblingIndices?: number[]\n): React.ReactNode[] => {\n    if (!moduleConfigs) {\n        return [];\n    }\n\n    const canAddAtIndex = (index: number) => {\n        return addSiblingIndices ? addSiblingIndices.indexOf(index + 1) >= 0 : false;\n    };\n    // if addSiblingIndices is not undefined, we add the AddModuleControl components between each module; but in hidden state if index value isnt provider\n    // this prevents re-rendering of the module when the AddModuleControl components are enabled/disabled\n    // in preview mode, addSiblingIndices will be undefined and we will only render the modules\n    return moduleConfigs.map((moduleConfig: IModuleContract, index: number) => {\n        return addSiblingIndices ? (\n            <AddModuleWrapper\n                safeRenderProps={{\n                    key: moduleConfig.id,\n                    ...moduleConfig,\n                    parentId: parentProps.id,\n                    slotId: slotId,\n                    store: parentProps.store,\n                    addChunk: parentProps.addChunk\n                }}\n                addModuleProps={{\n                    moduleId: parentProps.id,\n                    index: index + 1,\n                    enabled: canAddAtIndex(index),\n                    slotId: slotId,\n                    mode: AddControlMode.Sibling\n                }}\n            />\n        ) : (\n            <SafeRenderModuleWithContext\n                key={moduleConfig.id}\n                {...moduleConfig}\n                parentId={parentProps.id}\n                slotId={slotId}\n                store={parentProps.store}\n                addChunk={parentProps.addChunk}\n            />\n        );\n    });\n};\n\n/**\n * Maps the application state to the modules props\n * @param state The application state\n * @param ownProps The props for the specific module\n */\nconst mapStateToProps = (store: PageContext, props: TSafeRenderModuleProps): IModule<IGeneric<IAny>> => {\n    try {\n        const { internalTelemetry } = props;\n        const moduleConfig = getModuleConfig(store, props.id);\n        if (!moduleConfig) {\n            internalTelemetry.log(\n                LogLevel.Error,\n                internalTelemetry.stringFormat(EXCEPTION_MISSINGMODULECONFIG, [props.id, props.typeName])\n            );\n            return {} as IModule<IGeneric<IAny>>;\n        }\n\n        // TODO - following statements introducing side effect in render method (props should not change in render). Please take a look after public preview\n        // Pull value out of stuff that came from cache (doing this gives us reactivity via MobX)\n        Object.keys(moduleConfig.data).forEach(key => {\n            if (moduleConfig.data[key] && moduleConfig.data[key].Item) {\n                moduleConfig.data[key] = moduleConfig.data[key].Item;\n            }\n        });\n\n        // @ts-ignore\n        const moduleBinder = msdyn365Commerce.moduleBinder(moduleConfig.typeName);\n        if (!moduleBinder) {\n            internalTelemetry.log(LogLevel.Error, EXCEPTION_NOMODULEBINDER, { values: [asSystemMetadata(moduleConfig.typeName)] });\n            return {} as IModule<IGeneric<IAny>>;\n        }\n        const enableAddModuleControls = isAuthoringEditEnabled(store.requestContext);\n        return {\n            ...props,\n            ...moduleConfig,\n            component: moduleBinder.component,\n            slots: enableAddModuleControls ? getSlotDictionary(props, moduleConfig.slotsForAddModule) : getSlotDictionary(props)\n        };\n    } catch (e) {\n        props.internalTelemetry.log(LogLevel.Error, props.internalTelemetry.stringFormat(EXCEPTION_MODULERENDERFAIL, [props.id]), {\n            exception: e\n        });\n        return {} as IModule<IGeneric<IAny>>;\n    }\n};\n\nconst getModuleConfig = (store: PageContext, moduleId: string): IModule => {\n    return store.modules(moduleId);\n};\n\nconst getSlotDictionary = (props: IGeneric<IAny>, slotsForAddModule?: IAddModuleSlot[]): IDictionary<React.ReactNode[]> => {\n    const slotDictionary: IDictionary<React.ReactNode[]> = {};\n    const { modules } = props;\n    const slotsWithAddModuleControls = (slotsForAddModule || []).filter(a => !a.index && a.slotName);\n    const addSiblingIndexDictionary: { [key: string]: number[] } = {};\n    (slotsForAddModule || [])\n        .filter(a => a.index && !a.slotName)\n        .forEach(a => {\n            addSiblingIndexDictionary[a.slotId] = a.index || [];\n        });\n    // removes placeholder 'click here to configure' modules\n    // tslint:disable-next-line:no-any\n    const getNonPlaceholderModules = (mods: any[]) => {\n        return mods.filter(a => a.typeName !== 'place-holder-for-container-preview');\n    };\n    if (modules) {\n        Object.keys(modules).forEach((key: string) => {\n            slotDictionary[key] = getRenderSlotComponent(\n                props,\n                getNonPlaceholderModules(modules[key]),\n                key,\n                slotsForAddModule ? addSiblingIndexDictionary[key] || [] : undefined\n            );\n        });\n    }\n    slotsWithAddModuleControls.forEach((slot: IAddModuleSlot) => {\n        if (!modules || !modules[slot.slotId] || getNonPlaceholderModules(modules[slot.slotId]).length === 0) {\n            slotDictionary[slot.slotId] = [\n                // tslint:disable-next-line:jsx-wrap-multiline\n                <AddModuleControl\n                    key={`${props.id}.${slot}`}\n                    moduleId={props.id}\n                    enabled={true}\n                    slotId={slot.slotId}\n                    parentId={props.parentId}\n                    slotName={slot.slotName}\n                    mode={AddControlMode.EmptySlot}\n                />\n            ];\n        }\n    });\n    return slotDictionary;\n};\n\nconst SafeRenderModuleWithContext = WithContext(SafeRenderModule);\nexport default SafeRenderModuleWithContext;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}