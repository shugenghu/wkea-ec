{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";/*!\r\n * Copyright (c) Microsoft Corporation.\r\n * All rights reserved. See LICENSE in the project root for license information.\r\n */import{createDataActionHook,TelemetryEvent}from'@msdyn365-commerce/core';import{getProductInfoFromCart}from'./telemetry.action.helper';var beforeUpdateCart=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(inputs,actionContext){var actionInput,updateCartLinesParams;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;actionInput=Array.isArray(inputs)?inputs[0]:inputs;if(!(actionInput.queryParams&&typeof actionInput.queryParams==='function')){_context.next=7;break;}updateCartLinesParams=actionInput.queryParams();if(!(updateCartLinesParams&&updateCartLinesParams.cartLines)){_context.next=7;break;}actionContext.requestContext.telemetryData[\"updatedCartLines\"]=updateCartLinesParams.cartLines;return _context.abrupt(\"return\");case 7:actionContext.telemetry.debug('UpdateCart pre-data action hook failed - No updated cart lines found');_context.next=13;break;case 10:_context.prev=10;_context.t0=_context[\"catch\"](0);actionContext.telemetry.debug('UpdateCart pre-data action hook failed.',_context.t0);case 13:case\"end\":return _context.stop();}}},_callee,null,[[0,10]]);}));return function beforeUpdateCart(_x,_x2){return _ref.apply(this,arguments);};}();var afterUpdateCart=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_inputs,cart,actionContext){var updatedProducts,updatedCartLines;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(window&&window._msdyn365&&window._msdyn365.telemetry){updatedProducts={};updatedCartLines=actionContext.requestContext.telemetryData[\"updatedCartLines\"];if(updatedCartLines){updatedCartLines.forEach(function(cartLine){if(cartLine&&cartLine.ProductId){var updatedProduct=actionContext.requestContext.telemetryData[cartLine.ProductId];if(updatedProduct){updatedProducts[cartLine.ProductId]=updatedProduct;}}});}window._msdyn365.telemetry.logEvent(TelemetryEvent.UpdateInCart,getProductInfoFromCart(cart,updatedProducts,actionContext.requestContext));}case 1:case\"end\":return _context2.stop();}}},_callee2);}));return function afterUpdateCart(_x3,_x4,_x5){return _ref2.apply(this,arguments);};}();createDataActionHook({actionId:'@msdyn365-commerce/retail-proxy/Carts/UpdateCartLines',postReaderHook:afterUpdateCart,preReaderHook:beforeUpdateCart});","map":{"version":3,"sources":["actions/updateCart-telemetry.action.ts"],"names":[],"mappings":"uIAAA;;;AAGG,GAEH,OAAS,oBAAT,CAA6D,cAA7D,KAAmF,yBAAnF,CAGA,OAAS,sBAAT,KAAuC,2BAAvC,CASA,GAAM,CAAA,gBAAgB,0FAAG,iBAAO,MAAP,CAA8C,aAA9C,wKAEX,WAFW,CAEG,KAAK,CAAC,OAAN,CAAc,MAAd,EAA6C,MAAM,CAAC,CAAD,CAAnD,CAA8E,MAFjF,MAKb,WAAW,CAAC,WAAZ,EAA2B,MAAO,CAAA,WAAW,CAAC,WAAnB,GAAmC,UALjD,0BAMP,qBANO,CAMiB,WAAW,CAAC,WAAZ,EANjB,MAOT,qBAAqB,EAAI,qBAAqB,CAAC,SAPtC,0BAST,aAAa,CAAC,cAAd,CAA6B,aAA7B,qBAAiE,qBAAqB,CAAC,SAAvF,CATS,wCAajB,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,sEAA9B,EAbiB,iFAejB,aAAa,CAAC,SAAd,CAAwB,KAAxB,CAA8B,yCAA9B,cAfiB,qEAAH,kBAAhB,CAAA,gBAAgB,gDAAtB,CAyBA,GAAM,CAAA,eAAe,2FAAG,kBAAO,OAAP,CAA+C,IAA/C,CAAoE,aAApE,2JACpB,GAAI,MAAM,EAAI,MAAM,CAAC,SAAjB,EAA8B,MAAM,CAAC,SAAP,CAAiB,SAAnD,CAA8D,CACpD,eADoD,CACf,EADe,CAEpD,gBAFoD,CAErB,aAAa,CAAC,cAAd,CAA6B,aAA7B,oBAFqB,CAK1D,GAAI,gBAAJ,CAAsB,CAClB,gBAAgB,CAAC,OAAjB,CAAyB,SAAC,QAAD,CAAuB,CAC5C,GAAI,QAAQ,EAAI,QAAQ,CAAC,SAAzB,CAAoC,CAChC,GAAM,CAAA,cAAc,CAAG,aAAa,CAAC,cAAd,CAA6B,aAA7B,CAA2C,QAAQ,CAAC,SAApD,CAAvB,CACA,GAAI,cAAJ,CAAoB,CAChB,eAAe,CAAC,QAAQ,CAAC,SAAV,CAAf,CAAsC,cAAtC,CACH,CACJ,CACJ,CAPD,EAQH,CAGD,MAAM,CAAC,SAAP,CAAiB,SAAjB,CAA2B,QAA3B,CACI,cAAc,CAAC,YADnB,CAEI,sBAAsB,CAAC,IAAD,CAAO,eAAP,CAAwB,aAAa,CAAC,cAAtC,CAF1B,EAIH,CAtBmB,wDAAH,kBAAf,CAAA,eAAe,sDAArB,CAyBA,oBAAoB,CAAC,CACjB,QAAQ,CAAE,uDADO,CAEjB,cAAc,CAAE,eAFC,CAGjB,aAAa,CAAE,gBAHE,CAAD,CAApB","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation.\n * All rights reserved. See LICENSE in the project root for license information.\n */\n\nimport { createDataActionHook, IActionContext, IActionInput, TelemetryEvent } from '@msdyn365-commerce/core';\nimport { IAny, IDictionary, IMSDyn365Window } from '@msdyn365-commerce/core-internal';\nimport { Cart, CartLine, IDataServiceRequest, IUpdateCartLinesParam } from '@msdyn365-commerce/retail-proxy';\nimport { getProductInfoFromCart } from './telemetry.action.helper';\n\ndeclare var window: IMSDyn365Window;\n\n/**\n * Saves info on cart lines updated before calling data action\n * @param inputs Data action inputs\n * @param actionContext Action context\n */\nconst beforeUpdateCart = async (inputs: IActionInput | IActionInput[], actionContext: IActionContext) => {\n    try {\n        const actionInput = Array.isArray(inputs) ? <IDataServiceRequest>inputs[0] : <IDataServiceRequest>inputs;\n\n        // If cart lines were updated\n        if (actionInput.queryParams && typeof actionInput.queryParams === 'function') {\n            const updateCartLinesParams = actionInput.queryParams<IUpdateCartLinesParam>();\n            if (updateCartLinesParams && updateCartLinesParams.cartLines) {\n                // Save info on updated cart lines for post data action hook to pick up\n                actionContext.requestContext.telemetryData[`updatedCartLines`] = updateCartLinesParams.cartLines;\n                return;\n            }\n        }\n        actionContext.telemetry.debug('UpdateCart pre-data action hook failed - No updated cart lines found');\n    } catch (e) {\n        actionContext.telemetry.debug('UpdateCart pre-data action hook failed.', e);\n    }\n};\n\n/**\n * Fires an UpdateInCart event after data action completed\n * @param _inputs Data action inputs\n * @param cart New cart object after cart lines have been added\n * @param actionContext Action context\n */\nconst afterUpdateCart = async (_inputs: IActionInput | IActionInput[], cart: Cart | Cart[], actionContext: IActionContext) => {\n    if (window && window._msdyn365 && window._msdyn365.telemetry) {\n        const updatedProducts: IDictionary<IAny> = {};\n        const updatedCartLines = <CartLine[]>actionContext.requestContext.telemetryData[`updatedCartLines`];\n\n        // If TelemetryData exists for updated cart lines, collect product info\n        if (updatedCartLines) {\n            updatedCartLines.forEach((cartLine: CartLine) => {\n                if (cartLine && cartLine.ProductId) {\n                    const updatedProduct = actionContext.requestContext.telemetryData[cartLine.ProductId];\n                    if (updatedProduct) {\n                        updatedProducts[cartLine.ProductId] = updatedProduct;\n                    }\n                }\n            });\n        }\n\n        // Fire UpdateInCart event\n        window._msdyn365.telemetry.logEvent(\n            TelemetryEvent.UpdateInCart,\n            getProductInfoFromCart(cart, updatedProducts, actionContext.requestContext)\n        );\n    }\n};\n\ncreateDataActionHook({\n    actionId: '@msdyn365-commerce/retail-proxy/Carts/UpdateCartLines',\n    postReaderHook: afterUpdateCart,\n    preReaderHook: beforeUpdateCart\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}