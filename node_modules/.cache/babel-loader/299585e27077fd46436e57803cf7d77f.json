{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import\"core-js/modules/es.regexp.constructor.js\";import\"core-js/modules/es.regexp.to-string.js\";import\"core-js/modules/es.string.replace.js\";import\"core-js/modules/web.dom-collections.iterator.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{__decorate}from\"tslib\";import{withModuleState}from'@msdyn365-commerce-modules/checkout-utilities';import classnames from'classnames';import{computed,when}from'mobx';import{observer}from'mobx-react';import*as React from'react';import getAddContactInfo from'./components/get-add-contact-info';import getShowContactInfo from'./components/get-show-contact-info';export*from'./components/get-add-contact-info';export*from'./components/get-show-contact-info';let CheckoutGuestProfile=class CheckoutGuestProfile extends React.Component{constructor(){super(...arguments);this.state={email:this.props.context&&this.props.context.request&&this.props.context.request.user&&this.props.context.request.user.isAuthenticated&&this.props.context.request.user.emailAddress||''};this.inputRef=/*#__PURE__*/React.createRef();this.init=async()=>{var _this$props$data$chec;const emailOnCart=(_this$props$data$chec=this.props.data.checkout.result)===null||_this$props$data$chec===void 0?void 0:_this$props$data$chec.checkoutCart.cart.ReceiptEmail;const email=emailOnCart||this.state.email;if(email){await this.updateGuestProfile(email);}const isEmailValid=this.isEmailValid(email);this.props.moduleState.init({onEdit:this.onEdit,onCancel:this.onCancel,onSubmit:this.onSubmit,status:email&&isEmailValid?'ready':'updating',hasError:!!email&&!isEmailValid});};this.onChange=rowEmail=>{const email=(rowEmail||'').replace(new RegExp('[<>]','gi'),'');this.setState({email});if(this.props.moduleState.hasError){this.props.moduleState.setHasError(false);}};this.isEmailValid=email=>{const regex=/^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;return regex.test(email);};this.updateGuestProfile=async newGuestCheckoutEmail=>{if(this.props.data.checkout.result){await this.props.data.checkout.result.updateGuestCheckoutEmail({newGuestCheckoutEmail});this.setState({email:newGuestCheckoutEmail});}};this.onEdit=()=>{this.props.moduleState.onUpdating();};this.onSubmit=async()=>{const{email}=this.state;const isValid=this.isEmailValid(email);if(!isValid){this.props.moduleState.setHasError(true);const input=this.inputRef&&this.inputRef.current&&this.inputRef.current.focus&&this.inputRef.current;input&&input.focus();}else{this.props.moduleState.onReady();await this.updateGuestProfile(email);}};this.onCancel=()=>{if(!this.props.data.checkout.result){return;}const email=this.props.data.checkout.result.guestCheckoutEmail;if(!email){this.props.moduleState.onUpdating();return;}else{this.setState({email});this.props.moduleState.setHasError(false);this.props.moduleState.onReady();}};}get isDataReady(){return(this.props.data.checkout.result&&this.props.data.checkout.status)==='SUCCESS';}componentDidMount(){when(()=>this.isDataReady,async()=>{await this.init();});}render(){const{config:{className},resources,moduleState:{isReady,hasError,hasExternalSubmitGroup}}=this.props;const email=this.props.data.checkout.result&&this.props.data.checkout.result.guestCheckoutEmail||'';const viewProps=_objectSpread(_objectSpread(_objectSpread({},this.props),this.state),{},{onChange:this.onChange,onEdit:this.onEdit,onCancel:this.onCancel,onSubmit:this.onSubmit,moduleProps:{moduleProps:this.props,className:classnames('ms-checkout-guest-profile',className,isReady?'show':'add')},showContactInfo:isReady?getShowContactInfo({canEdit:!hasExternalSubmitGroup,email,resources,onEdit:this.onEdit}):undefined,addContactInfo:!isReady?getAddContactInfo({email:this.state.email,hasError,resources,inputRef:this.inputRef,onChange:this.onChange,canSubmit:!hasExternalSubmitGroup,onSubmit:this.onSubmit,canCancel:!hasExternalSubmitGroup&&!!email,onCancel:this.onCancel}):undefined});return this.props.renderView(viewProps);}};__decorate([computed],CheckoutGuestProfile.prototype,\"isDataReady\",null);CheckoutGuestProfile=__decorate([withModuleState,observer],CheckoutGuestProfile);export default CheckoutGuestProfile;","map":{"version":3,"sources":["modules/checkout-guest-profile/checkout-guest-profile.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { IModuleStateProps, withModuleState } from '@msdyn365-commerce-modules/checkout-utilities';\nimport { IModuleProps } from '@msdyn365-commerce-modules/utilities';\nimport classnames from 'classnames';\nimport { computed, when } from 'mobx';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\nimport { ICheckoutGuestProfileData } from './checkout-guest-profile.data';\nimport { ICheckoutGuestProfileProps } from './checkout-guest-profile.props.autogenerated';\nimport getAddContactInfo, { IAddContactInfo } from './components/get-add-contact-info';\nimport getShowContactInfo, { IShowContactInfo } from './components/get-show-contact-info';\n\nexport * from './components/get-add-contact-info';\nexport * from './components/get-show-contact-info';\n\ninterface ICheckoutGuestProfileState {\n    email: string;\n}\n\nexport interface ICheckoutGuestProfileModuleProps extends ICheckoutGuestProfileProps<ICheckoutGuestProfileData>, IModuleStateProps { }\n\nexport interface ICheckoutGuestProfileViewProps extends ICheckoutGuestProfileProps<ICheckoutGuestProfileData>, ICheckoutGuestProfileState {\n    moduleProps: IModuleProps;\n    showContactInfo?: IShowContactInfo;\n    addContactInfo?: IAddContactInfo;\n\n    onChange?(email: string): void;\n    onEdit?(): void;\n    onSubmit?(): void;\n    onCancel?(): void;\n}\n\n/**\n *\n * CheckoutGuestProfile component\n * @extends {React.PureComponent<ICheckoutGuestProfileProps<ICheckoutGuestProfileData>, ICheckoutGuestProfileState>}\n */\n// @ts-ignore\n@withModuleState\n@observer\nclass CheckoutGuestProfile extends React.Component<ICheckoutGuestProfileModuleProps, ICheckoutGuestProfileState> {\n    public state: ICheckoutGuestProfileState = {\n        email:\n            (this.props.context &&\n                this.props.context.request &&\n                this.props.context.request.user &&\n                this.props.context.request.user.isAuthenticated &&\n                this.props.context.request.user.emailAddress) ||\n            ''\n    };\n\n    private inputRef: React.RefObject<HTMLInputElement> = React.createRef();\n\n    @computed get isDataReady(): boolean {\n        return (this.props.data.checkout.result && this.props.data.checkout.status) === 'SUCCESS';\n    }\n\n    public componentDidMount(): void {\n        // @ts-ignore: Compiler not reconizing condition check for function params\n        when(\n            () => this.isDataReady,\n            async () => {\n                await this.init();\n            }\n        );\n    }\n\n    public render(): JSX.Element {\n        const {\n            config: { className },\n            resources,\n            moduleState: { isReady, hasError, hasExternalSubmitGroup }\n        } = this.props;\n        const email = (this.props.data.checkout.result && this.props.data.checkout.result.guestCheckoutEmail) || '';\n\n        const viewProps: ICheckoutGuestProfileViewProps = {\n            ...this.props,\n            ...this.state,\n            onChange: this.onChange,\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n\n            moduleProps: {\n                moduleProps: this.props,\n                className: classnames('ms-checkout-guest-profile', className, isReady ? 'show' : 'add')\n            },\n            showContactInfo: isReady\n                ? getShowContactInfo({\n                    canEdit: !hasExternalSubmitGroup,\n                    email,\n                    resources,\n                    onEdit: this.onEdit\n                })\n                : undefined,\n            addContactInfo: !isReady\n                ? getAddContactInfo({\n                    email: this.state.email,\n                    hasError,\n                    resources,\n                    inputRef: this.inputRef,\n                    onChange: this.onChange,\n                    canSubmit: !hasExternalSubmitGroup,\n                    onSubmit: this.onSubmit,\n                    canCancel: !hasExternalSubmitGroup && !!email,\n                    onCancel: this.onCancel\n                })\n                : undefined\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    private init = async (): Promise<void> => {\n        const emailOnCart = this.props.data.checkout.result?.checkoutCart.cart.ReceiptEmail;\n        const email = emailOnCart || this.state.email;\n\n        if (email) {\n            await this.updateGuestProfile(email);\n        }\n\n        const isEmailValid = this.isEmailValid(email);\n        this.props.moduleState.init({\n            onEdit: this.onEdit,\n            onCancel: this.onCancel,\n            onSubmit: this.onSubmit,\n            status: email && isEmailValid ? 'ready' : 'updating',\n            hasError: !!email && !isEmailValid\n        });\n    };\n\n    private onChange = (rowEmail: string): void => {\n        const email = (rowEmail || '').replace(new RegExp('[<>]', 'gi'), '');\n        this.setState({ email });\n        if (this.props.moduleState.hasError) {\n            // Clear error during user updating the email\n            this.props.moduleState.setHasError(false);\n        }\n    };\n\n    private isEmailValid = (email: string): boolean => {\n        const regex = /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n        return regex.test(email);\n    };\n\n    private updateGuestProfile = async (newGuestCheckoutEmail: string): Promise<void> => {\n        if (this.props.data.checkout.result) {\n            await this.props.data.checkout.result.updateGuestCheckoutEmail({ newGuestCheckoutEmail });\n            this.setState({ email: newGuestCheckoutEmail });\n        }\n    };\n\n    private onEdit = (): void => {\n        this.props.moduleState.onUpdating();\n    };\n\n    private onSubmit = async (): Promise<void> => {\n        const { email } = this.state;\n        const isValid = this.isEmailValid(email);\n        if (!isValid) {\n            this.props.moduleState.setHasError(true);\n            // Get error, focus back on the input field\n            const input = this.inputRef && this.inputRef.current && this.inputRef.current.focus && (this.inputRef.current as HTMLElement);\n            input && input.focus();\n        } else {\n            this.props.moduleState.onReady();\n            await this.updateGuestProfile(email);\n        }\n    };\n\n    private onCancel = (): void => {\n        // Reset to the saved value\n        if (!this.props.data.checkout.result) {\n            return;\n        }\n\n        const email = this.props.data.checkout.result.guestCheckoutEmail;\n        if (!email) {\n            // It has no saved email, set to status updating and request user to fill the email form\n            this.props.moduleState.onUpdating();\n            return;\n        } else {\n            // It has saved email, set to status ready\n            this.setState({\n                email\n            });\n            this.props.moduleState.setHasError(false);\n            this.props.moduleState.onReady();\n        }\n    };\n}\n\nexport default CheckoutGuestProfile;"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}