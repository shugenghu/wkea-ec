{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{generateProductImageUrl}from'@msdyn365-commerce-modules/retail-actions';import MsDyn365,{createObservableDataAction}from'@msdyn365-commerce/core';import{searchByCriteriaAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import{BaseCollectionInput,createBaseCollectionInput}from'./base-collection-action';import{ListPageStateInput}from'../list-page-state';export var GetFullProductsByCollectionInput=/*#__PURE__*/function(_BaseCollectionInput){_inherits(GetFullProductsByCollectionInput,_BaseCollectionInput);var _super=_createSuper(GetFullProductsByCollectionInput);function GetFullProductsByCollectionInput(){var _this;_classCallCheck(this,GetFullProductsByCollectionInput);_this=_super.apply(this,arguments);_this.getCacheObjectType=function(){return'FullProductSearchResult';};_this.dataCacheType=function(){if(_this.pageType!=='Category'||_this.refiners&&_this.refiners.length>0||_this.queryResultSettings&&_this.queryResultSettings.Sorting&&_this.queryResultSettings.Sorting.Columns&&_this.queryResultSettings.Sorting.Columns.length>0){return'request';}else{return'application';}};return _this;}return GetFullProductsByCollectionInput;}(BaseCollectionInput);var createInput=function createInput(args){var input=createBaseCollectionInput(args,GetFullProductsByCollectionInput);if(input.queryResultSettings.Paging&&args.config){input.queryResultSettings.Paging.Top=args.config.itemsPerPage||1;}if(input.queryResultSettings.Paging&&args.requestContext.query&&args.requestContext.query.skip){input.queryResultSettings.Paging.Skip=+args.requestContext.query.skip;}input.queryResultSettings.count=true;return input;};function action(_x,_x2){return _action.apply(this,arguments);}function _action(){_action=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var productSearchResults,promise,searchProductId,searchCriteriaInput,mappedProducts;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:searchCriteriaInput={};searchCriteriaInput.Context={ChannelId:ctx.requestContext.apiSettings.channelId,CatalogId:ctx.requestContext.apiSettings.catalogId};searchCriteriaInput.Refinement=input.refiners;searchCriteriaInput.IncludeAttributes=input.includeAttributes;if(!(input.pageType==='Category'||ctx.requestContext.query&&ctx.requestContext.query.categoryId)){_context.next=13;break;}if(!input.category){_context.next=10;break;}searchCriteriaInput.CategoryIds=[input.category||0];promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);_context.next=11;break;case 10:throw new Error('[GetFullProductsForCollection]Category Page Detected, but no global categoryId found');case 11:_context.next=30;break;case 13:if(!(input.searchText&&ctx.requestContext.query&&ctx.requestContext.query.q)){_context.next=18;break;}searchCriteriaInput.SearchCondition=input.searchText;promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);_context.next=30;break;case 18:if(!(input.searchText&&ctx.requestContext.query&&ctx.requestContext.query.productId)){_context.next=29;break;}searchProductId=Number(input.searchText);if(!Number.isNaN(searchProductId)){_context.next=24;break;}throw new Error('Failed to cast search product id into a number.');case 24:searchCriteriaInput.RecommendationListId='looks';searchCriteriaInput.Ids=[searchProductId||0];promise=searchByCriteriaAsync({callerContext:ctx,queryResultSettings:input.queryResultSettings},searchCriteriaInput);case 27:_context.next=30;break;case 29:throw new Error('[GetFullProductsForCollection]Search Page Detected, but no q= or productId= query parameter found');case 30:_context.next=32;return promise;case 32:productSearchResults=_context.sent;mappedProducts=productSearchResults.map(function(productSearchResult){var newImageUrl=generateProductImageUrl(productSearchResult,ctx.requestContext.apiSettings);if(newImageUrl){productSearchResult.PrimaryImageUrl=newImageUrl;}return productSearchResult;});if(!MsDyn365.isBrowser){ctx.update(new ListPageStateInput(),{totalProductCount:promise.metadata.count||0,activeFilters:input.refiners});}return _context.abrupt(\"return\",{products:mappedProducts,count:promise.metadata.count||0});case 36:case\"end\":return _context.stop();}}},_callee);}));return _action.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce-modules/search-result-container/get-full-products-by-collection',action:action,input:createInput});","map":{"version":3,"sources":["modules/search-result-container/actions/get-full-products-by-collection.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { generateProductImageUrl } from '@msdyn365-commerce-modules/retail-actions';\nimport MsDyn365, {\n    createObservableDataAction,\n    IAction,\n    IActionContext,\n    IActionInput,\n    ICreateActionContext\n} from '@msdyn365-commerce/core';\nimport { AsyncResult, ProductSearchCriteria,ProductSearchResult } from '@msdyn365-commerce/retail-proxy';\nimport { searchByCriteriaAsync} from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport {\n    BaseCollectionInput,\n    createBaseCollectionInput\n} from './base-collection-action';\n\nimport { ListPageStateInput } from '../list-page-state';\n\n/**\n * GetFullProductsByCollection Action Input\n */\nexport class GetFullProductsByCollectionInput extends BaseCollectionInput implements IActionInput {\n    public getCacheObjectType = () => 'FullProductSearchResult';\n    public dataCacheType = () => {\n        if (\n            this.pageType !== 'Category' ||\n            (this.refiners && this.refiners.length > 0) ||\n            (this.queryResultSettings && this.queryResultSettings.Sorting && this.queryResultSettings.Sorting.Columns && this.queryResultSettings.Sorting.Columns.length > 0)\n        ) {\n            return 'request';\n        } else {\n            return 'application';\n        }\n    }\n}\n\nexport interface IFullProductsSearchResultsWithCount {\n    products: ProductSearchResult[];\n    count: number;\n}\n\n/**\n * createInput function which creates and actionInput used to fetch products for a list page.\n */\nconst createInput = (args: ICreateActionContext<{ itemsPerPage: number ;includedAttributes:boolean | undefined}>): IActionInput => {\n    const input = createBaseCollectionInput(args, GetFullProductsByCollectionInput);\n\n    // Set Top\n    if (input.queryResultSettings.Paging && args.config) {\n        input.queryResultSettings.Paging.Top = args.config.itemsPerPage || 1;\n    }\n\n    // Set Skip\n    if (input.queryResultSettings.Paging && args.requestContext.query && args.requestContext.query.skip) {\n        input.queryResultSettings.Paging.Skip = +args.requestContext.query.skip;\n    }\n\n    input.queryResultSettings.count = true;\n\n    return input;\n};\n\n/**\n * Action function to fetch products for a list page\n */\nasync function action(\n    input: GetFullProductsByCollectionInput,\n    ctx: IActionContext\n): Promise<IFullProductsSearchResultsWithCount> {\n    let productSearchResults: ProductSearchResult[];\n    let promise: AsyncResult<ProductSearchResult[]>;\n    let searchProductId;\n    const searchCriteriaInput: ProductSearchCriteria = {};\n    searchCriteriaInput.Context = { ChannelId: ctx.requestContext.apiSettings.channelId, CatalogId: ctx.requestContext.apiSettings.catalogId };\n    searchCriteriaInput.Refinement = input.refiners;\n    searchCriteriaInput.IncludeAttributes = input.includeAttributes;\n\n    if (input.pageType === 'Category' || (ctx.requestContext.query && ctx.requestContext.query.categoryId)) {\n        if (input.category) {\n            searchCriteriaInput.CategoryIds = [input.category || 0];\n            promise = searchByCriteriaAsync(\n                {\n                    callerContext: ctx,\n                    queryResultSettings: input.queryResultSettings\n                },\n                searchCriteriaInput\n            );\n        } else {\n            throw new Error(\n                '[GetFullProductsForCollection]Category Page Detected, but no global categoryId found'\n            );\n        }\n    } else {\n        if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.q)) {\n            searchCriteriaInput.SearchCondition = input.searchText;\n            promise = searchByCriteriaAsync(\n                {\n                    callerContext: ctx,\n                    queryResultSettings: input.queryResultSettings\n                },\n                searchCriteriaInput\n            );\n        } else {\n            if (input.searchText && (ctx.requestContext.query && ctx.requestContext.query.productId)) {\n                searchProductId = Number(input.searchText);\n                if (Number.isNaN(searchProductId)) {\n                    throw new Error('Failed to cast search product id into a number.');\n                } else {\n                    searchCriteriaInput.RecommendationListId = 'looks';\n                    searchCriteriaInput.Ids = [searchProductId || 0];\n                    promise = searchByCriteriaAsync(\n                        {\n                            callerContext: ctx,\n                            queryResultSettings: input.queryResultSettings\n                        },\n                        searchCriteriaInput\n                    );\n                }\n            } else {\n                throw new Error(\n                    '[GetFullProductsForCollection]Search Page Detected, but no q= or productId= query parameter found'\n                );\n            }\n        }\n    }\n\n    productSearchResults = await promise;\n\n    const mappedProducts = productSearchResults.map(productSearchResult => {\n        const newImageUrl = generateProductImageUrl(\n            productSearchResult,\n            ctx.requestContext.apiSettings\n        );\n\n        if (newImageUrl) {\n            productSearchResult.PrimaryImageUrl = newImageUrl;\n        }\n\n        return (productSearchResult);\n    });\n\n    // Update ListPageState For SSR\n    if (!MsDyn365.isBrowser) {\n        ctx.update(new ListPageStateInput(), { totalProductCount: promise.metadata.count || 0, activeFilters: input.refiners });\n\n    }\n\n    return {\n        products: mappedProducts,\n        count: promise.metadata.count || 0\n    };\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/search-result-container/get-full-products-by-collection',\n    action: <IAction<IFullProductsSearchResultsWithCount>>action,\n    input: createInput\n});\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}