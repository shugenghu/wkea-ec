{"ast":null,"code":"import\"core-js/modules/es.promise.js\";import{createObservableDataAction}from'@msdyn365-commerce/core';import getCurrentCategory,{CurrentCategoryInput}from'./get-current-category';import getProducts,{ProductInput}from'./get-simple-products';import{searchByCategoryAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';import{QueryResultSettingsProxy}from'./utilities/QueryResultSettingsProxy';import{buildCacheKey}from'./utilities/utils';/**\r\n * Product by category ID Input action\r\n */export class ProductsByCategoryInput{constructor(category,apiSettings,queryResultSettingsProxy){this.getCacheKey=()=>buildCacheKey(\"\".concat(this.categoryId||this.categorySlug,\"|\").concat(this.catalogId,\"|\").concat(this.queryResultSettingsProxy.cacheKeyHint),this.apiSettings);this.getCacheObjectType=()=>'Products-From-Search';this.dataCacheType=()=>'application';this.apiSettings=apiSettings;this.currentCategory=category;this.queryResultSettingsProxy=queryResultSettingsProxy;this.catalogId=apiSettings.catalogId;this.categoryId=category.categoryId;this.categorySlug=category.categorySlug;}}/**\r\n * createInput method for the getProductsByCategory data aciton\r\n */export const createGetProductsByCategoryInput=inputData=>{if(inputData&&inputData.requestContext){const currentCategory=new CurrentCategoryInput(inputData.requestContext);const queryResultSettingsProxy=QueryResultSettingsProxy.fromInputData(inputData);return new ProductsByCategoryInput(currentCategory,inputData.requestContext.apiSettings,queryResultSettingsProxy);}throw new Error('Please specify categoryId query string in request.');};/**\r\n * Action method for the getProductsByCategory data action\r\n */export async function getProductsByCategoryAction(input,ctx){const{apiSettings}=ctx.requestContext;let categoryId=input.currentCategory.categoryId;if(input.currentCategory.categorySlug&&!categoryId){const category=await getCurrentCategory(input.currentCategory,ctx);if(!category){ctx.trace('[getProductsByCategoryAction] Unable to find category');return[];}categoryId=category.RecordId;}const productInputs=await searchByCategoryAsync({callerContext:ctx,queryResultSettings:input.queryResultSettingsProxy.QueryResultSettings},+apiSettings.channelId,input.catalogId,categoryId||0).then(productSearchResults=>{return productSearchResults.map(product=>{return new ProductInput(product.RecordId,apiSettings);});});if(productInputs.length>0){return await getProducts(productInputs,ctx);}else{return[];}}/**\r\n * The getProductsByCategory data action\r\n * Retrieves the current category of the request via the getCurrentCategory data action\r\n * Then calls the searchByCategory RetailServer API to get a list of products associated with\r\n * the current category, and finally fully hydrates the data for those prodcuts via the\r\n * getProducts data action, returning a list of SimpleProducts within the current category.\r\n */export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/get-products-by-category',action:getProductsByCategoryAction,input:createGetProductsByCategoryInput});","map":{"version":3,"sources":["../../src/get-products-by-category.ts"],"names":[],"mappings":"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","sourcesContent":["import { CacheType, IAction, IActionInput, ICommerceApiSettings } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IActionContext, IAny, ICreateActionContext, IGeneric } from '@msdyn365-commerce/core';\nimport { ProductSearchResult, SimpleProduct } from '@msdyn365-commerce/retail-proxy';\nimport getCurrentCategory, { CurrentCategoryInput } from './get-current-category';\nimport getProducts, { ProductInput } from './get-simple-products';\n\nimport { searchByCategoryAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/ProductsDataActions.g';\nimport { QueryResultSettingsProxy } from './utilities/QueryResultSettingsProxy';\nimport { buildCacheKey } from './utilities/utils';\n\n/**\n * Product by category ID Input action\n */\nexport class ProductsByCategoryInput implements IActionInput {\n    public categoryId?: number;\n    public categorySlug?: string;\n    public categoryName?: string;\n    public catalogId: number;\n    public currentCategory: CurrentCategoryInput;\n    public readonly queryResultSettingsProxy: QueryResultSettingsProxy;\n    private apiSettings: ICommerceApiSettings;\n\n    constructor(category: CurrentCategoryInput, apiSettings: ICommerceApiSettings, queryResultSettingsProxy: QueryResultSettingsProxy) {\n        this.apiSettings = apiSettings;\n        this.currentCategory = category;\n        this.queryResultSettingsProxy = queryResultSettingsProxy;\n        this.catalogId = apiSettings.catalogId;\n        this.categoryId = category.categoryId;\n        this.categorySlug = category.categorySlug;\n    }\n\n    public getCacheKey = () => buildCacheKey(`${this.categoryId || this.categorySlug}|${this.catalogId}|${this.queryResultSettingsProxy.cacheKeyHint}`, this.apiSettings);\n    public getCacheObjectType = () => 'Products-From-Search';\n    public dataCacheType = (): CacheType => 'application';\n}\n\n/**\n * createInput method for the getProductsByCategory data aciton\n */\nexport const createGetProductsByCategoryInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    if (inputData && inputData.requestContext) {\n        const currentCategory = new CurrentCategoryInput(inputData.requestContext);\n        const queryResultSettingsProxy = QueryResultSettingsProxy.fromInputData(inputData);\n        return new ProductsByCategoryInput(\n            currentCategory,\n            inputData.requestContext.apiSettings,\n            queryResultSettingsProxy\n        );\n    }\n\n    throw new Error('Please specify categoryId query string in request.');\n};\n\n/**\n * Action method for the getProductsByCategory data action\n */\nexport async function getProductsByCategoryAction(input: ProductsByCategoryInput, ctx: IActionContext): Promise<SimpleProduct[]> {\n    const { apiSettings } = ctx.requestContext;\n    let categoryId = input.currentCategory.categoryId;\n    if (input.currentCategory.categorySlug && !categoryId) {\n        const category = await getCurrentCategory(input.currentCategory, ctx);\n        if (!category) {\n            ctx.trace('[getProductsByCategoryAction] Unable to find category');\n            return <SimpleProduct[]>[];\n        }\n        categoryId = category.RecordId;\n    }\n\n    const productInputs = await searchByCategoryAsync(\n        { callerContext: ctx, queryResultSettings: input.queryResultSettingsProxy.QueryResultSettings },\n        +apiSettings.channelId,\n        input.catalogId,\n        categoryId || 0\n    ).then(productSearchResults => {\n        return productSearchResults.map(\n            (product: ProductSearchResult): ProductInput => {\n                return new ProductInput(product.RecordId, apiSettings);\n            }\n        );\n    });\n\n    if (productInputs.length > 0) {\n        return <SimpleProduct[]>await getProducts(productInputs, ctx);\n    } else {\n        return <SimpleProduct[]>[];\n    }\n}\n\n/**\n * The getProductsByCategory data action\n * Retrieves the current category of the request via the getCurrentCategory data action\n * Then calls the searchByCategory RetailServer API to get a list of products associated with\n * the current category, and finally fully hydrates the data for those prodcuts via the\n * getProducts data action, returning a list of SimpleProducts within the current category.\n */\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-products-by-category',\n    action: <IAction<SimpleProduct[]>>getProductsByCategoryAction,\n    input: createGetProductsByCategoryInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}