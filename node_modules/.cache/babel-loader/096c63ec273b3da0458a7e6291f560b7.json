{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"@babel/runtime/helpers/esm/createClass\";import _inherits from\"@babel/runtime/helpers/esm/inherits\";import _possibleConstructorReturn from\"@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"@babel/runtime/helpers/esm/getPrototypeOf\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect===\"undefined\"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy===\"function\")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}import{__decorate}from\"tslib\";import*as React from'react';import{withModuleState}from'@msdyn365-commerce-modules/checkout-utilities';import classnames from'classnames';import _get from'lodash/get';import{computed,reaction}from'mobx';import{observer}from'mobx-react';import{getAccountPaymentFormEditMode}from'./components/get-account-payment-form-edit-mode';import{getAccountPaymentFormSummaryMode}from'./components/get-account-payment-form-summary-mode';var CheckoutCustomerAccountPayment=/*#__PURE__*/function(_React$Component){_inherits(CheckoutCustomerAccountPayment,_React$Component);var _super=_createSuper(CheckoutCustomerAccountPayment);function CheckoutCustomerAccountPayment(props){var _this;_classCallCheck(this,CheckoutCustomerAccountPayment);_this=_super.call(this,props);_this.baseClassName='ms-checkout-customer-account';_this.getAvailableCredit=function(creditBalances){if(!creditBalances){return 0;}return creditBalances.CreditLimit-creditBalances.Balance-creditBalances.PendingBalance;};_this.addPayment=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var checkoutState;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:checkoutState=_this.props.data.checkout.result;if(checkoutState){_context.next=4;break;}_this.props.context.telemetry.error('checkout state not found');return _context.abrupt(\"return\");case 4:_context.next=6;return checkoutState.updateCustomerAccountAmount({newAmount:_this.state.paymentAmount});case 6:_this.props.context.telemetry.information('customer account payment amount updated');case 7:case\"end\":return _context.stop();}}},_callee);}));_this.toggleCreditSection=function(){_this.setState({isCreditSectionExpanded:!_this.state.isCreditSectionExpanded});};_this.init=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this.props.moduleState.init({onCancel:_this.handleCancelOrSubmit,onSubmit:_this.handleCancelOrSubmit,onEdit:_this.onEdit});if(_this.props.data.checkout.result&&_this.props.data.checkout.result.customerAccountAmount!==0){_this.props.moduleState.onReady();}case 2:case\"end\":return _context2.stop();}}},_callee2);}));_this.onChangePaymentAmount=function(newAmount){_this.setState({paymentAmount:newAmount});};_this.updateMaxAmount=function(newAmount){if(_this.props.data.checkout.result&&_this.props.data.checkout.result.customerAccountAmount===0){_this.setState({paymentAmount:Math.max(0,newAmount)});}};_this.onEdit=function(){_this.props.moduleState.onUpdating();};_this.handleCancelOrSubmit=function(){var checkoutState=_this.props.data.checkout.result;if(checkoutState&&checkoutState.customerAccountAmount>0){_this.props.moduleState.onReady();}else{_this.props.moduleState.onSkip();}};_this.removePayment=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var checkoutState;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:checkoutState=_this.props.data.checkout.result;if(checkoutState){_context3.next=4;break;}_this.props.context.telemetry.error('checkout state not found');return _context3.abrupt(\"return\");case 4:_this.setState({paymentAmount:0});_context3.next=7;return checkoutState.updateCustomerAccountAmount({newAmount:0});case 7:_this.props.context.telemetry.information('customer account payment removed');case 8:case\"end\":return _context3.stop();}}},_callee3);}));_this.state={paymentAmount:_this.maxPaymentAmount,isCreditSectionExpanded:false};return _this;}_createClass(CheckoutCustomerAccountPayment,[{key:\"componentDidMount\",value:function(){var _componentDidMount=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var _this2=this;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return this.init();case 2:reaction(function(){return _this2.props.data.checkout.result&&_this2.props.data.checkout.result.checkoutCart.cart&&_this2.props.data.checkout.result.checkoutCart.cart.TotalAmount;},function(totalAmount){_this2.updateMaxAmount(_this2.maxPaymentAmount);});case 3:case\"end\":return _context4.stop();}}},_callee4,this);}));function componentDidMount(){return _componentDidMount.apply(this,arguments);}return componentDidMount;}()},{key:\"render\",value:function render(){var customerInfo=this.props.data.customerInformation.result;if(!this.isCustomerAccountPaymentEnabled){this.props.context.telemetry.information('customer account payments will not display, because the feature is disabled or not enabled for this type of customer');return null;}var checkoutState=this.props.data.checkout.result;var cart=checkoutState?checkoutState.checkoutCart.cart:undefined;var creditBalances=this.props.data.creditBalances.result;if(!cart){return null;}var resources=this.props.resources;var locale=_get(this.props,'context.request.locale')||'en-us';var customerSinceDate=new Date((customerInfo===null||customerInfo===void 0?void 0:customerInfo.CreatedDateTime)||0).toLocaleDateString(locale);var props=_objectSpread(_objectSpread({},this.props),{},{checkoutCustomerAccount:{moduleProps:this.props,className:classnames(this.baseClassName)},editView:getAccountPaymentFormEditMode({onAddPayment:this.addPayment,resources:resources,amount:this.state.paymentAmount,onChangePaymentAmount:this.onChangePaymentAmount,maxAmount:this.maxPaymentAmount,customer:customerInfo,customerCreatedDate:customerSinceDate,availableCredit:this.props.context.cultureFormatter.formatCurrency(this.getAvailableCredit(creditBalances),this.currencyCode),showCreditLimit:(customerInfo===null||customerInfo===void 0?void 0:customerInfo.MandatoryCreditLimit)||false,errorMessage:this.errorMessage,onToggleCreditSection:this.toggleCreditSection,creditSectionIsExpanded:this.state.isCreditSectionExpanded,orderTotal:this.props.context.cultureFormatter.formatCurrency(this.orderTotal,this.currencyCode),excessCredit:this.formattedExcessCredit,onRemovePayment:this.removePayment,appliedAmount:checkoutState&&checkoutState.customerAccountAmount>0?this.props.context.cultureFormatter.formatCurrency(checkoutState.customerAccountAmount,this.currencyCode):undefined}),summaryView:getAccountPaymentFormSummaryMode({resources:resources,amount:this.state.paymentAmount,appliedAmount:checkoutState&&checkoutState.customerAccountAmount>0?this.props.context.cultureFormatter.formatCurrency(checkoutState.customerAccountAmount,this.currencyCode):undefined})});return this.props.renderView(props);}},{key:\"isCustomerAccountPaymentEnabled\",get:function get(){var customerInfo=_get(this.props,'data.customerInformation.result');var platform=_get(this.props,'context.request.app.platform');return customerInfo&&customerInfo.AllowOnAccountPayment===true&&platform&&(platform.enableCustomerAccountPayment==='all'||platform.enableCustomerAccountPayment==='b2b'&&customerInfo.IsB2b===true||platform.enableCustomerAccountPayment==='b2c'&&customerInfo.IsB2b===false);}},{key:\"getLoyaltyAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;if(!checkoutState||!checkoutState.loyaltyAmount){return 0;}return checkoutState.loyaltyAmount;}},{key:\"getGiftCardAmount\",get:function get(){var checkoutState=this.props.data.checkout.result;if(!checkoutState||!checkoutState.giftCards||checkoutState.giftCards.length===0){return 0;}var giftCardAmount=0;checkoutState.giftCards.forEach(function(giftCard){giftCardAmount+=giftCard.Balance||0;});return giftCardAmount;}},{key:\"maxPaymentAmount\",get:function get(){var _this$props$data$cust,_this$props$data$cust2;var cart=this.props.data.checkout.result?this.props.data.checkout.result.checkoutCart.cart:undefined;if(!cart){return 0;}var amountDue=Math.max(0,(cart.TotalAmount||0)-this.getLoyaltyAmount-this.getGiftCardAmount);if((_this$props$data$cust=this.props.data.customerInformation)!==null&&_this$props$data$cust!==void 0&&(_this$props$data$cust2=_this$props$data$cust.result)!==null&&_this$props$data$cust2!==void 0&&_this$props$data$cust2.MandatoryCreditLimit){var _this$props$data$cred;return Math.min(this.getAvailableCredit((_this$props$data$cred=this.props.data.creditBalances)===null||_this$props$data$cred===void 0?void 0:_this$props$data$cred.result),amountDue);}else{return amountDue;}}},{key:\"errorMessage\",get:function get(){if(this.state.paymentAmount>this.maxPaymentAmount||this.state.paymentAmount<0){return this.props.resources.invalidAmountMessage;}return undefined;}},{key:\"currencyCode\",get:function get(){return _get(this.props,'context.request.channel.Currency');}},{key:\"availableCredit\",get:function get(){var creditBalances=_get(this.props,'data.creditBalances.result');return creditBalances?this.getAvailableCredit(creditBalances):0;}},{key:\"orderTotal\",get:function get(){var orderTotal=_get(this.props,'data.checkout.result.checkoutCart.cart.TotalAmount');return orderTotal?orderTotal:0;}},{key:\"formattedExcessCredit\",get:function get(){var excessCredit=this.availableCredit-this.orderTotal;return excessCredit<0?this.props.context.cultureFormatter.formatCurrency(excessCredit,this.currencyCode):undefined;}}]);return CheckoutCustomerAccountPayment;}(React.Component);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"isCustomerAccountPaymentEnabled\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"getLoyaltyAmount\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"getGiftCardAmount\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"maxPaymentAmount\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"errorMessage\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"currencyCode\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"availableCredit\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"orderTotal\",null);__decorate([computed],CheckoutCustomerAccountPayment.prototype,\"formattedExcessCredit\",null);CheckoutCustomerAccountPayment=__decorate([withModuleState,observer],CheckoutCustomerAccountPayment);export{CheckoutCustomerAccountPayment};export default CheckoutCustomerAccountPayment;","map":{"version":3,"sources":["modules/checkout-customer-account-payment/checkout-customer-account-payment.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as React from 'react';\n\nimport { IModuleStateManager, withModuleState } from '@msdyn365-commerce-modules/checkout-utilities';\nimport { IModuleProps } from '@msdyn365-commerce-modules/utilities';\nimport { CustomerBalances } from '@msdyn365-commerce/retail-proxy';\nimport classnames from 'classnames';\nimport get from 'lodash/get';\nimport { computed, reaction } from 'mobx';\nimport { observer } from 'mobx-react';\nimport { ICheckoutCustomerAccountPaymentData } from './checkout-customer-account-payment.data';\nimport { ICheckoutCustomerAccountPaymentProps } from './checkout-customer-account-payment.props.autogenerated';\nimport { getAccountPaymentFormEditMode, IAccountPaymentEditViewForm } from './components/get-account-payment-form-edit-mode';\nimport { getAccountPaymentFormSummaryMode, IAccountPaymentSummaryViewForm } from './components/get-account-payment-form-summary-mode';\n\nexport interface ICheckoutCustomerAccountPaymentViewProps extends ICheckoutCustomerAccountPaymentProps<ICheckoutCustomerAccountPaymentData> {\n    checkoutCustomerAccount: IModuleProps;\n    summaryView: IAccountPaymentSummaryViewForm;\n    editView: IAccountPaymentEditViewForm;\n    moduleState: IModuleStateManager;\n}\n\nexport interface ICheckoutCustomerAccountPaymentState {\n    paymentAmount: number;\n    isCreditSectionExpanded: boolean;\n}\n\n/**\n *\n * CheckoutCustomerAccount component\n * @extends {React.Component<ICheckoutCustomerAccountPaymentProps<ICheckoutCustomerAccountPaymentData>>}\n */\n// @ts-ignore\n@withModuleState\n@observer\nexport class CheckoutCustomerAccountPayment extends React.Component<ICheckoutCustomerAccountPaymentViewProps, ICheckoutCustomerAccountPaymentState> {\n\n    @computed get isCustomerAccountPaymentEnabled(): boolean {\n        const customerInfo = get(this.props, 'data.customerInformation.result');\n        const platform = get(this.props, 'context.request.app.platform');\n\n        return customerInfo &&\n        customerInfo.AllowOnAccountPayment === true &&\n        platform &&\n        (platform.enableCustomerAccountPayment === 'all' ||\n        (platform.enableCustomerAccountPayment === 'b2b' && customerInfo.IsB2b === true) ||\n        (platform.enableCustomerAccountPayment === 'b2c' && customerInfo.IsB2b === false));\n    }\n\n    @computed get getLoyaltyAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        if (!checkoutState || !checkoutState.loyaltyAmount) {\n            return 0;\n        }\n        return checkoutState.loyaltyAmount;\n    }\n\n    @computed get getGiftCardAmount(): number {\n        const checkoutState = this.props.data.checkout.result;\n        if (!checkoutState || !checkoutState.giftCards || checkoutState.giftCards.length === 0) {\n            return 0;\n        }\n\n        let giftCardAmount: number = 0;\n        checkoutState.giftCards.forEach(giftCard => {\n                giftCardAmount += (giftCard.Balance || 0);\n            });\n\n        return giftCardAmount;\n    }\n\n    @computed get maxPaymentAmount(): number {\n        const cart = this.props.data.checkout.result ? this.props.data.checkout.result.checkoutCart.cart : undefined;\n        if (!cart) {\n            return 0;\n        }\n        // Use customer account after gift card and loyalty.\n        const amountDue = Math.max(0, (cart.TotalAmount || 0) - this.getLoyaltyAmount - this.getGiftCardAmount);\n\n        // if the user has a mandatory credit limit, then the max amount must not be more than that\n        if (this.props.data.customerInformation?.result?.MandatoryCreditLimit) {\n            return Math.min(this.getAvailableCredit(this.props.data.creditBalances?.result), amountDue);\n        } else {\n            return amountDue;\n        }\n    }\n\n    @computed get errorMessage(): string | undefined {\n        if (this.state.paymentAmount > this.maxPaymentAmount || this.state.paymentAmount < 0) {\n            return this.props.resources.invalidAmountMessage;\n        }\n\n        return undefined;\n    }\n\n    @computed get currencyCode(): string | undefined {\n        return get(this.props, 'context.request.channel.Currency');\n    }\n\n    @computed get availableCredit(): number {\n        const creditBalances = get(this.props, 'data.creditBalances.result');\n\n        return creditBalances ? this.getAvailableCredit(creditBalances) : 0;\n    }\n\n    @computed get orderTotal(): number {\n        const orderTotal = get(this.props, 'data.checkout.result.checkoutCart.cart.TotalAmount');\n\n        return orderTotal ? orderTotal : 0;\n    }\n\n    @computed get formattedExcessCredit(): string | undefined {\n        const excessCredit = this.availableCredit - this.orderTotal;\n        return excessCredit < 0 ? this.props.context.cultureFormatter.formatCurrency(excessCredit, this.currencyCode) : undefined;\n    }\n\n    private baseClassName: string = 'ms-checkout-customer-account';\n    public constructor(props: ICheckoutCustomerAccountPaymentViewProps) {\n        super(props);\n        this.state = {paymentAmount: this.maxPaymentAmount, isCreditSectionExpanded: false};\n    }\n\n    public async componentDidMount(): Promise<void> {\n        await this.init();\n\n        // when the cart.TotalAmount gets updated (like if selecting the delivery option adds a charge) we need to update the amount based on the new total amount.\n        reaction(\n            () => this.props.data.checkout.result && this.props.data.checkout.result.checkoutCart.cart && this.props.data.checkout.result.checkoutCart.cart.TotalAmount,\n            totalAmount => {\n                this.updateMaxAmount(this.maxPaymentAmount);\n            }\n        );\n    }\n\n    public render(): JSX.Element | null {\n        const customerInfo = this.props.data.customerInformation.result;\n\n        if (!this.isCustomerAccountPaymentEnabled) {\n            this.props.context.telemetry.information('customer account payments will not display, because the feature is disabled or not enabled for this type of customer');\n            return null;\n        }\n\n        const checkoutState = this.props.data.checkout.result;\n        const cart =  checkoutState ? checkoutState.checkoutCart.cart : undefined;\n\n        const creditBalances = this.props.data.creditBalances.result;\n\n        if (!cart) {\n            return null;\n        }\n        const resources = this.props.resources;\n        const locale = get(this.props, 'context.request.locale') || 'en-us';\n\n        const customerSinceDate = new Date(customerInfo?.CreatedDateTime || 0).toLocaleDateString(locale);\n\n        const props = {\n            ...this.props,\n            checkoutCustomerAccount: {\n            moduleProps: this.props,\n            className: classnames(\n                this.baseClassName\n            )},\n            editView: getAccountPaymentFormEditMode({\n                onAddPayment: this.addPayment,\n                resources,\n                amount: this.state.paymentAmount,\n                onChangePaymentAmount: this.onChangePaymentAmount,\n                maxAmount: this.maxPaymentAmount,\n                customer: customerInfo,\n                customerCreatedDate: customerSinceDate,\n                availableCredit: this.props.context.cultureFormatter.formatCurrency(this.getAvailableCredit(creditBalances), this.currencyCode),\n                showCreditLimit: customerInfo?.MandatoryCreditLimit || false,\n                errorMessage: this.errorMessage,\n                onToggleCreditSection: this.toggleCreditSection,\n                creditSectionIsExpanded: this.state.isCreditSectionExpanded,\n                orderTotal: this.props.context.cultureFormatter.formatCurrency(this.orderTotal, this.currencyCode),\n                excessCredit: this.formattedExcessCredit,\n                onRemovePayment: this.removePayment,\n                appliedAmount: checkoutState && checkoutState.customerAccountAmount > 0 ? this.props.context.cultureFormatter.formatCurrency(checkoutState.customerAccountAmount, this.currencyCode) : undefined\n            }),\n            summaryView: getAccountPaymentFormSummaryMode({\n                resources,\n                amount: this.state.paymentAmount,\n                appliedAmount: checkoutState && checkoutState.customerAccountAmount > 0 ? this.props.context.cultureFormatter.formatCurrency(checkoutState.customerAccountAmount, this.currencyCode) : undefined\n            })\n        };\n\n        return this.props.renderView(props) as React.ReactElement;\n    }\n\n    private getAvailableCredit = (creditBalances: CustomerBalances | undefined) => {\n        if (!creditBalances) {\n            return 0;\n        }\n        return creditBalances.CreditLimit - creditBalances.Balance - creditBalances.PendingBalance;\n    };\n\n    private addPayment = async (): Promise<void> => {\n        const checkoutState = this.props.data.checkout.result;\n\n        if (!checkoutState) {\n            this.props.context.telemetry.error('checkout state not found');\n            return;\n        }\n\n        await checkoutState.updateCustomerAccountAmount({ newAmount: this.state.paymentAmount });\n        this.props.context.telemetry.information('customer account payment amount updated');\n    }\n\n    private toggleCreditSection = (): void => {\n        this.setState({\n            isCreditSectionExpanded: !this.state.isCreditSectionExpanded\n        });\n    };\n\n    private init = async(): Promise<void> => {\n        this.props.moduleState.init({\n            onCancel: this.handleCancelOrSubmit,\n            onSubmit: this.handleCancelOrSubmit,\n            onEdit: this.onEdit\n        });\n\n        if (this.props.data.checkout.result && this.props.data.checkout.result.customerAccountAmount !== 0) {\n            this.props.moduleState.onReady();\n        }\n    }\n\n    private onChangePaymentAmount =(newAmount: number): void => {\n        this.setState({\n            paymentAmount: newAmount\n        });\n    };\n\n    private updateMaxAmount =(newAmount: number): void => {\n\n        // if the user has already set an amount, we should not override that in the UI because it will be confusing.\n        if (this.props.data.checkout.result && this.props.data.checkout.result.customerAccountAmount === 0) {\n            this.setState({\n                // We should never allow a negative amount.\n                paymentAmount: Math.max(0, newAmount)\n            });\n        }\n    };\n\n    private onEdit = (): void => {\n        this.props.moduleState.onUpdating();\n    };\n\n    private handleCancelOrSubmit = () => {\n        const checkoutState = this.props.data.checkout.result;\n        if (checkoutState && checkoutState.customerAccountAmount > 0) {\n            this.props.moduleState.onReady();\n        } else {\n            // Skip the module\n            this.props.moduleState.onSkip();\n        }\n    };\n\n    private removePayment = async (): Promise<void> => {\n        const checkoutState = this.props.data.checkout.result;\n\n        if (!checkoutState) {\n            this.props.context.telemetry.error('checkout state not found');\n            return;\n        }\n\n        this.setState({\n            paymentAmount: 0\n        });\n\n        await checkoutState.updateCustomerAccountAmount({ newAmount: 0});\n        this.props.context.telemetry.information('customer account payment removed');\n    }\n}\n\nexport default CheckoutCustomerAccountPayment;\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}