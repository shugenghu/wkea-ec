{"ast":null,"code":"import _regeneratorRuntime from\"@babel/runtime/regenerator\";import _asyncToGenerator from\"@babel/runtime/helpers/esm/asyncToGenerator\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";import _classCallCheck from\"@babel/runtime/helpers/esm/classCallCheck\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{createObservableDataAction}from'@msdyn365-commerce/core';import getCategoryAction,{CategoriesInput as RawCategoriesInput}from'./get-categories';import{getCategoryUrl}from'./utilities/Url-builder';import{buildCacheKey}from'./utilities/utils';/**\r\n * Input for get-categories data action\r\n */export var CategoriesInput=function CategoriesInput(context,mappedToHierarchy,maxItems){var _this=this;_classCallCheck(this,CategoriesInput);this.getCacheKey=function(){return buildCacheKey(\"\".concat(_this.channelId,\"|\").concat(_this.sitePath,\"|top-\").concat(_this.maxItems||250),_this.apiSettings,_this.locale);};this.getCacheObjectType=function(){return _this._mappedToHierarchy?'CategoryHierarchy':'Category';};this.dataCacheType=function(){return'application';};this.getLocale=function(){return _this.locale||'';};this._mappedToHierarchy=mappedToHierarchy;this.maxItems=maxItems||250;this.channelId=context&&context.apiSettings&&context.apiSettings.channelId?+context.apiSettings.channelId:0;this.sitePath=context&&context.sitePath||'';this.apiSettings=context.apiSettings;this.locale=context.locale||'';};var getFriendlyName=function getFriendlyName(locale,nameTranslations){var nameTranslation;if(locale&&nameTranslations&&nameTranslations.length>0){nameTranslation=nameTranslations.find(function(item){return item.Language.toLowerCase()===locale.toLowerCase();});}return nameTranslation&&nameTranslation.Text;};/**\r\n * Creates a hierarchy of categories based on the ParentCategory property\r\n * @param categoryList Categories that will be converted into a hierarchy\r\n * @returns Hierarchy of categories in array\r\n */export var mapCategoryToHierarchy=function mapCategoryToHierarchy(categoryList,ctx,locale){if(!categoryList||!categoryList.length){return[];}var categoryMap=categoryList.reduce(function(memo,category){var localName=getFriendlyName(locale,category.NameTranslations);var categoryHierarchy=_objectSpread({},category);categoryHierarchy.NeutralizedName=category.Name;categoryHierarchy.Name=localName||categoryHierarchy.NeutralizedName;memo[category.RecordId]=categoryHierarchy;return memo;},{});var zeroCategory=categoryMap[0];Object.keys(categoryMap).forEach(function(id){var element=categoryMap[+id];var parentId=element.ParentCategory;element.Url=getCategoryUrl(element,ctx,categoryMap);if(parentId===0){zeroCategory=element;return;}var parent=parentId&&categoryMap[parentId];if(parent){parent.Children=parent.Children||[];parent.Children.push(element);}});return zeroCategory&&zeroCategory.Children||[];};/**\r\n * Creates the input required to make the retail api call\r\n */export var createCategoriesHierarchyInput=function createCategoriesHierarchyInput(inputData){var topItems=inputData.config&&inputData.config.topCategories&&parseInt(inputData.config.topCategories,10);return new CategoriesInput(inputData.requestContext,true,topItems);};/**\r\n * Calls the Retail API and returns all the categories as a hierarchy\r\n */export function getCategoryHierarchyAction(_x,_x2){return _getCategoryHierarchyAction.apply(this,arguments);}function _getCategoryHierarchyAction(){_getCategoryHierarchyAction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(input,ctx){var categories;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getCategoryAction(new RawCategoriesInput(ctx.requestContext,false,input.maxItems),ctx);case 2:categories=_context.sent;return _context.abrupt(\"return\",mapCategoryToHierarchy(categories,ctx,input.getLocale()));case 4:case\"end\":return _context.stop();}}},_callee);}));return _getCategoryHierarchyAction.apply(this,arguments);}export default createObservableDataAction({id:'@msdyn365-commerce-modules/retail-actions/get-categories-hierarchy',action:getCategoryHierarchyAction,input:createCategoriesHierarchyInput});","map":{"version":3,"sources":["../../src/get-categories-hierarchy.ts"],"names":[],"mappings":"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","sourcesContent":["import { CategoryHierarchy } from '@msdyn365-commerce/commerce-entities';\nimport { CacheType, IAction, IActionContext, IActionInput, ICommerceApiSettings } from '@msdyn365-commerce/core';\nimport { createObservableDataAction, IAny, ICreateActionContext, IGeneric, IRequestContext } from '@msdyn365-commerce/core';\nimport { Category } from '@msdyn365-commerce/retail-proxy';\nimport { TextValueTranslation } from '@msdyn365-commerce/retail-proxy';\nimport getCategoryAction, { CategoriesInput as RawCategoriesInput } from './get-categories';\nimport { getCategoryUrl } from './utilities/Url-builder';\nimport { buildCacheKey } from './utilities/utils';\n\n/**\n * Input for get-categories data action\n */\nexport class CategoriesInput implements IActionInput {\n    public readonly maxItems: number;\n    public readonly channelId: number;\n    private readonly sitePath: string;\n    private _mappedToHierarchy: boolean;\n    private apiSettings: ICommerceApiSettings;\n    private locale?:string;\n\n    constructor(context: IRequestContext, mappedToHierarchy: boolean, maxItems?: number) {\n        this._mappedToHierarchy = mappedToHierarchy;\n        this.maxItems = maxItems || 250;\n        this.channelId = context && context.apiSettings && context.apiSettings.channelId ? +context.apiSettings.channelId : 0;\n        this.sitePath = context && context.sitePath || '';\n        this.apiSettings = context.apiSettings;\n        this.locale = context.locale || '';\n    }\n\n    public getCacheKey = () => buildCacheKey(`${this.channelId}|${this.sitePath}|top-${this.maxItems || 250}`, this.apiSettings, this.locale);\n    public getCacheObjectType = () => (this._mappedToHierarchy ? 'CategoryHierarchy' : 'Category');\n    public dataCacheType = (): CacheType => 'application';\n    public getLocale = ():string => this.locale || '';\n}\n\nconst getFriendlyName = (locale?: string, nameTranslations?: TextValueTranslation[]): string | undefined => {\n    let nameTranslation: TextValueTranslation | undefined;\n    if (locale && nameTranslations && nameTranslations.length > 0) {\n        nameTranslation = nameTranslations.find(item => item.Language!.toLowerCase() === locale.toLowerCase());\n    }\n\n    return nameTranslation && nameTranslation.Text;\n};\n\nexport interface ICategoryMap {\n    [RecordId: number]: CategoryHierarchy;\n}\n\n/**\n * Creates a hierarchy of categories based on the ParentCategory property\n * @param categoryList Categories that will be converted into a hierarchy\n * @returns Hierarchy of categories in array\n */\nexport const mapCategoryToHierarchy = (categoryList: Category[], ctx: IActionContext, locale?: string ): CategoryHierarchy[] => {\n    if (!categoryList || !categoryList.length) {\n        return [];\n    }\n\n    const categoryMap: ICategoryMap = categoryList.reduce((memo: ICategoryMap, category: Category) => {\n        const localName = getFriendlyName(locale, category.NameTranslations);\n        const categoryHierarchy = <CategoryHierarchy> { ...category };\n        categoryHierarchy.NeutralizedName = category.Name;\n        categoryHierarchy.Name = localName || categoryHierarchy.NeutralizedName;\n        memo[category.RecordId] = categoryHierarchy;\n        return memo;\n    }, {});\n\n    let zeroCategory = categoryMap[0];\n\n    Object.keys(categoryMap).forEach((id: string) => {\n        const element = categoryMap[+id];\n        const parentId = element.ParentCategory;\n        element.Url = getCategoryUrl(element, ctx, categoryMap);\n        if (parentId === 0) {\n            zeroCategory = element;\n            return;\n        }\n\n        const parent = parentId && categoryMap[parentId];\n        if (parent) {\n            parent.Children = parent.Children || [];\n            parent.Children.push(element);\n        }\n    });\n\n    return (zeroCategory && zeroCategory.Children) || [];\n};\n\n/**\n * Creates the input required to make the retail api call\n */\nexport const createCategoriesHierarchyInput = (inputData: ICreateActionContext<IGeneric<IAny>>): IActionInput => {\n    const topItems = inputData.config && inputData.config.topCategories && parseInt(inputData.config.topCategories, 10);\n    return new CategoriesInput(inputData.requestContext, true, topItems);\n};\n\n/**\n * Calls the Retail API and returns all the categories as a hierarchy\n */\nexport async function getCategoryHierarchyAction(input: CategoriesInput, ctx: IActionContext): Promise<CategoryHierarchy[]> {\n    const categories = await getCategoryAction(\n        new RawCategoriesInput(ctx.requestContext, false, input.maxItems),\n        ctx\n    );\n    return mapCategoryToHierarchy(categories, ctx, input.getLocale());\n}\n\nexport default createObservableDataAction({\n    id: '@msdyn365-commerce-modules/retail-actions/get-categories-hierarchy',\n    action: <IAction<CategoryHierarchy[]>>getCategoryHierarchyAction,\n    input: createCategoriesHierarchyInput\n});\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}