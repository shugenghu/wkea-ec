{"ast":null,"code":"import\"core-js/modules/es.object.assign.js\";import\"core-js/modules/es.regexp.to-string.js\";import\"core-js/modules/es.string.replace.js\";import\"core-js/modules/web.dom-collections.for-each.js\";import _defineProperty from\"@babel/runtime/helpers/esm/defineProperty\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{__decorate}from\"tslib\";import{Button,format,getPayloadObject,getTelemetryAttributes,getTelemetryObject,TelemetryConstant}from'@msdyn365-commerce-modules/utilities';import*as Msdyn365 from'@msdyn365-commerce/core';import{getLoyaltyRewardPointActivityTimelineAsync,getLoyaltyRewardPointsExpiringSoonAsync}from'@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';import classnames from'classnames';import{observer}from'mobx-react';import*as React from'react';import{AccountLoyaltyLabel,AccountLoyaltyModalLabel}from'./components';let AccountLoyalty=class AccountLoyalty extends React.PureComponent{constructor(props){super(props);this.handleHeadingChange=event=>this.props.config.heading.text=event.target.value;this._populateModalData=(focusRef,loyaltyCard,currentLoyaltyPoints,expiring)=>()=>{if(!loyaltyCard||!loyaltyCard.CardNumber||!currentLoyaltyPoints.RewardPointId){this.props.context.telemetry.error('Modal data is empty, module wont render');return null;}const{actionContext}=this.props.context;this.setState({isModalOpen:true,currentModalData:currentLoyaltyPoints,isModalExpiring:expiring,modalID:'',currentFocus:focusRef});if(expiring){getLoyaltyRewardPointsExpiringSoonAsync({callerContext:actionContext,queryResultSettings:{}},loyaltyCard.CardNumber,currentLoyaltyPoints.RewardPointId,30).then(points=>{this.setState({pointsActivity:points});}).catch(error=>{this.props.telemetry.exception(error);this.props.telemetry.debug('Failed to get reward point activity');});}else{getLoyaltyRewardPointActivityTimelineAsync({callerContext:actionContext,queryResultSettings:{}},loyaltyCard.CardNumber,currentLoyaltyPoints.RewardPointId).then(points=>{this.setState({pointsActivity:points});}).catch(error=>{this.props.telemetry.error(error.message);this.props.telemetry.debug('Failed to get reward point activity');});}return;};this._closeModal=()=>{this.setState({isModalOpen:false,currentModalData:undefined,pointsActivity:undefined});};this._buttonAvailableRef=/*#__PURE__*/React.createRef();this._buttonExpireRef=/*#__PURE__*/React.createRef();this.state={isModalOpen:false,currentModalData:undefined,isModalExpiring:false,modalID:'',pointsActivity:undefined};this.telemetryContent=getTelemetryObject(this.props.context.request.telemetryPageName,this.props.friendlyName,this.props.telemetry);this.payLoad=getPayloadObject('click',this.telemetryContent,TelemetryConstant.BackToShopping);}render(){const{className,heading}=this.props.config;const{loyaltyCard}=this.props.data;const{loyaltyCardLabel,totalAvailablePointsLabel,backToShoppingText}=this.props.resources;const{actionContext}=this.props.context;const{isModalOpen}=this.state;const backToShopAttributes=getTelemetryAttributes(this.telemetryContent,this.payLoad);if(!loyaltyCard||!loyaltyCard.result||!loyaltyCard.result.CardNumber){this.props.context.telemetry.error('Loyalty card content is empty, module wont render');return null;}const loyaltyCardData=loyaltyCard.result;const rewardPoints=loyaltyCard&&loyaltyCardData.RewardPoints;const homeLink=Msdyn365.getUrlSync('home',actionContext)||'';const viewProps=_objectSpread(_objectSpread({},this.props),{},{AccountLoyalty:{moduleProps:this.props,className:classnames('ms-account-loyalty',className)},totalPoints:rewardPoints&&this._getTotalPoints(),className:classnames('msc-account-loyalty',className),rewardPoints:loyaltyCardData.RewardPoints&&loyaltyCardData.RewardPoints.length>0&&this._renderRewardPoints(loyaltyCardData),pointsModal:isModalOpen&&this._renderModal()||{isOpen:false,returnFocusRef:this.state.currentFocus},Info:{className:'ms-account-loyalty__info'},Points:{className:'ms-account-loyalty__points'},Breakdown:{className:'ms-account-loyalty__breakdown'},RewardPoints:{className:'ms-account-loyalty__reward-points'},PointsBreakdown:{className:'ms-account-loyalty__point-breakdown'},Button:{className:'ms-account-loyalty__link'},heading:heading&&/*#__PURE__*/React.createElement(Msdyn365.Text,{className:'ms-account-loyalty__heading',text:heading.text,tag:heading.tag||'h2',editProps:{onEdit:this.handleHeadingChange,requestContext:this.props.context.request}}),infoLabel:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__info-label',text:loyaltyCardLabel}),cardNumber:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__card-number',text:loyaltyCardData.CardNumber}),joinDate:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__join-date',text:this._formatJoinDate(this._parseDate(loyaltyCardData.LoyaltyEnrollmentDateLocal))}),pointsLabel:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__total-points-label',text:totalAvailablePointsLabel}),points:rewardPoints&&/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__total-points',text:this._getTotalPoints()}),homeButton:rewardPoints&&/*#__PURE__*/React.createElement(\"a\",Object.assign({className:'ms-account-loyalty__home-link msc-btn',href:homeLink},backToShopAttributes),backToShoppingText)});return this.props.renderView(viewProps);}_formatJoinDate(date){return format(this.props.resources.joinDateFormatted,new Intl.DateTimeFormat(this.props.context.actionContext.requestContext.locale,{month:'long',day:'numeric',year:'numeric'}).format(new Date(date)));}_renderRewardPoints(loyaltyCard){return loyaltyCard.RewardPoints.map((loyaltyPoints,index)=>{const availableId=loyaltyPoints.RewardPointId&&\"\".concat(loyaltyPoints.RewardPointId,\"-available-\").concat(index)||'available-points';const expiringId=loyaltyPoints.RewardPointId&&\"\".concat(loyaltyPoints.RewardPointId,\"-expiring-\").concat(index)||'expiring-points';const{availablePointsLabel,expiringPointsFormatLabel}=this.props.resources;this.payLoad.contentAction.etext=TelemetryConstant.AvailablePoints;const availablePointsAttributes=getTelemetryAttributes(this.telemetryContent,this.payLoad);this.payLoad.contentAction.etext=TelemetryConstant.ExpiringPoints;const expiringPointsAttributes=getTelemetryAttributes(this.telemetryContent,this.payLoad);return{label:/*#__PURE__*/React.createElement(AccountLoyaltyModalLabel,{className:'ms-account-loyalty__points-title',text:loyaltyPoints.Description}),availableModalLabel:loyaltyPoints.ActivePoints!==undefined&&/*#__PURE__*/React.createElement(AccountLoyaltyModalLabel,{className:'ms-account-loyalty__available-points-label',text:availablePointsLabel,labelFor:availableId}),availableModalTrigger:loyaltyPoints.ActivePoints!==undefined&&/*#__PURE__*/React.createElement(Button,Object.assign({className:'ms-account-loyalty__points-trigger',color:'link',onClick:this._populateModalData(this._buttonAvailableRef,loyaltyCard,loyaltyPoints,false),innerRef:this._buttonAvailableRef},availablePointsAttributes),loyaltyPoints.ActivePoints.toString()),expiringModalLabel:loyaltyPoints.PointsExpiringSoon!==undefined&&/*#__PURE__*/React.createElement(AccountLoyaltyModalLabel,{className:'ms-account-loyalty__expiring-points-label',text:format(expiringPointsFormatLabel,30),labelFor:expiringId}),expiringModalTrigger:loyaltyPoints.PointsExpiringSoon!==undefined&&/*#__PURE__*/React.createElement(Button,Object.assign({className:'ms-account-loyalty__points-trigger',color:'link',onClick:this._populateModalData(this._buttonExpireRef,loyaltyCard,loyaltyPoints,true),innerRef:this._buttonExpireRef},expiringPointsAttributes),loyaltyPoints.PointsExpiringSoon.toString())};});}_renderModal(){const{totalAvailablePointsLabel,loyaltyActivityDateLabel,loyaltyActivityBalanceLabel}=this.props.resources;const{isModalOpen,currentModalData}=this.state;if(!isModalOpen||!currentModalData){this.props.context.telemetry.error('Account loyalty modal content is empty, module wont render');return null;}return{isOpen:isModalOpen,returnFocusRef:this.state.currentFocus,horizontalPosition:'center',verticalPosition:'center',modalClassName:'ms-account-loyalty__points-modal',modalHeaderClassName:'ms-account-loyalty__points-modal-header',modalHeader:currentModalData.Description||'',modalBodyClassName:'ms-account-loyalty__points-modal-body',ModalBodyTop:{className:'ms-account-loyalty__points-modal-body-top'},ModalBodyHeaders:{className:'ms-account-loyalty__points-modal-body-header'},rewardPointsActivity:this._renderPointsActivity(),pointsDescription:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-name',text:totalAvailablePointsLabel}),totalPoints:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-total',text:this._getPoints()}),date:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-date',text:loyaltyActivityDateLabel}),balanceLabel:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-balance',text:loyaltyActivityBalanceLabel}),onClose:this._closeModal};}_getTotalPoints(){const rewardPoints=this.props.data.loyaltyCard.result&&this.props.data.loyaltyCard.result.RewardPoints;let total=0;rewardPoints.forEach(loyaltyPoints=>{total+=loyaltyPoints.ActivePoints||0;});return total;}_getPoints(){const{currentModalData,isModalExpiring}=this.state;return\"\".concat((isModalExpiring?currentModalData.PointsExpiringSoon:currentModalData.ActivePoints)||0);}_renderPointsActivity(){const{pointsActivity}=this.state;if(!pointsActivity){this.props.context.telemetry.error('Points activity content is empty, module wont render');return undefined;}return pointsActivity.map(activity=>{return{Activity:{className:'ms-account-loyalty__points-modal-activity'},activityType:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-type',text:this._getTimelineType(activity)}),activityDate:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-date',text:this.props.context.cultureFormatter.formatDate(this._parseDate(activity.ActivityDate))}),activityPoints:/*#__PURE__*/React.createElement(AccountLoyaltyLabel,{className:'ms-account-loyalty__points-modal-points',text:activity.LoyaltyPoints&&activity.LoyaltyPoints||''})};});}_parseDate(date){if(typeof date==='string'){let dateString=date.toString();dateString=dateString.replace(/-/g,'/');dateString=dateString.substring(0,10);return new Date(dateString);}else{return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate());}}_getTimelineType(pointActivity){if(pointActivity.LoyaltyRewardPointTimelineEntryType){return pointActivity.LoyaltyRewardPointTimelineEntryType;}const{earnedPointsLabel,redeemedPointsLabel,adjustedPointsLabel}=this.props.resources;switch(pointActivity.ExtensibleLoyaltyRewardPointActivityEntryTypeValue){case 1:return earnedPointsLabel;case 3:return redeemedPointsLabel;case 5:return adjustedPointsLabel;default:return'';}}};AccountLoyalty=__decorate([observer],AccountLoyalty);export default AccountLoyalty;","map":{"version":3,"sources":["modules/account-loyalty/account-loyalty.tsx"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { Button, format, getPayloadObject, getTelemetryAttributes, getTelemetryObject, IModuleProps, INodeProps, IPayLoad, ITelemetryContent, TelemetryConstant } from '@msdyn365-commerce-modules/utilities';\nimport * as Msdyn365 from '@msdyn365-commerce/core';\nimport { LoyaltyCard, LoyaltyRewardPoint, LoyaltyRewardPointActivity } from '@msdyn365-commerce/retail-proxy';\nimport { getLoyaltyRewardPointActivityTimelineAsync, getLoyaltyRewardPointsExpiringSoonAsync } from '@msdyn365-commerce/retail-proxy/dist/DataActions/StoreOperationsDataActions.g';\nimport classnames from 'classnames';\nimport { observer } from 'mobx-react';\nimport * as React from 'react';\nimport { IAccountLoyaltyData } from './account-loyalty.data';\nimport { IAccountLoyaltyProps } from './account-loyalty.props.autogenerated';\nimport { AccountLoyaltyLabel, AccountLoyaltyModalLabel } from './components';\n\nexport interface IAccountLoyaltyViewProps extends IAccountLoyaltyProps<{}> {\n    AccountLoyalty: IModuleProps;\n    className: string;\n    totalPoints: number;\n    heading?: React.ReactNode;\n    Info: INodeProps;\n    infoLabel: React.ReactNode;\n    cardNumber: React.ReactNode;\n    joinDate: React.ReactNode;\n    Points: INodeProps;\n    pointsLabel: React.ReactNode;\n    points: React.ReactNode;\n    Breakdown: INodeProps;\n    RewardPoints: INodeProps;\n    PointsBreakdown: INodeProps;\n    rewardPoints?: IAccountLoyaltyRewardPointProps[];\n    Button: INodeProps;\n    homeButton: React.ReactNode;\n    pointsModal: IAccountLoyaltyModalProps;\n}\n\nexport interface IAccountLoyaltyState {\n    isModalOpen: boolean;\n    currentModalData?: LoyaltyRewardPoint;\n    isModalExpiring: boolean;\n    modalID: string;\n    currentFocus?: React.RefObject<HTMLElement>;\n    pointsActivity: LoyaltyRewardPointActivity[] | undefined;\n}\n\nexport interface IAccountLoyaltyRewardPointProps {\n    label: React.ReactNode;\n    availableModalLabel: React.ReactNode;\n    availableModalTrigger: React.ReactNode;\n    expiringModalLabel: React.ReactNode;\n    expiringModalTrigger: React.ReactNode;\n}\n\nexport type horizontalModalPosition = 'left' | 'center' | 'right';\nexport type verticalModalPosition = 'top' | 'center' | 'bottom';\n\nexport interface IAccountLoyaltyModalProps {\n    isOpen: boolean;\n    horizontalPosition?: horizontalModalPosition;\n    verticalPosition?: verticalModalPosition;\n    modalClassName?: string;\n    modalHeaderClassName?: string;\n    modalHeader?: string;\n    modalBodyClassName?: string;\n    ModalBodyTop: INodeProps;\n    pointsDescription?: React.ReactNode;\n    totalPoints?: React.ReactNode;\n    ModalBodyHeaders: INodeProps;\n    date?: React.ReactNode;\n    balanceLabel?: React.ReactNode;\n    rewardPointsActivity?: IAccountLoyaltyActivityProps[];\n    returnFocusRef?: React.RefObject<HTMLElement>;\n    onClose(): void;\n}\n\nexport interface IAccountLoyaltyActivityProps {\n    Activity: INodeProps;\n    activityType: React.ReactNode;\n    activityDate: React.ReactNode;\n    activityPoints: React.ReactNode;\n}\n\nexport interface IProps extends IAccountLoyaltyProps<IAccountLoyaltyData> { }\n\n/**\n *\n * AccountLoyalty component\n * @extends {React.Component<IAccountLoyaltyProps<IAccountLoyaltyData>>}\n */\n@observer\nclass AccountLoyalty extends React.PureComponent<IProps, IAccountLoyaltyState> {\n    private _buttonAvailableRef: React.RefObject<HTMLButtonElement>;\n    private _buttonExpireRef: React.RefObject<HTMLButtonElement>;\n    private telemetryContent?: ITelemetryContent;\n    private payLoad: IPayLoad;\n\n    constructor(props: IAccountLoyaltyProps<IAccountLoyaltyData>) {\n        super(props);\n        this._buttonAvailableRef = React.createRef();\n        this._buttonExpireRef = React.createRef();\n        this.state = {\n            isModalOpen: false,\n            currentModalData: undefined,\n            isModalExpiring: false,\n            modalID: '',\n            pointsActivity: undefined\n        };\n        this.telemetryContent = getTelemetryObject(this.props.context.request.telemetryPageName!, this.props.friendlyName, this.props.telemetry);\n        this.payLoad = getPayloadObject('click', this.telemetryContent, TelemetryConstant.BackToShopping);\n    }\n\n    public render(): JSX.Element | null {\n        const { className, heading } = this.props.config;\n        const { loyaltyCard } = this.props.data;\n        const { loyaltyCardLabel, totalAvailablePointsLabel, backToShoppingText } = this.props.resources;\n        const { actionContext } = this.props.context;\n        const { isModalOpen } = this.state;\n        const backToShopAttributes = getTelemetryAttributes(this.telemetryContent!, this.payLoad);\n\n        if (!loyaltyCard || !loyaltyCard.result ||  !loyaltyCard.result.CardNumber) {\n            this.props.context.telemetry.error('Loyalty card content is empty, module wont render');\n            return null;\n        }\n\n        const loyaltyCardData = loyaltyCard.result;\n        const rewardPoints = loyaltyCard && loyaltyCardData.RewardPoints;\n        const homeLink = Msdyn365.getUrlSync('home', actionContext) || '';\n\n        const viewProps = {\n            ...this.props,\n            AccountLoyalty: {\n                moduleProps: this.props,\n                className: classnames('ms-account-loyalty', className),\n            },\n            totalPoints: rewardPoints && this._getTotalPoints(),\n            className: classnames('msc-account-loyalty', className),\n            rewardPoints: loyaltyCardData.RewardPoints && loyaltyCardData.RewardPoints.length > 0 && this._renderRewardPoints(loyaltyCardData),\n            pointsModal: isModalOpen && this._renderModal() || { isOpen: false, returnFocusRef: this.state.currentFocus },\n            Info: { className: 'ms-account-loyalty__info' },\n            Points: { className: 'ms-account-loyalty__points' },\n            Breakdown: { className: 'ms-account-loyalty__breakdown' },\n            RewardPoints: { className: 'ms-account-loyalty__reward-points' },\n            PointsBreakdown: { className: 'ms-account-loyalty__point-breakdown' },\n            Button: { className: 'ms-account-loyalty__link' },\n            heading: heading &&\n                (\n                    <Msdyn365.Text\n                        className='ms-account-loyalty__heading'\n                        text={heading.text}\n                        tag={heading.tag || 'h2'}\n                        editProps = {{onEdit: this.handleHeadingChange, requestContext: this.props.context.request}}\n                    />\n                ),\n\n            // account info\n            infoLabel:\n               (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__info-label'\n                        text={loyaltyCardLabel}\n                    />\n               ),\n            cardNumber:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__card-number'\n                        text={loyaltyCardData.CardNumber}\n                    />\n                ),\n            joinDate:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__join-date'\n                        text={this._formatJoinDate(this._parseDate(loyaltyCardData.LoyaltyEnrollmentDateLocal!))}\n                    />\n                ),\n\n            // points\n            pointsLabel:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__total-points-label'\n                        text={totalAvailablePointsLabel}\n                    />\n                ),\n            points: rewardPoints &&\n               (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__total-points'\n                        text={this._getTotalPoints()}\n                    />\n               ),\n\n            homeButton: rewardPoints &&\n                (\n                    <a\n                        className='ms-account-loyalty__home-link msc-btn'\n                        href={homeLink}\n                        {...backToShopAttributes}\n                    >\n                        { backToShoppingText }\n                    </a>\n                )\n        };\n\n        return this.props.renderView(viewProps) as React.ReactElement;\n    }\n\n    public handleHeadingChange = (event: Msdyn365.ContentEditableEvent) => this.props.config.heading!.text= event.target.value;\n\n    private _formatJoinDate(date: Date): string {\n        return format(this.props.resources.joinDateFormatted,\n                      new Intl.DateTimeFormat(this.props.context.actionContext.requestContext.locale, { month: 'long', day: 'numeric', year: 'numeric' }).format(new Date(date)));\n    }\n\n    private _renderRewardPoints(loyaltyCard: LoyaltyCard): IAccountLoyaltyRewardPointProps[] {\n        return loyaltyCard.RewardPoints!.map((loyaltyPoints, index) => {\n            const availableId =  loyaltyPoints.RewardPointId && `${ loyaltyPoints.RewardPointId }-available-${ index }` || 'available-points';\n            const expiringId = loyaltyPoints.RewardPointId && `${ loyaltyPoints.RewardPointId }-expiring-${ index }` || 'expiring-points';\n            const { availablePointsLabel, expiringPointsFormatLabel } = this.props.resources;\n            this.payLoad.contentAction.etext = TelemetryConstant.AvailablePoints;\n            const availablePointsAttributes = getTelemetryAttributes(this.telemetryContent!, this.payLoad);\n            this.payLoad.contentAction.etext = TelemetryConstant.ExpiringPoints;\n            const expiringPointsAttributes = getTelemetryAttributes(this.telemetryContent!, this.payLoad);\n\n            return ({\n                label:\n                    (\n                        <AccountLoyaltyModalLabel\n                            className='ms-account-loyalty__points-title'\n                            text={loyaltyPoints.Description}\n                        />\n                    ),\n                availableModalLabel: loyaltyPoints.ActivePoints !== undefined &&\n                    (\n                        <AccountLoyaltyModalLabel\n                            className='ms-account-loyalty__available-points-label'\n                            text={availablePointsLabel}\n                            labelFor={availableId}\n                        />\n                    ),\n                availableModalTrigger: loyaltyPoints.ActivePoints !== undefined &&\n                    (\n                        <Button\n                            className='ms-account-loyalty__points-trigger'\n                            color='link'\n                            onClick={this._populateModalData(this._buttonAvailableRef, loyaltyCard, loyaltyPoints, false)}\n                            innerRef={this._buttonAvailableRef}\n                            {...availablePointsAttributes}\n                        >\n                            {loyaltyPoints.ActivePoints.toString()}\n                        </Button>\n                    ),\n                expiringModalLabel: loyaltyPoints.PointsExpiringSoon !== undefined &&\n                    (\n                        <AccountLoyaltyModalLabel\n                            className='ms-account-loyalty__expiring-points-label'\n                            text={format(expiringPointsFormatLabel, 30)}\n                            labelFor={expiringId}\n                        />\n                    ),\n                expiringModalTrigger: loyaltyPoints.PointsExpiringSoon !== undefined &&\n                    (\n                        <Button\n                            className='ms-account-loyalty__points-trigger'\n                            color='link'\n                            onClick={this._populateModalData(this._buttonExpireRef, loyaltyCard, loyaltyPoints, true)}\n                            innerRef={this._buttonExpireRef}\n                            {...expiringPointsAttributes}\n                        >\n                            {loyaltyPoints.PointsExpiringSoon.toString()}\n                        </Button>\n                    )\n            });\n        });\n    }\n\n    private _renderModal(): IAccountLoyaltyModalProps | null {\n        const { totalAvailablePointsLabel, loyaltyActivityDateLabel, loyaltyActivityBalanceLabel } = this.props.resources;\n        const { isModalOpen, currentModalData } = this.state;\n\n        if (!isModalOpen || !currentModalData) {\n            // return empty modal\n            this.props.context.telemetry.error('Account loyalty modal content is empty, module wont render');\n            return null;\n        }\n\n        return {\n            isOpen: isModalOpen,\n            returnFocusRef: this.state.currentFocus,\n            horizontalPosition: 'center',\n            verticalPosition: 'center',\n            modalClassName: 'ms-account-loyalty__points-modal',\n            modalHeaderClassName: 'ms-account-loyalty__points-modal-header',\n            modalHeader: currentModalData.Description || '',\n            modalBodyClassName: 'ms-account-loyalty__points-modal-body',\n            ModalBodyTop: { className: 'ms-account-loyalty__points-modal-body-top' },\n            ModalBodyHeaders: { className: 'ms-account-loyalty__points-modal-body-header' },\n            rewardPointsActivity: this._renderPointsActivity(),\n            pointsDescription:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__points-modal-name'\n                        text={totalAvailablePointsLabel}\n                    />\n                ),\n            totalPoints:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__points-modal-total'\n                        text={this._getPoints()}\n                    />\n                ),\n            date:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__points-modal-date'\n                        text={loyaltyActivityDateLabel}\n                    />\n                ),\n            balanceLabel:\n                (\n                    <AccountLoyaltyLabel\n                        className='ms-account-loyalty__points-modal-balance'\n                        text={loyaltyActivityBalanceLabel}\n                    />\n                ),\n            onClose: this._closeModal\n        };\n    }\n\n    private _getTotalPoints(): number {\n        const rewardPoints = this.props.data.loyaltyCard.result && this.props.data.loyaltyCard.result.RewardPoints;\n\n        let total = 0;\n        rewardPoints!.forEach(loyaltyPoints => {\n            total += loyaltyPoints.ActivePoints || 0;\n        });\n\n        return total;\n    }\n\n    private _getPoints(): string {\n        const { currentModalData, isModalExpiring } = this.state;\n\n        return `${(isModalExpiring ? currentModalData!.PointsExpiringSoon : currentModalData!.ActivePoints) || 0}`;\n    }\n\n    private _renderPointsActivity(): IAccountLoyaltyActivityProps[] | undefined {\n        const { pointsActivity } = this.state;\n\n        if (!pointsActivity) {\n            this.props.context.telemetry.error('Points activity content is empty, module wont render');\n            return undefined;\n        }\n\n        return pointsActivity.map((activity) => {\n            return ({\n                Activity: { className: 'ms-account-loyalty__points-modal-activity' },\n                activityType:\n                    (\n                        <AccountLoyaltyLabel\n                            className='ms-account-loyalty__points-modal-type'\n                            text={this._getTimelineType(activity)}\n                        />\n                    ),\n                activityDate:\n                    (\n                        <AccountLoyaltyLabel\n                            className='ms-account-loyalty__points-modal-date'\n                            text={this.props.context.cultureFormatter.formatDate(this._parseDate(activity.ActivityDate!))}\n                        />\n                    ),\n                activityPoints:\n                    (\n                        <AccountLoyaltyLabel\n                            className='ms-account-loyalty__points-modal-points'\n                            text={activity.LoyaltyPoints && activity.LoyaltyPoints || ''}\n                        />\n                    )\n            });\n        });\n    }\n\n    private _parseDate(date: Date | string): Date {\n        /* Dates for loyalty are coming as formatted strings yyyy-mm-ddT:00:00.000z\n           Javascript was interpreting this as an iso format, thus causing the wrong date to be rendered */\n        if (typeof date === 'string') {\n            let dateString = date.toString();\n            dateString = dateString.replace(/-/g, '/');\n            dateString = dateString.substring(0, 10);\n            return new Date(dateString);\n        } else {\n            return new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());\n        }\n    }\n\n    private _getTimelineType(pointActivity: LoyaltyRewardPointActivity): string {\n        if (pointActivity.LoyaltyRewardPointTimelineEntryType) {\n            return pointActivity.LoyaltyRewardPointTimelineEntryType;\n        }\n\n        const { earnedPointsLabel, redeemedPointsLabel, adjustedPointsLabel } = this.props.resources;\n        switch (pointActivity.ExtensibleLoyaltyRewardPointActivityEntryTypeValue) {\n            case 1:\n                return earnedPointsLabel;\n            case 3:\n                return redeemedPointsLabel;\n            case 5:\n                return adjustedPointsLabel;\n            default:\n                return '';\n        }\n    }\n\n    private _populateModalData = (focusRef: React.RefObject<HTMLElement>, loyaltyCard: LoyaltyCard, currentLoyaltyPoints: LoyaltyRewardPoint, expiring: boolean) => () =>  {\n        if (!loyaltyCard || !loyaltyCard.CardNumber || !currentLoyaltyPoints.RewardPointId) {\n            this.props.context.telemetry.error('Modal data is empty, module wont render');\n            return null;\n        }\n\n        const { actionContext } = this.props.context;\n        // open modal\n        this.setState({\n            isModalOpen: true,\n            currentModalData: currentLoyaltyPoints,\n            isModalExpiring: expiring,\n            modalID: '',\n            currentFocus: focusRef,\n        });\n\n        if (expiring) {\n            getLoyaltyRewardPointsExpiringSoonAsync({ callerContext: actionContext, queryResultSettings: {} }, loyaltyCard.CardNumber, currentLoyaltyPoints.RewardPointId, 30)\n                .then((points: LoyaltyRewardPointActivity[]) => {\n                    this.setState({pointsActivity: points});\n                })\n                .catch((error: Error) => {\n                    this.props.telemetry.exception(error);\n                    this.props.telemetry.debug('Failed to get reward point activity');\n                });\n        } else {\n            getLoyaltyRewardPointActivityTimelineAsync({ callerContext: actionContext, queryResultSettings: {} }, loyaltyCard.CardNumber, currentLoyaltyPoints.RewardPointId)\n                .then((points: LoyaltyRewardPointActivity[]) => {\n                    this.setState({pointsActivity: points});\n                })\n                .catch((error: Error) => {\n                    this.props.telemetry.error(error.message);\n                    this.props.telemetry.debug('Failed to get reward point activity');\n                });\n        }\n\n        return;\n    }\n\n    private _closeModal = () => {\n        this.setState({\n            isModalOpen: false,\n            currentModalData: undefined,\n            pointsActivity: undefined\n        });\n    }\n}\n\nexport default AccountLoyalty;\n"],"sourceRoot":"./src/"},"metadata":{},"sourceType":"module"}